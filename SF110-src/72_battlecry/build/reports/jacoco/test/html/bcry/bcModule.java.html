<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>bcModule.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">72_battlecry</a> &gt; <a href="index.source.html" class="el_package">bcry</a> &gt; <span class="el_source">bcModule.java</span></div><h1>bcModule.java</h1><pre class="source lang-java linenums">/* Battlecry V0.1
 * Copyright (C) 2003  Marek &quot;Wansti&quot; Moeckel
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */

package bcry;

import java.io.*;
import java.util.*;
import java.util.zip.*;
import java.util.List.*;

/* THE BATTLECRY MODULE CLASS
 * This class represents a Battlecry Module.
 */
class bcModule {

<span class="nc" id="L31">   private final String DEFAULT_DATA = &quot;data/modules/battlecry.bcm&quot;;</span>
<span class="nc" id="L32">   private final String DICT_FILE = &quot;data/cmudict.0.6-2-bcry&quot;;</span>
   private static final String DEMO_TEMPLATE = &quot;data/bcDemoModule.template&quot;;
   
   private Properties grammar;
   private Properties info;
   private List layout; //Cointains String objects
   private List wordLists; //Contains bcWordList objects
   
<span class="nc" id="L40">   private int sylTolerance = 0;</span>
<span class="nc" id="L41">   private int metTolerance = 1;</span>
<span class="nc" id="L42">   private boolean initialized = false;</span>
   
<span class="nc" id="L44">   private bcVoice voice = null;</span>
<span class="nc" id="L45">   private bcDictionary dict = null;</span>


   /* CLASS CONSTRUCTOR
    * If no dictionary is being handed to the constructor, bcModule will initialize it automatically.
    * If you (re-)load a module, you can use getDictionary() from the old module to save loading time.
    */
<span class="nc" id="L52">   public bcModule(String data, String customLayout, bcVoice v) {</span>
<span class="nc" id="L53">      voice = v;</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">      if (data.equals(&quot;&quot;)) {data = DEFAULT_DATA;}</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">      if (data.equals(&quot;DEMO&quot;)) {</span>
<span class="nc" id="L56">         initialized = initializeDemoModule();</span>
      }
      else {
<span class="nc" id="L59">         dict = new bcDictionary(DICT_FILE,voice);</span>
<span class="nc" id="L60">         initialized = initialize(data, customLayout);</span>
      }
<span class="nc" id="L62">   }</span>
   
<span class="nc" id="L64">   public bcModule(String data, String customLayout, bcVoice v, bcDictionary d) {</span>
<span class="nc" id="L65">      voice = v;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">      if (data.equals(&quot;&quot;)) {data = DEFAULT_DATA;}</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">      if (data.equals(&quot;DEMO&quot;)) {</span>
<span class="nc" id="L68">         initialized = initializeDemoModule();</span>
      }
      else {
<span class="nc" id="L71">         dict = d;</span>
<span class="nc" id="L72">         initialized = initialize(data, customLayout);</span>
      }
<span class="nc" id="L74">   }</span>

   
   // ---------------- CONSTRUCTOR AUXILIARY METHODS ----------------   
   
   private boolean initialize(String data, String customLayout) {
<span class="nc" id="L80">      boolean result = false;</span>
<span class="nc" id="L81">      File test = new File(data);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">      if (test.isDirectory()) {</span>
<span class="nc" id="L83">         voice.verbose(&quot;Using directory &quot;+data);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">         if (openDirectory(data,customLayout)) {</span>
<span class="nc" id="L85">            result = true;</span>
<span class="nc" id="L86">            voice.verbose(&quot;Directory opened successfully.&quot;);</span>
         }
      }
<span class="nc bnc" id="L89" title="All 2 branches missed.">      else if (test.isFile()) {</span>
<span class="nc" id="L90">         voice.verbose(&quot;Using module &quot;+data);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">         if (openZipFile(data,customLayout)) {</span>
<span class="nc" id="L92">            result = true;</span>
<span class="nc" id="L93">            voice.verbose(&quot;Module opened successfully.&quot;);</span>
         }
      }
      else {
<span class="nc" id="L97">         voice.sysout(&quot;Error: File or directory not found: &quot;+test);</span>
      }
<span class="nc" id="L99">      return result;</span>
   }
   
   /* The following method initializes a hard-coded version of the default Battlecry module
    * stored in the bcDemoModule class.
    * This is used for the applet version of Battlecry (&quot;Battlecry Live&quot;) which cannot
    * load modules from data files for security reasons.
    * Custom demo modules can be generated from any standard module using the --demo option.
    */
   private boolean initializeDemoModule() {
<span class="nc" id="L109">      boolean result = false;</span>
<span class="nc" id="L110">      voice.verbose(&quot;Running in Demo Mode&quot;);</span>
<span class="nc" id="L111">      bcDemoModule demo = new bcDemoModule();</span>
<span class="nc" id="L112">      grammar = demo.getGrammar();</span>
<span class="nc" id="L113">      info = demo.getInfo();</span>
<span class="nc" id="L114">      layout = demo.getLayout();</span>
<span class="nc" id="L115">      wordLists = demo.getWordLists();</span>
<span class="nc bnc" id="L116" title="All 8 branches missed.">      if ((grammar != null) &amp;&amp; (info != null) &amp;&amp; (layout != null) &amp;&amp; (wordLists != null)) {result = true;}</span>
<span class="nc" id="L117">      return result;</span>
   }


   // ---------------- MODULE LOADING METHODS ----------------

   /* openZipFile
    * This method parses the data archives and passes its files to the corresponding methods.
    */
   private boolean openZipFile(String dataFile, String layoutFile) {

<span class="nc" id="L128">    boolean result = true;</span>
<span class="nc" id="L129">    boolean needLayout = true;</span>
<span class="nc" id="L130">    int complete = 0;</span>
    
<span class="nc bnc" id="L132" title="All 2 branches missed.">    if (!layoutFile.equals(&quot;&quot;)) {</span>
      try {
<span class="nc" id="L134">         voice.verbose(&quot;Using custom layout &quot;+layoutFile);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">         if (!loadLayout(new FileInputStream(layoutFile))) {</span>
<span class="nc" id="L136">            voice.sysout(&quot;Warning: Failed to load custom layout file. Trying to load from data file...&quot;);</span>
         }
         else {
<span class="nc" id="L139">            needLayout = false;</span>
         }
      }
<span class="nc" id="L142">      catch (IOException e) {</span>
<span class="nc" id="L143">         voice.sysout(&quot;Warning: Failed to open custom layout file. Trying data file...&quot;);</span>
<span class="nc" id="L144">      }</span>
    }
    try {

<span class="nc" id="L148">       ZipFile zipFile = new ZipFile(dataFile);</span>
<span class="nc" id="L149">       Enumeration entries = zipFile.entries();</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">       while(entries.hasMoreElements()) {</span>
<span class="nc" id="L152">         ZipEntry entry = (ZipEntry)entries.nextElement();</span>

<span class="nc bnc" id="L154" title="All 2 branches missed.">         if(entry.isDirectory()) {</span>
<span class="nc" id="L155">            voice.sysout(&quot;Warning: Directory detected inside data file; this can cause problems.&quot;);</span>
<span class="nc" id="L156">            continue;</span>
         }

<span class="nc bnc" id="L159" title="All 2 branches missed.">         if (entry.getName().equals(&quot;info.dat&quot;)) {</span>
<span class="nc" id="L160">            complete++;</span>
<span class="nc" id="L161">            voice.verbose(&quot;Loading file: &quot;+entry.getName());</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (!loadInfo(zipFile.getInputStream(entry))) {</span>
<span class="nc" id="L163">               voice.sysout(&quot;Error: Unable to parse info file.&quot;);</span>
<span class="nc" id="L164">               result = false;</span>
            }
         }
<span class="nc bnc" id="L167" title="All 2 branches missed.">         else if (entry.getName().equals(&quot;layout.dat&quot;)) {</span>
<span class="nc" id="L168">           complete++;</span>
<span class="nc" id="L169">           voice.verbose(&quot;Loading file: &quot;+entry.getName());</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">           if (needLayout) {</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">               if (!loadLayout(zipFile.getInputStream(entry))) {</span>
<span class="nc" id="L172">                 voice.sysout(&quot;Error: Unable to parse layout file.&quot;);</span>
<span class="nc" id="L173">              result = false;</span>
               }
              }
           else {
            continue;
           }
         }
<span class="nc bnc" id="L180" title="All 2 branches missed.">            else if (entry.getName().equals(&quot;grammar.dat&quot;)) {</span>
<span class="nc" id="L181">               complete++;</span>
<span class="nc" id="L182">               voice.verbose(&quot;Loading file: &quot;+entry.getName());</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">               if (!loadGrammar(zipFile.getInputStream(entry))) {</span>
<span class="nc" id="L184">                  voice.sysout(&quot;Error: Unable to parse grammar file.&quot;);</span>
<span class="nc" id="L185">               result = false;</span>
            }
            }
<span class="nc bnc" id="L188" title="All 2 branches missed.">            else if (entry.getName().equals(&quot;words.dat&quot;)) {</span>
<span class="nc" id="L189">              complete++;</span>
<span class="nc" id="L190">              voice.verbose(&quot;Loading file: &quot;+entry.getName());</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">              if (!loadWordLists(zipFile.getInputStream(entry))) {</span>
<span class="nc" id="L192">             voice.sysout(&quot;Error: Unable to parse word list &quot;+entry.getName());</span>
<span class="nc" id="L193">             result = false;</span>
           }
            }
            else {
<span class="nc" id="L197">              voice.sysout(&quot;Warning: Ignoring unknown file type &quot;+entry.getName());</span>
            }
<span class="nc" id="L199">            }</span>
<span class="nc" id="L200">            zipFile.close();</span>
<span class="nc" id="L201">      } catch (IOException e) {</span>
<span class="nc" id="L202">            voice.sysout(&quot;Error: Could not open data file &quot;+dataFile);</span>
<span class="nc" id="L203">            result = false;</span>
<span class="nc" id="L204">           }</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">     if (complete != 4) {</span>
<span class="nc" id="L206">         voice.sysout(&quot;Error: Module &quot;+dataFile+&quot; does not contain all necessary files.&quot;);</span>
<span class="nc" id="L207">         result = false;</span>
      }
<span class="nc" id="L209">     return result;</span>
   }

   /* openDirectory
    * This method opens the module files inside the given directory.
    */
   private boolean openDirectory(String dataFile, String layoutFile) {

<span class="nc" id="L217">    boolean result = true;</span>
<span class="nc" id="L218">    boolean needLayout = true;</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">    if (!layoutFile.equals(&quot;&quot;)) {</span>
      try {
<span class="nc" id="L221">         voice.verbose(&quot;Using custom layout &quot;+layoutFile);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">         if (!loadLayout(new FileInputStream(layoutFile))) {</span>
<span class="nc" id="L223">            voice.sysout(&quot;Warning: Failed to load custom layout file. Trying to load from data file...&quot;);</span>
         }
         else {
<span class="nc" id="L226">            needLayout = false;</span>
         }
      }
<span class="nc" id="L229">      catch (IOException e) {</span>
<span class="nc" id="L230">         voice.sysout(&quot;Warning: Failed to open custom layout file. Trying data file...&quot;);</span>
<span class="nc" id="L231">      }</span>
    }
    try {

<span class="nc" id="L235">      int complete = 0;</span>
<span class="nc" id="L236">      File[] fileList = new File(dataFile).listFiles();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">      for (int i = 0; i &lt; fileList.length; i++) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">         if ((fileList[i].toString().endsWith(&quot;info.dat&quot;)) ||</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">            (fileList[i].toString().endsWith(&quot;layout.dat&quot;)) ||</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">            (fileList[i].toString().endsWith(&quot;grammar.dat&quot;)) ||</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            (fileList[i].toString().endsWith(&quot;words.dat&quot;))) {</span>
<span class="nc" id="L242">            complete++;</span>
         }
      }
<span class="nc bnc" id="L245" title="All 2 branches missed.">      if (complete != 4) {</span>
<span class="nc" id="L246">         voice.sysout(&quot;Error: Directory &quot;+dataFile+&quot; does not contain all necessary files.&quot;);</span>
<span class="nc" id="L247">         result = false;</span>
      }
      else {
<span class="nc bnc" id="L250" title="All 2 branches missed.">      for (int i = 0; i &lt; fileList.length; i++) {</span>

<span class="nc bnc" id="L252" title="All 2 branches missed.">         if (fileList[i].getName().equals(&quot;info.dat&quot;)) {</span>
<span class="nc" id="L253">            voice.verbose(&quot;Loading file: &quot;+fileList[i].toString());</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (!loadInfo(new FileInputStream(fileList[i].toString()))) {</span>
<span class="nc" id="L255">               voice.sysout(&quot;Error: Unable to parse info file.&quot;);</span>
<span class="nc" id="L256">               result = false;</span>
            }
         }
<span class="nc bnc" id="L259" title="All 2 branches missed.">         else if (fileList[i].getName().equals(&quot;layout.dat&quot;)) {</span>
<span class="nc" id="L260">           voice.verbose(&quot;Loading file: &quot;+fileList[i].toString());</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">           if (needLayout) {</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">               if (!loadLayout(new FileInputStream(fileList[i].toString()))) {</span>
<span class="nc" id="L263">                 voice.sysout(&quot;Error: Unable to parse layout file.&quot;);</span>
<span class="nc" id="L264">              result = false;</span>
               }
              }
           else {
            continue;
           }
         }
<span class="nc bnc" id="L271" title="All 2 branches missed.">            else if (fileList[i].getName().equals(&quot;grammar.dat&quot;)) {</span>
<span class="nc" id="L272">               voice.verbose(&quot;Loading file: &quot;+fileList[i].toString());</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">               if (!loadGrammar(new FileInputStream(fileList[i].toString()))) {</span>
<span class="nc" id="L274">                  voice.sysout(&quot;Error: Unable to parse grammar file.&quot;);</span>
<span class="nc" id="L275">               result = false;</span>
            }
            }
<span class="nc bnc" id="L278" title="All 2 branches missed.">            else if (fileList[i].getName().equals(&quot;words.dat&quot;)) {</span>
<span class="nc" id="L279">              voice.verbose(&quot;Loading file: &quot;+fileList[i].toString());</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">              if (!loadWordLists(new FileInputStream(fileList[i].toString()))) {</span>
<span class="nc" id="L281">             voice.sysout(&quot;Error: Unable to parse word list &quot;+fileList[i].toString());</span>
<span class="nc" id="L282">             result = false;</span>
           }
            }
            else {
<span class="nc" id="L286">              voice.sysout(&quot;Warning: Ignoring unknown file type &quot;+fileList[i].toString());</span>
            }
      }
      }
<span class="nc" id="L290">      } catch (IOException e) {</span>
<span class="nc" id="L291">            voice.sysout(&quot;Error: &quot;+dataFile+&quot; does not contain valid battlecry data.&quot;);</span>
<span class="nc" id="L292">            result = false;</span>
<span class="nc" id="L293">           }</span>
<span class="nc" id="L294">     return result;</span>
   }

   /* loadWordLists
    * Takes a word file (and its name) and adds it to the wordLists array.
    */
   private boolean loadWordLists(InputStream wordFile) {

<span class="nc bnc" id="L302" title="All 2 branches missed.">      if (wordLists == null) {wordLists = new LinkedList();}</span>
<span class="nc" id="L303">      bcWordList tempList = new bcWordList(&quot;BC_DUMMY_LIST&quot;);</span>
<span class="nc" id="L304">      bcWordList splitList = new bcWordList(&quot;BC_SPLIT_STRINGS&quot;); //Create an extra list for single words</span>
      String line;
<span class="nc" id="L306">      boolean result = true;</span>
      try {
<span class="nc" id="L308">         BufferedReader list = new BufferedReader(new InputStreamReader(wordFile));</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">         while ((line = list.readLine()) != null) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">            if (!line.equals(&quot;&quot;)) {</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">               if ((line.startsWith(&quot;[&quot;)) &amp;&amp; (line.endsWith(&quot;]&quot;))) {</span>
                  //create a new list, add the current list to wordLists first
<span class="nc bnc" id="L313" title="All 2 branches missed.">                  if (!tempList.getFileName().equals(&quot;BC_DUMMY_LIST&quot;)) {wordLists.add(tempList);}</span>
<span class="nc" id="L314">                  voice.verbose(&quot;Adding word list: &quot;+line.substring(1,line.length()-1));</span>
<span class="nc" id="L315">                  tempList = new bcWordList(line.substring(1,line.length()-1));</span>
               }
               else {
                  //add this word
<span class="nc bnc" id="L319" title="All 2 branches missed.">                  if (!line.startsWith(&quot;#&quot;)) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                     if (line.indexOf(&quot;=&quot;) == -1) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                        if (tempList.getItem(line) == null) tempList.addWord(line,dict.getPhonemes(line));</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                        if (line.indexOf(&quot; &quot;) != -1) {</span>
<span class="nc" id="L323">                           String temp[] = line.split(&quot; &quot;);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                           for (int i=0; i&lt;temp.length; i++) {</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">                              if (splitList.getItem(temp[i]) == null) splitList.addWord(temp[i],dict.getPhonemes(temp[i]));</span>
                           }
<span class="nc" id="L327">                        }</span>
                     }
                     else {
                        //word is set equal to another
                        //TODO: Split words at &quot;blank&quot;
<span class="nc" id="L332">                        String[] splitLine = line.split(&quot;=&quot;);</span>
<span class="nc" id="L333">                        bcWord tempWord = new bcWord(splitLine[0],dict.getPhonemes(splitLine[0]));</span>
<span class="nc" id="L334">                        tempWord.setEqualWord(splitLine[1],dict.getPhonemes(splitLine[1]));</span>
<span class="nc" id="L335">                        tempList.addWord(tempWord);</span>
<span class="nc" id="L336">                     }</span>
                  }
               }
            }
         }
<span class="nc bnc" id="L341" title="All 2 branches missed.">         if (tempList.getFileName().equals(&quot;BC_DUMMY_LIST&quot;)) {</span>
<span class="nc" id="L342">            voice.sysout(&quot;Error: Syntax error in words.dat - see documentation for help.&quot;);</span>
<span class="nc" id="L343">            result = false;</span>
         }
<span class="nc" id="L345">         wordLists.add(tempList);</span>
<span class="nc" id="L346">         list.close();</span>
      }
<span class="nc" id="L348">      catch (Exception e) {voice.sysout(&quot;Error: Unable to load word lists - &quot;+e.toString()); result = false;}</span>
         
      //Parse grammar for strings, add them to the word lists
<span class="nc" id="L351">      tempList = new bcWordList(&quot;BC_FROM_GRAMMAR&quot;);</span>
      String temp1[];
      String temp2[];
<span class="nc" id="L354">      Enumeration entries = grammar.propertyNames();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">      while(entries.hasMoreElements()) {</span>
<span class="nc" id="L356">         temp1 = grammar.getProperty(entries.nextElement().toString()).split(&quot;'&quot;);</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">         for (int i=1; i&lt;temp1.length; i++) {</span>
            //add the whole string
<span class="nc bnc" id="L359" title="All 2 branches missed.">            if (tempList.getItem(temp1[i]) == null) tempList.addWord(temp1[i],dict.getPhonemes(temp1[i]));</span>
            //if string is more than one word, add single words to splitList
<span class="nc bnc" id="L361" title="All 2 branches missed.">            if (temp1[i].indexOf(&quot; &quot;) != -1) {</span>
<span class="nc" id="L362">               temp2 = temp1[i].split(&quot; &quot;);</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">               for (int j=0; j&lt;temp2.length; j++) {</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">                  if (splitList.getItem(temp2[j]) == null) splitList.addWord(temp2[j],dict.getPhonemes(temp2[j]));</span>
               }
            }
<span class="nc" id="L367">            i++; //only every second element is a valid string, so increase i by 1 to skip the others</span>
         }
      }
      //hack to prevent program from crashing when xLiner produces an empty string; fix this in xLiner!
<span class="nc" id="L371">      splitList.addWord(&quot;&quot;,&quot;&quot;);</span>
<span class="nc" id="L372">      wordLists.add(tempList);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">      if (splitList.getNumberOfWords() != 0) wordLists.add(splitList);</span>
<span class="nc" id="L374">      return result;</span>
   }

   /* loadLayout
    * Takes the layout.dat file and stores its data into the Layout array.
    */
   private boolean loadLayout(InputStream layoutFile) {

      int i;
      String line;
<span class="nc" id="L384">      boolean result = true;</span>
      try {
<span class="nc" id="L386">         layout = new LinkedList();</span>
<span class="nc" id="L387">         BufferedReader lo = new BufferedReader(new InputStreamReader(layoutFile));</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">         while ((line = lo.readLine()) != null) {</span>
<span class="nc" id="L389">            layout.add(line);</span>
         }
<span class="nc" id="L391">         lo.close();</span>
      }
<span class="nc" id="L393">      catch (Exception e) {voice.sysout(e.toString()); result = false;}</span>
<span class="nc" id="L394">      return result;</span>
   }

   /* loadGrammar
    * Takes the grammar.dat file and stores its information in the &quot;grammar&quot; Properties variable.
    */
   private boolean loadGrammar(InputStream grammarFile) {

<span class="nc" id="L402">      boolean result = true;</span>
      try {
<span class="nc" id="L404">         grammar = new Properties();</span>
<span class="nc" id="L405">         grammar.load(grammarFile);</span>
      }
<span class="nc" id="L407">      catch (Exception e) {voice.sysout(e.toString()); result = false;}</span>
<span class="nc" id="L408">      return result;</span>
   }

   /* loadInfo
    * Takes the info.dat file and stores its information in the &quot;info&quot; Properties variable.
    * It also reads the options from that file;
    */
   private boolean loadInfo(InputStream infoFile) {

<span class="nc" id="L417">      boolean result = true;</span>
      try {
<span class="nc" id="L419">         info = new Properties();</span>
<span class="nc" id="L420">         info.load(infoFile);</span>

<span class="nc bnc" id="L422" title="All 2 branches missed.">         if (!(info.getProperty(&quot;OPTION_SYLLABLE_TOLERANCE&quot;) == null)) {</span>
<span class="nc" id="L423">            sylTolerance = Integer.parseInt(info.getProperty(&quot;OPTION_SYLLABLE_TOLERANCE&quot;));</span>
         }
         else {
<span class="nc" id="L426">            voice.verbose(&quot;OPTION_SYLLABLE_TOLERANCE not set in info.dat, using default.&quot;);</span>
         }
<span class="nc bnc" id="L428" title="All 2 branches missed.">         if (!(info.getProperty(&quot;OPTION_METRIC_TOLERANCE&quot;) == null)) {</span>
<span class="nc" id="L429">            metTolerance = Integer.parseInt(info.getProperty(&quot;OPTION_METRIC_TOLERANCE&quot;));</span>
         }
         else {
<span class="nc" id="L432">            voice.verbose(&quot;OPTION_METRIC_TOLERANCE not set in info.dat, using default.&quot;);</span>
         }

      }
<span class="nc" id="L436">      catch (NumberFormatException e) {</span>
<span class="nc" id="L437">         voice.sysout(&quot;Warning: Option with an invalid value found, using default.&quot;);</span>
      }
<span class="nc" id="L439">      catch (Exception e) {</span>
<span class="nc" id="L440">         voice.sysout(e.toString());</span>
<span class="nc" id="L441">         result = false;</span>
<span class="nc" id="L442">      }</span>
<span class="nc" id="L443">      return result;</span>
   }
   
   // ---------------- DEMO CLASS GENERATOR ----------------
   
   /* toDemoClass()
    * creates a bcDemoModule class from this module
    */
   public void toDemoClass(String outputFile) {
   try {
<span class="nc" id="L453">      int c = 0;</span>
      String line;
      String nextLine;
      String temp;
      Enumeration entries;
<span class="nc" id="L458">      BufferedReader template = new BufferedReader(new FileReader(DEMO_TEMPLATE));</span>
<span class="nc" id="L459">      BufferedWriter output = new BufferedWriter(new FileWriter(outputFile));</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">      while ((line = template.readLine()) != null) {</span>
         //Add grammar entries
<span class="nc bnc" id="L462" title="All 2 branches missed.">         if (line.equals(&quot;//DEMOMAKER: INSERT GRAMMAR HERE!&quot;)) {</span>
<span class="nc" id="L463">            entries = grammar.propertyNames();</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">            while(entries.hasMoreElements()) {                  </span>
<span class="nc" id="L465">               temp = entries.nextElement().toString();</span>
<span class="nc" id="L466">               nextLine = &quot;      grammar.setProperty(\&quot;&quot; + temp + &quot;\&quot;,\&quot;&quot; + grammar.getProperty(temp) + &quot;\&quot;);&quot;;</span>
<span class="nc" id="L467">               output.write(nextLine);</span>
<span class="nc" id="L468">               output.newLine();</span>
<span class="nc" id="L469">               c++;</span>
            }
<span class="nc" id="L471">            voice.verbose(c+&quot; grammar entries added.&quot;);</span>
<span class="nc" id="L472">            c = 0;</span>
         }
<span class="nc bnc" id="L474" title="All 2 branches missed.">         else if (line.equals(&quot;//DEMOMAKER: INSERT INFO HERE!&quot;)) {</span>
<span class="nc" id="L475">            entries = info.propertyNames();</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">            while(entries.hasMoreElements()) {</span>
<span class="nc" id="L477">               temp = entries.nextElement().toString();</span>
<span class="nc" id="L478">               nextLine = &quot;      info.setProperty(\&quot;&quot; + temp + &quot;\&quot;,\&quot;&quot; + info.getProperty(temp) + &quot;\&quot;);&quot;;</span>
<span class="nc" id="L479">               output.write(nextLine);</span>
<span class="nc" id="L480">               output.newLine();</span>
<span class="nc" id="L481">               c++;</span>
            }
<span class="nc" id="L483">            voice.verbose(c+&quot; info entries added.&quot;);</span>
<span class="nc" id="L484">            c = 0;</span>
         }
<span class="nc bnc" id="L486" title="All 2 branches missed.">         else if (line.equals(&quot;//DEMOMAKER: INSERT LAYOUT HERE!&quot;)) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">            for (int i=0; i&lt;layout.size(); i++) {</span>
<span class="nc" id="L488">               nextLine = &quot;      layout.add(\&quot;&quot; + layout.get(i) + &quot;\&quot;);&quot;;</span>
<span class="nc" id="L489">               output.write(nextLine);</span>
<span class="nc" id="L490">               output.newLine();</span>
<span class="nc" id="L491">               c++;</span>
            }
<span class="nc" id="L493">            voice.verbose(c+&quot; layout entries added.&quot;);</span>
<span class="nc" id="L494">            c = 0;</span>
         }
<span class="nc bnc" id="L496" title="All 2 branches missed.">         else if (line.equals(&quot;//DEMOMAKER: INSERT WORDLISTS HERE!&quot;)) {</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">            for (int i=0; i&lt;wordLists.size(); i++) {</span>
<span class="nc" id="L498">               bcWordList tempL = (bcWordList)wordLists.get(i);</span>
<span class="nc" id="L499">               output.write(&quot;      tempList = new bcWordList(\&quot;&quot;+tempL.getFileName()+&quot;\&quot;);&quot;);</span>
<span class="nc" id="L500">               output.newLine();</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">               for (int j=0; j&lt;tempL.getNumberOfWords(); j++) {</span>
<span class="nc" id="L502">                  nextLine = &quot;      tempList.addWord(\&quot;&quot; + tempL.getItem(j).getWord() + &quot;\&quot;,\&quot;&quot; + tempL.getItem(j).getPhonemes() +&quot;\&quot;);&quot;;</span>
<span class="nc" id="L503">                  output.write(nextLine);</span>
<span class="nc" id="L504">                  output.newLine();</span>
<span class="nc" id="L505">                  c++;</span>
               }
<span class="nc" id="L507">               output.write(&quot;      wordLists.add(tempList);&quot;);</span>
<span class="nc" id="L508">               output.newLine();</span>
<span class="nc" id="L509">               output.newLine();                 </span>
            }
<span class="nc" id="L511">            voice.verbose(c+&quot; word list entries added.&quot;);</span>
<span class="nc" id="L512">            c = 0;</span>
         }
         else {
<span class="nc" id="L515">           output.write(line);</span>
<span class="nc" id="L516">           output.newLine();</span>
         }
      }
<span class="nc" id="L519">      template.close();</span>
<span class="nc" id="L520">      output.close();</span>
   }      
<span class="nc" id="L522">   catch (IOException e) {voice.sysout(&quot;Error: Could not create demo module - &quot; + e.toString());}</span>
<span class="nc" id="L523">   voice.sysout(&quot;bcDemoModule class created at &quot;+outputFile+&quot;.&quot;);</span>
<span class="nc" id="L524">   }</span>
     
   
   // ---------------- PUBLIC METHODS ----------------
   
   public Properties getGrammar() {
<span class="nc" id="L530">      return grammar;</span>
   }
   
   public Properties getInfo() {
<span class="nc" id="L534">      return info;</span>
   }

   public List getLayout() {
<span class="nc" id="L538">      return layout;</span>
   }
   
   public List getWordLists() {
<span class="nc" id="L542">      return wordLists;</span>
   }
   
   public bcWordList getWordList(String listName) {
<span class="nc" id="L546">      bcWordList result = null;</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">      for (int i = 0; i &lt; wordLists.size(); i++) {</span>
<span class="nc" id="L548">         bcWordList temp = (bcWordList)wordLists.get(i);</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">         if (temp.getFileName().equals(listName)) {</span>
<span class="nc" id="L550">            result = temp;</span>
<span class="nc" id="L551">            break;</span>
         }
      }
<span class="nc" id="L554">      return result;</span>
   }
     
   public int getSyllableTolerance() {
<span class="nc" id="L558">      return sylTolerance;</span>
   }
   
   public int getMetricTolerance() {
<span class="nc" id="L562">      return metTolerance;</span>
   }
   
   public boolean isInitialized() {
<span class="nc" id="L566">      return initialized;</span>
   }
   
   public bcDictionary getDictionary() {
<span class="nc" id="L570">      return dict;</span>
   }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>