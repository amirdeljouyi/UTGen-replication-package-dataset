<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminApp.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">73_fim1</a> &gt; <a href="index.source.html" class="el_package">osa.ora.server.admin</a> &gt; <span class="el_source">AdminApp.java</span></div><h1>AdminApp.java</h1><pre class="source lang-java linenums">/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package osa.ora.server.admin;

import osa.ora.server.*;
import com.birosoft.liquid.LiquidLookAndFeel;
import java.awt.Dimension;
import java.awt.Toolkit;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.net.URISyntaxException;
import java.rmi.NotBoundException;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.util.Hashtable;
import java.util.Vector;
import javax.swing.ImageIcon;
import javax.swing.JDialog;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.UIManager;
import osa.ora.server.admin.ui.AdminLoginPanel;
import osa.ora.server.admin.ui.ControlPanel;
import osa.ora.server.beans.AdminSettingBean;
import osa.ora.server.beans.Group;
import osa.ora.server.beans.IConstant;
import osa.ora.server.beans.LoginBean;
import osa.ora.server.beans.ResultBean;
import osa.ora.server.beans.Room;
import osa.ora.server.beans.User;
import osa.ora.server.utils.StringEncoder64;
import osa.ora.server.utils.StringEncrypter;

/**
 *
 * @author ooransa
 */
public class AdminApp {

    private ServerAdminInterface serverAdminInterface;
    private Vector&lt;Group&gt; groups;
    private Vector&lt;Room&gt; rooms;
<span class="nc" id="L46">    private String lookString = &quot;com.birosoft.liquid.LiquidLookAndFeel&quot;;</span>
    private User user;
    private JFrame chatAdminFrame;
    private JDialog loginDialog;
<span class="fc" id="L50">    private static String path = &quot;&quot;;</span>
    private AdminSettingBean adminSettingBean;
    private ControlPanel controlPanel;
<span class="nc" id="L53">    private ImageIcon errorIcon = new ImageIcon(java.awt.Toolkit.getDefaultToolkit().getImage(getClass().getResource(&quot;/images/error.png&quot;)));</span>
    private Hashtable&lt;Integer, String&gt; connectedClientsIPs;
    private int securityMode;
    private String rootNode;
    private String authToken;
    private String securityToke;
    private StringEncrypter stringEnc;
    /**
     * main method for admin
     * @param args
     */
    public static void main(String[] args) {
        try {
<span class="nc" id="L66">            AdminApp adminApp = new AdminApp();</span>
<span class="nc" id="L67">        } catch (RemoteException ex) {</span>
<span class="nc" id="L68">            ex.printStackTrace();</span>
<span class="nc" id="L69">            System.out.println(&quot;Error in Running!&quot;);</span>
<span class="nc" id="L70">        }</span>
<span class="nc" id="L71">    }</span>

<span class="nc" id="L73">    public AdminApp() throws RemoteException {</span>
<span class="nc" id="L74">        connectedClientsIPs = new Hashtable&lt;Integer, String&gt;(0);</span>
<span class="nc" id="L75">        groups = new Vector&lt;Group&gt;(0);</span>
<span class="nc" id="L76">        rooms = new Vector&lt;Room&gt;(0);</span>
        try {
<span class="nc" id="L78">            path = AdminApp.class.getProtectionDomain().getCodeSource().getLocation().toURI().getPath();</span>
<span class="nc" id="L79">        } catch (URISyntaxException ex) {</span>
<span class="nc" id="L80">            ex.printStackTrace();</span>
<span class="nc" id="L81">        }</span>
<span class="nc" id="L82">        path = path.substring(0, path.lastIndexOf('/') + 1);</span>
<span class="nc" id="L83">        adminSettingBean = new AdminSettingBean(path);</span>
        try {
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (lookString instanceof String) {</span>
<span class="nc" id="L86">                LiquidLookAndFeel.setLiquidDecorations(true);</span>
<span class="nc" id="L87">                UIManager.setLookAndFeel((String) lookString);</span>
            }
<span class="nc" id="L89">        } catch (Exception e1) {</span>
<span class="nc" id="L90">            e1.printStackTrace();</span>
<span class="nc" id="L91">            JOptionPane.showMessageDialog(null, &quot;Error in applying look and feel!!&quot;);</span>
<span class="nc" id="L92">        }</span>
<span class="nc" id="L93">        chatAdminFrame = new JFrame();</span>
<span class="nc" id="L94">        chatAdminFrame.setTitle(&quot;Free Instant Messenger - Admin Interface&quot;);</span>
<span class="nc" id="L95">        chatAdminFrame.setIconImage(Toolkit.getDefaultToolkit().getImage(getClass().getResource(&quot;/images/groups.png&quot;)));</span>
<span class="nc" id="L96">        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();</span>
<span class="nc" id="L97">        chatAdminFrame.setSize(580, 455);</span>
<span class="nc" id="L98">        Dimension frameSize = chatAdminFrame.getSize();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (frameSize.height &gt; screenSize.height) {</span>
<span class="nc" id="L100">            frameSize.height = screenSize.height;</span>
        }
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (frameSize.width &gt; screenSize.width) {</span>
<span class="nc" id="L103">            frameSize.width = screenSize.width;</span>
        }
<span class="nc" id="L105">        chatAdminFrame.setLocation((screenSize.width - frameSize.width) / 2, (screenSize.height - frameSize.height) / 2);</span>
<span class="nc" id="L106">        chatAdminFrame.setResizable(false);</span>
<span class="nc" id="L107">        chatAdminFrame.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);</span>
<span class="nc" id="L108">        loginDialog = new JDialog(getChatAdminFrame(), &quot;Login&quot;, true);</span>
<span class="nc" id="L109">        AdminLoginPanel loginPanel = new AdminLoginPanel(this);</span>
<span class="nc" id="L110">        loginDialog.setSize(300, 150);</span>
        //loginDialog.setUndecorated(true);
<span class="nc" id="L112">        loginDialog.setLocationRelativeTo(chatAdminFrame);</span>
<span class="nc" id="L113">        loginDialog.setAlwaysOnTop(true);</span>
<span class="nc" id="L114">        loginDialog.addWindowListener(new WindowAdapter() {</span>

            public void windowClosing(WindowEvent e) {
<span class="nc" id="L117">                System.exit(0);</span>
<span class="nc" id="L118">            }</span>
        });
<span class="nc" id="L120">        loginDialog.setResizable(false);</span>
<span class="nc" id="L121">        loginDialog.getContentPane().add(loginPanel);</span>
<span class="nc" id="L122">        loginDialog.setVisible(true);</span>
<span class="nc" id="L123">    }</span>

    public void initServer() throws Exception {
        //lookup for the server
<span class="nc" id="L127">        Registry reg = null;</span>
<span class="nc" id="L128">        reg = LocateRegistry.getRegistry(adminSettingBean.getServerURL(), Integer.parseInt(adminSettingBean.getServerPort()));</span>
<span class="nc" id="L129">        System.out.println(&quot;trying to connect to the FIM server .....&quot;);</span>
        try {
<span class="nc" id="L131">            serverAdminInterface = (ServerAdminInterface) reg.lookup(&quot;ModernChatServer&quot;);</span>
<span class="nc" id="L132">            System.out.println(&quot;connected to the FIM server .....&quot;);</span>
<span class="nc" id="L133">        } catch (RemoteException ex) {</span>
            //ex.printStackTrace();
<span class="nc" id="L135">            throw new Exception(&quot;Can't find this FIM Server!&quot;);</span>
<span class="nc" id="L136">        } catch (NotBoundException ex) {</span>
            //ex.printStackTrace();
<span class="nc" id="L138">            throw new Exception(&quot;Server invalid IP/Port or FIM Server not running!&quot;);</span>
<span class="nc" id="L139">        }</span>
<span class="nc" id="L140">    }</span>

    public void login(String userEmail, String password) throws Exception {
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (serverAdminInterface == null) {</span>
<span class="nc" id="L144">            initServer();</span>
        }
<span class="nc" id="L146">        stringEnc=StringEncrypter.getInstance(password);</span>
<span class="nc" id="L147">        LoginBean loginBean= serverAdminInterface.signInAsAdmin(StringEncoder64.encodeStringUTF8(userEmail), stringEnc.encrypt(password));</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        if (loginBean == null) {</span>
<span class="nc" id="L149">            throw new Exception(&quot;Invalid User Email or Password!&quot;);</span>
        } else {
<span class="nc" id="L151">            authToken=loginBean.getAuthToken();</span>
<span class="nc" id="L152">            securityToke=stringEnc.decrypt(loginBean.getSecureToken());</span>
<span class="nc" id="L153">            stringEnc=StringEncrypter.getInstance(securityToke);</span>
<span class="nc" id="L154">            user=loginBean.getUser();</span>
<span class="nc" id="L155">            loginDialog.setVisible(false);</span>
<span class="nc" id="L156">            controlPanel = new ControlPanel(this);</span>
<span class="nc" id="L157">            getChatAdminFrame().getContentPane().add(controlPanel);</span>
<span class="nc" id="L158">            getChatAdminFrame().setVisible(true);</span>
            try {
<span class="nc" id="L160">                securityMode = serverAdminInterface.getSecurityMode(authToken);</span>
<span class="nc" id="L161">                rootNode = serverAdminInterface.getRootNode(authToken);</span>
<span class="nc" id="L162">                setGroups(loadGroups());</span>
<span class="nc" id="L163">            } catch (RemoteException ex) {</span>
<span class="nc" id="L164">                ex.printStackTrace();</span>
<span class="nc" id="L165">                throw new Exception(&quot;Error During Getting All Groups From FIM Server!&quot;);</span>
<span class="nc" id="L166">            }</span>
            try {
<span class="nc" id="L168">                setRooms(serverAdminInterface.loadRooms(authToken));</span>
<span class="nc" id="L169">            } catch (RemoteException ex) {</span>
<span class="nc" id="L170">                ex.printStackTrace();</span>
<span class="nc" id="L171">                throw new Exception(&quot;Error During Getting All Rooms From FIM Server!&quot;);</span>
<span class="nc" id="L172">            }</span>
        }
<span class="nc" id="L174">    }</span>

    public Vector&lt;Group&gt; loadGroups() throws RemoteException {
<span class="nc" id="L177">        groups = serverAdminInterface.loadGroupsAndUsers(authToken);</span>
<span class="nc" id="L178">        return groups;</span>
    }

    public String changePassword(String oldPass, String newPass) {
<span class="nc" id="L182">        ResultBean result = null;</span>
        try {
<span class="nc" id="L184">            result = serverAdminInterface.changeAdminPassword(StringEncoder64.encodeStringUTF8(user.getEmail()), stringEnc.encrypt(oldPass), stringEnc.encrypt(newPass));</span>
<span class="nc" id="L185">        } catch (Exception ex) {</span>
<span class="nc" id="L186">            ex.printStackTrace();</span>
<span class="nc" id="L187">            return &quot;Error: &quot; + ex.getMessage();</span>
<span class="nc" id="L188">        }</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (result.isSuccess()) {</span>
<span class="nc" id="L190">            return &quot;New Password Applied Successfully!&quot;;</span>
        } else {
<span class="nc bnc" id="L192" title="All 2 branches missed.">            if (result.getAction() == IConstant.ERROR) {</span>
                //set user status in the tab and list as offline !
<span class="nc" id="L194">                return &quot;Error: &quot; + result.getMessage();</span>
            } else {
<span class="nc" id="L196">                return &quot;Failed to Change Password!&quot;;</span>
            }
        }
    }

    /**
     * @return the errorIcon
     */
    public ImageIcon getErrorIcon() {
<span class="nc" id="L205">        return errorIcon;</span>
    }

    /**
     * @return the loginDialog
     */
    public JDialog getLoginDialog() {
<span class="nc" id="L212">        return loginDialog;</span>
    }

    /**
     * @return the chatAdminFrame
     */
    public JFrame getChatAdminFrame() {
<span class="nc" id="L219">        return chatAdminFrame;</span>
    }

    /**
     * @return the groups
     */
    public Vector&lt;Group&gt; getGroups() {
<span class="nc" id="L226">        return groups;</span>
    }

    /**
     * @param groups the groups to set
     */
    public void setGroups(Vector&lt;Group&gt; groups) {
<span class="nc" id="L233">        this.groups = groups;</span>
<span class="nc" id="L234">    }</span>

    /**
     * @return the rooms
     */
    public Vector&lt;Room&gt; getRooms() {
<span class="nc" id="L240">        return rooms;</span>
    }

    /**
     * @param rooms the rooms to set
     */
    public void setRooms(Vector&lt;Room&gt; rooms) {
<span class="nc" id="L247">        this.rooms = rooms;</span>
<span class="nc" id="L248">    }</span>

    public User createUser(User user) throws RemoteException {
<span class="nc" id="L251">        return serverAdminInterface.createUser(user,authToken);</span>
    }

    public Group createGroup(Group group) throws RemoteException {
<span class="nc" id="L255">        return serverAdminInterface.createGroup(group,authToken);</span>
    }

    public Room createRoom(Room room) throws RemoteException {
<span class="nc" id="L259">        return serverAdminInterface.createRoom(room,authToken);</span>
    }

    public User delUser(User user) throws RemoteException {
<span class="nc" id="L263">        return serverAdminInterface.delUser(user,authToken);</span>
    }

    public Group delGroup(Group group) throws RemoteException {
<span class="nc" id="L267">        return serverAdminInterface.delGroup(group,authToken);</span>
    }

    public Room delRoom(Room room) throws RemoteException {
<span class="nc" id="L271">        return serverAdminInterface.delRoom(room,authToken);</span>
    }

    public User updateUser(User user) throws RemoteException {
<span class="nc" id="L275">        return serverAdminInterface.updateUser(user,authToken);</span>
    }

    public User updateUserGroup(User user) throws RemoteException {
<span class="nc" id="L279">        return serverAdminInterface.updateUserGroup(user,authToken);</span>
    }

    public Group updateGroup(Group group) throws RemoteException {
<span class="nc" id="L283">        return serverAdminInterface.updateGroup(group,authToken);</span>
    }

    public Room updateRoom(Room room) throws RemoteException {
<span class="nc" id="L287">        return serverAdminInterface.updateRoom(room,authToken);</span>
    }

    public boolean setNewDefaultPassword(String newPass) throws RemoteException {
<span class="nc" id="L291">        return serverAdminInterface.setNewDefaultPassword(stringEnc.encrypt(newPass),authToken);</span>
    }

    public void shutdown(String justification) throws RemoteException {
<span class="nc" id="L295">        serverAdminInterface.ping();</span>
        try{
<span class="nc" id="L297">            serverAdminInterface.shutdownServer(justification,authToken);</span>
<span class="nc" id="L298">        }catch(Throwable t){</span>
            //nothing to done
<span class="nc" id="L300">        }</span>
<span class="nc" id="L301">    }</span>

    public void kickOffUsers(String justification) throws RemoteException {
<span class="nc" id="L304">        serverAdminInterface.kickOffUsers(justification,authToken);</span>
<span class="nc" id="L305">    }</span>

    public void kickOffUser(int userId) throws RemoteException {
<span class="nc" id="L308">        serverAdminInterface.kickOffUser(userId,authToken);</span>
<span class="nc" id="L309">    }</span>

    public boolean ping() throws Exception {
        try {
<span class="nc" id="L313">            return serverAdminInterface.ping();</span>
<span class="nc" id="L314">        } catch (Exception ex) {</span>
            try {
<span class="nc" id="L316">                initServer();</span>
<span class="nc" id="L317">                return serverAdminInterface.ping();</span>
<span class="nc" id="L318">            } catch (Exception ex1) {</span>
<span class="nc" id="L319">                throw ex1;</span>
            }
        }
    }

    public User resetUserPass(User user) throws RemoteException {
<span class="nc" id="L325">        return serverAdminInterface.resetUserPass(user,authToken);</span>
    }

    public boolean setLogLevel(int level) throws RemoteException {
<span class="nc" id="L329">        return serverAdminInterface.setLogLevel(level, true,authToken);</span>
    }

    /**
     * @return the connectedClientsIPs
     */
    public Hashtable&lt;Integer, String&gt; getConnectedClientsIPs() {
<span class="nc" id="L336">        return connectedClientsIPs;</span>
    }

    public void returnOnlineIPs() throws RemoteException {
<span class="nc" id="L340">        connectedClientsIPs = serverAdminInterface.returnOnlineIPs(authToken);</span>
<span class="nc" id="L341">    }</span>

    public int setSecurityLevel(int level) throws RemoteException {
<span class="nc" id="L344">        securityMode=level;</span>
<span class="nc" id="L345">        return serverAdminInterface.setSecurityMode(level,authToken);</span>
    }

    public int getLogLevel() throws RemoteException {
<span class="nc" id="L349">        return serverAdminInterface.getLogLevel(authToken);</span>
    }

    public int getSecurityLevel() throws RemoteException {
<span class="nc" id="L353">        return serverAdminInterface.getSecurityMode(authToken);</span>
    }

    public boolean sendGlobalTextAnn(String msg) throws RemoteException {
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (securityMode == 0) {</span>
<span class="nc" id="L358">            return serverAdminInterface.sendGlobalTextAnn(msg,authToken);</span>
        } else {
<span class="nc" id="L360">            msg=stringEnc.encrypt(msg);</span>
<span class="nc" id="L361">            return serverAdminInterface.sendGlobalSecureTextAnn(msg,authToken);</span>
        }
    }
    public boolean setNewRootNode(String rootNode) throws RemoteException{
<span class="nc" id="L365">        this.rootNode=rootNode;</span>
<span class="nc" id="L366">        return serverAdminInterface.setRootNode(rootNode,authToken);</span>
    }
    public boolean refreshContactList() throws RemoteException{
<span class="nc" id="L369">        return serverAdminInterface.refreshContactList(authToken);</span>
    }

    /**
     * @return the rootNode
     */
    public String getRootNode() {
<span class="nc" id="L376">        return rootNode;</span>
    }

    /**
     * @return the adminSettingBean
     */
    public AdminSettingBean getAdminSettingBean() {
<span class="nc" id="L383">        return adminSettingBean;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>