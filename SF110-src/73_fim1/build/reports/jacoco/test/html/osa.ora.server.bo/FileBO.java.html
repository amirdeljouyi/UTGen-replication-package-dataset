<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileBO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">73_fim1</a> &gt; <a href="index.source.html" class="el_package">osa.ora.server.bo</a> &gt; <span class="el_source">FileBO.java</span></div><h1>FileBO.java</h1><pre class="source lang-java linenums">/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package osa.ora.server.bo;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.OutputStreamWriter;
import java.util.Calendar;
import java.util.Hashtable;
import java.util.Properties;
import java.util.Vector;
import java.util.logging.Level;
import java.util.logging.Logger;
import osa.ora.server.ModernChatServer;
import osa.ora.server.beans.Group;
import osa.ora.server.beans.IConstant;
import osa.ora.server.beans.Room;
import osa.ora.server.beans.User;
import osa.ora.server.utils.XMLParser;

/**
 *
 * @author ooransa
 */
public class FileBO implements IBO {

    String path;
    XMLParser parser1;
    XMLParser parser2;
    XMLParser parser3;
    Properties config;
    private Logger logger;
    private User adminUser;
    private ModernChatServer modernServer;
    private Hashtable&lt;Integer, String&gt; passwords;
    private static final String SERVER_DATA_1_FILE_NAME = &quot;/config/data1.xml&quot;;
    private static final String SERVER_DATA_2_FILE_NAME = &quot;/config/data2.xml&quot;;
    private static final String SERVER_DATA_3_FILE_NAME = &quot;/config/data3.xml&quot;;
    private static final String SERVER_TRANS_FILE_NAME = &quot;/config/trans.dat&quot;;

<span class="nc" id="L45">    public FileBO(String path,ModernChatServer modernServer) throws Exception {</span>
<span class="nc" id="L46">        this.path = path;</span>
<span class="nc" id="L47">        this.modernServer=modernServer;</span>
<span class="nc" id="L48">        this.logger=ModernChatServer.getLogger();</span>
<span class="nc" id="L49">        loadXMLFile(path);</span>
<span class="nc" id="L50">        config = new Properties();</span>
        try {
<span class="nc" id="L52">            config.load(new FileInputStream(path + SERVER_TRANS_FILE_NAME));</span>
<span class="nc" id="L53">        } catch (Exception e) {</span>
<span class="nc" id="L54">            logger.log(Level.SEVERE, &quot;Server Data Error!,Can't load user passwords!&quot;,e);</span>
<span class="nc" id="L55">        }</span>
<span class="nc" id="L56">        passwords = new Hashtable&lt;Integer, String&gt;();</span>
<span class="nc" id="L57">    }</span>

    private void loadXMLFile(String path) throws Exception {
<span class="nc" id="L60">        parser1 = new XMLParser(path + SERVER_DATA_1_FILE_NAME);</span>
<span class="nc" id="L61">        parser2 = new XMLParser(path + SERVER_DATA_2_FILE_NAME);</span>
<span class="nc" id="L62">        parser3 = new XMLParser(path + SERVER_DATA_3_FILE_NAME);</span>
<span class="nc" id="L63">    }</span>
    public Vector&lt;Group&gt; loadGroupsAndUsers() {
<span class="nc" id="L65">        logger.log(Level.FINE, &quot;Load All Users and Groups&quot;);</span>
<span class="nc" id="L66">        Vector&lt;Group&gt; result = new Vector&lt;Group&gt;(0);</span>
        //load groups
<span class="nc" id="L68">        Vector tempVector = parser1.getProperty(&quot;group&quot;);</span>
<span class="nc" id="L69">        logger.log(Level.FINE, &quot;All Groups size=&quot; + tempVector.size());</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">        for (int i = 0; i &lt; tempVector.size(); i++) {</span>
<span class="nc" id="L71">            Group groupTemp = new Group();</span>
<span class="nc" id="L72">            Hashtable hashTemp = (Hashtable) tempVector.get(i);</span>
<span class="nc" id="L73">            groupTemp.setId(Integer.parseInt((String) hashTemp.get(&quot;id&quot;)));</span>
<span class="nc" id="L74">            groupTemp.setName((String) hashTemp.get(&quot;name&quot;));</span>
<span class="nc" id="L75">            groupTemp.setUsers(new Vector&lt;User&gt;());</span>
<span class="nc" id="L76">            result.add(groupTemp);</span>
        }
<span class="nc" id="L78">        tempVector = parser2.getProperty(&quot;user&quot;);</span>
<span class="nc" id="L79">        logger.log(Level.FINE, &quot;All Users size=&quot; + tempVector.size());</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        for (int i = 0; i &lt; tempVector.size(); i++) {</span>
<span class="nc" id="L81">            User userTemp = new User();</span>
<span class="nc" id="L82">            Hashtable hashTemp = (Hashtable) tempVector.get(i);</span>
<span class="nc" id="L83">            userTemp.setId(Integer.parseInt((String) hashTemp.get(&quot;id&quot;)));</span>
<span class="nc" id="L84">            userTemp.setName((String) hashTemp.get(&quot;name&quot;));</span>
<span class="nc" id="L85">            userTemp.setEmail((String) hashTemp.get(&quot;email&quot;));</span>
<span class="nc" id="L86">            userTemp.setDirectPhone((String) hashTemp.get(&quot;directPhone&quot;));</span>
<span class="nc" id="L87">            userTemp.setJobTitle((String) hashTemp.get(&quot;jobTitle&quot;));</span>
<span class="nc" id="L88">            userTemp.setGroup_id(Integer.parseInt((String) hashTemp.get(&quot;groupId&quot;)));</span>
<span class="nc" id="L89">            userTemp.setCanJoinChatRoom(Boolean.parseBoolean((String) hashTemp.get(&quot;canJoinChatRoom&quot;)));</span>
<span class="nc" id="L90">            userTemp.setOnlyStartChat(Boolean.parseBoolean((String) hashTemp.get(&quot;onlyStartChat&quot;)));</span>
<span class="nc" id="L91">            userTemp.setShowMyStatus(Boolean.parseBoolean((String) hashTemp.get(&quot;showStatus&quot;)));</span>
<span class="nc" id="L92">            userTemp.setStatus_id(IConstant.SIGN_OUT);</span>
<span class="nc" id="L93">            String password = config.getProperty(&quot;&quot; + userTemp.getId());</span>
            //only add user if he has group :)
            //admin user doesn't have group

<span class="nc bnc" id="L97" title="All 2 branches missed.">            if(userTemp.getId()==1000){</span>
<span class="nc" id="L98">                adminUser=userTemp;</span>
<span class="nc" id="L99">                getPasswords().put(userTemp.getId(), password);</span>
            }else{
<span class="nc bnc" id="L101" title="All 2 branches missed.">                for (int n = 0; n &lt; result.size(); n++) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">                    if (result.get(n).getId() == userTemp.getGroup_id()) {</span>
<span class="nc" id="L103">                        result.get(n).getUsers().add(userTemp);</span>
<span class="nc" id="L104">                        getPasswords().put(userTemp.getId(), password);</span>
<span class="nc" id="L105">                        break;</span>
                    }
                }
            }
        }
<span class="nc" id="L110">        System.gc();</span>
<span class="nc" id="L111">        return result;</span>
    }
    public User getAdminUser(){
<span class="nc" id="L114">        return adminUser;</span>
    }
    public Vector&lt;Room&gt; loadRooms() {
<span class="nc" id="L117">        logger.log(Level.FINE, &quot;Load All Rooms&quot;);</span>
<span class="nc" id="L118">        Vector&lt;Room&gt; result = new Vector&lt;Room&gt;();</span>
<span class="nc" id="L119">        Vector tempVector = parser3.getProperty(&quot;room&quot;);</span>
<span class="nc" id="L120">        logger.log(Level.FINE, &quot;All rooms size=&quot; + tempVector.size());</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        for (int i = 0; i &lt; tempVector.size(); i++) {</span>
<span class="nc" id="L122">            Room roomTemp = new Room();</span>
<span class="nc" id="L123">            Hashtable hashTemp = (Hashtable) tempVector.get(i);</span>
<span class="nc" id="L124">            roomTemp.setId(Integer.parseInt((String) hashTemp.get(&quot;id&quot;)));</span>
<span class="nc" id="L125">            roomTemp.setName((String) hashTemp.get(&quot;name&quot;));</span>
<span class="nc" id="L126">            String users = (String) hashTemp.get(&quot;users&quot;);</span>
<span class="nc bnc" id="L127" title="All 4 branches missed.">            if (users != null &amp;&amp; users.length() &gt; 0) {</span>
<span class="nc" id="L128">                String[] userIds = users.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">                if (userIds != null &amp;&amp; userIds.length &gt; 0) {</span>
<span class="nc" id="L130">                    int[] roomUsers = new int[userIds.length];</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                    for (int n = 0; n &lt; userIds.length; n++) {</span>
<span class="nc" id="L132">                        roomUsers[n] = Integer.parseInt(userIds[n]);</span>
                    }
<span class="nc" id="L134">                    roomTemp.setUserId(roomUsers);</span>
                    //this is done here to enuse no room is added unless it
                    //has users assigened on it.
<span class="nc" id="L137">                    result.add(roomTemp);</span>
                }
            }
        }
<span class="nc" id="L141">        System.gc();</span>
<span class="nc" id="L142">        return result;</span>
    }

    /**
     * @return the passwords
     */
    public Hashtable&lt;Integer, String&gt; getPasswords() {
<span class="nc" id="L149">        return passwords;</span>
    }

    private Group saveNewGroup(Vector&lt;Group&gt; groups, Group newGroup) {
<span class="nc" id="L153">        logger.log(Level.FINE, &quot;Save New Group&quot;);</span>
<span class="nc" id="L154">        File tempFile = new File(path + SERVER_DATA_1_FILE_NAME);</span>
<span class="nc" id="L155">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L157">            tempFile.createNewFile();</span>
<span class="nc" id="L158">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L159">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L160">            out.newLine();</span>
<span class="nc" id="L161">            out.write(&quot;&lt;groups&gt;&quot;);</span>
<span class="nc" id="L162">            out.newLine();</span>
<span class="nc" id="L163">            int maxId = 0;</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc" id="L165">                groups.get(i).writeToFile(out);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">                if (groups.get(i).getId() &gt; maxId) {</span>
<span class="nc" id="L167">                    maxId = groups.get(i).getId();</span>
                }
            }
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if(maxId&lt;100) maxId=100;</span>
<span class="nc" id="L171">            newGroup.setId(maxId + 1);</span>
<span class="nc" id="L172">            newGroup.writeToFile(out);</span>
<span class="nc" id="L173">            out.write(&quot;&lt;/groups&gt;&quot;);</span>
<span class="nc" id="L174">            out.newLine();</span>
<span class="nc" id="L175">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L176">            out.newLine();</span>
<span class="nc" id="L177">            out.flush();</span>
<span class="nc" id="L178">            out.close();</span>
<span class="nc" id="L179">            groups.add(newGroup);</span>
<span class="nc" id="L180">            return newGroup;</span>
<span class="nc" id="L181">        } catch (Exception e) {</span>
<span class="nc" id="L182">            logger.log(Level.SEVERE, &quot;Server Data Error!,Can't save groups!&quot;,e);</span>
<span class="nc" id="L183">            return null;</span>
        } finally {
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L187">                    out.close();</span>
<span class="nc" id="L188">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L190">                }</span>
            }
        }
    }

    private User saveNewUser(Vector&lt;Group&gt; groups,User adminUser,  User newUser,String defaultPass) {
<span class="nc" id="L196">        logger.log(Level.FINE, &quot;Save New User&quot;);</span>
<span class="nc" id="L197">        File tempFile = new File(path + SERVER_DATA_2_FILE_NAME);</span>
<span class="nc" id="L198">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L200">            tempFile.createNewFile();</span>
<span class="nc" id="L201">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L202">            out.write(&quot;&lt;data&gt;&quot;);</span>

<span class="nc" id="L204">            out.newLine();</span>
<span class="nc" id="L205">            out.write(&quot;&lt;users&gt;&quot;);</span>
<span class="nc" id="L206">            out.newLine();</span>
<span class="nc" id="L207">            adminUser.writeToFile(out);</span>
<span class="nc" id="L208">            int maxId = 0;</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc" id="L210">                Vector&lt;User&gt; tempUsers = groups.get(i).getUsers();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                for (int n = 0; n &lt; tempUsers.size(); n++) {</span>
<span class="nc" id="L212">                    tempUsers.get(n).writeToFile(out);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                    if (tempUsers.get(n).getId() &gt; maxId) {</span>
<span class="nc" id="L214">                        maxId = tempUsers.get(n).getId();</span>
                    }
                }
            }
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if(maxId&lt;1000) maxId=1000;</span>
<span class="nc" id="L219">            newUser.setId(maxId + 1);</span>
<span class="nc" id="L220">            newUser.writeToFile(out);</span>
<span class="nc" id="L221">            out.write(&quot;&lt;/users&gt;&quot;);</span>
<span class="nc" id="L222">            out.newLine();</span>
<span class="nc" id="L223">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L224">            out.newLine();</span>
<span class="nc" id="L225">            out.flush();</span>
<span class="nc" id="L226">            out.close();</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                if (groups.get(i).getId() == newUser.getGroup_id()) {</span>
<span class="nc" id="L229">                    newUser.setStatus_id(IConstant.SIGN_OUT);</span>
<span class="nc" id="L230">                    groups.get(i).getUsers().add(newUser);</span>
<span class="nc" id="L231">                    break;</span>
                }
            }
<span class="nc" id="L234">            config.setProperty(&quot;&quot; + newUser.getId(), defaultPass);</span>
<span class="nc" id="L235">            savePasswordFile();</span>
<span class="nc" id="L236">            return newUser;</span>
<span class="nc" id="L237">        } catch (Exception e) {</span>
<span class="nc" id="L238">            logger.log(Level.SEVERE, &quot;Server Data Error!, Can't save users!&quot;,e);</span>
<span class="nc" id="L239">            return null;</span>
        } finally {
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L243">                    out.close();</span>
<span class="nc" id="L244">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L246">                }</span>
            }
        }
    }

    private void savePasswordFile() throws Exception {
<span class="nc" id="L252">        logger.log(Level.FINE, &quot;Save Password File&quot;);</span>
        try {
<span class="nc" id="L254">            BufferedWriter out = null;</span>
<span class="nc" id="L255">            File tempFile = new File(path + SERVER_TRANS_FILE_NAME);</span>
<span class="nc" id="L256">            tempFile.createNewFile();</span>
<span class="nc" id="L257">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L258">            config.store(out, &quot;Updated AT :&quot; + Calendar.getInstance());</span>
<span class="nc" id="L259">        } catch (Exception e) {</span>
<span class="nc" id="L260">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save password file!&quot;,e);</span>
<span class="nc" id="L261">            throw e;</span>
<span class="nc" id="L262">        }</span>
<span class="nc" id="L263">    }</span>

    private Room saveNewRoom(Vector&lt;Room&gt; rooms, Room newRoom) {
<span class="nc" id="L266">        logger.log(Level.FINE, &quot;Save New Room&quot;);</span>
<span class="nc" id="L267">        File tempFile = new File(path + SERVER_DATA_3_FILE_NAME);</span>
<span class="nc" id="L268">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L270">            tempFile.createNewFile();</span>
<span class="nc" id="L271">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L272">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L273">            out.newLine();</span>
<span class="nc" id="L274">            out.write(&quot;&lt;rooms&gt;&quot;);</span>
<span class="nc" id="L275">            out.newLine();</span>
<span class="nc" id="L276">            int maxId = 0;</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            for (int i = 0; i &lt; rooms.size(); i++) {</span>
<span class="nc" id="L278">                rooms.get(i).writeToFile(out);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                if (rooms.get(i).getId() &gt; maxId) {</span>
<span class="nc" id="L280">                    maxId = rooms.get(i).getId();</span>
                }
            }
<span class="nc bnc" id="L283" title="All 2 branches missed.">            if(maxId&lt;10000) maxId=10000;</span>
<span class="nc" id="L284">            newRoom.setId(maxId + 1);</span>
<span class="nc" id="L285">            newRoom.writeToFile(out);</span>
<span class="nc" id="L286">            out.write(&quot;&lt;/rooms&gt;&quot;);</span>
<span class="nc" id="L287">            out.newLine();</span>
<span class="nc" id="L288">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L289">            out.newLine();</span>
<span class="nc" id="L290">            out.flush();</span>
<span class="nc" id="L291">            out.close();</span>
<span class="nc" id="L292">            rooms.add(newRoom);</span>
<span class="nc" id="L293">            return newRoom;</span>
<span class="nc" id="L294">        } catch (Exception e) {</span>
<span class="nc" id="L295">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save rooms!&quot;,e);</span>
<span class="nc" id="L296">            return null;</span>
        } finally {
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L300">                    out.close();</span>
<span class="nc" id="L301">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L303">                }</span>
            }
        }
    }

    private Group deleteGroup(Vector&lt;Group&gt; groups, Group delGroup) {
<span class="nc" id="L309">        logger.log(Level.FINE, &quot;Delete Group&quot;);</span>
<span class="nc" id="L310">        File tempFile = new File(path + SERVER_DATA_1_FILE_NAME);</span>
<span class="nc" id="L311">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L313">            tempFile.createNewFile();</span>
<span class="nc" id="L314">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L315">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L316">            out.newLine();</span>
<span class="nc" id="L317">            out.write(&quot;&lt;groups&gt;&quot;);</span>
<span class="nc" id="L318">            out.newLine();</span>
<span class="nc" id="L319">            int index = -1;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                if (groups.get(i).getId() != delGroup.getId()) {</span>
<span class="nc" id="L322">                    groups.get(i).writeToFile(out);</span>
                } else {
<span class="nc" id="L324">                    index = i;</span>
                }
            }
<span class="nc" id="L327">            out.write(&quot;&lt;/groups&gt;&quot;);</span>
<span class="nc" id="L328">            out.newLine();</span>
<span class="nc" id="L329">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L330">            out.newLine();</span>
<span class="nc" id="L331">            out.flush();</span>
<span class="nc" id="L332">            out.close();</span>
<span class="nc" id="L333">            groups.remove(index);</span>
<span class="nc" id="L334">            return delGroup;</span>
<span class="nc" id="L335">        } catch (Exception e) {</span>
<span class="nc" id="L336">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save groups!&quot;,e);</span>
<span class="nc" id="L337">            return null;</span>
        } finally {
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L341">                    out.close();</span>
<span class="nc" id="L342">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L344">                }</span>
            }
        }
    }

    private Room deleteRoom(Vector&lt;Room&gt; rooms, Room delRoom) {
<span class="nc" id="L350">        logger.log(Level.FINE, &quot;Delete Room&quot;);</span>
<span class="nc" id="L351">        File tempFile = new File(path + SERVER_DATA_3_FILE_NAME);</span>
<span class="nc" id="L352">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L354">            tempFile.createNewFile();</span>
<span class="nc" id="L355">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L356">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L357">            out.newLine();</span>
<span class="nc" id="L358">            out.write(&quot;&lt;rooms&gt;&quot;);</span>
<span class="nc" id="L359">            out.newLine();</span>
<span class="nc" id="L360">            int index = -1;</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">            for (int i = 0; i &lt; rooms.size(); i++) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">                if (rooms.get(i).getId() != delRoom.getId()) {</span>
<span class="nc" id="L363">                    rooms.get(i).writeToFile(out);</span>
                } else {
<span class="nc" id="L365">                    index = i;</span>
                }
            }
<span class="nc" id="L368">            out.write(&quot;&lt;/rooms&gt;&quot;);</span>
<span class="nc" id="L369">            out.newLine();</span>
<span class="nc" id="L370">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L371">            out.newLine();</span>
<span class="nc" id="L372">            out.flush();</span>
<span class="nc" id="L373">            out.close();</span>
<span class="nc" id="L374">            rooms.remove(index);</span>
<span class="nc" id="L375">            return delRoom;</span>
<span class="nc" id="L376">        } catch (Exception e) {</span>
<span class="nc" id="L377">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save rooms!&quot;,e);</span>
<span class="nc" id="L378">            return null;</span>
        } finally {
<span class="nc bnc" id="L380" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L382">                    out.close();</span>
<span class="nc" id="L383">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L385">                }</span>
            }
        }
    }

    private User deleteUser(Vector&lt;Group&gt; groups,User adminUser, User delUser) {
<span class="nc" id="L391">        logger.log(Level.FINE, &quot;Delete User&quot;);</span>
<span class="nc" id="L392">        File tempFile = new File(path + SERVER_DATA_2_FILE_NAME);</span>
<span class="nc" id="L393">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L395">            tempFile.createNewFile();</span>
<span class="nc" id="L396">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L397">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L398">            out.newLine();</span>
<span class="nc" id="L399">            out.write(&quot;&lt;users&gt;&quot;);</span>
<span class="nc" id="L400">            out.newLine();</span>
<span class="nc" id="L401">            adminUser.writeToFile(out);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc" id="L403">                Vector&lt;User&gt; tempUsers = groups.get(i).getUsers();</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                for (int n = 0; n &lt; tempUsers.size(); n++) {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">                    if (tempUsers.get(n).getId() != delUser.getId()) {</span>
<span class="nc" id="L406">                        tempUsers.get(n).writeToFile(out);</span>
                    }
                }
            }
<span class="nc" id="L410">            out.write(&quot;&lt;/users&gt;&quot;);</span>
<span class="nc" id="L411">            out.newLine();</span>
<span class="nc" id="L412">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L413">            out.newLine();</span>
<span class="nc" id="L414">            out.flush();</span>
<span class="nc" id="L415">            out.close();</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                if (groups.get(i).getId() == delUser.getGroup_id()) {</span>
<span class="nc" id="L418">                    Vector&lt;User&gt; tempUsers = groups.get(i).getUsers();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                    for (int n = 0; n &lt; tempUsers.size(); n++) {</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">                        if (tempUsers.get(n).getId() == delUser.getId()) {</span>
<span class="nc" id="L421">                            groups.get(i).getUsers().remove(n);</span>
<span class="nc" id="L422">                            break;</span>
                        }
                    }
                }
            }
<span class="nc" id="L427">            return delUser;</span>
<span class="nc" id="L428">        } catch (Exception e) {</span>
<span class="nc" id="L429">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save users!&quot;,e);</span>
<span class="nc" id="L430">            return null;</span>
        } finally {
<span class="nc bnc" id="L432" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L434">                    out.close();</span>
<span class="nc" id="L435">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L437">                }</span>
            }
        }
    }

    private User updateUser(Vector&lt;Group&gt; groups,User adminUser, User updUser) {
<span class="nc" id="L443">        logger.log(Level.FINE, &quot;Update User&quot;);</span>
<span class="nc" id="L444">        File tempFile = new File(path + SERVER_DATA_2_FILE_NAME);</span>
<span class="nc" id="L445">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L447">            tempFile.createNewFile();</span>
<span class="nc" id="L448">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L449">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L450">            out.newLine();</span>
<span class="nc" id="L451">            out.write(&quot;&lt;users&gt;&quot;);</span>
<span class="nc" id="L452">            out.newLine();</span>
<span class="nc" id="L453">            adminUser.writeToFile(out);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc" id="L455">                Vector&lt;User&gt; tempUsers = groups.get(i).getUsers();</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                for (int n = 0; n &lt; tempUsers.size(); n++) {</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">                    if (tempUsers.get(n).getId() != updUser.getId()) {</span>
<span class="nc" id="L458">                        tempUsers.get(n).writeToFile(out);</span>
                    } else {
<span class="nc" id="L460">                        updUser.writeToFile(out);</span>
                    }
                }
            }
<span class="nc" id="L464">            out.write(&quot;&lt;/users&gt;&quot;);</span>
<span class="nc" id="L465">            out.newLine();</span>
<span class="nc" id="L466">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L467">            out.newLine();</span>
<span class="nc" id="L468">            out.flush();</span>
<span class="nc" id="L469">            out.close();</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">                if (groups.get(i).getId() == updUser.getGroup_id()) {</span>
<span class="nc" id="L472">                    Vector&lt;User&gt; tempUsers = groups.get(i).getUsers();</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">                    for (int n = 0; n &lt; tempUsers.size(); n++) {</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">                        if (tempUsers.get(n).getId() == updUser.getId()) {</span>
<span class="nc" id="L475">                            groups.get(i).getUsers().set(n, updUser);</span>
<span class="nc" id="L476">                            break;</span>
                        }
                    }
                }
            }
<span class="nc" id="L481">            return updUser;</span>
<span class="nc" id="L482">        } catch (Exception e) {</span>
<span class="nc" id="L483">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save users!&quot;,e);</span>
<span class="nc" id="L484">            return null;</span>
        } finally {
<span class="nc bnc" id="L486" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L488">                    out.close();</span>
<span class="nc" id="L489">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L491">                }</span>
            }
        }
    }
    private User updateUserGroup(Vector&lt;Group&gt; groups,User adminUser, User updUser) {
<span class="nc" id="L496">        logger.log(Level.FINE, &quot;Update User Group&quot;);</span>
<span class="nc" id="L497">        File tempFile = new File(path + SERVER_DATA_2_FILE_NAME);</span>
<span class="nc" id="L498">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L500">            tempFile.createNewFile();</span>
<span class="nc" id="L501">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L502">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L503">            out.newLine();</span>
<span class="nc" id="L504">            out.write(&quot;&lt;users&gt;&quot;);</span>
<span class="nc" id="L505">            out.newLine();</span>
<span class="nc" id="L506">            adminUser.writeToFile(out);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc" id="L508">                Vector&lt;User&gt; tempUsers = groups.get(i).getUsers();</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                for (int n = 0; n &lt; tempUsers.size(); n++) {</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">                    if (tempUsers.get(n).getId() != updUser.getId()) {</span>
<span class="nc" id="L511">                        tempUsers.get(n).writeToFile(out);</span>
                    } else {
<span class="nc" id="L513">                        updUser.writeToFile(out);</span>
                    }
                }
            }
<span class="nc" id="L517">            out.write(&quot;&lt;/users&gt;&quot;);</span>
<span class="nc" id="L518">            out.newLine();</span>
<span class="nc" id="L519">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L520">            out.newLine();</span>
<span class="nc" id="L521">            out.flush();</span>
<span class="nc" id="L522">            out.close();</span>
            //remove from old group
<span class="nc bnc" id="L524" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc" id="L525">                Vector&lt;User&gt; tempUsers = groups.get(i).getUsers();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">                for (int n = 0; n &lt; tempUsers.size(); n++) {</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                    if (tempUsers.get(n).getId() == updUser.getId()) {</span>
<span class="nc" id="L528">                        groups.get(i).getUsers().remove(n);</span>
<span class="nc" id="L529">                        break;</span>
                    }
                }
            }
            //add to the new group
<span class="nc bnc" id="L534" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                if (groups.get(i).getId() == updUser.getGroup_id()) {</span>
<span class="nc" id="L536">                    groups.get(i).getUsers().add(updUser);</span>
<span class="nc" id="L537">                    break;</span>
                }
            }
<span class="nc" id="L540">            return updUser;</span>
<span class="nc" id="L541">        } catch (Exception e) {</span>
<span class="nc" id="L542">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save users!&quot;,e);</span>
<span class="nc" id="L543">            return null;</span>
        } finally {
<span class="nc bnc" id="L545" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L547">                    out.close();</span>
<span class="nc" id="L548">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L550">                }</span>
            }
        }
    }

    private Group updateGroup(Vector&lt;Group&gt; groups, Group updateGroup) {
<span class="nc" id="L556">        logger.log(Level.FINE, &quot;Update Group&quot;);</span>
<span class="nc" id="L557">        File tempFile = new File(path + SERVER_DATA_1_FILE_NAME);</span>
<span class="nc" id="L558">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L560">            tempFile.createNewFile();</span>
<span class="nc" id="L561">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L562">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L563">            out.newLine();</span>
<span class="nc" id="L564">            out.write(&quot;&lt;groups&gt;&quot;);</span>
<span class="nc" id="L565">            out.newLine();</span>
<span class="nc" id="L566">            int index = 0;</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">            for (int i = 0; i &lt; groups.size(); i++) {</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">                if (groups.get(i).getId() != updateGroup.getId()) {</span>
<span class="nc" id="L569">                    groups.get(i).writeToFile(out);</span>
                } else {
<span class="nc" id="L571">                    updateGroup.writeToFile(out);</span>
<span class="nc" id="L572">                    index = i;</span>
                }
            }
<span class="nc" id="L575">            out.write(&quot;&lt;/groups&gt;&quot;);</span>
<span class="nc" id="L576">            out.newLine();</span>
<span class="nc" id="L577">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L578">            out.newLine();</span>
<span class="nc" id="L579">            out.flush();</span>
<span class="nc" id="L580">            out.close();</span>
<span class="nc" id="L581">            groups.set(index, updateGroup);</span>
<span class="nc" id="L582">            return updateGroup;</span>
<span class="nc" id="L583">        } catch (Exception e) {</span>
<span class="nc" id="L584">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save groups!&quot;,e);</span>
<span class="nc" id="L585">            return null;</span>
        } finally {
<span class="nc bnc" id="L587" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L589">                    out.close();</span>
<span class="nc" id="L590">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L592">                }</span>
            }
        }
    }

    private Room updateRoom(Vector&lt;Room&gt; rooms, Room updateRoom) {
<span class="nc" id="L598">        logger.log(Level.FINE, &quot;Update Room&quot;);</span>
<span class="nc" id="L599">        File tempFile = new File(path + SERVER_DATA_3_FILE_NAME);</span>
<span class="nc" id="L600">        BufferedWriter out = null;</span>
        try {
<span class="nc" id="L602">            tempFile.createNewFile();</span>
<span class="nc" id="L603">            out = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(tempFile),&quot;UTF8&quot;));</span>
<span class="nc" id="L604">            out.write(&quot;&lt;data&gt;&quot;);</span>
<span class="nc" id="L605">            out.newLine();</span>
<span class="nc" id="L606">            out.write(&quot;&lt;rooms&gt;&quot;);</span>
<span class="nc" id="L607">            out.newLine();</span>
<span class="nc" id="L608">            int index = 0;</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">            for (int i = 0; i &lt; rooms.size(); i++) {</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">                if (rooms.get(i).getId() != updateRoom.getId()) {</span>
<span class="nc" id="L611">                    rooms.get(i).writeToFile(out);</span>
                } else {
<span class="nc" id="L613">                    updateRoom.writeToFile(out);</span>
<span class="nc" id="L614">                    index = i;</span>
                }
            }
<span class="nc" id="L617">            out.write(&quot;&lt;/rooms&gt;&quot;);</span>
<span class="nc" id="L618">            out.newLine();</span>
<span class="nc" id="L619">            out.write(&quot;&lt;/data&gt;&quot;);</span>
<span class="nc" id="L620">            out.newLine();</span>
<span class="nc" id="L621">            out.flush();</span>
<span class="nc" id="L622">            out.close();</span>
<span class="nc" id="L623">            rooms.set(index, updateRoom);</span>
<span class="nc" id="L624">            return updateRoom;</span>
<span class="nc" id="L625">        } catch (Exception e) {</span>
<span class="nc" id="L626">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't save rooms!&quot;,e);</span>
<span class="nc" id="L627">            return null;</span>
        } finally {
<span class="nc bnc" id="L629" title="All 2 branches missed.">            if (out != null) {</span>
                try {
<span class="nc" id="L631">                    out.close();</span>
<span class="nc" id="L632">                } catch (Exception e) {</span>
                    //e.printStackTrace();
<span class="nc" id="L634">                }</span>
            }
        }
    }

    public User createUser(User user) {
<span class="nc" id="L640">        return saveNewUser(modernServer.getGroups(),modernServer.getAdminUser(), user,modernServer.getServerSettingBean().getDefualtPassword());</span>
    }

    public Group createGroup(Group group) {
<span class="nc" id="L644">        return saveNewGroup(modernServer.getGroups(), group);</span>
    }

    public Room createRoom(Room room) {
<span class="nc" id="L648">        return saveNewRoom(modernServer.getRooms(), room);</span>
    }

    public User delUser(User user) {
<span class="nc" id="L652">        return deleteUser(modernServer.getGroups(),modernServer.getAdminUser(), user);</span>
    }

    public Group delGroup(Group group) {
<span class="nc" id="L656">        return deleteGroup(modernServer.getGroups(), group);</span>
    }

    public Room delRoom(Room room) {
<span class="nc" id="L660">        return deleteRoom(modernServer.getRooms(), room);</span>
    }

    public User updateUser(User user) {
<span class="nc" id="L664">        return updateUser(modernServer.getGroups(),modernServer.getAdminUser(), user);</span>
    }

    public Group updateGroup(Group group) {
<span class="nc" id="L668">        return updateGroup(modernServer.getGroups(), group);</span>
    }

    public Room updateRoom(Room room) {
<span class="nc" id="L672">        return updateRoom(modernServer.getRooms(), room);</span>
    }

    public boolean updatePassword(int userId,String oldPass, String newPass) {
<span class="nc" id="L676">        logger.log(Level.FINE, &quot;Update Password&quot;);</span>
<span class="nc" id="L677">        config.setProperty(&quot;&quot; + userId,newPass);</span>
        try {
<span class="nc" id="L679">            savePasswordFile();</span>
<span class="nc" id="L680">            return true;</span>
<span class="nc" id="L681">        } catch (Exception ex) {</span>
<span class="nc" id="L682">            config.setProperty(&quot;&quot; + userId,oldPass);</span>
<span class="nc" id="L683">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't update user password!&quot;,ex);</span>
<span class="nc" id="L684">            return false;</span>
        }
    }

    public User resetUserPass(User user) {
<span class="nc" id="L689">        logger.log(Level.FINE, &quot;Reset User Password&quot;);</span>
<span class="nc" id="L690">        config.setProperty(&quot;&quot; + user.getId(),modernServer.getServerSettingBean().getDefualtPassword());</span>
        try {
<span class="nc" id="L692">            savePasswordFile();</span>
<span class="nc" id="L693">            return user;</span>
<span class="nc" id="L694">        } catch (Exception ex) {</span>
<span class="nc" id="L695">            logger.log(Level.SEVERE, &quot;Server Data Error!, can't reset user password!&quot;,ex);</span>
<span class="nc" id="L696">            return null;</span>
        }
    }

    public User updateUserGroup(User user) {
<span class="nc" id="L701">        return updateUserGroup(modernServer.getGroups(),modernServer.getAdminUser(),user);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>