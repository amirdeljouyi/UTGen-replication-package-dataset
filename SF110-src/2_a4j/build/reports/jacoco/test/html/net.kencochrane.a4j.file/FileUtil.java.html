<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">2_a4j</a> &gt; <a href="index.source.html" class="el_package">net.kencochrane.a4j.file</a> &gt; <span class="el_source">FileUtil.java</span></div><h1>FileUtil.java</h1><pre class="source lang-java linenums">/*
Copyright (c) 2003, Ken Cochrane
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted
provided that the following conditions are met:

    * Redistributions of source code must retain the above copyright notice,
    this list of conditions and the following disclaimer.

    * Redistributions in binary form must reproduce the above copyright notice,
    this list of conditions and the following disclaimer in the documentation
    and/or other materials provided with the distribution.

    * Neither the name of Ken Cochrane nor the names of its contributors may be used to endorse
    or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

*/
package net.kencochrane.a4j.file;

import net.kencochrane.a4j.data.Query;
import net.kencochrane.a4j.util.LoadProperties;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.util.ArrayList;
import java.util.Date;
import java.util.Properties;
import java.util.Random;

//import org.apache.log4j.Logger;

/**
 * http://www.KenCochrane.net
 * Ken Cochrane
 * Date: May 23, 2003
 * Time: 9:30:23 AM
 *
 *
 */
public class FileUtil {
    //  Logger log = Logger.getLogger(this.getClass());
    protected String cacheDir;
    protected long oldestAge;

<span class="fc" id="L56">    public FileUtil() {</span>
<span class="fc" id="L57">        Properties props = LoadProperties.instance().getProperties();</span>
<span class="fc" id="L58">        this.cacheDir = props.getProperty(&quot;cacheDir&quot;);</span>
        try {
<span class="fc" id="L60">            this.oldestAge = Long.parseLong(props.getProperty(&quot;cacheLife&quot;));</span>
<span class="nc" id="L61">        } catch (Exception e) {</span>
<span class="nc" id="L62">            this.oldestAge = 86400000;</span>
<span class="fc" id="L63">        }</span>
<span class="fc" id="L64">    }</span>

    //download file

    public boolean downloadOneASINFile(String asin, String type, String offer, String page, String saveFileName) {
        //     log.debug(&quot;download&quot;);
        //     log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L72">        ArrayList asins = new ArrayList();</span>
<span class="fc" id="L73">        Query xml = new Query();</span>
<span class="fc" id="L74">        String searchType = &quot;AsinSearch&quot;;</span>
        //String offer = &quot;all&quot;;
<span class="fc" id="L76">        String response = new String();</span>
<span class="fc" id="L77">        asins.add(asin);</span>
        try {
            //        log.debug(&quot;download - try&quot;);
<span class="nc" id="L80">            response = xml.sendRequest(xml.queryGenerator(searchType, type, page, offer, asins));</span>
<span class="nc" id="L81">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="nc" id="L82">            byte[] byteMe = response.getBytes();</span>
<span class="nc" id="L83">            out.write(byteMe);</span>
<span class="nc" id="L84">            out.close();</span>
<span class="nc" id="L85">            File file = new File(saveFileName);</span>
<span class="nc bnc" id="L86" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
                //       log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L88">                downloaded = false;</span>
            } else {
<span class="nc" id="L90">                downloaded = true;</span>
            }
<span class="fc" id="L92">        } catch (Exception e) {</span>
            //      log.error(e.toString());
<span class="fc" id="L94">            downloaded = false;</span>
<span class="nc" id="L95">        }</span>

<span class="fc" id="L97">        return downloaded;</span>
    }

    //delete file
    public void deleteFile(String fileName) {
        //      log.debug(&quot;In delete&quot;);
        boolean deleted;
<span class="fc" id="L104">        File file = new File(fileName);</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (file != null) {</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">            if (file.exists()) {</span>
<span class="nc" id="L107">                deleted = file.delete();</span>
                //            log.debug(&quot;deleted? &quot; + deleted);
                //             log.debug(&quot;delete file&quot;);
            }
        }
        //     log.debug(&quot;out of delete&quot;);
<span class="fc" id="L113">    }</span>

    //check file age
    public boolean isAgeGood(File file) {
        //      log.debug(&quot;is good - in&quot;);
<span class="fc" id="L118">        Date now = new Date();</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        if (file != null) {</span>
<span class="nc" id="L120">            long fileAge = file.lastModified();</span>
<span class="nc" id="L121">            long timeNow = now.getTime();</span>
<span class="nc" id="L122">            long timeDiff = timeNow - fileAge;</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (file.length() &lt; 1000) {</span>
                //        log.debug(&quot;File is Bad&quot;);
<span class="nc" id="L126">                return false;</span>
            }

<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (timeDiff &lt; oldestAge) {</span>
                //        log.debug(&quot;Good&quot;);
<span class="nc" id="L131">                return true;</span>
            } else {
                //         log.debug(&quot;bad&quot;);
<span class="nc" id="L134">                return false;</span>
            }
        } else {
            //         log.debug(&quot;bad file is null&quot;);
<span class="fc" id="L138">            return false;</span>
        }
    }

    //rename file
    public void renameFile(String oldFileName, String newFileName) {
        boolean renamed;
        //      log.debug(&quot;rename - in&quot;);
<span class="fc" id="L146">        File file = new File(oldFileName);</span>
<span class="fc" id="L147">        File newFile = new File(newFileName);</span>
        try {
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            if (file != null) {</span>
                //          log.debug(&quot;file isn't null&quot;);
<span class="fc bfc" id="L151" title="All 2 branches covered.">                if (file.exists()) {</span>
                    //             log.debug(&quot;file exists rename it &quot;);
<span class="fc" id="L153">                    renamed = file.renameTo(newFile);</span>
                    //              log.debug(&quot;renamed? = &quot; + renamed);
                }
            }
<span class="nc" id="L157">        } catch (Exception e) {</span>
            //        log.error(e.toString());
<span class="fc" id="L159">        }</span>
        //      log.debug(&quot;rename - out&quot;);
<span class="fc" id="L161">    }</span>

    //cleanup old files older then a week

    //get file

    public File getASINFile(String asin, String type, String offer, String page) {
        //     log.debug(&quot;In getASINFile&quot;);
<span class="fc" id="L169">        String filename = asin + &quot;_&quot; + offer + &quot;_&quot; + type + &quot;_&quot; + page + &quot;.xml&quot;;</span>
<span class="fc" id="L170">        String tFileName = &quot;t_&quot; + asin + &quot;_&quot; + offer + &quot;_&quot; + type + &quot;_&quot; + page + &quot;.xml&quot;;</span>

<span class="fc" id="L172">        String cachedFileName = cacheDir + filename.trim().toUpperCase();</span>
<span class="fc" id="L173">        String tempFilename = cacheDir + tFileName.trim().toUpperCase();</span>
        // have all files uppercase so that there is no diffs
<span class="fc" id="L175">        File cachedFile = new File(cachedFileName);</span>

        // check if cachedFile is there.
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        if (cachedFile != null) {</span>
            // check if cachedFile is there.
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">            if (cachedFile.exists()) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (isAgeGood(cachedFile)) { // check the age of the cachedFile</span>
<span class="nc" id="L182">                    return cachedFile; // if age is ok return that cachedFile</span>
                } else {
                    //              log.debug(&quot;else&quot;);
                    // if age is too old get a new cachedFile
<span class="nc bnc" id="L186" title="All 2 branches missed.">                    if (downloadOneASINFile(asin, type, offer, page, tempFilename)) {</span>
                        // if getting a new File was successful then delete old one
<span class="nc" id="L188">                        deleteFile(cachedFileName);</span>
                        //and rename the temp to the asin.xml cachedFile
<span class="nc" id="L190">                        renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L191">                        return new File(cachedFileName); //cachefile is now the new file</span>
                    } else {
                        // if getting a new File failed return the old one
                        // and delete the temp if it exists
<span class="nc" id="L195">                        deleteFile(tempFilename);</span>
<span class="nc" id="L196">                        return cachedFile;</span>
                    }
                }

            } else {
                //cachedFile not there
                // if the cachedFile wasn't there get it
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">                if (downloadOneASINFile(asin, type, offer, page, tempFilename)) {</span>
                    // if getting the File was successful return it
                    //rename temp to asin.xml
<span class="nc" id="L206">                    renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L207">                    return new File(cachedFileName);</span>
                } else {
                    // if getting the File failed then return an error or something letting the user know there was a problem
<span class="fc" id="L210">                    return null;</span>
                }

            }
        } else   //cachedFile not there
        {
            // if the cachedFile wasn't there get it
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (downloadOneASINFile(asin, type, offer, page, tempFilename)) {</span>
                // if getting the File was successful return it
                //rename temp to asin.xml
<span class="nc" id="L220">                renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L221">                return new File(cachedFileName);</span>
            } else {
                // if getting the File failed then return an error or something letting the user know there was a problem
<span class="nc" id="L224">                return null;</span>
            }
        }

    }

    public FileInputStream fetchASINFile(String asin, String type, String offer, String page) {
        try {
            //       log.debug(&quot;In FetchFile&quot;);
<span class="fc" id="L233">            File asinFile = getASINFile(asin, type, offer, page);</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">            if (asinFile != null) {</span>
<span class="nc" id="L235">                FileInputStream in = new FileInputStream(asinFile);</span>
                //             log.debug(&quot;got File&quot;);
<span class="nc" id="L237">                return in;</span>
            } else {
<span class="fc" id="L239">                return null;</span>
            }

<span class="nc" id="L242">        } catch (FileNotFoundException fnfe) {</span>
            //           log.error(&quot;error in fetchfile&quot;);
<span class="nc" id="L244">            return null;</span>
        }
    }

    public boolean downloadBrowseNodeFile(String mode, String node, String page, String saveFileName) {
        //      log.debug(&quot;download&quot;);
        //      log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L252">        Query xml = new Query();</span>
<span class="fc" id="L253">        String type = &quot;lite&quot;;</span>
<span class="fc" id="L254">        String offer = &quot;new&quot;;</span>
<span class="fc" id="L255">        String response = new String();</span>
        try {
//            log.debug(&quot;download - try&quot;);
<span class="nc" id="L258">            response = xml.sendRequest(xml.browseNodeQueryGenerator(type, page, offer, mode, node));</span>
<span class="nc" id="L259">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="nc" id="L260">            byte[] byteMe = response.getBytes();</span>
<span class="nc" id="L261">            out.write(byteMe);</span>
<span class="nc" id="L262">            out.close();</span>
<span class="nc" id="L263">            File file = new File(saveFileName);</span>
<span class="nc bnc" id="L264" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
                //            log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L266">                downloaded = false;</span>
            } else {
<span class="nc" id="L268">                downloaded = true;</span>
            }

<span class="fc" id="L271">        } catch (Exception e) {</span>
            //       log.error(e.toString());
<span class="fc" id="L273">            downloaded = false;</span>
<span class="nc" id="L274">        }</span>

<span class="fc" id="L276">        return downloaded;</span>
    }

    public File getBrowseNodeFile(String mode, String node, String page) {
        //      log.debug(&quot;In getBrowseNodeFile&quot;);
<span class="fc" id="L281">        String filename = mode + &quot;_&quot; + node + &quot;_&quot; + page + &quot;.xml&quot;;</span>
<span class="fc" id="L282">        String tFileName = &quot;t_&quot; + mode + &quot;_&quot; + node + &quot;_&quot; + page + &quot;.xml&quot;;</span>

<span class="fc" id="L284">        String cachedFileName = cacheDir + filename.trim().toUpperCase();</span>
<span class="fc" id="L285">        String tempFilename = cacheDir + tFileName.trim().toUpperCase();</span>
        // have all files uppercase so that there is no diffs
<span class="fc" id="L287">        File cachedFile = new File(cachedFileName);</span>

        // check if cachedFile is there.
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">        if (cachedFile != null) {</span>
            // check if cachedFile is there.
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">            if (cachedFile.exists()) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">                if (isAgeGood(cachedFile)) { // check the age of the cachedFile</span>
<span class="nc" id="L294">                    return cachedFile; // if age is ok return that cachedFile</span>
                } else {
                    //              log.debug(&quot;else&quot;);
                    // if age is too old get a new cachedFile
<span class="nc bnc" id="L298" title="All 2 branches missed.">                    if (downloadBrowseNodeFile(mode, node, page, tempFilename)) {</span>
                        // if getting a new File was successful then delete old one
<span class="nc" id="L300">                        deleteFile(cachedFileName);</span>
                        //and rename the temp to the asin.xml cachedFile
<span class="nc" id="L302">                        renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L303">                        return new File(cachedFileName); //cachefile is now the new file</span>
                    } else {
                        // if getting a new File failed return the old one
                        // and delete the temp if it exists
<span class="nc" id="L307">                        deleteFile(tempFilename);</span>
<span class="nc" id="L308">                        return cachedFile;</span>
                    }
                }

            } else {
                //cachedFile not there
                // if the cachedFile wasn't there get it
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">                if (downloadBrowseNodeFile(mode, node, page, tempFilename)) {</span>
                    // if getting the File was successful return it
                    //rename temp to asin.xml
<span class="nc" id="L318">                    renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L319">                    return new File(cachedFileName);</span>
                } else {
                    // if getting the File failed then return an error or something letting the user know there was a problem
<span class="fc" id="L322">                    return null;</span>
                }

            }
        } else   //cachedFile not there
        {
            // if the cachedFile wasn't there get it
<span class="nc bnc" id="L329" title="All 2 branches missed.">            if (downloadBrowseNodeFile(mode, node, page, tempFilename)) {</span>
                // if getting the File was successful return it
                //rename temp to asin.xml
<span class="nc" id="L332">                renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L333">                return new File(cachedFileName);</span>
            } else {
                // if getting the File failed then return an error or something letting the user know there was a problem
<span class="nc" id="L336">                return null;</span>
            }
        }

    }

    public FileInputStream fetchBNFile(String mode, String node, String page) {
        try {
//          log.debug(&quot;In FetchBNFile&quot;);
<span class="fc" id="L345">            File file = getBrowseNodeFile(mode, node, page);</span>
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">            if (file != null) {</span>
<span class="nc" id="L347">                FileInputStream in = new FileInputStream(file);</span>
//         log.debug(&quot;got File&quot;);
<span class="nc" id="L349">                return in;</span>
            } else {
<span class="fc" id="L351">                return null;</span>
            }
<span class="nc" id="L353">        } catch (FileNotFoundException fnfe) {</span>
//        log.error(&quot;error in fetchfile&quot;);
<span class="nc" id="L355">            return null;</span>
        }
    }

    public File downloadBlendedSearchFile(String searchTerm, String type) {
        //     log.debug(&quot;download&quot;);

<span class="fc" id="L362">        Date timestamp = new Date();</span>
<span class="fc" id="L363">        Random r = new Random();</span>
<span class="fc" id="L364">        String fileName = &quot;b_&quot; + Long.toString(timestamp.getTime()) + &quot;_&quot; + r.nextInt() + &quot;.xml&quot;;</span>
<span class="fc" id="L365">        String saveFileName = cacheDir + fileName.trim().toUpperCase();</span>
        //      log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L368">        Query xml = new Query();</span>
<span class="fc" id="L369">        String response = new String();</span>
        try {
            //          log.debug(&quot;download - try&quot;);
<span class="nc" id="L372">            response = xml.sendRequest(xml.BlendedSearchGenerator(type, searchTerm));</span>
<span class="nc" id="L373">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="nc" id="L374">            byte[] byteMe = response.getBytes();</span>
<span class="nc" id="L375">            out.write(byteMe);</span>
<span class="nc" id="L376">            out.close();</span>
<span class="nc" id="L377">            File file = new File(saveFileName);</span>
<span class="nc bnc" id="L378" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
                //           log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L380">                downloaded = false;</span>
            } else {
<span class="nc" id="L382">                downloaded = true;</span>
            }
<span class="fc" id="L384">        } catch (Exception e) {</span>
            //      log.error(e.toString());
<span class="fc" id="L386">            downloaded = false;</span>
<span class="nc" id="L387">        }</span>

<span class="pc bpc" id="L389" title="1 of 2 branches missed.">        if (downloaded) {</span>
<span class="nc" id="L390">            return new File(saveFileName);</span>
        } else {
<span class="fc" id="L392">            return null;</span>
        }
    }

    public File downloadKeywordSearchFile(String searchTerm, String productLine, String type, String page) {
        //      log.debug(&quot;download&quot;);

<span class="fc" id="L399">        Date timestamp = new Date();</span>
<span class="fc" id="L400">        Random r = new Random();</span>
<span class="fc" id="L401">        String fileName = &quot;k_&quot; + Long.toString(timestamp.getTime()) + &quot;_&quot; + r.nextInt() + &quot;.xml&quot;;</span>
<span class="fc" id="L402">        String saveFileName = cacheDir + fileName.trim().toUpperCase();</span>
        //     log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L405">        Query xml = new Query();</span>
<span class="fc" id="L406">        String response = new String();</span>
        try {
            //          log.debug(&quot;download - try&quot;);
<span class="nc" id="L409">            response = xml.sendRequest(xml.KeywordSearchGenerator(searchTerm, productLine, type, page));</span>
<span class="nc" id="L410">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="nc" id="L411">            byte[] byteMe = response.getBytes();</span>
<span class="nc" id="L412">            out.write(byteMe);</span>
<span class="nc" id="L413">            out.close();</span>
<span class="nc" id="L414">            File file = new File(saveFileName);</span>
<span class="nc bnc" id="L415" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
                //           log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L417">                downloaded = false;</span>
            } else {
<span class="nc" id="L419">                downloaded = true;</span>
            }
<span class="fc" id="L421">        } catch (Exception e) {</span>
            //      log.error(e.toString());
<span class="fc" id="L423">            downloaded = false;</span>
<span class="nc" id="L424">        }</span>

<span class="pc bpc" id="L426" title="1 of 2 branches missed.">        if (downloaded) {</span>
<span class="nc" id="L427">            return new File(saveFileName);</span>
        } else {
<span class="fc" id="L429">            return null;</span>
        }
    }

    public FileInputStream fetchBlendedSearchFile(String searchTerm, String type) {
        try {
            //        log.debug(&quot;In FetchBlendedSearchFile&quot;);
<span class="fc" id="L436">            File file = downloadBlendedSearchFile(searchTerm, type);</span>
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">            if (file != null) {</span>
<span class="nc" id="L438">                FileInputStream in = new FileInputStream(file);</span>
                //        log.debug(&quot;got File&quot;);
<span class="nc" id="L440">                return in;</span>
            } else {
<span class="fc" id="L442">                return null;</span>
            }
<span class="nc" id="L444">        } catch (FileNotFoundException fnfe) {</span>
            //        log.error(&quot;error in fetchfile&quot;);
<span class="nc" id="L446">            return null;</span>
        }
    }

    public FileInputStream fetchKeywordSearchFile(String searchTerm, String productLine, String type, String page) {
        try {
            //         log.debug(&quot;In FetchKeywordSearchFile&quot;);
<span class="fc" id="L453">            File file = downloadKeywordSearchFile(searchTerm, productLine, type, page);</span>
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">            if (file != null) {</span>
<span class="nc" id="L455">                FileInputStream in = new FileInputStream(file);</span>
                //         log.debug(&quot;got File&quot;);
<span class="nc" id="L457">                return in;</span>
            } else {
<span class="fc" id="L459">                return null;</span>
            }
<span class="nc" id="L461">        } catch (FileNotFoundException fnfe) {</span>
            //          log.error(&quot;error in fetchfile&quot;);
<span class="nc" id="L463">            return null;</span>
        }
    }

    public File downloadGenericSearchFile(String searchType, String searchTerm, String mode, String type, String page, String offer) {
        //      log.debug(&quot;download&quot;);

<span class="fc" id="L470">        Date timestamp = new Date();</span>
<span class="fc" id="L471">        Random r = new Random();</span>
<span class="fc" id="L472">        String fileName = &quot;g_&quot; + Long.toString(timestamp.getTime()) + &quot;_&quot; + r.nextInt() + &quot;.xml&quot;;</span>
<span class="fc" id="L473">        String saveFileName = cacheDir + fileName.trim().toUpperCase();</span>
        //       log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L476">        Query xml = new Query();</span>
<span class="fc" id="L477">        String response = new String();</span>
        try {
            //         log.debug(&quot;download - try&quot;);
<span class="nc" id="L480">            response = xml.sendRequest(xml.SearchQueryGenerator(searchType, searchTerm, mode, type, page, offer));</span>
<span class="nc" id="L481">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="nc" id="L482">            byte[] byteMe = response.getBytes();</span>
<span class="nc" id="L483">            out.write(byteMe);</span>
<span class="nc" id="L484">            out.close();</span>
<span class="nc" id="L485">            File file = new File(saveFileName);</span>
<span class="nc bnc" id="L486" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
                //           log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L488">                downloaded = false;</span>
            } else {
<span class="nc" id="L490">                downloaded = true;</span>
            }
<span class="fc" id="L492">        } catch (Exception e) {</span>
            //      log.error(e.toString());
<span class="fc" id="L494">            downloaded = false;</span>
<span class="nc" id="L495">        }</span>

<span class="pc bpc" id="L497" title="1 of 2 branches missed.">        if (downloaded) {</span>
<span class="nc" id="L498">            return new File(saveFileName);</span>
        } else {
<span class="fc" id="L500">            return null;</span>
        }
    }

    public FileInputStream fetchGenericSearchFile(String searchType, String searchTerm, String mode, String type, String page, String offer) {
        try {
            //        log.debug(&quot;In fetchGenericSearchFile&quot;);
<span class="fc" id="L507">            File file = downloadGenericSearchFile(searchType, searchTerm, mode, type, page, offer);</span>
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">            if (file != null) {</span>
<span class="nc" id="L509">                FileInputStream in = new FileInputStream(file);</span>
                //        log.debug(&quot;got File&quot;);
<span class="nc" id="L511">                return in;</span>
            } else {
<span class="fc" id="L513">                return null;</span>
            }
<span class="nc" id="L515">        } catch (FileNotFoundException fnfe) {</span>
            //         log.error(&quot;error in fetchfile&quot;);
<span class="nc" id="L517">            return null;</span>
        }
    }

    public File downloadThirdPartySearchFile(String sellerId, String type, String page, String status) {
        //      log.debug(&quot;download&quot;);

<span class="fc" id="L524">        Date timestamp = new Date();</span>
<span class="fc" id="L525">        Random r = new Random();</span>
<span class="fc" id="L526">        String fileName = &quot;3rd_&quot; + Long.toString(timestamp.getTime()) + &quot;_&quot; + r.nextInt() + &quot;.xml&quot;;</span>
<span class="fc" id="L527">        String saveFileName = cacheDir + fileName.trim().toUpperCase();</span>
        //     log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L530">        Query xml = new Query();</span>
<span class="fc" id="L531">        String response = new String();</span>
        try {
            //           log.debug(&quot;download - try&quot;);
<span class="nc" id="L534">            response = xml.sendRequest(xml.SearchThirdPartyGenerator(sellerId, type, page, status));</span>
<span class="nc" id="L535">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="nc" id="L536">            byte[] byteMe = response.getBytes();</span>
<span class="nc" id="L537">            out.write(byteMe);</span>
<span class="nc" id="L538">            out.close();</span>
<span class="nc" id="L539">            File file = new File(saveFileName);</span>
<span class="nc bnc" id="L540" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
                //           log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L542">                downloaded = false;</span>
            } else {
<span class="nc" id="L544">                downloaded = true;</span>
            }
<span class="fc" id="L546">        } catch (Exception e) {</span>
            //      log.error(e.toString());
<span class="fc" id="L548">            downloaded = false;</span>
<span class="nc" id="L549">        }</span>

<span class="pc bpc" id="L551" title="1 of 2 branches missed.">        if (downloaded) {</span>
<span class="nc" id="L552">            return new File(saveFileName);</span>
        } else {
<span class="fc" id="L554">            return null;</span>
        }
    }

    public FileInputStream fetchThirdPartySearchFile(String sellerId, String type, String page, String status) {
        try {
            //         log.debug(&quot;In fetchThirdPartySearchFile&quot;);
<span class="fc" id="L561">            File file = downloadThirdPartySearchFile(sellerId, type, page, status);</span>
<span class="pc bpc" id="L562" title="1 of 2 branches missed.">            if (file != null) {</span>
<span class="nc" id="L563">                FileInputStream in = new FileInputStream(file);</span>
                //        log.debug(&quot;got File&quot;);
<span class="nc" id="L565">                return in;</span>
            } else {
<span class="fc" id="L567">                return null;</span>
            }
<span class="nc" id="L569">        } catch (FileNotFoundException fnfe) {</span>
            //         log.error(&quot;error in fetchfile&quot;);
<span class="nc" id="L571">            return null;</span>
        }
    }


    public File getAccessories(String asin, ArrayList asins) {
        //      log.debug(&quot;In getAccessories&quot;);
<span class="fc" id="L578">        String filename = &quot;a_&quot; + asin + &quot;.xml&quot;;</span>
<span class="fc" id="L579">        String tFileName = &quot;ta_&quot; + asin + &quot;.xml&quot;;</span>

<span class="fc" id="L581">        String cachedFileName = cacheDir + filename.trim().toUpperCase();</span>
<span class="fc" id="L582">        String tempFilename = cacheDir + tFileName.trim().toUpperCase();</span>
        // have all files uppercase so that there is no diffs
<span class="fc" id="L584">        File cachedFile = new File(cachedFileName);</span>

        // check if cachedFile is there.
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">        if (cachedFile != null) {</span>
            // check if cachedFile is there.
<span class="pc bpc" id="L589" title="1 of 2 branches missed.">            if (cachedFile.exists()) {</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">                if (isAgeGood(cachedFile)) { // check the age of the cachedFile</span>
<span class="nc" id="L591">                    return cachedFile; // if age is ok return that cachedFile</span>
                } else {
                    //                log.debug(&quot;else&quot;);
                    // if age is too old get a new cachedFile
<span class="nc bnc" id="L595" title="All 2 branches missed.">                    if (downloadAccessoriesFile(asin, asins, tempFilename)) {</span>
                        // if getting a new File was successful then delete old one
<span class="nc" id="L597">                        deleteFile(cachedFileName);</span>
                        //and rename the temp to the asin.xml cachedFile
<span class="nc" id="L599">                        renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L600">                        return new File(cachedFileName); //cachefile is now the new file</span>
                    } else {
                        // if getting a new File failed return the old one
                        // and delete the temp if it exists
<span class="nc" id="L604">                        deleteFile(tempFilename);</span>
<span class="nc" id="L605">                        return cachedFile;</span>
                    }
                }

            } else {
                //cachedFile not there
                // if the cachedFile wasn't there get it
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">                if (downloadAccessoriesFile(asin, asins, tempFilename)) {</span>
                    // if getting the File was successful return it
                    //rename temp to asin.xml
<span class="nc" id="L615">                    renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L616">                    return new File(cachedFileName);</span>
                } else {
                    // if getting the File failed then return an error or something letting the user know there was a problem
<span class="fc" id="L619">                    return null;</span>
                }

            }
        } else   //cachedFile not there
        {
            // if the cachedFile wasn't there get it
<span class="nc bnc" id="L626" title="All 2 branches missed.">            if (downloadAccessoriesFile(asin, asins, tempFilename)) {</span>
                // if getting the File was successful return it
                //rename temp to asin.xml
<span class="nc" id="L629">                renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L630">                return new File(cachedFileName);</span>
            } else {
                // if getting the File failed then return an error or something letting the user know there was a problem
<span class="nc" id="L633">                return null;</span>
            }
        }

    }

    public boolean downloadAccessoriesFile(String asin, ArrayList asins, String saveFileName) {
        //      log.debug(&quot;download&quot;);
        //      log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L643">        Query xml = new Query();</span>
<span class="fc" id="L644">        String searchType = &quot;AsinSearch&quot;;</span>
<span class="fc" id="L645">        String page = &quot;1&quot;;</span>
<span class="fc" id="L646">        String offer = &quot;all&quot;;</span>
<span class="fc" id="L647">        String response = new String();</span>
        try {
            //          log.debug(&quot;download - try&quot;);
<span class="nc" id="L650">            response = xml.sendRequest(xml.queryGenerator(searchType, &quot;lite&quot;, page, offer, asins));</span>
<span class="nc" id="L651">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="nc" id="L652">            byte[] byteMe = response.getBytes();</span>
<span class="nc" id="L653">            out.write(byteMe);</span>
<span class="nc" id="L654">            out.close();</span>
<span class="nc" id="L655">            File file = new File(saveFileName);</span>
<span class="nc bnc" id="L656" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
                //           log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L658">                downloaded = false;</span>
            } else {
<span class="nc" id="L660">                downloaded = true;</span>
            }
<span class="fc" id="L662">        } catch (Exception e) {</span>
            //      log.error(e.toString());
<span class="fc" id="L664">            downloaded = false;</span>
<span class="nc" id="L665">        }</span>

<span class="fc" id="L667">        return downloaded;</span>
    }

    public FileInputStream fetchAccessories(String asin, ArrayList asins) {
        try {
            //          log.debug(&quot;In fetchAccessories&quot;);
<span class="fc" id="L673">            File file = getAccessories(asin, asins);</span>
<span class="pc bpc" id="L674" title="1 of 2 branches missed.">            if (file != null) {</span>
<span class="nc" id="L675">                FileInputStream in = new FileInputStream(file);</span>
                //        log.debug(&quot;got File&quot;);
<span class="nc" id="L677">                return in;</span>
            } else {
<span class="fc" id="L679">                return null;</span>
            }
<span class="nc" id="L681">        } catch (FileNotFoundException fnfe) {</span>
            //         log.error(&quot;error in fetchfile&quot;);
<span class="nc" id="L683">            return null;</span>
        }
    }

    public File getSimilarItems(String asin, String page) {
        //     log.debug(&quot;In getSimilarItems&quot;);
<span class="fc" id="L689">        String filename = &quot;s_&quot; + asin + &quot;.xml&quot;;</span>
<span class="fc" id="L690">        String tFileName = &quot;ts_&quot; + asin + &quot;.xml&quot;;</span>

<span class="fc" id="L692">        String cachedFileName = cacheDir + filename.trim().toUpperCase();</span>
<span class="fc" id="L693">        String tempFilename = cacheDir + tFileName.trim().toUpperCase();</span>
        // have all files uppercase so that there is no diffs
<span class="fc" id="L695">        File cachedFile = new File(cachedFileName);</span>

        // check if cachedFile is there.
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">        if (cachedFile != null) {</span>
            // check if cachedFile is there.
<span class="pc bpc" id="L700" title="1 of 2 branches missed.">            if (cachedFile.exists()) {</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">                if (isAgeGood(cachedFile)) { // check the age of the cachedFile</span>
<span class="nc" id="L702">                    return cachedFile; // if age is ok return that cachedFile</span>
                } else {
                    //               log.debug(&quot;else&quot;);
                    // if age is too old get a new cachedFile
<span class="nc bnc" id="L706" title="All 2 branches missed.">                    if (downloadSimilaritesFile(asin, page, tempFilename)) {</span>
                        // if getting a new File was successful then delete old one
<span class="nc" id="L708">                        deleteFile(cachedFileName);</span>
                        //and rename the temp to the asin.xml cachedFile
<span class="nc" id="L710">                        renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L711">                        return new File(cachedFileName); //cachefile is now the new file</span>
                    } else {
                        // if getting a new File failed return the old one
                        // and delete the temp if it exists
<span class="nc" id="L715">                        deleteFile(tempFilename);</span>
<span class="nc" id="L716">                        return cachedFile;</span>
                    }
                }

            } else {
                //cachedFile not there
                // if the cachedFile wasn't there get it
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">                if (downloadSimilaritesFile(asin, page, tempFilename)) {</span>
                    // if getting the File was successful return it
                    //rename temp to asin.xml
<span class="nc" id="L726">                    renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L727">                    return new File(cachedFileName);</span>
                } else {
                    // if getting the File failed then return an error or something letting the user know there was a problem
<span class="fc" id="L730">                    return null;</span>
                }

            }
        } else   //cachedFile not there
        {
            // if the cachedFile wasn't there get it
<span class="nc bnc" id="L737" title="All 2 branches missed.">            if (downloadSimilaritesFile(asin, page, tempFilename)) {</span>
                // if getting the File was successful return it
                //rename temp to asin.xml
<span class="nc" id="L740">                renameFile(tempFilename, cachedFileName);</span>
<span class="nc" id="L741">                return new File(cachedFileName);</span>
            } else {
                // if getting the File failed then return an error or something letting the user know there was a problem
<span class="nc" id="L744">                return null;</span>
            }
        }

    }

    public boolean downloadSimilaritesFile(String asin, String page, String saveFileName) {
        //       log.debug(&quot;download&quot;);
        //       log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L754">        Query xml = new Query();</span>
<span class="fc" id="L755">        ArrayList asins = new ArrayList();</span>
<span class="fc" id="L756">        String searchType = &quot;SimilaritySearch&quot;;</span>
<span class="fc" id="L757">        String offer = &quot;all&quot;;</span>
<span class="fc" id="L758">        String response = new String();</span>
<span class="fc" id="L759">        asins.add(asin);</span>
        try {
            //           log.debug(&quot;download - try&quot;);
<span class="nc" id="L762">            response = xml.sendRequest(xml.queryGenerator(searchType, &quot;lite&quot;, page, offer, asins));</span>
<span class="nc" id="L763">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="nc" id="L764">            byte[] byteMe = response.getBytes();</span>
<span class="nc" id="L765">            out.write(byteMe);</span>
<span class="nc" id="L766">            out.close();</span>
<span class="nc" id="L767">            File file = new File(saveFileName);</span>
<span class="nc bnc" id="L768" title="All 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
                //          log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L770">                downloaded = false;</span>
            } else {
<span class="nc" id="L772">                downloaded = true;</span>
            }
<span class="fc" id="L774">        } catch (Exception e) {</span>
            //       log.error(e.toString());
<span class="fc" id="L776">            downloaded = false;</span>
<span class="nc" id="L777">        }</span>

<span class="fc" id="L779">        return downloaded;</span>
    }

    public FileInputStream fetchSimilarItems(String asin, String page) {
        try {
            //        log.debug(&quot;fetchSimilarItems&quot;);
<span class="fc" id="L785">            File file = getSimilarItems(asin, page);</span>
<span class="pc bpc" id="L786" title="1 of 2 branches missed.">            if (file != null) {</span>
<span class="nc" id="L787">                FileInputStream in = new FileInputStream(file);</span>
                //          log.debug(&quot;got File&quot;);
<span class="nc" id="L789">                return in;</span>
            } else {
<span class="fc" id="L791">                return null;</span>
            }
<span class="nc" id="L793">        } catch (FileNotFoundException fnfe) {</span>
            //         log.error(&quot;error in fetchfile&quot;);
<span class="nc" id="L795">            return null;</span>
        }
    }

    public File downloadCart(String cartQuery) {
//       log.debug(&quot;download&quot;);

<span class="fc" id="L802">        Date timestamp = new Date();</span>
<span class="fc" id="L803">        Random r = new Random();</span>
<span class="fc" id="L804">        String fileName = &quot;c_&quot; + Long.toString(timestamp.getTime()) + &quot;_&quot; + r.nextInt() + &quot;.xml&quot;;</span>
<span class="fc" id="L805">        String saveFileName = cacheDir + fileName.trim().toUpperCase();</span>
//      log.debug(&quot;saveFilename = &quot; + saveFileName);
        boolean downloaded;
<span class="fc" id="L808">        Query xml = new Query();</span>
<span class="fc" id="L809">        String response = new String();</span>
        try {
            //         log.debug(&quot;download - try&quot;);
<span class="fc" id="L812">            response = xml.sendRequest(cartQuery);</span>
<span class="fc" id="L813">            FileOutputStream out = new FileOutputStream(saveFileName);</span>
<span class="fc" id="L814">            byte[] byteMe = response.getBytes();</span>
<span class="fc" id="L815">            out.write(byteMe);</span>
<span class="fc" id="L816">            out.close();</span>
<span class="fc" id="L817">            File file = new File(saveFileName);</span>
<span class="pc bpc" id="L818" title="2 of 4 branches missed.">            if (file != null &amp;&amp; file.length() &lt; 1000) {</span>
//            log.debug(&quot;FileSize = &quot; + file.length());
<span class="nc" id="L820">                downloaded = false;</span>
            } else {
<span class="fc" id="L822">                downloaded = true;</span>
            }
<span class="nc" id="L824">        } catch (Exception e) {</span>
//       log.error(e.toString());
<span class="nc" id="L826">            downloaded = false;</span>
<span class="fc" id="L827">        }</span>

<span class="pc bpc" id="L829" title="1 of 2 branches missed.">        if (downloaded) {</span>
<span class="fc" id="L830">            return new File(saveFileName);</span>
        } else {
<span class="nc" id="L832">            return null;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>