<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FSPathResultListImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">60_sugar</a> &gt; <a href="index.source.html" class="el_package">net.sf.sugar.fspath</a> &gt; <span class="el_source">FSPathResultListImpl.java</span></div><h1>FSPathResultListImpl.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2008 (C) Keith Bishop (bishi@users.sourceforge.net)
 *
 * All rights reserved.
 *
 * This file is part of FSPath.
 *
 * FSPath is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * FSPath is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with FSPath.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

/*
 * FSPathResultListImpl.java
 *
 * Created on 08 April 2008, 18:00
 *
 */

package net.sf.sugar.fspath;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 *
 * @author kbishop
 * @version $Id$
 */
public class FSPathResultListImpl extends ArrayList&lt;FSPathResult&gt; implements FSPathResultList  {

    /** Creates a new instance of FSPathResultListImpl */
<span class="fc" id="L47">    public FSPathResultListImpl() {</span>
<span class="fc" id="L48">    }</span>

	/**
	 *  A convenience method for defining custom filesystem interaction
	 *  across the whole list of results.
	 *
	 *  This method loops through the results and calls the call(Result result)
	 *  method of the Callback class passed to it for each individual result.
	 *
	 *  @param Callback - a custom implementation of the Callback interface.
	 *  @throws IOException
 	 */
    public FSPathResultList each(Callback callback) throws IOException {
<span class="nc bnc" id="L61" title="All 2 branches missed.">        for (FSPathResult result : this) {</span>
<span class="nc" id="L62">            callback.call(result);</span>
<span class="nc" id="L63">        }</span>
<span class="nc" id="L64">        return this;</span>
    }

    /**
     *  Deletes each file contained in this FSPathResultList.
     *  &lt;br/&gt;
     *  &lt;pre&gt;
     *  ************************************************************************
     *  *               IMPORTANT !!!!!    Use with caution                    *
     *  *   This method makes it extremely easy to trash your filesystem       *
     *  *   Its advised that FSPath queries are tested thouroughly before use  *
     *  *   in order to verify which files would be deleted                    *
     *  *                                                                      *
     *  ************************************************************************
     *  &lt;/pre&gt;
     *  @returns FSPathResultModificationListImpl - all successfully deleted files&lt;br/&gt;
     *  will be added as a success, and the failures will be added as failures.
     *
     *  @throws IOException - NOTE this method does not currently thrown an IOException
     *  @throws OperationNotPermittedException - this exception will be thrown if&lt;br/&gt;
     *  The FSPathResult objects contained in this FSPathResultList don't contain&lt;br/&gt;
     *  java.io.File objects&lt;br/&gt;
     *  (i.e the FSPath query was written to return Boolean, String nor numerical results).
     */
    public FSPathResultModificationList delete() throws IOException, OperationNotPermittedException {

<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (! isListOfFiles()) {</span>
<span class="nc" id="L91">            throw new OperationNotPermittedException(&quot;Delete is only permitted on FSPathResult objects containing a File object&quot;);</span>
        }

<span class="nc" id="L94">        FSPathResultModificationList deletionList = new FSPathResultModificationListImpl();</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">        for(FSPathResult result : this) {</span>
            try {
<span class="nc" id="L98">                File file = result.getFile();</span>
<span class="nc" id="L99">                boolean success = file.delete();</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">                if (success) {</span>
<span class="nc" id="L102">                    deletionList.addSuccess(result);</span>
                } else {
<span class="nc" id="L104">                    deletionList.addFailure(result);</span>
                }

<span class="nc" id="L107">            } catch (Exception e) {</span>
                //todo: log this ?
<span class="nc" id="L109">                deletionList.addFailure(result);</span>
<span class="nc" id="L110">            }</span>
<span class="nc" id="L111">        }</span>

<span class="nc" id="L113">        return deletionList;</span>
    }

    /**
     *  This method will copy each file contained in this FSPathResultList to the
     *  destination path supplied.
     *
     *  @param String - the destination path which you would like to copy files to.
     *
     *  @returns FSPathResultModificationListImpl - all successfully copied files
     *  will be added as a success, and the failures will be added as failures.
     *
     *  @param String the absolute or realtive path of the destination Directory
     *  @throws IOException - NOTE this is currently not thrown by this method.
     *  @throws OperationNotPermittedException - this exception is thrown upon
     *  the following conditions :&lt;br/&gt;
     *  &lt;br/&gt;
     *  1)  The FSPathResult objects contained in this FSPathResultList don't contain&lt;br/&gt;
     *      java.io.File objects&lt;br/&gt;
     *      (i.e the FSPath query was written to return Boolean, String nor numerical results).&lt;br/&gt;
     *  2)  The directory denoted by the destination path doesn't exist.&lt;br/&gt;
     *  3)  The destination path doesn't resolve to a directory.&lt;br/&gt;
     *  4)  The destination path isn't writeable.&lt;br/&gt;
     *  5)  The current java process doesn't have sufficient priveledges to&lt;br/&gt;
     *      access the destination path.&lt;br/&gt;
     */
    public FSPathResultModificationList copy(String destinationDirPath)
                                                throws IOException,
                                                OperationNotPermittedException {

<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (! isListOfFiles()) {</span>
<span class="nc" id="L144">            throw new OperationNotPermittedException(&quot;Copy is only permitted on FSPathResult objects containing a java.io.File object&quot;);</span>
        }

<span class="nc" id="L147">        File destinationDir = new File(destinationDirPath);</span>

        try {
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (! destinationDir.exists()) {</span>
<span class="nc" id="L151">                throw new OperationNotPermittedException(&quot;Unable to copy to a directory that doesn't exist&quot;);</span>
            }

<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (! destinationDir.isDirectory()) {</span>
<span class="nc" id="L155">                throw new OperationNotPermittedException(&quot;Destination path &quot; + destinationDir.getAbsolutePath() + &quot; does not resolve to a directory&quot;);</span>
            }

<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (! destinationDir.canWrite()) {</span>
<span class="nc" id="L159">                throw new OperationNotPermittedException(&quot;Desination path &quot; + destinationDir.getAbsolutePath() + &quot; is not writable&quot;);</span>
            }

<span class="nc" id="L162">        } catch (SecurityException se) {</span>
<span class="nc" id="L163">            throw new OperationNotPermittedException(&quot;The current process does not have sufficent priveledges to access &quot; + destinationDir.getAbsolutePath(), se);</span>
<span class="nc" id="L164">        }</span>

<span class="nc" id="L166">        FSPathResultModificationList results = new FSPathResultModificationListImpl();</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">        for (FSPathResult result : this) {</span>

<span class="nc" id="L170">            File destinationFile = new File(destinationDir + result.getFile().getName());</span>

            try {

<span class="nc" id="L174">                FileReader inputReader = new FileReader(result.getFile());</span>
<span class="nc" id="L175">                FileWriter outputReader = new FileWriter(destinationFile);</span>

<span class="nc" id="L177">                int charsRead = 0;</span>

<span class="nc bnc" id="L179" title="All 2 branches missed.">                while ((charsRead = inputReader.read()) != -1) {</span>
<span class="nc" id="L180">                    outputReader.write(charsRead);</span>
                }

<span class="nc" id="L183">                inputReader.close();</span>
<span class="nc" id="L184">                outputReader.close();</span>

<span class="nc" id="L186">                results.addSuccess(new FSPathResult(destinationFile));</span>

<span class="nc" id="L188">            } catch (Exception e) {</span>
<span class="nc" id="L189">                results.addFailure(new FSPathResult(destinationFile));</span>
<span class="nc" id="L190">            }</span>
<span class="nc" id="L191">        }</span>

<span class="nc" id="L193">        return results;</span>
    }

    public boolean isListOfFiles() {
<span class="nc bnc" id="L197" title="All 4 branches missed.">        return (this.size() &gt; 0 &amp;&amp; this.get(0).getFile() != null);</span>
    }

	/**
	 *  Renames each file in the FSPathResultList based on a regex match
	 *  expression and a replace expression.
	 *  &lt;br/&gt;
	 *  This method is designed to enable simple renaming i.e. renaming from&lt;br/&gt;
	 *  &quot;a.txt&quot; to &quot;b.txt&quot; but also complex renaming using regular expressions.&lt;br/&gt;
	 *  &lt;br/&gt;
	 *  Example simple renaming : &lt;br/&gt;
	 *  &lt;pre&gt;fspath.query(&quot;/dir[@name='logs']/file[@name='error.log']&quot;).rename(&quot;error.log&quot;, &quot;error.log.1&quot;);&lt;/pre&gt; &lt;br/&gt;
	 *  This would work fine for a single file but not much use for multiple files.&lt;br/&gt;
	 *  &lt;br/&gt;
	 *  Example complex renaming : &lt;br/&gt;
	 *  &lt;br/&gt;
	 *  Imagine a directory full of files with a format such as : &lt;br/&gt;
	 *  &lt;pre&gt;
	 *  appLog-01_01_2008.log.1
	 *  appLog-01_01_2008.log.2
	 *  ...
	 *  &lt;/pre&gt;
	 *  Now imagine that we wanted to rename the files so that they end in .log but they also keep their&lt;br/&gt;
	 *  uniqueness (i.e. the number at the end of the file needs to move to a new position in the filename)&lt;br/&gt;
	 *  &lt;br/&gt;
	 *  The following code expression would work :&lt;br/&gt;
	 *  &lt;pre&gt;fspath.query(&quot;dir[@name = 'logs']/file&quot;).rename(&quot;(.*)\.log\.([0-9]+)&quot;, &quot;$1_$2.log&quot;);&lt;/pre&gt; &lt;br/&gt;
	 *  Here the matchExpression has two capturing groups, one being everything up to the '.log' in the filename, &lt;br/&gt;
	 *  and the other being the number after the &quot;.log.&quot; .&lt;br/&gt;
	 *  The replace expression simply specifies that the new file name will have the text in the first capturing group,&lt;br/&gt;
	 *  followed by a &quot;_&quot; then the text in the second capturing group and then &quot;.log&quot;.
	 */
    public FSPathResultModificationList rename(String matchExpression,
                                               String replaceExpresion)
                                               throws
                                                IOException,
                                                OperationNotPermittedException {

<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (! isListOfFiles()) {</span>
<span class="nc" id="L236">            throw new OperationNotPermittedException(&quot;Copy is only permitted on FSPathResult objects containing a java.io.File object&quot;);</span>
        }

<span class="nc" id="L239">        Pattern pattern = Pattern.compile(matchExpression);</span>

<span class="nc" id="L241">        FSPathResultModificationList results = new FSPathResultModificationListImpl();</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">        for (FSPathResult result : this) {</span>

<span class="nc" id="L245">            File origFile = null;</span>
<span class="nc" id="L246">            File newFile = null;</span>
            try {
<span class="nc" id="L248">                origFile = result.getFile();</span>
<span class="nc" id="L249">                Matcher matcher = pattern.matcher(origFile.getName());</span>

<span class="nc" id="L251">                String newName = matcher.replaceAll(replaceExpresion);</span>
<span class="nc" id="L252">                 newFile = new File(newName);</span>

<span class="nc" id="L254">                origFile.renameTo(newFile);</span>

<span class="nc" id="L256">                results.addSuccess(new FSPathResult(newFile));</span>

<span class="nc" id="L258">            } catch (Exception e) {</span>
<span class="nc" id="L259">                results.addFailure(new FSPathResult(newFile));</span>
<span class="nc" id="L260">            }</span>
<span class="nc" id="L261">        }</span>

<span class="nc" id="L263">        return results;</span>
    }

    /**
     *  Moves each file in the list to the specified desination path.
     *
     *  This method effecively calls copy() and then delete() on itself.
     *  If any file fails to sucessfully copy, then this method 'fails fast'
     *  and returns the results of the copy. This should prevent the situation arising
     *  where the copied files are completely deleted.
     *  If the copy suceeds, then it will attempt to delete the original files.
     *
     *  @param String - the directory path to move the files to.
     *  @throws OperationNotPermittedException - see the comments for &lt;code&gt;copy&lt;/code&gt;
     *
     */
    public FSPathResultModificationList move(String destinationPath)
                                                throws
                                                IOException,
                                                OperationNotPermittedException {

<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (! isListOfFiles()) {</span>
<span class="nc" id="L285">            throw new OperationNotPermittedException(&quot;move is only permitted on FSPathResult objects containing a java.io.File object&quot;);</span>
        }

<span class="nc" id="L288">        FSPathResultModificationList copyResults = this.copy(destinationPath);</span>

        //if we detect a failure then cease what we're doing and return the results so far
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (copyResults.hasFailures()) {</span>
<span class="nc" id="L292">            return copyResults;</span>
        }

        //if we're happy with the copy, delete the original files,
        //and return the results of the deletion
<span class="nc" id="L297">        return this.delete();</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>