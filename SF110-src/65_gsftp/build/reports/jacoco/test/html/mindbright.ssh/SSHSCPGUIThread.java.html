<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SSHSCPGUIThread.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">65_gsftp</a> &gt; <a href="index.source.html" class="el_package">mindbright.ssh</a> &gt; <span class="el_source">SSHSCPGUIThread.java</span></div><h1>SSHSCPGUIThread.java</h1><pre class="source lang-java linenums">/******************************************************************************
 *
 * Copyright (c) 1998,99 by Mindbright Technology AB, Stockholm, Sweden.
 *                 www.mindbright.se, info@mindbright.se
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 *****************************************************************************
 * $Author: webjabber $
 * $Date: 2006/06/13 18:43:42 $
 * $Name:  $
 *****************************************************************************/
package mindbright.ssh;

import java.awt.*;
import java.awt.event.*;
import java.io.File;

import com.gotoservers.ftp.RemoteFileBrowser;
import com.isnetworks.ssh.FileDisplay;

import mindbright.gui.ProgressBar;
import mindbright.util.AWTConvenience;

public final class SSHSCPGUIThread implements Runnable, SSHSCPIndicator {
	//String curDir, localFile, remoteFile;
<span class="fc" id="L35">	String curDir =&quot;/&quot;;</span>
	//String remoteHost;

	//int remotePort;

	// //SSHAuthenticator authenticator;
	// //SSHClientUser mainUser;
	// //SSHInteractor interactor;
	boolean recursive, background, toRemote;

	Frame parent;

	SSHSCPPanel mRefreshDialog;

	//String[] localFileList;

	Dialog copyIndicator;

	ProgressBar progress;

	// //SSHSCP scp;
	Thread copyThread;

	Label srcLbl, dstLbl, sizeLbl, nameLbl, speedLbl;

	Button cancB;

	long startTime;

	long lastTime;

	long totTransSize;

	long fileTransSize;

	long curFileSize;

	long lastSize;

	int fileCnt;
	
	boolean isBinary;

	boolean doneCopying;
	RemoteFileBrowser mRemoteFileBrowser;
	FileDisplay mLocalFileDisplay;
	FileDisplay mRemoteFileDisplay;
	public SSHSCPGUIThread(
	// //String remoteHost, int remotePort,
			// //SSHAuthenticator authenticator,
			// //SSHClientUser mainUser, SSHInteractor interactor,
			//Frame parent, String curDir, String localFile, String remoteFile,
			Frame parent,
			FileDisplay localFileDisplay,
			FileDisplay remoteFileDisplay,
			RemoteFileBrowser remoteFileBrowser,
			
			boolean recursive, 
			boolean background, 
			boolean toRemote,
			boolean isBinary,
<span class="fc" id="L96">			SSHSCPPanel dialog) throws Exception {</span>
		// super(SSH.getThreadGroup(), SSH.createThreadName()); // JH_Mod
<span class="fc" id="L98">		this.mLocalFileDisplay = localFileDisplay;</span>
<span class="fc" id="L99">		this.mRemoteFileDisplay = remoteFileDisplay;</span>
<span class="fc" id="L100">		this.mRemoteFileBrowser = remoteFileBrowser;</span>
<span class="fc" id="L101">		this.isBinary = isBinary;</span>
<span class="fc" id="L102">		this.parent = parent;</span>
<span class="fc" id="L103">		this.recursive = recursive;</span>
<span class="fc" id="L104">		this.background = background;</span>
<span class="fc" id="L105">		this.toRemote = toRemote;</span>

<span class="fc" id="L107">		this.fileCnt = 0;</span>
<span class="fc" id="L108">		this.doneCopying = false;</span>
<span class="fc" id="L109">		this.startTime = 0;</span>
<span class="fc" id="L110">		this.lastTime = 0;</span>
<span class="fc" id="L111">		this.totTransSize = 0;</span>
<span class="fc" id="L112">		this.fileTransSize = 0;</span>
<span class="fc" id="L113">		this.lastSize = 0;</span>
<span class="fc" id="L114">		this.mRefreshDialog = dialog;</span>
		// this.start();
<span class="fc" id="L116">	}</span>

	private void setupDialog() {
<span class="fc" id="L119">		String sourceFile = &quot;Local:&quot;;</span>
<span class="fc" id="L120">		String destFile = &quot;Remote:&quot;;</span>

<span class="fc bfc" id="L122" title="All 2 branches covered.">		if (!toRemote) {</span>
			String tmp;
<span class="fc" id="L124">			tmp = sourceFile;</span>
<span class="fc" id="L125">			sourceFile = destFile;</span>
<span class="fc" id="L126">			destFile = tmp;</span>
		}

<span class="nc" id="L129">		copyIndicator = new Dialog(parent, &quot;GoToServers - File Transfer&quot;, false);</span>

<span class="nc" id="L131">		GridBagLayout grid = new GridBagLayout();</span>
<span class="nc" id="L132">		GridBagConstraints gridc = new GridBagConstraints();</span>
		Label lbl;
		Button b;

<span class="nc" id="L136">		copyIndicator.setLayout(grid);</span>

<span class="nc" id="L138">		gridc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L139">		gridc.anchor = GridBagConstraints.WEST;</span>
<span class="nc" id="L140">		gridc.gridy = 0;</span>
<span class="nc" id="L141">		gridc.gridwidth = 1;</span>
<span class="nc" id="L142">		gridc.insets = new Insets(4, 4, 4, 4);</span>

<span class="nc" id="L144">		lbl = new Label(&quot;Source:&quot;);</span>
<span class="nc" id="L145">		grid.setConstraints(lbl, gridc);</span>
<span class="nc" id="L146">		copyIndicator.add(lbl);</span>

<span class="nc" id="L148">		gridc.gridwidth = 4;</span>
<span class="nc" id="L149">		srcLbl = new Label(cutName(sourceFile, 32));</span>
<span class="nc" id="L150">		grid.setConstraints(srcLbl, gridc);</span>
<span class="nc" id="L151">		copyIndicator.add(srcLbl);</span>

<span class="nc" id="L153">		gridc.gridy = 1;</span>
<span class="nc" id="L154">		gridc.gridwidth = 1;</span>

<span class="nc" id="L156">		lbl = new Label(&quot;Destination:&quot;);</span>
<span class="nc" id="L157">		grid.setConstraints(lbl, gridc);</span>
<span class="nc" id="L158">		copyIndicator.add(lbl);</span>

<span class="nc" id="L160">		gridc.gridwidth = 4;</span>
<span class="nc" id="L161">		dstLbl = new Label(cutName(destFile, 32));</span>
<span class="nc" id="L162">		grid.setConstraints(dstLbl, gridc);</span>
<span class="nc" id="L163">		copyIndicator.add(dstLbl);</span>

<span class="nc" id="L165">		gridc.gridy = 2;</span>

<span class="nc" id="L167">		gridc.gridwidth = 1;</span>
<span class="nc" id="L168">		lbl = new Label(&quot;Current:&quot;);</span>
<span class="nc" id="L169">		grid.setConstraints(lbl, gridc);</span>
<span class="nc" id="L170">		copyIndicator.add(lbl);</span>

<span class="nc" id="L172">		gridc.gridwidth = 3;</span>
<span class="nc" id="L173">		nameLbl = new Label(&quot;connecting...&quot;);</span>
<span class="nc" id="L174">		grid.setConstraints(nameLbl, gridc);</span>
<span class="nc" id="L175">		copyIndicator.add(nameLbl);</span>

<span class="nc" id="L177">		gridc.gridwidth = 1;</span>
<span class="nc" id="L178">		sizeLbl = new Label(&quot;&quot;);</span>
<span class="nc" id="L179">		grid.setConstraints(sizeLbl, gridc);</span>
<span class="nc" id="L180">		copyIndicator.add(sizeLbl);</span>

<span class="nc" id="L182">		gridc.gridy = 3;</span>
<span class="nc" id="L183">		gridc.gridwidth = 3;</span>
<span class="nc" id="L184">		gridc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L185">		gridc.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L186">		gridc.insets = new Insets(4, 12, 4, 4);</span>
<span class="nc" id="L187">		progress = new ProgressBar(512, 160, 20);</span>
<span class="nc" id="L188">		grid.setConstraints(progress, gridc);</span>
<span class="nc" id="L189">		copyIndicator.add(progress);</span>

<span class="nc" id="L191">		gridc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L192">		gridc.insets = new Insets(4, 4, 4, 4);</span>
<span class="nc" id="L193">		gridc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L194">		speedLbl = new Label(&quot;0.0 kB/sec&quot;, Label.CENTER);</span>
<span class="nc" id="L195">		grid.setConstraints(speedLbl, gridc);</span>
<span class="nc" id="L196">		copyIndicator.add(speedLbl);</span>

<span class="nc" id="L198">		gridc.gridy = 4;</span>
<span class="nc" id="L199">		cancB = new Button(&quot;Cancel&quot;);</span>
<span class="nc" id="L200">		cancB.addActionListener(new ActionListener() {</span>
			public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L202" title="All 2 branches missed.">				if (!doneCopying) {</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">					if (copyThread != null)</span>
<span class="nc" id="L204">						copyThread.stop();</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">					if (mRemoteFileBrowser != null)</span>
<span class="nc" id="L206">						mRemoteFileBrowser.abort();</span>
				}
<span class="nc" id="L208">				copyIndicator.setVisible(false);</span>
<span class="nc" id="L209">			}</span>
		});

<span class="nc" id="L212">		gridc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L213">		gridc.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L214">		gridc.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L215">		gridc.ipady = 2;</span>
<span class="nc" id="L216">		gridc.ipadx = 2;</span>
<span class="nc" id="L217">		grid.setConstraints(cancB, gridc);</span>
<span class="nc" id="L218">		copyIndicator.add(cancB);</span>

<span class="nc" id="L220">		AWTConvenience.setBackgroundOfChildren(copyIndicator);</span>

<span class="nc" id="L222">		Dimension d = speedLbl.getSize();</span>
<span class="nc" id="L223">		d.width += d.width * 2;</span>
<span class="nc" id="L224">		speedLbl.setSize(d);</span>
<span class="nc" id="L225">		sizeLbl.setSize(d);</span>

<span class="nc" id="L227">		copyIndicator.setResizable(true);</span>
<span class="nc" id="L228">		copyIndicator.pack();</span>
<span class="nc" id="L229">		AWTConvenience.placeDialog(copyIndicator);</span>
<span class="nc" id="L230">	}</span>

	public void run() {
<span class="nc" id="L233">		setupDialog();</span>
		// copyThread = new Thread(new Runnable() {
<span class="nc" id="L235">		copyThread = new Thread(SSHSCPPanel.getThreadGroup(), new Runnable() { // JH_Mod</span>
					public void run() {

						try {
<span class="nc bnc" id="L239" title="All 2 branches missed.">							if ( toRemote ){</span>
<span class="nc" id="L240">								mRemoteFileBrowser.putFiles(SSHSCPGUIThread.this, </span>
										mRemoteFileDisplay,
										mLocalFileDisplay,
										isBinary
										);
							}else{
<span class="nc" id="L246">								mRemoteFileBrowser.getFiles(SSHSCPGUIThread.this, </span>
										mRemoteFileDisplay,
										mLocalFileDisplay,
										isBinary
										);
								
							}
							////scp = new SSHSCP(remoteHost, remotePort,
							////		authenticator, new File(curDir), recursive,
							////		false);
							////scp.setClientUser(mainUser);
							////scp.setInteractor(interactor);
							////scp.setIndicator(SSHSCPGUIThread.this);
							////if (toRemote) {
							////	scp.copyToRemote(localFileList, remoteFile);
							////} else {
							////	scp.copyToLocal(localFileList, remoteFile);
							///}
<span class="nc" id="L264">							copyThread.setPriority(Thread.NORM_PRIORITY);</span>
<span class="nc" id="L265">							Toolkit.getDefaultToolkit().beep();</span>
<span class="nc" id="L266">						} catch (Exception e) {</span>
							//TODO:
							////interactor.alert(&quot;SCP Error: &quot; + e.getMessage());
<span class="nc" id="L269">							System.out.println(&quot;SCP Error:&quot;);</span>
<span class="nc" id="L270">							e.printStackTrace();</span>
<span class="nc" id="L271">						}</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">						nameLbl.setText(&quot;Copied &quot; + fileCnt + &quot; file&quot;</span>
								+ (fileCnt != 1 ? &quot;s&quot; : &quot;&quot;) + &quot;.&quot;);
<span class="nc" id="L274">						double kSize = (double) totTransSize / 1024;</span>
<span class="nc" id="L275">						sizeLbl.setText(round(kSize) + &quot; kB&quot;);</span>
<span class="nc" id="L276">						doneCopying = true;</span>
<span class="nc" id="L277">						cancB.setLabel(&quot;Done&quot;);</span>
<span class="nc" id="L278">						mRefreshDialog.refresh();</span>

<span class="nc" id="L280">						AWTConvenience</span>
<span class="nc" id="L281">								.setKeyListenerOfChildren(copyIndicator,</span>
										new AWTConvenience.OKCancelAdapter(
												cancB, cancB), null);

<span class="nc" id="L285">					}</span>
				});

<span class="nc bnc" id="L288" title="All 2 branches missed.">		if (background) {</span>
<span class="nc" id="L289">			copyThread.setPriority(Thread.MIN_PRIORITY);</span>
		}

<span class="nc" id="L292">		copyThread.start();</span>

<span class="nc" id="L294">		copyIndicator.setVisible(true);</span>
<span class="nc" id="L295">	}</span>

	public static String[] spaceSplit(String str) {
<span class="fc bfc" id="L298" title="All 4 branches covered.">		if( str==null || str.length()&lt;=0 )return null;</span>
		
<span class="fc" id="L300">		int l = 0, r, cnt = 0;</span>
<span class="fc" id="L301">		String[] list = new String[str.length() / 2];</span>
<span class="fc" id="L302">		boolean lastIsQuoted = false;</span>
<span class="fc" id="L303">		str = str.trim();</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">		while ((r = str.indexOf(' ', l)) &gt;= 0) {</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">			if (str.charAt(l) == '&quot;') {</span>
<span class="fc" id="L306">				l += 1;</span>
<span class="fc" id="L307">				r = str.indexOf('&quot;', l);</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">				if (r == -1)</span>
<span class="fc" id="L309">					return null;</span>
			}
<span class="fc" id="L311">			String name = str.substring(l, r);</span>
<span class="fc bfc" id="L312" title="All 2 branches covered.">			if (name.endsWith(File.separator))</span>
<span class="fc" id="L313">				name = name.substring(0, name.length() - 1);</span>
<span class="fc" id="L314">			list[cnt++] = name;</span>

<span class="fc" id="L316">			l = r;</span>
			do {
<span class="fc" id="L318">				l++;</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">				if (l == str.length()) {</span>
<span class="fc" id="L320">					lastIsQuoted = true;</span>
<span class="fc" id="L321">					break;</span>
				}
<span class="fc bfc" id="L323" title="All 2 branches covered.">			} while (str.charAt(l) == ' ');</span>
<span class="fc" id="L324">		}</span>

<span class="fc bfc" id="L326" title="All 2 branches covered.">		if (!lastIsQuoted) {</span>
<span class="fc bfc" id="L327" title="All 2 branches covered.">			if (str.charAt(l) == '&quot;') {</span>
<span class="fc" id="L328">				l += 1;</span>
<span class="fc" id="L329">				r = str.indexOf('&quot;', l);</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">				if (r == -1)</span>
<span class="fc" id="L331">					return null;</span>
			}
<span class="fc" id="L333">			String name = str.substring(l);</span>
<span class="fc bfc" id="L334" title="All 2 branches covered.">			if (name.endsWith(File.separator))</span>
<span class="fc" id="L335">				name = name.substring(0, name.length() - 1);</span>
<span class="fc" id="L336">			list[cnt++] = name;</span>
		}

<span class="fc bfc" id="L339" title="All 2 branches covered.">		for (int i = 0; i &lt; cnt; i++) {</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">			if (list[i].endsWith(&quot;\&quot;&quot;)) {</span>
<span class="fc" id="L341">				list[i] = list[i].substring(0, list[i].length() - 1);</span>
			}
		}

<span class="fc" id="L345">		String[] tmp = list;</span>
<span class="fc" id="L346">		list = new String[cnt];</span>
<span class="fc" id="L347">		System.arraycopy(tmp, 0, list, 0, cnt);</span>

<span class="fc" id="L349">		return list;</span>
	}

	public static String[] starExpand(String[] fileList, String curDir) {
<span class="fc" id="L353">		int i, j, n, cnt = 0;</span>
<span class="fc" id="L354">		String[] newList = new String[4096]; // !!! Ouch...</span>
<span class="fc" id="L355">		String[] curDirList = (new File(curDir)).list();</span>
		String path, curFile;

<span class="fc bfc" id="L358" title="All 2 branches covered.">		for (i = 0; i &lt; fileList.length; i++) {</span>
<span class="fc" id="L359">			curFile = fileList[i];</span>
<span class="fc" id="L360">			path = &quot;&quot;;</span>
<span class="fc" id="L361">			n = curFile.indexOf('*');</span>
<span class="fc bfc" id="L362" title="All 2 branches covered.">			if (n == -1) {</span>
<span class="fc" id="L363">				cnt = addUnique(newList, curFile, cnt);</span>
<span class="fc" id="L364">				continue;</span>
			}
			String[] dirList;
<span class="fc" id="L367">			File f = new File(curFile);</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">			if (!f.isAbsolute()) {</span>
<span class="fc" id="L369">				dirList = curDirList;</span>
			} else {
<span class="fc" id="L371">				String dir = f.getParent();</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">				if (dir == null)</span>
<span class="nc" id="L373">					dir = new String(File.separator); // !!! Ouch...</span>
<span class="fc" id="L374">				dirList = (new File(dir)).list();</span>
<span class="fc" id="L375">				curFile = f.getName();</span>
<span class="fc" id="L376">				path = dir + File.separator;</span>
<span class="fc" id="L377">				n = curFile.indexOf('*');</span>
			}

<span class="fc" id="L380">			String pre = curFile.substring(0, n);</span>
<span class="fc" id="L381">			String post = curFile.substring(n + 1);</span>
<span class="fc bfc" id="L382" title="All 2 branches covered.">			for (j = 0; j &lt; dirList.length; j++) {</span>
<span class="fc" id="L383">				String name = dirList[j];</span>
<span class="fc bfc" id="L384" title="All 4 branches covered.">				if (name.startsWith(pre) &amp;&amp; name.endsWith(post)) {</span>
<span class="fc" id="L385">					cnt = addUnique(newList, path + name, cnt);</span>
				}
			}
		}
<span class="fc" id="L389">		String[] tmp = newList;</span>
<span class="fc" id="L390">		newList = new String[cnt];</span>
<span class="fc" id="L391">		System.arraycopy(tmp, 0, newList, 0, cnt);</span>
<span class="fc" id="L392">		return newList;</span>
	}

	static int addUnique(String[] list, String str, int last) {
		int i;
<span class="fc bfc" id="L397" title="All 2 branches covered.">		for (i = 0; i &lt; last; i++)</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">			if (list[i].equals(str))</span>
<span class="fc" id="L399">				break;</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">		if (i == last)</span>
<span class="fc" id="L401">			list[last++] = str;</span>
<span class="fc" id="L402">		return last;</span>
	}

	public void connected(String server) {
<span class="nc" id="L406">		nameLbl.setText(&quot;...connected&quot;);</span>
<span class="nc" id="L407">	}</span>

	public void startFile(String file, long size) {
<span class="fc" id="L410">		double kSize = (double) size / 1024;</span>
<span class="nc" id="L411">		sizeLbl.setText(round(kSize) + &quot; kB&quot;);</span>
<span class="nc" id="L412">		nameLbl.setText(file);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">		if (toRemote) {</span>
<span class="nc" id="L414">			srcLbl.setText(cutName(&quot;localhost:&quot; + file, 32));</span>
		} else {
<span class="nc" id="L416">			dstLbl.setText(cutName(&quot;localhost:&quot; + file, 32));</span>
		}
<span class="nc" id="L418">		progress.setMax(size, true);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">		if (startTime == 0)</span>
<span class="nc" id="L420">			startTime = System.currentTimeMillis();</span>
<span class="nc" id="L421">		curFileSize = size;</span>
<span class="nc" id="L422">		fileTransSize = 0;</span>
<span class="nc" id="L423">		fileCnt++;</span>
<span class="nc" id="L424">	}</span>

	public void startDir(String file) {
<span class="fc bfc" id="L427" title="All 2 branches covered.">		if (startTime == 0)</span>
<span class="fc" id="L428">			startTime = System.currentTimeMillis();</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">		if (file.length() &gt; curDir.length())</span>
<span class="fc" id="L430">			file = file.substring(curDir.length());</span>
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">		if (toRemote) {</span>
<span class="nc" id="L432">			srcLbl.setText(cutName(&quot;localhost:&quot; + file, 32));</span>
		} else {
<span class="nc" id="L434">			dstLbl.setText(cutName(&quot;localhost:&quot; + file, 32));</span>
		}
<span class="nc" id="L436">	}</span>

	public void endFile() {
<span class="nc" id="L439">		progress.setValue(curFileSize, true);</span>
<span class="nc" id="L440">	}</span>

	public void endDir() {
<span class="fc" id="L443">	}</span>

	public void progress(long size) {
<span class="fc" id="L446">		totTransSize += size;</span>
<span class="fc" id="L447">		fileTransSize += size;</span>
<span class="fc bfc" id="L448" title="All 4 branches covered.">		if ((curFileSize &gt; 0)</span>
				&amp;&amp; ((((totTransSize - lastSize) * 100) / curFileSize) &gt;= 1)) {
<span class="fc bfc" id="L450" title="All 2 branches covered.">			progress.setValue(fileTransSize, !background);</span>
<span class="fc" id="L451">			long now = System.currentTimeMillis();</span>
<span class="fc" id="L452">			long totSec = ((now - startTime) / 1000);</span>
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">			double rate = (totSec != 0 ? (((double) totTransSize / 1024) / totSec)</span>
					: 0.0);
<span class="fc" id="L455">			totSec = (now - lastTime);</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">			if (totSec != 0) {</span>
<span class="fc" id="L457">				double rate2 = ((double) (totTransSize - lastSize) / 1024)</span>
						/ totSec;
<span class="fc" id="L459">				rate = (rate + rate2) / 2.0;</span>
			}
<span class="nc" id="L461">			speedLbl.setText(&quot;&quot; + round(rate) + &quot; kB/sec&quot;);</span>
<span class="nc" id="L462">			lastSize = totTransSize;</span>
<span class="nc" id="L463">			lastTime = now;</span>
		}
<span class="fc" id="L465">	}</span>

	double round(double val) {
<span class="fc" id="L468">		val = val * 10.0;</span>
<span class="fc" id="L469">		val = Math.floor(val);</span>
<span class="fc" id="L470">		val = val / 10.0;</span>
<span class="fc" id="L471">		return val;</span>
	}

	String cutName(String name, int len) {
<span class="fc bfc" id="L475" title="All 2 branches covered.">		if (name.length() &gt; len) {</span>
<span class="fc" id="L476">			len -= 3;</span>
<span class="fc" id="L477">			String pre = name.substring(0, len / 2);</span>
<span class="fc" id="L478">			String suf = name.substring(name.length() - (len / 2));</span>
<span class="fc" id="L479">			name = pre + &quot;...&quot; + suf;</span>
		}
<span class="fc" id="L481">		return name;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>