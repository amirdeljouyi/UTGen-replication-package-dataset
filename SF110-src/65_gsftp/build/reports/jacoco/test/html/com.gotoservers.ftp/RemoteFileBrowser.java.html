<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RemoteFileBrowser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">65_gsftp</a> &gt; <a href="index.source.html" class="el_package">com.gotoservers.ftp</a> &gt; <span class="el_source">RemoteFileBrowser.java</span></div><h1>RemoteFileBrowser.java</h1><pre class="source lang-java linenums">/******************************************************************************
 *
 * Copyright (c) 2006 by GoToServers.com
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *****************************************************************************/

package com.gotoservers.ftp;

import mindbright.ssh.SSHMiscDialogs;
import mindbright.ssh.SSHPropertyHandler;
import mindbright.ssh.SSHSCPIndicator;
import mindbright.ssh.SSHSCPPanel;

import org.apache.commons.net.ProtocolCommandEvent;
import org.apache.commons.net.ProtocolCommandListener;

import java.io.*;
import java.util.*;

import com.isnetworks.ssh.*;

import org.apache.commons.net.ftp.FTP;
import org.apache.commons.net.ftp.FTPClient;
import org.apache.commons.net.ftp.FTPFile;
import org.apache.commons.net.ftp.FTPReply;

public class RemoteFileBrowser extends AbstractFileBrowser implements
		ProtocolCommandListener {
	String currentPath;

	FTPClient ftp;

	SSHPropertyHandler mPropertyHandler;

	SSHSCPPanel mErrorLog;

	public RemoteFileBrowser(FileDisplay fileDisplay,
			SSHPropertyHandler propertyHandler, SSHSCPPanel errorLog) {
<span class="nc" id="L48">		super(fileDisplay, propertyHandler);</span>
<span class="nc" id="L49">		mPropertyHandler = propertyHandler;</span>
<span class="nc" id="L50">		mErrorLog = errorLog;</span>

<span class="nc" id="L52">	}</span>

	public void fileDoubleClicked(FileListItem file) throws SSHException {
		try {
<span class="nc bnc" id="L56" title="All 2 branches missed.">			if (file.isDirectory()) {</span>
<span class="nc" id="L57">				ftp.cwd(file.getName());</span>
<span class="nc" id="L58">				refresh();</span>
			}
<span class="nc" id="L60">		} catch (Exception e) {</span>
<span class="nc" id="L61">			throw new SSHException(e.getMessage());</span>
<span class="nc" id="L62">		}</span>
<span class="nc" id="L63">	}</span>
	private String getPWD(){
		try{
<span class="nc bnc" id="L66" title="All 2 branches missed.">			if (ftp.pwd() == 257) {</span>
<span class="nc" id="L67">				String res = ftp.getReplyString();</span>
<span class="nc bnc" id="L68" title="All 4 branches missed.">				if (res != null &amp;&amp; res.length() &gt;= 5</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">						&amp;&amp; res.indexOf(&quot;257 &quot;) == 0) {</span>
<span class="nc" id="L70">					res = res.substring(4);</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">					if (res.charAt(0) == '&quot;') {</span>
<span class="nc" id="L72">						res = res.substring(1);</span>
<span class="nc" id="L73">						int pos = res.indexOf('&quot;');</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">						if (pos &gt; 0) {</span>
<span class="nc" id="L75">							res = res.substring(0, pos);</span>
						}
<span class="nc" id="L77">					} else {</span>
<span class="nc" id="L78">						int pos = res.indexOf(' ');</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">						if (pos &gt; 0) {</span>
<span class="nc" id="L80">							res = res.substring(0, pos);</span>
						}
					}
<span class="nc" id="L83">					return res;</span>
				}
			}
<span class="nc" id="L86">		}catch(Exception e){</span>
<span class="nc" id="L87">			mErrorLog.logError(e);</span>
<span class="nc" id="L88">		}</span>
<span class="nc" id="L89">		return null;</span>
	}
	public void refresh() throws SSHException {
<span class="nc bnc" id="L92" title="All 2 branches missed.">		if( !ftp.isConnected() ){</span>
<span class="nc" id="L93">			connect();</span>
			try {
<span class="nc" id="L95">				ftp.changeWorkingDirectory(currentPath);</span>
<span class="nc" id="L96">			} catch (Exception e) {</span>
<span class="nc" id="L97">				throw new SSHException(e.getMessage());</span>
<span class="nc" id="L98">			}</span>
			
		}
		try {
<span class="nc" id="L102">			String pwd = getPWD();</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">			if( pwd!=null ) currentPath = pwd;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			if (currentPath == null) currentPath = &quot;/&quot;;</span>

			// 257 &quot;PATHNAME&quot;

<span class="nc" id="L108">			FTPFile[] files = ftp.listFiles();</span>

<span class="nc" id="L110">			Vector v = new Vector();</span>

			// Add each file and directory in the list
<span class="nc bnc" id="L113" title="All 2 branches missed.">			for (int i = 0; i &lt; files.length; i++) {</span>
<span class="nc bnc" id="L114" title="All 4 branches missed.">				if (files[i].isDirectory() &amp;&amp; &quot;.&quot;.equals(files[i].getName()))</span>
<span class="nc" id="L115">					continue;</span>
<span class="nc" id="L116">				v.addElement(new FileListItem(files[i].getName(), currentPath,</span>
<span class="nc" id="L117">						files[i].isDirectory(), files[i].getSize(),</span>
<span class="nc" id="L118">						files[i].getTimestamp().getTimeInMillis()</span>
						));
			}

			// Sort the array since File.list() does not define an order for the
			// results
<span class="nc" id="L124">			FileListItem.sort(v);</span>

			// Set list in the GUI
<span class="nc" id="L127">			mFileDisplay.setFileList(v, currentPath);</span>
<span class="nc" id="L128">		} catch (Exception e) {</span>
<span class="nc" id="L129">			throw new SSHException(e.getMessage());</span>
<span class="nc" id="L130">		}</span>

<span class="nc" id="L132">	}</span>

	public void delete(FileListItem[] files) throws SSHException {
<span class="nc bnc" id="L135" title="All 4 branches missed.">		if (files != null</span>
				 &amp;&amp; files.length&gt;0 
<span class="nc bnc" id="L137" title="All 2 branches missed.">				 &amp;&amp; SSHMiscDialogs.confirm(&quot;Deletion Confirmation&quot;,&quot;Do you want to delete them?&quot;,true,mPropertyHandler.getParent())</span>
			){
<span class="nc bnc" id="L139" title="All 2 branches missed.">			for (int i = 0; i &lt; files.length; i++) {</span>
				try {
<span class="nc bnc" id="L141" title="All 2 branches missed.">					if (files[i].isDirectory()) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">						if (!ftp.removeDirectory(files[i].getName())) {</span>
<span class="nc" id="L143">							System.out.println(ftp.getReplyString());</span>
						}
<span class="nc bnc" id="L145" title="All 2 branches missed.">					} else if (!ftp.deleteFile(files[i].getName())) {</span>
<span class="nc" id="L146">						System.out.println(ftp.getReplyString());</span>
					}

<span class="nc" id="L149">				} catch (Exception e) {</span>
<span class="nc" id="L150">					e.printStackTrace();</span>
<span class="nc" id="L151">				}</span>
			}
<span class="nc" id="L153">			refresh();</span>
		}

<span class="nc" id="L156">	}</span>
	private void connect()  throws SSHException {
<span class="nc" id="L158">		ftp = new FTPClient();</span>
<span class="nc" id="L159">		ftp.addProtocolCommandListener(this);</span>
		try {
			int reply;
<span class="nc" id="L162">			ftp.connect(mPropertyHandler.getRemoteServer(), mPropertyHandler</span>
<span class="nc" id="L163">					.getRemotePort());</span>

			// After connection attempt, you should check the reply code to
			// verify
			// success.
<span class="nc" id="L168">			reply = ftp.getReplyCode();</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">			if (!FTPReply.isPositiveCompletion(reply)) {</span>
<span class="nc" id="L171">				throw new SSHException(ftp.getReplyString());</span>
			}
<span class="nc bnc" id="L173" title="All 2 branches missed.">			if (!ftp.login(mPropertyHandler.getRemoteUser(), mPropertyHandler</span>
<span class="nc" id="L174">					.getRemotePassword())) {</span>
<span class="nc" id="L175">				throw new SSHException(ftp.getReplyString());</span>
			}
			// if (binaryTransfer)
			// ftp.setFileType(FTP.BINARY_FILE_TYPE);

<span class="nc" id="L180">			ftp.enterLocalPassiveMode();</span>

<span class="nc" id="L182">		} catch (IOException e) {</span>
<span class="nc" id="L183">			disconnect();</span>
<span class="nc" id="L184">			e.printStackTrace();</span>
<span class="nc" id="L185">			throw new SSHException(e.getMessage());</span>
<span class="nc" id="L186">		} finally {</span>

<span class="nc" id="L188">		}</span>

<span class="nc" id="L190">	}</span>
	public void initialize() throws SSHException {
<span class="nc" id="L192">		connect();</span>
<span class="nc" id="L193">		refresh();</span>
<span class="nc" id="L194">	}</span>

	public void makeDirectory(String directoryName) throws SSHException {
		try {
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (ftp.makeDirectory(directoryName)) {</span>
<span class="nc" id="L199">				refresh();</span>
			} else {
<span class="nc" id="L201">				System.out.println(ftp.getReplyString());</span>
			}
<span class="nc" id="L203">		} catch (Exception e) {</span>
<span class="nc" id="L204">			e.printStackTrace();</span>
<span class="nc" id="L205">		}</span>

<span class="nc" id="L207">	}</span>

	public void rename(FileListItem file, String newFileName)
			throws SSHException {
		try {
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (ftp.rename(file.getName(), newFileName)) {</span>
<span class="nc" id="L213">				refresh();</span>
			} else {
<span class="nc" id="L215">				throw new SSHException(ftp.getReplyString());</span>
			}
<span class="nc" id="L217">		} catch (Exception e) {</span>
<span class="nc" id="L218">			mErrorLog.logError(e);</span>
<span class="nc" id="L219">		}</span>

<span class="nc" id="L221">	}</span>

	public void changeDirectory(String directoryName) throws SSHException {
		try {
<span class="nc bnc" id="L225" title="All 2 branches missed.">			if (ftp.changeWorkingDirectory(directoryName)) {</span>
<span class="nc" id="L226">				refresh();</span>
			} else {
<span class="nc" id="L228">				throw new SSHException(ftp.getReplyString());</span>
			}
<span class="nc" id="L230">		} catch (Exception e) {</span>
<span class="nc" id="L231">			mErrorLog.logError(e);</span>
<span class="nc" id="L232">		}</span>
<span class="nc" id="L233">	}</span>

	public void disconnect() {
<span class="nc" id="L236">		System.out.println(&quot;disconnect&quot;);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">		if (ftp.isConnected()) {</span>
			try {
<span class="nc" id="L239">				ftp.logout();</span>
<span class="nc" id="L240">			} catch (IOException f) {</span>
				// do nothing
<span class="nc" id="L242">			}</span>
			try {
<span class="nc" id="L244">				ftp.disconnect();</span>
<span class="nc" id="L245">			} catch (IOException f) {</span>
				// do nothing
<span class="nc" id="L247">			}</span>
		}

<span class="nc" id="L250">	}</span>

	public void protocolCommandSent(ProtocolCommandEvent event) {
		// TODO Auto-generated method stub
		// System.out.println(&quot;Sent Command:&quot; + event.getCommand());
		// System.out.println(&quot;Sent Message:&quot; + event.getMessage());
<span class="nc" id="L256">	}</span>

	public void protocolReplyReceived(ProtocolCommandEvent event) {
		// TODO Auto-generated method stub
<span class="nc" id="L260">		System.out.println(&quot;Replay Code:&quot; + event.getReplyCode());</span>
<span class="nc" id="L261">		System.out.println(&quot;Replay Message:&quot; + event.getMessage());</span>

<span class="nc" id="L263">	}</span>
	private void getAllFiles(SSHSCPIndicator indicator,FileListItem[] rFiles, String curDir ){
		//handle file
<span class="nc bnc" id="L266" title="All 2 branches missed.">		for (int i = 0; i &lt; rFiles.length; i++) {</span>
<span class="nc" id="L267">			FileListItem fi = rFiles[i];</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">			if (fi.isDirectory()) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">				if( &quot;.&quot;.equals(fi.getName()) </span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">				 || &quot;..&quot;.equals(fi.getName()) ) {</span>
<span class="nc" id="L271">					continue;</span>
				}
<span class="nc" id="L273">				String localDir = curDir+fi.getName()+&quot;/&quot;;</span>
<span class="nc" id="L274">				File localDirFile = new File(localDir);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">				if( localDirFile.exists() ){</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">					if( !localDirFile.isDirectory() ){</span>
<span class="nc" id="L277">						mErrorLog.logError(new SSHException(&quot;Can't create directory:&quot;+localDir) );</span>
<span class="nc" id="L278">						continue;</span>
					}
				}else{
					try{
<span class="nc bnc" id="L282" title="All 2 branches missed.">						if( !localDirFile.mkdir() ){</span>
<span class="nc" id="L283">							throw new SSHException(&quot;Can't create directory:&quot;+localDir);</span>
						}
<span class="nc" id="L285">					}catch(Exception e){</span>
<span class="nc" id="L286">						mErrorLog.logError(e );</span>
<span class="nc" id="L287">						continue;</span>
<span class="nc" id="L288">					}</span>
				}
				
				try{
<span class="nc bnc" id="L292" title="All 2 branches missed.">					if (ftp.changeWorkingDirectory(fi.getName())) {</span>
<span class="nc" id="L293">						String pwd = getPWD();</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">						if( pwd==null)pwd = fi.getAbsolutePath();</span>
<span class="nc" id="L295">						System.err.println(&quot;D:&quot;+pwd);</span>
						
<span class="nc" id="L297">						FTPFile[] files = ftp.listFiles();</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">						if( files!=null &amp;&amp; files.length&gt;0){</span>
<span class="nc" id="L299">							FileListItem[] drFiles = new FileListItem[files.length];</span>
							// Add each file and directory in the list
<span class="nc bnc" id="L301" title="All 2 branches missed.">							for (int ri = 0; ri &lt; files.length; ri++) {</span>
<span class="nc" id="L302">								System.err.println(&quot;F:&quot;+files[ri].getName());</span>
<span class="nc" id="L303">								drFiles[ri]= new FileListItem(files[ri].getName(), localDir,</span>
<span class="nc" id="L304">										files[ri].isDirectory(), files[ri].getSize(),</span>
<span class="nc" id="L305">										files[ri].getTimestamp().getTimeInMillis()</span>
										);
							}
<span class="nc" id="L308">							getAllFiles(indicator,drFiles,localDir );</span>

						}
						
						
<span class="nc" id="L313">						ftp.changeToParentDirectory();</span>
<span class="nc" id="L314">					} else {</span>
<span class="nc" id="L315">						throw new SSHException(ftp.getReplyString());</span>
					}
<span class="nc" id="L317">				} catch (Exception e) {</span>
<span class="nc" id="L318">					mErrorLog.logError(e);</span>
<span class="nc" id="L319">				}</span>
				// handle latter
<span class="nc" id="L321">			} else {</span>
<span class="nc" id="L322">				InputStream is = null;</span>
<span class="nc" id="L323">				OutputStream os = null;</span>
				try {
<span class="nc" id="L325">					File localFile = new File(curDir + fi.getName());</span>
<span class="nc" id="L326">					is = ftp.retrieveFileStream(fi.getName());</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">					if( is!=null ){</span>
<span class="nc" id="L328">						os = new FileOutputStream(localFile);</span>
<span class="nc" id="L329">						byte[] buffer = new byte[4096];</span>
						int len;
<span class="nc" id="L331">						long total = 0;</span>
<span class="nc" id="L332">						indicator.startFile(fi.getName(), fi.getSize());</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">						while ((len = is.read(buffer)) &gt;= 0) {</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">							if (len &gt; 0) {</span>
<span class="nc" id="L335">								os.write(buffer, 0, len);</span>
<span class="nc" id="L336">								total += len;</span>
<span class="nc" id="L337">								indicator.progress(total);</span>
							}
						}
<span class="nc" id="L340">						indicator.endFile();</span>
<span class="nc" id="L341">					}else{</span>
<span class="nc" id="L342">						mErrorLog.logError(new SSHException(ftp.getReplyString()));</span>
					}
<span class="nc" id="L344">				} catch (Exception e) {</span>
<span class="nc" id="L345">					mErrorLog.logError(e);</span>
					// TODO:
<span class="nc" id="L347">					e.printStackTrace();</span>
				} finally {
<span class="nc bnc" id="L349" title="All 2 branches missed.">					if (is != null) {</span>
						try {
<span class="nc" id="L351">							is.close();</span>
<span class="nc" id="L352">						} catch (Exception e) {</span>
<span class="nc" id="L353">						}</span>
						;
					}
<span class="nc bnc" id="L356" title="All 2 branches missed.">					if (os != null) {</span>
						try {
<span class="nc" id="L358">							os.close();</span>
<span class="nc" id="L359">						} catch (Exception e) {</span>
<span class="nc" id="L360">						}</span>
						;
					}
					try{
<span class="nc" id="L364">						ftp.completePendingCommand();</span>
<span class="nc" id="L365">					}catch(Exception e){</span>
						
<span class="nc" id="L367">					}</span>
				}
			}
			
		}
		
<span class="nc" id="L373">	}</span>
	public void getFiles(SSHSCPIndicator indicator, FileDisplay remoteDisplay,
			FileDisplay localDisplay, boolean isBinary) {
<span class="nc" id="L376">		FileListItem[] rFiles = remoteDisplay.getSelectedFiles();</span>
<span class="nc bnc" id="L377" title="All 4 branches missed.">		if (rFiles != null &amp;&amp; rFiles.length &gt; 0) {</span>
			try {
<span class="nc bnc" id="L379" title="All 2 branches missed.">				if (isBinary) {</span>
<span class="nc" id="L380">					ftp.setFileType(FTP.BINARY_FILE_TYPE);</span>
				} else {
<span class="nc" id="L382">					ftp.setFileType(FTP.ASCII_FILE_TYPE);</span>
				}
<span class="nc" id="L384">				String curDir = localDisplay.getFileSystemLocation();//.getFileSystemLocationLabelText();</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">				if (curDir == null)</span>
<span class="nc" id="L386">					curDir = &quot;/&quot;;</span>
				else {
<span class="nc" id="L388">					int len = curDir.length();</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">					if (curDir.charAt(len - 1) != '/'</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">							&amp;&amp; curDir.charAt(len - 1) != '\\') {</span>
<span class="nc" id="L391">						curDir += &quot;/&quot;;</span>
					}
				}
<span class="nc" id="L394">				getAllFiles(indicator,rFiles, curDir );</span>
<span class="nc" id="L395">			} catch (Exception e) {</span>
<span class="nc" id="L396">				mErrorLog.logError(e);</span>
<span class="nc" id="L397">			}</span>
			try {
<span class="nc" id="L399">				changeDirectory(this.currentPath);</span>
<span class="nc" id="L400">			} catch (Exception e) {</span>
<span class="nc" id="L401">				mErrorLog.logError(e);</span>
<span class="nc" id="L402">			}</span>

		}

<span class="nc" id="L406">	}</span>
	private void putAllFiles(SSHSCPIndicator indicator,FileListItem[] lFiles, String curDir ){
		//handle file
<span class="nc bnc" id="L409" title="All 2 branches missed.">		for (int i = 0; i &lt; lFiles.length; i++) {</span>
<span class="nc" id="L410">			FileListItem fi = lFiles[i];</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">			if (fi.isDirectory()) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">				if( &quot;.&quot;.equals(fi.getName()) </span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">				 || &quot;..&quot;.equals(fi.getName()) ) {</span>
<span class="nc" id="L414">					continue;</span>
				}
<span class="nc" id="L416">				String localDir = curDir+fi.getName()+&quot;/&quot;;</span>
<span class="nc" id="L417">				File localDirFile = new File(localDir);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">				if( !localDirFile.exists() </span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">				 || !localDirFile.isDirectory()){</span>
<span class="nc" id="L420">					mErrorLog.logError(new SSHException(&quot;Can't list directory:&quot;+localDir ));</span>
<span class="nc" id="L421">					continue;</span>
				}
				try{
<span class="nc" id="L424">					ftp.makeDirectory( fi.getName());</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">					if (ftp.changeWorkingDirectory(fi.getName())) {</span>
<span class="nc" id="L426">						String pwd = getPWD();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">						if( pwd==null){</span>
<span class="nc" id="L428">							mErrorLog.logError(new SSHException(&quot;Can't get path :&quot;+fi.getName()) );</span>
<span class="nc" id="L429">							continue;</span>
						}
<span class="nc" id="L431">						System.err.println(&quot;D:&quot;+pwd);</span>
						
<span class="nc" id="L433">						File[] files = localDirFile.listFiles();</span>
<span class="nc bnc" id="L434" title="All 4 branches missed.">						if( files!=null &amp;&amp; files.length&gt;0){</span>
<span class="nc" id="L435">							FileListItem[] dlFiles = new FileListItem[files.length];</span>
							// Add each file and directory in the list
<span class="nc bnc" id="L437" title="All 2 branches missed.">							for (int li = 0; li &lt; files.length; li++) {</span>
<span class="nc" id="L438">								System.err.println(&quot;F:&quot;+files[li].getName());</span>
<span class="nc" id="L439">								dlFiles[li]= new FileListItem(files[li].getName(), localDir,</span>
<span class="nc" id="L440">										files[li].isDirectory(), files[li].length(),</span>
<span class="nc" id="L441">										files[li].lastModified()</span>
										);
							}
<span class="nc" id="L444">							putAllFiles(indicator,dlFiles,localDir );</span>

						}
						
						
<span class="nc" id="L449">						ftp.changeToParentDirectory();</span>
<span class="nc" id="L450">					} else {</span>
<span class="nc" id="L451">						throw new SSHException(ftp.getReplyString());</span>
					}
<span class="nc" id="L453">				} catch (Exception e) {</span>
<span class="nc" id="L454">					mErrorLog.logError(e);</span>
<span class="nc" id="L455">				}</span>
				// handle latter
<span class="nc" id="L457">			} else {</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">				if( fi.getSize()&lt;=0){</span>
<span class="nc" id="L459">					mErrorLog.logError(new SSHException(&quot;Can't copy file directory:&quot;+curDir + fi.getName()));</span>
<span class="nc" id="L460">					continue;</span>
				}
				
<span class="nc" id="L463">				InputStream is = null;</span>
<span class="nc" id="L464">				OutputStream os = null;</span>
				try {
<span class="nc" id="L466">					File localFile = new File(curDir + fi.getName());</span>
<span class="nc" id="L467">					os = ftp.storeFileStream(fi.getName());</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">					if( os!=null ){</span>
<span class="nc" id="L469">						is = new FileInputStream(localFile);</span>
<span class="nc" id="L470">						byte[] buffer = new byte[4096];</span>
						int len;
<span class="nc" id="L472">						long total = 0;</span>
<span class="nc" id="L473">						long fSize  = fi.getSize();</span>
<span class="nc" id="L474">						indicator.startFile(fi.getName(), fSize);</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">						while ((len = is.read(buffer)) &gt;= 0) {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">							if (len &gt; 0) {</span>
<span class="nc" id="L477">								os.write(buffer, 0, len);</span>
<span class="nc" id="L478">								total += len;</span>
<span class="nc" id="L479">								indicator.progress(len);</span>
							}
						}
<span class="nc" id="L482">						indicator.endFile();</span>
<span class="nc" id="L483">					}else{</span>
<span class="nc" id="L484">						mErrorLog.logError(new SSHException(ftp.getReplyString()));</span>
					}
<span class="nc" id="L486">				} catch (Exception e) {</span>
<span class="nc" id="L487">					mErrorLog.logError(e);</span>
					// TODO:
<span class="nc" id="L489">					e.printStackTrace();</span>
				} finally {
<span class="nc bnc" id="L491" title="All 2 branches missed.">					if (is != null) {</span>
						try {
<span class="nc" id="L493">							is.close();</span>
<span class="nc" id="L494">						} catch (Exception e) {</span>
<span class="nc" id="L495">						}</span>
						;
					}
<span class="nc bnc" id="L498" title="All 2 branches missed.">					if (os != null) {</span>
						try {
<span class="nc" id="L500">							os.close();</span>
<span class="nc" id="L501">						} catch (Exception e) {</span>
<span class="nc" id="L502">						}</span>
						;
					}
					try{
<span class="nc" id="L506">						ftp.completePendingCommand();</span>
<span class="nc" id="L507">					}catch(Exception e){</span>
						
<span class="nc" id="L509">					}</span>
				}
			}
			
		}
		
<span class="nc" id="L515">	}</span>

	public void putFiles(SSHSCPIndicator indicator,FileDisplay remoteDisplay, FileDisplay localDisplay,
			boolean isBinary) {
<span class="nc" id="L519">		FileListItem[] lFiles = localDisplay.getSelectedFiles();</span>
<span class="nc bnc" id="L520" title="All 4 branches missed.">		if (lFiles != null &amp;&amp; lFiles.length &gt; 0) {</span>
			try {
<span class="nc bnc" id="L522" title="All 2 branches missed.">				if (isBinary) {</span>
<span class="nc" id="L523">					ftp.setFileType(FTP.BINARY_FILE_TYPE);</span>
				} else {
<span class="nc" id="L525">					ftp.setFileType(FTP.ASCII_FILE_TYPE);</span>
				}
<span class="nc" id="L527">				String curDir = localDisplay.getFileSystemLocation();//.getFileSystemLocationLabelText();</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">				if (curDir == null)</span>
<span class="nc" id="L529">					curDir = &quot;/&quot;;</span>
				else {
<span class="nc" id="L531">					int len = curDir.length();</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">					if (curDir.charAt(len - 1) != '/'</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">							&amp;&amp; curDir.charAt(len - 1) != '\\') {</span>
<span class="nc" id="L534">						curDir += &quot;/&quot;;</span>
					}
				}
<span class="nc" id="L537">				putAllFiles(indicator,lFiles, curDir );</span>
<span class="nc" id="L538">			} catch (Exception e) {</span>
<span class="nc" id="L539">				mErrorLog.logError(e);</span>
<span class="nc" id="L540">			}</span>
			try {
<span class="nc" id="L542">				changeDirectory(this.currentPath);</span>
<span class="nc" id="L543">			} catch (Exception e) {</span>
<span class="nc" id="L544">				mErrorLog.logError(e);</span>
<span class="nc" id="L545">			}</span>

		}

<span class="nc" id="L549">	}</span>
	public void abort(){
<span class="nc" id="L551">		try{ftp.abort();}catch(Exception e){};</span>
<span class="nc" id="L552">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>