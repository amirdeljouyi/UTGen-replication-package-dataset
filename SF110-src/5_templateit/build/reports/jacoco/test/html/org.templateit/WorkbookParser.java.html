<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorkbookParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">5_templateit</a> &gt; <a href="index.source.html" class="el_package">org.templateit</a> &gt; <span class="el_source">WorkbookParser.java</span></div><h1>WorkbookParser.java</h1><pre class="source lang-java linenums">/*
 * Copyright(C) 2008-2009 Dmitriy Kumshayev. &lt;dq@mail.com&gt;
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.templateit;

import java.util.Set;

import org.apache.log4j.Logger;
import org.apache.poi.hssf.usermodel.HSSFComment;
import org.apache.poi.hssf.usermodel.HSSFRichTextString;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.hssf.util.CellRangeAddress;

class WorkbookParser
{
<span class="fc" id="L31">	private static final Logger logger = Logger.getLogger(WorkbookParser.class);</span>

	private final HSSFWorkbook workbook;
	private final TemplateWorkbook tWorkbook;

	private TemplateSheet tSheet;

	public WorkbookParser(HSSFWorkbook workbook) 
<span class="fc" id="L39">	{</span>
<span class="fc" id="L40">		this.workbook = workbook;</span>
<span class="fc" id="L41">		this.tWorkbook = new TemplateWorkbook();</span>
<span class="fc" id="L42">	}</span>
	
	public TemplateWorkbook parse()
	{
<span class="fc" id="L46">		return parse(null);</span>
	}
	public TemplateWorkbook parse(Set&lt;String&gt; excludedSheetNames)
	{
<span class="fc" id="L50">		int nSheets = workbook.getNumberOfSheets();</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">		for (int i = 0; i &lt; nSheets; i++)</span>
		{
<span class="fc" id="L53">			HSSFSheet sheet = workbook.getSheetAt(i);</span>
<span class="fc" id="L54">			String sheetName = workbook.getSheetName(i);</span>
<span class="pc bpc" id="L55" title="3 of 4 branches missed.">			if (excludedSheetNames!=null &amp;&amp; !excludedSheetNames.contains(sheetName))</span>
			{
<span class="nc" id="L57">				parseSheet(sheetName, sheet);</span>
			}
		}
<span class="fc" id="L60">		return tWorkbook;</span>
	}

	private void parseSheet(String sheetName, HSSFSheet sheet)
	{
<span class="nc" id="L65">		logger.debug(&quot;Parsing &lt;&quot; + sheetName + &quot;&gt;&quot;);</span>
<span class="nc" id="L66">		tSheet = tWorkbook.createTemplateSheet(sheetName,sheet);</span>

<span class="nc" id="L68">		int lastRow = sheet.getLastRowNum();</span>
<span class="nc" id="L69">		StaticTemplate template = null;</span>

<span class="nc bnc" id="L71" title="All 2 branches missed.">		for (int r = 0; r &lt;= lastRow; r++)</span>
		{
<span class="nc" id="L73">			HSSFRow row = sheet.getRow(r);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">			if (row != null)</span>
			{
<span class="nc" id="L76">				tSheet.setLastColumn(Math.max(row.getLastCellNum(), tSheet</span>
<span class="nc" id="L77">						.getLastColumn()));</span>
				// POI does not provide a way to walk through 
				// all available cell comments, so we reserve
				// first 20 columns 
<span class="nc" id="L81">				int lastColumn = Math.max(tSheet.getLastColumn(), 20);</span>

<span class="nc bnc" id="L83" title="All 2 branches missed.">				for (int c = 0; c &lt;= lastColumn; c++)</span>
				{
<span class="nc" id="L85">					boolean templateEndFound = false;</span>
<span class="nc" id="L86">					HSSFComment cellComment = sheet.getCellComment(r, c);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">					if (cellComment != null)</span>
					{
<span class="nc" id="L89">						HSSFRichTextString hstring = cellComment.getString();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">						if (hstring != null)</span>
						{
<span class="nc" id="L92">							String comm = hstring.toString();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">							if (comm != null)</span>
							{
<span class="nc bnc" id="L95" title="All 2 branches missed.">								if (logger.isTraceEnabled())</span>
								{
<span class="nc" id="L97">									String ct = comm.replace('\n', ' ').trim();</span>
<span class="nc" id="L98">									logger.trace(&quot;comment @(&quot; + r + &quot;,&quot; + c + &quot;): '&quot; + ct + &quot;'&quot;);</span>
								}
<span class="nc" id="L100">								String[] names = null;</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">								if ((names = OpMatcher.matchTemplateBegin(comm)) != null)</span>
								{
<span class="nc bnc" id="L103" title="All 2 branches missed.">									if (logger.isTraceEnabled())</span>
									{
<span class="nc" id="L105">										logger.trace(&quot;@template_begin @(&quot; + r + &quot;,&quot; + c + &quot;)&quot;);</span>
									}
<span class="nc" id="L107">									template = tSheet.createTemplate(r, c, names);</span>
								}

<span class="nc bnc" id="L110" title="All 2 branches missed.">								if (OpMatcher.matchTemplateEnd(comm))</span>
								{
<span class="nc bnc" id="L112" title="All 2 branches missed.">									if (logger.isTraceEnabled())</span>
									{
<span class="nc" id="L114">										logger.trace(&quot;@template_end @(&quot; + r + &quot;,&quot; + c + &quot;)&quot;);</span>
									}
<span class="nc bnc" id="L116" title="All 2 branches missed.">									if( template != null )</span>
									{
<span class="nc" id="L118">										template.setEndReference(new Reference(r, c));</span>
									}
									else
									{
<span class="nc" id="L122">										logger.warn(&quot;@template_end without @template_begin&quot;);</span>
									}
<span class="nc" id="L124">									templateEndFound = true;</span>
								}

<span class="nc" id="L127">								String paramName = OpMatcher.matchTemplateParameter(comm);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">								if (paramName != null )</span>
								{
<span class="nc bnc" id="L130" title="All 2 branches missed.">									if( template != null )</span>
									{
<span class="nc" id="L132">										int relRow = r-template.start().row();			</span>
<span class="nc" id="L133">										int relCol = c-template.start().column();			</span>
<span class="nc" id="L134">										template.createParameter(paramName, relRow, relCol);</span>
<span class="nc" id="L135">									}</span>
									else
									{
<span class="nc" id="L138">										logger.warn(&quot;Cannot create parameter '&quot;+paramName+&quot;'&quot;);</span>
									}
								}
								
<span class="nc" id="L142">								NamedStyle style = OpMatcher.matchStyle(comm);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">								if( style != null )</span>
								{
<span class="nc" id="L145">									style.setRow(r);</span>
<span class="nc" id="L146">									style.setColumn(c);</span>
<span class="nc" id="L147">									tSheet.addStyle(style);</span>
								}
							}

<span class="nc bnc" id="L151" title="All 2 branches missed.">							if( templateEndFound )</span>
							{
								// reset template
<span class="nc" id="L154">								template = null;</span>
							}
						}
					}
				}
			}
		}

<span class="nc" id="L162">		processMergeRegions(sheet);</span>
<span class="nc" id="L163">	}</span>

	private void processMergeRegions(HSSFSheet sheet)
	{
		// identify MergeRegions and assign them to corresponding template sections
<span class="nc" id="L168">		int numMergedRegions = sheet.getNumMergedRegions();</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">		for (int i = 0; i &lt; numMergedRegions; i++)</span>
		{
<span class="nc" id="L171">			CellRangeAddress mr = sheet.getMergedRegion(i);</span>
<span class="nc" id="L172">			Reference start = new Reference(mr.getFirstRow(), mr.getFirstColumn());</span>
<span class="nc" id="L173">			Reference end = new Reference(mr.getLastRow(), mr.getLastColumn());</span>
<span class="nc" id="L174">			MergeRegion mreg = new MergeRegion(start, end);</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">			if (logger.isTraceEnabled())</span>
			{
<span class="nc" id="L177">				logger.trace(&quot;Merge region @(&quot; + mreg + &quot;)&quot;);</span>
			}

<span class="nc bnc" id="L180" title="All 2 branches missed.">			for (StaticTemplate template : tSheet.templates())</span>
			{
<span class="nc bnc" id="L182" title="All 2 branches missed.">				if (mreg.contains(template.end()))</span>
				{
<span class="nc" id="L184">					template.setEndReference(mreg.end());</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">					if (logger.isTraceEnabled())</span>
					{
<span class="nc" id="L188">						logger.trace(&quot;Template &quot; + template.getName() + &quot; extended to (&quot;</span>
								+ template + &quot;)&quot;);
					}
				}

<span class="nc bnc" id="L193" title="All 2 branches missed.">				if (template.contains(mreg))</span>
				{
<span class="nc" id="L195">					template.addMergeRegion(mreg);</span>
				}
<span class="nc" id="L197">			}</span>
		}
<span class="nc" id="L199">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>