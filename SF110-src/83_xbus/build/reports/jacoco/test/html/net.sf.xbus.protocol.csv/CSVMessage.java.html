<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CSVMessage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.protocol.csv</a> &gt; <span class="el_source">CSVMessage.java</span></div><h1>CSVMessage.java</h1><pre class="source lang-java linenums">/*
 * Created on 28.09.2004
 */
package net.sf.xbus.protocol.csv;

import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.xbussystem.XBUSSystem;
import net.sf.xbus.protocol.TextMessage;
import net.sf.xbus.protocol.XMLMessage;
import net.sf.xbus.protocol.xml.XMLMessageAbstract;

import org.w3c.dom.Document;

/**
 * &lt;code&gt;CSVMessage&lt;/code&gt; is helping the xBus transporting and converting
 * data structured in CSV format
 * &lt;p&gt;
 * As CSV is not a standardized, the authors have decided to base the
 * implementation on an existing definition (@see &lt;a
 * href=&quot;http://www.edoceo.com/utilis/csv-file-format.php&quot;&gt; -&amp;gt; CSV Definition&lt;/a&gt;).
 * &lt;/p&gt;
 * &lt;p&gt;
 * The entries are internally stored in a DOM tree. Thus &lt;code&gt;CSVMessage&lt;/code&gt;
 * extends {@link net.sf.xbus.protocol.xml.XMLMessageAbstract} to use some of
 * its xml features.
 * &lt;/p&gt;
 * 
 * @author Duewel, Kooppl
 */
public class CSVMessage extends XMLMessageAbstract
		implements
			TextMessage,
			XMLMessage
{

	private XBUSSystem mResponseSystem;

	/**
	 * This constructor stores the &lt;code&gt;source&lt;/code&gt;, creates an unique
	 * identifier for the message and initializes the requestTimestamp. It is
	 * used when constructing a new &lt;code&gt;CSVMessage&lt;/code&gt; from the data of a
	 * receiver.
	 * 
	 * @param source the source of the data
	 */
	public CSVMessage(XBUSSystem source)
	{
<span class="nc" id="L49">		super(source);</span>
<span class="nc" id="L50">		setShortname(&quot;CSVMessage&quot;);</span>
<span class="nc" id="L51">	} // CSVMessage(XBUSSystem source)</span>

	/**
	 * This constructor initializes the new &lt;code&gt;CSVMessage&lt;/code&gt; with the
	 * given parameters. It is used when constructing a new
	 * &lt;code&gt;CSVMessage&lt;/code&gt; by converting it from another
	 * {@link net.sf.xbus.protocol.Message Message}.
	 * 
	 * @param function the function to be executed by the destination system
	 * @param source the source of the data
	 * @param id the message id
	 */
	public CSVMessage(String function, XBUSSystem source, String id)
	{
<span class="nc" id="L65">		super(function, source, id);</span>
<span class="nc" id="L66">		setShortname(&quot;CSVMessage&quot;);</span>
<span class="nc" id="L67">	} // CSVMessage(String function, XBUSSystem source, String id)</span>

	/**
	 * Returns the request text as String.
	 * 
	 * @param system the name of the process
	 * @return the request text in String format.
	 */
	public String getRequestText(XBUSSystem system) throws XException
	{
<span class="nc" id="L77">		Document doc = getRequestDocument(system);</span>
<span class="nc" id="L78">		String result = null;</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">		if (doc != null)</span>
<span class="nc" id="L80">			result = serializeRecords(doc, system);</span>
<span class="nc" id="L81">		return result;</span>
	} // getRequestText()

	public void setRequestText(String text, XBUSSystem source)
			throws XException
	{
<span class="nc" id="L87">		Document doc = parseRecords(text, getSource().getName());</span>
<span class="nc" id="L88">		setRequestDocument(doc, source);</span>
<span class="nc" id="L89">	}</span>

	/**
	 * Returns the response text as String.
	 * 
	 * @return the response text as String
	 */
	public String getResponseText() throws XException
	{
<span class="nc" id="L98">		Document doc = getResponseDocument();</span>
<span class="nc" id="L99">		String response = null;</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">		if (doc != null &amp;&amp; mResponseSystem != null)</span>
<span class="nc" id="L101">			response = serializeRecords(doc, mResponseSystem);</span>
<span class="nc" id="L102">		return response;</span>
	} // getResponseText()

	/**
	 * Sets the response data
	 * 
	 * @param text the new response text as String
	 * @param destination the destination process
	 * @throws XException
	 */
	public void setResponseText(String text, XBUSSystem destination)
			throws XException
	{
<span class="nc" id="L115">		setReturncode(Constants.RC_OK);</span>
<span class="nc" id="L116">		setErrorcode(0);</span>
<span class="nc" id="L117">		setErrortext(null);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (text == null)</span>
<span class="nc" id="L119">			setResponseDocument(null, destination);</span>
		else
<span class="nc" id="L121">			setResponseDocument(parseRecords(text, destination.getName()),</span>
					destination);
<span class="nc" id="L123">	} // setResponseText(String text)</span>

	/**
	 * Sets the response data by passing a DOM tree
	 * 
	 * @param doc the DOM tree
	 * @param destination the destination process
	 * @throws XException
	 */
	public void setResponseDocument(Document doc, XBUSSystem destination)
			throws XException
	{
<span class="nc" id="L135">		mResponseSystem = destination;</span>

<span class="nc" id="L137">		super.setResponseDocument(doc, destination);</span>
<span class="nc" id="L138">	} // setResponseDocument(Document doc, XBUSSystem destination)</span>

	/**
	 * Parses the Records from CSV format into the internal DOM tree
	 * 
	 * @param text the text which has to be parsed
	 * @return the parsed records as DOM tree
	 */
	private Document parseRecords(String text, String systemName)
			throws XException
	{
<span class="nc" id="L149">		CSVParser parser = CSVParser.getInstance(systemName);</span>
<span class="nc" id="L150">		return parser.parse(text, systemName);</span>
	} // parseRecords(String text)

	/**
	 * Serializes the Records from DOM format into CSV format
	 * 
	 * @param doc the DOM tree which is serialized
	 * @param system the process name
	 * @return the serialized data in CSV format
	 */
	private String serializeRecords(Document doc, XBUSSystem system)
			throws XException
	{
<span class="nc" id="L163">		String records = null;</span>
		// for the result
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (doc != null)</span>
		{ // There is a document to serialize.
			String sourceType;

			// the interface file type
<span class="nc bnc" id="L170" title="All 2 branches missed.">			if (system != null)</span>
<span class="nc" id="L171">				sourceType = system.getName();</span>
			else
<span class="nc" id="L173">				sourceType = doc.getDocumentElement().getNodeName();</span>

			// Get a serializer object
<span class="nc" id="L176">			CSVSerializer csvSerializer = CSVSerializer.getInstance(sourceType);</span>
			// Serializer is initialized, so let's go.
<span class="nc" id="L178">			records = csvSerializer.serialize(doc);</span>
		} // if (doc != null)
<span class="nc" id="L180">		return records;</span>
	} // serializeRecords(Document doc, XBUSSystem system)

	/**
	 * Empty method.
	 */
	protected void synchronizeRequestFields(XBUSSystem system)
	{
		/*
		 * do nothing
		 */
<span class="nc" id="L191">	} // synchronizeRequestFields()</span>

	/**
	 * Empty method.
	 */
	protected void synchronizeResponseFields(XBUSSystem system)
	{
<span class="nc" id="L198">		setReturncode(Constants.RC_OK);</span>
<span class="nc" id="L199">	} // synchronizeResponseFields()</span>

} // CSVMessage
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>