<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleFileSender.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.technical.file</a> &gt; <span class="el_source">SimpleFileSender.java</span></div><h1>SimpleFileSender.java</h1><pre class="source lang-java linenums">package net.sf.xbus.technical.file;

import java.io.BufferedOutputStream;
import java.io.BufferedWriter;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.util.List;
import java.util.Vector;

import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.xbussystem.XBUSSystem;
import net.sf.xbus.technical.Sender;
import net.sf.xbus.technical.TextSender;

public class SimpleFileSender extends FileBase implements Sender, TextSender
{
<span class="nc" id="L20">	protected FileSenderConfiguration mConfiguration = null;</span>

	/**
	 * Constructs a FileSender object giving all necessary data from the
	 * standard configuration, checking file permissions and registering current
	 * resource by the {@link net.sf.xbus.base.core.TAManager}.
	 * 
	 * @exception XException if any error occurs
	 */
	public SimpleFileSender(XBUSSystem system) throws XException
<span class="nc" id="L30">	{</span>
<span class="nc" id="L31">		mConfiguration = new FileSenderConfiguration(system);</span>
<span class="nc" id="L32">		checkFilePermissions();</span>
<span class="nc" id="L33">	}</span>

	public String execute(String function, String callData) throws XException
	{
<span class="nc" id="L37">		BufferedWriter buffOut = prepareWriter();</span>

<span class="nc bnc" id="L39" title="All 2 branches missed.">		if (callData == null)</span>
		{
<span class="nc" id="L41">			callData = &quot;&quot;;</span>
		}

		// write callData into the file.
		// Characters written to it are translated into bytes
		// according to a specified character encoding.
		try
		{
<span class="nc" id="L49">			buffOut.write(callData);</span>
			// Writing an end of file sign on Unix systems
<span class="nc bnc" id="L51" title="All 2 branches missed.">			if (Constants.LINE_SEPERATOR.equals(&quot;\n&quot;)</span>
<span class="nc bnc" id="L52" title="All 4 branches missed.">					&amp;&amp; (callData.length() == 0 || callData.charAt(callData</span>
<span class="nc" id="L53">							.length() - 1) != '\n'))</span>
<span class="nc" id="L54">				buffOut.newLine();</span>
<span class="nc" id="L55">			buffOut.close();</span>
		}
<span class="nc" id="L57">		catch (IOException e)</span>
		{
<span class="nc" id="L59">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_FILE, &quot;0&quot;, e);
<span class="nc" id="L62">		}</span>
<span class="nc" id="L63">		return null;</span>
	}

	protected BufferedWriter prepareWriter() throws XException
	{
<span class="nc" id="L68">		prepareWriteFile();</span>
		BufferedWriter buffOut;
		try
		{
<span class="nc" id="L72">			buffOut = new BufferedWriter(</span>
					new OutputStreamWriter(new FileOutputStream(mConfiguration
<span class="nc" id="L74">							.getFileNames()[0], true), mConfiguration</span>
<span class="nc" id="L75">							.getEncoding()));</span>
		}
<span class="nc" id="L77">		catch (Exception e)</span>
		{
<span class="nc" id="L79">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_FILE, &quot;0&quot;, e);
<span class="nc" id="L82">		}</span>
<span class="nc" id="L83">		return buffOut;</span>
	}

	protected void prepareWriteFile() throws XException
	{
<span class="nc bnc" id="L88" title="All 2 branches missed.">		if (new File(mConfiguration.getFileNames()[0]).exists())</span>
		{
<span class="nc" id="L90">			if (mConfiguration.getResolution()</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">					.equals(Constants.WRITE_OVERWRITE))</span>
			{
<span class="nc" id="L93">				deleteFile(mConfiguration.getFileNames()[0]);</span>
			}

<span class="nc bnc" id="L96" title="All 2 branches missed.">			if (mConfiguration.getResolution().equals(Constants.WRITE_APPEND))</span>
			{
<span class="nc bnc" id="L98" title="All 2 branches missed.">				if (getFileLength(mConfiguration.getFileNames()[0]) &gt; 0</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">						&amp;&amp; getLastByteOfFile(mConfiguration.getFileNames()[0]) != 10)</span>
				{
					try
					{
<span class="nc" id="L103">						BufferedOutputStream buffOut = new BufferedOutputStream(</span>
								new FileOutputStream(mConfiguration
<span class="nc" id="L105">										.getFileNames()[0], true));</span>
<span class="nc" id="L106">						buffOut.write(Constants.LINE_SEPERATOR</span>
<span class="nc" id="L107">								.getBytes(mConfiguration.getEncoding()));</span>
<span class="nc" id="L108">						buffOut.close();</span>
					}
<span class="nc" id="L110">					catch (Exception e)</span>
					{
<span class="nc" id="L112">						throw new XException(Constants.LOCATION_EXTERN,</span>
								Constants.LAYER_TECHNICAL,
								Constants.PACKAGE_TECHNICAL_FILE, &quot;0&quot;, e);
<span class="nc" id="L115">					}</span>
				}
			}
		}
<span class="nc" id="L119">	}</span>

	/**
	 * On the basis of the ConflictResolution (resolved action when the file
	 * already exists) having read from the standard configuration, checks this
	 * method a file on an opportunity to meet the requirements
	 * &lt;p&gt;
	 * &lt;table border&gt;
	 * &lt;tr&gt;
	 * &lt;th&gt;Resolution&lt;/th&gt;
	 * &lt;th&gt;Requirements&lt;/th&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;Error&lt;/td&gt;
	 * &lt;td&gt;the physical file can not be exist&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;Overwrite Append&lt;/td&gt;
	 * &lt;td&gt;1. the file is a normal file (not a directory) &lt;br&gt;
	 * 2. the application can modify this file&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;/table border&gt;
	 * 
	 * @param config Instanze of the configuration
	 * @param system Sytem name which file resoltion must be read.
	 * @return true if the file meets the requirements of ConflictResolution,
	 *         otherwise false
	 * @exception XException if any errors occurs
	 */

	private void checkFilePermissions() throws XException
	{
<span class="nc" id="L151">		String fileName = mConfiguration.getFileNames()[0];</span>
<span class="nc" id="L152">		File srcFile = new File(fileName);</span>
		// constructing the file object doesn't create a file on disk!

<span class="nc bnc" id="L155" title="All 2 branches missed.">		if (srcFile.exists())</span>
		{
			// 1.check if resolution = error
<span class="nc bnc" id="L158" title="All 2 branches missed.">			if (mConfiguration.getResolution().equals(Constants.WRITE_ERROR))</span>
			{
<span class="nc" id="L160">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_FILE, &quot;29&quot;);
			}

			// 2. check if it is one file
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if (!srcFile.isFile())</span>
			{
<span class="nc" id="L168">				List params = new Vector();</span>
<span class="nc" id="L169">				params.add(mConfiguration.getFileNames());</span>
<span class="nc" id="L170">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_FILE, &quot;30&quot;, params);
			}

			// 3. check write permissions
<span class="nc bnc" id="L176" title="All 2 branches missed.">			if (!srcFile.canWrite())</span>
			{
<span class="nc" id="L178">				List params = new Vector();</span>
<span class="nc" id="L179">				params.add(fileName);</span>
<span class="nc" id="L180">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_FILE, &quot;31&quot;, params);
			}
		}
<span class="nc" id="L185">	}</span>

	public String getType()
	{
<span class="nc" id="L189">		return Constants.TYPE_TEXT;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>