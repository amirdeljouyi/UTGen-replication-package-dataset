<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DBJournal.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.base.journal</a> &gt; <span class="el_source">DBJournal.java</span></div><h1>DBJournal.java</h1><pre class="source lang-java linenums">package net.sf.xbus.base.journal;

import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.core.trace.Trace;
import net.sf.xbus.base.xbussystem.XBUSSystem;
import net.sf.xbus.protocol.Message;
import net.sf.xbus.technical.database.DBConnection;

/**
 * &lt;code&gt;DBJournal&lt;/code&gt; writes information about the activities of the
 * middleware into the database.
 * &lt;p&gt;
 * 
 * The information is stored in the database-table &lt;code&gt;journal&lt;/code&gt;. An
 * instance of {@link net.sf.xbus.technical.database.DBConnection} is used for
 * handling the database-connection.
 */
<span class="nc" id="L19">public class DBJournal implements JournalInterface</span>
{
	private static final String INSERT_JOURNAL = &quot;InsertJournal&quot;;
	
<span class="nc" id="L23">	private DBConnection mDBConnection = null;</span>

	/**
	 * Writes a middleware-activity to the database. An activity can be:
	 * &lt;ul&gt;
	 * &lt;li&gt;A message has been received and processed.&lt;/li&gt;
	 * &lt;li&gt;A message has been send to a neighbor-system.&lt;/li&gt;
	 * &lt;/ul&gt;
	 * &lt;p&gt;
	 * The {@link net.sf.xbus.base.core.config.Configuration} stores, which
	 * activities are written. All other activities are ignored.
	 * &lt;p&gt;
	 * 
	 * @param type &lt;b&gt;R&lt;/b&gt;: message has been received, &lt;b&gt;S&lt;/b&gt;: message has
	 *            been send
	 * @param system The name of the system, from which the message has been
	 *            received or where the message has been sent to.
	 * @param message The {@link Message}-object that represents the data of
	 *            the message.
	 * 
	 */
	public void log(char type, XBUSSystem system, Message message)
			throws XException
	{
<span class="nc" id="L47">		writeToDB(type, system, message, false);</span>
<span class="nc" id="L48">	}</span>

	/**
	 * Commits the database.
	 */
	public void commit() throws XException
	{
<span class="nc bnc" id="L55" title="All 2 branches missed.">		if (mDBConnection != null)</span>
		{
<span class="nc" id="L57">			mDBConnection.commit();</span>
		}
<span class="nc" id="L59">	}</span>

	/**
	 * Does the writing to the database.
	 */
	private void writeToDB(char type, XBUSSystem system, Message message,
			boolean retry) throws XException
	{
<span class="nc" id="L67">		String requestMessage = Journal.formatText(message, system, true);</span>
<span class="nc" id="L68">		String responseMessage = Journal.formatText(message, system, false);</span>

<span class="nc" id="L70">		String requestTimestamp = Journal.formatDate(message</span>
<span class="nc" id="L71">				.getRequestTimestamp());</span>
<span class="nc" id="L72">		String responseTimestamp = Journal.formatDate(message</span>
<span class="nc" id="L73">				.getResponseTimestamp());</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">		if (mDBConnection == null)</span>
		{
<span class="nc" id="L77">			String dbConnectionName = Configuration.getInstance()</span>
<span class="nc" id="L78">					.getValueOptional(&quot;Base&quot;, &quot;Journal&quot;, &quot;DBConnection&quot;);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">			if (dbConnectionName == null)</span>
			{
<span class="nc" id="L81">				dbConnectionName = DBConnection.UNNAMED;</span>
			}
<span class="nc" id="L83">			mDBConnection = DBConnection.getInstance(dbConnectionName);</span>
		}

<span class="nc" id="L86">		String statementName = getStatementName();</span>

		try
		{
<span class="nc bnc" id="L90" title="All 2 branches missed.">			if (!mDBConnection.existsPrepared(statementName))</span>
			{
<span class="nc" id="L92">				mDBConnection.prepareStatement(statementName,</span>
<span class="nc" id="L93">						new StringBuffer().append(&quot;INSERT INTO journal (&quot;)</span>
<span class="nc" id="L94">								.append(&quot;jo_type, &quot;).append(&quot;jo_system, &quot;)</span>
<span class="nc" id="L95">								.append(&quot;jo_function, &quot;).append(</span>
<span class="nc" id="L96">										&quot;jo_message_id, &quot;).append(</span>
<span class="nc" id="L97">										&quot;jo_request_message, &quot;).append(</span>
<span class="nc" id="L98">										&quot;jo_request_timestamp, &quot;).append(</span>
<span class="nc" id="L99">										&quot;jo_response_message, &quot;).append(</span>
<span class="nc" id="L100">										&quot;jo_response_timestamp, &quot;).append(</span>
<span class="nc" id="L101">										&quot;jo_returncode,	&quot;).append(</span>
<span class="nc" id="L102">										&quot;jo_errorcode, &quot;).append(</span>
<span class="nc" id="L103">										&quot;jo_errormessage&quot;).append(&quot;) VALUES (&quot;)</span>
<span class="nc" id="L104">								.append(&quot;?,?,?,?,?,?,?,?,?,?,?)&quot;).toString());</span>
			}

<span class="nc" id="L107">			mDBConnection.bind(statementName, 1, (new Character(type))</span>
<span class="nc" id="L108">					.toString());</span>
<span class="nc" id="L109">			mDBConnection.bind(statementName, 2, system.getCompleteName());</span>
<span class="nc" id="L110">			mDBConnection.bind(statementName, 3, message.getFunction());</span>
<span class="nc" id="L111">			mDBConnection.bind(statementName, 4, message.getId());</span>
<span class="nc" id="L112">			mDBConnection.bind(statementName, 5, requestMessage);</span>
<span class="nc" id="L113">			mDBConnection.bind(statementName, 6, requestTimestamp);</span>
<span class="nc" id="L114">			mDBConnection.bind(statementName, 7, responseMessage);</span>
<span class="nc" id="L115">			mDBConnection.bind(statementName, 8, responseTimestamp);</span>
<span class="nc" id="L116">			mDBConnection.bind(statementName, 9, message.getReturncode());</span>
<span class="nc" id="L117">			mDBConnection.bind(statementName, 10, message.getErrorcode());</span>
<span class="nc" id="L118">			mDBConnection.bind(statementName, 11, message.getErrortext());</span>

<span class="nc" id="L120">			mDBConnection.executeUpdatePrepared(statementName);</span>
		}
<span class="nc" id="L122">		catch (XException e)</span>
		{
<span class="nc bnc" id="L124" title="All 2 branches missed.">			if (!retry)</span>
			{
<span class="nc" id="L126">				Trace.warn(&quot;DBConnection maybe gone, trying again&quot;);</span>
<span class="nc" id="L127">				mDBConnection.reopen();</span>
<span class="nc" id="L128">				writeToDB(type, system, message, true);</span>
			}
<span class="nc" id="L130">		}</span>
<span class="nc" id="L131">	}</span>

	private String getStatementName()
	{
<span class="nc" id="L135">		return new StringBuffer(INSERT_JOURNAL).append(</span>
<span class="nc" id="L136">				Thread.currentThread().getName()).toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>