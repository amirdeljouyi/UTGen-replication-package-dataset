<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.protocol</a> &gt; <span class="el_source">MessageFactory.java</span></div><h1>MessageFactory.java</h1><pre class="source lang-java linenums">package net.sf.xbus.protocol;

import java.util.List;
import java.util.Vector;

import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.core.reflection.ReflectionSupport;
import net.sf.xbus.base.xbussystem.XBUSSystem;

import org.w3c.dom.Document;

/**
 * The class &lt;code&gt;MessageFactory&lt;/code&gt; is used to dynamically create
 * messages. It implements the &lt;b&gt;Factory &lt;/b&gt; Design-Pattern.
 * &lt;p&gt;
 */
<span class="nc" id="L19">public class MessageFactory</span>
{
	public static final int TRANSFORM_FROM_REQUEST = 0;

	public static final int TRANSFORM_FROM_RESPONSE = 1;

	/**
	 * The appropriate &lt;code&gt;Message&lt;/code&gt; -object for the given source will
	 * be created. The name of the appropriate &lt;code&gt;Message&lt;/code&gt; class is
	 * read from the {@link net.sf.xbus.base.core.config.Configuration}.
	 * 
	 * @param source the name of the system, from which the message was received
	 */
	public static Message createApplicationMessage(XBUSSystem source)
			throws XException
	{
<span class="nc" id="L35">		Configuration config = Configuration.getInstance();</span>

<span class="nc" id="L37">		String messageClassShortname = config.getValue(</span>
<span class="nc" id="L38">				Constants.CHAPTER_SYSTEM, source.getName(), &quot;Message&quot;);</span>

<span class="nc" id="L40">		String messageClass = Configuration.getClass(&quot;Message&quot;,</span>
				messageClassShortname);

<span class="nc" id="L43">		Class[] conArgsClass = new Class[]</span>
		{ReflectionSupport
<span class="nc" id="L45">				.classForName(&quot;net.sf.xbus.base.xbussystem.XBUSSystem&quot;)};</span>
<span class="nc" id="L46">		Object[] conArgs = new Object[]</span>
		{source};

<span class="nc" id="L49">		return (Message) ReflectionSupport.createObject(messageClass,</span>
				conArgsClass, conArgs);
	}

	/**
	 * Transforms the response of a source message to the response of a
	 * destination message.
	 * 
	 * @param source the system name where the response of the source message is
	 *            coming from
	 * @param destination the system name where the response of the destination
	 *            message shall be sent to
	 * @param sourceMessage the &lt;code&gt;Message&lt;/code&gt; from which the response
	 *            to transform is taken.
	 * @param destinationMessage the &lt;code&gt;Message&lt;/code&gt; whose response is
	 *            filled
	 */
	static public void transformResponse2Response(XBUSSystem source,
			XBUSSystem destination, Message sourceMessage,
			Message destinationMessage) throws XException
	{
<span class="nc" id="L70">		String receiverType = Configuration.getInstance().getValueOptional(</span>
<span class="nc" id="L71">				&quot;TransformInput&quot;, source.getName(), destination.getName());</span>

<span class="nc bnc" id="L73" title="All 2 branches missed.">		if (receiverType == null)</span>
		{
<span class="nc bnc" id="L75" title="All 2 branches missed.">			if (sourceMessage instanceof XMLMessage)</span>
			{
<span class="nc" id="L77">				receiverType = Constants.TYPE_XML;</span>
			}
<span class="nc bnc" id="L79" title="All 2 branches missed.">			else if (sourceMessage instanceof ObjectMessage)</span>
			{
<span class="nc" id="L81">				receiverType = Constants.TYPE_OBJECT;</span>
			}
<span class="nc bnc" id="L83" title="All 2 branches missed.">			else if (sourceMessage instanceof TextMessage)</span>
			{
<span class="nc" id="L85">				receiverType = Constants.TYPE_TEXT;</span>
			}
			else
			{
<span class="nc" id="L89">				List params = new Vector(1);</span>
<span class="nc" id="L90">				params.add(sourceMessage.getShortname());</span>
<span class="nc" id="L91">				throw new XException(Constants.LOCATION_INTERN,</span>
						Constants.LAYER_PROTOCOL,
						Constants.PACKAGE_PROTOCOL_PROTOCOL, &quot;9&quot;, params);
			}
		} // if (receiverType==null) - no specific type declared for system

<span class="nc" id="L97">		Object input = null;</span>
<span class="nc" id="L98">		Object output = null;</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">		if (receiverType.equals(Constants.TYPE_XML))</span>
		{
<span class="nc" id="L102">			input = ((XMLMessage) sourceMessage).getResponseDocument();</span>
		}
<span class="nc bnc" id="L104" title="All 2 branches missed.">		else if (receiverType.equals(Constants.TYPE_OBJECT))</span>
		{
			// the message content is serialised due to the structure
			// description attached to the source system
<span class="nc" id="L108">			input = ((ObjectMessage) sourceMessage).getResponseObject();</span>
		}
		else
		{
			// the message content is serialised due to the structure
			// description attached to the source system
<span class="nc" id="L114">			input = ((TextMessage) sourceMessage).getResponseText();</span>
		}

<span class="nc" id="L117">		Transformer transformer = TransformerFactory.createTransformer(source,</span>
				destination, sourceMessage, destinationMessage);

<span class="nc" id="L120">		output = transformer.transform(input, source, destination,</span>
				destinationMessage);

		// The transformation result is a string.
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (output instanceof String)</span>
		{
<span class="nc" id="L126">			((TextMessage) destinationMessage).setResponseText((String) output,</span>
					destination);
		} // then (output.getClass().getName().equals(&quot;java.lang.String&quot;))
<span class="nc bnc" id="L129" title="All 2 branches missed.">		else if (output instanceof Document)</span>
		{ // The transformation result is a DOM tree.
<span class="nc" id="L131">			((XMLMessage) destinationMessage).setResponseDocument(</span>
					(Document) output, destination);
		} // then (doc.isInstance(output))
		else
		{ // The transformation result is anything else than a string or a
			// DOM tree.
<span class="nc" id="L137">			((ObjectMessage) destinationMessage).setResponseObject(output,</span>
					destination);
		} // else (output.getClass().getName().equals(&quot;java.lang.String&quot;))
<span class="nc" id="L140">	}</span>

	/**
	 * The appropriate &lt;code&gt;Message&lt;/code&gt; object which is needed to send a
	 * message to the given destination will be created. At this point either
	 * the request or the response of the incoming &lt;code&gt;Message&lt;/code&gt; will
	 * be converted to the request of the outgoing &lt;code&gt;Message&lt;/code&gt;.
	 * 
	 * @param destination the name of the system where the message will be send
	 *            to
	 * @param sourceMessage the &lt;code&gt;Message&lt;/code&gt; from which the new
	 *            &lt;code&gt;Message&lt;/code&gt; will be initialized
	 * @param convertFrom flag wether the request or the response of the
	 *            sourceMessage is used to fill the request of the new
	 *            &lt;code&gt;Message&lt;/code&gt;
	 */
	public static Message createSenderMessage(XBUSSystem destination,
			Message sourceMessage, int convertFrom) throws XException
	{
<span class="nc bnc" id="L159" title="All 4 branches missed.">		if ((convertFrom != TRANSFORM_FROM_REQUEST)</span>
				&amp;&amp; (convertFrom != TRANSFORM_FROM_RESPONSE))
		{
<span class="nc" id="L162">			List params = new Vector();</span>
<span class="nc" id="L163">			params.add(String.valueOf(convertFrom));</span>
<span class="nc" id="L164">			throw new XException(Constants.LOCATION_INTERN,</span>
					Constants.LAYER_PROTOCOL,
					Constants.PACKAGE_PROTOCOL_PROTOCOL, &quot;7&quot;, params);
		}

<span class="nc" id="L169">		Message destinationMessage = createMessage(sourceMessage, destination);</span>

<span class="nc" id="L171">		XBUSSystem source = sourceMessage.getSource();</span>

<span class="nc" id="L173">		String receiverType = Configuration.getInstance().getValueOptional(</span>
<span class="nc" id="L174">				&quot;TransformInput&quot;, source.getName(), destination.getName());</span>

<span class="nc bnc" id="L176" title="All 2 branches missed.">		if (receiverType == null)</span>
		{
<span class="nc bnc" id="L178" title="All 2 branches missed.">			if (sourceMessage instanceof XMLMessage)</span>
			{
<span class="nc" id="L180">				receiverType = Constants.TYPE_XML;</span>
			}
<span class="nc bnc" id="L182" title="All 2 branches missed.">			else if (sourceMessage instanceof ObjectMessage)</span>
			{
<span class="nc" id="L184">				receiverType = Constants.TYPE_OBJECT;</span>
			}
<span class="nc bnc" id="L186" title="All 2 branches missed.">			else if (sourceMessage instanceof TextMessage)</span>
			{
<span class="nc" id="L188">				receiverType = Constants.TYPE_TEXT;</span>
			}
			else
			{
<span class="nc" id="L192">				List params = new Vector(1);</span>
<span class="nc" id="L193">				params.add(sourceMessage.getShortname());</span>
<span class="nc" id="L194">				throw new XException(Constants.LOCATION_INTERN,</span>
						Constants.LAYER_PROTOCOL,
						Constants.PACKAGE_PROTOCOL_PROTOCOL, &quot;9&quot;, params);
			}
		} // if (receiverType==null) - no specific type declared for system

<span class="nc" id="L200">		Object input = null;</span>
<span class="nc" id="L201">		Object output = null;</span>

<span class="nc bnc" id="L203" title="All 3 branches missed.">		switch (convertFrom)</span>
		{
			case TRANSFORM_FROM_REQUEST :
<span class="nc bnc" id="L206" title="All 2 branches missed.">				if (receiverType.equals(Constants.TYPE_XML))</span>
				{
<span class="nc" id="L208">					input = ((XMLMessage) sourceMessage)</span>
<span class="nc" id="L209">							.getRequestDocument(source);</span>
				}
<span class="nc bnc" id="L211" title="All 2 branches missed.">				else if (receiverType.equals(Constants.TYPE_OBJECT))</span>
				{
					// the message content is serialised due to the structure
					// description attached to the source system
<span class="nc" id="L215">					input = ((ObjectMessage) sourceMessage)</span>
<span class="nc" id="L216">							.getRequestObject(source);</span>
				}
<span class="nc bnc" id="L218" title="All 2 branches missed.">				else if (receiverType.equals(Constants.TYPE_TEXT))</span>
				{
					// the message content is serialised due to the structure
					// description attached to the source system
<span class="nc" id="L222">					input = ((TextMessage) sourceMessage)</span>
<span class="nc" id="L223">							.getRequestText(source);</span>
				}
				break;
			case TRANSFORM_FROM_RESPONSE :
<span class="nc bnc" id="L227" title="All 2 branches missed.">				if (receiverType.equals(Constants.TYPE_XML))</span>
				{
<span class="nc" id="L229">					input = ((XMLMessage) sourceMessage).getResponseDocument();</span>
				}
<span class="nc bnc" id="L231" title="All 2 branches missed.">				else if (receiverType.equals(Constants.TYPE_OBJECT))</span>
				{
					// the message content is serialised due to the structure
					// description attached to the source system
<span class="nc" id="L235">					input = ((ObjectMessage) sourceMessage).getResponseObject();</span>
				}
<span class="nc bnc" id="L237" title="All 2 branches missed.">				else if (receiverType.equals(Constants.TYPE_TEXT))</span>
				{
					// the message content is serialised due to the structure
					// description attached to the source system
<span class="nc" id="L241">					input = ((TextMessage) sourceMessage).getResponseText();</span>
				}
				break;
		}

<span class="nc" id="L246">		Transformer transformer = TransformerFactory.createTransformer(source,</span>
				destination, sourceMessage, destinationMessage);

<span class="nc" id="L249">		output = transformer.transform(input, source, destination,</span>
				destinationMessage);

<span class="nc bnc" id="L252" title="All 2 branches missed.">		if (output != null)</span>
		{
<span class="nc bnc" id="L254" title="All 2 branches missed.">			if (output instanceof String)</span>
			{
<span class="nc" id="L256">				((TextMessage) destinationMessage).setRequestText(output</span>
<span class="nc" id="L257">						.toString(), destination);</span>
			}
<span class="nc bnc" id="L259" title="All 2 branches missed.">			else if (output instanceof Document)</span>
			{
<span class="nc" id="L261">				((XMLMessage) destinationMessage).setRequestDocument(</span>
						(Document) output, destination);
			}
			else
			{
<span class="nc" id="L266">				((ObjectMessage) destinationMessage).setRequestObject(output,</span>
						destination);
			}
		}
<span class="nc" id="L270">		return destinationMessage;</span>
	}

	static private Message createMessage(Message source, XBUSSystem destination)
			throws XException
	{
		/*
		 * Constructing the parameters for the constructor.
		 */
<span class="nc" id="L279">		Class[] conArgsClass = new Class[]</span>
		{
<span class="nc" id="L281">				ReflectionSupport.classForName(&quot;java.lang.String&quot;),</span>
				ReflectionSupport
<span class="nc" id="L283">						.classForName(&quot;net.sf.xbus.base.xbussystem.XBUSSystem&quot;),</span>
<span class="nc" id="L284">				ReflectionSupport.classForName(&quot;java.lang.String&quot;)};</span>

<span class="nc" id="L286">		Object[] conArgs = new Object[]</span>
<span class="nc" id="L287">		{source.getFunction(), source.getSource(), source.getId()};</span>

		/*
		 * Getting the type of Message that must be created
		 */
<span class="nc" id="L292">		Configuration config = Configuration.getInstance();</span>
<span class="nc" id="L293">		String newMessageShortname = config.getValue(Constants.CHAPTER_SYSTEM,</span>
<span class="nc" id="L294">				destination.getName(), &quot;Message&quot;);</span>
<span class="nc" id="L295">		String newMessageName = Configuration.getClass(&quot;Message&quot;,</span>
				newMessageShortname);

		/*
		 * Instanciating the new Message
		 */
<span class="nc" id="L301">		return (Message) ReflectionSupport.createObject(newMessageName,</span>
				conArgsClass, conArgs);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>