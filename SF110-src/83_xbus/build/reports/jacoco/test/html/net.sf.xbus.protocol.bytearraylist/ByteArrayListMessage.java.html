<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ByteArrayListMessage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.protocol.bytearraylist</a> &gt; <span class="el_source">ByteArrayListMessage.java</span></div><h1>ByteArrayListMessage.java</h1><pre class="source lang-java linenums">package net.sf.xbus.protocol.bytearraylist;

import java.io.IOException;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.Vector;

import javax.xml.parsers.DocumentBuilder;

import net.sf.xbus.base.bytearraylist.ByteArrayConverter;
import net.sf.xbus.base.bytearraylist.ByteArrayConverterFactory;
import net.sf.xbus.base.bytearraylist.ByteArrayList;
import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.bytearrays.XByteArraySupport;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.xbussystem.XBUSSystem;
import net.sf.xbus.protocol.ObjectMessage;
import net.sf.xbus.protocol.xml.XMLMessageAbstract;

import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

/**
 * &lt;code&gt;ByteArrayListMessage&lt;/code
 */
public class ByteArrayListMessage extends XMLMessageAbstract
		implements
			ObjectMessage
{

	private static final String TAG_LINES = &quot;Lines&quot;;
	private static final String TAG_RECORD = &quot;Record&quot;;
	private static final String TAG_LENGTH = &quot;Length&quot;;

<span class="nc" id="L42">	private String mEncodingSystem = null;</span>

	/**
	 * Constructor for ByteArrayListMessage.
	 * 
	 * @param source
	 */
	public ByteArrayListMessage(XBUSSystem source)
	{
<span class="nc" id="L51">		super(source);</span>
<span class="nc" id="L52">		setShortname(&quot;ByteArrayListMessage&quot;);</span>
<span class="nc" id="L53">		mEncodingSystem = source.getName();</span>
<span class="nc" id="L54">	}</span>

	/**
	 * Constructor for ByteArrayListMessage.
	 * 
	 * @param function
	 * @param source
	 * @param id
	 */
	public ByteArrayListMessage(String function, XBUSSystem source, String id)
	{
<span class="nc" id="L65">		super(function, source, id);</span>
<span class="nc" id="L66">		setShortname(&quot;ByteArrayListMessage&quot;);</span>
<span class="nc" id="L67">		mEncodingSystem = source.getName();</span>
<span class="nc" id="L68">	}</span>

	/**
	 * Parses the incoming {@link net.sf.xbus.base.bytearraylist.ByteArrayList}into
	 * a XML document.
	 */
	public void setRequestObject(Object obj, XBUSSystem source)
			throws XException
	{
<span class="nc" id="L77">		setRequestDocument(parseList((ByteArrayList) obj, source), source);</span>
<span class="nc" id="L78">	}</span>

	/**
	 * Empty method
	 */
	public void setResponseObject(Object obj, XBUSSystem destination)
<span class="nc" id="L84">	{}</span>

	/**
	 * @return {@link net.sf.xbus.base.bytearraylist.ByteArrayList}
	 */
	public Object getRequestObject(XBUSSystem system) throws XException
	{
<span class="nc" id="L91">		return serializeList(getRequestDocument(system));</span>
	}

	/**
	 * @return always &lt;code&gt;null&lt;/code&gt;
	 */
	public Object getResponseObject()
	{
<span class="nc" id="L99">		return null;</span>
	}

	public void setEncodingSystem(XBUSSystem system)
	{
<span class="nc" id="L104">		mEncodingSystem = system.getName();</span>
<span class="nc" id="L105">	}</span>

	private Document parseList(ByteArrayList source, XBUSSystem system)
			throws XException
	{

		/*
		 * 1. Creating the root element
		 */
<span class="nc" id="L114">		DocumentBuilder builder = getDocumentBuilder(system);</span>
<span class="nc" id="L115">		Document doc = builder.newDocument();</span>
<span class="nc" id="L116">		Element root = doc.createElement(mEncodingSystem);</span>
<span class="nc" id="L117">		doc.appendChild(root);</span>

		/*
		 * 2. Getting the interface description
		 */
<span class="nc" id="L122">		String interfaceDescriptionFilename = getInterfaceDescriptionFilename(mEncodingSystem);</span>
<span class="nc" id="L123">		Document interfaceDescription = null;</span>
		try
		{
<span class="nc" id="L126">			interfaceDescription = builder.parse(interfaceDescriptionFilename);</span>
		}
<span class="nc" id="L128">		catch (IOException e)</span>
		{
<span class="nc" id="L130">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_PROTOCOL,
					Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;0&quot;, e);
		}
<span class="nc" id="L134">		catch (SAXException e)</span>
		{
<span class="nc" id="L136">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_PROTOCOL,
					Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;0&quot;, e);
<span class="nc" id="L139">		}</span>

		/*
		 * 3. Getting the position, length and list of identifiers
		 */
<span class="nc" id="L144">		NodeList lines = interfaceDescription.getElementsByTagName(TAG_LINES);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (lines.getLength() != 1)</span>
		{
<span class="nc" id="L147">			throw new XException(Constants.LOCATION_INTERN,</span>
					Constants.LAYER_PROTOCOL,
					Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;10&quot;);
		}

<span class="nc" id="L152">		Node identifierTag = lines.item(0);</span>
<span class="nc" id="L153">		NamedNodeMap attributes = identifierTag.getAttributes();</span>
<span class="nc" id="L154">		int identifierPos = getIdentifierPos(attributes);</span>
<span class="nc" id="L155">		int identifierLength = getIdentifierLength(attributes);</span>

<span class="nc" id="L157">		Hashtable identifiers = getIdentifiers(interfaceDescription);</span>

		// Hashtable recordLengths = computeRecordLengths(interfaceDescription);

		/*
		 * 4. Parsing the list of byte arrays
		 */
		String identifier;
		String identifierName;
		Element recordNode;
		Element fieldNode;
		Node valueNode;
		int pos;
		byte[] record;
		byte[] fieldBytes;
		Field field;
<span class="nc" id="L173">		ByteArrayConverter conv = ByteArrayConverterFactory</span>
<span class="nc" id="L174">				.getConverter(mEncodingSystem);</span>
<span class="nc" id="L175">		Hashtable fields = getFields(interfaceDescription);</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">		for (Iterator it = (source).iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L178">			record = (byte[]) it.next();</span>
<span class="nc" id="L179">			recordNode = doc.createElement(TAG_RECORD);</span>
<span class="nc" id="L180">			recordNode.setAttribute(TAG_LENGTH, String.valueOf(record.length));</span>
<span class="nc" id="L181">			identifier = conv.byteArrayToString(XByteArraySupport.subArray(</span>
					record, identifierPos, identifierLength));
<span class="nc" id="L183">			identifierName = (String) identifiers.get(identifier);</span>
<span class="nc" id="L184">			List fieldList = (List) fields.get(identifierName);</span>
<span class="nc" id="L185">			pos = 0;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">			for (Iterator it1 = fieldList.iterator(); it1.hasNext();)</span>
			{
<span class="nc" id="L188">				field = (Field) it1.next();</span>
<span class="nc" id="L189">				fieldBytes = XByteArraySupport.subArray(record, pos,</span>
						field.length);
<span class="nc" id="L191">				fieldNode = doc.createElement(field.name);</span>
<span class="nc" id="L192">				String value = conv.byteArrayToString(fieldBytes);</span>
<span class="nc" id="L193">				valueNode = doc.createTextNode(value);</span>
<span class="nc" id="L194">				fieldNode.appendChild(valueNode);</span>
<span class="nc" id="L195">				fieldNode</span>
<span class="nc" id="L196">						.setAttribute(TAG_LENGTH, String.valueOf(field.length));</span>
<span class="nc" id="L197">				recordNode.appendChild(fieldNode);</span>
<span class="nc" id="L198">				pos = pos + field.length;</span>
<span class="nc" id="L199">			}</span>
<span class="nc" id="L200">			root.appendChild(recordNode);</span>
<span class="nc" id="L201">		}</span>
<span class="nc" id="L202">		return doc;</span>
	}

	private int getIdentifierPos(NamedNodeMap attributes) throws XException
	{
		int identifierPos;
<span class="nc" id="L208">		Node attribute = attributes.getNamedItem(&quot;IdentifierPos&quot;);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (attribute != null)</span>
		{
<span class="nc" id="L211">			identifierPos = Integer.parseInt(attribute.getNodeValue());</span>
		}
		else
		{
<span class="nc" id="L215">			throw new XException(Constants.LOCATION_INTERN,</span>
					Constants.LAYER_PROTOCOL,
					Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;11&quot;);
		}
<span class="nc" id="L219">		return identifierPos;</span>
	}

	private int getIdentifierLength(NamedNodeMap attributes) throws XException
	{
		Node attribute;
		int identifierLength;
<span class="nc" id="L226">		attribute = attributes.getNamedItem(&quot;IdentifierLength&quot;);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (attribute != null)</span>
		{
<span class="nc" id="L229">			identifierLength = Integer.parseInt(attribute.getNodeValue());</span>
		}
		else
		{
<span class="nc" id="L233">			throw new XException(Constants.LOCATION_INTERN,</span>
					Constants.LAYER_PROTOCOL,
					Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;12&quot;);
		}
<span class="nc" id="L237">		return identifierLength;</span>
	}

	private ByteArrayList serializeList(Document doc) throws XException
	{
<span class="nc" id="L242">		ByteArrayList retArrayList = new ByteArrayList();</span>

<span class="nc" id="L244">		ByteArrayConverter conv = ByteArrayConverterFactory</span>
<span class="nc" id="L245">				.getConverter(mEncodingSystem);</span>

<span class="nc" id="L247">		NodeList records = doc.getElementsByTagName(TAG_RECORD);</span>
		Node recordNode;
		NamedNodeMap recordAttributes;
		Attr recordLengthAttr;
		int recordLength;
		byte[] recordArray;

		NodeList fields;
		Node fieldNode;
		NamedNodeMap fieldAttributes;
		Attr fieldLengthAttr;
		int fieldLength;
		Node fieldTextNode;
		String fieldValue;
		byte[] fieldBytes;
		int pos;

<span class="nc bnc" id="L264" title="All 2 branches missed.">		for (int i = 0; i &lt; records.getLength(); i++)</span>
		{
<span class="nc" id="L266">			recordNode = records.item(i);</span>
<span class="nc" id="L267">			recordAttributes = recordNode.getAttributes();</span>
<span class="nc" id="L268">			recordLengthAttr = (Attr) recordAttributes.getNamedItem(TAG_LENGTH);</span>
<span class="nc" id="L269">			recordLength = Integer.parseInt(recordLengthAttr.getNodeValue());</span>
<span class="nc" id="L270">			recordArray = new byte[recordLength];</span>

<span class="nc" id="L272">			pos = 0;</span>

<span class="nc" id="L274">			fields = recordNode.getChildNodes();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">			for (int k = 0; k &lt; fields.getLength(); k++)</span>
			{
<span class="nc" id="L277">				fieldNode = fields.item(k);</span>

<span class="nc bnc" id="L279" title="All 2 branches missed.">				if (fieldNode.getNodeType() == Node.ELEMENT_NODE)</span>
				{
<span class="nc" id="L281">					fieldAttributes = fieldNode.getAttributes();</span>
<span class="nc" id="L282">					fieldLengthAttr = (Attr) fieldAttributes</span>
<span class="nc" id="L283">							.getNamedItem(TAG_LENGTH);</span>
<span class="nc" id="L284">					fieldLength = Integer.parseInt(fieldLengthAttr</span>
<span class="nc" id="L285">							.getNodeValue());</span>
<span class="nc" id="L286">					fieldTextNode = fieldNode.getFirstChild();</span>
<span class="nc" id="L287">					fieldValue = fieldTextNode.getNodeValue();</span>
<span class="nc" id="L288">					fieldBytes = conv</span>
<span class="nc" id="L289">							.stringToByteArray(fieldValue, fieldLength);</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">					for (int m = 0; m &lt; fieldBytes.length; m++)</span>
					{
<span class="nc" id="L292">						recordArray[pos] = fieldBytes[m];</span>
<span class="nc" id="L293">						pos++;</span>
					}
				}
			}
<span class="nc" id="L297">			retArrayList.add(recordArray);</span>
		}
<span class="nc" id="L299">		return retArrayList;</span>
	}

	static private String getInterfaceDescriptionFilename(String system)
			throws XException
	{
<span class="nc" id="L305">		Configuration config = Configuration.getInstance();</span>
<span class="nc" id="L306">		String interfaceDescriptionFilename = config.getValue(</span>
				Constants.CHAPTER_SYSTEM, system, &quot;DescriptionFile&quot;);

<span class="nc" id="L309">		return new StringBuffer(Constants.XBUS_ETC).append(</span>
<span class="nc" id="L310">				&quot;InterfaceDescriptions&quot;).append(Constants.FILE_SEPERATOR)</span>
<span class="nc" id="L311">				.append(interfaceDescriptionFilename).toString();</span>
	}

	private Hashtable getIdentifiers(Document interfaceDescription)
			throws XException
	{
<span class="nc" id="L317">		Hashtable identifiers = new Hashtable();</span>
<span class="nc" id="L318">		NamedNodeMap attributes = null;</span>
<span class="nc" id="L319">		Node attribute = null;</span>
<span class="nc" id="L320">		NodeList recordTypes = interfaceDescription</span>
<span class="nc" id="L321">				.getElementsByTagName(&quot;RecordType&quot;);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">		if (recordTypes.getLength() &lt; 1)</span>
		{
<span class="nc" id="L324">			throw new XException(Constants.LOCATION_INTERN,</span>
					Constants.LAYER_PROTOCOL,
					Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;14&quot;);
		}
		Node recordType;
		Node nameNode;
		String identifierString;
		String identifierName;
<span class="nc bnc" id="L332" title="All 2 branches missed.">		for (int i = 0; i &lt; recordTypes.getLength(); i++)</span>
		{
<span class="nc" id="L334">			recordType = recordTypes.item(i);</span>
<span class="nc" id="L335">			attributes = recordType.getAttributes();</span>
<span class="nc" id="L336">			attribute = attributes.getNamedItem(&quot;Identifier&quot;);</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">			if (attribute != null)</span>
			{
<span class="nc" id="L339">				identifierString = attribute.getNodeValue();</span>
			}
			else
			{
<span class="nc" id="L343">				throw new XException(Constants.LOCATION_INTERN,</span>
						Constants.LAYER_PROTOCOL,
						Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;15&quot;);
			}

<span class="nc" id="L348">			nameNode = recordType.getFirstChild();</span>
<span class="nc" id="L349">			identifierName = nameNode.getNodeValue();</span>
<span class="nc" id="L350">			identifiers.put(identifierString, identifierName);</span>
		}
<span class="nc" id="L352">		return identifiers;</span>
	}

	private Hashtable getFields(Document interfaceDescription)
			throws XException
	{
<span class="nc" id="L358">		Hashtable fields = new Hashtable();</span>

<span class="nc" id="L360">		NodeList recordtypes = interfaceDescription</span>
<span class="nc" id="L361">				.getElementsByTagName(&quot;RecordTypeSpec&quot;);</span>

		NamedNodeMap attributes;
		Node attribute;
		String identifierString;
		NodeList fieldNodes;
		Node node;
<span class="nc" id="L368">		Field field = null;</span>
		Node name, length;
		List fieldList;

<span class="nc bnc" id="L372" title="All 2 branches missed.">		for (int i = 0; i &lt; recordtypes.getLength(); i++)</span>
		{
<span class="nc" id="L374">			Node recordtype = recordtypes.item(i);</span>
<span class="nc" id="L375">			attributes = recordtype.getAttributes();</span>
<span class="nc" id="L376">			attribute = attributes.getNamedItem(&quot;Name&quot;);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">			if (attribute != null)</span>
			{
<span class="nc" id="L379">				identifierString = attribute.getNodeValue();</span>
			}
			else
			{
<span class="nc" id="L383">				throw new XException(Constants.LOCATION_INTERN,</span>
						Constants.LAYER_PROTOCOL,
						Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;15&quot;);
			}

<span class="nc" id="L388">			fieldList = new Vector();</span>
<span class="nc" id="L389">			fieldNodes = recordtype.getChildNodes();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">			for (int k = 0; k &lt; fieldNodes.getLength(); k++)</span>
			{
<span class="nc" id="L392">				node = fieldNodes.item(k);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">				if ((&quot;Field&quot;.equals(node.getNodeName()))</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">						&amp;&amp; (node.getNodeType() == Node.ELEMENT_NODE))</span>
				{
<span class="nc" id="L396">					field = new Field();</span>
<span class="nc" id="L397">					attributes = node.getAttributes();</span>
<span class="nc" id="L398">					name = attributes.getNamedItem(&quot;Name&quot;);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">					if (name != null)</span>
					{
<span class="nc" id="L401">						field.name = name.getNodeValue();</span>
					}
					else
					{
<span class="nc" id="L405">						throw new XException(Constants.LOCATION_INTERN,</span>
								Constants.LAYER_PROTOCOL,
								Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;16&quot;);
					}
<span class="nc" id="L409">					length = attributes.getNamedItem(&quot;Length&quot;);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">					if (length != null)</span>
					{
						try
						{
<span class="nc" id="L414">							field.length = Integer.parseInt(length</span>
<span class="nc" id="L415">									.getNodeValue());</span>
						}
<span class="nc" id="L417">						catch (NumberFormatException e)</span>
						{
<span class="nc" id="L419">							throw new XException(Constants.LOCATION_EXTERN,</span>
									Constants.LAYER_PROTOCOL,
									Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST,
									&quot;17&quot;, e);
<span class="nc" id="L423">						}</span>
					}
					else
					{
<span class="nc" id="L427">						throw new XException(Constants.LOCATION_EXTERN,</span>
								Constants.LAYER_PROTOCOL,
								Constants.PACKAGE_PROTOCOL_BYTEARRAYLIST, &quot;18&quot;);
					}
<span class="nc" id="L431">					fieldList.add(field);</span>
				}
			}
<span class="nc" id="L434">			fields.put(identifierString, fieldList);</span>
		}
<span class="nc" id="L436">		return fields;</span>
	}

	protected void synchronizeRequestFields(XBUSSystem system)
<span class="nc" id="L440">	{}</span>

	protected void synchronizeResponseFields(XBUSSystem system)
<span class="nc" id="L443">	{}</span>

	/**
	 * Acts as a container for the information of one field of either an input
	 * or an output parameter.
	 */
<span class="nc" id="L449">	class Field</span>
	{
<span class="nc" id="L451">		public String name = null;</span>
<span class="nc" id="L452">		public int length = 0;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>