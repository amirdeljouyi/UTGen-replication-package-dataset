<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XException.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.base.core</a> &gt; <span class="el_source">XException.java</span></div><h1>XException.java</h1><pre class="source lang-java linenums">package net.sf.xbus.base.core;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.PrintStream;
import java.sql.SQLException;
import java.util.Hashtable;
import java.util.List;

import javax.naming.NamingException;

import net.sf.xbus.base.core.trace.Trace;

import org.xml.sax.SAXParseException;

/**
 * All errors that occur while processing a request are handled by throwing a
 * &lt;code&gt;XException&lt;/code&gt;. Because nearly all methods possibly throw a
 * &lt;code&gt;XException&lt;/code&gt;, only a few points (eg. the receivers) have to
 * catch and handle it.
 */
public class XException extends Exception
{
<span class="fc" id="L24">	private static Hashtable mExceptionInformation = new Hashtable();</span>
<span class="nc" id="L25">	private String mMessageText = null;</span>

	/**
	 * Constructs a &lt;code&gt;XException&lt;/code&gt; and traces the
	 * &lt;code&gt;message&lt;/code&gt; and the backtrace.
	 * 
	 * @param location indicates wether this is an internal or an external
	 *            problem
	 * @param layer indicates the layer where the error has occurred
	 * @param Package indicates the package where the error has occurred
	 * @param number to identify the error
	 */
	public XException(String location, String layer, String Package,
			String number)
<span class="nc" id="L39">	{</span>
<span class="nc" id="L40">		traceException(location, layer, Package, number, null);</span>
<span class="nc" id="L41">	}</span>

	/**
	 * Constructs a &lt;code&gt;XException&lt;/code&gt; and traces the
	 * &lt;code&gt;message&lt;/code&gt; and the backtrace.
	 * 
	 * @param location indicates wether this is an internal or an external
	 *            problem
	 * @param layer indicates the layer where the error has occurred
	 * @param Package indicates the package where the error has occurred
	 * @param number to identify the error
	 * @param params a list of values to be included in the message
	 */
	public XException(String location, String layer, String Package,
			String number, List params)
<span class="nc" id="L56">	{</span>
<span class="nc" id="L57">		traceException(location, layer, Package, number, params);</span>
<span class="nc" id="L58">	}</span>

	/**
	 * Constructs a &lt;code&gt;XException&lt;/code&gt; and traces the
	 * &lt;code&gt;Throwable&lt;/code&gt; and the backtrace.
	 * 
	 * @param location indicates wether this is an internal or an external
	 *            problem
	 * @param layer indicates the layer where the error has occurred
	 * @param Package indicates the package where the error has occurred
	 * @param number to identify the error
	 * @param t contains the thrown Exception.
	 * @param params list of parameters to be inclueded in the message
	 */
	public XException(String location, String layer, String Package,
			String number, Throwable t, List params)
	{
<span class="nc" id="L75">		super(t.getMessage());</span>

<span class="nc" id="L77">		traceException(location, layer, Package, number, t, params);</span>
<span class="nc" id="L78">	}</span>

	/**
	 * Constructs a &lt;code&gt;XException&lt;/code&gt; and traces the
	 * &lt;code&gt;Throwable&lt;/code&gt; and the backtrace.
	 * 
	 * @param location indicates wether this is an internal or an external
	 *            problem
	 * @param layer indicates the layer where the error has occurred
	 * @param Package indicates the package where the error has occurred
	 * @param number to identify the error
	 * @param t contains the thrown Exception.
	 */
	public XException(String location, String layer, String Package,
			String number, Throwable t)
	{
<span class="nc" id="L94">		super(t.getMessage());</span>

<span class="nc" id="L96">		traceException(location, layer, Package, number, t, null);</span>
<span class="nc" id="L97">	}</span>

	/**
	 * @return the message string of this instance (which may be null).
	 */
	public String getMessage()
	{
<span class="nc" id="L104">		return mMessageText;</span>
	}

	/**
	 * @return a more detailed information about the last thrown XException.
	 */
	public static String getExceptionInformation()
	{
<span class="nc" id="L112">		return (String) mExceptionInformation.get(Thread.currentThread()</span>
<span class="nc" id="L113">				.getName());</span>
	}

	/**
	 * Sets the information for the current XException
	 * 
	 * @param message the message of this XException
	 * @param t the thrown Exception.
	 */
	public static void setExceptionInformation(String message, Throwable t)
	{
<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (t == null)</span>
		{
<span class="nc" id="L126">			mExceptionInformation</span>
<span class="nc" id="L127">					.put(Thread.currentThread().getName(), message);</span>
		} // if (t == null)
		else
		{
<span class="nc" id="L131">			mExceptionInformation.put(Thread.currentThread().getName(),</span>
<span class="nc" id="L132">					new StringBuffer().append(message).append(</span>
<span class="nc" id="L133">							Constants.LINE_SEPERATOR).append(</span>
<span class="nc" id="L134">							Constants.LINE_SEPERATOR).append(</span>
<span class="nc" id="L135">							getStackTraceAsString(t)).toString());</span>
		}
<span class="nc" id="L137">	}</span>

	/**
	 * Removes information about previous exceptions.
	 */
	public static void clearExceptionInformation()
	{
<span class="nc" id="L144">		mExceptionInformation = new Hashtable();</span>
<span class="nc" id="L145">	}</span>

	/**
	 * Returns the stacktrace of the given &lt;code&gt;Throwable&lt;/code&gt; as a string.
	 * 
	 * @param t the thrown Exception.
	 */
	private static String getStackTraceAsString(Throwable t)
	{
<span class="nc" id="L154">		String retString = null;</span>

		try
		{
<span class="nc" id="L158">			ByteArrayOutputStream outStream = new ByteArrayOutputStream();</span>
<span class="nc" id="L159">			PrintStream printStream = new PrintStream(outStream);</span>
<span class="nc" id="L160">			t.printStackTrace(printStream);</span>

<span class="nc" id="L162">			retString = outStream.toString();</span>
<span class="nc" id="L163">			printStream.close();</span>
<span class="nc" id="L164">			outStream.close();</span>
		}
<span class="nc" id="L166">		catch (IOException e)</span>
		{
			/*
			 * do nothing
			 */
<span class="nc" id="L171">		}</span>

<span class="nc" id="L173">		return retString;</span>
	}

	private void traceException(String Location, String Layer, String Package,
			String Number, List params)
	{
<span class="nc" id="L179">		String basename = &quot;errors&quot;;</span>
<span class="nc" id="L180">		String key = Location + &quot;_&quot; + Layer + &quot;_&quot; + Package + &quot;_&quot; + Number;</span>

<span class="nc" id="L182">		MessageHandler msg = MessageHandler.getInstance(basename);</span>
<span class="nc" id="L183">		String messageText = msg.getMessage(key, params);</span>

<span class="nc bnc" id="L185" title="All 2 branches missed.">		if (Trace.isInitialized())</span>
		{
<span class="nc" id="L187">			Trace.error(&quot;Exception caught: &quot; + key + &quot; &quot; + messageText, this);</span>
		} // if (Trace.isInitialized())
		else
		{
<span class="nc" id="L191">			System.out.println(&quot;Exception caught: &quot; + key + &quot; &quot; + messageText);</span>
<span class="nc" id="L192">			printStackTrace();</span>
		}

<span class="nc" id="L195">		messageText = key + &quot; &quot; + messageText;</span>
<span class="nc" id="L196">		setExceptionInformation(messageText, this);</span>
<span class="nc" id="L197">		mMessageText = messageText;</span>
<span class="nc" id="L198">	}</span>

	private void traceException(String Location, String Layer, String Package,
			String Number, Throwable t, List params)
	{
		/*
		 * When the exception is an XException, it has been traced before
		 */
<span class="nc bnc" id="L206" title="All 2 branches missed.">		if (!this.getClass().equals(t.getClass()))</span>
		{
<span class="nc" id="L208">			String basename = &quot;errors&quot;;</span>
<span class="nc" id="L209">			String key = Location + &quot;_&quot; + Layer + &quot;_&quot; + Package + &quot;_&quot; + Number;</span>

<span class="nc" id="L211">			MessageHandler msg = MessageHandler.getInstance(basename);</span>
<span class="nc" id="L212">			String messageText = msg.getMessageOptional(key, params);</span>

<span class="nc bnc" id="L214" title="All 2 branches missed.">			if (messageText == null)</span>
			{
<span class="nc" id="L216">				messageText = t.getMessage();</span>
<span class="nc bnc" id="L217" title="All 4 branches missed.">				if ((messageText == null) &amp;&amp; (t.getCause() != null))</span>
				{
					/*
					 * When the Exception has no message, maybe its cause has
					 * one
					 */
<span class="nc" id="L223">					messageText = t.getCause().getMessage();</span>
				}
<span class="nc bnc" id="L225" title="All 2 branches missed.">				if (messageText == null)</span>
				{
					/*
					 * If messageText is still null, the name of the Throwable
					 * class is used
					 */
<span class="nc" id="L231">					messageText = t.getClass().getName();</span>
				}
			} // if (messageText == null)

<span class="nc bnc" id="L235" title="All 2 branches missed.">			if (Trace.isInitialized())</span>
			{
<span class="nc" id="L237">				Trace.error(&quot;Exception caught: &quot; + key + &quot; &quot; + messageText, t);</span>
<span class="nc" id="L238">				traceAdditionalInfo(t);</span>
			} // if (Trace.isInitialized())
			else
			{
<span class="nc" id="L242">				System.out.println(&quot;Exception caught: &quot; + key + &quot; &quot;</span>
						+ messageText);
<span class="nc" id="L244">				t.printStackTrace();</span>
			}

<span class="nc" id="L247">			messageText = key + &quot; &quot; + messageText;</span>
<span class="nc" id="L248">			setExceptionInformation(messageText, t);</span>
<span class="nc" id="L249">			mMessageText = messageText;</span>
<span class="nc" id="L250">		} // if (!this.getClass().equals(t.getClass()))</span>
		else
		{
<span class="nc" id="L253">			mMessageText = t.getMessage();</span>
		}
<span class="nc" id="L255">	}</span>

	private void traceAdditionalInfo(Throwable t)
	{
<span class="nc bnc" id="L259" title="All 2 branches missed.">		if (t instanceof NamingException)</span>
		{
<span class="nc" id="L261">			Trace.error(&quot;Resolved Name	 : &quot;</span>
<span class="nc" id="L262">					+ ((NamingException) t).getResolvedName());</span>
<span class="nc" id="L263">			Trace.error(&quot;Resolved Object : &quot;</span>
<span class="nc" id="L264">					+ ((NamingException) t).getResolvedObj());</span>
<span class="nc" id="L265">			Trace.error(&quot;Remaining Name  : &quot;</span>
<span class="nc" id="L266">					+ ((NamingException) t).getRemainingName());</span>
<span class="nc" id="L267">			Trace.error(&quot;Explanation : &quot;</span>
<span class="nc" id="L268">					+ ((NamingException) t).getExplanation());</span>
		}
<span class="nc bnc" id="L270" title="All 2 branches missed.">		else if (t instanceof SQLException)</span>
		{
<span class="nc" id="L272">			Trace.error(&quot;SQLState : &quot; + ((SQLException) t).getSQLState());</span>
<span class="nc" id="L273">			Trace.error(&quot;Errorcode: &quot; + ((SQLException) t).getErrorCode());</span>
		}
<span class="nc bnc" id="L275" title="All 2 branches missed.">		else if (t instanceof SAXParseException)</span>
		{
<span class="nc" id="L277">			Trace.error(&quot;Parsing error occurred at line &quot;</span>
<span class="nc" id="L278">					+ ((SAXParseException) t).getLineNumber() + &quot;, column &quot;</span>
<span class="nc" id="L279">					+ ((SAXParseException) t).getColumnNumber());</span>
		}
<span class="nc" id="L281">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>