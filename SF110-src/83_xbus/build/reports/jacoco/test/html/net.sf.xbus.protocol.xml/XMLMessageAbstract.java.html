<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XMLMessageAbstract.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.protocol.xml</a> &gt; <span class="el_source">XMLMessageAbstract.java</span></div><h1>XMLMessageAbstract.java</h1><pre class="source lang-java linenums">package net.sf.xbus.protocol.xml;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;

import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.core.strings.XStringSupport;
import net.sf.xbus.base.xbussystem.XBUSSystem;
import net.sf.xbus.base.xml.XMLHelper;
import net.sf.xbus.protocol.Message;
import net.sf.xbus.protocol.ObjectMessage;
import net.sf.xbus.protocol.TextMessage;
import net.sf.xbus.protocol.XMLMessage;

import org.w3c.dom.Document;
import org.w3c.dom.DocumentType;

/**
 * &lt;code&gt;XMLMessage&lt;/code&gt; is the base class for all messages in the XML
 * format.
 * &lt;p&gt;
 * 
 * It holds the XML data internally as an &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
 * Therefore it is more efficient to work with the &lt;code&gt;Document&lt;/code&gt;
 * representation than with the &lt;code&gt;String&lt;/code&gt; representation. When
 * working with &lt;code&gt;String&lt;/code&gt; representation, parsing and serializing is
 * done internally.
 */
public abstract class XMLMessageAbstract extends Message implements
		TextMessage, ObjectMessage, XMLMessage
{
<span class="nc" id="L36">	private Document mXMLRequestDocument = null;</span>

<span class="nc" id="L38">	private Document mXMLResponseDocument = null;</span>

<span class="nc" id="L40">	private String mRequestDTDSystemID = null;</span>

<span class="nc" id="L42">	private String mResponseDTDSystemID = null;</span>

	/**
	 * This constructor stores the &lt;code&gt;source&lt;/code&gt;, creates an unique
	 * identifier for the message and initializes the requestTimestamp. It is
	 * used when constructing a new &lt;code&gt;XMLMessage&lt;/code&gt; from the data of a
	 * receiver.
	 * 
	 * @param source
	 *            the system where the message is coming from
	 */
	public XMLMessageAbstract(XBUSSystem source)
	{
<span class="nc" id="L55">		super(source);</span>
<span class="nc" id="L56">	}</span>

	/**
	 * This constructor initializes the new &lt;code&gt;XMLMessage&lt;/code&gt; with the
	 * given parameters. It is used when constructing a new
	 * &lt;code&gt;XMLMessage&lt;/code&gt; by converting it from another
	 * &lt;code&gt;Message&lt;/code&gt;.
	 * 
	 * @param function
	 *            the function of the other &lt;code&gt;Message&lt;/code&gt;
	 * @param source
	 *            the source of the other &lt;code&gt;Message&lt;/code&gt;
	 * @param id
	 *            the id of the other &lt;code&gt;Message&lt;/code&gt;
	 */
	public XMLMessageAbstract(String function, XBUSSystem source, String id)
	{
<span class="nc" id="L73">		super(function, source, id);</span>
<span class="nc" id="L74">	}</span>

	/**
	 * Gets the text of the incoming message. It is the result of the
	 * serialization of the internally used &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 * 
	 * @param source
	 *            ignored
	 * @return the request XML document as a &lt;code&gt;String&lt;/code&gt;
	 */
	public String getRequestText(XBUSSystem source) throws XException
	{
<span class="nc" id="L86">		return serializeXML(mXMLRequestDocument, mRequestDTDSystemID);</span>
	}

	/**
	 * Sets the text of the incoming message. After parsing the XML string, the
	 * information is internally stored in a &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 * 
	 * @param text
	 *            a XML document from the request
	 */
	public void setRequestText(String text, XBUSSystem source)
			throws XException
	{
<span class="nc" id="L99">		setRequestDocument(parseXML(text, source), source);</span>
<span class="nc" id="L100">	}</span>

	/**
	 * Gets the text of the outgoing message. It is the result of the
	 * serialization of the internally used &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 * 
	 * @return the response XML document as a &lt;code&gt;String&lt;/code&gt;
	 */
	public String getResponseText() throws XException
	{
<span class="nc" id="L110">		return serializeXML(mXMLResponseDocument, mResponseDTDSystemID);</span>
	}

	/**
	 * Sets the text of the outgoing message. After parsing the XML string, the
	 * information is internally stored as a &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 * 
	 * @param text
	 *            a XML document from the response
	 */
	public void setResponseText(String text, XBUSSystem destination)
			throws XException
	{
<span class="nc" id="L123">		setResponseDocument(parseXML(text, destination), destination);</span>
<span class="nc" id="L124">	}</span>

	/**
	 * Returns the request XML data as a &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 */
	public Document getRequestDocument(XBUSSystem system)
	{
<span class="nc" id="L131">		return mXMLRequestDocument;</span>
	}

	/**
	 * Sets the request XML data as a &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 */
	public void setRequestDocument(Document doc, XBUSSystem source)
			throws XException
	{
<span class="nc" id="L140">		mXMLRequestDocument = doc;</span>

<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (mXMLRequestDocument != null)</span>
		{
			/*
			 * Set the SystemId with the DTD given in the document
			 */
<span class="nc" id="L147">			DocumentType docType = mXMLRequestDocument.getDoctype();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">			if (docType != null)</span>
			{
<span class="nc" id="L150">				mRequestDTDSystemID = docType.getSystemId();</span>
			}

			/*
			 * Set the function, when a XPath expression is given
			 */
<span class="nc" id="L156">			String xPathExpr = Configuration.getInstance().getValueOptional(</span>
<span class="nc" id="L157">					Constants.CHAPTER_SYSTEM, source.getName(),</span>
					&quot;XPathExpression&quot;);
			try
			{
<span class="nc bnc" id="L161" title="All 2 branches missed.">				if (xPathExpr != null)</span>
				{
<span class="nc" id="L163">					XPath xPath = XPathFactory.newInstance().newXPath();</span>
<span class="nc" id="L164">					String function = xPath.evaluate(xPathExpr, doc</span>
<span class="nc" id="L165">							.getDocumentElement());</span>
<span class="nc" id="L166">					function = XStringSupport.replaceAll(function, &quot; &quot;, &quot;&quot;);</span>
<span class="nc" id="L167">					setFunction(function);</span>
				}
			}
<span class="nc" id="L170">			catch (XPathExpressionException e)</span>
			{
<span class="nc" id="L172">				throw new XException(Constants.LOCATION_INTERN,</span>
						Constants.LAYER_PROTOCOL,
						Constants.PACKAGE_PROTOCOL_XML, &quot;0&quot;, e);
<span class="nc" id="L175">			}</span>

		}

<span class="nc" id="L179">		synchronizeRequestFields(source);</span>
<span class="nc" id="L180">	}</span>

	/**
	 * Returns the response XML data as a &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 */
	public Document getResponseDocument()
	{
<span class="nc" id="L187">		return mXMLResponseDocument;</span>
	}

	/**
	 * Sets the response XML data as a &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 */
	public void setResponseDocument(Document doc, XBUSSystem destination)
			throws XException
	{
<span class="nc" id="L196">		mXMLResponseDocument = doc;</span>

<span class="nc bnc" id="L198" title="All 2 branches missed.">		if (mXMLResponseDocument != null)</span>
		{
<span class="nc" id="L200">			DocumentType docType = mXMLResponseDocument.getDoctype();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if (docType != null)</span>
			{
<span class="nc" id="L203">				mResponseDTDSystemID = docType.getSystemId();</span>
			}
		}

<span class="nc" id="L207">		synchronizeResponseFields(destination);</span>
<span class="nc" id="L208">	}</span>

	/**
	 * @see net.sf.xbus.protocol.ObjectMessage#getRequestObject(net.sf.xbus.base.xbussystem.XBUSSystem)
	 */
	public Object getRequestObject(XBUSSystem system) throws XException
	{
<span class="nc" id="L215">		return getRequestDocument(system);</span>
	}

	/**
	 * @see net.sf.xbus.protocol.ObjectMessage#setRequestObject(java.lang.Object,
	 *      net.sf.xbus.base.xbussystem.XBUSSystem)
	 */
	public void setRequestObject(Object object, XBUSSystem source)
			throws XException
	{
<span class="nc" id="L225">		setRequestDocument((Document) object, source);</span>
<span class="nc" id="L226">	}</span>

	/**
	 * @see net.sf.xbus.protocol.ObjectMessage#getResponseObject()
	 */
	public Object getResponseObject() throws XException
	{
<span class="nc" id="L233">		return getResponseDocument();</span>
	}

	/**
	 * @see net.sf.xbus.protocol.ObjectMessage#setResponseObject(java.lang.Object,
	 *      net.sf.xbus.base.xbussystem.XBUSSystem)
	 */
	public void setResponseObject(Object object, XBUSSystem destination)
			throws XException
	{
<span class="nc" id="L243">		setResponseDocument((Document) object, destination);</span>
<span class="nc" id="L244">	}</span>

	/**
	 * After setting the request data, both &lt;code&gt;setRequestText&lt;/code&gt; and
	 * &lt;code&gt;setRequestDocument&lt;/code&gt;, some fields of the
	 * &lt;code&gt;Message&lt;/code&gt; must be synchronized with the request data.
	 * &lt;p&gt;
	 * &lt;ul&gt;
	 * &lt;li&gt;&lt;b&gt;Id: &lt;/b&gt;When the Id is found in the request data, it must be
	 * copied to the &lt;code&gt;Message&lt;/code&gt;. When it is not found, the value
	 * from the &lt;code&gt;Message&lt;/code&gt; must be copied to the request data.
	 * &lt;li&gt;&lt;b&gt;Function: &lt;/b&gt;The value for the function must be read from the
	 * request data and must be set in the &lt;code&gt;Message&lt;/code&gt;.
	 * &lt;li&gt;&lt;b&gt;Source: &lt;/b&gt;Must be copied from the &lt;code&gt;Message&lt;/code&gt; object
	 * to the request data, to be sure that it is set correct.
	 * &lt;li&gt;&lt;b&gt;Request Timestamp: &lt;/b&gt;Must be copied from the
	 * &lt;code&gt;Message&lt;/code&gt; object to the request data.
	 * &lt;/ul&gt;
	 */
	abstract protected void synchronizeRequestFields(XBUSSystem system)
			throws XException;

	/**
	 * After setting the response data, both &lt;code&gt;setResponseText&lt;/code&gt; and
	 * &lt;code&gt;setResponseDocument&lt;/code&gt;, some fields of the
	 * &lt;code&gt;Message&lt;/code&gt; must be synchronized with the response data.
	 * &lt;p&gt;
	 * &lt;ul&gt;
	 * &lt;li&gt;&lt;b&gt;Returncode: &lt;/b&gt;The value of the returncode must be extracted out
	 * of the response data.
	 * &lt;li&gt;&lt;b&gt;Errorcode: &lt;/b&gt;When an error has occured, the value for the
	 * errorcode can be read out of the response data, if it is included there.
	 * &lt;li&gt;&lt;b&gt;Errortext: &lt;/b&gt;When an error has occured, the value for the
	 * errortext can be read out of the response data, if it is included there.
	 * &lt;/ul&gt;
	 */
	abstract protected void synchronizeResponseFields(XBUSSystem system)
			throws XException;

	/**
	 * Parses the given XML string.
	 */
	protected Document parseXML(String xml, XBUSSystem system)
			throws XException
	{
<span class="nc" id="L289">		return XMLHelper.parseXML(xml, getShortname(), system.getName());</span>
	}

	/**
	 * Returns an adequate &lt;code&gt;DocumentBuilder&lt;/code&gt; for this message
	 */
	protected DocumentBuilder getDocumentBuilder(XBUSSystem system)
			throws XException
	{
<span class="nc" id="L298">		return XMLHelper.getDocumentBuilder(getShortname(), system.getName());</span>
	}

	/**
	 * Serializes the given &lt;code&gt;org.w3c.dom.Document&lt;/code&gt;.
	 */
	static protected String serializeXML(Document doc, String systemID)
			throws XException
	{
<span class="nc" id="L307">		return XMLHelper.serializeXML(doc, systemID);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>