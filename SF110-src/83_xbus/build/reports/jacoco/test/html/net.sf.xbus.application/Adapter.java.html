<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Adapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.application</a> &gt; <span class="el_source">Adapter.java</span></div><h1>Adapter.java</h1><pre class="source lang-java linenums">package net.sf.xbus.application;

import java.util.Date;
import java.util.List;
import java.util.Vector;

import net.sf.xbus.base.bytearraylist.ByteArrayList;
import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.core.trace.Trace;
import net.sf.xbus.base.deletedMessageStore.DeletedMessageStore;
import net.sf.xbus.base.journal.Journal;
import net.sf.xbus.base.xbussystem.XBUSSystem;
import net.sf.xbus.protocol.Message;
import net.sf.xbus.protocol.MessageFactory;
import net.sf.xbus.protocol.ObjectMessage;
import net.sf.xbus.protocol.TextMessage;
import net.sf.xbus.protocol.XMLMessage;
import net.sf.xbus.protocol.simple.SimpleTextMessage;
import net.sf.xbus.technical.ObjectSender;
import net.sf.xbus.technical.Sender;
import net.sf.xbus.technical.SenderFactory;
import net.sf.xbus.technical.TextSender;

import org.w3c.dom.Document;

/**
 * The &lt;code&gt;Adapter&lt;/code&gt; is called from receivers. He is responsible for
 * creating the appropriate &lt;code&gt;Message&lt;/code&gt; object, calling the
 * appropriate object and method of the application layer and logging the call
 * in the &lt;code&gt;DBJournal&lt;/code&gt;.
 */
<span class="nc" id="L34">public class Adapter</span>
{
<span class="nc" id="L36">	private String mReturncode = Constants.RC_NOK;</span>

<span class="nc" id="L38">	private Object mResponse = null;</span>
<span class="nc" id="L39">	private String mErrormessage = null;</span>

	/**
	 * Sends a message to a sender (which was generated by the
	 * {@link net.sf.xbus.technical.SenderFactory}).
	 * &lt;p&gt;
	 * 
	 * @param message the message to be sent
	 * @param destination the destination where the message shall be sent to
	 * @throws XException if something goes wrong
	 */
	static public void callSender(Message message, XBUSSystem destination)
			throws XException
	{
		try
		{
<span class="nc" id="L55">			Sender sender = SenderFactory.createSender(destination);</span>

<span class="nc" id="L57">			String senderType = Configuration.getInstance().getValueOptional(</span>
<span class="nc" id="L58">					&quot;System&quot;, destination.getName(), &quot;Type&quot;);</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">			if (senderType == null)</span>
			{
<span class="nc" id="L61">				senderType = sender.getType();</span>
			}

<span class="nc bnc" id="L64" title="All 2 branches missed.">			if (Constants.TYPE_TEXT.equals(senderType))</span>
			{
<span class="nc" id="L66">				boolean sendMessage = true;</span>
<span class="nc" id="L67">				String request = ((TextMessage) message)</span>
<span class="nc" id="L68">						.getRequestText(destination);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">				if (isEmpty(request))</span>
				{
<span class="nc" id="L71">					String onEmpty = retrieveOnEmpty(destination.getName(),</span>
							true);
<span class="nc bnc" id="L73" title="All 2 branches missed.">					if (onEmpty.equals(Constants.READ_IGNORE))</span>
					{
<span class="nc" id="L75">						sendMessage = false;</span>
					}
<span class="nc bnc" id="L77" title="All 2 branches missed.">					else if (onEmpty.equals(Constants.READ_PROCESS))</span>
					{
<span class="nc" id="L79">						sendMessage = true;</span>
					}
<span class="nc bnc" id="L81" title="All 2 branches missed.">					else if (onEmpty.equals(Constants.READ_ERROR))</span>
					{
<span class="nc" id="L83">						throw new XException(Constants.LOCATION_EXTERN,</span>
								Constants.LAYER_APPLICATION,
								Constants.PACKAGE_APPLICATION_ADAPTER, &quot;4&quot;);
					}
				}

<span class="nc bnc" id="L89" title="All 2 branches missed.">				if (sendMessage)</span>
				{
					// Send the message to the destination system
					// The message is already transformed and must only be
					// retrieved.
					// Structure information for message serialisation is due to
					// the
					// destination system.
<span class="nc" id="L97">					TextSender textsender = (TextSender) sender;</span>

<span class="nc" id="L99">					String resData = textsender.execute(message.getFunction(),</span>
							request);

<span class="nc" id="L102">					((TextMessage) message).setResponseText(resData,</span>
							destination);
<span class="nc" id="L104">					message.setResponseTimestamp(new Date());</span>
				}
<span class="nc" id="L106">			}</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">			else if (Constants.TYPE_OBJECT.equals(senderType))</span>
			{
<span class="nc" id="L109">				boolean sendMessage = true;</span>
<span class="nc" id="L110">				Object request = ((ObjectMessage) message)</span>
<span class="nc" id="L111">						.getRequestObject(destination);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">				if (isEmpty(request))</span>
				{
<span class="nc" id="L114">					String onEmpty = retrieveOnEmpty(destination.getName(),</span>
							true);
<span class="nc bnc" id="L116" title="All 2 branches missed.">					if (onEmpty.equals(Constants.READ_IGNORE))</span>
					{
<span class="nc" id="L118">						sendMessage = false;</span>
					}
<span class="nc bnc" id="L120" title="All 2 branches missed.">					else if (onEmpty.equals(Constants.READ_PROCESS))</span>
					{
<span class="nc" id="L122">						sendMessage = true;</span>
					}
<span class="nc bnc" id="L124" title="All 2 branches missed.">					else if (onEmpty.equals(Constants.READ_ERROR))</span>
					{
<span class="nc" id="L126">						throw new XException(Constants.LOCATION_EXTERN,</span>
								Constants.LAYER_APPLICATION,
								Constants.PACKAGE_APPLICATION_ADAPTER, &quot;4&quot;);
					}
				}

<span class="nc bnc" id="L132" title="All 2 branches missed.">				if (sendMessage)</span>
				{
					// Send the message to the destination system
					// The message is already transformed and must only be
					// retrieved.
					// Structure information for message serialisation is due to
					// the
					// destination system.
<span class="nc" id="L140">					ObjectSender objectsender = (ObjectSender) sender;</span>

<span class="nc" id="L142">					Object resData = objectsender.execute(</span>
<span class="nc" id="L143">							message.getFunction(), ((ObjectMessage) message)</span>
<span class="nc" id="L144">									.getRequestObject(destination));</span>

<span class="nc" id="L146">					((ObjectMessage) message).setResponseObject(resData,</span>
							destination);
<span class="nc" id="L148">					message.setResponseTimestamp(new Date());</span>
				}
<span class="nc" id="L150">			}</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">			else if (Constants.TYPE_XML.equals(senderType))</span>
			{
<span class="nc" id="L153">				boolean sendMessage = true;</span>
<span class="nc" id="L154">				Object request = ((ObjectMessage) message)</span>
<span class="nc" id="L155">						.getRequestObject(destination);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">				if (isEmpty(request))</span>
				{
<span class="nc" id="L158">					String onEmpty = retrieveOnEmpty(destination.getName(),</span>
							true);
<span class="nc bnc" id="L160" title="All 2 branches missed.">					if (onEmpty.equals(Constants.READ_IGNORE))</span>
					{
<span class="nc" id="L162">						sendMessage = false;</span>
					}
<span class="nc bnc" id="L164" title="All 2 branches missed.">					else if (onEmpty.equals(Constants.READ_PROCESS))</span>
					{
<span class="nc" id="L166">						sendMessage = true;</span>
					}
<span class="nc bnc" id="L168" title="All 2 branches missed.">					else if (onEmpty.equals(Constants.READ_ERROR))</span>
					{
<span class="nc" id="L170">						throw new XException(Constants.LOCATION_EXTERN,</span>
								Constants.LAYER_APPLICATION,
								Constants.PACKAGE_APPLICATION_ADAPTER, &quot;4&quot;);
					}
				}

<span class="nc bnc" id="L176" title="All 2 branches missed.">				if (sendMessage)</span>
				{
					// Send the message to the destination system
					// The message is already transformed and must only be
					// retrieved.
<span class="nc" id="L181">					ObjectSender objectsender = (ObjectSender) sender;</span>

<span class="nc" id="L183">					Document resData = (Document) objectsender.execute(message</span>
<span class="nc" id="L184">							.getFunction(), ((XMLMessage) message)</span>
<span class="nc" id="L185">							.getRequestDocument(destination));</span>

<span class="nc" id="L187">					((XMLMessage) message).setResponseDocument(resData,</span>
							destination);
<span class="nc" id="L189">					message.setResponseTimestamp(new Date());</span>
				}
<span class="nc" id="L191">			}</span>
			else
			{
<span class="nc" id="L194">				List params = new Vector();</span>
<span class="nc" id="L195">				params.add(sender.getType());</span>
<span class="nc" id="L196">				throw new XException(Constants.LOCATION_INTERN,</span>
						Constants.LAYER_APPLICATION,
						Constants.PACKAGE_APPLICATION_ADAPTER, &quot;1&quot;, params);
			}
		}
<span class="nc" id="L201">		catch (Exception t)</span>
		{
<span class="nc" id="L203">			message.setResponseTimestamp(new Date());</span>
<span class="nc" id="L204">			message.setReturncode(Constants.RC_NOK);</span>
<span class="nc" id="L205">			message.setErrortext(t.getMessage());</span>
<span class="nc" id="L206">			Trace.error(t);</span>
<span class="nc" id="L207">		}</span>

		/* Logging of the sending-activity into the journal. */
		try
		{
<span class="nc" id="L212">			new Journal().log('S', destination, message);</span>
		}
<span class="nc" id="L214">		catch (Exception t)</span>
		{
<span class="nc" id="L216">			throw new XException(Constants.LOCATION_INTERN,</span>
					Constants.LAYER_APPLICATION,
					Constants.PACKAGE_APPLICATION_ADAPTER, &quot;0&quot;, t);
<span class="nc" id="L219">		}</span>
<span class="nc" id="L220">	}</span>

	/**
	 * Creates the appropriate &lt;code&gt;Message&lt;/code&gt; object by calling the
	 * &lt;code&gt;MessageFactory&lt;/code&gt; and calls the appropriate object and method
	 * of the application layer by calling the &lt;code&gt;ApplicationFactory&lt;/code&gt;.
	 * Finally the &lt;code&gt;DBJournal&lt;/code&gt; class is called for logging of the
	 * call.
	 * &lt;p&gt;
	 * The resulting returncode and response-string can be requested afterwards
	 * with dedicated methods in this class.
	 */
	public void callApplication(XBUSSystem source, Object request,
			String messageType)
	{
		/*
		 * Setting values for the DeletedMessageStore
		 */
<span class="nc" id="L238">		DeletedMessageStore dms = DeletedMessageStore.getInstance();</span>
<span class="nc" id="L239">		dms.setMessage(request);</span>
<span class="nc" id="L240">		dms.setSystem(source);</span>

<span class="nc" id="L242">		mReturncode = Constants.RC_NOK;</span>
<span class="nc" id="L243">		Message call = null;</span>
		try
		{
			try
			{
				// Zero: check handling of empty messages
<span class="nc bnc" id="L249" title="All 2 branches missed.">				if (!checkRequest(source, request))</span>
				{
					/*
					 * Request shall not be processed but ignored
					 */
<span class="nc" id="L254">					call = new SimpleTextMessage(source);</span>
					try
					{
<span class="nc" id="L257">						((TextMessage) call).setRequestText(request.toString(),</span>
								source);
					}
<span class="nc" id="L260">					catch (XException e)</span>
					{
						// This problem has already been traced
<span class="nc" id="L263">					}</span>
<span class="nc" id="L264">					call.setReturncode(Constants.RC_OK);</span>
				}
				else
				{
					/*
					 * Request shall be processed
					 */

					// First: create the message obejct
<span class="nc" id="L273">					call = MessageFactory.createApplicationMessage(source);</span>

					// Second: initialise the message object by pasting in the
					// request
					// as content,
					// then perfom the call the appropriate application object
					// and record the response
<span class="nc bnc" id="L280" title="All 2 branches missed.">					if (Constants.TYPE_TEXT.equals(messageType))</span>
					{
<span class="nc" id="L282">						((TextMessage) call).setRequestText((String) request,</span>
								source);
<span class="nc" id="L284">						ApplicationFactory.callApplication(call);</span>
						// Get the response.
						// The message is already transformed and structure
						// information
						// for serialising is attached to the source system.
<span class="nc" id="L289">						mResponse = ((TextMessage) call).getResponseText();</span>
					}
<span class="nc bnc" id="L291" title="All 2 branches missed.">					else if (Constants.TYPE_OBJECT.equals(messageType))</span>
					{
<span class="nc" id="L293">						((ObjectMessage) call)</span>
<span class="nc" id="L294">								.setRequestObject(request, source);</span>
<span class="nc" id="L295">						ApplicationFactory.callApplication(call);</span>
						// Get the response.
						// The message is already transformed and structure
						// information
						// for serialising is attached to the source system.
<span class="nc" id="L300">						mResponse = ((ObjectMessage) call).getResponseObject();</span>
					}
				}
			}
<span class="nc" id="L304">			catch (Exception t)</span>
			{
				/*
				 * Inner try-catch block catches all exceptions and converts
				 * them to XExceptions if necessary
				 */
<span class="nc bnc" id="L310" title="All 2 branches missed.">				if (t instanceof XException)</span>
				{
<span class="nc" id="L312">					throw (XException) t;</span>
				}
				else
				{
<span class="nc" id="L316">					throw new XException(Constants.LOCATION_INTERN,</span>
							Constants.LAYER_APPLICATION,
							Constants.PACKAGE_APPLICATION_ADAPTER, &quot;0&quot;, t);
				}
<span class="nc" id="L320">			}</span>
		}
<span class="nc" id="L322">		catch (XException e)</span>
		{
			/*
			 * Outer try-catch block handles the XException
			 */
<span class="nc bnc" id="L327" title="All 2 branches missed.">			if (call == null)</span>
			{
<span class="nc bnc" id="L329" title="All 2 branches missed.">				if (request == null)</span>
				{
<span class="nc" id="L331">					request = &quot;&lt;null&gt;&quot;;</span>
				}
<span class="nc" id="L333">				call = new SimpleTextMessage(source);</span>
				try
				{
<span class="nc" id="L336">					((TextMessage) call).setRequestText(request.toString(),</span>
							source);
				}
<span class="nc" id="L339">				catch (XException e1)</span>
				{
					// This problem has already been traced
<span class="nc" id="L342">				}</span>
			}
<span class="nc" id="L344">			call.setReturncode(Constants.RC_NOK);</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">			if ((call.getErrortext() == null)</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">					|| (call.getErrortext().length() == 0))</span>
			{
<span class="nc" id="L348">				call.setErrortext(e.getMessage());</span>
			}
		}
		finally
		{
<span class="nc" id="L353">			mReturncode = call.getReturncode();</span>
<span class="nc" id="L354">			mErrormessage = call.getErrortext();</span>

			try
			{
				// Logging of the receiving-activity into the journal and
				// closing the
				// connection to the database.
<span class="nc" id="L361">				call.setResponseTimestamp(new Date());</span>
<span class="nc" id="L362">				Journal journal = new Journal();</span>
<span class="nc" id="L363">				journal.log('R', source, call);</span>
<span class="nc" id="L364">				journal.commit();</span>
			} // try
<span class="nc" id="L366">			catch (Exception t)</span>
			{
<span class="nc" id="L368">				Trace.error(t);</span>
<span class="nc" id="L369">			} // catch (Throwable t)</span>
		}
<span class="nc" id="L371">	} // callApplication(XBUSSystem source, String request)</span>

	/**
	 * 
	 * @return
	 */
	private boolean checkRequest(XBUSSystem source, Object request)
			throws XException
	{
<span class="nc" id="L380">		boolean result = true;</span>

		/*
		 * Request == null will never be processed
		 */
		// if (request == null)
		// {
		// throw new XException(Constants.LOCATION_EXTERN,
		// Constants.LAYER_APPLICATION,
		// Constants.PACKAGE_APPLICATION_ADAPTER, &quot;2&quot;);
		// }
		/*
		 * Check if empty requests shall be processed
		 */
<span class="nc bnc" id="L394" title="All 2 branches missed.">		if (isEmpty(request))</span>
		{
<span class="nc" id="L396">			String onEmpty = retrieveOnEmpty(source.getName(), false);</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">			if (onEmpty.equals(Constants.READ_ERROR))</span>
			{
<span class="nc" id="L399">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_APPLICATION,
						Constants.PACKAGE_APPLICATION_ADAPTER, &quot;4&quot;);
			}
<span class="nc bnc" id="L403" title="All 2 branches missed.">			else if (onEmpty.equals(Constants.READ_IGNORE))</span>
			{
<span class="nc" id="L405">				result = false;</span>
			}
		}

<span class="nc" id="L409">		return result;</span>
	}

	private static boolean isEmpty(Object request)
	{
<span class="nc bnc" id="L414" title="All 2 branches missed.">		if (request == null)</span>
		{
<span class="nc" id="L416">			return true;</span>
		}

<span class="nc bnc" id="L419" title="All 4 branches missed.">		if ((request instanceof String) &amp;&amp; (((String) request).length() == 0))</span>
		{
<span class="nc" id="L421">			return true;</span>
		}
<span class="nc bnc" id="L423" title="All 2 branches missed.">		if ((request instanceof ByteArrayList)</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">				&amp;&amp; (((ByteArrayList) request).length() == 0))</span>
		{
<span class="nc" id="L426">			return true;</span>
		}
<span class="nc" id="L428">		return false;</span>

	}

	/**
	 * Reads the action which should happen with the file is empty for the for
	 * the given system name from the standard configuration and checks its
	 * conformity with the allowed ones:
	 * &lt;p&gt;
	 * &lt;dl&gt;
	 * &lt;dd&gt;&lt;code&gt;Error&lt;/code&gt; &amp;nbsp;-throw a XException
	 * &lt;dd&gt;&lt;code&gt;Ignore&lt;/code&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;- ignore the request
	 * &lt;dd&gt;&lt;code&gt;Process&lt;/code&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;- process normally
	 * &lt;/dl&gt;
	 */
	static private String retrieveOnEmpty(String system, boolean sender)
			throws XException
	{
<span class="nc" id="L446">		String onEmpty = Configuration.getInstance().getValueOptional(</span>
				Constants.CHAPTER_SYSTEM, system, &quot;OnEmpty&quot;);
<span class="nc bnc" id="L448" title="All 2 branches missed.">		if (onEmpty == null)</span>
		{
<span class="nc bnc" id="L450" title="All 2 branches missed.">			if (sender)</span>
			{
<span class="nc" id="L452">				onEmpty = Constants.READ_PROCESS;</span>
			}
			else
			{
<span class="nc" id="L456">				onEmpty = Constants.READ_IGNORE;</span>
			}
		}
<span class="nc bnc" id="L459" title="All 2 branches missed.">		if (!onEmpty.equals(Constants.READ_ERROR)</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">				&amp;&amp; !onEmpty.equals(Constants.READ_IGNORE)</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">				&amp;&amp; !onEmpty.equals(Constants.READ_PROCESS))</span>
		{
<span class="nc" id="L463">			List params = new Vector();</span>
<span class="nc" id="L464">			params.add(onEmpty);</span>
<span class="nc" id="L465">			throw new XException(Constants.LOCATION_INTERN,</span>
					Constants.LAYER_APPLICATION,
					Constants.PACKAGE_APPLICATION_ADAPTER, &quot;3&quot;, params);
		}
<span class="nc" id="L469">		return onEmpty;</span>
	}

	/**
	 * After calling the application layer, the receiver can query the resulting
	 * returncode.
	 */
	public String getReturncode()
	{
<span class="nc" id="L478">		return mReturncode;</span>
	}

	/**
	 * After calling the application layer, the receiver can query the resulting
	 * response.
	 */
	public Object getResponse()
	{
<span class="nc" id="L487">		return mResponse;</span>
	}

	/**
	 * After calling the application layer, the receiver can query the resulting
	 * error message.
	 */
	public String getErrormessage()
	{
<span class="nc" id="L496">		return mErrormessage;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>