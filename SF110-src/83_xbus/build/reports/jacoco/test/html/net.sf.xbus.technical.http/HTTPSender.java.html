<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HTTPSender.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.technical.http</a> &gt; <span class="el_source">HTTPSender.java</span></div><h1>HTTPSender.java</h1><pre class="source lang-java linenums">package net.sf.xbus.technical.http;

import java.io.IOException;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.List;
import java.util.Vector;

import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.xbussystem.XBUSSystem;
import net.sf.xbus.technical.Sender;
import net.sf.xbus.technical.TextSender;

import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.HttpException;
import org.apache.commons.httpclient.HttpMethod;
import org.apache.commons.httpclient.HttpState;
import org.apache.commons.httpclient.UsernamePasswordCredentials;
import org.apache.commons.httpclient.auth.AuthScope;
import org.apache.commons.httpclient.methods.PostMethod;
import org.apache.commons.httpclient.methods.StringRequestEntity;
import org.apache.commons.httpclient.params.HttpClientParams;
import org.apache.commons.httpclient.protocol.Protocol;
import org.apache.commons.io.IOUtils;

/**
 * The &lt;code&gt;HTTPSender&lt;/code&gt; sends a message to an URL.
 * &lt;p&gt;
 * For sending &lt;code&gt;SOAPMessages&lt;/code&gt; there are two special features:
 * &lt;ul&gt;
 * &lt;li&gt;The HTTP Header contains an additional entry &lt;code&gt;SOAPAction&lt;/code&gt;,
 * referencing the function.&lt;/li&gt;
 * &lt;li&gt;When the other side sends a returncode other than &lt;code&gt;OK&lt;/code&gt;,
 * the &lt;code&gt;HTTPSender&lt;/code&gt; reads the error stream as the response.&lt;/li&gt;
 * &lt;/ul&gt;
 */
public class HTTPSender implements Sender, TextSender
{

<span class="nc" id="L42">	XBUSSystem mDestination = null;</span>

<span class="nc" id="L44">	String mContentType = null;</span>

	/**
	 * Stores the destination for later use.
	 */
	public HTTPSender(XBUSSystem destination)
<span class="nc" id="L50">	{</span>
<span class="nc" id="L51">		mDestination = destination;</span>
<span class="nc" id="L52">	}</span>

	/**
	 * Sends the &lt;code&gt;callData&lt;/code&gt; to the system. &lt;code&gt;function&lt;/code&gt;
	 * is ignored.
	 * 
	 * @return &lt;code&gt;null&lt;/code&gt;
	 */
	public String execute(String function, String callData) throws XException
	{
<span class="nc" id="L62">		PostMethod method = initialize(function, null);</span>

<span class="nc bnc" id="L64" title="All 2 branches missed.">		if (callData == null)</span>
<span class="nc" id="L65">			callData = &quot;&quot;;</span>

<span class="nc" id="L67">		method.setRequestEntity(new StringRequestEntity(callData));</span>
		// method.setRequestContentLength(callData.length());
		// method.setRequestBody(callData);

<span class="nc" id="L71">		return sendMessage(method);</span>
	}

	protected PostMethod initialize(String function, String url)
			throws XException
	{
<span class="nc" id="L77">		Configuration config = Configuration.getInstance();</span>

		/*
		 * HTTPParameterSender doesn`t have a Content-Type, all other
		 * HTTPxxxSenders must have that parameter
		 */
<span class="nc bnc" id="L83" title="All 2 branches missed.">		if (!(this instanceof HTTPParameterSender))</span>
		{
<span class="nc" id="L85">			mContentType = config.getValue(Constants.CHAPTER_SYSTEM,</span>
<span class="nc" id="L86">					mDestination.getName(), &quot;Content-Type&quot;);</span>
		}

		/*
		 * If no URL is given, we must have it in the configuration
		 */
<span class="nc bnc" id="L92" title="All 2 branches missed.">		if (url == null)</span>
		{
<span class="nc" id="L94">			url = config.getValue(Constants.CHAPTER_SYSTEM, mDestination</span>
<span class="nc" id="L95">					.getName(), &quot;URL&quot;);</span>
		}
<span class="nc" id="L97">		url = mDestination.replaceAllMarkers(url)[0];</span>

<span class="nc" id="L99">		setKeystore(url);</span>

		/*
		 * Self-signed certificates SHOULD NOT be used for productive systems
		 * due to security reasons, unless it is a concious decision and you are
		 * perfectly aware of security implications of accepting self-signed
		 * certificates.
		 */
<span class="nc" id="L107">		boolean allowSelfSignedCertificate = config.getValueAsBooleanOptional(</span>
<span class="nc" id="L108">				Constants.CHAPTER_SYSTEM, mDestination.getName(),</span>
				&quot;AllowSelfSignedCertificate&quot;);
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (allowSelfSignedCertificate)</span>
		{
<span class="nc" id="L112">			Protocol.registerProtocol(&quot;https&quot;, new Protocol(&quot;https&quot;,</span>
					new EasySSLProtocolSocketFactory(), 8443));
		}

<span class="nc" id="L116">		PostMethod method = new PostMethod(url);</span>

<span class="nc" id="L118">		setRequestHeaders(function, method);</span>

<span class="nc" id="L120">		return method;</span>
	}

	protected void setRequestHeaders(String function, PostMethod method)
			throws XException
	{
<span class="nc bnc" id="L126" title="All 2 branches missed.">		if (mContentType != null)</span>
		{
<span class="nc" id="L128">			method.setRequestHeader(&quot;Content-Type&quot;, mContentType);</span>
		}

<span class="nc bnc" id="L131" title="All 2 branches missed.">		if (isSOAPMessage())</span>
		{
<span class="nc" id="L133">			method.setRequestHeader(&quot;SOAPAction&quot;, function);</span>
		}
<span class="nc" id="L135">	}</span>

	protected String sendMessage(PostMethod method) throws XException
	{
<span class="nc" id="L139">		String response = null;</span>
<span class="nc" id="L140">		int statusCode = 0;</span>

		try
		{
<span class="nc" id="L144">			HttpClient client = new HttpClient();</span>
<span class="nc" id="L145">			setAuthentication(client, method);</span>
<span class="nc" id="L146">			statusCode = client.executeMethod(method);</span>

<span class="nc" id="L148">			response = IOUtils.toString(method.getResponseBodyAsStream(),</span>
<span class="nc" id="L149">					method.getResponseCharSet());</span>

<span class="nc" id="L151">			method.releaseConnection();</span>

<span class="nc bnc" id="L153" title="All 6 branches missed.">			if (((statusCode &lt; 200) || statusCode &gt; 299) &amp;&amp; (!isSOAPMessage()))</span>
			{
<span class="nc" id="L155">				List params = new Vector();</span>
<span class="nc" id="L156">				params.add(String.valueOf(statusCode));</span>
<span class="nc" id="L157">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_HTTP, &quot;1&quot;, params);
			}
		}
<span class="nc" id="L162">		catch (HttpException e)</span>
		{
<span class="nc" id="L164">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_HTTP, &quot;0&quot;, e);
		}
<span class="nc" id="L168">		catch (IOException e)</span>
		{
<span class="nc" id="L170">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_HTTP, &quot;0&quot;, e);
<span class="nc" id="L173">		}</span>
<span class="nc" id="L174">		return response;</span>
	}

	private boolean isSOAPMessage() throws XException
	{
<span class="nc" id="L179">		Configuration config = Configuration.getInstance();</span>

<span class="nc" id="L181">		String message = config.getValue(Constants.CHAPTER_SYSTEM, mDestination</span>
<span class="nc" id="L182">				.getName(), &quot;Message&quot;);</span>
<span class="nc" id="L183">		boolean isSOAPMessage = (&quot;SOAPMessage&quot;.equals(message));</span>

<span class="nc" id="L185">		return isSOAPMessage;</span>
	}

	private void setKeystore(String urlName) throws XException
	{
<span class="nc" id="L190">		Configuration config = Configuration.getInstance();</span>

		try
		{
<span class="nc" id="L194">			URL url = new URL(urlName);</span>

<span class="nc bnc" id="L196" title="All 2 branches missed.">			if (&quot;https&quot;.equals(url.getProtocol())</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">					&amp;&amp; (System.getProperty(&quot;javax.net.ssl.trustStore&quot;) == null))</span>
			{
<span class="nc" id="L199">				System.setProperty(&quot;javax.net.ssl.trustStore&quot;,</span>
						Constants.XBUS_ETC
<span class="nc" id="L201">								+ config.getValue(&quot;Connection&quot;, &quot;HTTP&quot;,</span>
										&quot;Keystore&quot;));
			}
		}
<span class="nc" id="L205">		catch (MalformedURLException e)</span>
		{
<span class="nc" id="L207">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_HTTP, &quot;0&quot;, e);
<span class="nc" id="L210">		}</span>
<span class="nc" id="L211">	}</span>

	private void setAuthentication(HttpClient client, HttpMethod method)
			throws XException
	{
<span class="nc" id="L216">		Configuration config = Configuration.getInstance();</span>
<span class="nc" id="L217">		String user = config.getValueOptional(Constants.CHAPTER_SYSTEM,</span>
<span class="nc" id="L218">				mDestination.getName(), &quot;User&quot;);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">		if (user != null)</span>
		{
<span class="nc" id="L221">			String realm = config.getValueOptional(Constants.CHAPTER_SYSTEM,</span>
<span class="nc" id="L222">					mDestination.getName(), &quot;Realm&quot;);</span>
<span class="nc" id="L223">			String password = config.getValueOptional(Constants.CHAPTER_SYSTEM,</span>
<span class="nc" id="L224">					mDestination.getName(), &quot;Password&quot;);</span>
<span class="nc" id="L225">			HttpState state = client.getState();</span>
<span class="nc" id="L226">			state.setCredentials(</span>
<span class="nc" id="L227">					new AuthScope(client.getHostConfiguration().getHost(),</span>
<span class="nc" id="L228">							client.getHostConfiguration().getPort(), realm),</span>
					new UsernamePasswordCredentials(user, password));
<span class="nc" id="L230">			HttpClientParams params = new HttpClientParams();</span>
<span class="nc" id="L231">			params.setAuthenticationPreemptive(config.getValueAsBooleanOptional(</span>
<span class="nc" id="L232">					Constants.CHAPTER_SYSTEM, mDestination.getName(),</span>
					&quot;AuthenticationPreemptive&quot;));
<span class="nc" id="L234">			client.setParams(params);</span>
		}
<span class="nc" id="L236">	}</span>

	public String getType()
	{
<span class="nc" id="L240">		return Constants.TYPE_TEXT;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>