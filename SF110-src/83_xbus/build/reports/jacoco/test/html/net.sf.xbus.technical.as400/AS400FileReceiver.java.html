<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AS400FileReceiver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.technical.as400</a> &gt; <span class="el_source">AS400FileReceiver.java</span></div><h1>AS400FileReceiver.java</h1><pre class="source lang-java linenums">package net.sf.xbus.technical.as400;

import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.Vector;

import net.sf.xbus.application.Adapter;
import net.sf.xbus.application.PostProcessor;
import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.TAManager;
import net.sf.xbus.base.core.TAResource;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.core.trace.Trace;
import net.sf.xbus.base.notifyerror.NotifyError;
import net.sf.xbus.base.xbussystem.XBUSSystem;
import net.sf.xbus.technical.Receiver;
import net.sf.xbus.technical.ReceiverSingleInterface;

import com.ibm.as400.access.AS400;
import com.ibm.as400.access.AS400File;
import com.ibm.as400.access.AS400FileRecordDescription;
import com.ibm.as400.access.CharConverter;
import com.ibm.as400.access.IFSFile;
import com.ibm.as400.access.ProgramParameter;
import com.ibm.as400.access.QSYSObjectPathName;
import com.ibm.as400.access.Record;
import com.ibm.as400.access.RecordFormat;
import com.ibm.as400.access.SequentialFile;

/**
 * The &lt;code&gt;AS400FileReceiver&lt;/code&gt; receives a request, reads the files on
 * the AS400 machines into tstrings and calls the application layer.
 * 
 * &lt;p&gt;
 * &lt;b&gt;Configuration:&lt;/b&gt;
 * &lt;p&gt;
 * &lt;table border&gt;
 * &lt;tr&gt;
 * &lt;th&gt;Chapter&lt;/th&gt;
 * &lt;th&gt;Section&lt;/th&gt;
 * &lt;th&gt;Key&lt;/th&gt;
 * &lt;th&gt;Content&lt;/th&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 * &lt;td&gt;System&lt;/td&gt;
 * &lt;td&gt;Interface&lt;/td&gt;
 * &lt;td&gt;Filename&lt;/td&gt;
 * &lt;td&gt;Path name that represents an object in the &lt;br&gt;
 * QSYS library file system on the AS400 machine&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 * &lt;td&gt;System&lt;/td&gt;
 * &lt;td&gt;Interface&lt;/td&gt;
 * &lt;td&gt;FinalResolution&lt;/td&gt;
 * &lt;td&gt;Three actions are possible with the file after processing: &lt;br&gt;
 * &lt;b&gt;&lt;i&gt;preserve, rename&lt;/i&gt;&lt;/b&gt; or&lt;b&gt;&lt;i&gt; delete&lt;/i&gt;&lt;/b&gt;&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 * &lt;td&gt;System&lt;/td&gt;
 * &lt;td&gt;Interface&lt;/td&gt;
 * &lt;td&gt;OnError&lt;/td&gt;
 * &lt;td&gt;Three actions are be possible with the file when an unrecoverable error
 * has occured: &lt;br&gt;
 * &lt;b&gt;&lt;i&gt;preserve, rename&lt;/i&gt;&lt;/b&gt; or&lt;b&gt;&lt;i&gt; delete&lt;/i&gt;&lt;/b&gt;&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 * &lt;td&gt;System&lt;/td&gt;
 * &lt;td&gt;Interface&lt;/td&gt;
 * &lt;td&gt;Encoding&lt;/td&gt;
 * &lt;td&gt;Specified character encoding of the interface&lt;i&gt; (Optional)&lt;/i&gt;&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 * &lt;td&gt;Base&lt;/td&gt;
 * &lt;td&gt;ReceiverTimeout&lt;/td&gt;
 * &lt;td&gt;Seconds&lt;/td&gt;
 * &lt;td&gt;Global timeout value for AS400FileReceiver.&lt;br&gt;
 * If any error occurs the AS400FileReceiver tries again in this time.&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;tr&gt;
 * &lt;td&gt;Base&lt;/td&gt;
 * &lt;td&gt;Retry&lt;/td&gt;
 * &lt;td&gt;Count&lt;/td&gt;
 * &lt;td&gt;How many additional attempts are started after an error occured?&lt;/td&gt;
 * &lt;/tr&gt;
 * &lt;/table&gt;
 */
<span class="nc" id="L89">public class AS400FileReceiver extends AS400FileBase</span>
		implements
			Receiver,
			TAResource,
			ReceiverSingleInterface
{

	/**
	 * AS400 object that represents the iSeries system that contains the file
	 */
<span class="nc" id="L99">	protected AS400 mAS400System = null;</span>

	/**
	 * Path name that represents an object in the QSYS library file system from
	 * the standard configuration.&lt;br&gt;
	 * May contain placeholders for informations on the address
	 */
<span class="nc" id="L106">	private String mConfigFilename = null;</span>

	/**
	 * Path name that represents the copy from the original object in the QSYS
	 * library file system&lt;br&gt;
	 * which Member is renamed to the current date.
	 */
<span class="nc" id="L113">	private String mRenamename = null;</span>

	/**
	 * Represents an AS/400 physical or logical file. Allows the user to use
	 * commitment control when accessing an AS/400 file and access the records
	 * in an AS/400 file sequentially or by record number.
	 */
<span class="nc" id="L120">	protected SequentialFile mOriginFile = null;</span>

	/**
	 * QSYSObjectPathName represents an object in the integrated file system
	 */
<span class="nc" id="L125">	protected QSYSObjectPathName mQSYSObject = null;</span>

	/**
	 * File encoding
	 */
<span class="nc" id="L130">	protected String mEncoding = null;</span>

	/**
	 * Resolved action with the file after that it was read&lt;br&gt;
	 * &lt;i&gt;preserve, rename&lt;/i&gt; or &lt;i&gt;delete&lt;/i&gt;
	 */
<span class="nc" id="L136">	private String mResolution = null;</span>

	/**
	 * In case of &lt;code&gt;mResolution=CallProgram&lt;/code&gt; this path will be used
	 * for the program call.
	 */
	private String mAS400TerminatorProgram;

	/**
	 * Type of action after an error occured.
	 */
<span class="nc" id="L147">	private String mOnError = null;</span>

	/**
	 * Number of retries after an error in first attempt.
	 */
<span class="nc" id="L152">	private int mRetryCount = 0;</span>

	/**
	 * Delay between retries in seconds.
	 */
<span class="nc" id="L157">	private int mTimeout = 0;</span>

	/**
	 * Timeout for stopping program call
	 */
<span class="nc" id="L162">	private int mProgramTimeout = 0;</span>

	/**
	 * This method manages the receiving of message for one neighbor system.
	 * &lt;p&gt;
	 * The system is specified by its name. Due to wildcards in this name it may
	 * really describe serveral interfaces. All these will be processed. Thus,
	 * first the list of {@link net.sf.xbus.base.xbussystem.XBUSSystem}s for
	 * the given system name is determined by replacing the wildcards.
	 * &lt;p&gt;
	 * After that for each XBUSSystem the {@link #doReceive(XBUSSystem)} method
	 * is invoked, where requested interface file(s) is (are) read out into a
	 * character string. The XBUSSystem and the string are passed to the
	 * application layer.
	 * &lt;p&gt;
	 * &lt;b&gt;&lt;i&gt;Note:&lt;/i&gt;&lt;/b&gt;&lt;br&gt;
	 * The retry mechanism in this method first attempts processing &lt;b&gt;&lt;u&gt;each&lt;/u&gt;&lt;/b&gt;
	 * XBUSSystem. Those which cause errors are put into a list and this list is
	 * the base for the next retry.
	 * 
	 * @param systemName name of the system to receive data from
	 * @throws XException if something goes wrong
	 */
	public void receive(String systemName)
	{
		try
		{
			// file name, encoding and resolution for this system
			// are read from the configuration and saved into class variables
<span class="nc" id="L191">			readConfiguration(systemName);</span>

<span class="nc" id="L193">			mAS400System.connectService(AS400.FILE);</span>

			// AS400Receiver will be registered by TAManager
<span class="nc" id="L196">			TAManager taManager = TAManager.getInstance();</span>
<span class="nc" id="L197">			taManager.clearManager();</span>
<span class="nc" id="L198">			taManager.registerResource(this);</span>
<span class="nc" id="L199">			taManager.begin();</span>

			// determine the list of XBUSSystems for the system name
<span class="nc" id="L202">			List systems = XBUSSystem.getSystems(systemName, mConfigFilename);</span>
			// for failed transmissions
<span class="nc" id="L204">			List errorSystems = null;</span>

			// for counting the attempts
<span class="nc" id="L207">			int i = 0;</span>
			// while loop for the attemps to process the interfaces
<span class="nc bnc" id="L209" title="All 4 branches missed.">			while ((!systems.isEmpty()) &amp;&amp; (i &lt; mRetryCount + 1))</span>
			{ // still some systems to process and number of retires nor yet
				// reached
				// time out before retries
<span class="nc bnc" id="L213" title="All 2 branches missed.">				if (i &gt; 0)</span>
<span class="nc" id="L214">					Thread.sleep(mTimeout * 1000);</span>

				// empty list for failed interfaces
<span class="nc" id="L217">				errorSystems = new Vector();</span>

				// for loop iterates over the all XBUSSystems and tries to
				// receive the interface data
<span class="nc bnc" id="L221" title="All 2 branches missed.">				for (Iterator it = systems.iterator(); it.hasNext();)</span>
				{ // iterating operation in first body instruction:
<span class="nc" id="L223">					XBUSSystem xbusSystem = (XBUSSystem) it.next();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">					if (i == 0)</span>
					{ // first attempt
<span class="nc" id="L226">						Trace.info(&quot;Start processing &quot;</span>
<span class="nc" id="L227">								+ xbusSystem.getCompleteName());</span>
					} // then (i == 0)
					else
					{ // a retry
<span class="nc" id="L231">						Trace.info(&quot;Retry number &quot; + i + &quot;: &quot;</span>
<span class="nc" id="L232">								+ xbusSystem.getCompleteName());</span>
					} // else (i == 0)
<span class="nc bnc" id="L234" title="All 2 branches missed.">					if (doReceive(xbusSystem))</span>
					{ // successfully received
<span class="nc" id="L236">						taManager.commit();</span>

<span class="nc" id="L238">						PostProcessor.start(xbusSystem, null,</span>
								Constants.POSTPROCESSING_PERSYSTEM);

<span class="nc" id="L241">						Trace.info(&quot;End processing &quot;</span>
<span class="nc" id="L242">								+ xbusSystem.getCompleteName());</span>
<span class="nc" id="L243">						Trace.info(&quot;----------------------------------------&quot;);</span>
					} // then (receive(xbusSystem))
					else
					{ // An error occured during data transmission
						// but the resulting exception was already catched.
<span class="nc" id="L248">						taManager.rollback();</span>
<span class="nc" id="L249">						Trace.info(&quot;Error while processing &quot;</span>
<span class="nc" id="L250">								+ xbusSystem.getCompleteName());</span>
<span class="nc" id="L251">						Trace.info(&quot;----------------------------------------&quot;);</span>
<span class="nc" id="L252">						errorSystems.add(xbusSystem);</span>
					} // else (receive(xbusSystem))
<span class="nc" id="L254">				} // for (Iterator it = systems.iterator(); it.hasNext();)</span>
				// In next attempt only try the failed interfaces.
<span class="nc" id="L256">				systems = errorSystems;</span>
				// One attempt more done.
<span class="nc" id="L258">				i++;</span>
			} // while ((!systems.isEmpty()) &amp;&amp; (i &lt; mRetryCount + 1))

<span class="nc bnc" id="L261" title="All 2 branches missed.">			if (!systems.isEmpty())</span>
			{ // Even after retrying some systems were not successfully
				// processed.
<span class="nc" id="L264">				Trace.error(&quot;Some systems couldn't be processed.&quot;);</span>

				// Falied interfaces list for error message.
<span class="nc" id="L267">				Hashtable additionalInfo = new Hashtable();</span>
				// Counting the failed interfaces.
<span class="nc" id="L269">				i = 1;</span>
				XBUSSystem system;
				// loop over al failed interfaces
<span class="nc bnc" id="L272" title="All 2 branches missed.">				for (Iterator it = systems.iterator(); it.hasNext();)</span>
				{ // iterating operation in first body instruction:
<span class="nc" id="L274">					system = (XBUSSystem) it.next();</span>

<span class="nc" id="L276">					additionalInfo.put(&quot;System&quot; + i, system.getCompleteName());</span>

					// Perform cleaning operations according to configuration.
					try
					{
<span class="nc bnc" id="L281" title="All 2 branches missed.">						if (mOnError.equals(Constants.READ_DELETE)</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">								|| mOnError.equals(Constants.READ_DELETEFILE))</span>
						{
<span class="nc" id="L284">							deleteFile(mAS400System, system</span>
<span class="nc" id="L285">									.replaceAllMarkers(mConfigFilename)[0]);</span>
						} // delete
<span class="nc bnc" id="L287" title="All 2 branches missed.">						else if (mOnError.equals(Constants.READ_DELETEMEMBER))</span>
						{
<span class="nc" id="L289">							deleteMember(mAS400System, system</span>
<span class="nc" id="L290">									.replaceAllMarkers(mConfigFilename)[0]);</span>
						} // delete member
<span class="nc bnc" id="L292" title="All 2 branches missed.">						else if (mOnError.equals(Constants.READ_RENAME))</span>
						{
<span class="nc" id="L294">							renameFile(</span>
									mAS400System,
<span class="nc" id="L296">									system.replaceAllMarkers(mConfigFilename)[0],</span>
<span class="nc" id="L297">									system.replaceAllMarkers(mConfigFilename)[0]</span>
<span class="nc" id="L298">											+ Constants.getDateAsString());</span>
						} // rename
						// Nothing to do for &quot;Preserve&quot;.
					} // try
<span class="nc" id="L302">					catch (XException e)</span>
					{
<span class="nc" id="L304">						Trace.error(e);</span>
<span class="nc" id="L305">					} // catch</span>
					// Next system.
<span class="nc" id="L307">					i++;</span>
				} // for (Iterator it = systems.iterator(); it.hasNext();)
<span class="nc" id="L309">				NotifyError.notifyError(this, new XBUSSystem(systemName),</span>
						&quot;Some interfaces couldn't be processed&quot;, null,
						additionalInfo);
<span class="nc" id="L312">			} // if (!systems.isEmpty())</span>
			else
<span class="nc" id="L314">				PostProcessor.start(new XBUSSystem(systemName), null,</span>
						Constants.POSTPROCESSING_FINAL);
		} // try
<span class="nc" id="L317">		catch (Throwable e)</span>
		{
			try
			{
<span class="nc" id="L321">				NotifyError.notifyError(this, new XBUSSystem(systemName), e</span>
<span class="nc" id="L322">						.getMessage(), null, null);</span>
			}
<span class="nc" id="L324">			catch (XException e1)</span>
			{
				// do nothing
<span class="nc" id="L327">			}</span>
		} // catch
		finally
		{
<span class="nc" id="L331">			TAManager.getInstance().close();</span>
			// remove from the resources
<span class="nc" id="L333">			TAManager.getInstance().removeResource(this);</span>
			// disconnect from the all services at the iSeries
<span class="nc" id="L335">			mAS400System.disconnectAllServices();</span>
		} // finally
<span class="nc" id="L337">	} // doReceive(String systemName)</span>

	/**
	 * Manages the process of receipt for a specifc XBUSSystem. This method is
	 * provided to do the following:
	 * &lt;ol&gt;
	 * &lt;li&gt; replace wildcards in the filename with the dealer information
	 * &lt;li&gt; create copy and backup files, depending on the resolution
	 * &lt;li&gt; read file into String
	 * &lt;li&gt; call application layer
	 * &lt;li&gt; determine the result in sense of success/no success
	 * &lt;/ol&gt;
	 * 
	 * @param xbusSystem XBUSSystem object with information of this
	 *            neighbor-system to be read
	 * @exception XException if any errors is occurs which is not treated in the
	 *                application layer
	 */
	protected boolean doReceive(XBUSSystem xbusSystem)
	{
<span class="nc" id="L357">		boolean successful = false;</span>

		try
		{
			// The name of the interface file may contain placeholders for
			// informations
			// on the address.
			// In replaceMarker() method these placeholders will be replaced
			// with their
			// actual values for the address of the neighbor-system.
			// If no address address information is available, the text will be
			// returned
			// without modifications.
			// Create an object in the integrated file system for the file name.
			// It is used to parse an integrated file system name into its
			// components.
<span class="nc" id="L373">			mQSYSObject = new QSYSObjectPathName(xbusSystem</span>
<span class="nc" id="L374">					.replaceAllMarkers(mConfigFilename)[0]);</span>
<span class="nc" id="L375">			IFSFile ifsFile = new IFSFile(mAS400System, mQSYSObject.getPath());</span>

			// only if the file exist and it is accessible.
<span class="nc bnc" id="L378" title="All 2 branches missed.">			if (ifsFile.exists())</span>
			{
<span class="nc" id="L380">				Trace.info(&quot;Receiving data from &quot;</span>
<span class="nc" id="L381">						+ xbusSystem.replaceAllMarkers(mConfigFilename)[0]);</span>

				// initiate the SequentialFile object
<span class="nc" id="L384">				mOriginFile = new SequentialFile(mAS400System, mQSYSObject</span>
<span class="nc" id="L385">						.getPath());</span>

				// lock original file with the WRITE_EXCLUSIVE_LOCK lock type
<span class="nc" id="L388">				mOriginFile.lock(SequentialFile.WRITE_EXCLUSIVE_LOCK);</span>

<span class="nc" id="L390">				Object requestContent = getRequestContent();</span>

				// if OnEmpty is Ignore end this method
<span class="nc bnc" id="L393" title="All 2 branches missed.">				if (requestContent == null)</span>
				{
<span class="nc" id="L395">					rollback();</span>
<span class="nc" id="L396">					return true;</span>
				}
				else
				{
					// call application layer
<span class="nc" id="L401">					Adapter adapter = new Adapter();</span>
<span class="nc" id="L402">					adapter.callApplication(xbusSystem, requestContent,</span>
<span class="nc" id="L403">							getType());</span>

					// check the Adapter return code
					// in case of not success, throw new XException
<span class="nc bnc" id="L407" title="All 2 branches missed.">					if (Constants.RC_OK.equals(adapter.getReturncode()))</span>
					{
<span class="nc" id="L409">						successful = true;</span>
					}
				}
<span class="nc" id="L412">			}</span>
			else
			{

<span class="nc" id="L416">				successful = true;</span>
			}

		}
<span class="nc" id="L420">		catch (Throwable t)</span>
		{
			// Something unexpected has happened.
<span class="nc" id="L423">			Trace.error(t);</span>
<span class="nc" id="L424">			successful = false;</span>
<span class="nc" id="L425">		}</span>

<span class="nc" id="L427">		return successful;</span>

	}

	/**
	 * &lt;code&gt;getRequestContent&lt;/code&gt; delivers the content of the request.
	 * Subclasses may define their own request content.
	 * 
	 * @return the interface file content as &lt;code&gt;String&lt;/code&gt; but casted to
	 *         &lt;code&gt;Object&lt;/code&gt; for compliance reasons
	 * @exception XException if file can not be read or any I/O error occurs
	 */
	protected Object getRequestContent() throws XException
	{
		// read original file
<span class="nc" id="L442">		return readFile();</span>
	} // getRequestContent()

	/**
	 * Reads the content of the integrated file system object specified by its
	 * path name into a string.
	 * &lt;p&gt;
	 * &lt;b&gt;&lt;i&gt;Note: &lt;/i&gt;&lt;/b&gt; We use the record-level access classes for
	 * reading.&lt;br&gt;
	 * Contents of each record first are read out in a byte array of AS400 data
	 * and then converted then to a character string with the specified
	 * character encoding.
	 * 
	 * @return file contents as String (with line breaks as recordSeparators)
	 * @exception XException if file can not be read or any I/O error occurs
	 */
	private String readFile() throws XException
	{
<span class="nc" id="L460">		StringBuffer retBuffer = new StringBuffer();</span>

<span class="nc" id="L462">		AS400FileRecordDescription recordDescription = new AS400FileRecordDescription(</span>
<span class="nc" id="L463">				mAS400System, mQSYSObject.getPath());</span>

		try
		{
			// Set record format of the file.
<span class="nc" id="L468">			RecordFormat[] format = recordDescription.retrieveRecordFormat();</span>
<span class="nc" id="L469">			mOriginFile.setRecordFormat(format[0]);</span>

			// Open the file.
<span class="nc" id="L472">			mOriginFile.open(AS400File.READ_WRITE, 0,</span>
					AS400File.COMMIT_LOCK_LEVEL_NONE);

			// Read all records in the file into
			// a string - each one separated by the Constants.LINE_SEPARATOR
<span class="nc" id="L477">			Record record = mOriginFile.readNext();</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">			if (record != null)</span>
			{ // at least one record
<span class="nc" id="L481">				byte[] inData = null;</span>

				// save record contents to the byte array
<span class="nc" id="L484">				inData = record.getContents();</span>

				// convert this content to the String
<span class="nc" id="L487">				mConverter = new CharConverter(mEncoding);</span>
<span class="nc" id="L488">				retBuffer.append(mConverter.byteArrayToString(inData));</span>

<span class="nc bnc" id="L490" title="All 2 branches missed.">				while ((record = mOriginFile.readNext()) != null)</span>
				{
					// read records while they exist
<span class="nc" id="L493">					retBuffer.append(Constants.LINE_SEPERATOR);</span>
<span class="nc" id="L494">					inData = record.getContents();</span>
<span class="nc" id="L495">					retBuffer.append(mConverter.byteArrayToString(inData));</span>
				} // while ((record = mOriginFile.readNext()) != null)
			} // if (record != null)
			// close the file since I am done
<span class="nc" id="L499">			mOriginFile.close();</span>
		} // try
<span class="nc" id="L501">		catch (Exception thr)</span>
		{
<span class="nc" id="L503">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, thr);
<span class="nc" id="L506">		} // catch</span>
<span class="nc" id="L507">		return retBuffer.toString();</span>
	} // readFile()

	/**
	 * Reads standard configuration and stores following data in the class
	 * variables.
	 * &lt;p&gt;
	 * &lt;dl&gt;
	 * &lt;dd&gt;&lt;table&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;&lt;code&gt;Filename&lt;/code&gt;&lt;/td&gt;
	 * &lt;td&gt;&lt;/td&gt;
	 * &lt;td&gt;path name that represents an object in the QSYS library file system&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;&lt;code&gt;Resolution actions&lt;/code&gt;&lt;/td&gt;
	 * &lt;td&gt;&lt;/td&gt;
	 * &lt;td&gt;actions to be taken in case of successfull transmission, error and
	 * empty source file&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;&lt;code&gt;Encoding&lt;/code&gt;&lt;/td&gt;
	 * &lt;td&gt;&lt;/td&gt;
	 * &lt;td&gt;specified character encoding of the interface&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;/table&gt;
	 * &lt;/dl&gt;
	 * 
	 * @see #getResolution(Configuration, String)
	 * @see AS400FileBase#getEncoding(AS400, String)
	 * @param system System name to be read
	 * @exception XException if the configuartion is not available or a
	 *                mandatory key cannot be read
	 */
	public void readConfiguration(String system) throws XException
	{
<span class="nc" id="L543">		Configuration config = Configuration.getInstance();</span>

		// create an AS400 object for the server that holds the files
		// and connection to the iSeries
<span class="nc" id="L547">		AS400Connection connection = AS400Connection.getInstance(config</span>
<span class="nc" id="L548">				.getValue(Constants.CHAPTER_SYSTEM, system, &quot;AS400&quot;));</span>
<span class="nc" id="L549">		mAS400System = connection.getSystem();</span>

<span class="nc" id="L551">		mResolution = getResolution(config, system);</span>
<span class="nc" id="L552">		mOnError = getOnError(config, system);</span>
<span class="nc" id="L553">		mConfigFilename = config.getValue(Constants.CHAPTER_SYSTEM, system,</span>
				Constants.KEY_FILENAME);
<span class="nc" id="L555">		mEncoding = getEncoding(mAS400System, system);</span>
<span class="nc" id="L556">		mAS400TerminatorProgram = config.getValueOptional(</span>
				Constants.CHAPTER_SYSTEM, system, &quot;AS400Program.Terminator&quot;);
<span class="nc" id="L558">		mRetryCount = Configuration.getInstance().getValueAsInt(</span>
				Constants.CHAPTER_BASE, &quot;Retry&quot;, &quot;Count&quot;);
<span class="nc bnc" id="L560" title="All 2 branches missed.">		if (mRetryCount &gt; 0)</span>
<span class="nc" id="L561">			mTimeout = config.getValueAsInt(Constants.CHAPTER_BASE,</span>
					&quot;ReceiverTimeout&quot;, &quot;Seconds&quot;);

<span class="nc" id="L564">		mProgramTimeout = config.getValueAsIntOptional(</span>
				Constants.CHAPTER_SYSTEM, system, &quot;ProgramTimeout&quot;) * 1000;
<span class="nc bnc" id="L566" title="All 2 branches missed.">		if (mProgramTimeout == 0)</span>
		{
<span class="nc" id="L568">			mProgramTimeout = Integer.MAX_VALUE;</span>
		}
<span class="nc" id="L570">	} // readConfiguration(String system)</span>

	/**
	 * Determines the final resolution (action after successful file processing)
	 * for the given system name from the standard configuration and checks its
	 * conformity with the allowed ones:
	 * &lt;p&gt;
	 * &lt;dl&gt;
	 * &lt;dd&gt;&lt;code&gt;Preserve&lt;/code&gt;&amp;nbsp;-the source file remains without
	 * modifications
	 * &lt;dd&gt;&lt;code&gt;Rename&lt;/code&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;- the source file member is
	 * renamed
	 * &lt;dd&gt;&lt;code&gt;Delete&lt;/code&gt; or &lt;code&gt;DeleteFile&lt;/code&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;-
	 * the source file is deleted
	 * &lt;dd&gt;&lt;code&gt;DeleteMember&lt;/code&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;- the source file
	 * member is deleted
	 * &lt;dd&gt;&lt;code&gt;CallProgram&lt;/code&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;- a parameterless
	 * program is called on the AS400, its path is given in the configuration
	 * &lt;/dl&gt;
	 * 
	 * @param config Instance of the
	 *            {@link net.sf.xbus.base.core.config.Configuration}
	 * @param system Sytem name for which resolution must be read.
	 * @return final resolution as String (Preserve, Rename, Delete, DeleteFile,
	 *         DeleteMember or CallProgram)
	 * @exception XException if resolution value is not configured or not known
	 */
	public String getResolution(Configuration config, String system)
			throws XException
	{
<span class="nc" id="L600">		String resolution = config.getValue(Constants.CHAPTER_SYSTEM, system,</span>
				Constants.KEY_RECEIVE_RESOL);
<span class="nc bnc" id="L602" title="All 2 branches missed.">		if (!resolution.equals(Constants.READ_PRESERVE)</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">				&amp;&amp; !resolution.equals(Constants.READ_RENAME)</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">				&amp;&amp; !resolution.equals(Constants.READ_DELETE)</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">				&amp;&amp; !resolution.equals(Constants.READ_DELETEFILE)</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">				&amp;&amp; !resolution.equals(Constants.READ_DELETEMEMBER)</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">				&amp;&amp; !resolution.equals(Constants.READ_CALLPROGRAM))</span>
		{
<span class="nc" id="L609">			List params = new Vector();</span>
<span class="nc" id="L610">			params.add(mResolution);</span>
<span class="nc" id="L611">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;20&quot;, params);
		}
<span class="nc" id="L615">		return resolution;</span>
	} // getResolution(Configuration config, String system)

	/**
	 * Determines the action which should happen in case of an error from the
	 * standard configuration and checks its conformity with the allowed ones:
	 * &lt;p&gt;
	 * &lt;dl&gt;
	 * &lt;dd&gt;&lt;code&gt;Preserve&lt;/code&gt;&amp;nbsp;-the source file remains without
	 * modifications
	 * &lt;dd&gt;&lt;code&gt;Rename&lt;/code&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;- the source file member is
	 * renamed
	 * &lt;dd&gt;&lt;code&gt;Delete&lt;/code&gt; or &lt;code&gt;DeleteFile&lt;/code&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;-
	 * the source file is deleted
	 * &lt;dd&gt;&lt;code&gt;DeleteMember&lt;/code&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;- the source file
	 * member is deleted
	 * &lt;/dl&gt;
	 * 
	 * @param config Instance of the
	 *            {@link net.sf.xbus.base.core.config.Configuration}
	 * @param system Sytem name which resoltion must be read.
	 * @return error case action as String (Preserve, Rename, Delete,
	 *         DeleteFile, DeleteMember)
	 * @exception XException if the onError key is missing or unknown
	 */
	public String getOnError(Configuration config, String system)
			throws XException
	{
<span class="nc" id="L643">		String onError = config.getValue(Constants.CHAPTER_SYSTEM, system,</span>
				&quot;OnError&quot;);
<span class="nc bnc" id="L645" title="All 2 branches missed.">		if (!onError.equals(Constants.READ_PRESERVE)</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">				&amp;&amp; !onError.equals(Constants.READ_RENAME)</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">				&amp;&amp; !onError.equals(Constants.READ_DELETE)</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">				&amp;&amp; !onError.equals(Constants.READ_DELETEMEMBER))</span>
		{
<span class="nc" id="L650">			List params = new Vector();</span>
<span class="nc" id="L651">			params.add(onError);</span>
<span class="nc" id="L652">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;21&quot;, params);
		}
<span class="nc" id="L656">		return onError;</span>
	} // getOnError(Configuration config, String system)

	/**
	 * Sets the aS400System in AS400FileReceiver object.
	 * 
	 * @param aS400System The aS400System to set
	 */
	public void setAS400System(AS400 aS400System)
	{
<span class="nc" id="L666">		mAS400System = aS400System;</span>
<span class="nc" id="L667">	} // setAS400System(AS400 aS400System)</span>

	/**
	 * Implemented method &lt;code&gt;commit&lt;/code&gt; from the TAResource interface.
	 * The purpose of commit actions is to remove any backup information that
	 * had been created during processing (transaction) in the iSeries
	 * integrated file system. Depending on the Resolution, the following
	 * actions are carried out:
	 * &lt;p&gt;
	 * &lt;table border&gt;
	 * &lt;tr&gt;
	 * &lt;th&gt;Resolution&lt;/th&gt;
	 * &lt;th&gt;Action&lt;/th&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;Preserve&lt;/td&gt;
	 * &lt;td&gt;&amp;nbsp;1. release file lock&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;Rename&lt;/td&gt;
	 * &lt;td&gt;&amp;nbsp;1. release file lock&lt;br&gt;
	 * &amp;nbsp;2. rename file&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;Delete/DeleteFile&lt;/td&gt;
	 * &lt;td&gt;&amp;nbsp;1. release file lock&lt;br&gt;
	 * &amp;nbsp;2. delete file&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;DeleteMember&lt;/td&gt;
	 * &lt;td&gt;&amp;nbsp;1. release file lock&lt;br&gt;
	 * &amp;nbsp;2. delete member&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;tr&gt;
	 * &lt;td&gt;CallProgram&lt;/td&gt;
	 * &lt;td&gt;&amp;nbsp;1. release file lock&lt;br&gt;
	 * &amp;nbsp;2. call the specified terminator program&lt;/td&gt;
	 * &lt;/tr&gt;
	 * &lt;/table&gt;
	 * 
	 * @see net.sf.xbus.base.core.TAResource#commit()
	 * @exception XException if accessing the interface file or perfoming the
	 *                configured action fails
	 */
	public void commit() throws XException
	{
		// release all Locks
<span class="nc bnc" id="L714" title="All 2 branches missed.">		if (mOriginFile.getExplicitLocks().length &gt; 0)</span>
		{
			try
			{
<span class="nc" id="L718">				mOriginFile.releaseExplicitLocks();</span>
			} // try
<span class="nc" id="L720">			catch (Exception ex)</span>
			{
<span class="nc" id="L722">				List params = new Vector();</span>
<span class="nc" id="L723">				params.add(mQSYSObject.getPath());</span>
<span class="nc" id="L724">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_AS400, &quot;6&quot;, params);
<span class="nc" id="L727">			} // catch</span>
		} // if (mOriginFile.getExplicitLocks().length &gt; 0)

		// delete file if resolution = Delete/DeleteFile
<span class="nc bnc" id="L731" title="All 2 branches missed.">		if (mResolution.equals(Constants.READ_DELETE)</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">				|| mResolution.equals(Constants.READ_DELETEFILE))</span>
		{
			try
			{
<span class="nc" id="L736">				mOriginFile.delete();</span>
			} // try
<span class="nc" id="L738">			catch (Exception ex)</span>
			{
<span class="nc" id="L740">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, ex);
<span class="nc" id="L743">			} // catch</span>
		} // Delete/DeleteFile

		// Delete member if resolution = DelteMember
<span class="nc bnc" id="L747" title="All 2 branches missed.">		if (mResolution.equals(Constants.READ_DELETEMEMBER))</span>
		{
			try
			{
<span class="nc" id="L751">				mOriginFile.deleteMember();</span>
			} // try
<span class="nc" id="L753">			catch (Exception ex)</span>
			{
<span class="nc" id="L755">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, ex);
<span class="nc" id="L758">			} // catch</span>
		} // DeleteMember

		// Rename member if resolution = rename
<span class="nc bnc" id="L762" title="All 2 branches missed.">		else if (mResolution.equals(Constants.READ_RENAME))</span>
		{
			// Get new path with date as member name.
<span class="nc" id="L765">			mRenamename = getRenamedMember(new QSYSObjectPathName(mQSYSObject</span>
<span class="nc" id="L766">					.getPath()), &quot;SV&quot; + Constants.getAS400DateFormat());</span>
			// Execute renaming
<span class="nc" id="L768">			renameFile(mAS400System, mQSYSObject.getPath(), mRenamename);</span>
		} // Rename

		// Call &quot;Terminator&quot; program if resolution = CallProgram
<span class="nc bnc" id="L772" title="All 2 branches missed.">		else if (mResolution.equals(Constants.READ_CALLPROGRAM))</span>
		{
			// Check for program path read from the configuration before.
<span class="nc bnc" id="L775" title="All 2 branches missed.">			if (mAS400TerminatorProgram == null</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">					|| mAS400TerminatorProgram.length() == 0)</span>
			{
<span class="nc" id="L778">				throw new XException(Constants.LOCATION_INTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_AS400, &quot;25&quot;);
			}
			// Empty parameter list
<span class="nc" id="L783">			ProgramParameter[] param = new ProgramParameter[0];</span>
			// Call
<span class="nc" id="L785">			callAS400Program(mAS400System, mAS400TerminatorProgram, param,</span>
					mProgramTimeout);
		} // CallProgram
<span class="nc" id="L788">	} // commit()</span>

	/**
	 * Implemented method &lt;code&gt;rollback&lt;/code&gt; from TAResource neglects all
	 * changes made so far (file locking).
	 * &lt;p&gt;
	 * 
	 * @see net.sf.xbus.base.core.TAResource#rollback()
	 * @exception XException if locks cannot be released
	 */
	public void rollback() throws XException
	{
<span class="nc bnc" id="L800" title="All 2 branches missed.">		if (mOriginFile.getExplicitLocks().length &gt; 0)</span>
		{
			try
			{
<span class="nc" id="L804">				mOriginFile.releaseExplicitLocks();</span>
			} // try
<span class="nc" id="L806">			catch (Exception ex)</span>
			{
<span class="nc" id="L808">				List params = new Vector();</span>
<span class="nc" id="L809">				params.add(mQSYSObject.getPath());</span>
<span class="nc" id="L810">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_AS400, &quot;6&quot;, params);
<span class="nc" id="L813">			} // catch</span>
		} // if (mOriginFile.getExplicitLocks().length &gt; 0)
<span class="nc" id="L815">	} // rollback()</span>

	/**
	 * Not implemented for the iSeries integrated file system
	 * 
	 * @see net.sf.xbus.base.core.TAResource#open()
	 */
	public void open()
<span class="nc" id="L823">	{}</span>

	/**
	 * Not implemented for the iSeries integrated file system
	 * 
	 * @see net.sf.xbus.base.core.TAResource#close()
	 */
	public void close()
<span class="nc" id="L831">	{}</span>

	public String getType()
	{
<span class="nc" id="L835">		return Constants.TYPE_TEXT;</span>
	}
} // AS400FileReceiver
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>