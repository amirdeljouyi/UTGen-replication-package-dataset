<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AS400FileBase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.technical.as400</a> &gt; <span class="el_source">AS400FileBase.java</span></div><h1>AS400FileBase.java</h1><pre class="source lang-java linenums">package net.sf.xbus.technical.as400;

import java.util.List;
import java.util.Vector;

import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.core.timeoutcall.TimedCallable;
import net.sf.xbus.base.core.trace.Trace;

import com.ibm.as400.access.AS400;
import com.ibm.as400.access.CharConverter;
import com.ibm.as400.access.IFSFile;
import com.ibm.as400.access.IFSFileInputStream;
import com.ibm.as400.access.IFSFileOutputStream;
import com.ibm.as400.access.ProgramParameter;
import com.ibm.as400.access.QSYSObjectPathName;
import com.ibm.as400.access.SequentialFile;

/**
 * Class &lt;code&gt;AS400FileBase&lt;/code&gt; is the abstract base class for the
 * {@link AS400FileReceiver} and {@link AS400FileSender} classes.
 * &lt;p&gt;
 * It provides the methods for the following:
 * &lt;ul&gt;
 * &lt;li&gt;Renaming files and members&lt;/li&gt;
 * &lt;li&gt;Deleting files and members&lt;/li&gt;
 * &lt;li&gt;Copying files&lt;/li&gt;
 * &lt;li&gt;Locking files for different types of access&lt;/li&gt;
 * &lt;li&gt;Calling programs&lt;/li&gt;
 * &lt;/ul&gt;.
 * &lt;/p&gt;
 */
<span class="nc" id="L35">public abstract class AS400FileBase</span>
{

	/**
	 * The char converter according to actual string encoding. It is
	 * &lt;code&gt;protected&lt;/code&gt; to grant access by the subclasses.
	 */
	protected CharConverter mConverter;

	/**
	 * Returns the encoding of the data type from the
	 * {@link net.sf.xbus.base.core.config.Configuration}. If this one is
	 * non-existent, the method returns the default value from the AS400 object
	 * that corresponds to the job CCSID of the server.
	 * &lt;p&gt;
	 * 
	 * @param as400System AS400 object for the server that holds the files
	 * @param system system name for which encoding must be read
	 * @return character encoding from Configuration or default encoding that
	 *         corresponds to the job CCSID of the server.
	 * @exception XException if encoding cannot be determined neither from the
	 *                configurationnor by accesing the AS400
	 */
	static public String getEncoding(AS400 as400System, String system)
			throws XException
	{
<span class="nc" id="L61">		Configuration config = Configuration.getInstance();</span>
<span class="nc" id="L62">		String configEncoding = null;</span>
<span class="nc" id="L63">		configEncoding = config.getValueOptional(Constants.CHAPTER_SYSTEM,</span>
				system, Constants.KEY_ENCODING);

<span class="nc bnc" id="L66" title="All 2 branches missed.">		if (configEncoding == null)</span>
		{
			try
			{
<span class="nc" id="L70">				configEncoding = as400System.getJobCCSIDEncoding();</span>
			} // try
<span class="nc" id="L72">			catch (Exception ex)</span>
			{
<span class="nc" id="L74">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, ex);
<span class="nc" id="L77">			} // catch</span>
		} // if (configEncoding == null)
<span class="nc" id="L79">		return configEncoding;</span>
	} // getEncoding(AS400 as400System, String system)

	/**
	 * Sets a lock on the file to prevent other users from accessing the file
	 * while it is in use.
	 * &lt;p&gt;
	 * The following type of lock is used:
	 * &lt;p&gt;
	 * &lt;code&gt;WRITE_EXCLUSIVE_LOCK&lt;/code&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;The current Java
	 * program changes the file, and no other program can access the file.
	 * &lt;p&gt;
	 * &lt;i&gt;Note:&lt;/i&gt; If a lock has already been obtained for this file, no
	 * action is taken.
	 * 
	 * @param as400System The AS400 system to which to connect. The system
	 *            cannot be null.
	 * @param lockFilename The integrated file system pathname of the file to be
	 *            locked. The name cannot be null.
	 * @exception XException if locking did not work
	 */
	protected void setLock(AS400 as400System, String lockFilename)
			throws XException
	{
		try
		{
<span class="nc" id="L105">			SequentialFile seqFile = new SequentialFile(as400System,</span>
					lockFilename);
<span class="nc" id="L107">			seqFile.lock(SequentialFile.WRITE_EXCLUSIVE_LOCK);</span>
		} // try
<span class="nc" id="L109">		catch (Exception ex)</span>
		{
<span class="nc" id="L111">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, ex);
<span class="nc" id="L114">		} // catch</span>
<span class="nc" id="L115">	} // setLock(AS400 as400System, String lockFilename)</span>

	/**
	 * Releases all locks acquired via the {@link #setLock(AS400, String)}
	 * method.
	 * &lt;p&gt;
	 * If no locks have been explicitly obtained, no action is taken.
	 * 
	 * @param as400System The AS400 system to which to connect. The system
	 *            cannot be null.
	 * @param lockFilename The integrated file system pathname of the file to be
	 *            locked. The name cannot be null.
	 * @exception XException if the file lock can not be released
	 */
	protected void releaseLock(AS400 as400System, String lockFilename)
			throws XException
	{
<span class="nc" id="L132">		SequentialFile lockFile = new SequentialFile(as400System, lockFilename);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">		if (lockFile.getExplicitLocks().length &gt; 0)</span>
		{ // There are locks.
			try
			{
<span class="nc" id="L137">				lockFile.releaseExplicitLocks();</span>
			} // try
<span class="nc" id="L139">			catch (Exception ex)</span>
			{
<span class="nc" id="L141">				List params = new Vector();</span>
<span class="nc" id="L142">				params.add(lockFilename);</span>
<span class="nc" id="L143">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_AS400, &quot;6&quot;, params);
<span class="nc" id="L146">			} // catch</span>
		} // if (lockFile.getExplicitLocks().length &gt; 0)
<span class="nc" id="L148">	} // releaseLock(AS400 as400System, String lockFilename)</span>

	/**
	 * Return a path name with a new member name. The QSYSObjectPathName
	 * provides an integrated file system path name that represents an object in
	 * the QSYS library file system.
	 * &lt;p&gt;
	 * &lt;i&gt;For example:&lt;/i&gt;&lt;br&gt;
	 * &lt;dl&gt;
	 * &lt;dd&gt;/QSYS.&lt;b&gt;LIB&lt;/b&gt;/QGPL.&lt;b&gt;LIB&lt;/b&gt;/ACCOUNTS.&lt;b&gt;FILE&lt;/b&gt;/PAYABLE.&lt;b&gt;MBR&lt;/b&gt;
	 * &lt;/dl&gt;
	 * &lt;p&gt;
	 * This method parses the given QSYSObjectPathName object to extract the
	 * library, object, member, and object type and builds integrated file
	 * system path name with &lt;b&gt;new member&lt;/b&gt; as follows:
	 * &lt;p&gt;
	 * &lt;dl&gt;
	 * &lt;dd&gt;/QSYS.LIB/&lt;b&gt;OLDLIB&lt;/b&gt;.LIB/&lt;b&gt;OLDFILE&lt;/b&gt;.FILE/&lt;b&gt;NEWMEMBER&lt;/b&gt;.MBR
	 * &lt;/dl&gt;
	 * 
	 * @param qsysPathname represents old object in the QSYS library file system
	 * @param newMember new member name, cannot exceed 10 characters in length!
	 *            Must start with a letter.
	 * @return fully qualified integrated file system path of the new object in
	 *         the QSYS file system
	 */
	protected String getRenamedMember(QSYSObjectPathName qsysPathname,
			String newMember)
	{
<span class="nc" id="L177">		return new QSYSObjectPathName(qsysPathname.getLibraryName(),</span>
<span class="nc" id="L178">				qsysPathname.getObjectName(), newMember, qsysPathname</span>
<span class="nc" id="L179">						.getObjectType()).getPath();</span>
	}

	/**
	 * Renames the integrated file system object specified by the &lt;i&gt;source&lt;/i&gt;
	 * path name to have the path name of &lt;i&gt;dest&lt;/i&gt;.
	 * 
	 * @param as400System AS400 system to which to connect. The system cannot be
	 *            null
	 * @param sourceFilename old abstract pathname of the integrated file system
	 *            object
	 * @param destFilename new abstract pathname of the integrated file system
	 *            object
	 * @exception XException if an error occurs while communicating with the
	 *                server.
	 */
	protected void renameFile(AS400 as400System, String sourceFilename,
			String destFilename) throws XException
	{
<span class="nc" id="L198">		IFSFile srcFile = new IFSFile(as400System, sourceFilename);</span>
<span class="nc" id="L199">		IFSFile destFile = new IFSFile(as400System, destFilename);</span>

		// construct temp name and temp member for destination file
<span class="nc" id="L202">		String tempName = new StringBuffer(destFile.getParent()).append(</span>
<span class="nc" id="L203">				Constants.FILE_SEPERATOR).append(&quot;xbusTemp.MBR&quot;).toString();</span>
<span class="nc" id="L204">		IFSFile tempFile = null;</span>
		try
		{
			// 1. rename destination file to temp one if it exists
<span class="nc bnc" id="L208" title="All 2 branches missed.">			if (destFile.exists())</span>
			{
<span class="nc" id="L210">				tempFile = new IFSFile(as400System, tempName);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">				if (tempFile.exists())</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">					if (!tempFile.delete())</span>
					{
<span class="nc" id="L214">						throw new XException(Constants.LOCATION_EXTERN,</span>
								Constants.LAYER_TECHNICAL,
								Constants.PACKAGE_TECHNICAL_AS400, &quot;7&quot;,
								(List) null);
					}
<span class="nc bnc" id="L219" title="All 2 branches missed.">				if (!destFile.renameTo(tempFile))</span>
				{
<span class="nc" id="L221">					throw new XException(Constants.LOCATION_EXTERN,</span>
							Constants.LAYER_TECHNICAL,
							Constants.PACKAGE_TECHNICAL_AS400, &quot;8&quot;, (List) null);
				}
				// Reinitialize to check existance of the renamed member
				// Return value of renameTo is not reliable. It may be &lt;true&gt;
				// even if
				// the renaming was not successful.
<span class="nc" id="L229">				tempFile = new IFSFile(as400System, tempName);</span>
				// Make sure that renaming was successful.
<span class="nc bnc" id="L231" title="All 2 branches missed.">				if (!tempFile.exists())</span>
				{
<span class="nc" id="L233">					throw new XException(Constants.LOCATION_EXTERN,</span>
							Constants.LAYER_TECHNICAL,
							Constants.PACKAGE_TECHNICAL_AS400, &quot;8&quot;, (List) null);
				}
				// Reinitialise to allow further renaming
<span class="nc" id="L238">				destFile = new IFSFile(as400System, destFilename);</span>
			} // if (destFile.exists())

<span class="nc" id="L241">			boolean renameBackTempFile = false;</span>
			// Should the renaming of the destination member be reversed?

			// 2. rename source file to dest file
<span class="nc bnc" id="L245" title="All 2 branches missed.">			if (srcFile.renameTo(destFile))</span>
			{
				// Reinitialise to check existance of the destination file
				// Return value of renameTo is not reliable. It may be &lt;true&gt;
				// even if
				// the renaming was not successful.
<span class="nc" id="L251">				destFile = new IFSFile(as400System, destFilename);</span>
				// Make sure that renaming was successful.
<span class="nc bnc" id="L253" title="All 2 branches missed.">				if (!destFile.exists())</span>
<span class="nc" id="L254">					renameBackTempFile = true;</span>
				// delete temp member
<span class="nc bnc" id="L256" title="All 4 branches missed.">				if (tempFile != null &amp;&amp; tempFile.exists())</span>
<span class="nc" id="L257">					deleteMember(as400System, tempName);</span>
			} // if (srcFile.renameTo(destFile))
			else
				// Reverse initial renaming of the destination file member
<span class="nc" id="L261">				renameBackTempFile = true;</span>

			// 3. Rename the destination file member bach to its original name
			// if
			// any error prevented the renaming of the source file.
			// Only necessary if the destination filemember existed before and
			// was
			// renamed to a temporyry member name.
<span class="nc bnc" id="L269" title="All 4 branches missed.">			if (tempFile != null &amp;&amp; renameBackTempFile)</span>
			{ // Reverse initial renaming of the destination file member
				// Reinitialise to allow backwards renaming
<span class="nc" id="L272">				destFile = new IFSFile(as400System, destFilename);</span>
				// rename back temp member to destination member
<span class="nc" id="L274">				tempFile.renameTo(destFile);</span>

<span class="nc" id="L276">				List params = new Vector();</span>
<span class="nc" id="L277">				params.add(sourceFilename);</span>
<span class="nc" id="L278">				params.add(destFilename);</span>
<span class="nc" id="L279">				throw new XException(Constants.LOCATION_EXTERN,</span>
						Constants.LAYER_TECHNICAL,
						Constants.PACKAGE_TECHNICAL_AS400, &quot;10&quot;, params);
			} // if (tempFile!=null &amp;&amp; renameBackTempFile)
		} // try
<span class="nc" id="L284">		catch (Exception ex)</span>
		{
<span class="nc" id="L286">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, ex);
<span class="nc" id="L289">		} // catch</span>
<span class="nc" id="L290">	} // renameFile(AS400 as400System,String sourceFilename,String</span>
		// destFilename)

	/**
	 * This method uses the installable file system classes to copy a file from
	 * one directory to another on the server.
	 * 
	 * @param as400System AS400 object for the server which holds the files.
	 * @param sourceName name the source file to be copied
	 * @param targetName name the target file to be copied to
	 * @exception XException if file processing cannot be completed
	 */
	protected void copyFile(AS400 as400System, String sourceName,
			String targetName) throws XException
	{
<span class="nc" id="L305">		byte[] buffer = new byte[1024 * 64];</span>

<span class="nc" id="L307">		IFSFileInputStream source = null;</span>
<span class="nc" id="L308">		IFSFileOutputStream target = null;</span>
		try
		{
			// Open the source file for exclusive access.
<span class="nc" id="L312">			source = new IFSFileInputStream(as400System, sourceName,</span>
					IFSFileInputStream.SHARE_NONE);

<span class="nc" id="L315">			IFSFile targetFile = new IFSFile(as400System, targetName);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">			if (!targetFile.exists())</span>
			{
<span class="nc" id="L318">				targetFile.createNewFile();</span>
			} // if (!targetFile.exists())

			// Open the target file for exclusive access.
<span class="nc" id="L322">			target = new IFSFileOutputStream(as400System, targetName,</span>
					IFSFileOutputStream.SHARE_NONE, false);

			// Read the first 64K bytes from the source file.
<span class="nc" id="L326">			int bytesRead = source.read(buffer);</span>

			// While there is data in the source file copy the data from
			// the source file to the target file.
<span class="nc bnc" id="L330" title="All 2 branches missed.">			while (bytesRead &gt; 0)</span>
			{
<span class="nc" id="L332">				target.write(buffer, 0, bytesRead);</span>
<span class="nc" id="L333">				bytesRead = source.read(buffer);</span>
			}

			// Clean up by closing the source and target file.
<span class="nc" id="L337">			source.close();</span>
<span class="nc" id="L338">			target.close();</span>
		} // try
<span class="nc" id="L340">		catch (Exception e)</span>
		{
			// If any of the above operations failed trace error
			// and output the exception.
<span class="nc" id="L344">			Trace.error(&quot;Copy failed&quot;);</span>
<span class="nc" id="L345">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, e);
<span class="nc" id="L348">		} // catch</span>
<span class="nc" id="L349">	} // copyFile(AS400 as400System,String sourceName,String targetName)</span>

	/**
	 * &lt;code&gt;deleteFile&lt;/code&gt; deletes a file on the AS400 file system. This
	 * method is used for files in the AS400 inegrated file system sense.
	 * 
	 * @see #deleteMember(AS400, String)
	 * @param mAS400System the AS400 to interact with
	 * @param fileName the path of the file to delete
	 * @throws XException if the file cannot be deleted for any reason
	 */
	protected void deleteFile(AS400 mAS400System, String fileName)
			throws XException
	{
<span class="nc" id="L363">		SequentialFile file = new SequentialFile(mAS400System, fileName);</span>
		try
		{
<span class="nc" id="L366">			file.delete();</span>
		} // try
<span class="nc" id="L368">		catch (Exception ex)</span>
		{
<span class="nc" id="L370">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, ex);
<span class="nc" id="L373">		} // catch</span>
<span class="nc" id="L374">	} // deleteFile(AS400 mAS400System, String fileName)</span>

	/**
	 * Deletes a member of a sequential file on the AS/400 file system. The
	 * surrounding file will continue to exist.
	 * 
	 * @param as400System the AS/400 to interact with
	 * @param fileName the name of the file and member to delete
	 * @throws XException if the member cannot be deleted for any reason
	 */
	protected void deleteMember(AS400 as400System, String fileName)
			throws XException
	{
<span class="nc" id="L387">		SequentialFile srcFile = new SequentialFile(as400System, fileName);</span>
		try
		{
<span class="nc" id="L390">			srcFile.deleteMember();</span>
		} // try
<span class="nc" id="L392">		catch (Exception ex)</span>
		{
<span class="nc" id="L394">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, ex);
<span class="nc" id="L397">		} // catch</span>
<span class="nc" id="L398">	} // deleteMember(AS400 as400System, String fileName)</span>

	/**
	 * Calls an AS400 program.
	 * 
	 * @param as400 the AS400 to interact with
	 * @param programName the path of the program to call
	 * @param parameters the input and output paremeters of the program call
	 * @param timeout seconds before program will be stopped
	 * @throws XException if the AS400 issues an error
	 */
	protected void callAS400Program(AS400 as400, String programName,
			ProgramParameter[] parameters, int timeout) throws XException
	{
<span class="nc" id="L412">		AS400ProgramCaller caller = new AS400ProgramCaller(as400, programName,</span>
				parameters, mConverter);
<span class="nc" id="L414">		TimedCallable tc = new TimedCallable(caller, timeout);</span>
		try
		{
<span class="nc" id="L417">			tc.call();</span>
		}
<span class="nc" id="L419">		catch (Exception e)</span>
		{
<span class="nc" id="L421">			throw new XException(Constants.LOCATION_EXTERN,</span>
					Constants.LAYER_TECHNICAL,
					Constants.PACKAGE_TECHNICAL_AS400, &quot;0&quot;, e);
<span class="nc" id="L424">		}</span>
<span class="nc" id="L425">	} // callAS400Program(AS400 as400,String programName,ProgramParameter[]</span>
		// parameters)

} // AS400FileBase
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>