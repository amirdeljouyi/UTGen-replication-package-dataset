<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Administrator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">83_xbus</a> &gt; <a href="index.source.html" class="el_package">net.sf.xbus.admin</a> &gt; <span class="el_source">Administrator.java</span></div><h1>Administrator.java</h1><pre class="source lang-java linenums">package net.sf.xbus.admin;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.text.NumberFormat;
import java.util.Iterator;
import java.util.Set;
import java.util.TreeSet;

import net.sf.xbus.base.core.ASCIITokenizer;
import net.sf.xbus.base.core.Constants;
import net.sf.xbus.base.core.MessageHandler;
import net.sf.xbus.base.core.TAManager;
import net.sf.xbus.base.core.XException;
import net.sf.xbus.base.core.config.Configuration;
import net.sf.xbus.base.core.trace.Trace;
import net.sf.xbus.base.deletedMessageStore.DeletedMessageStore;
import net.sf.xbus.base.journal.Journal;
import net.sf.xbus.technical.ReceiverService;
import net.sf.xbus.technical.ReceiverThreadManager;
import net.sf.xbus.technical.as400.AS400Connection;
import net.sf.xbus.technical.database.DBConnection;
import net.sf.xbus.technical.http.HTTPReceiver;
import net.sf.xbus.technical.mq.MQConnection;

/**
 * Provides several services to administrate the xBus.
 */
<span class="nc" id="L32">public class Administrator</span>
{
	/**
	 * Reads a file from &lt;code&gt;XBUS_HOME/etc&lt;/code&gt;.
	 * 
	 * @param filename the name of the file to read
	 * @return the content of the file or an error message
	 */
	public String readEtc(String filename)
	{
<span class="nc bnc" id="L42" title="All 2 branches missed.">		if (filename == null)</span>
		{
<span class="nc" id="L44">			return (&quot;Filename must not be null.&quot;);</span>
		} // if (source == null)
<span class="nc bnc" id="L46" title="All 4 branches missed.">		else if (filename.startsWith(&quot;..&quot;) || (filename.indexOf(&quot;..&quot;) &gt; 0))</span>
		{
<span class="nc" id="L48">			return (&quot;.. is not allowed in filename.&quot;);</span>
		} // if (source.startsWith(&quot;..&quot;) || (source.indexOf(&quot;..&quot;) &gt; 0))
<span class="nc bnc" id="L50" title="All 4 branches missed.">		else if (filename.startsWith(&quot;/&quot;) || (filename.startsWith(&quot;\\&quot;)))</span>
		{
<span class="nc" id="L52">			return (&quot;Filename must not start with / or \\.&quot;);</span>
		} // if (source.startsWith(&quot;..&quot;) || (source.indexOf(&quot;..&quot;) &gt; 0))

<span class="nc" id="L55">		return readFile(Constants.XBUS_ETC + filename, 0);</span>
	}

	/**
	 * Reads a file from &lt;code&gt;XBUS_HOME/log&lt;/code&gt;.
	 * 
	 * @param filename the name of the file
	 * @param maxLength maximum length to read in kbyte.
	 * @return the content of the file or an error message
	 */
	public String readLog(String filename, int maxLength)
	{
<span class="nc bnc" id="L67" title="All 2 branches missed.">		if (filename == null)</span>
		{
<span class="nc" id="L69">			return (&quot;Filename must not be null&quot;);</span>
		} // if (source == null)
<span class="nc bnc" id="L71" title="All 4 branches missed.">		else if (filename.startsWith(&quot;..&quot;) || (filename.indexOf(&quot;..&quot;) &gt; 0))</span>
		{
<span class="nc" id="L73">			return (&quot;.. is not allowed in filename&quot;);</span>
		} // if (source.startsWith(&quot;..&quot;) || (source.indexOf(&quot;..&quot;) &gt; 0))
<span class="nc bnc" id="L75" title="All 4 branches missed.">		else if (filename.startsWith(&quot;/&quot;) || (filename.startsWith(&quot;\\&quot;)))</span>
		{
<span class="nc" id="L77">			return (&quot;filename must not start with / or \\&quot;);</span>
		} // if (source.startsWith(&quot;..&quot;) || (source.indexOf(&quot;..&quot;) &gt; 0))

<span class="nc" id="L80">		return readFile(Constants.XBUS_LOG + filename, maxLength);</span>
	}

	/**
	 * Explains an errorcode.
	 * 
	 * @param key the errorcode to explain
	 * @return the message of the errorcode
	 */
	public String explainErrorcode(String key)
	{
<span class="nc bnc" id="L91" title="All 2 branches missed.">		if (key == null)</span>
		{
<span class="nc" id="L93">			return (&quot;Key must not be null.&quot;);</span>
		}

<span class="nc" id="L96">		String basename = &quot;errors&quot;;</span>

		// get the decompose key
<span class="nc" id="L99">		ASCIITokenizer test = new ASCIITokenizer(key, &quot;_&quot;);</span>
<span class="nc" id="L100">		String Location = test.nextToken();</span>
<span class="nc" id="L101">		String Layer = test.nextToken();</span>
<span class="nc" id="L102">		String Package = test.nextToken();</span>
<span class="nc" id="L103">		String Number = test.nextToken();</span>

		// get the Message
<span class="nc" id="L106">		MessageHandler msg = MessageHandler.getInstance(basename);</span>
<span class="nc" id="L107">		String messageText = msg.getMessageOptional(key, null);</span>

		// get the Location
<span class="nc" id="L110">		String LocationInformation = null;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (Location.equals(&quot;I&quot;))</span>
		{
<span class="nc" id="L113">			LocationInformation = &quot;Intern&quot;;</span>
		} // if (Location.equals(&quot;I&quot;))
<span class="nc bnc" id="L115" title="All 2 branches missed.">		else if (Location.equals(&quot;E&quot;))</span>
		{
<span class="nc" id="L117">			LocationInformation = &quot;Extern&quot;;</span>
		} // if (Location.equals(&quot;E&quot;))
		else
		{
<span class="nc" id="L121">			return &quot;Wrong Location&quot;;</span>
		}
		// get the Layer
<span class="nc" id="L124">		String LayerInformation = msg.getMessageOptional(Layer, null);</span>

		// get the Package
<span class="nc" id="L127">		String PackageInformation = msg.getMessageOptional(Layer + &quot;_&quot;</span>
				+ Package, null);

<span class="nc" id="L130">		String informations = new StringBuffer(Location).append(&quot; = &quot;).append(</span>
<span class="nc" id="L131">				LocationInformation).append(Constants.LINE_SEPERATOR).append(</span>
<span class="nc" id="L132">				Layer).append(&quot; = &quot;).append(LayerInformation).append(</span>
<span class="nc" id="L133">				Constants.LINE_SEPERATOR).append(Package).append(&quot; = &quot;).append(</span>
<span class="nc" id="L134">				PackageInformation).append(Constants.LINE_SEPERATOR).append(</span>
<span class="nc" id="L135">				&quot;Number&quot;).append(&quot; = &quot;).append(Number).append(</span>
<span class="nc" id="L136">				Constants.LINE_SEPERATOR).append(&quot;Message text&quot;).append(&quot; = &quot;)</span>
<span class="nc" id="L137">				.append(messageText).toString();</span>

<span class="nc" id="L139">		return informations;</span>
	}

	/**
	 * Stopping all background services, refreshes the configuration and starts
	 * the background services again.
	 * 
	 * @return the confirmation or an error message
	 */
	public String restartReceiverService()
	{
		try
		{
			/*
			 * Stop background receivers
			 */
<span class="nc" id="L155">			ReceiverService.getInstance().stopAllSystems();</span>

			/*
			 * Initialize all configurations
			 */
<span class="nc" id="L160">			Configuration.refresh(&quot;standard&quot;);</span>
<span class="nc" id="L161">			Configuration.refresh(&quot;xbus&quot;);</span>
<span class="nc" id="L162">			Configuration.refresh(&quot;mapping&quot;);</span>

			/*
			 * Initialize XException, Trace and Journal
			 */
<span class="nc" id="L167">			XException.clearExceptionInformation();</span>
<span class="nc" id="L168">			Trace.initialize();</span>
<span class="nc" id="L169">			Journal.initialize();</span>

			/*
			 * Clear all connections
			 */
<span class="nc" id="L174">			DBConnection.clear();</span>
<span class="nc" id="L175">			AS400Connection.clear();</span>
<span class="nc" id="L176">			MQConnection.clear();</span>
<span class="nc" id="L177">			TAManager.clear();</span>

			/*
			 * Start background receivers again
			 */
<span class="nc" id="L182">			ReceiverService.getInstance().startAllSystems();</span>
<span class="nc" id="L183">			ReceiverThreadManager.getInstance().clearStoppedHTTPReceivers();</span>
<span class="nc" id="L184">			HTTPReceiver.initializeAmountErrorsCompletely();</span>

<span class="nc" id="L186">			return &quot;ReceiverService has been restarted and configuration has been refreshed.&quot;;</span>
		}
<span class="nc" id="L188">		catch (XException e)</span>
		{
<span class="nc" id="L190">			return XException.getExceptionInformation();</span>
		}
	}

	/**
	 * Stops the ReceiverService completely, including the JMX server.
	 * 
	 * @return the confirmation or an error message
	 */
	public String stopReceiverService()
	{
		try
		{
<span class="nc bnc" id="L203" title="All 2 branches missed.">			if (!ReceiverService.getInstance().stop())</span>
			{
<span class="nc" id="L205">				return &quot;ReceiverService can not be stopped&quot;;</span>
			}
		}
<span class="nc" id="L208">		catch (XException e)</span>
		{
<span class="nc" id="L210">			return XException.getExceptionInformation();</span>
<span class="nc" id="L211">		}</span>

<span class="nc" id="L213">		return &quot;ReceiverService has been stopped&quot;;</span>
	}

	/**
	 * Returns lists of running, stopped and killed ReceiverThreads.
	 * 
	 * @return lists of running, stopped and killed ReceiverThreads
	 */
	public String getReceiverServiceStatus()
	{
<span class="nc" id="L223">		StringBuffer retBuffer = new StringBuffer();</span>

		/*
		 * Retrieving state of ReveiverThreads
		 */
<span class="nc" id="L228">		ReceiverThreadManager manager = ReceiverThreadManager.getInstance();</span>
		Set runningSystems;
		Set allSystems;
		try
		{
<span class="nc" id="L233">			allSystems = manager.getAllSystems();</span>
<span class="nc" id="L234">			runningSystems = manager.getRunningSystems();</span>
		}
<span class="nc" id="L236">		catch (XException e)</span>
		{
<span class="nc" id="L238">			return e.getMessage();</span>
<span class="nc" id="L239">		}</span>
<span class="nc" id="L240">		Set stoppedSystems = manager.getStoppedSystems();</span>

<span class="nc" id="L242">		StringBuffer tmpBuffer = new StringBuffer();</span>
<span class="nc" id="L243">		retBuffer.append(&quot;Running Background Receivers:\n&quot;);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">		for (Iterator it = runningSystems.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L246">			tmpBuffer.append(&quot;\n&quot;).append(it.next());</span>
		}
<span class="nc bnc" id="L248" title="All 2 branches missed.">		if (tmpBuffer.length() == 0)</span>
		{
<span class="nc" id="L250">			retBuffer.append(&quot;-&quot;);</span>
		}
		else
		{
<span class="nc" id="L254">			retBuffer.append(tmpBuffer);</span>
		}

<span class="nc" id="L257">		tmpBuffer = new StringBuffer();</span>
<span class="nc" id="L258">		retBuffer.append(&quot;\n\nStopped Background Receivers:\n&quot;);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">		for (Iterator it = stoppedSystems.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L261">			tmpBuffer.append(&quot;\n&quot;).append(it.next());</span>
		}
<span class="nc bnc" id="L263" title="All 2 branches missed.">		if (tmpBuffer.length() == 0)</span>
		{
<span class="nc" id="L265">			retBuffer.append(&quot;-&quot;);</span>
		}
		else
		{
<span class="nc" id="L269">			retBuffer.append(tmpBuffer);</span>
		}

<span class="nc" id="L272">		tmpBuffer = new StringBuffer();</span>
<span class="nc" id="L273">		String system = null;</span>
<span class="nc" id="L274">		retBuffer.append(&quot;\n\nKilled Background Receivers:\n&quot;);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">		for (Iterator it = allSystems.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L277">			system = (String) it.next();</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if ((!runningSystems.contains(system))</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">					&amp;&amp; (!stoppedSystems.contains(system)))</span>
			{
<span class="nc" id="L281">				tmpBuffer.append(&quot;\n&quot;).append(it.next());</span>
			}
		}
<span class="nc bnc" id="L284" title="All 2 branches missed.">		if (tmpBuffer.length() == 0)</span>
		{
<span class="nc" id="L286">			retBuffer.append(&quot;-&quot;);</span>
		}
		else
		{
<span class="nc" id="L290">			retBuffer.append(tmpBuffer);</span>
		}

<span class="nc bnc" id="L293" title="All 2 branches missed.">		if (ReceiverService.getInstance().isWatchdogRunning())</span>
		{
<span class="nc" id="L295">			retBuffer.append(&quot;\n\nWatchdog is running&quot;);</span>
		}
		else
		{
<span class="nc" id="L299">			retBuffer.append(&quot;\n\nWatchdog is NOT running !!!&quot;);</span>
		}

<span class="nc" id="L302">		return retBuffer.toString();</span>
	}

	/**
	 * Returns some information about the state of the Java Virtual Machine,
	 * containing memory consumption and information about the environment.
	 * 
	 * @return some information about the state of the Java Virtual Machine
	 */
	public String getJVMStatus()
	{
<span class="nc" id="L313">		StringBuffer retBuffer = new StringBuffer();</span>

<span class="nc" id="L315">		retBuffer.append(&quot;Resources:&quot;);</span>
<span class="nc" id="L316">		Runtime runtime = Runtime.getRuntime();</span>
<span class="nc" id="L317">		runtime.gc();</span>
<span class="nc" id="L318">		retBuffer.append(&quot;\n\nMaximum memory available:        &quot;</span>
<span class="nc" id="L319">				+ NumberFormat.getInstance().format(runtime.maxMemory())</span>
				+ &quot; bytes&quot;);
<span class="nc" id="L321">		retBuffer.append(&quot;\nMemory currently used:           &quot;</span>
<span class="nc" id="L322">				+ NumberFormat.getInstance().format(runtime.totalMemory())</span>
				+ &quot; bytes&quot;);
<span class="nc" id="L324">		retBuffer.append(&quot;\nFree memory currently available: &quot;</span>
<span class="nc" id="L325">				+ NumberFormat.getInstance().format(runtime.freeMemory())</span>
				+ &quot; bytes&quot;);
<span class="nc" id="L327">		retBuffer.append(&quot;\nAvailable processors:            &quot;</span>
<span class="nc" id="L328">				+ runtime.availableProcessors());</span>

<span class="nc" id="L330">		retBuffer.append(&quot;\n\nEnvironment:\n&quot;);</span>
<span class="nc" id="L331">		TreeSet envKeys = new TreeSet(System.getProperties().keySet());</span>
<span class="nc" id="L332">		String key = null;</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">		for (Iterator it = envKeys.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L335">			key = (String) it.next();</span>
<span class="nc" id="L336">			retBuffer.append(&quot;\n&quot; + key + &quot;=&quot; + System.getProperty(key));</span>
		}

<span class="nc" id="L339">		return retBuffer.toString();</span>
	}

	/**
	 * Demands the stop of a background receiver.
	 * 
	 * @param system the name of the system
	 * @return a confirmation or an error message
	 */
	public String demandStopBackgroundReceiver(String system)
	{
		try
		{
<span class="nc" id="L352">			ReceiverThreadManager manager = ReceiverThreadManager.getInstance();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">			if (!manager.getRunningSystems().contains(system))</span>
			{
<span class="nc" id="L355">				return new StringBuffer(system).append(</span>
<span class="nc" id="L356">						&quot; is not a started background receiver&quot;).toString();</span>
			}

<span class="nc" id="L359">			manager.demandStopReceiverThread(system);</span>
<span class="nc" id="L360">			return &quot;Stop for background receiver &quot; + system + &quot; demanded&quot;;</span>
		}
<span class="nc" id="L362">		catch (XException e)</span>
		{
<span class="nc" id="L364">			return e.getMessage();</span>
		}
	}

	/**
	 * Starts a background receiver.
	 * 
	 * @param system the name of the system
	 * @return a confirmation or an error message
	 */
	public String startBackgroundReceiver(String system)
	{
		try
		{
<span class="nc" id="L378">			ReceiverThreadManager manager = ReceiverThreadManager.getInstance();</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">			if (!manager.getAllSystems().contains(system))</span>
			{
<span class="nc" id="L381">				return new StringBuffer(system).append(</span>
						&quot; is not a configured configured background receiver&quot;)
<span class="nc" id="L383">						.toString();</span>
			}
<span class="nc bnc" id="L385" title="All 2 branches missed.">			if (manager.getRunningSystems().contains(system))</span>
			{
<span class="nc" id="L387">				return new StringBuffer(system).append(&quot; is already started&quot;)</span>
<span class="nc" id="L388">						.toString();</span>
			}

<span class="nc" id="L391">			manager.startReceiverThread(system);</span>
		}
<span class="nc" id="L393">		catch (XException e)</span>
		{
<span class="nc" id="L395">			return e.getMessage();</span>
<span class="nc" id="L396">		}</span>
<span class="nc" id="L397">		return &quot;Background receiver &quot; + system + &quot; started&quot;;</span>
	}

	/**
	 * Reads the filenames that are currently in the Deleted Message Store.
	 * 
	 * @return the filenames that are currently in the Deleted Message Store
	 */
	public String getDeletedMessageFilenames()
	{
		try
		{
			String[] filenames = DeletedMessageStore
<span class="nc" id="L410">					.getDeletedMessageFilenames();</span>

<span class="nc" id="L412">			StringBuffer retBuffer = new StringBuffer();</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">			for (int i = 0; i &lt; filenames.length; i++)</span>
			{
<span class="nc" id="L415">				retBuffer.append(filenames[i]).append(Constants.LINE_SEPERATOR);</span>
			}
<span class="nc" id="L417">			return retBuffer.toString();</span>
		}
<span class="nc" id="L419">		catch (XException e)</span>
		{
<span class="nc" id="L421">			return e.getMessage();</span>
		}
	}

	/**
	 * Resends a message from the Deleted Message Store
	 * 
	 * @param filename the filename of the deleted message
	 * @return a message of success or failure
	 */
	public String resendDeletedMessage(String filename)
	{
<span class="nc" id="L433">		return DeletedMessageStore.resendDeletedMessage(filename);</span>
	}

	/**
	 * Reads a file.
	 * 
	 * @param filename the name of the file including the directory
	 * @param maxLength maximum length to read in kbyte.
	 * @return the content of the file or an error message
	 */
	private String readFile(String filename, int maxLength)
	{
<span class="nc" id="L445">		StringBuffer retBuffer = new StringBuffer();</span>
<span class="nc" id="L446">		File sourceFile = new File(filename);</span>
		String zeile;

		try
		{
<span class="nc" id="L451">			BufferedReader buffReader = new BufferedReader(</span>
					new InputStreamReader(new FileInputStream(sourceFile)));

<span class="nc bnc" id="L454" title="All 2 branches missed.">			if ((zeile = buffReader.readLine()) != null)</span>
			{
<span class="nc" id="L456">				retBuffer.append(zeile);</span>
			} // if((zeile = buffReader.readLine()) != null)

<span class="nc bnc" id="L459" title="All 2 branches missed.">			while ((zeile = buffReader.readLine()) != null)</span>
			{
<span class="nc" id="L461">				retBuffer.append(Constants.LINE_SEPERATOR);</span>
<span class="nc" id="L462">				retBuffer.append(zeile);</span>
			} // while ((zeile = buffReader.readLine()) != null)
<span class="nc" id="L464">			buffReader.close();</span>
		}
<span class="nc" id="L466">		catch (IOException e)</span>
		{
<span class="nc" id="L468">			return XException.getExceptionInformation();</span>
<span class="nc" id="L469">		}</span>

<span class="nc bnc" id="L471" title="All 2 branches missed.">		if (maxLength &gt; 0)</span>
		{
<span class="nc" id="L473">			int bufferLength = retBuffer.length();</span>
<span class="nc" id="L474">			int endLength = bufferLength - maxLength * 1024;</span>
<span class="nc" id="L475">			retBuffer.delete(0, endLength);</span>
		} // if (expectedLength &gt; 0)
<span class="nc" id="L477">		return retBuffer.toString();</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>