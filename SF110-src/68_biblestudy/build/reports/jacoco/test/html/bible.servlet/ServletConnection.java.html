<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServletConnection.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">68_biblestudy</a> &gt; <a href="index.source.html" class="el_package">bible.servlet</a> &gt; <span class="el_source">ServletConnection.java</span></div><h1>ServletConnection.java</h1><pre class="source lang-java linenums">package bible.servlet;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintWriter;
import java.net.URL;
import java.net.MalformedURLException;
import java.util.Date;
import java.util.TimeZone;

import javax.servlet.http.*;
import javax.servlet.ServletRequest;

import bible.util.Logger;
import bible.util.Util;

/**
 * @author  James Stauffer
 * @version $Id: ServletConnection.java,v 1.1.1.1 2001/02/10 05:46:08 jstauffe Exp $
 */
public class ServletConnection {
    
    public ServletConnection(HttpServletRequest request, HttpServletResponse response) {
<span class="nc" id="L25">        this(request, response, System.currentTimeMillis());</span>
<span class="nc" id="L26">    }</span>
    
<span class="nc" id="L28">    public ServletConnection(HttpServletRequest request, HttpServletResponse response, long startTime) {</span>
<span class="nc" id="L29">        this.request = request;</span>
<span class="nc" id="L30">        this.response = response;</span>
<span class="nc" id="L31">        this.username = ServletUtil.GetUsername(request);</span>
<span class="nc" id="L32">        this.startTime = startTime;</span>
<span class="nc" id="L33">        UrlRequestLog.logStart(getUsername(), getStartTime(), getRemoteHost(), request.getRequestURI());</span>
        try {
<span class="nc" id="L35">            responseSent = false;</span>
<span class="nc" id="L36">            sos = new HTMLOutputStream(response);</span>
<span class="nc" id="L37">        } catch(IOException e) {</span>
<span class="nc" id="L38">            log(e);</span>
<span class="nc" id="L39">        }</span>
<span class="nc" id="L40">    }</span>
    
    public long getStartTime() {
<span class="nc" id="L43">        return startTime;</span>
    }
    
    public String getQueryString() {
<span class="nc" id="L47">        return request.getQueryString();</span>
    }
    
    public String getRemoteHost() {
<span class="nc" id="L51">        return request.getRemoteHost();</span>
    }
    
    public void log(Throwable e) {
<span class="nc" id="L55">        log(e, &quot;Unknown&quot;, true);</span>
<span class="nc" id="L56">    }</span>
    
    public void log(Throwable e, String servlet) {
<span class="nc" id="L59">        log(e, servlet, true);</span>
<span class="nc" id="L60">    }</span>
    
    /**
     * Doesn't try to send the content already generated.
     */
    public void log(Throwable e, String servlet, boolean displayErrorMessage) {//, String member
<span class="nc" id="L66">        Logger.Log(e, username);</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if(displayErrorMessage) {</span>
<span class="nc" id="L68">            displayError();</span>
        }
<span class="nc" id="L70">    }</span>
    
    public void log(String message) {
<span class="nc" id="L73">        Logger.Log(message);</span>
<span class="nc" id="L74">    }</span>
    
    public void flushResponse() throws IOException {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if(!responseSent) {</span>
<span class="nc" id="L78">            responseSent = true;</span>
        } else {
<span class="nc" id="L80">            log(new IOException(&quot;Warning: response already sent.&quot;));</span>
        }
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if(redirected) {</span>
<span class="nc" id="L83">            resetOutputStream();</span>
        } else {
<span class="nc" id="L85">            sos.flush();//Ideally this should only occur if(!responseSent)</span>
        }
<span class="nc" id="L87">    }</span>
    
    /**
     * Doesn't try to send the content already generated.
     */
    public void displayErrorMessage(String message) {
        try {
<span class="nc" id="L94">            sos = new HTMLOutputStream(response);</span>
<span class="nc" id="L95">            displayMessagePage(message);</span>
<span class="nc" id="L96">        } catch(IOException ioe) {</span>
<span class="nc" id="L97">            ioe.printStackTrace();</span>
<span class="nc" id="L98">        }</span>
<span class="nc" id="L99">    }</span>
    
    public void displayMessagePage(String message) {
<span class="nc" id="L102">        sendRedirect(&quot;/jsp/Message.jsp?s=&quot; + message);</span>
<span class="nc" id="L103">    }</span>
    
    public void sendRedirect(String location) {
        try {
<span class="nc" id="L107">            response.sendRedirect(location);</span>
<span class="nc" id="L108">        } catch(IOException e) {</span>
<span class="nc" id="L109">            Logger.Log(e, username);</span>
<span class="nc" id="L110">        }</span>
<span class="nc" id="L111">        redirected = true;</span>
<span class="nc" id="L112">    }</span>
    
    public void setRedirected() {
<span class="nc" id="L115">        redirected = true;</span>
<span class="nc" id="L116">    }</span>
    
    public boolean isRedirected() {
<span class="nc" id="L119">        return redirected;</span>
    }
    
    public String getUsername() {
<span class="nc" id="L123">        return username;</span>
    }
    
    public HttpServletRequest getRequest() {
<span class="nc" id="L127">        return request;</span>
    }
    
    public HttpServletResponse getResponse() {
<span class="nc" id="L131">        return response;</span>
    }

    public String getRequestParameter(String key) {
<span class="nc" id="L135">        return request.getParameter(key);</span>
    }
    
    public String[] getRequestParameters(String key) {
<span class="nc" id="L139">        return request.getParameterValues(key);</span>
    }
    
    public void logConnectionClose(boolean error) {
<span class="nc" id="L143">        UrlRequestLog.logEnd(getUsername(), getStartTime(), System.currentTimeMillis(), error);</span>
<span class="nc" id="L144">    }</span>
    
    public void redirectWithout(String parameter) throws IOException {
<span class="nc" id="L147">        sendRedirect(getURLwithout(parameter));</span>
<span class="nc" id="L148">    }</span>
    
    public void displayOfflineMessage() {
<span class="nc" id="L151">        sendRedirect(&quot;/jsp/Offline.jsp&quot;);</span>
<span class="nc" id="L152">    }</span>
    
    public void print(String line) {
<span class="nc" id="L155">        sos.print(line);</span>
<span class="nc" id="L156">    }</span>
    
    public void println(String line) {
<span class="nc" id="L159">        sos.println(line);</span>
<span class="nc" id="L160">    }</span>

    public PrintWriter getPW() {
<span class="nc" id="L163">        return sos.getPW();</span>
    }

    public InputStream getInputStream() throws IOException {
<span class="nc" id="L167">        return request.getInputStream();</span>
    }

    public boolean isBypassUser() {
<span class="nc" id="L171">        String[] bypassers = Base.GetOptions().getBypassAccounts();</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        for(int index = 0; index &lt; bypassers.length; index++) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if(bypassers[index].equals(username)) {</span>
<span class="nc" id="L174">                return true;</span>
            }
        }
<span class="nc" id="L177">        return false;</span>
    }
    
    /**
     * Returns a string describing the current log.
     */
    public void displayError() {
<span class="nc" id="L184">        sendRedirect(&quot;/jsp/Error.jsp?time=&quot; + System.currentTimeMillis());</span>
<span class="nc" id="L185">    }</span>
    
    public void resetOutputStream() throws IOException {
<span class="nc" id="L188">        int size = sos.getSize();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if(size &gt; 0) {</span>
<span class="nc" id="L190">            String contents = sos.reset();</span>
<span class="nc" id="L191">            log(Util.ToString(new IOException(&quot;Throwing away &quot; + size + &quot; bytes in &quot; + sos)) + &quot;Contents:&quot; + contents);</span>
        }
<span class="nc" id="L193">    }</span>

    /**
     * Very strict equal test.
     */
    public boolean equals(Object other) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">        return other == this;</span>
    }
    
    public String toString() {
<span class="nc bnc" id="L203" title="All 4 branches missed.">        return getClass().getName() + &quot;:[startTime=&quot; + startTime</span>
        + &quot;, username=&quot; + username
        + &quot;, &quot; + (responseSent ? &quot;&quot; : &quot;!&quot;) + &quot;responseSent&quot;
        + &quot;, &quot; + (redirected ? &quot;&quot; : &quot;!&quot;) + &quot;redirected&quot;
        + &quot;]&quot;;
    }

    private String getURLwithout(String parameter) {
<span class="nc" id="L211">        String startUrl = request.getRequestURI();</span>
<span class="nc" id="L212">        String endUrl = startUrl;</span>
<span class="nc" id="L213">        int startIndex = startUrl.indexOf(parameter);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if(startIndex &gt;= 0) {// found</span>
<span class="nc" id="L215">            endUrl = startUrl.substring(0, startIndex);// get part before</span>
            
<span class="nc" id="L217">            int endIndex = startUrl.indexOf(QUERY_SEP, startIndex + parameter.length());//Look for anything after</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if(endIndex &gt;= 0) {// basically &gt;= startIndex + parameter.length()</span>
<span class="nc" id="L219">                endUrl += startUrl.substring(endIndex + 1);// add part after</span>
                
            }
<span class="nc bnc" id="L222" title="All 2 branches missed.">            while(endUrl.endsWith(QUERY_SEP)) {// Remove &amp; if it is on the end</span>
<span class="nc" id="L223">                endUrl = endUrl.substring(0, endUrl.length() - QUERY_SEP.length());</span>
            }
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if(endUrl.endsWith(QUERY_CHAR)) {// Remove ? if it is on the end</span>
<span class="nc" id="L226">                endUrl = endUrl.substring(0, endUrl.length() - QUERY_CHAR.length());</span>
            }
        }
<span class="nc" id="L229">        return endUrl;</span>
    }
    
    private String getURLwith(String parameter) {
<span class="nc" id="L233">        String url = request.getRequestURI();</span>
        
<span class="nc" id="L235">        int queryCharIndex = url.indexOf(QUERY_CHAR);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if(queryCharIndex &gt;= 0) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if(queryCharIndex != (url.length() - 1)) {// Not last character(other stuff in query)</span>
<span class="nc" id="L238">                url += QUERY_SEP;</span>
            }
        } else {
<span class="nc" id="L241">            url += QUERY_CHAR;</span>
        }
        
<span class="nc" id="L244">        return url + parameter;</span>
    }
    
    public String getFullUrl(){
<span class="nc" id="L248">        String query = request.getQueryString();</span>
<span class="nc" id="L249">        String url = request.getRequestURI();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">        if (query != null)  {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (url.indexOf(QUERY_CHAR) == -1)  { // Jsdk2.0 case</span>
<span class="nc" id="L252">                url = url + QUERY_CHAR + query;</span>
            }
        }
<span class="nc" id="L255">        return url;</span>
    }
    
    private final static String QUERY_CHAR = &quot;?&quot;;
    private final static String QUERY_SEP  = &quot;&amp;&quot;;
    private boolean              responseSent;//Only used for debugging
<span class="nc" id="L261">    private boolean              redirected = false;</span>
    private long                 startTime;
    private HTMLOutputStream     sos;
    private HttpServletRequest   request;
    private HttpServletResponse  response;
    private String               username;
<span class="nc" id="L267">    private static URLRequestLog UrlRequestLog = new URLRequestLog();</span>
}

class URLRequestLog {
<span class="nc" id="L271">    public URLRequestLog() {</span>
<span class="nc" id="L272">        logger = new Logger(&quot;connection/&quot;);</span>
<span class="nc" id="L273">    }</span>
    
    public void logStart(String username, long startTime, String remoteHost, String URL) {
<span class="nc" id="L276">        logger.log(username + &quot;\t on \t&quot; + Logger.FormatDate(startTime) + &quot;\t from host \t&quot; + remoteHost</span>
            + &quot;\t for \t&quot; + URL);
<span class="nc" id="L278">    }</span>
    
    public void logEnd(String username, long startTime, long endTime, boolean error) {
<span class="nc bnc" id="L281" title="All 2 branches missed.">        logger.log(username + &quot;\t on \t&quot; + Logger.FormatDate(startTime) + &quot;\t closed after \t&quot;</span>
            + (endTime - startTime) + &quot;\t milliseconds&quot; + (error ? &quot;\t with error&quot; :&quot;&quot;));
<span class="nc" id="L283">    }</span>
    
    public void logMessage(String username, long startTime, String message) {
<span class="nc" id="L286">        logger.log(username + &quot;\t on \t&quot; + Logger.FormatDate(startTime) + &quot;\t &quot; + message);</span>
<span class="nc" id="L287">    }</span>
    
    private Logger logger;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>