<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Database.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">68_biblestudy</a> &gt; <a href="index.source.html" class="el_package">bible.util</a> &gt; <span class="el_source">Database.java</span></div><h1>Database.java</h1><pre class="source lang-java linenums">/**
 * Database.java: Manages all database access using JDBC
 */

package bible.util;

import java.io.*;
import java.sql.*;
import java.util.*;

/**
 * Manages all database access using JDBC
 *
 * @version $Id: Database.java,v 1.1.1.1 2001/02/10 05:46:08 jstauffe Exp $
 * @author  Umesh Berry
 */
public class Database {
<span class="fc" id="L18">    private Database() {</span>
<span class="fc" id="L19">        connectionBroker = new DbConnectionBroker();</span>
<span class="fc" id="L20">        String logDir = connectionBroker.getLog();</span>
<span class="pc bpc" id="L21" title="1 of 2 branches missed.">        if(logDir != null) {</span>
<span class="nc" id="L22">            log = new Logger(logDir);</span>
<span class="nc" id="L23">            log.log(connectionBroker.toString());</span>
<span class="nc" id="L24">            log.log(&quot;Start \tCreation Time \tIndex \tCreate Time String\tQuery&quot;);</span>
<span class="nc" id="L25">            log.log(&quot;End \tCreation Time \tElapsed Milliseconds&quot;);</span>
        }
<span class="fc" id="L27">    }</span>

    public static DbResult Query(String query) throws SQLException {
<span class="nc" id="L30">        return DefaultDatabase.query(query, true);</span>
    }

    private DbResult query(String query) throws SQLException {
<span class="nc" id="L34">        return query(query, true);</span>
    }

    private DbResult query(String query, boolean recursive) throws SQLException {

<span class="fc" id="L39">        String PREFIX = &quot;select &quot;;</span>
<span class="pc bpc" id="L40" title="1 of 2 branches missed.">        if(query.trim().substring(0, PREFIX.length()).equalsIgnoreCase(PREFIX)) {</span>
<span class="nc" id="L41">            DbConnectionAttributes connectionAttributes = getConnectionAttributes();</span>
<span class="nc" id="L42">            connectionAttributes.init(query);</span>
<span class="nc" id="L43">            logStart(connectionAttributes);</span>
            try {
<span class="nc" id="L45">                return new DbResult(connectionAttributes, connectionAttributes.executeQuery(), connectionBroker);</span>
<span class="nc" id="L46">            } catch(SQLException e) {</span>
<span class="nc" id="L47">                e.printStackTrace();</span>
<span class="nc bnc" id="L48" title="All 4 branches missed.">                if((e.getMessage() != null) &amp;&amp; (e.getMessage().indexOf(CONNECTION_ERROR) &gt;= 0)) {</span>
<span class="nc" id="L49">                    connectionBroker.disconnectAll();</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">                    if(recursive) {//Try one more time</span>
<span class="nc" id="L51">                        return query(query, false);</span>
                    }
                } else {
<span class="nc" id="L54">                    connectionBroker.release(connectionAttributes);</span>
                }
<span class="nc" id="L56">                throw new SQLException(&quot;Query=&quot; + query + &quot;\r\n&quot; + Util.ToString(e));</span>
            } finally {
<span class="nc" id="L58">                logEnd(connectionAttributes);</span>
            }
        } else {
<span class="nc" id="L61">            throw new SQLException(&quot;Query doesn't start with '&quot; + PREFIX + &quot;', but '&quot; + query.substring(0, PREFIX.length()) + &quot;' :&quot; + query);</span>
        }
    }

    public static int Update(String update) throws SQLException {
<span class="nc" id="L66">        return DefaultDatabase.update(update);</span>
    }

    private int update(String update) throws SQLException {
<span class="nc" id="L70">        int rowsChanged = 0;</span>
<span class="nc" id="L71">        DbConnectionAttributes connectionAttributes = getConnectionAttributes();</span>
<span class="nc" id="L72">        connectionAttributes.init(update);</span>
<span class="nc" id="L73">        logStart(connectionAttributes);</span>
        try {
<span class="nc" id="L75">            rowsChanged = connectionAttributes.executeUpdate();</span>
<span class="nc" id="L76">            connectionBroker.release(connectionAttributes);</span>
<span class="nc" id="L77">            return rowsChanged;</span>
<span class="nc" id="L78">        } catch(SQLException e) {</span>
<span class="nc bnc" id="L79" title="All 4 branches missed.">            if((e.getMessage() != null) &amp;&amp; (e.getMessage().indexOf(CONNECTION_ERROR) &gt;= 0)) {</span>
<span class="nc" id="L80">                connectionBroker.disconnectAll();</span>
            } else {
<span class="nc" id="L82">                connectionBroker.release(connectionAttributes);</span>
            }
<span class="nc" id="L84">            throw e;</span>
        } finally {
<span class="nc" id="L86">            logEnd(connectionAttributes);</span>
<span class="nc" id="L87">            connectionAttributes.reset();</span>
        }
    }

    public static int Insert(String insert) throws SQLException {
<span class="nc" id="L92">        String[] inserts = new String[1];</span>
<span class="nc" id="L93">        inserts[0] = insert;</span>
<span class="nc" id="L94">        return DefaultDatabase.insert(inserts, true)[0];</span>
    }

    /**
     * Useful for passing in multiple inserts to do in batches
     * @author James Stauffer
     */
    public static int[] BatchInsert(String[] inserts, int countPerBatch) throws SQLException {
<span class="nc" id="L102">        int [] ids = new int[inserts.length];</span>
        int [] batchIds;
<span class="nc" id="L104">        String[] insertBatch = new String[countPerBatch];</span>
<span class="nc" id="L105">        int fullBatches = inserts.length / countPerBatch;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        for(int index = 0; index &lt; fullBatches; index++) {</span>
<span class="nc" id="L107">            System.arraycopy(inserts, index * countPerBatch, insertBatch, 0, countPerBatch);//Copy inserts in batch to separate array</span>
<span class="nc" id="L108">            batchIds = DefaultDatabase.insert(insertBatch, false);</span>
<span class="nc" id="L109">            System.arraycopy(batchIds, 0, ids, index * countPerBatch, countPerBatch);//Copy ids back</span>
        }

<span class="nc" id="L112">        int lastBatchSize = inserts.length % countPerBatch;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if(lastBatchSize &gt; 0) {</span>
<span class="nc" id="L114">            insertBatch = new String[lastBatchSize];</span>
<span class="nc" id="L115">            System.arraycopy(inserts, inserts.length - lastBatchSize, insertBatch, 0, insertBatch.length);//Copy inserts in batch to separate array</span>
<span class="nc" id="L116">            batchIds = DefaultDatabase.insert(insertBatch, false);</span>
<span class="nc" id="L117">            System.arraycopy(batchIds, 0, ids, inserts.length - lastBatchSize, lastBatchSize);//Copy ids back</span>
        }
<span class="nc" id="L119">        return ids;</span>
    }

    /**
     * @author James Stauffer
     */
    public static int Insert(String insert, boolean returnID) throws SQLException {
<span class="nc" id="L126">        String[] inserts = new String[1];</span>
<span class="nc" id="L127">        inserts[0] = insert;</span>
<span class="nc" id="L128">        return DefaultDatabase.insert(inserts, returnID)[0];</span>
    }

    private int insert(String insert) throws SQLException {
<span class="nc" id="L132">        String[] inserts = new String[1];</span>
<span class="nc" id="L133">        inserts[0] = insert;</span>
<span class="nc" id="L134">        return insert(inserts, true)[0];</span>
    }

    /**
     * Creates inserts for the results of the select.
     * @param insert Something like &quot;insert into web_complete_Document (form_number, transaction_status, web_doc_uid)&quot;
     * @param select Something like &quot;select form_number, transaction_status, 4321 from web_complete_Document where web_doc_uid = 1234&quot;
     * @author James Stauffer
     */
    private int[] selectInsert(String insert, String select) throws SQLException {
<span class="nc" id="L144">        DbResult result = null;</span>
        try {
<span class="nc" id="L146">            Vector inserts = new Vector();</span>
            Vector values;
<span class="nc" id="L148">            result = query(select);</span>
<span class="nc" id="L149">            ResultSetMetaData metaData = result.getMetaData();</span>
<span class="nc" id="L150">            int columns = metaData.getColumnCount();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            while(result.next()) {</span>
<span class="nc" id="L152">                values = new Vector();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                for(int col = 1; col &lt;= columns; col++) {</span>
<span class="nc" id="L154">                    Object obj = result.getObject(col);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                    if(obj instanceof String) {</span>
<span class="nc" id="L156">                        values.addElement(&quot;'&quot; + obj + &quot;'&quot;);</span>
                    } else {
<span class="nc" id="L158">                        values.addElement(obj.toString());</span>
                    }
                }
<span class="nc" id="L161">                inserts.addElement(insert + &quot; values(&quot; + Util.ToString(values, false, &quot;, &quot;) + &quot;)&quot;);</span>
            }
<span class="nc" id="L163">            DbResult.Close(result);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if(inserts.size() &gt; 0) {</span>
<span class="nc" id="L165">                return insert(Util.ToStringArray(inserts), true);</span>
            } else {// nothing returned by the select
<span class="nc" id="L167">                return new int[0];</span>
            }
        } finally {
<span class="nc" id="L170">            DbResult.Close(result);</span>
        }
    }

    /**
     * @param returnID false means that no extra work(db call) will be done to find the id
     * @author James Stauffer(Modified)
     */
    private int[] insert(String inserts[], boolean returnID) throws SQLException {
<span class="nc" id="L179">        DbConnectionAttributes connectionAttributes = getConnectionAttributes();</span>
<span class="nc" id="L180">        connectionAttributes.init(Util.ToString(inserts, false, &quot; &quot;));</span>
<span class="nc" id="L181">        logStart(connectionAttributes);</span>
        try {
<span class="nc" id="L183">            int[] id = new int[inserts.length];</span>
<span class="nc" id="L184">            connectionAttributes.executeUpdate();</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">            if(returnID) {//To get the last identity value, use the @@IDENTITY global variable.</span>
<span class="nc" id="L187">                ResultSet rs = connectionAttributes.executeQuery(&quot;select @@identity id&quot;);</span>
<span class="nc" id="L188">                rs.next();</span>
<span class="nc" id="L189">                id[0] = rs.getInt(&quot;id&quot;);</span>
<span class="nc" id="L190">                rs.close();</span>
            }

<span class="nc" id="L193">            connectionBroker.release(connectionAttributes);</span>
<span class="nc" id="L194">            return id;</span>
<span class="nc" id="L195">        } catch(SQLException e) {</span>
<span class="nc bnc" id="L196" title="All 4 branches missed.">            if((e.getMessage() != null) &amp;&amp; (e.getMessage().indexOf(CONNECTION_ERROR) &gt;= 0)) {</span>
<span class="nc" id="L197">                connectionBroker.disconnectAll();</span>
            } else {
<span class="nc" id="L199">                connectionBroker.release(connectionAttributes);</span>
            }
<span class="nc" id="L201">            throw e;</span>
        } finally {
<span class="nc" id="L203">            logEnd(connectionAttributes);</span>
<span class="nc" id="L204">            connectionAttributes.reset();</span>
        }
    }

    /***
     * Creates a prepared statement using the connection managed by the database manager
     *
     * @author Michael Lee
     * @see &lt;a href=&quot;http://java.sun.com/docs/books/tutorial/jdbc/basics/prepared.html&quot;&gt;JDBC Prepared Statements Tutorial&lt;/a&gt;
     */
    private PreparedStatement prepareStatement(String query) throws SQLException {
<span class="nc" id="L215">        DbConnectionAttributes connectionAttributes = getConnectionAttributes();</span>
<span class="nc" id="L216">        connectionAttributes.init(query);</span>
<span class="nc" id="L217">        logStart(connectionAttributes);</span>
        try {
<span class="nc" id="L219">            return connectionAttributes.prepareStatement();</span>
        } finally {
<span class="nc" id="L221">            logEnd(connectionAttributes);</span>
        }
    }

    public static PreparedStatement PrepareStatement(String query) throws SQLException {
<span class="nc" id="L226">        return DefaultDatabase.prepareStatement(query);</span>
    }

    /**
     * Excecutes a prepared statement and returns a DbResult.  It assumes that any parameters have been properly
     * filled into the prepared statement.
     *
     * @author Michael Lee
     * @see &lt;a href=&quot;http://java.sun.com/docs/books/tutorial/jdbc/basics/prepared.html&quot;&gt;JDBC Prepared Statements Tutorial&lt;/a&gt;
     * @param recursive true if there are some conditions where if the query fails we should retry the query.
     */
    private DbResult preparedStatement(PreparedStatement statement, boolean recursive) throws SQLException {
<span class="nc" id="L238">        DbConnectionAttributes connectionAttributes = getConnectionAttributes();</span>
<span class="nc" id="L239">        connectionAttributes.init(statement.toString());</span>
<span class="nc" id="L240">        logStart(connectionAttributes);</span>
        try {

            try {
<span class="nc" id="L244">               return new DbResult(connectionAttributes, statement.executeQuery(), connectionBroker);</span>
<span class="nc" id="L245">            } catch(SQLException e) {</span>
<span class="nc" id="L246">                e.printStackTrace();</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">                if((e.getMessage() != null) &amp;&amp; (e.getMessage().indexOf(CONNECTION_ERROR) &gt;= 0)) {</span>
<span class="nc" id="L248">                    connectionBroker.disconnectAll();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">                    if(recursive) {//Try one more time</span>
<span class="nc" id="L250">                       return preparedStatement(statement, false);</span>
                    }
                } else {
<span class="nc" id="L253">                    connectionBroker.release(connectionAttributes);</span>
                }
<span class="nc" id="L255">                throw e;</span>
            }
        } finally {
<span class="nc" id="L258">            logEnd(connectionAttributes);</span>
        }
    }

    /**
     * Excecutes a prepared statement and returns a DbResult.  It assumes that any parameters have been properly
     * filled into the prepared statement.
     *
     * @author Michael Lee
     * @see &lt;a href=&quot;http://java.sun.com/docs/books/tutorial/jdbc/basics/prepared.html&quot;&gt;JDBC Prepared Statements Tutorial&lt;/a&gt;
     */
    private DbResult preparedStatement(PreparedStatement statement) throws SQLException {
<span class="nc" id="L270">       return preparedStatement(statement, true);</span>
    }

    public static DbResult PreparedStatement(PreparedStatement statement) throws SQLException {
<span class="nc" id="L274">       return DefaultDatabase.preparedStatement(statement, true);</span>
    }


    public static String Escape(String s) {
<span class="nc" id="L279">        int index = s.indexOf(ESCAPE_CHAR);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (index != -1) {</span>
<span class="nc" id="L281">            s = s.substring(0, index) + ESCAPE_CHAR + ESCAPE_CHAR + Escape(s.substring(index+1));</span>
        }
<span class="nc" id="L283">        return s;</span>
    }

    public static DbConnectionBroker GetConnectionBroker() {
<span class="nc" id="L287">        return DefaultDatabase.connectionBroker;</span>
    }

    public static String GetTableName(String insertQuery) {
<span class="nc" id="L291">        StringTokenizer st = new StringTokenizer(insertQuery, &quot;( &quot;);</span>
<span class="nc" id="L292">        String dummy = st.nextToken();</span>
<span class="nc" id="L293">        dummy = st.nextToken();</span>
<span class="nc" id="L294">        return st.nextToken();</span>
    }

    public String toString() {
<span class="nc" id="L298">        return getClass().getName() + &quot;[ connectionBroker=&quot; + connectionBroker</span>
            + &quot;]&quot;;
    }

    public static DbConnectionAttributes GetConnectionAttributes() throws SQLException {
<span class="nc" id="L303">        return DefaultDatabase.connectionBroker.getConnectionAttributes();</span>
    }

    private DbConnectionAttributes getConnectionAttributes() throws SQLException {
<span class="nc" id="L307">        return connectionBroker.getConnectionAttributes();</span>
    }

    private void logStart(DbConnectionAttributes ca) throws SQLException {
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if(log != null) {</span>
<span class="nc" id="L312">            log.log(&quot;Start \t&quot; + ca.getCreationTime() + &quot; \t&quot; + ca.getIndex()</span>
<span class="nc" id="L313">                + &quot; \t&quot; + Logger.FormatDate(ca.getCreationTime()) + &quot;\t&quot; + ca.getQuery());</span>
        }
<span class="nc" id="L315">    }</span>

    private void logEnd(DbConnectionAttributes ca) throws SQLException {
<span class="nc bnc" id="L318" title="All 2 branches missed.">        if(log != null) {</span>
<span class="nc" id="L319">            log.log(&quot;End \t&quot; + ca.getCreationTime() + &quot; \t&quot; + (System.currentTimeMillis() - ca.getCreationTime()));</span>
        }
<span class="nc" id="L321">    }</span>

    private DbConnectionBroker connectionBroker;
    private Logger log;
    private static Database DefaultDatabase;
    private static final char ESCAPE_CHAR = '\'';
    private static final String CONNECTION_ERROR = &quot;Connection reset by peer&quot;;

    static {
    	try {
<span class="fc" id="L331">    		DefaultDatabase = new Database();</span>
<span class="nc" id="L332">    	} catch(Throwable e) {</span>
<span class="nc" id="L333">    			e.printStackTrace(System.out);</span>
<span class="fc" id="L334">    	}</span>
<span class="fc" id="L335">    }</span>

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>