<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultIndexEngine.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">42_asphodel</a> &gt; <a href="index.source.html" class="el_package">org.asphodel.index</a> &gt; <span class="el_source">DefaultIndexEngine.java</span></div><h1>DefaultIndexEngine.java</h1><pre class="source lang-java linenums">package org.asphodel.index;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.document.Document;
import org.apache.lucene.document.Field;
import org.apache.lucene.document.DateTools;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.store.FSDirectory;
import org.asphodel.parser.ContentParserException;
import org.asphodel.FtrException;
import org.asphodel.FtrConstants;
import org.asphodel.AsphodelServiceLocator;
import org.asphodel.AsphodelConfig;

import java.io.IOException;
import java.io.File;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;
import java.util.Collection;

/**
 * @author sunwj
 * @version 0.1
 * @since 0.1
 *        Date: Apr 3, 2007
 *        Time: 12:25:46 PM
 *        default implementation of the indexEngine. If you are using a IOC,te repositoryDirectory can be configured.
 */
public class DefaultIndexEngine implements IndexEngine {
<span class="nc" id="L33">    private static final Log log = LogFactory.getLog(DefaultIndexEngine.class);</span>
<span class="nc" id="L34">    private String repositoryDirectory = null;</span>

<span class="nc" id="L36">    public DefaultIndexEngine(String repository) {</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">        if (repository == null) {</span>
<span class="nc" id="L38">            repository = AsphodelConfig.getDefaultRepository();</span>
        }
<span class="nc" id="L40">        this.repositoryDirectory =</span>
<span class="nc" id="L41">                new File(AsphodelConfig.getRepositoryHousePath(), repository).getAbsolutePath();</span>
<span class="nc" id="L42">    }</span>



    public void createIndex(Collection&lt;Indexee&gt; indexees) throws FtrException {

<span class="nc" id="L48">    }</span>

    /**
     * create index using the given content.
     * TODO: save the page in cache with highlighted.
     *
     * @param indexee the target to be indexed
     */
    public void createIndex(Indexee indexee) throws FtrException {
<span class="nc" id="L57">        IndexWriter indexWriter = null;</span>
        try {
<span class="nc" id="L59">            indexWriter = new IndexWriter(FSDirectory.getDirectory(this.repositoryDirectory), this.getAnalyzer());</span>

<span class="nc" id="L61">            Document document = this.composeIndexeeDocument(indexee);</span>

<span class="nc" id="L63">            indexWriter.addDocument(document);</span>

<span class="nc" id="L65">        } catch (ContentParserException cpe) {</span>
<span class="nc" id="L66">            log.error(&quot;failed to parse the content&quot;, cpe);</span>
<span class="nc" id="L67">            throw new FtrException(&quot;failed to parse the content&quot;, cpe);</span>
<span class="nc" id="L68">        } catch (IOException e) {</span>
<span class="nc" id="L69">            log.error(&quot;when indexing.&quot;, e);</span>
<span class="nc" id="L70">            throw new FtrException(&quot;failed to execute the index operation&quot;, e);</span>
        } finally {
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (indexWriter != null)</span>
                try {
<span class="nc" id="L74">                    indexWriter.close();</span>
<span class="nc" id="L75">                } catch (IOException ioe) {</span>
<span class="nc" id="L76">                    log.warn(&quot;indexWriter closed error:&quot; + ioe.getMessage());</span>
<span class="nc" id="L77">                }</span>
        }
<span class="nc" id="L79">    }</span>

    /**
     * compose the document,which will contain all the filed to be indexed.
     */
    private Document composeIndexeeDocument(Indexee indexee) throws ContentParserException {
<span class="nc" id="L85">        Document document = new Document();</span>

<span class="nc" id="L87">        String content = indexee.getIndexeeContent().getContent();</span>
<span class="nc" id="L88">        String uri = indexee.getUri();</span>
<span class="nc" id="L89">        checkFields(new String[]{uri});</span>

//        document.add(new Field(FtrConstants.FIELD_CONTENT, reader,Field.TermVector.YES));
<span class="nc" id="L92">        document.add(new Field(FtrConstants.FIELD_CONTENT, content, Field.Store.YES, Field.Index.TOKENIZED));</span>
<span class="nc" id="L93">        document.add(new Field(FtrConstants.FIELD_URI, uri, Field.Store.YES, Field.Index.NO));</span>

<span class="nc" id="L95">        document.add(new Field(FtrConstants.FIELD_CACHEDDATE,</span>
<span class="nc" id="L96">                DateTools.timeToString(System.currentTimeMillis(), DateTools.Resolution.DAY),</span>
                Field.Store.YES,
                Field.Index.NO));

<span class="nc" id="L100">        Map otherIndexeeFields = indexee.getOtherFields();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (otherIndexeeFields != null) {</span>
<span class="nc" id="L102">            Set set = otherIndexeeFields.keySet();</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            for (Iterator iterator = set.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L104">                String key = (String) iterator.next();</span>
<span class="nc" id="L105">                Object fieldValue = otherIndexeeFields.get(key);</span>

                //todo how to deal with the date field                if(fieldValue instanceof java.util.Date) 
<span class="nc" id="L108">                document.add(new Field(key, (String) fieldValue, Field.Store.YES, Field.Index.UN_TOKENIZED));</span>
<span class="nc" id="L109">            }</span>
        }

<span class="nc" id="L112">        return document;</span>
    }

    private void checkFields(String[] values) throws IllegalArgumentException {
<span class="nc bnc" id="L116" title="All 2 branches missed.">        for (int i = 0; i &lt; values.length; i++) {</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">            if (values[i] == null || values[i].equals(&quot;&quot;))</span>
<span class="nc" id="L118">                throw new IllegalArgumentException(&quot;the value is not allowed null:&quot; + i);</span>
        }
<span class="nc" id="L120">    }</span>

    private Analyzer getAnalyzer() {
<span class="nc" id="L123">        return AsphodelServiceLocator.getAnalyzer();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>