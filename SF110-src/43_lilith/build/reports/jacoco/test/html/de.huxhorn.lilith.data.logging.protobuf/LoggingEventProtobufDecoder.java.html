<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoggingEventProtobufDecoder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">43_lilith</a> &gt; <a href="index.source.html" class="el_package">de.huxhorn.lilith.data.logging.protobuf</a> &gt; <span class="el_source">LoggingEventProtobufDecoder.java</span></div><h1>LoggingEventProtobufDecoder.java</h1><pre class="source lang-java linenums">/*
 * Lilith - a log event viewer.
 * Copyright (C) 2007-2009 Joern Huxhorn
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package de.huxhorn.lilith.data.logging.protobuf;

import de.huxhorn.lilith.data.logging.ExtendedStackTraceElement;
import de.huxhorn.lilith.data.logging.LoggerContext;
import de.huxhorn.lilith.data.logging.LoggingEvent;
import de.huxhorn.lilith.data.logging.Marker;
import de.huxhorn.lilith.data.logging.Message;
import de.huxhorn.lilith.data.logging.ThreadInfo;
import de.huxhorn.lilith.data.logging.ThrowableInfo;
import de.huxhorn.lilith.data.logging.protobuf.generated.LoggingProto;
import de.huxhorn.sulky.codec.Decoder;

import com.google.protobuf.InvalidProtocolBufferException;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.zip.GZIPInputStream;

public class LoggingEventProtobufDecoder
	implements Decoder&lt;LoggingEvent&gt;
{
	private boolean compressing;

	public LoggingEventProtobufDecoder(boolean compressing)
<span class="nc" id="L45">	{</span>
<span class="nc" id="L46">		this.compressing = compressing;</span>
<span class="nc" id="L47">	}</span>

	public boolean isCompressing()
	{
<span class="nc" id="L51">		return compressing;</span>
	}

	public void setCompressing(boolean compressing)
	{
<span class="nc" id="L56">		this.compressing = compressing;</span>
<span class="nc" id="L57">	}</span>

	public LoggingEvent decode(byte[] bytes)
	{
<span class="nc bnc" id="L61" title="All 2 branches missed.">		if(bytes == null)</span>
		{
<span class="nc" id="L63">			return null;</span>
		}
<span class="nc" id="L65">		LoggingProto.LoggingEvent parsedEvent = null;</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">		if(!compressing)</span>
		{
			try
			{
<span class="nc" id="L70">				parsedEvent = LoggingProto.LoggingEvent.parseFrom(bytes);</span>
			}
<span class="nc" id="L72">			catch(InvalidProtocolBufferException e)</span>
			{
				// ignore
<span class="nc" id="L75">			}</span>
		}
		else
		{
<span class="nc" id="L79">			ByteArrayInputStream in = new ByteArrayInputStream(bytes);</span>
			try
			{
<span class="nc" id="L82">				GZIPInputStream gis = new GZIPInputStream(in);</span>
<span class="nc" id="L83">				parsedEvent = LoggingProto.LoggingEvent.parseFrom(gis);</span>
<span class="nc" id="L84">				gis.close();</span>
			}
<span class="nc" id="L86">			catch(IOException e)</span>
			{
				// ignore
<span class="nc" id="L89">			}</span>
		}
<span class="nc" id="L91">		return convert(parsedEvent);</span>
	}

	public static Marker convert(LoggingProto.Marker marker)
	{
<span class="nc bnc" id="L96" title="All 2 branches missed.">		if(marker == null)</span>
		{
<span class="nc" id="L98">			return null;</span>
		}
<span class="nc" id="L100">		Map&lt;String, Marker&gt; markers = new HashMap&lt;String, Marker&gt;();</span>
<span class="nc" id="L101">		return convert(marker, markers);</span>
	}

	private static Marker convert(LoggingProto.Marker marker, Map&lt;String, Marker&gt; markers)
	{
<span class="nc" id="L106">		String markerName = marker.getName();</span>

<span class="nc" id="L108">		Marker result = markers.get(markerName);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">		if(result == null)</span>
		{
			// new marker
<span class="nc" id="L112">			result = new Marker();</span>
<span class="nc" id="L113">			result.setName(markerName);</span>
<span class="nc" id="L114">			markers.put(markerName, result);</span>
		}

<span class="nc" id="L117">		int refCount = marker.getReferenceCount();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if(refCount &gt; 0)</span>
		{
<span class="nc" id="L120">			List&lt;LoggingProto.Marker&gt; refList = marker.getReferenceList();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">			for(LoggingProto.Marker current : refList)</span>
			{
<span class="nc" id="L123">				result.add(convert(current, markers));</span>
<span class="nc" id="L124">			}</span>
		}

<span class="nc" id="L127">		return result;</span>
	}

	public static ExtendedStackTraceElement convert(LoggingProto.StackTraceElement ste)
	{
<span class="nc bnc" id="L132" title="All 2 branches missed.">		if(ste == null)</span>
		{
<span class="nc" id="L134">			return null;</span>
		}

<span class="nc" id="L137">		ExtendedStackTraceElement result = new ExtendedStackTraceElement();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">		if(ste.hasMethodName())</span>
		{
<span class="nc" id="L140">			result.setMethodName(ste.getMethodName());</span>
		}

<span class="nc bnc" id="L143" title="All 2 branches missed.">		if(ste.hasClassName())</span>
		{
<span class="nc" id="L145">			result.setClassName(ste.getClassName());</span>
		}

<span class="nc bnc" id="L148" title="All 2 branches missed.">		if(ste.hasFileName())</span>
		{
<span class="nc" id="L150">			result.setFileName(ste.getFileName());</span>
		}

<span class="nc bnc" id="L153" title="All 2 branches missed.">		if(ste.hasLineNumber())</span>
		{
<span class="nc" id="L155">			result.setLineNumber(ste.getLineNumber());</span>
		}

<span class="nc bnc" id="L158" title="All 2 branches missed.">		if(ste.hasCodeLocation())</span>
		{
<span class="nc" id="L160">			result.setCodeLocation(ste.getCodeLocation());</span>
		}

<span class="nc bnc" id="L163" title="All 2 branches missed.">		if(ste.hasVersion())</span>
		{
<span class="nc" id="L165">			result.setVersion(ste.getVersion());</span>
		}

<span class="nc bnc" id="L168" title="All 2 branches missed.">		if(ste.hasExact())</span>
		{
<span class="nc" id="L170">			result.setExact(ste.getExact());</span>
		}

<span class="nc" id="L173">		return result;</span>

	}

	public static ThrowableInfo convert(LoggingProto.Throwable throwable)
	{
<span class="nc bnc" id="L179" title="All 2 branches missed.">		if(throwable == null)</span>
		{
<span class="nc" id="L181">			return null;</span>
		}

<span class="nc" id="L184">		ThrowableInfo result = new ThrowableInfo();</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">		if(throwable.hasThrowableClass())</span>
		{
<span class="nc" id="L188">			result.setName(throwable.getThrowableClass());</span>
		}

<span class="nc bnc" id="L191" title="All 2 branches missed.">		if(throwable.hasMessage())</span>
		{
<span class="nc" id="L193">			result.setMessage(throwable.getMessage());</span>
		}

<span class="nc bnc" id="L196" title="All 2 branches missed.">		if(throwable.hasOmittedElements())</span>
		{
<span class="nc" id="L198">			result.setOmittedElements(throwable.getOmittedElements());</span>
		}

<span class="nc bnc" id="L201" title="All 2 branches missed.">		if(throwable.hasCause())</span>
		{
<span class="nc" id="L203">			result.setCause(convert(throwable.getCause()));</span>
		}

		{
<span class="nc" id="L207">			int count = throwable.getStackTraceElementCount();</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">			if(count &gt; 0)</span>
			{
<span class="nc" id="L210">				ExtendedStackTraceElement[] stackTrace = new ExtendedStackTraceElement[count];</span>
<span class="nc" id="L211">				List&lt;LoggingProto.StackTraceElement&gt; stackTraceElementList = throwable.getStackTraceElementList();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">				for(int i = 0; i &lt; count; i++)</span>
				{
<span class="nc" id="L214">					stackTrace[i] = convert(stackTraceElementList.get(i));</span>
				}
<span class="nc" id="L216">				result.setStackTrace(stackTrace);</span>
			}
		}
<span class="nc" id="L219">		return result;</span>
	}

	public static Message convert(LoggingProto.Message parsedMessage)
	{
<span class="nc bnc" id="L224" title="All 2 branches missed.">		if(parsedMessage == null)</span>
		{
<span class="nc" id="L226">			return null;</span>
		}
<span class="nc" id="L228">		Message result = new Message();</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		if(parsedMessage.hasMessagePattern())</span>
		{
<span class="nc" id="L231">			result.setMessagePattern(parsedMessage.getMessagePattern());</span>
		}
<span class="nc" id="L233">		int argumentCount = parsedMessage.getArgumentCount();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">		if(argumentCount &gt; 0)</span>
		{
<span class="nc" id="L236">			String[] arguments = new String[argumentCount];</span>
<span class="nc" id="L237">			List&lt;LoggingProto.MessageArgument&gt; argumentList = parsedMessage.getArgumentList();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">			for(int i = 0; i &lt; argumentCount; i++)</span>
			{
<span class="nc" id="L240">				LoggingProto.MessageArgument current = argumentList.get(i);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">				if(current.hasValue())</span>
				{
<span class="nc" id="L243">					arguments[i] = current.getValue();</span>
				}
			}
<span class="nc" id="L246">			result.setArguments(arguments);</span>
		}
<span class="nc" id="L248">		return result;</span>
	}

	public static ThreadInfo convert(LoggingProto.ThreadInfo parsedThreadInfo)
	{
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if(parsedThreadInfo == null)</span>
		{
<span class="nc" id="L255">			return null;</span>
		}
<span class="nc" id="L257">		Long threadId = null;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">		if(parsedThreadInfo.hasId())</span>
		{
<span class="nc" id="L260">			threadId = parsedThreadInfo.getId();</span>
		}
<span class="nc" id="L262">		String threadName = null;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">		if(parsedThreadInfo.hasName())</span>
		{
<span class="nc" id="L265">			threadName = parsedThreadInfo.getName();</span>
		}
<span class="nc" id="L267">		Long threadGroupId = null;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if(parsedThreadInfo.hasGroupId())</span>
		{
<span class="nc" id="L270">			threadGroupId = parsedThreadInfo.getGroupId();</span>
		}
<span class="nc" id="L272">		String threadGroupName = null;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">		if(parsedThreadInfo.hasGroupName())</span>
		{
<span class="nc" id="L275">			threadGroupName = parsedThreadInfo.getGroupName();</span>
		}
<span class="nc" id="L277">		return new ThreadInfo(threadId, threadName, threadGroupId, threadGroupName);</span>
	}

	public static LoggerContext convert(LoggingProto.LoggerContext loggerContext)
	{
<span class="nc bnc" id="L282" title="All 2 branches missed.">		if(loggerContext == null)</span>
		{
<span class="nc" id="L284">			return null;</span>
		}
<span class="nc" id="L286">		LoggerContext result = new LoggerContext();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if(loggerContext.hasName())</span>
		{
<span class="nc" id="L289">			result.setName(loggerContext.getName());</span>
		}
<span class="nc bnc" id="L291" title="All 2 branches missed.">		if(loggerContext.hasBirthTime())</span>
		{
<span class="nc" id="L293">			result.setBirthTime(loggerContext.getBirthTime());</span>
		}
<span class="nc bnc" id="L295" title="All 2 branches missed.">		if(loggerContext.hasProperties())</span>
		{
<span class="nc" id="L297">			result.setProperties(convert(loggerContext.getProperties()));</span>
		}
<span class="nc" id="L299">		return result;</span>
	}

	public static Map&lt;String, String&gt; convert(LoggingProto.StringMap stringMap)
	{
<span class="nc bnc" id="L304" title="All 2 branches missed.">		if(stringMap == null)</span>
		{
<span class="nc" id="L306">			return null;</span>
		}
<span class="nc bnc" id="L308" title="All 2 branches missed.">		if(stringMap.getEntryCount() &gt; 0)</span>
		{
<span class="nc" id="L310">			Map&lt;String, String&gt; result = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L311">			List&lt;LoggingProto.StringMapEntry&gt; mdcList = stringMap.getEntryList();</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			for(LoggingProto.StringMapEntry current : mdcList)</span>
			{
<span class="nc" id="L314">				String key = current.getKey();</span>
<span class="nc" id="L315">				String value = null;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">				if(current.hasValue())</span>
				{
<span class="nc" id="L318">					value = current.getValue();</span>
				}
<span class="nc" id="L320">				result.put(key, value);</span>
<span class="nc" id="L321">			}</span>
<span class="nc" id="L322">			return result;</span>
		}

<span class="nc" id="L325">		return null;</span>
	}

	public static LoggingEvent convert(LoggingProto.LoggingEvent parsedEvent)
	{
<span class="nc bnc" id="L330" title="All 2 branches missed.">		if(parsedEvent == null)</span>
		{
<span class="nc" id="L332">			return null;</span>
		}

<span class="nc" id="L335">		LoggingEvent result = new LoggingEvent();</span>

		// handling loggerName
<span class="nc bnc" id="L338" title="All 2 branches missed.">		if(parsedEvent.hasLoggerName())</span>
		{
<span class="nc" id="L340">			result.setLogger(parsedEvent.getLoggerName());</span>
		}

		// handling sequence number
<span class="nc bnc" id="L344" title="All 2 branches missed.">		if(parsedEvent.hasSequenceNumber())</span>
		{
<span class="nc" id="L346">			result.setSequenceNumber(parsedEvent.getSequenceNumber());</span>
		}

		// handling threadInfo
<span class="nc bnc" id="L350" title="All 2 branches missed.">		if(parsedEvent.hasThreadInfo())</span>
		{
<span class="nc" id="L352">			result.setThreadInfo(convert(parsedEvent.getThreadInfo()));</span>
		}

		// handling level
<span class="nc bnc" id="L356" title="All 2 branches missed.">		if(parsedEvent.hasLevel())</span>
		{
<span class="nc" id="L358">			LoggingProto.Level level = parsedEvent.getLevel();</span>
<span class="nc bnc" id="L359" title="All 6 branches missed.">			switch(level)</span>
			{
				case TRACE:
<span class="nc" id="L362">					result.setLevel(LoggingEvent.Level.TRACE);</span>
<span class="nc" id="L363">					break;</span>
				case DEBUG:
<span class="nc" id="L365">					result.setLevel(LoggingEvent.Level.DEBUG);</span>
<span class="nc" id="L366">					break;</span>
				case INFO:
<span class="nc" id="L368">					result.setLevel(LoggingEvent.Level.INFO);</span>
<span class="nc" id="L369">					break;</span>
				case WARN:
<span class="nc" id="L371">					result.setLevel(LoggingEvent.Level.WARN);</span>
<span class="nc" id="L372">					break;</span>
				case ERROR:
<span class="nc" id="L374">					result.setLevel(LoggingEvent.Level.ERROR);</span>
					break;
			}
		}

		// handle LoggerContext
<span class="nc bnc" id="L380" title="All 2 branches missed.">		if(parsedEvent.hasLoggerContext())</span>
		{
<span class="nc" id="L382">			result.setLoggerContext(convert(parsedEvent.getLoggerContext()));</span>
		}

		// handle Throwable
<span class="nc bnc" id="L386" title="All 2 branches missed.">		if(parsedEvent.hasThrowable())</span>
		{
<span class="nc" id="L388">			result.setThrowable(convert(parsedEvent.getThrowable()));</span>
		}

		// handle Marker
<span class="nc bnc" id="L392" title="All 2 branches missed.">		if(parsedEvent.hasMarker())</span>
		{
<span class="nc" id="L394">			result.setMarker(convert(parsedEvent.getMarker()));</span>

		}

		// handle CallStack
		{
<span class="nc" id="L400">			int count = parsedEvent.getCallStackElementCount();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">			if(count &gt; 0)</span>
			{
<span class="nc" id="L403">				List&lt;LoggingProto.StackTraceElement&gt; callStackElements = parsedEvent.getCallStackElementList();</span>
<span class="nc" id="L404">				ExtendedStackTraceElement[] callStack = new ExtendedStackTraceElement[count];</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">				for(int i = 0; i &lt; count; i++)</span>
				{
<span class="nc" id="L407">					LoggingProto.StackTraceElement current = callStackElements.get(i);</span>
<span class="nc" id="L408">					callStack[i] = convert(current);</span>
				}
<span class="nc" id="L410">				result.setCallStack(callStack);</span>
			}
		}

		// handling timestamp
<span class="nc bnc" id="L415" title="All 2 branches missed.">		if(parsedEvent.hasTimeStamp())</span>
		{
<span class="nc" id="L417">			result.setTimeStamp(parsedEvent.getTimeStamp());</span>
		}

		// handling event message
<span class="nc bnc" id="L421" title="All 2 branches missed.">		if(parsedEvent.hasMessage())</span>
		{
<span class="nc" id="L423">			result.setMessage(convert(parsedEvent.getMessage()));</span>
		}

		// handling MappedDiagnosticContext
<span class="nc bnc" id="L427" title="All 2 branches missed.">		if(parsedEvent.hasMappedDiagnosticContext())</span>
		{
<span class="nc" id="L429">			result.setMdc(convert(parsedEvent.getMappedDiagnosticContext()));</span>
		}

		// handling NestedDiagnosticContext
<span class="nc bnc" id="L433" title="All 2 branches missed.">		if(parsedEvent.hasNestedDiagnosticContext())</span>
		{
<span class="nc" id="L435">			LoggingProto.NestedDiagnosticContext parsedNdc = parsedEvent.getNestedDiagnosticContext();</span>
<span class="nc" id="L436">			int entryCount = parsedNdc.getEntryCount();</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">			if(entryCount &gt; 0)</span>
			{
<span class="nc" id="L439">				List&lt;LoggingProto.Message&gt; entryList = parsedNdc.getEntryList();</span>
<span class="nc" id="L440">				Message[] ndc = new Message[entryCount];</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">				for(int i = 0; i &lt; entryCount; i++)</span>
				{
<span class="nc" id="L443">					ndc[i] = convert(entryList.get(i));</span>
				}
<span class="nc" id="L445">				result.setNdc(ndc);</span>
			}
		}
<span class="nc" id="L448">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>