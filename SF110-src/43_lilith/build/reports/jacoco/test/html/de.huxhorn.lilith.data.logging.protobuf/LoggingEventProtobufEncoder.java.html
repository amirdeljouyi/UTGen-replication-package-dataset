<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoggingEventProtobufEncoder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">43_lilith</a> &gt; <a href="index.source.html" class="el_package">de.huxhorn.lilith.data.logging.protobuf</a> &gt; <span class="el_source">LoggingEventProtobufEncoder.java</span></div><h1>LoggingEventProtobufEncoder.java</h1><pre class="source lang-java linenums">/*
 * Lilith - a log event viewer.
 * Copyright (C) 2007-2009 Joern Huxhorn
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package de.huxhorn.lilith.data.logging.protobuf;

import de.huxhorn.lilith.data.logging.ExtendedStackTraceElement;
import de.huxhorn.lilith.data.logging.LoggerContext;
import de.huxhorn.lilith.data.logging.LoggingEvent;
import de.huxhorn.lilith.data.logging.Marker;
import de.huxhorn.lilith.data.logging.Message;
import de.huxhorn.lilith.data.logging.ThreadInfo;
import de.huxhorn.lilith.data.logging.ThrowableInfo;
import de.huxhorn.lilith.data.logging.protobuf.generated.LoggingProto;
import de.huxhorn.sulky.codec.Encoder;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.zip.GZIPOutputStream;

public class LoggingEventProtobufEncoder
	implements Encoder&lt;LoggingEvent&gt;
{
	private boolean compressing;

	public LoggingEventProtobufEncoder(boolean compressing)
<span class="nc" id="L43">	{</span>
<span class="nc" id="L44">		this.compressing = compressing;</span>
<span class="nc" id="L45">	}</span>

	public boolean isCompressing()
	{
<span class="nc" id="L49">		return compressing;</span>
	}

	public void setCompressing(boolean compressing)
	{
<span class="nc" id="L54">		this.compressing = compressing;</span>
<span class="nc" id="L55">	}</span>

	public byte[] encode(LoggingEvent event)
	{
<span class="nc" id="L59">		LoggingProto.LoggingEvent converted = convert(event);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">		if(converted == null)</span>
		{
<span class="nc" id="L62">			return null;</span>
		}
<span class="nc bnc" id="L64" title="All 2 branches missed.">		if(!compressing)</span>
		{
<span class="nc" id="L66">			return converted.toByteArray();</span>
		}
<span class="nc" id="L68">		ByteArrayOutputStream out = new ByteArrayOutputStream();</span>
		GZIPOutputStream gos;
		try
		{
<span class="nc" id="L72">			gos = new GZIPOutputStream(out);</span>
<span class="nc" id="L73">			converted.writeTo(gos);</span>
<span class="nc" id="L74">			gos.flush();</span>
<span class="nc" id="L75">			gos.close();</span>
<span class="nc" id="L76">			return out.toByteArray();</span>
		}
<span class="nc" id="L78">		catch(IOException e)</span>
		{
			// ignore
		}
<span class="nc" id="L82">		return null;</span>
	}

	public static LoggingProto.Marker convert(Marker marker)
	{
<span class="nc bnc" id="L87" title="All 2 branches missed.">		if(marker == null)</span>
		{
<span class="nc" id="L89">			return null;</span>
		}
<span class="nc" id="L91">		List&lt;String&gt; handledMarkers = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L92">		return convert(marker, handledMarkers);</span>
	}

	private static LoggingProto.Marker convert(Marker marker, List&lt;String&gt; handledMarkers)
	{
<span class="nc" id="L97">		String markerName = marker.getName();</span>
<span class="nc" id="L98">		LoggingProto.Marker.Builder builder = LoggingProto.Marker.newBuilder().setName(markerName);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">		if(handledMarkers.contains(markerName))</span>
		{
<span class="nc" id="L101">			return builder.build();</span>
		}
<span class="nc" id="L103">		handledMarkers.add(markerName);</span>
<span class="nc" id="L104">		boolean hasReferences = marker.hasReferences();</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if(hasReferences)</span>
		{
<span class="nc" id="L107">			Map&lt;String, Marker&gt; refs = marker.getReferences();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			for(Map.Entry&lt;String, Marker&gt; current : refs.entrySet())</span>
			{
<span class="nc" id="L110">				builder.addReference(convert(current.getValue(), handledMarkers));</span>
<span class="nc" id="L111">			}</span>
		}

<span class="nc" id="L114">		return builder.build();</span>
	}

	public static LoggingProto.StackTraceElement convert(ExtendedStackTraceElement ste)
	{
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if(ste == null)</span>
		{
<span class="nc" id="L121">			return null;</span>
		}
<span class="nc" id="L123">		LoggingProto.StackTraceElement.Builder builder = LoggingProto.StackTraceElement.newBuilder();</span>

		{
<span class="nc" id="L126">			String methodName = ste.getMethodName();</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">			if(methodName != null)</span>
			{
<span class="nc" id="L129">				builder.setMethodName(methodName);</span>
			}
		}

		{
<span class="nc" id="L134">			String className = ste.getClassName();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">			if(className != null)</span>
			{
<span class="nc" id="L137">				builder.setClassName(className);</span>
			}
		}

		{
<span class="nc" id="L142">			String fileName = ste.getFileName();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			if(fileName != null)</span>
			{
<span class="nc" id="L145">				builder.setFileName(fileName);</span>
			}
		}

		{
<span class="nc" id="L150">			int lineNumber = ste.getLineNumber();</span>
<span class="nc" id="L151">			builder.setLineNumber(lineNumber);</span>
		}

		{
<span class="nc" id="L155">			String codeLocation = ste.getCodeLocation();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">			if(codeLocation != null)</span>
			{
<span class="nc" id="L158">				builder.setCodeLocation(codeLocation);</span>
			}
		}

		{
<span class="nc" id="L163">			String version = ste.getVersion();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">			if(version != null)</span>
			{
<span class="nc" id="L166">				builder.setVersion(version);</span>
			}
		}

<span class="nc" id="L170">		builder.setExact(ste.isExact());</span>

<span class="nc" id="L172">		return builder.build();</span>
	}

	public static LoggingProto.Throwable convert(ThrowableInfo throwableInfo)
	{
<span class="nc bnc" id="L177" title="All 2 branches missed.">		if(throwableInfo == null)</span>
		{
<span class="nc" id="L179">			return null;</span>
		}
<span class="nc" id="L181">		LoggingProto.Throwable.Builder builder = LoggingProto.Throwable.newBuilder();</span>

		{
<span class="nc" id="L184">			String name = throwableInfo.getName();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">			if(name != null)</span>
			{
<span class="nc" id="L187">				builder.setThrowableClass(name);</span>
			}
		}

		{
<span class="nc" id="L192">			String message = throwableInfo.getMessage();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">			if(message != null)</span>
			{
<span class="nc" id="L195">				builder.setMessage(message);</span>
			}
		}

		{
<span class="nc" id="L200">			int omittedElements = throwableInfo.getOmittedElements();</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if(omittedElements &gt; 0)</span>
			{
<span class="nc" id="L203">				builder.setOmittedElements(omittedElements);</span>
			}
		}

		{
<span class="nc" id="L208">			ThrowableInfo cause = throwableInfo.getCause();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			if(cause != null)</span>
			{
<span class="nc" id="L211">				builder.setCause(convert(cause));</span>
			}
		}

		{
<span class="nc" id="L216">			ExtendedStackTraceElement[] stackTrace = throwableInfo.getStackTrace();</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">			if(stackTrace != null)</span>
			{
<span class="nc bnc" id="L219" title="All 2 branches missed.">				for(ExtendedStackTraceElement current : stackTrace)</span>
				{
<span class="nc bnc" id="L221" title="All 2 branches missed.">					if(current != null)</span>
					{
<span class="nc" id="L223">						builder.addStackTraceElement(convert(current));</span>
					}
				}
			}
		}
<span class="nc" id="L228">		return builder.build();</span>
	}

	public static LoggingProto.Message convert(Message message)
	{
<span class="nc bnc" id="L233" title="All 2 branches missed.">		if(message == null)</span>
		{
<span class="nc" id="L235">			return null;</span>
		}
<span class="nc" id="L237">		LoggingProto.Message.Builder messageBuilder = LoggingProto.Message.newBuilder();</span>
<span class="nc" id="L238">		messageBuilder.setMessagePattern(message.getMessagePattern());</span>

<span class="nc" id="L240">		String[] arguments = message.getArguments();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">		if(arguments != null)</span>
		{
<span class="nc bnc" id="L243" title="All 2 branches missed.">			for(String current : arguments)</span>
			{
<span class="nc" id="L245">				LoggingProto.MessageArgument.Builder argumentBuilder = LoggingProto.MessageArgument.newBuilder();</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">				if(current != null)</span>
				{
<span class="nc" id="L248">					argumentBuilder.setValue(current);</span>
				}
<span class="nc" id="L250">				messageBuilder.addArgument(argumentBuilder.build());</span>
			}
		}
<span class="nc" id="L253">		return messageBuilder.build();</span>
	}

	public static LoggingProto.ThreadInfo convert(ThreadInfo threadInfo)
	{
<span class="nc bnc" id="L258" title="All 2 branches missed.">		if(threadInfo == null)</span>
		{
<span class="nc" id="L260">			return null;</span>
		}
<span class="nc" id="L262">		LoggingProto.ThreadInfo.Builder builder = LoggingProto.ThreadInfo.newBuilder();</span>

		{
<span class="nc" id="L265">			String name = threadInfo.getName();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">			if(name != null)</span>
			{
<span class="nc" id="L268">				builder.setName(name);</span>
			}
		}

		{
<span class="nc" id="L273">			Long id = threadInfo.getId();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			if(id != null)</span>
			{
<span class="nc" id="L276">				builder.setId(id);</span>
			}
		}

		{
<span class="nc" id="L281">			String name = threadInfo.getGroupName();</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">			if(name != null)</span>
			{
<span class="nc" id="L284">				builder.setGroupName(name);</span>
			}
		}

		{
<span class="nc" id="L289">			Long id = threadInfo.getGroupId();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">			if(id != null)</span>
			{
<span class="nc" id="L292">				builder.setGroupId(id);</span>
			}
		}
<span class="nc" id="L295">		return builder.build();</span>
	}

	public static LoggingProto.LoggerContext convert(LoggerContext context)
	{
<span class="nc bnc" id="L300" title="All 2 branches missed.">		if(context == null)</span>
		{
<span class="nc" id="L302">			return null;</span>
		}
<span class="nc" id="L304">		LoggingProto.LoggerContext.Builder builder = LoggingProto.LoggerContext.newBuilder();</span>
		{
<span class="nc" id="L306">			String name = context.getName();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">			if(name != null)</span>
			{
<span class="nc" id="L309">				builder.setName(name);</span>
			}
		}
		{
<span class="nc" id="L313">			Long birthTime = context.getBirthTime();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">			if(birthTime != null)</span>
			{
<span class="nc" id="L316">				builder.setBirthTime(birthTime);</span>
			}
		}
		{
<span class="nc" id="L320">			Map&lt;String, String&gt; map = context.getProperties();</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">			if(map != null &amp;&amp; map.size() &gt; 0)</span>
			{
<span class="nc" id="L323">				builder.setProperties(convert(map));</span>
			}
		}
<span class="nc" id="L326">		return builder.build();</span>

	}

	public static LoggingProto.StringMap convert(Map&lt;String, String&gt; map)
	{
<span class="nc bnc" id="L332" title="All 2 branches missed.">		if(map == null)</span>
		{
<span class="nc" id="L334">			return null;</span>
		}
<span class="nc" id="L336">		LoggingProto.StringMap.Builder builder = LoggingProto.StringMap.newBuilder();</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">		for(Map.Entry&lt;String, String&gt; current : map.entrySet())</span>
		{
<span class="nc" id="L339">			LoggingProto.StringMapEntry.Builder entryBuilder = LoggingProto.StringMapEntry.newBuilder()</span>
<span class="nc" id="L340">				.setKey(current.getKey());</span>
<span class="nc" id="L341">			String value = current.getValue();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">			if(value != null)</span>
			{
<span class="nc" id="L344">				entryBuilder.setValue(value);</span>
			}
<span class="nc" id="L346">			builder.addEntry(entryBuilder.build());</span>
<span class="nc" id="L347">		}</span>
<span class="nc" id="L348">		return builder.build();</span>
	}

	public static LoggingProto.LoggingEvent convert(LoggingEvent event)
	{
<span class="nc bnc" id="L353" title="All 2 branches missed.">		if(event == null)</span>
		{
<span class="nc" id="L355">			return null;</span>
		}
<span class="nc" id="L357">		LoggingProto.LoggingEvent.Builder eventBuilder = LoggingProto.LoggingEvent.newBuilder();</span>

		// handling loggerName
		{
<span class="nc" id="L361">			String loggerName = event.getLogger();</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">			if(loggerName != null)</span>
			{
<span class="nc" id="L364">				eventBuilder.setLoggerName(loggerName);</span>
			}
		}

		// handling sequence number
		{
<span class="nc" id="L370">			Long sequence = event.getSequenceNumber();</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">			if(sequence != null)</span>
			{
<span class="nc" id="L373">				eventBuilder.setSequenceNumber(sequence);</span>
			}
		}

		// handling threadInfo
		{
<span class="nc" id="L379">			ThreadInfo threadInfo = event.getThreadInfo();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">			if(threadInfo != null)</span>
			{
<span class="nc" id="L382">				eventBuilder.setThreadInfo(convert(threadInfo));</span>
			}
		}

		// handling level
		{
<span class="nc" id="L388">			LoggingEvent.Level level = event.getLevel();</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">			if(level != null)</span>
			{
<span class="nc bnc" id="L391" title="All 6 branches missed.">				switch(level)</span>
				{
					case TRACE:
<span class="nc" id="L394">						eventBuilder.setLevel(LoggingProto.Level.TRACE);</span>
<span class="nc" id="L395">						break;</span>
					case DEBUG:
<span class="nc" id="L397">						eventBuilder.setLevel(LoggingProto.Level.DEBUG);</span>
<span class="nc" id="L398">						break;</span>
					case INFO:
<span class="nc" id="L400">						eventBuilder.setLevel(LoggingProto.Level.INFO);</span>
<span class="nc" id="L401">						break;</span>
					case WARN:
<span class="nc" id="L403">						eventBuilder.setLevel(LoggingProto.Level.WARN);</span>
<span class="nc" id="L404">						break;</span>
					case ERROR:
<span class="nc" id="L406">						eventBuilder.setLevel(LoggingProto.Level.ERROR);</span>
						break;
				}
			}
		}

		// handle LoggerContext
		{
<span class="nc" id="L414">			LoggerContext context = event.getLoggerContext();</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">			if(context != null)</span>
			{
<span class="nc" id="L417">				eventBuilder.setLoggerContext(convert(context));</span>
			}
		}

		// handle Throwable
		{
<span class="nc" id="L423">			ThrowableInfo throwable = event.getThrowable();</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">			if(throwable != null)</span>
			{
<span class="nc" id="L426">				eventBuilder.setThrowable(convert(throwable));</span>
			}
		}

		// handle Marker
		{
<span class="nc" id="L432">			Marker marker = event.getMarker();</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">			if(marker != null)</span>
			{
<span class="nc" id="L435">				eventBuilder.setMarker(convert(marker));</span>
			}
		}

		// handle CallStack
		{
<span class="nc" id="L441">			ExtendedStackTraceElement[] callStack = event.getCallStack();</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">			if(callStack != null)</span>
			{
<span class="nc bnc" id="L444" title="All 2 branches missed.">				for(ExtendedStackTraceElement current : callStack)</span>
				{
<span class="nc bnc" id="L446" title="All 2 branches missed.">					if(current != null)</span>
					{
<span class="nc" id="L448">						eventBuilder.addCallStackElement(convert(current));</span>
					}
				}
			}
		}

		// handling timestamp
		{
<span class="nc" id="L456">			Long timeStamp = event.getTimeStamp();</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">			if(timeStamp != null)</span>
			{
<span class="nc" id="L459">				eventBuilder.setTimeStamp(timeStamp);</span>
			}
		}

		// handling event message
		{
<span class="nc" id="L465">			Message message = event.getMessage();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">			if(message != null)</span>
			{
<span class="nc" id="L468">				eventBuilder.setMessage(convert(message));</span>
			}
		}

		// handling MappedDiagnosticContext
<span class="nc" id="L473">		Map&lt;String, String&gt; mdc = event.getMdc();</span>
<span class="nc bnc" id="L474" title="All 4 branches missed.">		if(mdc != null &amp;&amp; mdc.size() &gt; 0)</span>
		{
<span class="nc" id="L476">			eventBuilder.setMappedDiagnosticContext(convert(mdc));</span>
		}

		// handling NestedDiagnosticContext
<span class="nc" id="L480">		Message[] ndc = event.getNdc();</span>
<span class="nc bnc" id="L481" title="All 4 branches missed.">		if(ndc != null &amp;&amp; ndc.length &gt; 0)</span>
		{
<span class="nc" id="L483">			LoggingProto.NestedDiagnosticContext.Builder ndcBuilder = LoggingProto.NestedDiagnosticContext.newBuilder();</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">			for(Message currentMessage : ndc)</span>
			{
<span class="nc" id="L486">				ndcBuilder.addEntry(convert(currentMessage));</span>
			}
<span class="nc" id="L488">			eventBuilder.setNestedDiagnosticContext(ndcBuilder.build());</span>
		}

<span class="nc" id="L491">		return eventBuilder.build();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>