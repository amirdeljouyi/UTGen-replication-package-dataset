<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Slf4JHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">43_lilith</a> &gt; <a href="index.source.html" class="el_package">de.huxhorn.lilith.handler</a> &gt; <span class="el_source">Slf4JHandler.java</span></div><h1>Slf4JHandler.java</h1><pre class="source lang-java linenums">/*
 * Lilith - a log event viewer.
 * Copyright (C) 2007-2009 Joern Huxhorn
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 * 
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package de.huxhorn.lilith.handler;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;

import java.util.logging.Handler;
import java.util.logging.Level;
import java.util.logging.LogRecord;

/**
 * &lt;p&gt;A java.util.logging.Handler that simply forwards LogRecords to the respective
 * org.slf4j.Logger.&lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;Usage example:&lt;br /&gt;
 * &lt;tt&gt;&lt;pre&gt;
 * {
 * // initialize java.util.logging to use slf4j...
 * Handler handler = new Slf4JHandler();
 * java.util.logging.Logger rootLogger = java.util.logging.Logger.getLogger(&quot;&quot;);
 * rootLogger.addHandler(handler);
 * rootLogger.setLevel(java.util.logging.Level.ALL);
 * }
 * &lt;/pre&gt;&lt;/tt&gt;&lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;&lt;b&gt;Keep in mind that the above code enables all logging, even for &lt;tt&gt;java.*&lt;/tt&gt;, &lt;tt&gt;javax.*&lt;/tt&gt;
 * and &lt;tt&gt;sun.*&lt;/tt&gt;!&lt;/b&gt;&lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;This means that you will most likely have to set the log level of those three packages to a sane value
 * like &lt;tt&gt;INFO&lt;/tt&gt; or &lt;tt&gt;WARN&lt;/tt&gt;.&lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;It's also possible to set those levels before the LogRecord reaches the Handler:&lt;br/&gt;
 * &lt;tt&gt;&lt;pre&gt;
 * {
 * java.util.logging.Logger.getLogger(&quot;java&quot;).setLevel(java.util.logging.Level.WARNING);
 * java.util.logging.Logger.getLogger(&quot;javax&quot;).setLevel(java.util.logging.Level.WARNING);
 * java.util.logging.Logger.getLogger(&quot;sun&quot;).setLevel(java.util.logging.Level.WARNING);
 * }
 * &lt;/pre&gt;&lt;/tt&gt;&lt;/p&gt;
 */
<span class="nc" id="L58">public class Slf4JHandler</span>
	extends Handler
{
<span class="nc" id="L61">	private static final int TRACE_LEVEL_THRESHOLD = Level.FINEST.intValue();</span>
<span class="nc" id="L62">	private static final int DEBUG_LEVEL_THRESHOLD = Level.FINE.intValue();</span>
<span class="nc" id="L63">	private static final int INFO_LEVEL_THRESHOLD = Level.INFO.intValue();</span>
<span class="nc" id="L64">	private static final int WARN_LEVEL_THRESHOLD = Level.WARNING.intValue();</span>

	private static final String LEVEL_MDC_KEY = &quot;JUL-Level&quot;;
	private static final String SOURCE_CLASS_NAME_MDC_KEY = &quot;JUL-SourceClassName&quot;;
	private static final String SOURCE_METHOD_NAME_MDC_KEY = &quot;JUL-SourceMethodName&quot;;

	/**
	 * Publish a &lt;tt&gt;LogRecord&lt;/tt&gt;.
	 * &lt;p/&gt;
	 * The logging request was made initially to a &lt;tt&gt;Logger&lt;/tt&gt; object,
	 * which initialized the &lt;tt&gt;LogRecord&lt;/tt&gt; and forwarded it here.
	 * &lt;p/&gt;
	 * The &lt;tt&gt;Handler&lt;/tt&gt;  is responsible for formatting the message, when and
	 * if necessary.  The formatting should include localization.
	 *
	 * @param record description of the log event. A null record is
	 *               silently ignored and is not published
	 */
	public void publish(LogRecord record)
	{
<span class="nc bnc" id="L84" title="All 2 branches missed.">		if(record != null)</span>
		{
<span class="nc" id="L86">			logRecord(record);</span>
		}
<span class="nc" id="L88">	}</span>


	/**
	 * Flush any buffered output.
	 */
	public void flush()
	{
<span class="nc" id="L96">	}</span>

	/**
	 * Close the &lt;tt&gt;Handler&lt;/tt&gt; and free all associated resources.
	 * &lt;p/&gt;
	 * The close method will perform a &lt;tt&gt;flush&lt;/tt&gt; and then close the
	 * &lt;tt&gt;Handler&lt;/tt&gt;.   After close has been called this &lt;tt&gt;Handler&lt;/tt&gt;
	 * should no longer be used.  Method calls may either be silently
	 * ignored or may throw runtime exceptions.
	 *
	 * @throws SecurityException if a security manager exists and if
	 *                           the caller does not have &lt;tt&gt;LoggingPermission(&quot;control&quot;)&lt;/tt&gt;.
	 */
	public void close()
		throws SecurityException
	{
<span class="nc" id="L112">	}</span>

	private void logRecord(LogRecord record)
	{
<span class="nc" id="L116">		Level julLevel = record.getLevel();</span>
<span class="nc" id="L117">		int julLevelValue = julLevel.intValue();</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if(julLevelValue &lt;= TRACE_LEVEL_THRESHOLD)</span>
		{
<span class="nc" id="L120">			logTrace(record);</span>
		}
<span class="nc bnc" id="L122" title="All 2 branches missed.">		else if(julLevelValue &lt;= DEBUG_LEVEL_THRESHOLD)</span>
		{
<span class="nc" id="L124">			logDebug(record);</span>
		}
<span class="nc bnc" id="L126" title="All 2 branches missed.">		else if(julLevelValue &lt;= INFO_LEVEL_THRESHOLD)</span>
		{
<span class="nc" id="L128">			logInfo(record);</span>
		}
<span class="nc bnc" id="L130" title="All 2 branches missed.">		else if(julLevelValue &lt;= WARN_LEVEL_THRESHOLD)</span>
		{
<span class="nc" id="L132">			logWarn(record);</span>
		}
		else
		{
<span class="nc" id="L136">			logError(record);</span>
		}
<span class="nc" id="L138">	}</span>

	private void logTrace(LogRecord record)
	{
<span class="nc" id="L142">		String loggerName = record.getLoggerName();</span>
<span class="nc" id="L143">		final Logger logger = LoggerFactory.getLogger(loggerName);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">		if(logger.isTraceEnabled())</span>
		{
<span class="nc" id="L146">			initMDC(record);</span>
<span class="nc" id="L147">			String message = record.getMessage();</span>
<span class="nc" id="L148">			Throwable throwable = record.getThrown();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if(throwable != null)</span>
			{
<span class="nc" id="L151">				logger.trace(message, throwable);</span>
			}
			else
			{
<span class="nc" id="L155">				logger.trace(message);</span>
			}
<span class="nc" id="L157">			clearMDC();</span>
		}
<span class="nc" id="L159">	}</span>

	private void logDebug(LogRecord record)
	{
<span class="nc" id="L163">		String loggerName = record.getLoggerName();</span>
<span class="nc" id="L164">		final Logger logger = LoggerFactory.getLogger(loggerName);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if(logger.isDebugEnabled())</span>
		{
<span class="nc" id="L167">			initMDC(record);</span>
<span class="nc" id="L168">			String message = record.getMessage();</span>
<span class="nc" id="L169">			Throwable throwable = record.getThrown();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">			if(throwable != null)</span>
			{
<span class="nc" id="L172">				logger.debug(message, throwable);</span>
			}
			else
			{
<span class="nc" id="L176">				logger.debug(message);</span>
			}
<span class="nc" id="L178">			clearMDC();</span>
		}
<span class="nc" id="L180">	}</span>

	private void logInfo(LogRecord record)
	{
<span class="nc" id="L184">		String loggerName = record.getLoggerName();</span>
<span class="nc" id="L185">		final Logger logger = LoggerFactory.getLogger(loggerName);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">		if(logger.isInfoEnabled())</span>
		{
<span class="nc" id="L188">			initMDC(record);</span>
<span class="nc" id="L189">			String message = record.getMessage();</span>
<span class="nc" id="L190">			Throwable throwable = record.getThrown();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">			if(throwable != null)</span>
			{
<span class="nc" id="L193">				logger.info(message, throwable);</span>
			}
			else
			{
<span class="nc" id="L197">				logger.info(message);</span>
			}
<span class="nc" id="L199">			clearMDC();</span>
		}
<span class="nc" id="L201">	}</span>

	private void logWarn(LogRecord record)
	{
<span class="nc" id="L205">		String loggerName = record.getLoggerName();</span>
<span class="nc" id="L206">		final Logger logger = LoggerFactory.getLogger(loggerName);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">		if(logger.isWarnEnabled())</span>
		{
<span class="nc" id="L209">			initMDC(record);</span>
<span class="nc" id="L210">			String message = record.getMessage();</span>
<span class="nc" id="L211">			Throwable throwable = record.getThrown();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if(throwable != null)</span>
			{
<span class="nc" id="L214">				logger.warn(message, throwable);</span>
			}
			else
			{
<span class="nc" id="L218">				logger.warn(message);</span>
			}
<span class="nc" id="L220">			clearMDC();</span>
		}
<span class="nc" id="L222">	}</span>

	private void logError(LogRecord record)
	{
<span class="nc" id="L226">		String loggerName = record.getLoggerName();</span>
<span class="nc" id="L227">		final Logger logger = LoggerFactory.getLogger(loggerName);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">		if(logger.isErrorEnabled())</span>
		{
<span class="nc" id="L230">			initMDC(record);</span>
<span class="nc" id="L231">			String message = record.getMessage();</span>
<span class="nc" id="L232">			Throwable throwable = record.getThrown();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">			if(throwable != null)</span>
			{
<span class="nc" id="L235">				logger.error(message, throwable);</span>
			}
			else
			{
<span class="nc" id="L239">				logger.error(message);</span>
			}
<span class="nc" id="L241">			clearMDC();</span>
		}
<span class="nc" id="L243">	}</span>


	private void initMDC(LogRecord record)
	{
<span class="nc" id="L248">		Level julLevel = record.getLevel();</span>
<span class="nc" id="L249">		MDC.put(LEVEL_MDC_KEY, julLevel.getName());</span>
<span class="nc" id="L250">		String sourceClassName = record.getSourceClassName();</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">		if(sourceClassName != null)</span>
		{
<span class="nc" id="L253">			MDC.put(SOURCE_CLASS_NAME_MDC_KEY, sourceClassName);</span>
		}
<span class="nc" id="L255">		String sourceMethodName = record.getSourceMethodName();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">		if(sourceMethodName != null)</span>
		{
<span class="nc" id="L258">			MDC.put(SOURCE_METHOD_NAME_MDC_KEY, sourceMethodName);</span>
		}
<span class="nc" id="L260">	}</span>

	private void clearMDC()
	{
<span class="nc" id="L264">		MDC.remove(LEVEL_MDC_KEY);</span>
<span class="nc" id="L265">		MDC.remove(SOURCE_CLASS_NAME_MDC_KEY);</span>
<span class="nc" id="L266">		MDC.remove(SOURCE_METHOD_NAME_MDC_KEY);</span>
<span class="nc" id="L267">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>