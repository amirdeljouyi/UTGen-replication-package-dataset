<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccessEventProtobufEncoder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">43_lilith</a> &gt; <a href="index.source.html" class="el_package">de.huxhorn.lilith.data.access.protobuf</a> &gt; <span class="el_source">AccessEventProtobufEncoder.java</span></div><h1>AccessEventProtobufEncoder.java</h1><pre class="source lang-java linenums">/*
 * Lilith - a log event viewer.
 * Copyright (C) 2007-2009 Joern Huxhorn
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package de.huxhorn.lilith.data.access.protobuf;

import de.huxhorn.lilith.data.access.AccessEvent;
import de.huxhorn.lilith.data.access.LoggerContext;
import de.huxhorn.lilith.data.access.protobuf.generated.AccessProto;
import de.huxhorn.sulky.codec.Encoder;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.Date;
import java.util.Map;
import java.util.zip.GZIPOutputStream;

public class AccessEventProtobufEncoder
	implements Encoder&lt;AccessEvent&gt;
{
	private boolean compressing;

	public AccessEventProtobufEncoder(boolean compressing)
<span class="nc" id="L37">	{</span>
<span class="nc" id="L38">		this.compressing = compressing;</span>
<span class="nc" id="L39">	}</span>

	public boolean isCompressing()
	{
<span class="nc" id="L43">		return compressing;</span>
	}

	public void setCompressing(boolean compressing)
	{
<span class="nc" id="L48">		this.compressing = compressing;</span>
<span class="nc" id="L49">	}</span>

	public byte[] encode(AccessEvent event)
	{
<span class="nc" id="L53">		AccessProto.AccessEvent converted = convert(event);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">		if(converted == null)</span>
		{
<span class="nc" id="L56">			return null;</span>
		}
<span class="nc bnc" id="L58" title="All 2 branches missed.">		if(!compressing)</span>
		{
<span class="nc" id="L60">			return converted.toByteArray();</span>
		}
<span class="nc" id="L62">		ByteArrayOutputStream out = new ByteArrayOutputStream();</span>
		GZIPOutputStream gos;
		try
		{
<span class="nc" id="L66">			gos = new GZIPOutputStream(out);</span>
<span class="nc" id="L67">			converted.writeTo(gos);</span>
<span class="nc" id="L68">			gos.flush();</span>
<span class="nc" id="L69">			gos.close();</span>
<span class="nc" id="L70">			return out.toByteArray();</span>
		}
<span class="nc" id="L72">		catch(IOException e)</span>
		{
			// ignore
		}
<span class="nc" id="L76">		return null;</span>
	}

	public static AccessProto.AccessEvent convert(AccessEvent event)
	{
<span class="nc bnc" id="L81" title="All 2 branches missed.">		if(event == null)</span>
		{
<span class="nc" id="L83">			return null;</span>
		}
<span class="nc" id="L85">		AccessProto.AccessEvent.Builder eventBuilder = AccessProto.AccessEvent.newBuilder();</span>

		// handling method
		{
<span class="nc" id="L89">			String method = event.getMethod();</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">			if(method != null)</span>
			{
<span class="nc" id="L92">				eventBuilder.setMethod(method);</span>
			}
		}

		// handling protocol
		{
<span class="nc" id="L98">			String protocol = event.getProtocol();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">			if(protocol != null)</span>
			{
<span class="nc" id="L101">				eventBuilder.setProtocol(protocol);</span>
			}
		}

		// handling remote address
		{
<span class="nc" id="L107">			String address = event.getRemoteAddress();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			if(address != null)</span>
			{
<span class="nc" id="L110">				eventBuilder.setRemoteAddress(address);</span>
			}
		}

		// handling remote host
		{
<span class="nc" id="L116">			String host = event.getRemoteHost();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">			if(host != null)</span>
			{
<span class="nc" id="L119">				eventBuilder.setRemoteHost(host);</span>
			}
		}

		// handling remote user
		{
<span class="nc" id="L125">			String user = event.getRemoteUser();</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">			if(user != null)</span>
			{
<span class="nc" id="L128">				eventBuilder.setRemoteUser(user);</span>
			}
		}

		// handling request uri
		{
<span class="nc" id="L134">			String uri = event.getRequestURI();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">			if(uri != null)</span>
			{
<span class="nc" id="L137">				eventBuilder.setRequestUri(uri);</span>
			}
		}

		// handling request url
		{
<span class="nc" id="L143">			String url = event.getRequestURL();</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			if(url != null)</span>
			{
<span class="nc" id="L146">				eventBuilder.setRequestUrl(url);</span>
			}
		}

		// handling request url
		{
<span class="nc" id="L152">			String url = event.getRequestURL();</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">			if(url != null)</span>
			{
<span class="nc" id="L155">				eventBuilder.setRequestUrl(url);</span>
			}
		}

		// handling server name
		{
<span class="nc" id="L161">			String name = event.getServerName();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">			if(name != null)</span>
			{
<span class="nc" id="L164">				eventBuilder.setServerName(name);</span>
			}
		}

		// handling timestamp
		{
<span class="nc" id="L170">			Long ts = event.getTimeStamp();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			if(ts != null)</span>
			{
<span class="nc" id="L173">				eventBuilder.setTimeStamp(ts);</span>
			}
		}

		// handling local port
		{
<span class="nc" id="L179">			int port = event.getLocalPort();</span>
<span class="nc" id="L180">			eventBuilder.setLocalPort(port);</span>
		}

		// handling status code
		{
<span class="nc" id="L185">			int status = event.getStatusCode();</span>
<span class="nc" id="L186">			eventBuilder.setStatusCode(status);</span>
		}

		// handling request headers
		{
<span class="nc" id="L191">			AccessProto.StringMap data = convertStringMap(event.getRequestHeaders());</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">			if(data != null)</span>
			{
<span class="nc" id="L194">				eventBuilder.setRequestHeaders(data);</span>
			}
		}

		// handling response headers
		{
<span class="nc" id="L200">			AccessProto.StringMap data = convertStringMap(event.getResponseHeaders());</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if(data != null)</span>
			{
<span class="nc" id="L203">				eventBuilder.setResponseHeaders(data);</span>
			}
		}

		// handling request parameters
		{
<span class="nc" id="L209">			AccessProto.StringArrayMap data = convertStringArrayMap(event.getRequestParameters());</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">			if(data != null)</span>
			{
<span class="nc" id="L212">				eventBuilder.setRequestParameters(data);</span>
			}
		}

		// handling logger context
		{
<span class="nc" id="L218">			LoggerContext context = event.getLoggerContext();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">			if(context != null)</span>
			{
<span class="nc" id="L221">				eventBuilder.setLoggerContext(convert(context));</span>
			}
		}
<span class="nc" id="L224">		return eventBuilder.build();</span>
	}

	public static AccessProto.LoggerContext convert(LoggerContext context)
	{
<span class="nc bnc" id="L229" title="All 2 branches missed.">		if(context == null)</span>
		{
<span class="nc" id="L231">			return null;</span>
		}
<span class="nc" id="L233">		AccessProto.LoggerContext.Builder builder = AccessProto.LoggerContext.newBuilder();</span>
		{
<span class="nc" id="L235">			String name = context.getName();</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">			if(name != null)</span>
			{
<span class="nc" id="L238">				builder.setName(name);</span>
			}
		}
		{
<span class="nc" id="L242">			Date birthTime = context.getBirthTime();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">			if(birthTime != null)</span>
			{
<span class="nc" id="L245">				builder.setBirthTime(birthTime.getTime());</span>
			}
		}
		{
<span class="nc" id="L249">			Map&lt;String, String&gt; map = context.getProperties();</span>
<span class="nc bnc" id="L250" title="All 4 branches missed.">			if(map != null &amp;&amp; map.size() &gt; 0)</span>
			{
<span class="nc" id="L252">				builder.setProperties(convertStringMap(map));</span>
			}
		}
<span class="nc" id="L255">		return builder.build();</span>

	}

	public static AccessProto.StringMap convertStringMap(Map&lt;String, String&gt; data)
	{
<span class="nc bnc" id="L261" title="All 2 branches missed.">		if(data == null)</span>
		{
<span class="nc" id="L263">			return null;</span>
		}
<span class="nc" id="L265">		AccessProto.StringMap.Builder builder = AccessProto.StringMap.newBuilder();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">		for(Map.Entry&lt;String, String&gt; current : data.entrySet())</span>
		{
<span class="nc" id="L268">			AccessProto.StringMapEntry.Builder entryBuilder = AccessProto.StringMapEntry.newBuilder()</span>
<span class="nc" id="L269">				.setKey(current.getKey());</span>
<span class="nc" id="L270">			String value = current.getValue();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">			if(value != null)</span>
			{
<span class="nc" id="L273">				entryBuilder.setValue(value);</span>
			}
<span class="nc" id="L275">			builder.addEntry(entryBuilder.build());</span>
<span class="nc" id="L276">		}</span>
<span class="nc" id="L277">		return builder.build();</span>
	}

	public static AccessProto.StringArrayMap convertStringArrayMap(Map&lt;String, String[]&gt; data)
	{
<span class="nc bnc" id="L282" title="All 2 branches missed.">		if(data == null)</span>
		{
<span class="nc" id="L284">			return null;</span>
		}
<span class="nc" id="L286">		AccessProto.StringArrayMap.Builder builder = AccessProto.StringArrayMap.newBuilder();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">		for(Map.Entry&lt;String, String[]&gt; current : data.entrySet())</span>
		{
<span class="nc" id="L289">			AccessProto.StringArrayMapEntry.Builder entryBuilder = AccessProto.StringArrayMapEntry.newBuilder()</span>
<span class="nc" id="L290">				.setKey(current.getKey());</span>
<span class="nc" id="L291">			String[] value = current.getValue();</span>
<span class="nc bnc" id="L292" title="All 4 branches missed.">			if(value != null &amp;&amp; value.length &gt; 0)</span>
			{
<span class="nc bnc" id="L294" title="All 2 branches missed.">				for(String cur : value)</span>
				{
<span class="nc" id="L296">					AccessProto.StringArrayValue.Builder valBuilder = AccessProto.StringArrayValue.newBuilder();</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">					if(cur != null)</span>
					{
<span class="nc" id="L299">						valBuilder.setValue(cur);</span>
					}

<span class="nc" id="L302">					entryBuilder.addValue(valBuilder.build());</span>
				}
			}
<span class="nc" id="L305">			builder.addEntry(entryBuilder.build());</span>
<span class="nc" id="L306">		}</span>
<span class="nc" id="L307">		return builder.build();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>