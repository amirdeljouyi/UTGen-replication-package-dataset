<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PreferencesDialog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">43_lilith</a> &gt; <a href="index.source.html" class="el_package">de.huxhorn.lilith.swing.preferences</a> &gt; <span class="el_source">PreferencesDialog.java</span></div><h1>PreferencesDialog.java</h1><pre class="source lang-java linenums">/*
 * Lilith - a log event viewer.
 * Copyright (C) 2007-2009 Joern Huxhorn
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package de.huxhorn.lilith.swing.preferences;

import de.huxhorn.lilith.data.eventsource.EventWrapper;
import de.huxhorn.lilith.data.eventsource.SourceIdentifier;
import de.huxhorn.lilith.data.logging.LoggingEvent;
import de.huxhorn.lilith.swing.ApplicationPreferences;
import de.huxhorn.lilith.swing.MainFrame;
import de.huxhorn.sulky.conditions.Condition;
import de.huxhorn.sulky.swing.KeyStrokes;
import groovy.ui.Console;
import org.apache.commons.io.IOUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.swing.AbstractAction;
import javax.swing.Action;
import javax.swing.JButton;
import javax.swing.JDialog;
import javax.swing.JPanel;
import javax.swing.JTabbedPane;
import javax.swing.JTextPane;
import javax.swing.KeyStroke;
import java.awt.BorderLayout;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.event.ActionEvent;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

public class PreferencesDialog
		extends JDialog
{
<span class="nc" id="L60">	private final Logger logger = LoggerFactory.getLogger(PreferencesDialog.class);</span>

	private ApplicationPreferences applicationPreferences;
	private MainFrame mainFrame;

	private JTabbedPane tabbedPane;

	private GeneralPanel generalPanel;
	private StartupShutdownPanel startupShutdownPanel;
	private SoundsPanel soundsPanel;
	private SourcesPanel sourcesPanel;
	private SourceListsPanel sourceListsPanel;
	private ConditionsPanel conditionsPanel;
	private Map&lt;String, String&gt; sourceNames;
	private Map&lt;String, Set&lt;String&gt;&gt; sourceLists;
	private SourceFilteringPanel sourceFilteringPanel;
	private String blackListName;
	private String whiteListName;
	private ApplicationPreferences.SourceFiltering sourceFiltering;

	public PreferencesDialog(MainFrame mainFrame)
	{
<span class="nc" id="L82">		super(mainFrame, &quot;Preferences&quot;);</span>
<span class="nc" id="L83">		this.mainFrame = mainFrame;</span>
<span class="nc" id="L84">		this.applicationPreferences = mainFrame.getApplicationPreferences();</span>
<span class="nc" id="L85">		createUI();</span>
<span class="nc" id="L86">	}</span>

	public ApplicationPreferences getApplicationPreferences()
	{
<span class="nc" id="L90">		return applicationPreferences;</span>
	}

	public MainFrame getMainFrame()
	{
<span class="nc" id="L95">		return mainFrame;</span>
	}

	private void createUI()
	{
<span class="nc" id="L100">		generalPanel = new GeneralPanel(this);</span>
<span class="nc" id="L101">		startupShutdownPanel = new StartupShutdownPanel(this);</span>
<span class="nc" id="L102">		soundsPanel = new SoundsPanel(this);</span>
<span class="nc" id="L103">		sourcesPanel = new SourcesPanel(this);</span>
<span class="nc" id="L104">		sourceListsPanel = new SourceListsPanel(this);</span>
<span class="nc" id="L105">		sourceFilteringPanel = new SourceFilteringPanel(this);</span>
<span class="nc" id="L106">		conditionsPanel = new ConditionsPanel(this);</span>
<span class="nc" id="L107">		TroubleshootingPanel troubleshootingPanel = new TroubleshootingPanel(this);</span>

<span class="nc" id="L109">		tabbedPane = new JTabbedPane();</span>
<span class="nc" id="L110">		tabbedPane.setPreferredSize(new Dimension(600, 500));</span>

<span class="nc" id="L112">		tabbedPane.add(&quot;General&quot;, generalPanel);</span>
<span class="nc" id="L113">		tabbedPane.add(&quot;Startup &amp; Shutdown&quot;, startupShutdownPanel);</span>
<span class="nc" id="L114">		tabbedPane.add(&quot;Sounds&quot;, soundsPanel);</span>
<span class="nc" id="L115">		tabbedPane.add(&quot;Sources&quot;, sourcesPanel);</span>
<span class="nc" id="L116">		tabbedPane.add(&quot;Source Lists&quot;, sourceListsPanel);</span>
<span class="nc" id="L117">		tabbedPane.add(&quot;Source Filtering&quot;, sourceFilteringPanel);</span>
<span class="nc" id="L118">		tabbedPane.add(&quot;Conditions&quot;, conditionsPanel);</span>
<span class="nc" id="L119">		tabbedPane.add(&quot;Troubleshooting&quot;, troubleshootingPanel);</span>

		// Main buttons
<span class="nc" id="L122">		JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));</span>
<span class="nc" id="L123">		buttonPanel.add(new JButton(new OkAction()));</span>
<span class="nc" id="L124">		buttonPanel.add(new JButton(new ApplyAction()));</span>
<span class="nc" id="L125">		buttonPanel.add(new JButton(new ResetAction()));</span>
<span class="nc" id="L126">		CancelAction cancelAction = new CancelAction();</span>
<span class="nc" id="L127">		buttonPanel.add(new JButton(cancelAction));</span>


<span class="nc" id="L130">		Container contentPane = getContentPane();</span>
<span class="nc" id="L131">		contentPane.setLayout(new BorderLayout());</span>
<span class="nc" id="L132">		contentPane.add(tabbedPane, BorderLayout.CENTER);</span>
<span class="nc" id="L133">		contentPane.add(buttonPanel, BorderLayout.SOUTH);</span>
<span class="nc" id="L134">		KeyStrokes.registerCommand(tabbedPane, cancelAction, &quot;CANCEL_ACTION&quot;);</span>
<span class="nc" id="L135">		KeyStrokes.registerCommand(buttonPanel, cancelAction, &quot;CANCEL_ACTION&quot;);</span>
<span class="nc" id="L136">	}</span>


	private void initUI()
	{
<span class="nc" id="L141">		generalPanel.initUI();</span>
<span class="nc" id="L142">		startupShutdownPanel.initUI();</span>
<span class="nc" id="L143">		soundsPanel.initUI();</span>
<span class="nc" id="L144">		sourceNames = applicationPreferences.getSourceNames();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (sourceNames == null)</span>
		{
<span class="nc" id="L147">			sourceNames = new HashMap&lt;String, String&gt;();</span>
		}
		else
		{
<span class="nc" id="L151">			sourceNames = new HashMap&lt;String, String&gt;(sourceNames);</span>
		}
<span class="nc" id="L153">		sourceLists = applicationPreferences.getSourceLists();</span>
<span class="nc" id="L154">		conditionsPanel.initUI();</span>
<span class="nc" id="L155">		sourcesPanel.initUI();</span>
<span class="nc" id="L156">		sourceListsPanel.initUI();</span>
<span class="nc" id="L157">		sourceFilteringPanel.initUI();</span>
<span class="nc" id="L158">		conditionsPanel.initUI();</span>
<span class="nc" id="L159">	}</span>

	public Map&lt;String, String&gt; getSourceNames()
	{
<span class="nc" id="L163">		return sourceNames;</span>
	}

	public void setSourceNames(Map&lt;String, String&gt; sourceNames)
	{
<span class="nc" id="L168">		this.sourceNames = sourceNames;</span>
<span class="nc" id="L169">		sourcesPanel.initUI();</span>
<span class="nc" id="L170">		sourceListsPanel.initUI();</span>
<span class="nc" id="L171">	}</span>

	public void setSourceName(String oldIdentifier, String newIdentifier, String sourceName)
	{
<span class="nc bnc" id="L175" title="All 2 branches missed.">		if (sourceNames.containsKey(oldIdentifier))</span>
		{
<span class="nc" id="L177">			sourceNames.remove(oldIdentifier);</span>
		}
<span class="nc" id="L179">		sourceNames.put(newIdentifier, sourceName);</span>
<span class="nc" id="L180">		sourcesPanel.initUI();</span>
<span class="nc" id="L181">		sourceListsPanel.initUI();</span>
<span class="nc" id="L182">	}</span>

	public void setSourceList(String oldName, String newName, List&lt;Source&gt; sourceList)
	{
<span class="nc bnc" id="L186" title="All 2 branches missed.">		if (sourceLists.containsKey(oldName))</span>
		{
<span class="nc" id="L188">			sourceLists.remove(oldName);</span>
		}
<span class="nc" id="L190">		Set&lt;String&gt; newList = new HashSet&lt;String&gt;();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">		for (Source s : sourceList)</span>
		{
<span class="nc" id="L193">			newList.add(s.getIdentifier());</span>
<span class="nc" id="L194">		}</span>
<span class="nc" id="L195">		sourceLists.put(newName, newList);</span>
<span class="nc" id="L196">		sourceListsPanel.initUI();</span>
<span class="nc" id="L197">		sourceFilteringPanel.initUI();</span>
<span class="nc" id="L198">	}</span>

	public List&lt;Source&gt; getSourceList(String name)
	{
<span class="nc" id="L202">		Set&lt;String&gt; srcList = sourceLists.get(name);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">		if (srcList != null)</span>
		{
<span class="nc" id="L205">			List&lt;Source&gt; result = new ArrayList&lt;Source&gt;();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">			for (String current : srcList)</span>
			{
<span class="nc" id="L208">				Source s = new Source();</span>
<span class="nc" id="L209">				s.setIdentifier(current);</span>
<span class="nc" id="L210">				s.setName(getSourceName(current));</span>
<span class="nc" id="L211">				result.add(s);</span>
<span class="nc" id="L212">			}</span>
<span class="nc" id="L213">			Collections.sort(result);</span>
<span class="nc" id="L214">			return result;</span>
		}
<span class="nc" id="L216">		return new ArrayList&lt;Source&gt;();</span>
	}

	private String getSourceName(String identifier)
	{
<span class="nc" id="L221">		String result = sourceNames.get(identifier);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">		if (result == null)</span>
		{
<span class="nc" id="L224">			result = identifier;</span>
		}
<span class="nc" id="L226">		return result;</span>
	}


	private void saveSettings()
	{
<span class="nc" id="L232">		generalPanel.saveSettings();</span>
<span class="nc" id="L233">		startupShutdownPanel.saveSettings();</span>
<span class="nc" id="L234">		soundsPanel.saveSettings();</span>
<span class="nc" id="L235">		conditionsPanel.saveSettings();</span>
<span class="nc" id="L236">		applicationPreferences.setSourceNames(sourceNames);</span>
<span class="nc" id="L237">		applicationPreferences.setSourceLists(sourceLists);</span>
<span class="nc" id="L238">		applicationPreferences.setBlackListName(blackListName);</span>
<span class="nc" id="L239">		applicationPreferences.setWhiteListName(whiteListName);</span>
<span class="nc" id="L240">		applicationPreferences.setSourceFiltering(sourceFiltering);</span>
		//sourcesPanel.saveSettings();
		//sourceListsPanel.saveSettings();
<span class="nc" id="L243">	}</span>

	private void resetSettings()
	{
		// just reinit from preferences, nobody would expect anything else...
		// applicationPreferences.reset();
<span class="nc" id="L249">		initUI();</span>
<span class="nc" id="L250">	}</span>

	public void setVisible(boolean visible)
	{
<span class="nc bnc" id="L254" title="All 2 branches missed.">		if (visible != isVisible())</span>
		{
<span class="nc bnc" id="L256" title="All 2 branches missed.">			if (visible)</span>
			{
<span class="nc" id="L258">				initUI();</span>
			}
<span class="nc" id="L260">			super.setVisible(visible);</span>
		}
<span class="nc" id="L262">	}</span>

	public List&lt;String&gt; getSourceListNames()
	{
<span class="nc" id="L266">		return new ArrayList&lt;String&gt;(sourceLists.keySet());</span>
	}

	public void removeSourceList(String sourceListName)
	{
<span class="nc bnc" id="L271" title="All 2 branches missed.">		if (sourceLists.containsKey(sourceListName))</span>
		{
<span class="nc" id="L273">			sourceLists.remove(sourceListName);</span>
<span class="nc" id="L274">			sourceListsPanel.initUI();</span>
<span class="nc" id="L275">			sourceFilteringPanel.initUI();</span>
		}
<span class="nc" id="L277">	}</span>

	public String getBlackListName()
	{
<span class="nc bnc" id="L281" title="All 2 branches missed.">		if (blackListName == null)</span>
		{
<span class="nc" id="L283">			blackListName = applicationPreferences.getBlackListName();</span>
		}
<span class="nc" id="L285">		return blackListName;</span>
	}

	public String getWhiteListName()
	{
<span class="nc bnc" id="L290" title="All 2 branches missed.">		if (whiteListName == null)</span>
		{
<span class="nc" id="L292">			whiteListName = applicationPreferences.getWhiteListName();</span>
		}
<span class="nc" id="L294">		return whiteListName;</span>
	}

	public ApplicationPreferences.SourceFiltering getSourceFiltering()
	{
<span class="nc bnc" id="L299" title="All 2 branches missed.">		if (sourceFiltering == null)</span>
		{
<span class="nc" id="L301">			sourceFiltering = applicationPreferences.getSourceFiltering();</span>
		}
<span class="nc" id="L303">		return sourceFiltering;</span>
	}

	public void setSourceFiltering(ApplicationPreferences.SourceFiltering sourceFiltering)
	{
<span class="nc" id="L308">		this.sourceFiltering = sourceFiltering;</span>
<span class="nc" id="L309">	}</span>

	public void setBlackListName(String blackListName)
	{
<span class="nc" id="L313">		this.blackListName = blackListName;</span>
<span class="nc" id="L314">	}</span>

	public void setWhiteListName(String whiteListName)
	{
<span class="nc" id="L318">		this.whiteListName = whiteListName;</span>
<span class="nc" id="L319">	}</span>

	private class OkAction
			extends AbstractAction
	{
		public OkAction()
<span class="nc" id="L325">		{</span>
<span class="nc" id="L326">			super(&quot;Ok&quot;);</span>
<span class="nc" id="L327">		}</span>

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L331">			saveSettings();</span>
<span class="nc" id="L332">			setVisible(false);</span>
<span class="nc" id="L333">		}</span>
	}

	private class ApplyAction
			extends AbstractAction
	{
		public ApplyAction()
<span class="nc" id="L340">		{</span>
<span class="nc" id="L341">			super(&quot;Apply&quot;);</span>
<span class="nc" id="L342">		}</span>

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L346">			saveSettings();</span>
<span class="nc" id="L347">		}</span>
	}

	private class ResetAction
			extends AbstractAction
	{
		public ResetAction()
<span class="nc" id="L354">		{</span>
<span class="nc" id="L355">			super(&quot;Reset&quot;);</span>
<span class="nc" id="L356">		}</span>

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L360">			resetSettings();</span>
<span class="nc" id="L361">		}</span>
	}

	private class CancelAction
			extends AbstractAction
	{
		public CancelAction()
<span class="nc" id="L368">		{</span>
<span class="nc" id="L369">			super(&quot;Cancel&quot;);</span>
<span class="nc" id="L370">			KeyStroke accelerator = KeyStrokes.resolveAcceleratorKeyStroke(&quot;ESCAPE&quot;);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">			if (logger.isDebugEnabled()) logger.debug(&quot;accelerator: {}&quot;, accelerator);</span>
<span class="nc" id="L372">			putValue(Action.ACCELERATOR_KEY, accelerator);</span>
<span class="nc" id="L373">		}</span>

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L377">			setVisible(false);</span>
<span class="nc" id="L378">		}</span>
	}

	public void editSourceName(String sourceIdentifier)
	{
<span class="nc" id="L383">		tabbedPane.setSelectedComponent(sourcesPanel);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">		if (!isVisible())</span>
		{
<span class="nc" id="L386">			mainFrame.showPreferencesDialog();</span>
		}
<span class="nc" id="L388">		sourcesPanel.editSourceName(sourceIdentifier);</span>
<span class="nc" id="L389">	}</span>

	public void editDetailsFormatter()
	{
<span class="nc" id="L393">		Console console = new Console();</span>
<span class="nc" id="L394">		File messageViewRoot = applicationPreferences.getDetailsViewRoot();</span>
<span class="nc" id="L395">		File messageViewGroovyFile = new File(messageViewRoot, ApplicationPreferences.DETAILS_VIEW_GROOVY_FILENAME);</span>

<span class="nc" id="L397">		EventWrapper&lt;LoggingEvent&gt; eventWrapper = new EventWrapper&lt;LoggingEvent&gt;(new SourceIdentifier(&quot;identifier&quot;, &quot;secondaryIdentifier&quot;), 17, new LoggingEvent());</span>
<span class="nc" id="L398">		console.setVariable(&quot;eventWrapper&quot;, eventWrapper);</span>

<span class="nc" id="L400">		console.setCurrentFileChooserDir(messageViewRoot);</span>
<span class="nc" id="L401">		String text = &quot;&quot;;</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">		if (messageViewGroovyFile.isFile())</span>
		{
			// TODO: init with default if not...
			InputStream is;
			try
			{
<span class="nc" id="L408">				is = new FileInputStream(messageViewGroovyFile);</span>
<span class="nc" id="L409">				List lines = IOUtils.readLines(is, &quot;UTF-8&quot;);</span>
<span class="nc" id="L410">				boolean isFirst = true;</span>
<span class="nc" id="L411">				StringBuilder textBuffer = new StringBuilder();</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">				for (Object o : lines)</span>
				{
<span class="nc" id="L414">					String s = (String) o;</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">					if (isFirst)</span>
					{
<span class="nc" id="L417">						isFirst = false;</span>
					}
					else
					{
<span class="nc" id="L421">						textBuffer.append(&quot;\n&quot;);</span>
					}
<span class="nc" id="L423">					textBuffer.append(s);</span>
<span class="nc" id="L424">				}</span>
<span class="nc" id="L425">				text = textBuffer.toString();</span>
			}
<span class="nc" id="L427">			catch (IOException e)</span>
			{
<span class="nc bnc" id="L429" title="All 2 branches missed.">				if (logger.isInfoEnabled())</span>
				{
<span class="nc" id="L431">					logger.info(&quot;Exception while reading '&quot; + messageViewGroovyFile.getAbsolutePath() + &quot;'.&quot;, e);</span>
				}
<span class="nc" id="L433">			}</span>
		}
<span class="nc" id="L435">		console.run(); // initializes everything</span>

<span class="nc" id="L437">		console.setScriptFile(messageViewGroovyFile);</span>
<span class="nc" id="L438">		JTextPane inputArea = console.getInputArea();</span>
<span class="nc" id="L439">		inputArea.setText(text);</span>
<span class="nc" id="L440">		console.setDirty(false);</span>
<span class="nc" id="L441">		inputArea.setCaretPosition(0);</span>
<span class="nc" id="L442">		inputArea.requestFocusInWindow();</span>
//		console.selectFilename();
//		console.fileOpen();


<span class="nc" id="L447">	}</span>


	public void editCondition(Condition condition)
	{
<span class="nc" id="L452">		tabbedPane.setSelectedComponent(conditionsPanel);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">		if (!isVisible())</span>
		{
<span class="nc" id="L455">			mainFrame.showPreferencesDialog();</span>
		}
<span class="nc" id="L457">		conditionsPanel.editCondition(condition);</span>
<span class="nc" id="L458">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>