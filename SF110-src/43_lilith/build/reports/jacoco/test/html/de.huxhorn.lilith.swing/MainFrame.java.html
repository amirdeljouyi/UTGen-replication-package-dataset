<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainFrame.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">43_lilith</a> &gt; <a href="index.source.html" class="el_package">de.huxhorn.lilith.swing</a> &gt; <span class="el_source">MainFrame.java</span></div><h1>MainFrame.java</h1><pre class="source lang-java linenums">/*
 * Lilith - a log event viewer.
 * Copyright (C) 2007-2009 Joern Huxhorn
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package de.huxhorn.lilith.swing;

import de.huxhorn.lilith.Lilith;
import de.huxhorn.lilith.LilithBuffer;
import de.huxhorn.lilith.LilithSounds;
import de.huxhorn.lilith.appender.InternalLilithAppender;
import de.huxhorn.lilith.consumers.AlarmSoundAccessEventConsumer;
import de.huxhorn.lilith.consumers.AlarmSoundLoggingEventConsumer;
import de.huxhorn.lilith.consumers.FileDumpEventConsumer;
import de.huxhorn.lilith.consumers.FileSplitterEventConsumer;
import de.huxhorn.lilith.consumers.RrdLoggingEventConsumer;
import de.huxhorn.lilith.data.access.AccessEvent;
import de.huxhorn.lilith.data.access.HttpStatus;
import de.huxhorn.lilith.data.eventsource.EventWrapper;
import de.huxhorn.lilith.data.eventsource.SourceIdentifier;
import de.huxhorn.lilith.data.logging.LoggingEvent;
import de.huxhorn.lilith.engine.AccessFileBufferFactory;
import de.huxhorn.lilith.engine.EventConsumer;
import de.huxhorn.lilith.engine.EventSource;
import de.huxhorn.lilith.engine.EventSourceListener;
import de.huxhorn.lilith.engine.FileBufferFactory;
import de.huxhorn.lilith.engine.FileConstants;
import de.huxhorn.lilith.engine.LogFileFactory;
import de.huxhorn.lilith.engine.LoggingFileBufferFactory;
import de.huxhorn.lilith.engine.SourceManager;
import de.huxhorn.lilith.engine.impl.EventSourceImpl;
import de.huxhorn.lilith.engine.impl.LogFileFactoryImpl;
import de.huxhorn.lilith.engine.impl.sourcemanager.SourceManagerImpl;
import de.huxhorn.lilith.engine.impl.sourceproducer.AccessEventProtobufServerSocketEventSourceProducer;
import de.huxhorn.lilith.engine.impl.sourceproducer.LoggingEventProtobufServerSocketEventSourceProducer;
import de.huxhorn.lilith.engine.xml.sourceproducer.LilithXmlMessageLoggingServerSocketEventSourceProducer;
import de.huxhorn.lilith.engine.xml.sourceproducer.LilithXmlStreamLoggingServerSocketEventSourceProducer;
import de.huxhorn.lilith.jul.xml.JulImportCallable;
import de.huxhorn.lilith.log4j.xml.Log4jImportCallable;
import de.huxhorn.lilith.logback.appender.AccessMultiplexSocketAppender;
import de.huxhorn.lilith.logback.appender.ClassicMultiplexSocketAppender;
import de.huxhorn.lilith.logback.appender.ClassicXmlMultiplexSocketAppender;
import de.huxhorn.lilith.logback.appender.ZeroDelimitedClassicXmlMultiplexSocketAppender;
import de.huxhorn.lilith.logback.producer.LogbackAccessServerSocketEventSourceProducer;
import de.huxhorn.lilith.logback.producer.LogbackLoggingServerSocketEventSourceProducer;
import de.huxhorn.lilith.services.gotosrc.GoToSourceService;
import de.huxhorn.lilith.services.sender.EventSender;
import de.huxhorn.lilith.services.sender.SenderService;
import de.huxhorn.lilith.swing.callables.CleanAllInactiveCallable;
import de.huxhorn.lilith.swing.callables.CleanObsoleteCallable;
import de.huxhorn.lilith.swing.callables.IndexingCallable;
import de.huxhorn.lilith.swing.debug.DebugDialog;
import de.huxhorn.lilith.swing.filefilters.DirectoryFilter;
import de.huxhorn.lilith.swing.filefilters.LilithFileFilter;
import de.huxhorn.lilith.swing.filefilters.LogFileFilter;
import de.huxhorn.lilith.swing.filefilters.RrdFileFilter;
import de.huxhorn.lilith.swing.filefilters.XmlImportFileFilter;
import de.huxhorn.lilith.swing.preferences.PreferencesDialog;
import de.huxhorn.lilith.swing.preferences.SavedCondition;
import de.huxhorn.lilith.swing.table.ColorScheme;
import de.huxhorn.lilith.swing.table.Colors;
import de.huxhorn.lilith.swing.taskmanager.TaskManagerInternalFrame;
import de.huxhorn.lilith.swing.transfer.MainFrameTransferHandler;
import de.huxhorn.lilith.swing.transfer.MainFrameTransferHandler16;
import de.huxhorn.sulky.buffers.AppendOperation;
import de.huxhorn.sulky.buffers.BlockingCircularBuffer;
import de.huxhorn.sulky.buffers.Buffer;
import de.huxhorn.sulky.buffers.FileBuffer;
import de.huxhorn.sulky.codec.filebuffer.CodecFileBuffer;
import de.huxhorn.sulky.codec.filebuffer.DefaultFileHeaderStrategy;
import de.huxhorn.sulky.codec.filebuffer.FileHeader;
import de.huxhorn.sulky.codec.filebuffer.FileHeaderStrategy;
import de.huxhorn.sulky.codec.filebuffer.MetaData;
import de.huxhorn.sulky.conditions.Condition;
import de.huxhorn.sulky.formatting.SimpleXml;
import de.huxhorn.sulky.sounds.Sounds;
import de.huxhorn.sulky.swing.MemoryStatus;
import de.huxhorn.sulky.swing.Windows;
import de.huxhorn.sulky.tasks.Task;
import de.huxhorn.sulky.tasks.TaskListener;
import de.huxhorn.sulky.tasks.TaskManager;
import groovy.lang.Binding;
import groovy.lang.GroovyClassLoader;
import groovy.lang.Script;
import org.apache.commons.httpclient.DefaultHttpMethodRetryHandler;
import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.methods.GetMethod;
import org.apache.commons.httpclient.params.HttpMethodParams;
import org.apache.commons.io.IOUtils;
import org.simplericity.macify.eawt.Application;
import org.simplericity.macify.eawt.ApplicationEvent;
import org.simplericity.macify.eawt.ApplicationListener;
import org.simplericity.macify.eawt.DefaultApplication;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.swing.Icon;
import javax.swing.ImageIcon;
import javax.swing.JDesktopPane;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JInternalFrame;
import javax.swing.JLabel;
import javax.swing.JMenuBar;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JToolBar;
import javax.swing.SwingUtilities;
import javax.swing.border.EtchedBorder;
import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Frame;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.Point;
import java.awt.Toolkit;
import java.awt.datatransfer.Clipboard;
import java.awt.datatransfer.StringSelection;
import java.awt.datatransfer.Transferable;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.beans.PropertyVetoException;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileFilter;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Serializable;
import java.net.URL;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.SortedMap;
import java.util.TreeMap;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;


public class MainFrame
		extends JFrame
{
<span class="nc" id="L168">	private final Logger logger = LoggerFactory.getLogger(MainFrame.class);</span>

	private final File startupApplicationPath;


	private GoToSourceService gotoSource;
	private LogFileFactory loggingFileFactory;
	private SourceManager&lt;LoggingEvent&gt; loggingEventSourceManager;
	private FileBufferFactory&lt;LoggingEvent&gt; loggingFileBufferFactory;
	private EventSourceListener&lt;LoggingEvent&gt; loggingSourceListener;
	private LoggingEventViewManager loggingEventViewManager;

	private LogFileFactory accessFileFactory;
	private SourceManager&lt;AccessEvent&gt; accessEventSourceManager;
	private FileBufferFactory&lt;AccessEvent&gt; accessFileBufferFactory;
	private EventSourceListener&lt;AccessEvent&gt; accessSourceListener;
	private AccessEventViewManager accessEventViewManager;

	private Sounds sounds;
	private JDesktopPane desktop;

	private PreferencesDialog preferencesDialog;
	private JDialog aboutDialog;
	private JLabel statusLabel;
	private ApplicationPreferences applicationPreferences;
	private DebugDialog debugDialog;
	private RrdFileFilter rrdFileFilter;
	private StatisticsDialog statisticsDialog;
	private TaskManager&lt;Long&gt; longTaskManager;
	private ViewActions viewActions;
	private OpenPreviousDialog openInactiveLogsDialog;
	private HelpFrame helpFrame;
	private Application application;
	private int activeCounter;
	private List&lt;AutostartRunnable&gt; autostartProcesses;
	private URL helpUrl;
	private SenderService senderService;
	private boolean enableBonjour;
	private final boolean isMac;
	private final boolean isWindows;
	private List&lt;SavedCondition&gt; activeConditions;
	private Map&lt;LoggingEvent.Level, Colors&gt; levelColors;
	private Map&lt;HttpStatus.Type, Colors&gt; statusColors;
	private SplashScreen splashScreen;
	private TaskManagerInternalFrame taskManagerFrame;
	private JLabel taskStatusLabel;
	private int previousNumberOfTasks;
	private ImageIcon smallProgressIcon;
	public static final String LOGS_SUBDIRECTORY = &quot;logs&quot;;
	public static final String LOGGING_FILE_SUBDIRECTORY = LOGS_SUBDIRECTORY + &quot;/logging&quot;;
	public static final String ACCESS_FILE_SUBDIRECTORY = LOGS_SUBDIRECTORY + &quot;/access&quot;;
	private JFileChooser openFileChooser;
	private JFileChooser importFileChooser;
	private boolean coloringWholeRow;
	/*
	 * Need to use ConcurrentMap because it's accessed by both the EventDispatchThread and the CleanupThread.
	 */
	//private ConcurrentMap&lt;EventIdentifier, SoftColorsReference&gt; colorsCache;
	//private ReferenceQueue&lt;Colors&gt; colorsReferenceQueue;

	public String[] getAllConditionScriptFiles()
	{
<span class="nc" id="L230">		return applicationPreferences.getAllConditionScriptFiles();</span>
	}

	public File resolveConditionScriptFile(String input)
	{
<span class="nc" id="L235">		return applicationPreferences.resolveConditionScriptFile(input);</span>
	}

	public AccessEventViewManager getAccessEventViewManager()
	{
<span class="nc" id="L240">		return accessEventViewManager;</span>
	}

	public LoggingEventViewManager getLoggingEventViewManager()
	{
<span class="nc" id="L245">		return loggingEventViewManager;</span>
	}

	public PreferencesDialog getPreferencesDialog()
	{
<span class="nc" id="L250">		return preferencesDialog;</span>
	}

	public ViewActions getViewActions()
	{
<span class="nc" id="L255">		return viewActions;</span>
	}

	public JDesktopPane getDesktop()
	{
<span class="nc" id="L260">		return desktop;</span>
	}

	public MainFrame(ApplicationPreferences applicationPreferences, SplashScreen splashScreen, String appName, boolean enableBonjour)
	{
<span class="nc" id="L265">		super(appName);</span>
<span class="nc" id="L266">		this.applicationPreferences = applicationPreferences;</span>
<span class="nc" id="L267">		this.coloringWholeRow = this.applicationPreferences.isColoringWholeRow();</span>
<span class="nc" id="L268">		this.splashScreen = splashScreen;</span>
<span class="nc" id="L269">		setSplashStatusText(&quot;Creating main frame.&quot;);</span>
<span class="nc" id="L270">		smallProgressIcon = new ImageIcon(MainFrame.class.getResource(&quot;/otherGraphics/Progress16.gif&quot;));</span>
<span class="nc" id="L271">		ImageIcon frameIcon = new ImageIcon(MainFrame.class.getResource(&quot;/otherGraphics/Lilith16.jpg&quot;));</span>
<span class="nc" id="L272">		setIconImage(frameIcon.getImage());</span>
		//colorsReferenceQueue=new ReferenceQueue&lt;Colors&gt;();
		//colorsCache=new ConcurrentHashMap&lt;EventIdentifier, SoftColorsReference&gt;();
<span class="nc" id="L275">		application = new DefaultApplication();</span>
<span class="nc" id="L276">		isMac = application.isMac();</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">		if (!isMac)</span>
		{
<span class="nc" id="L279">			String osName = System.getProperty(&quot;os.name&quot;).toLowerCase();</span>
<span class="nc" id="L280">			isWindows = osName.startsWith(&quot;windows&quot;);</span>
<span class="nc" id="L281">		}</span>
		else
		{
<span class="nc" id="L284">			isWindows = false;</span>
		}
<span class="nc" id="L286">		autostartProcesses = new ArrayList&lt;AutostartRunnable&gt;();</span>

<span class="nc" id="L288">		addWindowListener(new MainWindowListener());</span>
<span class="nc" id="L289">		Runtime runtime = Runtime.getRuntime();</span>
<span class="nc" id="L290">		Thread shutdownHook = new Thread(new ShutdownRunnable());</span>
<span class="nc" id="L291">		runtime.addShutdownHook(shutdownHook);</span>

<span class="nc" id="L293">		senderService = new SenderService(this);</span>
<span class="nc" id="L294">		this.enableBonjour = enableBonjour;</span>
		/*
		if(application.isMac())
		{
			setDefaultCloseOperation(JFrame.HIDE_ON_CLOSE);
		}
		else
		{
			setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		}
        */

<span class="nc" id="L306">		longTaskManager = new TaskManager&lt;Long&gt;();</span>
<span class="nc" id="L307">		longTaskManager.setUsingEventQueue(true);</span>
<span class="nc" id="L308">		longTaskManager.startUp();</span>
<span class="nc" id="L309">		longTaskManager.addTaskListener(new MainTaskListener());</span>

<span class="nc" id="L311">		startupApplicationPath = this.applicationPreferences.getStartupApplicationPath();</span>

<span class="nc" id="L313">		loggingFileFactory = new LogFileFactoryImpl(new File(startupApplicationPath, LOGGING_FILE_SUBDIRECTORY));</span>
<span class="nc" id="L314">		accessFileFactory = new LogFileFactoryImpl(new File(startupApplicationPath, ACCESS_FILE_SUBDIRECTORY));</span>

<span class="nc" id="L316">		Map&lt;String, String&gt; loggingMetaData = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L317">		loggingMetaData.put(FileConstants.CONTENT_TYPE_KEY, FileConstants.CONTENT_TYPE_VALUE_LOGGING);</span>
<span class="nc" id="L318">		loggingMetaData.put(FileConstants.CONTENT_FORMAT_KEY, FileConstants.CONTENT_FORMAT_VALUE_PROTOBUF);</span>
<span class="nc" id="L319">		loggingMetaData.put(FileConstants.COMPRESSION_KEY, FileConstants.COMPRESSION_VALUE_GZIP);</span>
		// TODO: configurable format and compressed

<span class="nc" id="L322">		loggingFileBufferFactory = new LoggingFileBufferFactory(loggingFileFactory, loggingMetaData);</span>

<span class="nc" id="L324">		Map&lt;String, String&gt; accessMetaData = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L325">		accessMetaData.put(FileConstants.CONTENT_TYPE_KEY, FileConstants.CONTENT_TYPE_VALUE_ACCESS);</span>
<span class="nc" id="L326">		accessMetaData.put(FileConstants.CONTENT_FORMAT_KEY, FileConstants.CONTENT_FORMAT_VALUE_PROTOBUF);</span>
<span class="nc" id="L327">		accessMetaData.put(FileConstants.COMPRESSION_KEY, FileConstants.COMPRESSION_VALUE_GZIP);</span>
		// TODO: configurable format and compressed

<span class="nc" id="L330">		accessFileBufferFactory = new AccessFileBufferFactory(accessFileFactory, accessMetaData);</span>

<span class="nc" id="L332">		rrdFileFilter = new RrdFileFilter();</span>

<span class="nc" id="L334">		loggingEventViewManager = new LoggingEventViewManager(this);</span>
<span class="nc" id="L335">		accessEventViewManager = new AccessEventViewManager(this);</span>
<span class="nc" id="L336">		this.applicationPreferences.addPropertyChangeListener(new PreferencesChangeListener());</span>
<span class="nc" id="L337">		loggingSourceListener = new LoggingEventSourceListener();</span>
<span class="nc" id="L338">		accessSourceListener = new AccessEventSourceListener();</span>
		// this.cleanupWindowChangeListener = new CleanupWindowChangeListener();
<span class="nc" id="L340">		desktop = new JDesktopPane();</span>
<span class="nc" id="L341">		JPanel statusBar = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L342">		GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L343">		statusLabel = new JLabel();</span>
<span class="nc" id="L344">		statusLabel.setText(&quot;Starting...&quot;);</span>

<span class="nc" id="L346">		gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L347">		gbc.gridx = 0;</span>
<span class="nc" id="L348">		gbc.gridy = 0;</span>
<span class="nc" id="L349">		gbc.weightx = 0.0;</span>
<span class="nc" id="L350">		gbc.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L351">		gbc.insets = new Insets(0, 5, 0, 0);</span>

<span class="nc" id="L353">		statusBar.add(statusLabel, gbc);</span>

<span class="nc" id="L355">		taskStatusLabel = new JLabel();</span>
<span class="nc" id="L356">		taskStatusLabel.setText(&quot;&quot;);</span>
<span class="nc" id="L357">		taskStatusLabel.setForeground(Color.BLUE);</span>
<span class="nc" id="L358">		taskStatusLabel.addMouseListener(new MouseAdapter()</span>
<span class="nc" id="L359">		{</span>
			@Override
			public void mouseClicked(MouseEvent mouseEvent)
			{
<span class="nc" id="L363">				showTaskManager();</span>
<span class="nc" id="L364">			}</span>

			@Override
			public void mouseEntered(MouseEvent mouseEvent)
			{
<span class="nc" id="L369">				taskStatusLabel.setForeground(Color.RED);</span>
<span class="nc" id="L370">			}</span>

			@Override
			public void mouseExited(MouseEvent mouseEvent)
			{
<span class="nc" id="L375">				taskStatusLabel.setForeground(Color.BLUE);</span>
<span class="nc" id="L376">			}</span>
		});
<span class="nc" id="L378">		gbc.gridx = 1;</span>
<span class="nc" id="L379">		gbc.gridy = 0;</span>
<span class="nc" id="L380">		gbc.weightx = 1.0;</span>
<span class="nc" id="L381">		gbc.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L382">		gbc.insets = new Insets(0, 5, 0, 0);</span>
<span class="nc" id="L383">		statusBar.add(taskStatusLabel, gbc);</span>


<span class="nc" id="L386">		MemoryStatus memoryStatus = new MemoryStatus();</span>
<span class="nc" id="L387">		memoryStatus.setBackground(Color.WHITE);</span>
<span class="nc" id="L388">		memoryStatus.setOpaque(true);</span>
<span class="nc" id="L389">		memoryStatus.setUsingBinaryUnits(true);</span>
<span class="nc" id="L390">		memoryStatus.setUsingTotal(false);</span>
<span class="nc" id="L391">		memoryStatus.setBorder(new EtchedBorder(EtchedBorder.LOWERED));</span>

<span class="nc" id="L393">		gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L394">		gbc.gridx = 2;</span>
<span class="nc" id="L395">		gbc.gridy = 0;</span>
<span class="nc" id="L396">		gbc.weightx = 0.0;</span>
<span class="nc" id="L397">		gbc.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L398">		gbc.insets = new Insets(0, 0, 0, 0);</span>

<span class="nc" id="L400">		statusBar.add(memoryStatus, gbc);</span>
<span class="nc" id="L401">		add(desktop, BorderLayout.CENTER);</span>
<span class="nc" id="L402">		add(statusBar, BorderLayout.SOUTH);</span>

<span class="nc" id="L404">		setSplashStatusText(&quot;Creating statistics dialog.&quot;);</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">		if (logger.isDebugEnabled()) logger.debug(&quot;Before creation of statistics-dialog...&quot;);</span>
<span class="nc" id="L406">		statisticsDialog = new StatisticsDialog(this);</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">		if (logger.isDebugEnabled()) logger.debug(&quot;After creation of statistics-dialog...&quot;);</span>

<span class="nc" id="L409">		setSplashStatusText(&quot;Creating about dialog.&quot;);</span>
<span class="nc" id="L410">		aboutDialog = new AboutDialog(this, &quot;About &quot; + appName + &quot;...&quot;, appName);</span>

<span class="nc" id="L412">		setSplashStatusText(&quot;Creating debug dialog.&quot;);</span>
<span class="nc" id="L413">		debugDialog = new DebugDialog(this, this);</span>

<span class="nc" id="L415">		setSplashStatusText(&quot;Creating preferences dialog.&quot;);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">		if (logger.isDebugEnabled()) logger.debug(&quot;Before creation of preferences-dialog...&quot;);</span>
<span class="nc" id="L417">		preferencesDialog = new PreferencesDialog(this);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">		if (logger.isDebugEnabled()) logger.debug(&quot;After creation of preferences-dialog...&quot;);</span>

<span class="nc" id="L420">		setSplashStatusText(&quot;Creating \&quot;Open inactive\&quot; dialog.&quot;);</span>
<span class="nc" id="L421">		openInactiveLogsDialog = new OpenPreviousDialog(MainFrame.this);</span>

<span class="nc" id="L423">		setSplashStatusText(&quot;Creating help frame.&quot;);</span>
<span class="nc" id="L424">		helpFrame = new HelpFrame(this);</span>
<span class="nc" id="L425">		helpFrame.setTitle(&quot;Help Topics&quot;);</span>

<span class="nc" id="L427">		openFileChooser = new JFileChooser();</span>
<span class="nc" id="L428">		openFileChooser.setFileFilter(new LilithFileFilter());</span>
<span class="nc" id="L429">		openFileChooser.setFileHidingEnabled(false);</span>
<span class="nc" id="L430">		openFileChooser.setCurrentDirectory(this.applicationPreferences.getPreviousOpenPath());</span>

<span class="nc" id="L432">		importFileChooser = new JFileChooser();</span>
<span class="nc" id="L433">		importFileChooser.setFileFilter(new XmlImportFileFilter());</span>
<span class="nc" id="L434">		importFileChooser.setFileHidingEnabled(false);</span>
<span class="nc" id="L435">		importFileChooser.setCurrentDirectory(this.applicationPreferences.getPreviousImportPath());</span>

<span class="nc" id="L437">		setSplashStatusText(&quot;Creating task manager frame.&quot;);</span>
<span class="nc" id="L438">		taskManagerFrame = new TaskManagerInternalFrame(this);</span>
<span class="nc" id="L439">		taskManagerFrame.setTitle(&quot;Task Manager&quot;);</span>
<span class="nc" id="L440">		taskManagerFrame.setDefaultCloseOperation(JInternalFrame.HIDE_ON_CLOSE);</span>
<span class="nc" id="L441">		taskManagerFrame.setBounds(0, 0, 320, 240);</span>

<span class="nc" id="L443">		desktop.add(taskManagerFrame);</span>
<span class="nc" id="L444">		desktop.validate();</span>

		// the following code must be executed after desktop has been initialized...
		try
		{
			// try to use the 1.6 transfer handler...
<span class="nc" id="L450">			new MainFrameTransferHandler16(this).attach();</span>
		}
<span class="nc" id="L452">		catch (Throwable t)</span>
		{
			// ... and use the basic 1.5 transfer handler if this fails.
<span class="nc" id="L455">			new MainFrameTransferHandler(this).attach();</span>
<span class="nc" id="L456">		}</span>

<span class="nc" id="L458">		helpUrl = MainFrame.class.getResource(&quot;/help/index.xhtml&quot;);</span>
<span class="nc" id="L459">	}</span>

	/**
	 * To be called after setVisible(true)...
	 */
	public void startUp()
	{
		//Thread referenceCollection=new Thread(new ColorsCollectionRunnable(), &quot;ColorCacheCleanupThread&quot;);
		//referenceCollection.setDaemon(true);
		//referenceCollection.start();

<span class="nc" id="L470">		setSplashStatusText(&quot;Executing autostart items.&quot;);</span>
		// Autostart
		{
<span class="nc" id="L473">			File autostartDir = new File(startupApplicationPath, &quot;autostart&quot;);</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">			if (autostartDir.mkdirs())</span>
			{
<span class="nc bnc" id="L476" title="All 2 branches missed.">				if (logger.isDebugEnabled()) logger.debug(&quot;Created '{}'.&quot;, autostartDir.getAbsolutePath());</span>
			}
<span class="nc" id="L478">			File[] autoFiles = autostartDir.listFiles(new FileFilter()</span>
<span class="nc" id="L479">			{</span>
				public boolean accept(File file)
				{
<span class="nc" id="L482">					return file.isFile();</span>
				}
			});

<span class="nc bnc" id="L486" title="All 4 branches missed.">			if (autoFiles != null &amp;&amp; autoFiles.length &gt; 0)</span>
			{
<span class="nc" id="L488">				Arrays.sort(autoFiles, new Comparator&lt;File&gt;()</span>
<span class="nc" id="L489">				{</span>
					public int compare(File o1, File o2)
					{
<span class="nc" id="L492">						return o1.getAbsolutePath().compareTo(o2.getAbsolutePath());</span>
					}
				});
<span class="nc bnc" id="L495" title="All 2 branches missed.">				for (File current : autoFiles)</span>
				{
<span class="nc" id="L497">					AutostartRunnable r = new AutostartRunnable(current);</span>
<span class="nc" id="L498">					autostartProcesses.add(r);</span>
<span class="nc" id="L499">					Thread t = new Thread(r, current.getAbsolutePath());</span>
<span class="nc" id="L500">					t.setDaemon(true);</span>
<span class="nc" id="L501">					t.start();</span>
				}
			}
			else
			{
<span class="nc bnc" id="L506" title="All 2 branches missed.">				if (logger.isInfoEnabled())</span>
				{
<span class="nc" id="L508">					logger.info(&quot;No autostart files defined in '{}'.&quot;, autostartDir.getAbsolutePath());</span>
				}
			}
		}

		// go to source
		{
<span class="nc" id="L515">			gotoSource = new GoToSourceService();</span>
			//gotoSource.start() started when needed...
		}

<span class="nc" id="L519">		setSplashStatusText(&quot;Creating global views.&quot;);</span>
<span class="nc" id="L520">		SourceIdentifier globalSourceIdentifier = new SourceIdentifier(&quot;global&quot;, null);</span>

<span class="nc" id="L522">		FileDumpEventConsumer&lt;LoggingEvent&gt; loggingFileDump = new FileDumpEventConsumer&lt;LoggingEvent&gt;(globalSourceIdentifier, loggingFileBufferFactory);</span>

<span class="nc" id="L524">		FileDumpEventConsumer&lt;AccessEvent&gt; accessFileDump = new FileDumpEventConsumer&lt;AccessEvent&gt;(globalSourceIdentifier, accessFileBufferFactory);</span>

<span class="nc" id="L526">		BlockingCircularBuffer&lt;EventWrapper&lt;LoggingEvent&gt;&gt; loggingEventQueue = new LilithBuffer&lt;LoggingEvent&gt;(applicationPreferences, 1000);</span>
<span class="nc" id="L527">		BlockingCircularBuffer&lt;EventWrapper&lt;AccessEvent&gt;&gt; accessEventQueue = new LilithBuffer&lt;AccessEvent&gt;(applicationPreferences, 1000);</span>

<span class="nc" id="L529">		SourceManagerImpl&lt;LoggingEvent&gt; lsm = new SourceManagerImpl&lt;LoggingEvent&gt;(loggingEventQueue);</span>
		// add global view
<span class="nc" id="L531">		EventSource&lt;LoggingEvent&gt; globalLoggingEventSource = new EventSourceImpl&lt;LoggingEvent&gt;(globalSourceIdentifier, loggingFileDump.getBuffer(), true);</span>
<span class="nc" id="L532">		lsm.addSource(globalLoggingEventSource);</span>

<span class="nc" id="L534">		setSplashStatusText(&quot;Creating internal view.&quot;);</span>
		// add internal lilith logging
<span class="nc" id="L536">		EventSource&lt;LoggingEvent&gt; lilithLoggingEventSource = new EventSourceImpl&lt;LoggingEvent&gt;(InternalLilithAppender.getSourceIdentifier(), InternalLilithAppender.getBuffer(), false);</span>
<span class="nc" id="L537">		lsm.addSource(lilithLoggingEventSource);</span>

<span class="nc" id="L539">		setLoggingEventSourceManager(lsm);</span>

<span class="nc" id="L541">		SourceManagerImpl&lt;AccessEvent&gt; asm = new SourceManagerImpl&lt;AccessEvent&gt;(accessEventQueue);</span>
		// add global view
<span class="nc" id="L543">		EventSource&lt;AccessEvent&gt; globalAccessEventSource = new EventSourceImpl&lt;AccessEvent&gt;(globalSourceIdentifier, accessFileDump.getBuffer(), true);</span>
<span class="nc" id="L544">		asm.addSource(globalAccessEventSource);</span>
<span class="nc" id="L545">		setAccessEventSourceManager(asm);</span>

		try
		{
<span class="nc" id="L549">			loggingEventSourceManager.addEventSourceProducer(new LogbackLoggingServerSocketEventSourceProducer(4560));</span>
		}
<span class="nc" id="L551">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L553" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L554">		}</span>

<span class="nc" id="L556">		setSplashStatusText(&quot;Starting event receivers.&quot;);</span>
		try
		{
<span class="nc" id="L559">			LoggingEventProtobufServerSocketEventSourceProducer producer</span>
					= new LoggingEventProtobufServerSocketEventSourceProducer
					(ClassicMultiplexSocketAppender.COMRESSED_DEFAULT_PORT, true);

<span class="nc" id="L563">			loggingEventSourceManager.addEventSourceProducer(producer);</span>
			// TODO: senderService.addLoggingProducer(producer);
		}
<span class="nc" id="L566">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L568" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L569">		}</span>

		try
		{
<span class="nc" id="L573">			LoggingEventProtobufServerSocketEventSourceProducer producer</span>
					= new LoggingEventProtobufServerSocketEventSourceProducer
					(ClassicMultiplexSocketAppender.UNCOMRESSED_DEFAULT_PORT, false);

<span class="nc" id="L577">			loggingEventSourceManager.addEventSourceProducer(producer);</span>
			// TODO: senderService.addLoggingProducer(producer);
		}
<span class="nc" id="L580">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L582" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L583">		}</span>


		try
		{
<span class="nc" id="L588">			LilithXmlMessageLoggingServerSocketEventSourceProducer producer</span>
					= new LilithXmlMessageLoggingServerSocketEventSourceProducer
					(ClassicXmlMultiplexSocketAppender.UNCOMRESSED_DEFAULT_PORT, false);

<span class="nc" id="L592">			loggingEventSourceManager.addEventSourceProducer(producer);</span>
		}
<span class="nc" id="L594">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L596" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L597">		}</span>

		try
		{
<span class="nc" id="L601">			LilithXmlMessageLoggingServerSocketEventSourceProducer producer</span>
					= new LilithXmlMessageLoggingServerSocketEventSourceProducer
					(ClassicXmlMultiplexSocketAppender.COMRESSED_DEFAULT_PORT, true);

<span class="nc" id="L605">			loggingEventSourceManager.addEventSourceProducer(producer);</span>
		}
<span class="nc" id="L607">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L609" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L610">		}</span>
//
		try
		{
<span class="nc" id="L614">			LilithXmlStreamLoggingServerSocketEventSourceProducer producer</span>
					= new LilithXmlStreamLoggingServerSocketEventSourceProducer
					(ZeroDelimitedClassicXmlMultiplexSocketAppender.DEFAULT_PORT);

<span class="nc" id="L618">			loggingEventSourceManager.addEventSourceProducer(producer);</span>
		}
<span class="nc" id="L620">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L622" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L623">		}</span>

		try
		{
<span class="nc" id="L627">			accessEventSourceManager.addEventSourceProducer(new LogbackAccessServerSocketEventSourceProducer(4570));</span>
		}
<span class="nc" id="L629">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L631" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L632">		}</span>
		try
		{
<span class="nc" id="L635">			AccessEventProtobufServerSocketEventSourceProducer producer</span>
					= new AccessEventProtobufServerSocketEventSourceProducer
					(AccessMultiplexSocketAppender.COMRESSED_DEFAULT_PORT, true);

<span class="nc" id="L639">			accessEventSourceManager.addEventSourceProducer(producer);</span>
			// TODO: senderService.addAccessProducer(producer);
		}
<span class="nc" id="L642">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L644" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L645">		}</span>

		try
		{
<span class="nc" id="L649">			AccessEventProtobufServerSocketEventSourceProducer producer</span>
					= new AccessEventProtobufServerSocketEventSourceProducer
					(AccessMultiplexSocketAppender.UNCOMPRESSED_DEFAULT_PORT, false);

<span class="nc" id="L653">			accessEventSourceManager.addEventSourceProducer(producer);</span>
			// TODO: senderService.addAccessProducer(producer);
		}
<span class="nc" id="L656">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L658" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating event producer!&quot;, ex);</span>
<span class="nc" id="L659">		}</span>
<span class="nc" id="L660">		viewActions = new ViewActions(this, null);</span>
<span class="nc" id="L661">		viewActions.getPopupMenu(); // initialize popup once in main frame only.</span>

<span class="nc" id="L663">		setSplashStatusText(&quot;Setting up event consumers.&quot;);</span>

<span class="nc" id="L665">		RrdLoggingEventConsumer rrdDb = new RrdLoggingEventConsumer();</span>
<span class="nc" id="L666">		rrdDb.setBasePath(new File(startupApplicationPath, &quot;statistics&quot;));</span>
<span class="nc" id="L667">		AlarmSoundLoggingEventConsumer loggingEventAlarmSound = new AlarmSoundLoggingEventConsumer();</span>
<span class="nc" id="L668">		loggingEventAlarmSound.setSounds(sounds);</span>

<span class="nc" id="L670">		FileSplitterEventConsumer&lt;LoggingEvent&gt; fileSplitterLoggingEventConsumer =</span>
				new FileSplitterEventConsumer&lt;LoggingEvent&gt;(/*applicationPreferences, */loggingFileBufferFactory, loggingEventSourceManager);

<span class="nc" id="L673">		List&lt;EventConsumer&lt;LoggingEvent&gt;&gt; loggingConsumers = new ArrayList&lt;EventConsumer&lt;LoggingEvent&gt;&gt;();</span>

<span class="nc" id="L675">		loggingConsumers.add(rrdDb);</span>
<span class="nc" id="L676">		loggingConsumers.add(loggingEventAlarmSound);</span>
<span class="nc" id="L677">		loggingConsumers.add(fileSplitterLoggingEventConsumer);</span>
<span class="nc" id="L678">		loggingConsumers.add(loggingFileDump);</span>

		// crashs the app using j2se 6
		//if(application.isMac())
		//{
		//	UserNotificationLoggingEventConsumer notification = new UserNotificationLoggingEventConsumer(application);
		//	loggingConsumers.add(notification);
		//}
<span class="nc" id="L686">		loggingEventSourceManager.setEventConsumers(loggingConsumers);</span>
<span class="nc" id="L687">		loggingEventSourceManager.start();</span>

<span class="nc" id="L689">		List&lt;EventConsumer&lt;AccessEvent&gt;&gt; accessConsumers = new ArrayList&lt;EventConsumer&lt;AccessEvent&gt;&gt;();</span>

<span class="nc" id="L691">		FileSplitterEventConsumer&lt;AccessEvent&gt; fileSplitterAccessEventConsumer =</span>
				new FileSplitterEventConsumer&lt;AccessEvent&gt;(/*applicationPreferences, */accessFileBufferFactory, accessEventSourceManager);
<span class="nc" id="L693">		AlarmSoundAccessEventConsumer accessEventAlarmSound = new AlarmSoundAccessEventConsumer();</span>
<span class="nc" id="L694">		accessEventAlarmSound.setSounds(sounds);</span>
<span class="nc" id="L695">		accessConsumers.add(accessEventAlarmSound);</span>
<span class="nc" id="L696">		accessConsumers.add(fileSplitterAccessEventConsumer);</span>
<span class="nc" id="L697">		accessConsumers.add(accessFileDump);</span>

		// crashs the app using j2se 6
		//if(application.isMac())
		//{
		//	UserNotificationAccessEventConsumer notification = new UserNotificationAccessEventConsumer(application);
		//	accessConsumers.add(notification);
		//}

<span class="nc" id="L706">		accessEventSourceManager.setEventConsumers(accessConsumers);</span>
<span class="nc" id="L707">		accessEventSourceManager.start();</span>

<span class="nc" id="L709">		JMenuBar menuBar = viewActions.getMenuBar();</span>
<span class="nc" id="L710">		JToolBar toolbar = viewActions.getToolbar();</span>
<span class="nc" id="L711">		add(toolbar, BorderLayout.NORTH);</span>
<span class="nc" id="L712">		setJMenuBar(menuBar);</span>
<span class="nc" id="L713">		viewActions.updateWindowMenu();</span>
<span class="nc" id="L714">		application.setEnabledAboutMenu(true);</span>
<span class="nc" id="L715">		application.setEnabledPreferencesMenu(true);</span>
<span class="nc" id="L716">		application.addApplicationListener(new MyApplicationListener());</span>

<span class="nc bnc" id="L718" title="All 2 branches missed.">		if (enableBonjour)</span>
		{
<span class="nc" id="L720">			senderService.start();</span>
		}
<span class="nc bnc" id="L722" title="All 2 branches missed.">		if (applicationPreferences.isCheckingForUpdate())</span>
		{
<span class="nc" id="L724">			checkForUpdate(false);</span>
		}
<span class="nc" id="L726">		updateConditions(); // to initialize active conditions.</span>
<span class="nc" id="L727">		setSplashStatusText(&quot;Finished.&quot;);</span>
<span class="nc" id="L728">		cleanObsoleteFiles();</span>
<span class="nc" id="L729">	}</span>

	private void updateTaskStatus()
	{
<span class="nc" id="L733">		int numberOfTasks = longTaskManager.getNumberOfTasks();</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">		if (numberOfTasks != previousNumberOfTasks)</span>
		{
<span class="nc" id="L736">			previousNumberOfTasks = numberOfTasks;</span>
<span class="nc" id="L737">			String text = &quot;&quot;;</span>
<span class="nc" id="L738">			Icon icon = null;</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">			if (numberOfTasks == 1)</span>
			{
<span class="nc" id="L741">				text = &quot;1 active task.&quot;;</span>
<span class="nc" id="L742">				icon = smallProgressIcon;</span>
			}
<span class="nc bnc" id="L744" title="All 2 branches missed.">			else if (numberOfTasks &gt; 1)</span>
			{
<span class="nc" id="L746">				text = &quot;&quot; + numberOfTasks + &quot; active tasks.&quot;;</span>
<span class="nc" id="L747">				icon = smallProgressIcon;</span>
			}
<span class="nc" id="L749">			taskStatusLabel.setText(text);</span>
<span class="nc" id="L750">			taskStatusLabel.setIcon(icon);</span>
		}
<span class="nc" id="L752">	}</span>

	private void setSplashStatusText(String text)
	{
<span class="nc bnc" id="L756" title="All 2 branches missed.">		if (splashScreen != null)</span>
		{
<span class="nc" id="L758">			splashScreen.setStatusText(text);</span>
		}
<span class="nc" id="L760">	}</span>

	public Application getApplication()
	{
<span class="nc" id="L764">		return application;</span>
	}

//	/**
//	 * Returns a sorted map containing resolved source name mapped to sender. If there is both a compressed
//	 * and uncompressed sender the compressed one will be used.
//	 * @param senders a map of all senders
//	 * @return a  map of senders.
//	 */
//	private &lt;T extends Serializable&gt; Map&lt;String, EventSender&lt;T&gt;&gt; getEventSenders(Map&lt;String, EventSender&lt;T&gt;&gt; senders)
//	{
//		Map&lt;String, EventSender&lt;T&gt;&gt; serviceNameSenderMapping;
//		synchronized(senders)
//		{
//			serviceNameSenderMapping =new HashMap&lt;String, EventSender&lt;T&gt;&gt;(senders);
//		}
//
//		SortedMap&lt;String, EventSender&lt;T&gt;&gt; result=new TreeMap&lt;String, EventSender&lt;T&gt;&gt;();
//		for(Map.Entry&lt;String, EventSender&lt;T&gt;&gt; current: serviceNameSenderMapping.entrySet())
//		{
//			EventSender&lt;T&gt; value = current.getValue();
//			String hostName = value.getHostAddress();
//			hostName = getPrimarySourceTitle(hostName);
//			EventSender&lt;T&gt; prevValue = result.get(hostName);
//			if(prevValue == null)
//			{
//				result.put(hostName, value);
//			}
//			else
//			{
//				if(value instanceof AbstractEventSender)
//				{
//					AbstractEventSender aes = (AbstractEventSender) value;
//					if(aes.isCompressing())
//					{
//						result.put(hostName, value);
//						if(logger.isDebugEnabled()) logger.debug(&quot;Replaced previous sender with compressing one.&quot;);
//					}
//				}
//			}
//		}
//		if(logger.isDebugEnabled()) logger.debug(&quot;EventSenders: {}&quot;, result);
//		return result;
//	}

	public Map&lt;String, EventSender&lt;LoggingEvent&gt;&gt; getLoggingEventSenders()
	{
<span class="nc" id="L811">		return senderService.getLoggingEventSenders();//getEventSenders(loggingEventSenders);</span>
	}

	public Map&lt;String, EventSender&lt;AccessEvent&gt;&gt; getAccessEventSenders()
	{
<span class="nc" id="L816">		return senderService.getAccessEventSenders();//getEventSenders(accessEventSenders);</span>
	}

	public void updateWindowMenus()
	{
<span class="nc" id="L821">		viewActions.updateWindowMenu();</span>
		// update other frames
<span class="nc" id="L823">		Map&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; loggingViews = loggingEventViewManager.getViews();</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">		for (Map.Entry&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; current : loggingViews.entrySet())</span>
		{
<span class="nc" id="L826">			ViewContainer&lt;LoggingEvent&gt; value = current.getValue();</span>
<span class="nc" id="L827">			ViewWindow window = value.resolveViewWindow();</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">			if (window instanceof JFrame)</span>
			{
<span class="nc" id="L830">				window.getViewActions().updateWindowMenu();</span>
			}
<span class="nc" id="L832">		}</span>
<span class="nc" id="L833">		Map&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; accessViews = accessEventViewManager.getViews();</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">		for (Map.Entry&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; current : accessViews.entrySet())</span>
		{
<span class="nc" id="L836">			ViewContainer&lt;AccessEvent&gt; value = current.getValue();</span>
<span class="nc" id="L837">			ViewWindow window = value.resolveViewWindow();</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">			if (window instanceof JFrame)</span>
			{
<span class="nc" id="L840">				window.getViewActions().updateWindowMenu();</span>
			}
<span class="nc" id="L842">		}</span>
<span class="nc" id="L843">	}</span>


	public void closeLoggingConnection(SourceIdentifier id)
	{
<span class="nc" id="L848">		loggingEventSourceManager.removeEventProducer(id);</span>
<span class="nc" id="L849">	}</span>

	public void closeAccessConnection(SourceIdentifier id)
	{
<span class="nc" id="L853">		accessEventSourceManager.removeEventProducer(id);</span>
<span class="nc" id="L854">	}</span>

	public void goToSource(StackTraceElement ste)
	{
		/*
		String className=ste.getClassName();
		int dollarIndex = className.indexOf(&quot;$&quot;);
		if(dollarIndex&gt;=0)
		{
			String parentClassName=className.substring(0, dollarIndex);
			if(logger.isWarnEnabled()) logger.warn(&quot;parentClassName: {}&quot;, parentClassName);
		}
        */
<span class="nc bnc" id="L867" title="All 2 branches missed.">		if (gotoSource != null)</span>
		{
<span class="nc" id="L869">			gotoSource.goToSource(ste);</span>
		}
<span class="nc" id="L871">	}</span>

	public void setActiveConnectionsCounter(int activeCounter)
	{
<span class="nc" id="L875">		this.activeCounter = activeCounter;</span>
<span class="nc" id="L876">		updateStatus();</span>
<span class="nc" id="L877">	}</span>

	public void copyHtml(String html)
	{
<span class="nc" id="L881">		Clipboard systemClipboard = Toolkit.getDefaultToolkit().getSystemClipboard();</span>
<span class="nc" id="L882">		Transferable transferableText = new HtmlTransferable(html);</span>
<span class="nc" id="L883">		systemClipboard.setContents(transferableText, null);</span>
<span class="nc" id="L884">	}</span>

	public void checkForUpdate(boolean showAlways)
	{
<span class="nc" id="L888">		Thread t = new Thread(new CheckForUpdateRunnable(showAlways));</span>
<span class="nc" id="L889">		t.start();</span>
<span class="nc" id="L890">	}</span>

	public void showPopup(Component component, Point p)
	{
<span class="nc bnc" id="L894" title="All 2 branches missed.">		if (logger.isDebugEnabled()) logger.debug(&quot;Show popup at {}.&quot;, p);</span>
<span class="nc" id="L895">		JPopupMenu popup = viewActions.getPopupMenu();</span>
<span class="nc" id="L896">		popup.show(component, p.x, p.y);</span>
<span class="nc" id="L897">	}</span>

	public Colors getColors(HttpStatus.Type status)
	{
<span class="nc bnc" id="L901" title="All 2 branches missed.">		if (statusColors == null)</span>
		{
<span class="nc" id="L903">			initStatusColors();</span>
		}
<span class="nc" id="L905">		return statusColors.get(status);</span>
	}

	public Colors getColors(LoggingEvent.Level level)
	{
<span class="nc bnc" id="L910" title="All 2 branches missed.">		if (levelColors == null)</span>
		{
<span class="nc" id="L912">			initLevelColors();</span>
		}
<span class="nc" id="L914">		return levelColors.get(level);</span>
	}

	public Colors getColors(EventWrapper eventWrapper)
	{
<span class="nc bnc" id="L919" title="All 2 branches missed.">		if (!SwingUtilities.isEventDispatchThread())</span>
		{
<span class="nc bnc" id="L921" title="All 2 branches missed.">			if (logger.isErrorEnabled()) logger.error(&quot;Not on EventDispatchThread!&quot;);</span>
		}
<span class="nc bnc" id="L923" title="All 2 branches missed.">		if (activeConditions != null)</span>
		{
<span class="nc bnc" id="L925" title="All 2 branches missed.">			for (SavedCondition current : activeConditions)</span>
			{
<span class="nc" id="L927">				Condition condition = current.getCondition();</span>
<span class="nc bnc" id="L928" title="All 4 branches missed.">				if (condition != null &amp;&amp; condition.isTrue(eventWrapper))</span>
				{
<span class="nc" id="L930">					return new Colors(current.getColorScheme());</span>
				}
<span class="nc" id="L932">			}</span>
		}

<span class="nc bnc" id="L935" title="All 2 branches missed.">		if (coloringWholeRow)</span>
		{
<span class="nc" id="L937">			Object eventObj = eventWrapper.getEvent();</span>
<span class="nc bnc" id="L938" title="All 2 branches missed.">			if (eventObj instanceof LoggingEvent)</span>
			{
<span class="nc" id="L940">				return getColors(((LoggingEvent) eventObj).getLevel());</span>
			}
<span class="nc bnc" id="L942" title="All 2 branches missed.">			if (eventObj instanceof AccessEvent)</span>
			{
<span class="nc" id="L944">				return getColors(HttpStatus.getType(((AccessEvent) eventObj).getStatusCode()));</span>
			}
		}
<span class="nc" id="L947">		return null;</span>
	}

	public void open()
	{
<span class="nc" id="L952">		int returnVal = openFileChooser.showOpenDialog(this);</span>

<span class="nc bnc" id="L954" title="All 2 branches missed.">		if (returnVal == JFileChooser.APPROVE_OPTION)</span>
		{
<span class="nc" id="L956">			open(openFileChooser.getSelectedFile());</span>
		}
<span class="nc" id="L958">	}</span>

	public void importFile()
	{
<span class="nc" id="L962">		int returnVal = importFileChooser.showOpenDialog(this);</span>

<span class="nc bnc" id="L964" title="All 2 branches missed.">		if (returnVal == JFileChooser.APPROVE_OPTION)</span>
		{
<span class="nc" id="L966">			File importFile = importFileChooser.getSelectedFile();</span>
<span class="nc" id="L967">			String fileName = importFile.getAbsolutePath();</span>
<span class="nc bnc" id="L968" title="All 2 branches missed.">			if (fileName.toLowerCase().endsWith(FileConstants.FILE_EXTENSION))</span>
			{
<span class="nc" id="L970">				open(importFile);</span>
<span class="nc" id="L971">				return;</span>
			}
<span class="nc" id="L973">			importFile(importFile);</span>
		}
<span class="nc" id="L975">	}</span>

	public void open(File dataFile)
	{
<span class="nc bnc" id="L979" title="All 2 branches missed.">		if (logger.isInfoEnabled()) logger.info(&quot;Open file: {}&quot;, dataFile.getAbsolutePath());</span>
<span class="nc" id="L980">		ViewContainer&lt;?&gt; viewContainer = resolveViewContainer(dataFile);</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">		if (viewContainer != null)</span>
		{
<span class="nc" id="L983">			showView(viewContainer);</span>
<span class="nc" id="L984">			String message = &quot;File '&quot; + dataFile.getAbsolutePath() + &quot;' is already open.&quot;;</span>
<span class="nc" id="L985">			JOptionPane.showMessageDialog(this, message, &quot;File is already open...&quot;, JOptionPane.INFORMATION_MESSAGE);</span>
<span class="nc" id="L986">			return;</span>
		}
<span class="nc" id="L988">		String fileName = dataFile.getAbsolutePath();</span>
		String indexFileName;
<span class="nc bnc" id="L990" title="All 2 branches missed.">		if (fileName.toLowerCase().endsWith(FileConstants.FILE_EXTENSION))</span>
		{
<span class="nc" id="L992">			indexFileName = fileName.substring(0, fileName.length() - FileConstants.FILE_EXTENSION.length());</span>
		}
		else
		{
<span class="nc" id="L996">			indexFileName = fileName;</span>
		}
<span class="nc" id="L998">		indexFileName = indexFileName + FileConstants.INDEX_FILE_EXTENSION;</span>

<span class="nc" id="L1000">		File indexFile = new File(indexFileName);</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">		if (!indexFile.isFile())</span>
		{
			// ask if it should be indexed.
<span class="nc" id="L1004">			String dialogTitle = &quot;Index file?&quot;;</span>
<span class="nc" id="L1005">			String message = &quot;Index file does not exist!\nIndex data file right now?&quot;;</span>
<span class="nc" id="L1006">			int result = JOptionPane.showConfirmDialog(this, message, dialogTitle,</span>
					JOptionPane.OK_CANCEL_OPTION, JOptionPane.QUESTION_MESSAGE);
<span class="nc bnc" id="L1008" title="All 2 branches missed.">			if (JOptionPane.OK_OPTION != result)</span>
			{
<span class="nc" id="L1010">				return;</span>
			}
<span class="nc" id="L1012">			String name = &quot;Indexing Lilith file&quot;;</span>
<span class="nc" id="L1013">			String description = &quot;Indexing '&quot; + dataFile.getAbsolutePath() + &quot;'...&quot;;</span>
<span class="nc" id="L1014">			Task&lt;Long&gt; task = longTaskManager.startTask(new IndexingCallable(dataFile, indexFile), name, description);</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Task-Name: {}&quot;, task.getName());</span>
<span class="nc" id="L1016">		}</span>
		else
		{
<span class="nc" id="L1019">			createViewFor(dataFile, indexFile);</span>
		}
<span class="nc" id="L1021">	}</span>

	public void importFile(File importFile)
	{
<span class="nc bnc" id="L1025" title="All 2 branches missed.">		if (logger.isInfoEnabled()) logger.info(&quot;Import file: {}&quot;, importFile.getAbsolutePath());</span>

<span class="nc" id="L1027">		File parentFile = importFile.getParentFile();</span>
<span class="nc" id="L1028">		String inputName = importFile.getName();</span>

<span class="nc" id="L1030">		File dataFile = new File(parentFile, inputName + FileConstants.FILE_EXTENSION);</span>
<span class="nc" id="L1031">		File indexFile = new File(parentFile, inputName + FileConstants.INDEX_FILE_EXTENSION);</span>

		// check if file exists and warn in that case
<span class="nc bnc" id="L1034" title="All 2 branches missed.">		if (dataFile.isFile())</span>
		{
			// check if file is already open
<span class="nc" id="L1037">			ViewContainer&lt;?&gt; viewContainer = resolveViewContainer(dataFile);</span>
<span class="nc bnc" id="L1038" title="All 2 branches missed.">			if (viewContainer != null)</span>
			{
<span class="nc" id="L1040">				showView(viewContainer);</span>
<span class="nc" id="L1041">				String message = &quot;File '&quot; + dataFile.getAbsolutePath() + &quot;' is already open.&quot;;</span>
<span class="nc" id="L1042">				JOptionPane</span>
<span class="nc" id="L1043">						.showMessageDialog(this, message, &quot;File is already open...&quot;, JOptionPane.INFORMATION_MESSAGE);</span>
				// TODO: Offer option to reimport anyway. Close view beforehand in tht case.
<span class="nc" id="L1045">				return;</span>
			}
<span class="nc" id="L1047">			String dialogTitle = &quot;Reimport file?&quot;;</span>
<span class="nc" id="L1048">			String message = &quot;Data file does already exist!\nReimport data file right now?&quot;;</span>
<span class="nc" id="L1049">			int result = JOptionPane.showConfirmDialog(this, message, dialogTitle,</span>
					JOptionPane.OK_CANCEL_OPTION, JOptionPane.QUESTION_MESSAGE);
<span class="nc bnc" id="L1051" title="All 2 branches missed.">			if (JOptionPane.OK_OPTION != result)</span>
			{
<span class="nc" id="L1053">				return;</span>
			}

<span class="nc bnc" id="L1056" title="All 2 branches missed.">			if (dataFile.delete())</span>
			{
<span class="nc bnc" id="L1058" title="All 2 branches missed.">				if (logger.isInfoEnabled()) logger.info(&quot;Deleted file '{}'.&quot;, dataFile.getAbsolutePath());</span>
			}
		}
<span class="nc bnc" id="L1061" title="All 2 branches missed.">		if (indexFile.isFile())</span>
		{
<span class="nc bnc" id="L1063" title="All 2 branches missed.">			if (indexFile.delete())</span>
			{
<span class="nc bnc" id="L1065" title="All 2 branches missed.">				if (logger.isInfoEnabled()) logger.info(&quot;Deleted file '{}'.&quot;, indexFile.getAbsolutePath());</span>
			}
		}

<span class="nc" id="L1069">		Map&lt;String, String&gt; metaData = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1070">		metaData.put(FileConstants.CONTENT_FORMAT_KEY, FileConstants.CONTENT_FORMAT_VALUE_PROTOBUF);</span>
<span class="nc" id="L1071">		metaData.put(FileConstants.CONTENT_TYPE_KEY, FileConstants.CONTENT_TYPE_VALUE_LOGGING);</span>
<span class="nc" id="L1072">		metaData.put(FileConstants.COMPRESSION_KEY, FileConstants.COMPRESSION_VALUE_GZIP);</span>

<span class="nc" id="L1074">		FileBuffer&lt;EventWrapper&lt;LoggingEvent&gt;&gt; buffer =</span>
<span class="nc" id="L1075">				loggingFileBufferFactory.createBuffer(dataFile, indexFile, metaData);</span>

<span class="nc" id="L1077">		ImportType type = resolveType(importFile);</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">		if (type == ImportType.LOG4J)</span>
		{
<span class="nc" id="L1080">			String name = &quot;Importing Log4J XML file&quot;;</span>
<span class="nc" id="L1081">			String description = &quot;Importing Log4J XML file '&quot; + importFile.getAbsolutePath() + &quot;'...&quot;;</span>
<span class="nc" id="L1082">			Task&lt;Long&gt; task = longTaskManager.startTask(new Log4jImportCallable(importFile, buffer), name, description);</span>
<span class="nc bnc" id="L1083" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Task-Name: {}&quot;, task.getName());</span>
<span class="nc" id="L1084">			return;</span>
		}
<span class="nc bnc" id="L1086" title="All 2 branches missed.">		if (type == ImportType.JUL)</span>
		{
<span class="nc" id="L1088">			String name = &quot;Importing java.util.logging XML file&quot;;</span>
<span class="nc" id="L1089">			String description = &quot;Importing java.util.logging XML file '&quot; + importFile.getAbsolutePath() + &quot;'...&quot;;</span>
<span class="nc" id="L1090">			Task&lt;Long&gt; task = longTaskManager.startTask(new JulImportCallable(importFile, buffer), name, description);</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Task-Name: {}&quot;, task.getName());</span>
<span class="nc" id="L1092">			return;</span>
		}

		// show warning &quot;Unknown type&quot;
<span class="nc" id="L1096">		String message = &quot;Couldn't detect type of file '&quot; + importFile.getAbsolutePath() + &quot;'.\nFile is unsupported.&quot;;</span>
<span class="nc" id="L1097">		JOptionPane.showMessageDialog(this, message, &quot;Unknown file type...&quot;, JOptionPane.WARNING_MESSAGE);</span>
<span class="nc" id="L1098">	}</span>

	private ImportType resolveType(File importFile)
	{
<span class="nc" id="L1102">		BufferedReader br = null;</span>
		try
		{
<span class="nc" id="L1105">			br = new BufferedReader(new FileReader(importFile));</span>
<span class="nc bnc" id="L1106" title="All 2 branches missed.">			for (int i = 0; i &lt; 5; i++)</span>
			{
<span class="nc" id="L1108">				String line = br.readLine();</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">				if (line == null)</span>
				{
<span class="nc" id="L1111">					break;</span>
				}
<span class="nc bnc" id="L1113" title="All 2 branches missed.">				if (line.contains(&quot;&lt;log4j:&quot;))</span>
				{
<span class="nc" id="L1115">					return ImportType.LOG4J;</span>
				}
<span class="nc bnc" id="L1117" title="All 4 branches missed.">				if (line.contains(&quot;&lt;log&gt;&quot;) || line.contains(&quot;&lt;record&gt;&quot;))</span>
				{
<span class="nc" id="L1119">					return ImportType.JUL;</span>
				}
			}
		}
<span class="nc" id="L1123">		catch (IOException ex)</span>
		{
<span class="nc bnc" id="L1125" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while resolving type of file!&quot;, ex);</span>
		}
		finally
		{
<span class="nc bnc" id="L1129" title="All 2 branches missed.">			if (br != null)</span>
			{
				try
				{
<span class="nc" id="L1133">					br.close();</span>
				}
<span class="nc" id="L1135">				catch (IOException e)</span>
				{
					// ignore
<span class="nc" id="L1138">				}</span>
			}
		}
<span class="nc" id="L1141">		return null;</span>
	}

<span class="nc" id="L1144">	public enum ImportType</span>
	{
<span class="nc" id="L1146">		LOG4J, JUL</span>
	}

	public ViewContainer&lt;?&gt; resolveViewContainer(File dataFile)
	{
		{ // logging
<span class="nc" id="L1152">			Map&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; views = loggingEventViewManager.getViews();</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">			for (Map.Entry&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; current : views.entrySet())</span>
			{

<span class="nc" id="L1156">				ViewContainer&lt;LoggingEvent&gt; view = current.getValue();</span>
<span class="nc" id="L1157">				EventWrapperViewPanel&lt;LoggingEvent&gt; defaultView = view.getDefaultView();</span>
<span class="nc" id="L1158">				EventSource&lt;LoggingEvent&gt; es = defaultView.getEventSource();</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">				if (es != null)</span>
				{
<span class="nc" id="L1161">					Buffer&lt;EventWrapper&lt;LoggingEvent&gt;&gt; buffer = es.getBuffer();</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">					if (buffer instanceof CodecFileBuffer)</span>
					{
<span class="nc" id="L1164">						CodecFileBuffer cfb = (CodecFileBuffer) buffer;</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">						if (dataFile.equals(cfb.getDataFile()))</span>
						{
<span class="nc" id="L1167">							return view;</span>
						}
					}
				}
<span class="nc" id="L1171">			}</span>
		}

		{ // access
<span class="nc" id="L1175">			Map&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; views = accessEventViewManager.getViews();</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">			for (Map.Entry&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; current : views.entrySet())</span>
			{

<span class="nc" id="L1179">				ViewContainer&lt;AccessEvent&gt; view = current.getValue();</span>
<span class="nc" id="L1180">				EventWrapperViewPanel&lt;AccessEvent&gt; defaultView = view.getDefaultView();</span>
<span class="nc" id="L1181">				EventSource&lt;AccessEvent&gt; es = defaultView.getEventSource();</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">				if (es != null)</span>
				{
<span class="nc" id="L1184">					Buffer&lt;EventWrapper&lt;AccessEvent&gt;&gt; buffer = es.getBuffer();</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">					if (buffer instanceof CodecFileBuffer)</span>
					{
<span class="nc" id="L1187">						CodecFileBuffer cfb = (CodecFileBuffer) buffer;</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">						if (dataFile.equals(cfb.getDataFile()))</span>
						{
<span class="nc" id="L1190">							return view;</span>
						}
					}
				}
<span class="nc" id="L1194">			}</span>
		}

<span class="nc" id="L1197">		return null;</span>
	}

	private void createViewFor(File dataFile, File indexFile)
	{
		// create view for dataFile and indexFile.
<span class="nc bnc" id="L1203" title="All 2 branches missed.">		if (logger.isInfoEnabled())</span>
		{
<span class="nc" id="L1205">			logger</span>
<span class="nc" id="L1206">					.info(&quot;Create view for dataFile '{}' and indexFile '{}'.&quot;, dataFile.getAbsolutePath(), indexFile.getAbsolutePath());</span>
		}

<span class="nc" id="L1209">		FileHeaderStrategy fileHeaderStrategy = new DefaultFileHeaderStrategy();</span>
		try
		{
<span class="nc" id="L1212">			FileHeader header = fileHeaderStrategy.readFileHeader(dataFile);</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">			if (header == null)</span>
			{
<span class="nc bnc" id="L1215" title="All 2 branches missed.">				if (logger.isWarnEnabled())</span>
				{
<span class="nc" id="L1217">					logger.warn(&quot;Couldn't read file header from '{}'!&quot;, dataFile.getAbsolutePath());</span>
				}
<span class="nc" id="L1219">				return;</span>
			}
<span class="nc bnc" id="L1221" title="All 2 branches missed.">			if (header.getMagicValue() != FileConstants.MAGIC_VALUE)</span>
			{
<span class="nc bnc" id="L1223" title="All 2 branches missed.">				if (logger.isWarnEnabled())</span>
				{
<span class="nc" id="L1225">					logger.warn(&quot;Invalid magic value! &quot;, Integer.toHexString(header.getMagicValue()));</span>
				}
<span class="nc" id="L1227">				return;</span>
			}
<span class="nc" id="L1229">			MetaData metaData = header.getMetaData();</span>
<span class="nc bnc" id="L1230" title="All 4 branches missed.">			if (metaData == null || metaData.getData() == null)</span>
			{
<span class="nc bnc" id="L1232" title="All 2 branches missed.">				if (logger.isWarnEnabled())</span>
				{
<span class="nc" id="L1234">					logger.warn(&quot;Couldn't read meta data from '{}'!&quot;, dataFile.getAbsolutePath());</span>
				}
<span class="nc" id="L1236">				return;</span>
			}
<span class="nc" id="L1238">			Map&lt;String, String&gt; data = metaData.getData();</span>
<span class="nc" id="L1239">			String contentType = data.get(FileConstants.CONTENT_TYPE_KEY);</span>
<span class="nc" id="L1240">			Map&lt;String, String&gt; usedMetaData = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L1241">			SourceIdentifier si = new SourceIdentifier(dataFile.getAbsolutePath());</span>

<span class="nc bnc" id="L1243" title="All 2 branches missed.">			if (FileConstants.CONTENT_TYPE_VALUE_LOGGING.equals(contentType))</span>
			{
<span class="nc" id="L1245">				FileBuffer&lt;EventWrapper&lt;LoggingEvent&gt;&gt; buffer =</span>
<span class="nc" id="L1246">						loggingFileBufferFactory.createBuffer(dataFile, indexFile, usedMetaData);</span>
<span class="nc" id="L1247">				EventSource&lt;LoggingEvent&gt; eventSource = new EventSourceImpl&lt;LoggingEvent&gt;(si, buffer, false);</span>
<span class="nc" id="L1248">				ViewContainer&lt;LoggingEvent&gt; viewContainer = loggingEventViewManager.retrieveViewContainer(eventSource);</span>
<span class="nc" id="L1249">				EventWrapperViewPanel&lt;LoggingEvent&gt; panel = viewContainer.getDefaultView();</span>
<span class="nc" id="L1250">				panel.setState(LoggingViewState.INACTIVE);</span>
<span class="nc" id="L1251">				showLoggingView(eventSource);</span>
<span class="nc" id="L1252">			}</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">			else if (FileConstants.CONTENT_TYPE_VALUE_ACCESS.equals(contentType))</span>
			{
<span class="nc" id="L1255">				FileBuffer&lt;EventWrapper&lt;AccessEvent&gt;&gt; buffer =</span>
<span class="nc" id="L1256">						accessFileBufferFactory.createBuffer(dataFile, indexFile, usedMetaData);</span>
<span class="nc" id="L1257">				EventSource&lt;AccessEvent&gt; eventSource = new EventSourceImpl&lt;AccessEvent&gt;(si, buffer, false);</span>
<span class="nc" id="L1258">				ViewContainer&lt;AccessEvent&gt; viewContainer = accessEventViewManager.retrieveViewContainer(eventSource);</span>
<span class="nc" id="L1259">				EventWrapperViewPanel&lt;AccessEvent&gt; panel = viewContainer.getDefaultView();</span>
<span class="nc" id="L1260">				panel.setState(LoggingViewState.INACTIVE);</span>
<span class="nc" id="L1261">				showAccessView(eventSource);</span>
<span class="nc" id="L1262">			}</span>
			else
			{
<span class="nc bnc" id="L1265" title="All 2 branches missed.">				if (logger.isWarnEnabled()) logger.warn(&quot;Unexpected content type {}.&quot;, contentType);</span>
			}
		}
<span class="nc" id="L1268">		catch (IOException e)</span>
		{
<span class="nc bnc" id="L1270" title="All 2 branches missed.">			if (logger.isWarnEnabled()) logger.warn(&quot;Exception while creating view form file!&quot;, e);</span>
<span class="nc" id="L1271">		}</span>
<span class="nc" id="L1272">	}</span>


	/*
	// implement cache?
	private static class SoftColorsReference
		extends SoftReference&lt;Colors&gt;
	{
		private static final Colors NULL_COLORS = new Colors();

		private EventIdentifier id;

		public SoftColorsReference(EventIdentifier id, Colors o, ReferenceQueue&lt;Colors&gt; referenceQueue)
		{
			super(o != null ? o : new Colors(), referenceQueue);
			this.id = id;
		}

		public EventIdentifier getId()
		{
			return id;
		}

		public Colors getColors()
		{
			Colors result = get();
			if(NULL_COLORS.equals(result))
			{
				return null;
			}
			return result;
		}
	}
    */


	private void initStatusColors()
	{
<span class="nc" id="L1310">		Map&lt;HttpStatus.Type, ColorScheme&gt; prefValue = applicationPreferences.getStatusColors();</span>
<span class="nc" id="L1311">		Map&lt;HttpStatus.Type, Colors&gt; colors = new HashMap&lt;HttpStatus.Type, Colors&gt;();</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">		for (Map.Entry&lt;HttpStatus.Type, ColorScheme&gt; current : prefValue.entrySet())</span>
		{
<span class="nc" id="L1314">			colors.put(current.getKey(), new Colors(current.getValue()));</span>
<span class="nc" id="L1315">		}</span>
<span class="nc" id="L1316">		statusColors = colors;</span>
<span class="nc" id="L1317">	}</span>


	private void initLevelColors()
	{
<span class="nc" id="L1322">		Map&lt;LoggingEvent.Level, ColorScheme&gt; prefValue = applicationPreferences.getLevelColors();</span>
<span class="nc" id="L1323">		Map&lt;LoggingEvent.Level, Colors&gt; colors = new HashMap&lt;LoggingEvent.Level, Colors&gt;();</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">		for (Map.Entry&lt;LoggingEvent.Level, ColorScheme&gt; current : prefValue.entrySet())</span>
		{
<span class="nc" id="L1326">			colors.put(current.getKey(), new Colors(current.getValue()));</span>
<span class="nc" id="L1327">		}</span>
<span class="nc" id="L1328">		levelColors = colors;</span>
<span class="nc" id="L1329">	}</span>

<span class="nc" id="L1331">	public class MyApplicationListener</span>
			implements ApplicationListener
	{

		public void handleAbout(ApplicationEvent event)
		{
			//application.requestUserAttention(Application.REQUEST_USER_ATTENTION_TYPE_INFORMATIONAL);
<span class="nc" id="L1338">			viewActions.getAboutAction().actionPerformed(null);</span>
<span class="nc" id="L1339">			event.setHandled(true);</span>
<span class="nc" id="L1340">		}</span>

		public void handleOpenApplication(ApplicationEvent applicationEvent)
		{
<span class="nc bnc" id="L1344" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Open Application: {}&quot;, applicationEvent);</span>
<span class="nc" id="L1345">		}</span>

		public void handleOpenFile(ApplicationEvent applicationEvent)
		{
<span class="nc bnc" id="L1349" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Open File: {}&quot;, applicationEvent);</span>
<span class="nc" id="L1350">		}</span>

		public void handlePreferences(ApplicationEvent applicationEvent)
		{
<span class="nc" id="L1354">			viewActions.getPreferencesAction().actionPerformed(null);</span>
<span class="nc" id="L1355">		}</span>

		public void handlePrintFile(ApplicationEvent applicationEvent)
		{
<span class="nc bnc" id="L1359" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Print: {}&quot;, applicationEvent);</span>
<span class="nc" id="L1360">		}</span>

		public void handleQuit(ApplicationEvent applicationEvent)
		{
<span class="nc" id="L1364">			exit();</span>
<span class="nc" id="L1365">		}</span>

		public void handleReopenApplication(ApplicationEvent applicationEvent)
		{
<span class="nc bnc" id="L1369" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Reopen Application: {}&quot;, applicationEvent);</span>
<span class="nc" id="L1370">			setVisible(true);</span>
<span class="nc" id="L1371">		}</span>
	}

	private void setLoggingEventSourceManager(SourceManager&lt;LoggingEvent&gt; loggingEventSourceManager)
	{
<span class="nc bnc" id="L1376" title="All 2 branches missed.">		if (this.loggingEventSourceManager != null)</span>
		{
<span class="nc" id="L1378">			this.loggingEventSourceManager.removeEventSourceListener(loggingSourceListener);</span>
		}
<span class="nc" id="L1380">		this.loggingEventSourceManager = loggingEventSourceManager;</span>
<span class="nc bnc" id="L1381" title="All 2 branches missed.">		if (this.loggingEventSourceManager != null)</span>
		{
<span class="nc" id="L1383">			this.loggingEventSourceManager.addEventSourceListener(loggingSourceListener);</span>

<span class="nc" id="L1385">			List&lt;EventSource&lt;LoggingEvent&gt;&gt; sources = this.loggingEventSourceManager.getSources();</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">			for (EventSource&lt;LoggingEvent&gt; source : sources)</span>
			{
<span class="nc" id="L1388">				loggingEventViewManager.retrieveViewContainer(source);</span>
<span class="nc" id="L1389">			}</span>
		}
<span class="nc" id="L1391">	}</span>

	public SourceManager&lt;LoggingEvent&gt; getLoggingEventSourceManager()
	{
<span class="nc" id="L1395">		return loggingEventSourceManager;</span>
	}

	private void setAccessEventSourceManager(SourceManager&lt;AccessEvent&gt; accessEventSourceManager)
	{
<span class="nc bnc" id="L1400" title="All 2 branches missed.">		if (this.accessEventSourceManager != null)</span>
		{
<span class="nc" id="L1402">			this.accessEventSourceManager.removeEventSourceListener(accessSourceListener);</span>
		}
<span class="nc" id="L1404">		this.accessEventSourceManager = accessEventSourceManager;</span>
<span class="nc bnc" id="L1405" title="All 2 branches missed.">		if (this.accessEventSourceManager != null)</span>
		{
<span class="nc" id="L1407">			this.accessEventSourceManager.addEventSourceListener(accessSourceListener);</span>

<span class="nc" id="L1409">			List&lt;EventSource&lt;AccessEvent&gt;&gt; sources = this.accessEventSourceManager.getSources();</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">			for (EventSource&lt;AccessEvent&gt; source : sources)</span>
			{
<span class="nc" id="L1412">				accessEventViewManager.retrieveViewContainer(source);</span>
<span class="nc" id="L1413">			}</span>
		}
<span class="nc" id="L1415">	}</span>

	public SourceManager&lt;AccessEvent&gt; getAccessEventSourceManager()
	{
<span class="nc" id="L1419">		return accessEventSourceManager;</span>
	}

	public Sounds getSounds()
	{
<span class="nc" id="L1424">		return sounds;</span>
	}

	public void setSounds(Sounds sounds)
	{
<span class="nc bnc" id="L1429" title="All 2 branches missed.">		if (sounds != null)</span>
		{
<span class="nc" id="L1431">			sounds.setSoundLocations(applicationPreferences.getSoundLocations());</span>
<span class="nc" id="L1432">			sounds.setMute(applicationPreferences.isMute());</span>
		}
<span class="nc" id="L1434">		this.sounds = sounds;</span>
<span class="nc" id="L1435">	}</span>

	private ViewContainer&lt;LoggingEvent&gt; retrieveLoggingViewContainer(EventSource&lt;LoggingEvent&gt; eventSource)
	{
<span class="nc" id="L1439">		return loggingEventViewManager.retrieveViewContainer(eventSource);</span>
	}

	private ViewContainer&lt;AccessEvent&gt; retrieveAccessViewContainer(EventSource&lt;AccessEvent&gt; eventSource)
	{
<span class="nc" id="L1444">		return accessEventViewManager.retrieveViewContainer(eventSource);</span>
	}

	public ApplicationPreferences getApplicationPreferences()
	{
<span class="nc" id="L1449">		return applicationPreferences;</span>
	}

	/*
	public EventWrapperViewPanel&lt;LoggingEvent&gt; createLoggingViewPanel(EventSource&lt;LoggingEvent&gt; eventSource)
	{
		EventWrapperViewPanel&lt;LoggingEvent&gt; result = new LoggingEventViewPanel(this, eventSource);
		result.setScrollingToBottom(applicationPreferences.isScrollingToBottom());
		return result;
	}
    */

	public SortedMap&lt;String, SourceIdentifier&gt; getAvailableStatistics()
	{
<span class="nc" id="L1463">		File statisticsPath = new File(applicationPreferences.getStartupApplicationPath(), &quot;statistics&quot;);</span>
<span class="nc" id="L1464">		File[] files = statisticsPath.listFiles(rrdFileFilter);</span>
<span class="nc" id="L1465">		SortedMap&lt;String, SourceIdentifier&gt; sources = new TreeMap&lt;String, SourceIdentifier&gt;();</span>
<span class="nc bnc" id="L1466" title="All 2 branches missed.">		if (files != null)</span>
		{
<span class="nc bnc" id="L1468" title="All 2 branches missed.">			for (File f : files)</span>
			{
<span class="nc" id="L1470">				String name = f.getName();</span>
<span class="nc" id="L1471">				name = name.substring(0, name.length() - 4); // we are sure about .rrd here...</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">				if (!name.equalsIgnoreCase(&quot;global&quot;))</span>
				{
<span class="nc" id="L1474">					SourceIdentifier si = new SourceIdentifier(name);</span>
<span class="nc" id="L1475">					sources.put(getSourceTitle(si), si);</span>
				}
			}
		}
<span class="nc" id="L1479">		return sources;</span>
	}

	public void showStatistics(SourceIdentifier sourceIdentifier)
	{
<span class="nc" id="L1484">		statisticsDialog.setSourceIdentifier(sourceIdentifier);</span>
<span class="nc" id="L1485">		Windows.showWindow(statisticsDialog, MainFrame.this, true);</span>
<span class="nc" id="L1486">	}</span>

	public TaskManager&lt;Long&gt; getLongWorkManager()
	{
<span class="nc" id="L1490">		return longTaskManager;</span>
	}

	public LogFileFactory getAccessFileFactory()
	{
<span class="nc" id="L1495">		return accessFileFactory;</span>
	}

	public LogFileFactory getLoggingFileFactory()
	{
<span class="nc" id="L1500">		return loggingFileFactory;</span>
	}

	public void showLoggingView(EventSource&lt;LoggingEvent&gt; eventSource)
	{
<span class="nc" id="L1505">		ViewContainer&lt;LoggingEvent&gt; container = retrieveLoggingViewContainer(eventSource);</span>
<span class="nc" id="L1506">		showView(container);</span>
<span class="nc" id="L1507">	}</span>

	public void showAccessView(EventSource&lt;AccessEvent&gt; eventSource)
	{
<span class="nc" id="L1511">		ViewContainer&lt;AccessEvent&gt; container = retrieveAccessViewContainer(eventSource);</span>
<span class="nc" id="L1512">		showView(container);</span>
<span class="nc" id="L1513">	}</span>

	public void showView(ViewContainer&lt;?&gt; container)
	{
		// we need this since this method might also be called by a different thread
<span class="nc" id="L1518">		ShowViewRunnable runnable = new ShowViewRunnable(container);</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">		if (SwingUtilities.isEventDispatchThread())</span>
		{
<span class="nc" id="L1521">			runnable.run();</span>
		}
		else
		{
<span class="nc" id="L1525">			SwingUtilities.invokeLater(runnable);</span>
		}
<span class="nc" id="L1527">	}</span>

	public void openPreviousLogging(SourceIdentifier si)
	{
<span class="nc" id="L1531">		FileBuffer&lt;EventWrapper&lt;LoggingEvent&gt;&gt; buffer = loggingFileBufferFactory.createBuffer(si);</span>
<span class="nc" id="L1532">		EventSource&lt;LoggingEvent&gt; eventSource = new EventSourceImpl&lt;LoggingEvent&gt;(si, buffer, false);</span>

<span class="nc" id="L1534">		ViewContainer&lt;LoggingEvent&gt; container = retrieveLoggingViewContainer(eventSource);</span>
<span class="nc" id="L1535">		EventWrapperViewPanel&lt;LoggingEvent&gt; panel = container.getDefaultView();</span>
<span class="nc" id="L1536">		panel.setState(LoggingViewState.INACTIVE);</span>
<span class="nc" id="L1537">		showLoggingView(eventSource);</span>
<span class="nc" id="L1538">	}</span>

	public void openPreviousAccess(SourceIdentifier si)
	{
<span class="nc" id="L1542">		FileBuffer&lt;EventWrapper&lt;AccessEvent&gt;&gt; buffer = accessFileBufferFactory.createBuffer(si);</span>
<span class="nc" id="L1543">		EventSource&lt;AccessEvent&gt; eventSource = new EventSourceImpl&lt;AccessEvent&gt;(si, buffer, false);</span>

<span class="nc" id="L1545">		ViewContainer&lt;AccessEvent&gt; container = retrieveAccessViewContainer(eventSource);</span>
<span class="nc" id="L1546">		EventWrapperViewPanel&lt;AccessEvent&gt; panel = container.getDefaultView();</span>
<span class="nc" id="L1547">		panel.setState(LoggingViewState.INACTIVE);</span>
<span class="nc" id="L1548">		showAccessView(eventSource);</span>
<span class="nc" id="L1549">	}</span>

	public void updateStatus()
	{
<span class="nc" id="L1553">		StringBuilder statusText = new StringBuilder();</span>

<span class="nc" id="L1555">		ApplicationPreferences.SourceFiltering filtering = applicationPreferences.getSourceFiltering();</span>
<span class="nc bnc" id="L1556" title="All 3 branches missed.">		switch (filtering)</span>
		{
			case BLACKLIST:
<span class="nc" id="L1559">				statusText.append(&quot;Blacklisting on '&quot;);</span>
<span class="nc" id="L1560">				statusText.append(applicationPreferences.getBlackListName());</span>
<span class="nc" id="L1561">				statusText.append(&quot;'.  &quot;);</span>
<span class="nc" id="L1562">				break;</span>
			case WHITELIST:
<span class="nc" id="L1564">				statusText.append(&quot;Whitelisting on '&quot;);</span>
<span class="nc" id="L1565">				statusText.append(applicationPreferences.getWhiteListName());</span>
<span class="nc" id="L1566">				statusText.append(&quot;'.  &quot;);</span>
				break;
		}

<span class="nc bnc" id="L1570" title="All 2 branches missed.">		if (activeCounter == 0)</span>
		{
<span class="nc" id="L1572">			statusText.append(&quot;No active connections.&quot;);</span>
		}
<span class="nc bnc" id="L1574" title="All 2 branches missed.">		else if (activeCounter == 1)</span>
		{
<span class="nc" id="L1576">			statusText.append(&quot;One active connection.&quot;);</span>
		}
<span class="nc bnc" id="L1578" title="All 2 branches missed.">		else if (activeCounter &gt; 1)</span>
		{
<span class="nc" id="L1580">			statusText.append(activeCounter).append(&quot; active connections.&quot;);</span>
		}
<span class="nc" id="L1582">		statusLabel.setText(statusText.toString());</span>
<span class="nc" id="L1583">	}</span>

<span class="nc" id="L1585">	private long lastScriptRefresh = 0;</span>
<span class="nc" id="L1586">	private long previousScriptFileTimestamp = 0;</span>
	private Script detailsViewScript;
	private static final int SCRIPT_REFRESH_INTERVAL = 5000;

	private void initDetailsViewScript()
	{
<span class="nc" id="L1592">		long current = System.currentTimeMillis();</span>
<span class="nc bnc" id="L1593" title="All 4 branches missed.">		if (detailsViewScript != null &amp;&amp; current - lastScriptRefresh &lt; SCRIPT_REFRESH_INTERVAL)</span>
		{
<span class="nc" id="L1595">			return;</span>
		}

<span class="nc" id="L1598">		lastScriptRefresh = current;</span>

<span class="nc" id="L1600">		File detailsViewRoot = getApplicationPreferences().getDetailsViewRoot();</span>
<span class="nc" id="L1601">		File scriptFile = new File(detailsViewRoot, ApplicationPreferences.DETAILS_VIEW_GROOVY_FILENAME);</span>
<span class="nc" id="L1602">		long scriptFileTimestamp = scriptFile.lastModified();</span>
<span class="nc bnc" id="L1603" title="All 4 branches missed.">		if (detailsViewScript == null || previousScriptFileTimestamp != scriptFileTimestamp)</span>
		{
<span class="nc bnc" id="L1605" title="All 2 branches missed.">			if (!scriptFile.isFile())</span>
			{
<span class="nc bnc" id="L1607" title="All 2 branches missed.">				if (logger.isWarnEnabled()) logger.warn(&quot;Scriptfile '{}' is not a file!&quot;, scriptFile.getAbsolutePath());</span>
			}
<span class="nc" id="L1609">			GroovyClassLoader gcl = new GroovyClassLoader();</span>
<span class="nc" id="L1610">			gcl.setShouldRecompile(true);</span>
			try
			{
<span class="nc" id="L1613">				Class clazz = gcl.parseClass(scriptFile);</span>
<span class="nc" id="L1614">				Object instance = clazz.newInstance();</span>
<span class="nc bnc" id="L1615" title="All 2 branches missed.">				if (instance instanceof Script)</span>
				{
<span class="nc" id="L1617">					detailsViewScript = (Script) instance;</span>
<span class="nc" id="L1618">					previousScriptFileTimestamp = scriptFileTimestamp;</span>
				}
			}
<span class="nc" id="L1621">			catch (Throwable e)</span>
			{
<span class="nc bnc" id="L1623" title="All 2 branches missed.">				if (logger.isWarnEnabled())</span>
				{
<span class="nc" id="L1625">					logger</span>
<span class="nc" id="L1626">							.warn(&quot;Exception while instanciating groovy condition '&quot; + scriptFile</span>
<span class="nc" id="L1627">									.getAbsolutePath() + &quot;'!&quot;, e);</span>
				}
<span class="nc" id="L1629">				detailsViewScript = null;</span>
<span class="nc" id="L1630">			}</span>
		}
<span class="nc" id="L1632">	}</span>


	public String createMessage(EventWrapper wrapper)
	{
<span class="nc" id="L1637">		initDetailsViewScript();</span>
<span class="nc" id="L1638">		String message = &quot;&lt;html&gt;&lt;body&gt;detailsView Script returned null!&lt;/body&gt;&lt;/html&gt;&quot;;</span>
//		if(wrapper!=null)
//		{
		//message=messageFormatter.createMessage(wrapper, true);
<span class="nc bnc" id="L1642" title="All 2 branches missed.">		if (detailsViewScript == null)</span>
		{
<span class="nc" id="L1644">			message = &quot;&lt;html&gt;&lt;body&gt;detailsView Script is broken!&lt;/body&gt;&lt;/html&gt;&quot;;</span>
		}
		else
		{
			try
			{
<span class="nc" id="L1650">				Binding binding = new Binding();</span>
<span class="nc" id="L1651">				binding.setVariable(&quot;eventWrapper&quot;, wrapper);</span>
<span class="nc" id="L1652">				binding.setVariable(&quot;logger&quot;, logger);</span>
<span class="nc" id="L1653">				binding.setVariable(&quot;completeCallStack&quot;, applicationPreferences.isShowingFullCallstack());</span>
<span class="nc" id="L1654">				binding.setVariable(&quot;showStackTrace&quot;, applicationPreferences.isShowingStackTrace());</span>

<span class="nc" id="L1656">				detailsViewScript.setBinding(binding);</span>
<span class="nc" id="L1657">				Object result = detailsViewScript.run();</span>
<span class="nc bnc" id="L1658" title="All 2 branches missed.">				if (result instanceof String)</span>
				{
<span class="nc" id="L1660">					message = (String) result;</span>
				}
<span class="nc bnc" id="L1662" title="All 2 branches missed.">				else if (result != null)</span>
				{
<span class="nc" id="L1664">					message = result.toString();</span>
				}
			}
<span class="nc" id="L1667">			catch (Throwable t)</span>
			{
<span class="nc" id="L1669">				message = &quot;&lt;html&gt;&lt;body&gt;Exception while executing detailsView Script!&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<span class="nc bnc" id="L1670" title="All 2 branches missed.">				if (logger.isWarnEnabled()) logger.warn(&quot;Exception while executing detailsView Script!&quot;, t);</span>
<span class="nc" id="L1671">			}</span>
		}
		//}
<span class="nc bnc" id="L1674" title="All 2 branches missed.">		if (logger.isDebugEnabled()) logger.debug(&quot;Message:\n{}&quot;, message);</span>
		// I'm not sure who is to blame for the following line of code...
		// One could argue that it's a bug in the application logging the event but I think
		// that it shouldn't be possible to cause a problem logging something weird.
		// One could also argue that logback should prevent/fix logging events that contain a zero
		// byte but this would result in a serious performance impact even though the problem is rather rare.
		// On the other hand, zero bytes can cause all kind of weird followup problems, e.g. cut off log files or,
		// as in this case, a malformed XML.
		// The third and last one to blame is the groovy XML builder. It shouldn't be possible to write a malformed
		// XML document using the builder but what would be an acceptable behaviour? Throwing an exception
		// would be a bad idea, imho. It would probably be best to replace the zero byte with a space.
		// This is very acceptable in my special case but I'm not sure if this is a general use case...
		//
		// http://cse-mjmcl.cse.bris.ac.uk/blog/2007/02/14/1171465494443.html
<span class="nc" id="L1688">		message = SimpleXml.replaceNonValidXMLCharacters(message, ' ');</span>
<span class="nc" id="L1689">		return message;</span>
	}

	public SortedMap&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; getSortedLoggingViews()
	{
<span class="nc" id="L1694">		EventSourceComparator&lt;LoggingEvent&gt; loggingComparator = new EventSourceComparator&lt;LoggingEvent&gt;();</span>
		SortedMap&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; sortedLoggingViews;
<span class="nc" id="L1696">		sortedLoggingViews = new TreeMap&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt;(loggingComparator);</span>
<span class="nc" id="L1697">		sortedLoggingViews.putAll(loggingEventViewManager.getViews());</span>
<span class="nc" id="L1698">		return sortedLoggingViews;</span>
	}

	public SortedMap&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; getSortedAccessViews()
	{
<span class="nc" id="L1703">		EventSourceComparator&lt;AccessEvent&gt; accessComparator = new EventSourceComparator&lt;AccessEvent&gt;();</span>
		SortedMap&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; sortedAccessViews;
<span class="nc" id="L1705">		sortedAccessViews = new TreeMap&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt;(accessComparator);</span>
<span class="nc" id="L1706">		sortedAccessViews.putAll(accessEventViewManager.getViews());</span>
<span class="nc" id="L1707">		return sortedAccessViews;</span>
	}

	public void closeAllViews(ViewContainer beside)
	{
		{
			/*List&lt;ViewContainer&lt;LoggingEvent&gt;&gt; closed = */
<span class="nc" id="L1714">			loggingEventViewManager.closeAllViews(beside);</span>
		}

		{
			/*List&lt;ViewContainer&lt;AccessEvent&gt;&gt; closed = */
<span class="nc" id="L1719">			accessEventViewManager.closeAllViews(beside);</span>
		}
<span class="nc" id="L1721">	}</span>

	public void minimizeAllViews(ViewContainer beside)
	{
		{
			/*List&lt;ViewContainer&lt;LoggingEvent&gt;&gt; closed = */
<span class="nc" id="L1727">			loggingEventViewManager.minimizeAllViews(beside);</span>
		}

		{
			/*List&lt;ViewContainer&lt;AccessEvent&gt;&gt; closed = */
<span class="nc" id="L1732">			accessEventViewManager.minimizeAllViews(beside);</span>
		}
<span class="nc" id="L1734">	}</span>

	public void removeInactiveViews(boolean onlyClosed, boolean clean)
	{
		{
<span class="nc" id="L1739">			List&lt;ViewContainer&lt;LoggingEvent&gt;&gt; removed = loggingEventViewManager.removeInactiveViews(onlyClosed);</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">			if (clean)</span>
			{
<span class="nc bnc" id="L1742" title="All 2 branches missed.">				for (ViewContainer current : removed)</span>
				{
<span class="nc" id="L1744">					EventWrapperViewPanel panel = current.getDefaultView();</span>
<span class="nc" id="L1745">					panel.clear();</span>
<span class="nc" id="L1746">				}</span>
			}
		}

		{
<span class="nc" id="L1751">			List&lt;ViewContainer&lt;AccessEvent&gt;&gt; removed = accessEventViewManager.removeInactiveViews(onlyClosed);</span>
<span class="nc bnc" id="L1752" title="All 2 branches missed.">			if (clean)</span>
			{
<span class="nc bnc" id="L1754" title="All 2 branches missed.">				for (ViewContainer current : removed)</span>
				{
<span class="nc" id="L1756">					EventWrapperViewPanel panel = current.getDefaultView();</span>
<span class="nc" id="L1757">					panel.clear();</span>
<span class="nc" id="L1758">				}</span>
			}
		}
<span class="nc" id="L1761">	}</span>

	public void openInactiveLogs()
	{
<span class="nc bnc" id="L1765" title="All 2 branches missed.">		if (logger.isInfoEnabled()) logger.info(&quot;Open inactive log...&quot;);</span>
<span class="nc" id="L1766">		Windows.showWindow(openInactiveLogsDialog, this, true);</span>

<span class="nc" id="L1768">	}</span>

	public void showDebugDialog()
	{
<span class="nc" id="L1772">		Windows.showWindow(debugDialog, MainFrame.this, true);</span>
<span class="nc" id="L1773">	}</span>

	public void showPreferencesDialog()
	{
<span class="nc" id="L1777">		Windows.showWindow(preferencesDialog, MainFrame.this, true);</span>
<span class="nc" id="L1778">	}</span>

	public void showHelp()
	{
<span class="nc bnc" id="L1782" title="All 2 branches missed.">		if (helpUrl != null)</span>
		{
<span class="nc" id="L1784">			helpFrame.setHelpUrl(helpUrl);</span>
		}
<span class="nc" id="L1786">		Windows.showWindow(helpFrame, MainFrame.this, false);</span>
<span class="nc" id="L1787">	}</span>

	public void showAboutDialog()
	{
<span class="nc" id="L1791">		Windows.showWindow(aboutDialog, MainFrame.this, true);</span>

<span class="nc bnc" id="L1793" title="All 4 branches missed.">		if (!applicationPreferences.isMute() &amp;&amp; sounds != null)</span>
		{
			//sounds.play(LilithSounds.ABOUT_SOUND);
		}
<span class="nc" id="L1797">	}</span>

	public void cleanAllInactiveLogs()
	{
<span class="nc" id="L1801">		loggingEventViewManager.removeInactiveViews(false);</span>
<span class="nc" id="L1802">		accessEventViewManager.removeInactiveViews(false);</span>
<span class="nc" id="L1803">		longTaskManager.startTask(new CleanAllInactiveCallable(this), &quot;Clean all inactive...&quot;);</span>
<span class="nc" id="L1804">		updateWindowMenus();</span>
<span class="nc" id="L1805">	}</span>

<span class="nc" id="L1807">	class LoggingEventSourceListener</span>
			implements EventSourceListener&lt;LoggingEvent&gt;
	{
		public void eventSourceAdded(EventSource&lt;LoggingEvent&gt; eventSource)
		{
<span class="nc" id="L1812">			SwingUtilities.invokeLater(new LoggingSourceAddedRunnable(eventSource));</span>
<span class="nc" id="L1813">		}</span>

		public void eventSourceRemoved(EventSource&lt;LoggingEvent&gt; eventSource)
		{
<span class="nc" id="L1817">			SwingUtilities.invokeLater(new LoggingSourceRemovedRunnable(eventSource));</span>
<span class="nc" id="L1818">		}</span>

		private class LoggingSourceAddedRunnable
				implements Runnable
		{
			EventSource&lt;LoggingEvent&gt; eventSource;

			public LoggingSourceAddedRunnable(EventSource&lt;LoggingEvent&gt; eventSource)
<span class="nc" id="L1826">			{</span>
<span class="nc" id="L1827">				this.eventSource = eventSource;</span>
<span class="nc" id="L1828">			}</span>

			public void run()
			{
<span class="nc" id="L1832">				ViewContainer&lt;LoggingEvent&gt; container = retrieveLoggingViewContainer(eventSource);</span>
<span class="nc" id="L1833">				EventWrapperViewPanel&lt;LoggingEvent&gt; panel = container.getDefaultView();</span>
<span class="nc" id="L1834">				panel.setState(LoggingViewState.ACTIVE);</span>
<span class="nc bnc" id="L1835" title="All 4 branches missed.">				if (!applicationPreferences.isMute() &amp;&amp; sounds != null)</span>
				{
<span class="nc" id="L1837">					sounds.play(LilithSounds.SOURCE_ADDED);</span>
				}
<span class="nc" id="L1839">				String primary = eventSource.getSourceIdentifier().getIdentifier();</span>
<span class="nc" id="L1840">				Map&lt;String, String&gt; sourceNames = applicationPreferences.getSourceNames();</span>

<span class="nc bnc" id="L1842" title="All 2 branches missed.">				if (!sourceNames.containsKey(primary))</span>
				{
<span class="nc" id="L1844">					sourceNames = new HashMap&lt;String, String&gt;(sourceNames);</span>
<span class="nc" id="L1845">					sourceNames.put(primary, primary);</span>
<span class="nc" id="L1846">					applicationPreferences.setSourceNames(sourceNames);</span>
				}

<span class="nc bnc" id="L1849" title="All 2 branches missed.">				if (applicationPreferences.isAutoOpening())</span>
				{
<span class="nc" id="L1851">					showLoggingView(eventSource);</span>
				}
<span class="nc" id="L1853">			}</span>
		}

		private class LoggingSourceRemovedRunnable
				implements Runnable
		{
			EventSource&lt;LoggingEvent&gt; eventSource;

			public LoggingSourceRemovedRunnable(EventSource&lt;LoggingEvent&gt; eventSource)
<span class="nc" id="L1862">			{</span>
<span class="nc" id="L1863">				this.eventSource = eventSource;</span>
<span class="nc" id="L1864">			}</span>

			public void run()
			{
<span class="nc" id="L1868">				ViewContainer&lt;LoggingEvent&gt; container = retrieveLoggingViewContainer(eventSource);</span>
<span class="nc" id="L1869">				EventWrapperViewPanel&lt;LoggingEvent&gt; panel = container.getDefaultView();</span>
<span class="nc" id="L1870">				panel.setState(LoggingViewState.INACTIVE);</span>
<span class="nc bnc" id="L1871" title="All 4 branches missed.">				if (!applicationPreferences.isMute() &amp;&amp; sounds != null)</span>
				{
<span class="nc" id="L1873">					sounds.play(LilithSounds.SOURCE_REMOVED);</span>
				}
<span class="nc bnc" id="L1875" title="All 2 branches missed.">				if (applicationPreferences.isAutoClosing())</span>
				{
<span class="nc" id="L1877">					loggingEventViewManager.closeViewContainer(container);</span>
				}
<span class="nc" id="L1879">				loggingEventSourceManager.removeEventProducer(eventSource.getSourceIdentifier());</span>
<span class="nc" id="L1880">				updateWindowMenus();</span>
<span class="nc" id="L1881">			}</span>
		}
	}

<span class="nc" id="L1885">	class AccessEventSourceListener</span>
			implements EventSourceListener&lt;AccessEvent&gt;
	{
		public void eventSourceAdded(EventSource&lt;AccessEvent&gt; eventSource)
		{
<span class="nc" id="L1890">			SwingUtilities.invokeLater(new AccessSourceAddedRunnable(eventSource));</span>
<span class="nc" id="L1891">		}</span>

		public void eventSourceRemoved(EventSource&lt;AccessEvent&gt; eventSource)
		{
<span class="nc" id="L1895">			SwingUtilities.invokeLater(new AccessSourceRemovedRunnable(eventSource));</span>
<span class="nc" id="L1896">		}</span>

		private class AccessSourceAddedRunnable
				implements Runnable
		{
			EventSource&lt;AccessEvent&gt; eventSource;

			public AccessSourceAddedRunnable(EventSource&lt;AccessEvent&gt; eventSource)
<span class="nc" id="L1904">			{</span>
<span class="nc" id="L1905">				this.eventSource = eventSource;</span>
<span class="nc" id="L1906">			}</span>

			public void run()
			{
<span class="nc" id="L1910">				ViewContainer&lt;AccessEvent&gt; container = retrieveAccessViewContainer(eventSource);</span>
<span class="nc" id="L1911">				EventWrapperViewPanel&lt;AccessEvent&gt; panel = container.getDefaultView();</span>
<span class="nc" id="L1912">				panel.setState(LoggingViewState.ACTIVE);</span>
<span class="nc bnc" id="L1913" title="All 4 branches missed.">				if (!applicationPreferences.isMute() &amp;&amp; sounds != null)</span>
				{
<span class="nc" id="L1915">					sounds.play(LilithSounds.SOURCE_ADDED);</span>
				}

<span class="nc" id="L1918">				String primary = eventSource.getSourceIdentifier().getIdentifier();</span>
<span class="nc" id="L1919">				Map&lt;String, String&gt; sourceNames = applicationPreferences.getSourceNames();</span>

<span class="nc bnc" id="L1921" title="All 2 branches missed.">				if (!sourceNames.containsKey(primary))</span>
				{
<span class="nc" id="L1923">					sourceNames = new HashMap&lt;String, String&gt;(sourceNames);</span>
<span class="nc" id="L1924">					sourceNames.put(primary, primary);</span>
<span class="nc" id="L1925">					applicationPreferences.setSourceNames(sourceNames);</span>
				}

<span class="nc bnc" id="L1928" title="All 2 branches missed.">				if (applicationPreferences.isAutoOpening())</span>
				{
<span class="nc" id="L1930">					showAccessView(eventSource);</span>
				}
<span class="nc" id="L1932">			}</span>
		}

		private class AccessSourceRemovedRunnable
				implements Runnable
		{
			EventSource&lt;AccessEvent&gt; eventSource;

			public AccessSourceRemovedRunnable(EventSource&lt;AccessEvent&gt; eventSource)
<span class="nc" id="L1941">			{</span>
<span class="nc" id="L1942">				this.eventSource = eventSource;</span>
<span class="nc" id="L1943">			}</span>

			public void run()
			{
<span class="nc" id="L1947">				ViewContainer&lt;AccessEvent&gt; container = retrieveAccessViewContainer(eventSource);</span>
<span class="nc" id="L1948">				EventWrapperViewPanel&lt;AccessEvent&gt; panel = container.getDefaultView();</span>
<span class="nc" id="L1949">				panel.setState(LoggingViewState.INACTIVE);</span>
<span class="nc bnc" id="L1950" title="All 4 branches missed.">				if (!applicationPreferences.isMute() &amp;&amp; sounds != null)</span>
				{
<span class="nc" id="L1952">					sounds.play(LilithSounds.SOURCE_REMOVED);</span>
				}
<span class="nc bnc" id="L1954" title="All 2 branches missed.">				if (applicationPreferences.isAutoClosing())</span>
				{
<span class="nc" id="L1956">					accessEventViewManager.closeViewContainer(container);</span>
				}
<span class="nc" id="L1958">				accessEventSourceManager.removeEventProducer(eventSource.getSourceIdentifier());</span>
<span class="nc" id="L1959">				updateWindowMenus();</span>
<span class="nc" id="L1960">			}</span>
		}
	}

	public String getPrimarySourceTitle(String primary)
	{
<span class="nc bnc" id="L1966" title="All 2 branches missed.">		if (primary == null)</span>
		{
<span class="nc" id="L1968">			return null;</span>
		}
<span class="nc" id="L1970">		Map&lt;String, String&gt; sourceNames = applicationPreferences.getSourceNames();</span>
<span class="nc" id="L1971">		String resolvedName = sourceNames.get(primary);</span>
<span class="nc bnc" id="L1972" title="All 4 branches missed.">		if (resolvedName != null &amp;&amp; !resolvedName.equals(primary))</span>
		{
<span class="nc bnc" id="L1974" title="All 2 branches missed.">			if (applicationPreferences.isShowingIdentifier())</span>
			{
<span class="nc" id="L1976">				return resolvedName + &quot; [&quot; + primary + &quot;]&quot;;</span>
			}
			else
			{
<span class="nc" id="L1980">				return resolvedName;</span>
			}
		}
<span class="nc" id="L1983">		return primary;</span>
	}

	public String getPrimarySourceTitle(SourceIdentifier identifier)
	{
<span class="nc" id="L1988">		return getPrimarySourceTitle(identifier.getIdentifier());</span>
	}

	public String getSourceTitle(SourceIdentifier identifier)
	{
<span class="nc" id="L1993">		String primary = getPrimarySourceTitle(identifier);</span>
<span class="nc" id="L1994">		String secondary = identifier.getSecondaryIdentifier();</span>
<span class="nc bnc" id="L1995" title="All 2 branches missed.">		if (secondary == null)</span>
		{
<span class="nc" id="L1997">			return primary;</span>
		}
<span class="nc" id="L1999">		return primary + &quot; - &quot; + secondary;</span>
	}

	public String getLoggingSourceTitle(SourceIdentifier identifier)
	{
<span class="nc" id="L2004">		return getSourceTitle(identifier) + &quot; (Logging)&quot;;</span>
	}

	public String getAccessSourceTitle(SourceIdentifier identifier)
	{
<span class="nc" id="L2009">		return getSourceTitle(identifier) + &quot; (Access)&quot;;</span>
	}

	String resolveSourceTitle(ViewContainer container)
	{
<span class="nc" id="L2014">		EventSource eventSource = container.getDefaultView().getEventSource();</span>
<span class="nc" id="L2015">		SourceIdentifier si = eventSource.getSourceIdentifier();</span>

<span class="nc" id="L2017">		Class clazz = container.getWrappedClass();</span>
		String title;
<span class="nc bnc" id="L2019" title="All 2 branches missed.">		if (clazz == LoggingEvent.class)</span>
		{
<span class="nc" id="L2021">			title = getLoggingSourceTitle(si);</span>
		}
		else
		{
<span class="nc" id="L2025">			title = getAccessSourceTitle(si);</span>
		}
<span class="nc" id="L2027">		return title;</span>
	}

	public void openUrl(URL url)
	{
<span class="nc bnc" id="L2032" title="All 2 branches missed.">		if (logger.isInfoEnabled()) logger.info(&quot;Opening URL {}. &quot;, url);</span>
<span class="nc" id="L2033">		Runtime runtime = Runtime.getRuntime();</span>
<span class="nc" id="L2034">		String[] cmdArray = getOpenUrlCommandArray(url);</span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">		if (cmdArray != null)</span>
		{
			try
			{
<span class="nc" id="L2039">				Process process = runtime.exec(cmdArray);</span>
<span class="nc" id="L2040">				ProcessConsumerRunnable consumer = new ProcessConsumerRunnable(process);</span>
<span class="nc" id="L2041">				Thread t = new Thread(consumer, &quot;Open URL: &quot; + url);</span>
<span class="nc" id="L2042">				t.setDaemon(true);</span>
<span class="nc" id="L2043">				t.start();</span>
			}
<span class="nc" id="L2045">			catch (IOException e)</span>
			{
<span class="nc bnc" id="L2047" title="All 2 branches missed.">				if (logger.isWarnEnabled()) logger.warn(&quot;Exception while trying to open URL &quot; + url + &quot;!&quot;, e);</span>
<span class="nc" id="L2048">			}</span>
		}
		else
		{
<span class="nc bnc" id="L2052" title="All 2 branches missed.">			if (logger.isInfoEnabled())</span>
			{
<span class="nc" id="L2054">				logger.info(&quot;Can't open url {} because no command is defined for the current system.&quot;, url);</span>
			}
		}
<span class="nc" id="L2057">	}</span>

	// Windows: cmd /C start http://www.heise.de
	// Mac: open http://www.heise.de

<span class="nc" id="L2062">	private static final String[] MAC_OPEN_URL_ARRAY =</span>
			{
					&quot;open&quot;,
					null
			};

<span class="nc" id="L2068">	private static final String[] WINDOWS_OPEN_URL_ARRAY =</span>
			{
					&quot;cmd&quot;,
					&quot;/C&quot;,
					&quot;start&quot;,
					null
			};

	private String[] getOpenUrlCommandArray(URL url)
	{
<span class="nc" id="L2078">		String[] result = null;</span>
<span class="nc bnc" id="L2079" title="All 2 branches missed.">		if (isWindows)</span>
		{
<span class="nc" id="L2081">			result = new String[WINDOWS_OPEN_URL_ARRAY.length];</span>
<span class="nc" id="L2082">			System.arraycopy(WINDOWS_OPEN_URL_ARRAY, 0, result, 0, WINDOWS_OPEN_URL_ARRAY.length);</span>
		}
<span class="nc bnc" id="L2084" title="All 2 branches missed.">		else if (isMac)</span>
		{
<span class="nc" id="L2086">			result = new String[MAC_OPEN_URL_ARRAY.length];</span>
<span class="nc" id="L2087">			System.arraycopy(MAC_OPEN_URL_ARRAY, 0, result, 0, MAC_OPEN_URL_ARRAY.length);</span>
		}

<span class="nc bnc" id="L2090" title="All 2 branches missed.">		if (result != null)</span>
		{
<span class="nc" id="L2092">			String urlStr = url.toString();</span>
<span class="nc bnc" id="L2093" title="All 2 branches missed.">			for (int i = 0; i &lt; result.length; i++)</span>
			{
<span class="nc bnc" id="L2095" title="All 2 branches missed.">				if (result[i] == null)</span>
				{
<span class="nc" id="L2097">					result[i] = urlStr;</span>
				}
			}
		}
<span class="nc" id="L2101">		return result;</span>
	}

	void showFrame(ViewContainer container)
	{
<span class="nc" id="L2106">		String title = resolveSourceTitle(container);</span>
<span class="nc" id="L2107">		ViewContainerFrame frame = new ViewContainerFrame(this, container);</span>
<span class="nc" id="L2108">		frame.setTitle(title);</span>
<span class="nc" id="L2109">		frame.setSize(800, 600);</span>

<span class="nc" id="L2111">		Windows.showWindow(frame, null, false);</span>
<span class="nc" id="L2112">		executeScrollToBottom(frame);</span>
<span class="nc" id="L2113">	}</span>

	void showInternalFrame(ViewContainer container)
	{
<span class="nc" id="L2117">		String title = resolveSourceTitle(container);</span>
<span class="nc" id="L2118">		ViewContainerInternalFrame frame = new ViewContainerInternalFrame(this, container);</span>
<span class="nc" id="L2119">		frame.setTitle(title);</span>

<span class="nc" id="L2121">		int count = desktop.getComponentCount();</span>
<span class="nc" id="L2122">		final int titleBarHeight = resolveInternalTitlebarHeight(/*frame*/);</span>
<span class="nc" id="L2123">		frame.setBounds(titleBarHeight * (count % 10), titleBarHeight * (count % 10), 640, 480);</span>

<span class="nc" id="L2125">		desktop.add(frame);</span>

<span class="nc" id="L2127">		frame.setVisible(true);</span>
<span class="nc" id="L2128">		executeScrollToBottom(frame);</span>
<span class="nc" id="L2129">	}</span>

	public void showTaskManager()
	{
		// don't add twice
<span class="nc bnc" id="L2134" title="All 2 branches missed.">		if (taskManagerFrame.isClosed())</span>
		{
<span class="nc" id="L2136">			desktop.add(taskManagerFrame);</span>
<span class="nc" id="L2137">			desktop.validate();</span>
		}
<span class="nc bnc" id="L2139" title="All 2 branches missed.">		if (taskManagerFrame.isIcon())</span>
		{
			try
			{
<span class="nc" id="L2143">				taskManagerFrame.setIcon(false);</span>
			}
<span class="nc" id="L2145">			catch (PropertyVetoException e)</span>
			{
				// ignore
<span class="nc" id="L2148">			}</span>
		}
<span class="nc bnc" id="L2150" title="All 2 branches missed.">		if (!taskManagerFrame.isVisible())</span>
		{
<span class="nc" id="L2152">			taskManagerFrame.setVisible(true);</span>
		}
<span class="nc" id="L2154">		taskManagerFrame.moveToFront();</span>
		try
		{
<span class="nc" id="L2157">			taskManagerFrame.setSelected(true);</span>
		}
<span class="nc" id="L2159">		catch (PropertyVetoException e)</span>
		{
			// ignore
<span class="nc" id="L2162">		}</span>
<span class="nc" id="L2163">	}</span>

	/**
	 * Initial scroll to bottom must be executed slightly after making it visible so
	 * it's using invokeLater, now.
	 *
	 * @param window the window that should scrollt to bottom is configured that way.
	 */
	private void executeScrollToBottom(ViewWindow window)
	{
<span class="nc bnc" id="L2173" title="All 2 branches missed.">		if (window != null)</span>
		{
<span class="nc" id="L2175">			ScrollToBottomRunnable runnable = new ScrollToBottomRunnable(window);</span>
<span class="nc" id="L2176">			SwingUtilities.invokeLater(runnable);</span>
		}
<span class="nc" id="L2178">	}</span>

	private static class ScrollToBottomRunnable
			implements Runnable
	{
		private ViewWindow window;

		private ScrollToBottomRunnable(ViewWindow window)
<span class="nc" id="L2186">		{</span>
<span class="nc" id="L2187">			this.window = window;</span>
<span class="nc" id="L2188">		}</span>

		public void run()
		{
<span class="nc" id="L2192">			ViewContainer viewContainer = window.getViewContainer();</span>
<span class="nc bnc" id="L2193" title="All 2 branches missed.">			if (viewContainer != null)</span>
			{
<span class="nc" id="L2195">				viewContainer.scrollToEvent();</span>
			}
<span class="nc" id="L2197">		}</span>
	}

	/**
	 * This is only a heuristic and probably won't be correct for non-metal l&amp;f...
	 *
	 * @return the height of the internal frames titlebar...
	 */
	private int resolveInternalTitlebarHeight(/*JInternalFrame frame*/)
	{
<span class="nc" id="L2207">		int result = 24;</span>
		/*
		InternalFrameUI ui = frame.getUI();
		if(ui instanceof BasicInternalFrameUI)
		{
			BasicInternalFrameUI bui=(BasicInternalFrameUI) ui;
			result=bui.getNorthPane().getPreferredSize().height;
			if(logger.isDebugEnabled()) logger.debug(&quot;Resolved height of titlebar: {}&quot;, result);
		}
        */
<span class="nc bnc" id="L2217" title="All 2 branches missed.">		if (logger.isDebugEnabled()) logger.debug(&quot;Height of titlebar: {}&quot;, result);</span>
<span class="nc" id="L2218">		return result;</span>
	}

	private void showApplicationPathChangedDialog()
	{
<span class="nc bnc" id="L2223" title="All 2 branches missed.">		if (logger.isInfoEnabled()) logger.info(&quot;showApplicationPathChangedDialog()&quot;);</span>
<span class="nc" id="L2224">		final Object[] options = {&quot;Exit&quot;, &quot;Cancel&quot;};</span>
<span class="nc" id="L2225">		Icon icon = null;</span>
		{
<span class="nc" id="L2227">			URL url = MainFrame.class.getResource(&quot;/tango/32x32/status/dialog-warning.png&quot;);</span>
<span class="nc bnc" id="L2228" title="All 2 branches missed.">			if (url != null)</span>
			{
<span class="nc" id="L2230">				icon = new ImageIcon(url);</span>
			}
		}
<span class="nc" id="L2233">		int result = JOptionPane.showOptionDialog(this,</span>
				&quot;You have changed the application path.\n&quot; +
						&quot;You need to restart for this change to take effect.\n\n&quot; +
						&quot;Exit now?&quot;,
				&quot;Exit now?&quot;,
				JOptionPane.DEFAULT_OPTION,
				JOptionPane.WARNING_MESSAGE,
				icon,
				options,
				options[0]);
<span class="nc bnc" id="L2243" title="All 2 branches missed.">		if (result == 0)</span>
		{
<span class="nc" id="L2245">			exit();</span>
		}
<span class="nc" id="L2247">	}</span>

	private void showLookAndFeelChangedDialog()
	{
<span class="nc bnc" id="L2251" title="All 2 branches missed.">		if (logger.isInfoEnabled()) logger.info(&quot;showLookAndFeelChangedDialog()&quot;);</span>
<span class="nc" id="L2252">		final Object[] options = {&quot;Exit&quot;, &quot;Cancel&quot;};</span>
<span class="nc" id="L2253">		Icon icon = null;</span>
		{
<span class="nc" id="L2255">			URL url = MainFrame.class.getResource(&quot;/tango/32x32/status/dialog-warning.png&quot;);</span>
<span class="nc bnc" id="L2256" title="All 2 branches missed.">			if (url != null)</span>
			{
<span class="nc" id="L2258">				icon = new ImageIcon(url);</span>
			}
		}
<span class="nc" id="L2261">		int result = JOptionPane.showOptionDialog(this,</span>
				&quot;You have changed the look &amp; feel.\n&quot; +
						&quot;You need to restart for this change to take effect.\n\n&quot; +
						&quot;Exit now?&quot;,
				&quot;Exit now?&quot;,
				JOptionPane.DEFAULT_OPTION,
				JOptionPane.WARNING_MESSAGE,
				icon,
				options,
				options[0]);
<span class="nc bnc" id="L2271" title="All 2 branches missed.">		if (result == 0)</span>
		{
<span class="nc" id="L2273">			exit();</span>
		}
<span class="nc" id="L2275">	}</span>

	public void exit()
	{
<span class="nc bnc" id="L2279" title="All 2 branches missed.">		if (applicationPreferences.isAskingBeforeQuit())</span>
		{
			// yes, I hate apps that ask this question...
<span class="nc" id="L2282">			String dialogTitle = &quot;Exit now?&quot;;</span>
<span class="nc" id="L2283">			String message = &quot;Are you really 100% sure that you want to quit?\nPlease do yourself a favour and think about it before you answer...\nExit now?&quot;;</span>
<span class="nc" id="L2284">			int result = JOptionPane.showConfirmDialog(this, message, dialogTitle,</span>
					JOptionPane.OK_CANCEL_OPTION, JOptionPane.QUESTION_MESSAGE);
<span class="nc bnc" id="L2286" title="All 2 branches missed.">			if (JOptionPane.OK_OPTION != result)</span>
			{
<span class="nc" id="L2288">				return;</span>
			}
		}
<span class="nc bnc" id="L2291" title="All 2 branches missed.">		if (logger.isInfoEnabled()) logger.info(&quot;Exiting...&quot;);</span>
		// this probably isn't necessary since jmdns registers a shutdown hook.
<span class="nc bnc" id="L2293" title="All 2 branches missed.">		if (senderService != null)</span>
		{
<span class="nc" id="L2295">			senderService.stop();</span>
//			if(logger.isInfoEnabled()) logger.info(&quot;Unregistering services...&quot;);
//			// this can't be done in the shutdown hook...
//			jmDns.unregisterAllServices();
		}
<span class="nc bnc" id="L2300" title="All 2 branches missed.">		if (applicationPreferences.isCleaningLogsOnExit())</span>
		{
<span class="nc" id="L2302">			deleteInactiveLogs();</span>
		}
<span class="nc" id="L2304">		applicationPreferences.setPreviousImportPath(importFileChooser.getCurrentDirectory());</span>
<span class="nc" id="L2305">		applicationPreferences.setPreviousOpenPath(openFileChooser.getCurrentDirectory());</span>
<span class="nc" id="L2306">		applicationPreferences.flush();</span>
<span class="nc" id="L2307">		longTaskManager.shutDown();</span>
<span class="nc" id="L2308">		System.exit(0);</span>
<span class="nc" id="L2309">	}</span>

	class ShowViewRunnable
			implements Runnable
	{
		private ViewContainer&lt;?&gt; container;

		public ShowViewRunnable(ViewContainer&lt;?&gt; container)
<span class="nc" id="L2317">		{</span>
<span class="nc" id="L2318">			this.container = container;</span>
<span class="nc" id="L2319">		}</span>

		public void run()
		{
<span class="nc" id="L2323">			boolean isNew = false;</span>
<span class="nc" id="L2324">			boolean isInternal = false;</span>
<span class="nc bnc" id="L2325" title="All 2 branches missed.">			if (container.getParent() == null)</span>
			{
<span class="nc" id="L2327">				isNew = true;</span>
<span class="nc bnc" id="L2328" title="All 2 branches missed.">				if (!applicationPreferences.isUsingInternalFrames())</span>
				{
<span class="nc" id="L2330">					showFrame(container);</span>
				}
				else
				{
<span class="nc" id="L2334">					showInternalFrame(container);</span>
				}
			}
<span class="nc" id="L2337">			updateWindowMenus();</span>
<span class="nc" id="L2338">			ViewWindow window = container.resolveViewWindow();</span>
<span class="nc bnc" id="L2339" title="All 2 branches missed.">			if (window instanceof ViewContainerInternalFrame)</span>
			{
<span class="nc" id="L2341">				isInternal = true;</span>
			}

<span class="nc bnc" id="L2344" title="All 2 branches missed.">			if (isNew)</span>
			{
<span class="nc bnc" id="L2346" title="All 2 branches missed.">				if (applicationPreferences.isAutoFocusingWindow())</span>
				{
<span class="nc" id="L2348">					window.focusWindow();</span>
<span class="nc bnc" id="L2349" title="All 2 branches missed.">					if (isInternal)</span>
					{
						// move mainframe to front.
<span class="nc bnc" id="L2352" title="All 2 branches missed.">						if ((getState() &amp; Frame.ICONIFIED) != 0)</span>
						{
<span class="nc" id="L2354">							setState(Frame.NORMAL);</span>
						}
<span class="nc" id="L2356">						toFront();</span>
					}
				}
			}
			else
			{
				// reselected existing views should *always* be focused!
<span class="nc" id="L2363">				window.focusWindow();</span>
<span class="nc bnc" id="L2364" title="All 2 branches missed.">				if (isInternal)</span>
				{
					// move mainframe to front.
<span class="nc" id="L2367">					toFront();</span>
				}
			}
<span class="nc" id="L2370">		}</span>
	}


<span class="nc" id="L2374">	private class PreferencesChangeListener</span>
			implements PropertyChangeListener
	{

		@SuppressWarnings({&quot;unchecked&quot;})
		public void propertyChange(PropertyChangeEvent evt)
		{
<span class="nc" id="L2381">			String propName = evt.getPropertyName();</span>

<span class="nc bnc" id="L2383" title="All 2 branches missed.">			if (ApplicationPreferences.SOUND_LOCATIONS_PROPERTY.equals(propName))</span>
			{
<span class="nc bnc" id="L2385" title="All 2 branches missed.">				if (sounds != null)</span>
				{
<span class="nc" id="L2387">					sounds.setSoundLocations((Map&lt;String, String&gt;) evt.getNewValue());</span>
				}
<span class="nc" id="L2389">				return;</span>
			}

<span class="nc bnc" id="L2392" title="All 2 branches missed.">			if (ApplicationPreferences.SOURCE_NAMES_PROPERTY.equals(propName)</span>
<span class="nc bnc" id="L2393" title="All 2 branches missed.">					|| ApplicationPreferences.SHOWING_IDENTIFIER_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2395">				updateSourceTitles();</span>
<span class="nc" id="L2396">				return;</span>
			}

<span class="nc bnc" id="L2399" title="All 2 branches missed.">			if (ApplicationPreferences.SOURCE_FILTERING_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2401">				updateStatus();</span>
<span class="nc" id="L2402">				return;</span>
			}

<span class="nc bnc" id="L2405" title="All 2 branches missed.">			if (ApplicationPreferences.MUTE_PROPERTY.equals(propName))</span>
			{
<span class="nc bnc" id="L2407" title="All 2 branches missed.">				if (sounds != null)</span>
				{
<span class="nc" id="L2409">					sounds.setMute((Boolean) evt.getNewValue());</span>
				}
<span class="nc" id="L2411">				return;</span>
			}

<span class="nc bnc" id="L2414" title="All 2 branches missed.">			if (ApplicationPreferences.APPLICATION_PATH_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2416">				File newPath = (File) evt.getNewValue();</span>
<span class="nc" id="L2417">				File oldPath = applicationPreferences.getStartupApplicationPath();</span>
<span class="nc bnc" id="L2418" title="All 2 branches missed.">				if (oldPath != null)</span>
				{
<span class="nc" id="L2420">					File previousApplicationPathFile = new File(newPath, ApplicationPreferences.PREVIOUS_APPLICATION_PATH_FILENAME);</span>
<span class="nc" id="L2421">					FileWriter writer = null;</span>
					try
					{
<span class="nc" id="L2424">						writer = new FileWriter(previousApplicationPathFile);</span>
<span class="nc" id="L2425">						writer.append(oldPath.getAbsolutePath());</span>
					}
<span class="nc" id="L2427">					catch (IOException ex)</span>
					{
<span class="nc bnc" id="L2429" title="All 2 branches missed.">						if (logger.isWarnEnabled())</span>
						{
<span class="nc" id="L2431">							logger</span>
<span class="nc" id="L2432">									.warn(&quot;Exception while writing previous application path to file '&quot; + previousApplicationPathFile</span>
<span class="nc" id="L2433">											.getAbsolutePath() + &quot;'!&quot;, ex);</span>
						}
					}
					finally
					{
<span class="nc" id="L2438">						IOUtils.closeQuietly(writer);</span>
					}
				}
<span class="nc" id="L2441">				showApplicationPathChangedDialog();</span>
<span class="nc" id="L2442">				return;</span>
			}

<span class="nc bnc" id="L2445" title="All 2 branches missed.">			if (ApplicationPreferences.LOOK_AND_FEEL_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2447">				showLookAndFeelChangedDialog();</span>
<span class="nc" id="L2448">				return;</span>
			}

<span class="nc bnc" id="L2451" title="All 2 branches missed.">			if (ApplicationPreferences.CONDITIONS_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2453">				updateConditions();</span>
<span class="nc" id="L2454">				return;</span>
			}

<span class="nc bnc" id="L2457" title="All 2 branches missed.">			if (ApplicationPreferences.LEVEL_COLORS_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2459">				levelColors = null;</span>
<span class="nc" id="L2460">				updateLoggingViews();</span>
<span class="nc" id="L2461">				return;</span>
			}

<span class="nc bnc" id="L2464" title="All 2 branches missed.">			if (ApplicationPreferences.STATUS_COLORS_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2466">				statusColors = null;</span>
<span class="nc" id="L2467">				updateAccessViews();</span>
<span class="nc" id="L2468">				return;</span>
			}

<span class="nc bnc" id="L2471" title="All 2 branches missed.">			if (ApplicationPreferences.SHOWING_FULL_CALLSTACK_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2473">				updateLoggingViews();</span>
<span class="nc" id="L2474">				return;</span>
			}

<span class="nc bnc" id="L2477" title="All 2 branches missed.">			if (ApplicationPreferences.SHOWING_STACKTRACE_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2479">				updateLoggingViews();</span>
				//return;
			}

<span class="nc bnc" id="L2483" title="All 2 branches missed.">			if (ApplicationPreferences.COLORING_WHOLE_ROW_PROPERTY.equals(propName))</span>
			{
<span class="nc" id="L2485">				coloringWholeRow = applicationPreferences.isColoringWholeRow();</span>
<span class="nc" id="L2486">				updateLoggingViews();</span>
				//return;
			}
<span class="nc" id="L2489">		}</span>

		private void updateSourceTitles()
		{
<span class="nc" id="L2493">			updateWindowMenus();</span>
<span class="nc" id="L2494">			Map&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; loggingViews = loggingEventViewManager</span>
<span class="nc" id="L2495">					.getViews();</span>
<span class="nc bnc" id="L2496" title="All 2 branches missed.">			for (Map.Entry&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; current : loggingViews.entrySet())</span>
			{
<span class="nc" id="L2498">				ViewContainer&lt;LoggingEvent&gt; value = current.getValue();</span>
<span class="nc" id="L2499">				ViewWindow window = value.resolveViewWindow();</span>
<span class="nc bnc" id="L2500" title="All 2 branches missed.">				if (window != null)</span>
				{
<span class="nc" id="L2502">					String title = resolveSourceTitle(value);</span>
<span class="nc" id="L2503">					window.setTitle(title);</span>
				}
<span class="nc" id="L2505">			}</span>
<span class="nc" id="L2506">			Map&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; accessViews = accessEventViewManager.getViews();</span>
<span class="nc bnc" id="L2507" title="All 2 branches missed.">			for (Map.Entry&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; current : accessViews.entrySet())</span>
			{
<span class="nc" id="L2509">				ViewContainer&lt;AccessEvent&gt; value = current.getValue();</span>
<span class="nc" id="L2510">				ViewWindow window = value.resolveViewWindow();</span>
<span class="nc bnc" id="L2511" title="All 2 branches missed.">				if (window != null)</span>
				{
<span class="nc" id="L2513">					String title = resolveSourceTitle(value);</span>
<span class="nc" id="L2514">					window.setTitle(title);</span>
				}
<span class="nc" id="L2516">			}</span>
<span class="nc" id="L2517">		}</span>
	}

	private void updateConditions()
	{
<span class="nc" id="L2522">		List&lt;SavedCondition&gt; conditions = applicationPreferences.getConditions();</span>
<span class="nc" id="L2523">		List&lt;SavedCondition&gt; active = new ArrayList&lt;SavedCondition&gt;();</span>
<span class="nc bnc" id="L2524" title="All 2 branches missed.">		if (conditions != null)</span>
		{
<span class="nc bnc" id="L2526" title="All 2 branches missed.">			for (SavedCondition current : conditions)</span>
			{
<span class="nc bnc" id="L2528" title="All 2 branches missed.">				if (current.isActive())</span>
				{
<span class="nc" id="L2530">					active.add(current);</span>
				}
<span class="nc" id="L2532">			}</span>
		}
<span class="nc" id="L2534">		activeConditions = active;</span>
		//flushCachedConditionResults();

<span class="nc" id="L2537">		updateAllViews();</span>
<span class="nc" id="L2538">	}</span>

	private void updateLoggingViews()
	{
<span class="nc" id="L2542">		Map&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; loggingViews = loggingEventViewManager.getViews();</span>
<span class="nc bnc" id="L2543" title="All 2 branches missed.">		for (Map.Entry&lt;EventSource&lt;LoggingEvent&gt;, ViewContainer&lt;LoggingEvent&gt;&gt; current : loggingViews.entrySet())</span>
		{
<span class="nc" id="L2545">			ViewContainer&lt;LoggingEvent&gt; value = current.getValue();</span>
<span class="nc" id="L2546">			value.updateViews();</span>
<span class="nc" id="L2547">		}</span>
<span class="nc" id="L2548">	}</span>

	private void updateAccessViews()
	{
<span class="nc" id="L2552">		Map&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; accessViews = accessEventViewManager.getViews();</span>
<span class="nc bnc" id="L2553" title="All 2 branches missed.">		for (Map.Entry&lt;EventSource&lt;AccessEvent&gt;, ViewContainer&lt;AccessEvent&gt;&gt; current : accessViews.entrySet())</span>
		{
<span class="nc" id="L2555">			ViewContainer&lt;AccessEvent&gt; value = current.getValue();</span>
<span class="nc" id="L2556">			value.updateViews();</span>
<span class="nc" id="L2557">		}</span>
<span class="nc" id="L2558">	}</span>

	private void updateAllViews()
	{
<span class="nc" id="L2562">		updateLoggingViews();</span>
<span class="nc" id="L2563">		updateAccessViews();</span>
<span class="nc" id="L2564">	}</span>

	/*
	 private void flushCachedConditionResults()
	 {
		 colorsCache.clear();
	 }
 */
	public void cleanObsoleteFiles()
	{
<span class="nc" id="L2574">		File obsoleteDir = new File(startupApplicationPath, &quot;sources&quot;);</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">		if (obsoleteDir.isDirectory())</span>
		{
<span class="nc" id="L2577">			longTaskManager</span>
<span class="nc" id="L2578">					.startTask(new CleanObsoleteCallable(obsoleteDir), &quot;Clean obsolete files&quot;, &quot;Deletes the directory '&quot; + obsoleteDir</span>
<span class="nc" id="L2579">							.getAbsolutePath() + &quot;' recursively.&quot;);</span>
		}
<span class="nc" id="L2581">	}</span>

	public void deleteInactiveLogs()
	{
<span class="nc" id="L2585">		deleteInactiveLogs(loggingFileFactory);</span>
<span class="nc" id="L2586">		deleteInactiveLogs(accessFileFactory);</span>
<span class="nc" id="L2587">	}</span>

	protected void deleteInactiveLogs(LogFileFactory fileFactory)
	{
<span class="nc" id="L2591">		List&lt;SourceIdentifier&gt; inactives = collectInactiveLogs(fileFactory);</span>
<span class="nc bnc" id="L2592" title="All 2 branches missed.">		for (SourceIdentifier si : inactives)</span>
		{
<span class="nc" id="L2594">			File dataFile = fileFactory.getDataFile(si);</span>
<span class="nc" id="L2595">			File indexFile = fileFactory.getIndexFile(si);</span>
<span class="nc bnc" id="L2596" title="All 2 branches missed.">			if (dataFile.delete())</span>
			{
<span class="nc bnc" id="L2598" title="All 2 branches missed.">				if (logger.isInfoEnabled()) logger.info(&quot;Deleted {}&quot;, dataFile);</span>
			}
<span class="nc bnc" id="L2600" title="All 2 branches missed.">			if (indexFile.delete())</span>
			{
<span class="nc bnc" id="L2602" title="All 2 branches missed.">				if (logger.isInfoEnabled()) logger.info(&quot;Deleted {}&quot;, indexFile);</span>
			}
<span class="nc" id="L2604">		}</span>
<span class="nc" id="L2605">	}</span>

	public List&lt;SourceIdentifier&gt; collectInactiveLogs(LogFileFactory fileFactory)
	{
<span class="nc" id="L2609">		List&lt;SourceIdentifier&gt; result = new ArrayList&lt;SourceIdentifier&gt;();</span>
<span class="nc" id="L2610">		File logsRoot = fileFactory.getBaseDir();</span>
<span class="nc" id="L2611">		File[] sources = logsRoot.listFiles(new DirectoryFilter());</span>
<span class="nc bnc" id="L2612" title="All 2 branches missed.">		if (sources != null)</span>
		{
<span class="nc bnc" id="L2614" title="All 2 branches missed.">			for (File f : sources)</span>
			{
<span class="nc" id="L2616">				collectInactiveLogs(fileFactory, f, result);</span>
			}
<span class="nc bnc" id="L2618" title="All 2 branches missed.">			if (logger.isDebugEnabled()) logger.debug(&quot;Inactive logs: {}&quot;, result);</span>
		}
<span class="nc" id="L2620">		return result;</span>
	}

	private void collectInactiveLogs(LogFileFactory fileFactory, File sourceDir, List&lt;SourceIdentifier&gt; inactiveLogs)
	{
<span class="nc" id="L2625">		String primary = sourceDir.getName();</span>

<span class="nc" id="L2627">		File[] logs = sourceDir.listFiles(new LogFileFilter(fileFactory));</span>
<span class="nc" id="L2628">		String extension = fileFactory.getDataFileExtension();</span>
<span class="nc bnc" id="L2629" title="All 2 branches missed.">		for (File f : logs)</span>
		{
<span class="nc" id="L2631">			String abs = f.getAbsolutePath();</span>
<span class="nc" id="L2632">			abs = abs.substring(0, abs.length() - extension.length());</span>
<span class="nc" id="L2633">			File active = new File(abs + FileConstants.ACTIVE_FILE_EXTENSION);</span>
<span class="nc bnc" id="L2634" title="All 2 branches missed.">			if (!active.isFile())</span>
			{
<span class="nc" id="L2636">				String secondary = f.getName();</span>
<span class="nc" id="L2637">				secondary = secondary.substring(0, secondary.length() - extension.length());</span>
<span class="nc" id="L2638">				inactiveLogs.add(new SourceIdentifier(primary, secondary));</span>
			}
		}
<span class="nc" id="L2641">	}</span>

	public void copyText(String text)
	{
<span class="nc" id="L2645">		Clipboard systemClipboard = Toolkit.getDefaultToolkit().getSystemClipboard();</span>
<span class="nc" id="L2646">		Transferable transferableText = new StringSelection(text);</span>
<span class="nc" id="L2647">		systemClipboard.setContents(transferableText, null);</span>
<span class="nc" id="L2648">	}</span>

<span class="nc" id="L2650">	public class EventSourceComparator&lt;T extends Serializable&gt;</span>
			implements Comparator&lt;EventSource&lt;T&gt;&gt;
	{
		public int compare(EventSource&lt;T&gt; o1, EventSource&lt;T&gt; o2)
		{
<span class="nc bnc" id="L2655" title="All 2 branches missed.">			if (o1 == o2)</span>
			{
<span class="nc" id="L2657">				return 0;</span>
			}
<span class="nc bnc" id="L2659" title="All 2 branches missed.">			if (o1 == null)</span>
			{
<span class="nc" id="L2661">				return -1;</span>
			}
<span class="nc bnc" id="L2663" title="All 2 branches missed.">			if (o2 == null)</span>
			{
<span class="nc" id="L2665">				return 1;</span>
			}
<span class="nc" id="L2667">			SourceIdentifier si1 = o1.getSourceIdentifier();</span>
<span class="nc" id="L2668">			SourceIdentifier si2 = o2.getSourceIdentifier();</span>
<span class="nc bnc" id="L2669" title="All 2 branches missed.">			if (si1 == si2)</span>
			{
<span class="nc" id="L2671">				return 0;</span>
			}
<span class="nc bnc" id="L2673" title="All 2 branches missed.">			if (si1 == null)</span>
			{
<span class="nc" id="L2675">				return -1;</span>
			}
<span class="nc bnc" id="L2677" title="All 2 branches missed.">			if (si2 == null)</span>
			{
<span class="nc" id="L2679">				return 1;</span>
			}

<span class="nc" id="L2682">			String primary1 = getPrimarySourceTitle(si1);</span>
<span class="nc" id="L2683">			String primary2 = getPrimarySourceTitle(si2);</span>
<span class="nc bnc" id="L2684" title="All 4 branches missed.">			if (primary1 != null &amp;&amp; primary2 != null)</span>
			{
<span class="nc" id="L2686">				int compare = primary1.compareTo(primary2);</span>
<span class="nc bnc" id="L2687" title="All 2 branches missed.">				if (compare != 0)</span>
				{
<span class="nc" id="L2689">					return compare;</span>
				}
			}
<span class="nc" id="L2692">			return o1.compareTo(o2);</span>
		}
	}

<span class="nc" id="L2696">	private class MainWindowListener</span>
			extends WindowAdapter
	{
		@Override
		public void windowClosing(WindowEvent e)
		{
<span class="nc" id="L2702">			exit();</span>
<span class="nc" id="L2703">		}</span>
	}

<span class="nc" id="L2706">	private class ShutdownRunnable</span>
			implements Runnable
	{
		public void run()
		{
<span class="nc bnc" id="L2711" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Executing shutdown hook...&quot;);</span>
<span class="nc bnc" id="L2712" title="All 2 branches missed.">			if (gotoSource != null)</span>
			{
<span class="nc" id="L2714">				gotoSource.stop();</span>
<span class="nc" id="L2715">				gotoSource = null;</span>
			}
<span class="nc bnc" id="L2717" title="All 2 branches missed.">			for (AutostartRunnable current : autostartProcesses)</span>
			{
<span class="nc" id="L2719">				current.destroyProcess();</span>
<span class="nc" id="L2720">			}</span>
<span class="nc bnc" id="L2721" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Finished executing shutdown hook...&quot;);</span>
<span class="nc" id="L2722">		}</span>
	}


	public static class AutostartRunnable
			implements Runnable
	{
<span class="nc" id="L2729">		private final Logger logger = LoggerFactory.getLogger(MainFrame.class);</span>

		private File file;
		private Process process;

		public AutostartRunnable(File file)
<span class="nc" id="L2735">		{</span>
<span class="nc" id="L2736">			this.file = file;</span>
<span class="nc" id="L2737">		}</span>

		public void destroyProcess()
		{
<span class="nc bnc" id="L2741" title="All 2 branches missed.">			if (process != null)</span>
			{
<span class="nc" id="L2743">				process.destroy();</span>
			}
<span class="nc" id="L2745">		}</span>

		public void run()
		{
			try
			{
<span class="nc bnc" id="L2751" title="All 2 branches missed.">				if (logger.isInfoEnabled()) logger.info(&quot;Starting '{}'.&quot;, file.getAbsolutePath());</span>
<span class="nc" id="L2752">				process = Runtime.getRuntime().exec(file.getAbsolutePath());</span>

<span class="nc" id="L2754">				Thread errThread = new Thread(new ErrorConsumerRunnable(process.getErrorStream()));</span>
<span class="nc" id="L2755">				errThread.setDaemon(true);</span>
<span class="nc" id="L2756">				errThread.start();</span>

<span class="nc" id="L2758">				Thread outThread = new Thread(new OutConsumerRunnable(process.getInputStream()));</span>
<span class="nc" id="L2759">				outThread.setDaemon(true);</span>
<span class="nc" id="L2760">				outThread.start();</span>

<span class="nc" id="L2762">				int exitCode = process.waitFor();</span>
<span class="nc bnc" id="L2763" title="All 2 branches missed.">				if (logger.isInfoEnabled())</span>
				{
<span class="nc" id="L2765">					logger.info(&quot;Execution of '{}' finished with exitCode {}.&quot;, file.getAbsolutePath(), exitCode);</span>
				}
			}
<span class="nc" id="L2768">			catch (IOException e)</span>
			{
<span class="nc bnc" id="L2770" title="All 2 branches missed.">				if (logger.isWarnEnabled())</span>
				{
<span class="nc" id="L2772">					logger.warn(&quot;Exception while executing '&quot; + file.getAbsolutePath() + &quot;'!&quot;, e);</span>
				}
			}
<span class="nc" id="L2775">			catch (InterruptedException e)</span>
			{
<span class="nc bnc" id="L2777" title="All 2 branches missed.">				if (logger.isDebugEnabled())</span>
				{
<span class="nc" id="L2779">					logger.debug(&quot;Execution of '&quot; + file.getAbsolutePath() + &quot;' was interrupted.&quot;, e);</span>
				}
<span class="nc" id="L2781">			}</span>
<span class="nc" id="L2782">		}</span>

		abstract class AbstractOutputConsumerRunnable
				implements Runnable
		{
			private BufferedReader inputReader;

			public AbstractOutputConsumerRunnable(InputStream input)
<span class="nc" id="L2790">			{</span>
<span class="nc" id="L2791">				inputReader = new BufferedReader(new InputStreamReader(input));</span>
<span class="nc" id="L2792">			}</span>

			public void run()
			{
				try
				{

					for (; ;)
					{
<span class="nc" id="L2801">						String line = inputReader.readLine();</span>
<span class="nc bnc" id="L2802" title="All 2 branches missed.">						if (line == null)</span>
						{
<span class="nc" id="L2804">							break;</span>
						}
<span class="nc" id="L2806">						processLine(line);</span>
<span class="nc" id="L2807">					}</span>

				}
<span class="nc" id="L2810">				catch (IOException e)</span>
				{
<span class="nc bnc" id="L2812" title="All 2 branches missed.">					if (logger.isDebugEnabled())</span>
					{
<span class="nc" id="L2814">						logger.debug(&quot;Exception while reading from process '&quot; + file.getAbsolutePath() + &quot;'.&quot;, e);</span>
					}
<span class="nc" id="L2816">				}</span>
<span class="nc" id="L2817">			}</span>

			public abstract void processLine(String line);
		}

		private class OutConsumerRunnable
				extends AbstractOutputConsumerRunnable
		{
			public OutConsumerRunnable(InputStream input)
<span class="nc" id="L2826">			{</span>
<span class="nc" id="L2827">				super(input);</span>
<span class="nc" id="L2828">			}</span>

			public void processLine(String line)
			{
<span class="nc bnc" id="L2832" title="All 2 branches missed.">				if (logger.isInfoEnabled()) logger.info(&quot;{}: {}&quot;, file.getAbsolutePath(), line);</span>
<span class="nc" id="L2833">			}</span>
		}

		private class ErrorConsumerRunnable
				extends AbstractOutputConsumerRunnable
		{
			public ErrorConsumerRunnable(InputStream input)
<span class="nc" id="L2840">			{</span>
<span class="nc" id="L2841">				super(input);</span>
<span class="nc" id="L2842">			}</span>

			public void processLine(String line)
			{
<span class="nc" id="L2846">				System.err.println(file.getAbsolutePath() + &quot;: &quot; + line);</span>
<span class="nc" id="L2847">			}</span>
		}

	}

	public static class ProcessConsumerRunnable
			implements Runnable
	{
<span class="nc" id="L2855">		private final Logger logger = LoggerFactory.getLogger(MainFrame.class);</span>

		private Process process;

		public ProcessConsumerRunnable(Process process)
<span class="nc" id="L2860">		{</span>
<span class="nc" id="L2861">			this.process = process;</span>
<span class="nc" id="L2862">		}</span>

		public void destroyProcess()
		{
<span class="nc bnc" id="L2866" title="All 2 branches missed.">			if (process != null)</span>
			{
<span class="nc" id="L2868">				process.destroy();</span>
			}
<span class="nc" id="L2870">		}</span>

		public void run()
		{
			try
			{
<span class="nc" id="L2876">				Thread errThread = new Thread(new ErrorConsumerRunnable(process.getErrorStream()));</span>
<span class="nc" id="L2877">				errThread.setDaemon(true);</span>
<span class="nc" id="L2878">				errThread.start();</span>

<span class="nc" id="L2880">				Thread outThread = new Thread(new OutConsumerRunnable(process.getInputStream()));</span>
<span class="nc" id="L2881">				outThread.setDaemon(true);</span>
<span class="nc" id="L2882">				outThread.start();</span>

<span class="nc" id="L2884">				int exitCode = process.waitFor();</span>
<span class="nc bnc" id="L2885" title="All 2 branches missed.">				if (logger.isDebugEnabled()) logger.debug(&quot;Execution finished with exitCode {}.&quot;, exitCode);</span>
			}
<span class="nc" id="L2887">			catch (InterruptedException e)</span>
			{
<span class="nc bnc" id="L2889" title="All 2 branches missed.">				if (logger.isDebugEnabled()) logger.debug(&quot;Execution of openUrl process was interrupted.&quot;, e);</span>
<span class="nc" id="L2890">			}</span>
<span class="nc" id="L2891">		}</span>

		abstract class AbstractOutputConsumerRunnable
				implements Runnable
		{
			private BufferedReader inputReader;

			public AbstractOutputConsumerRunnable(InputStream input)
<span class="nc" id="L2899">			{</span>
<span class="nc" id="L2900">				inputReader = new BufferedReader(new InputStreamReader(input));</span>
<span class="nc" id="L2901">			}</span>

			public void run()
			{
				try
				{

					for (; ;)
					{
<span class="nc" id="L2910">						String line = inputReader.readLine();</span>
<span class="nc bnc" id="L2911" title="All 2 branches missed.">						if (line == null)</span>
						{
<span class="nc" id="L2913">							break;</span>
						}
<span class="nc" id="L2915">						processLine(line);</span>
<span class="nc" id="L2916">					}</span>

				}
<span class="nc" id="L2919">				catch (IOException e)</span>
				{
<span class="nc bnc" id="L2921" title="All 2 branches missed.">					if (logger.isDebugEnabled()) logger.debug(&quot;Exception while reading from openUrl process.&quot;, e);</span>
<span class="nc" id="L2922">				}</span>
<span class="nc" id="L2923">			}</span>

			public abstract void processLine(String line);
		}

		private class OutConsumerRunnable
				extends AbstractOutputConsumerRunnable
		{
			public OutConsumerRunnable(InputStream input)
<span class="nc" id="L2932">			{</span>
<span class="nc" id="L2933">				super(input);</span>
<span class="nc" id="L2934">			}</span>

			public void processLine(String line)
			{
<span class="nc bnc" id="L2938" title="All 2 branches missed.">				if (logger.isDebugEnabled()) logger.debug(&quot;{}&quot;, line);</span>
<span class="nc" id="L2939">			}</span>
		}

		private class ErrorConsumerRunnable
				extends AbstractOutputConsumerRunnable
		{
			public ErrorConsumerRunnable(InputStream input)
<span class="nc" id="L2946">			{</span>
<span class="nc" id="L2947">				super(input);</span>
<span class="nc" id="L2948">			}</span>

			public void processLine(String line)
			{
<span class="nc" id="L2952">				System.err.println(&quot;openUrl: &quot; + line);</span>
<span class="nc" id="L2953">			}</span>
		}

	}

	private class CheckForUpdateRunnable
			implements Runnable
	{
		private boolean showAlways;

		public CheckForUpdateRunnable(boolean showAlways)
<span class="nc" id="L2964">		{</span>
<span class="nc" id="L2965">			this.showAlways = showAlways;</span>
<span class="nc" id="L2966">		}</span>

		public void run()
		{
<span class="nc" id="L2970">			final String url = &quot;http://lilith.huxhorn.de/current-version.txt&quot;;</span>
			// Create an instance of HttpClient.
<span class="nc" id="L2972">			HttpClient client = new HttpClient();</span>

			// Create a method instance.
<span class="nc" id="L2975">			GetMethod method = new GetMethod(url);</span>

			// Provide custom retry handler is necessary
<span class="nc" id="L2978">			method.getParams().setParameter(HttpMethodParams.RETRY_HANDLER,</span>
					new DefaultHttpMethodRetryHandler(3, false));

<span class="nc" id="L2981">			String currentVersion = null;</span>
			try
			{
				// Execute the method.
<span class="nc" id="L2985">				int statusCode = client.executeMethod(method);</span>

				// lets use our HttpStatus instead...
<span class="nc bnc" id="L2988" title="All 2 branches missed.">				if (statusCode != HttpStatus.OK.getCode())</span>
				{
<span class="nc" id="L2990">					System.err.println(&quot;Method failed: &quot; + method.getStatusLine());</span>
				}

				// Read the response body.
<span class="nc" id="L2994">				byte[] responseBody = method.getResponseBody();</span>
<span class="nc" id="L2995">				String charSet = method.getResponseCharSet();</span>

<span class="nc" id="L2997">				currentVersion = new String(responseBody, charSet);</span>
			}
<span class="nc" id="L2999">			catch (Throwable e)</span>
			{
<span class="nc bnc" id="L3001" title="All 2 branches missed.">				if (logger.isInfoEnabled()) logger.info(&quot;Exception while checking current version!&quot;, e);</span>
			}
			finally
			{
				// Release the connection.
<span class="nc" id="L3006">				method.releaseConnection();</span>
			}

			String message;
<span class="nc" id="L3010">			boolean newVersion = false;</span>
<span class="nc bnc" id="L3011" title="All 2 branches missed.">			if (currentVersion == null)</span>
			{
<span class="nc" id="L3013">				message = &quot;Couldn't retrieve current version!&quot;;</span>
			}
			else
			{
<span class="nc" id="L3017">				currentVersion = currentVersion.trim();</span>
<span class="nc bnc" id="L3018" title="All 2 branches missed.">				if (!currentVersion.equals(Lilith.APP_VERSION))</span>
				{
<span class="nc" id="L3020">					message = &quot;New version is available: &quot; + currentVersion;</span>
<span class="nc" id="L3021">					newVersion = true;</span>
				}
				else
				{
<span class="nc" id="L3025">					message = &quot;Your version is up to date.&quot;;</span>
				}
			}
<span class="nc bnc" id="L3028" title="All 2 branches missed.">			if (logger.isInfoEnabled()) logger.info(&quot;Message: {}, newVersion: {}&quot;, message, newVersion);</span>
<span class="nc bnc" id="L3029" title="All 4 branches missed.">			if (newVersion || showAlways)</span>
			{
<span class="nc" id="L3031">				SwingUtilities.invokeLater(new ShowUpdateDialog(message));</span>
			}
<span class="nc" id="L3033">		}</span>
	}

	private class ShowUpdateDialog
			implements Runnable
	{
		private String message;

		public ShowUpdateDialog(String message)
<span class="nc" id="L3042">		{</span>
<span class="nc" id="L3043">			this.message = message;</span>
<span class="nc" id="L3044">		}</span>

		public void run()
		{
<span class="nc" id="L3048">			MainFrame.this.showUpdateDialog(message);</span>
<span class="nc" id="L3049">		}</span>
	}

	private void showUpdateDialog(String message)
	{
<span class="nc" id="L3054">		JOptionPane.showMessageDialog(this, message, &quot;Check for update...&quot;, JOptionPane.INFORMATION_MESSAGE);</span>
		// TODO: Improve update available dialog

<span class="nc" id="L3057">	}</span>

	/*
		private class ColorsCollectionRunnable
			implements Runnable
		{
			private final Logger logger = LoggerFactory.getLogger(ColorsCollectionRunnable.class);

			public void run()
			{
				for(;;)
				{
					try
					{
						SoftColorsReference ref= (SoftColorsReference) colorsReferenceQueue.remove();
						EventIdentifier id = ref.getId();
						colorsCache.remove(id);
						if(logger.isDebugEnabled()) logger.debug(&quot;Removed cached color for {}.&quot;, id);
					}
					catch (InterruptedException e)
					{
						break;
					}
				}
			}
		}
		*/
<span class="nc" id="L3084">	private class MainTaskListener</span>
			implements TaskListener&lt;Long&gt;
	{
		public void taskCreated(Task&lt;Long&gt; longTask)
		{
<span class="nc" id="L3089">			updateTaskStatus();</span>
<span class="nc" id="L3090">		}</span>

		public void executionFailed(Task&lt;Long&gt; longTask, ExecutionException exception)
		{
<span class="nc" id="L3094">			updateTaskStatus();</span>
<span class="nc" id="L3095">		}</span>

		public void executionFinished(Task&lt;Long&gt; longTask, Long result)
		{
<span class="nc" id="L3099">			updateTaskStatus();</span>
<span class="nc" id="L3100">			Callable&lt;Long&gt; callable = longTask.getCallable();</span>

<span class="nc bnc" id="L3102" title="All 2 branches missed.">			if (callable instanceof IndexingCallable)</span>
			{
<span class="nc" id="L3104">				IndexingCallable iCallable = (IndexingCallable) callable;</span>
<span class="nc" id="L3105">				File dataFile = iCallable.getDataFile();</span>
<span class="nc" id="L3106">				File indexFile = iCallable.getIndexFile();</span>
<span class="nc" id="L3107">				createViewFor(dataFile, indexFile);</span>
<span class="nc" id="L3108">				return;</span>
			}
<span class="nc bnc" id="L3110" title="All 2 branches missed.">			if (callable instanceof Log4jImportCallable)</span>
			{
<span class="nc" id="L3112">				Log4jImportCallable iCallable = (Log4jImportCallable) callable;</span>
<span class="nc" id="L3113">				AppendOperation&lt;EventWrapper&lt;LoggingEvent&gt;&gt; buffer = iCallable.getBuffer();</span>
<span class="nc bnc" id="L3114" title="All 2 branches missed.">				if (buffer instanceof CodecFileBuffer)</span>
				{
<span class="nc" id="L3116">					CodecFileBuffer cfb = (CodecFileBuffer) buffer;</span>
<span class="nc" id="L3117">					File dataFile = cfb.getDataFile();</span>
<span class="nc" id="L3118">					File indexFile = cfb.getIndexFile();</span>
<span class="nc" id="L3119">					cfb.dispose();</span>
<span class="nc" id="L3120">					createViewFor(dataFile, indexFile);</span>
				}
<span class="nc" id="L3122">				return;</span>
			}
<span class="nc bnc" id="L3124" title="All 2 branches missed.">			if (callable instanceof JulImportCallable)</span>
			{
<span class="nc" id="L3126">				JulImportCallable iCallable = (JulImportCallable) callable;</span>
<span class="nc" id="L3127">				AppendOperation&lt;EventWrapper&lt;LoggingEvent&gt;&gt; buffer = iCallable.getBuffer();</span>
<span class="nc bnc" id="L3128" title="All 2 branches missed.">				if (buffer instanceof CodecFileBuffer)</span>
				{
<span class="nc" id="L3130">					CodecFileBuffer cfb = (CodecFileBuffer) buffer;</span>
<span class="nc" id="L3131">					File dataFile = cfb.getDataFile();</span>
<span class="nc" id="L3132">					File indexFile = cfb.getIndexFile();</span>
<span class="nc" id="L3133">					cfb.dispose();</span>
<span class="nc" id="L3134">					createViewFor(dataFile, indexFile);</span>
				}
			}
<span class="nc" id="L3137">		}</span>

		public void executionCanceled(Task&lt;Long&gt; longTask)
		{
<span class="nc" id="L3141">			updateTaskStatus();</span>
<span class="nc" id="L3142">		}</span>

		public void progressUpdated(Task&lt;Long&gt; longTask, int progress)
		{
<span class="nc" id="L3146">			updateTaskStatus();</span>
<span class="nc" id="L3147">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>