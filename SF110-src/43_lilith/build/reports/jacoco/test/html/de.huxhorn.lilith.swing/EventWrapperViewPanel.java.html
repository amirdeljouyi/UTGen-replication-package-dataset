<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EventWrapperViewPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">43_lilith</a> &gt; <a href="index.source.html" class="el_package">de.huxhorn.lilith.swing</a> &gt; <span class="el_source">EventWrapperViewPanel.java</span></div><h1>EventWrapperViewPanel.java</h1><pre class="source lang-java linenums">/*
 * Lilith - a log event viewer.
 * Copyright (C) 2007-2009 Joern Huxhorn
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package de.huxhorn.lilith.swing;

import de.huxhorn.lilith.buffers.FilteringBuffer;
import de.huxhorn.lilith.buffers.SoftReferenceCachingBuffer;
import de.huxhorn.lilith.conditions.EventContainsCondition;
import de.huxhorn.lilith.conditions.GroovyCondition;
import de.huxhorn.lilith.conditions.LoggerEqualsCondition;
import de.huxhorn.lilith.conditions.LoggerStartsWithCondition;
import de.huxhorn.lilith.conditions.MessageContainsCondition;
import de.huxhorn.lilith.data.eventsource.EventWrapper;
import de.huxhorn.lilith.data.eventsource.SourceIdentifier;
import de.huxhorn.lilith.data.logging.ExtendedStackTraceElement;
import de.huxhorn.lilith.data.logging.LoggingEvent;
import de.huxhorn.lilith.engine.EventSource;
import de.huxhorn.lilith.swing.callables.CallableMetaData;
import de.huxhorn.lilith.swing.callables.FindNextCallable;
import de.huxhorn.lilith.swing.callables.FindPreviousCallable;
import de.huxhorn.lilith.swing.linklistener.StackTraceElementLinkListener;
import de.huxhorn.lilith.swing.preferences.SavedCondition;
import de.huxhorn.lilith.swing.table.EventWrapperViewTable;
import de.huxhorn.lilith.swing.table.model.EventWrapperTableModel;
import de.huxhorn.sulky.buffers.Buffer;
import de.huxhorn.sulky.buffers.DisposeOperation;
import de.huxhorn.sulky.codec.filebuffer.CodecFileBuffer;
import de.huxhorn.sulky.conditions.And;
import de.huxhorn.sulky.conditions.Condition;
import de.huxhorn.sulky.conditions.Not;
import de.huxhorn.sulky.formatting.HumanReadable;
import de.huxhorn.sulky.swing.KeyStrokes;
import de.huxhorn.sulky.tasks.ProgressingCallable;
import de.huxhorn.sulky.tasks.Task;
import de.huxhorn.sulky.tasks.TaskListener;
import de.huxhorn.sulky.tasks.TaskManager;

import org.apache.commons.io.IOUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.xhtmlrenderer.simple.FSScrollPane;
import org.xhtmlrenderer.simple.XHTMLPanel;
import org.xhtmlrenderer.simple.extend.XhtmlNamespaceHandler;
import org.xhtmlrenderer.swing.LinkListener;
import org.xhtmlrenderer.swing.SelectionHighlighter;

import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusEvent;
import java.awt.event.FocusListener;
import java.awt.event.InputEvent;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStreamWriter;
import java.io.Serializable;
import java.net.URL;
import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Vector;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;

import javax.swing.*;
import javax.swing.border.MatteBorder;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.event.TableModelEvent;
import javax.swing.event.TableModelListener;

public abstract class EventWrapperViewPanel&lt;T extends Serializable&gt;
	extends JPanel
	implements DisposeOperation
{
	public static final String STATE_PROPERTY = &quot;state&quot;;
	public static final String FILTER_CONDITION_PROPERTY = &quot;filterCondition&quot;;
	public static final String EVENT_SOURCE_PROPERTY = &quot;eventSource&quot;;
	public static final String SCROLLING_TO_BOTTOM_PROPERTY = &quot;scrollingToBottom&quot;;
	public static final String PAUSED_PROPERTY = &quot;paused&quot;;
	public static final String SELECTED_EVENT_PROPERTY = &quot;selectedEvent&quot;;

<span class="nc" id="L109">	private final Logger logger = LoggerFactory.getLogger(EventWrapperViewPanel.class);</span>

	private EventSource&lt;T&gt; eventSource;
	private LoggingViewState state;
	private MainFrame mainFrame;
	private boolean showingFilters;
	private Condition filterCondition;
	private TaskManager&lt;Long&gt; taskManager;

	private EventWrapperViewTable&lt;T&gt; table;
	private EventWrapperTableModel&lt;T&gt; tableModel;

	private FindNextAction findNextAction;
	private FindPreviousAction findPrevAction;
	private CloseFindAction closeFindAction;

	private JButton findPrevButton;
	private JButton findNextButton;

	private JToolBar findPanel;
	private JToggleButton findNotButton;
	private JComboBox findTypeCombo;
	private JTextField findTextField;
	private JLabel statusLabel;
	private JScrollBar verticalLogScrollbar;

	private StatusTableModelListener tableModelListener;
	private FocusTraversalPolicy focusTraversalPolicy;
	private MatteBorder focusedBorder;
	private MatteBorder unfocusedBorder;
	private DecimalFormat eventCountFormat;
	private FindResultListener findResultListener;
	private static final String GROOVY_IDENTIFIER = &quot;#groovy#&quot;;
	private static final String SAVED_CONDITION_IDENTIFIER = &quot;#condition#&quot;;
<span class="nc" id="L143">	private static final Color ERROR_COLOR = new Color(0xffaaaa);</span>
	protected JMenu sendToMenuItem;

	private XHTMLPanel messagePane;
	private XhtmlNamespaceHandler xhtmlNamespaceHandler;
	private EventWrapper&lt;T&gt; selectedEvent;
	private SelectionHighlighter messagePaneCaret;
	private SelectionHighlighter.CopyAction copyAction;


	public EventWrapperViewPanel(MainFrame mainFrame, EventSource&lt;T&gt; eventSource)
	{
<span class="nc" id="L155">		super(true);</span>
<span class="nc" id="L156">		eventCountFormat = new DecimalFormat(&quot;#,###&quot;);</span>
<span class="nc" id="L157">		this.taskManager = mainFrame.getLongWorkManager();</span>
<span class="nc" id="L158">		findResultListener = new FindResultListener();</span>
<span class="nc" id="L159">		taskManager.addTaskListener(findResultListener);</span>
<span class="nc" id="L160">		this.mainFrame = mainFrame;</span>
<span class="nc" id="L161">		this.eventSource = eventSource;</span>
<span class="nc" id="L162">		showingFilters = false;</span>

<span class="nc" id="L164">		tableModelListener = new StatusTableModelListener();</span>
<span class="nc" id="L165">		initUi();</span>
<span class="nc" id="L166">	}</span>

	private void initUi()
	{
<span class="nc" id="L170">		Insets borderInsets = new Insets(2, 2, 2, 2);</span>
<span class="nc" id="L171">		focusedBorder = new MatteBorder(borderInsets, Color.YELLOW);</span>
<span class="nc" id="L172">		unfocusedBorder = new MatteBorder(borderInsets, Color.WHITE);</span>

<span class="nc" id="L174">		SoftReferenceCachingBuffer&lt;EventWrapper&lt;T&gt;&gt; cachedBuffer = createCachedBuffer(eventSource.getBuffer());</span>
<span class="nc" id="L175">		tableModel = createTableModel(cachedBuffer);</span>
<span class="nc" id="L176">		tableModel.addTableModelListener(tableModelListener);</span>
<span class="nc" id="L177">		table = createTable(tableModel);</span>
<span class="nc" id="L178">		table.getSelectionModel().addListSelectionListener(new TableRowSelectionListener());</span>
<span class="nc" id="L179">		JScrollPane tableScrollPane = new JScrollPane(table);</span>
<span class="nc" id="L180">		verticalLogScrollbar = tableScrollPane.getVerticalScrollBar();</span>

<span class="nc" id="L182">		messagePane = new XHTMLPanel();</span>
<span class="nc" id="L183">		messagePaneCaret = new SelectionHighlighter();</span>
<span class="nc" id="L184">		messagePaneCaret.install(messagePane);</span>

<span class="nc" id="L186">		copyAction = new SelectionHighlighter.CopyAction();</span>
<span class="nc" id="L187">		copyAction.install(messagePaneCaret);</span>

<span class="nc" id="L189">		messagePane.addMouseListener(new EventViewMouseListener());</span>


<span class="nc" id="L192">		messagePane.addFocusListener(new MessageFocusListener());</span>
<span class="nc" id="L193">		messagePane.setBorder(unfocusedBorder);</span>

		{
<span class="nc" id="L196">			List mouseTrackingList = messagePane.getMouseTrackingListeners();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">			if(mouseTrackingList != null)</span>
			{
<span class="nc bnc" id="L199" title="All 2 branches missed.">				for(Object o : mouseTrackingList)</span>
				{
<span class="nc bnc" id="L201" title="All 2 branches missed.">					if(logger.isDebugEnabled()) logger.debug(&quot;Before MTL {}&quot;, o);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">					if(o instanceof LinkListener)</span>
					{
<span class="nc" id="L204">						messagePane.removeMouseTrackingListener((LinkListener) o);</span>
					}
<span class="nc" id="L206">				}</span>
			}
		}

<span class="nc" id="L210">		messagePane.addMouseTrackingListener(new StackTraceElementLinkListener(mainFrame));</span>

<span class="nc" id="L212">		xhtmlNamespaceHandler = new XhtmlNamespaceHandler();</span>
<span class="nc" id="L213">		FSScrollPane messageScrollPane = new FSScrollPane(messagePane);</span>

<span class="nc" id="L215">		JSplitPane splitPane = new JSplitPane(JSplitPane.VERTICAL_SPLIT, tableScrollPane, messageScrollPane);</span>
<span class="nc" id="L216">		PropertyChangeListener splitPaneListener = new SplitPaneListener();</span>
<span class="nc" id="L217">		splitPane.addPropertyChangeListener(splitPaneListener);</span>
<span class="nc" id="L218">		splitPane.setResizeWeight(0.5); // divide space equally in case of resize.</span>
<span class="nc" id="L219">		splitPane.setOneTouchExpandable(true);</span>
<span class="nc" id="L220">		setLayout(new BorderLayout());</span>
<span class="nc" id="L221">		add(splitPane, BorderLayout.CENTER);</span>
<span class="nc" id="L222">		ScrollbarChangeListner scrollBarChangeListener = new ScrollbarChangeListner();</span>
<span class="nc" id="L223">		verticalLogScrollbar.getModel().addChangeListener(scrollBarChangeListener);</span>


<span class="nc" id="L226">		table.addMouseListener(new TableMouseListener());</span>
<span class="nc" id="L227">		table.addPropertyChangeListener(new EventWrapperViewChangeListener());</span>

<span class="nc" id="L229">		focusTraversalPolicy = new MyFocusTraversalPolicy();</span>

<span class="nc" id="L231">		initFindPanel();</span>

<span class="nc" id="L233">		ReplaceFilterAction replaceFilterAction = new ReplaceFilterAction();</span>

<span class="nc" id="L235">		FindTextFieldListener findTextFieldListener = new FindTextFieldListener();</span>
<span class="nc" id="L236">		findTextField.addActionListener(findTextFieldListener);</span>
<span class="nc" id="L237">		findTextField.getDocument().addDocumentListener(findTextFieldListener);</span>
<span class="nc" id="L238">		findTextField.setBackground(Color.WHITE);</span>

<span class="nc" id="L240">		JPanel bottomPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L241">		JPanel statusPanel = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L242">		GridBagConstraints gbc = new GridBagConstraints();</span>

<span class="nc" id="L244">		bottomPanel.add(findPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L245">		bottomPanel.add(statusPanel, BorderLayout.SOUTH);</span>

<span class="nc" id="L247">		statusLabel = new JLabel();</span>

<span class="nc" id="L249">		gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L250">		gbc.gridx = 0;</span>
<span class="nc" id="L251">		gbc.gridy = 0;</span>
<span class="nc" id="L252">		gbc.weightx = 1.0;</span>
<span class="nc" id="L253">		gbc.anchor = GridBagConstraints.CENTER;</span>
<span class="nc" id="L254">		gbc.insets = new Insets(0, 5, 0, 0);</span>

<span class="nc" id="L256">		statusPanel.add(statusLabel, gbc);</span>

<span class="nc" id="L258">		add(bottomPanel, BorderLayout.SOUTH);</span>

<span class="nc" id="L260">		setScrollingToBottom(false);</span>
<span class="nc" id="L261">		setPaused(false);</span>
<span class="nc" id="L262">		setFocusTraversalPolicy(focusTraversalPolicy);</span>
<span class="nc" id="L263">		setFocusCycleRoot(true);</span>
<span class="nc" id="L264">		setFocusTraversalPolicyProvider(true);</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">		if(logger.isDebugEnabled()) logger.debug(&quot;table.isFocusCycleRoot()={}&quot;, table.isFocusCycleRoot());</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if(logger.isDebugEnabled())</span>
		{
<span class="nc" id="L269">			logger.debug(&quot;table.isFocusTraversalPolicyProvider()={}&quot;, table.isFocusTraversalPolicyProvider());</span>
		}
<span class="nc" id="L271">		table.setFocusTraversalPolicy(focusTraversalPolicy);</span>
<span class="nc" id="L272">		table.setFocusCycleRoot(true);</span>

		// setting table traversal back to &quot;normal&quot;...
<span class="nc" id="L275">		table</span>
<span class="nc" id="L276">			.setFocusTraversalKeys(KeyboardFocusManager.FORWARD_TRAVERSAL_KEYS, getFocusTraversalKeys(KeyboardFocusManager.FORWARD_TRAVERSAL_KEYS));</span>
<span class="nc" id="L277">		table</span>
<span class="nc" id="L278">			.setFocusTraversalKeys(KeyboardFocusManager.BACKWARD_TRAVERSAL_KEYS, getFocusTraversalKeys(KeyboardFocusManager.BACKWARD_TRAVERSAL_KEYS));</span>

<span class="nc" id="L280">		updateStatusText();</span>

<span class="nc" id="L282">		KeyStrokes.registerCommand(this, findNextAction, &quot;FIND_NEXT_ACTION&quot;);</span>
<span class="nc" id="L283">		KeyStrokes.registerCommand(this, findPrevAction, &quot;FIND_PREV_ACTION&quot;);</span>
<span class="nc" id="L284">		KeyStrokes.registerCommand(this, closeFindAction, &quot;CLOSE_FIND_ACTION&quot;);</span>
<span class="nc" id="L285">		KeyStrokes.registerCommand(findTextField, replaceFilterAction, &quot;REPLACE_FILTER_ACTION&quot;);</span>
<span class="nc" id="L286">	}</span>

	private void initFindPanel()
	{
<span class="nc" id="L290">		findPanel = new JToolBar(SwingConstants.HORIZONTAL);</span>
<span class="nc" id="L291">		findPanel.setFloatable(false);</span>
<span class="nc" id="L292">		findPanel.setFocusTraversalPolicy(focusTraversalPolicy);</span>
<span class="nc" id="L293">		findPanel.setFocusCycleRoot(true);</span>

<span class="nc" id="L295">		closeFindAction = new CloseFindAction();</span>
<span class="nc" id="L296">		JButton findViewButton = new JButton(closeFindAction);</span>
<span class="nc" id="L297">		findPanel.add(findViewButton);</span>
<span class="nc" id="L298">		findPanel.addSeparator();</span>
<span class="nc" id="L299">		findPanel.add(new JLabel(&quot;Find: &quot;));</span>

<span class="nc" id="L301">		ActionListener findTypeModifiedListener = new FindTypeSelectionActionListener();</span>
<span class="nc" id="L302">		findTypeCombo = new JComboBox();</span>
<span class="nc" id="L303">		findTypeCombo.addActionListener(findTypeModifiedListener);</span>
<span class="nc" id="L304">		findNotButton = new JToggleButton(&quot;!&quot;);</span>
<span class="nc" id="L305">		findNotButton.addActionListener(findTypeModifiedListener);</span>
<span class="nc" id="L306">		findNotButton.setToolTipText(&quot;Not - inverts condition&quot;);</span>
<span class="nc" id="L307">		findTextField = new JTextField();</span>
<span class="nc" id="L308">		findTextField.setColumns(15);</span>
<span class="nc" id="L309">		findPanel.add(findNotButton);</span>
<span class="nc" id="L310">		findPanel.add(findTypeCombo);</span>
<span class="nc" id="L311">		findPanel.add(findTextField);</span>

<span class="nc" id="L313">		findPrevAction = new FindPreviousAction();</span>
<span class="nc" id="L314">		findPrevButton = new JButton(findPrevAction);</span>
<span class="nc" id="L315">		findPanel.add(findPrevButton);</span>

<span class="nc" id="L317">		findNextAction = new FindNextAction();</span>
<span class="nc" id="L318">		findNextButton = new JButton(findNextAction);</span>
<span class="nc" id="L319">		findPanel.add(findNextButton);</span>
<span class="nc" id="L320">		enableFindComponents(true);</span>
<span class="nc" id="L321">	}</span>

	public EventWrapperViewTable&lt;T&gt; getTable()
	{
<span class="nc" id="L325">		return table;</span>
	}

	public LoggingViewState getState()
	{
<span class="nc bnc" id="L330" title="All 2 branches missed.">		if(!EventQueue.isDispatchThread())</span>
		{
<span class="nc bnc" id="L332" title="All 2 branches missed.">			if(logger.isWarnEnabled())</span>
			{
				//noinspection ThrowableInstanceNeverThrown
<span class="nc" id="L335">				logger.warn(&quot;!DispatchThread - getState: state=&quot; + state, new Throwable());</span>
			}
		}
<span class="nc" id="L338">		return state;</span>
	}

	public MainFrame getMainFrame()
	{
<span class="nc" id="L343">		return mainFrame;</span>
	}

	public void setState(LoggingViewState state)
	{
<span class="nc" id="L348">		Object oldValue = this.state;</span>
<span class="nc" id="L349">		this.state = state;</span>
<span class="nc" id="L350">		Object newValue = this.state;</span>
<span class="nc" id="L351">		firePropertyChange(STATE_PROPERTY, oldValue, newValue);</span>
<span class="nc" id="L352">	}</span>

	public boolean isShowingFilters()
	{
<span class="nc" id="L356">		return showingFilters;</span>
	}

	public void setShowingFilters(boolean showingFilters)
	{
<span class="nc" id="L361">		this.showingFilters = showingFilters;</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">		if(showingFilters)</span>
		{
<span class="nc" id="L364">			initTypeCombo();</span>
			// select correct type in combo
<span class="nc" id="L366">			Condition condition = getFilterCondition();</span>
<span class="nc" id="L367">			boolean not = false;</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">			if(condition instanceof Not)</span>
			{
<span class="nc" id="L370">				Not notCondition = (Not) condition;</span>
<span class="nc" id="L371">				not = true;</span>
<span class="nc" id="L372">				condition = notCondition.getCondition();</span>
			}
<span class="nc bnc" id="L374" title="All 2 branches missed.">			if(condition != null)</span>
			{
<span class="nc" id="L376">				String conditionName = null;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">				if(condition instanceof EventContainsCondition)</span>
				{
<span class="nc" id="L379">					conditionName = EVENT_CONTAINS_CONDITION;</span>
				}
<span class="nc bnc" id="L381" title="All 2 branches missed.">				else if(condition instanceof MessageContainsCondition)</span>
				{
<span class="nc" id="L383">					conditionName = MESSAGE_CONTAINS_CONDITION;</span>
				}
<span class="nc bnc" id="L385" title="All 2 branches missed.">				else if(condition instanceof LoggerStartsWithCondition)</span>
				{
<span class="nc" id="L387">					conditionName = LOGGER_STARTS_WITH_CONDITION;</span>
				}
<span class="nc bnc" id="L389" title="All 2 branches missed.">				else if(condition instanceof LoggerEqualsCondition)</span>
				{
<span class="nc" id="L391">					conditionName = LOGGER_EQUALS_CONDITION;</span>
				}
<span class="nc bnc" id="L393" title="All 2 branches missed.">				else if(condition instanceof GroovyCondition)</span>
				{
<span class="nc" id="L395">					GroovyCondition groovyCondition = (GroovyCondition) condition;</span>
<span class="nc" id="L396">					String scriptFileName = groovyCondition.getScriptFileName();</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">					if(scriptFileName != null)</span>
					{
<span class="nc" id="L399">						File scriptFile = new File(scriptFileName);</span>
<span class="nc" id="L400">						conditionName = scriptFile.getName();</span>
					}
				}
<span class="nc bnc" id="L403" title="All 2 branches missed.">				if(conditionName != null)</span>
				{
<span class="nc" id="L405">					findTypeCombo.setSelectedItem(conditionName);</span>
				}
			}
<span class="nc" id="L408">			findNotButton.setSelected(not);</span>
		}
<span class="nc" id="L410">		findPanel.setVisible(showingFilters);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">		if(showingFilters)</span>
		{
<span class="nc" id="L413">			findTextField.requestFocusInWindow();</span>
<span class="nc" id="L414">			findTextField.selectAll();</span>
<span class="nc" id="L415">			applyFilter();</span>
		}
<span class="nc" id="L417">		scrollToEvent();</span>
<span class="nc" id="L418">	}</span>

	/**
	 * scrolls to bottom if it is enabled. Otherwise makes sure that an event is selected if available.
	 */
	public void scrollToEvent()
	{
<span class="nc bnc" id="L425" title="All 2 branches missed.">		if(table.isScrollingToBottom())</span>
		{
<span class="nc" id="L427">			SwingUtilities.invokeLater(new ScrollToBottomRunnable());</span>
		}
<span class="nc bnc" id="L429" title="All 2 branches missed.">		else if(table.getSelectedRow() &lt; 0)</span>
		{
<span class="nc" id="L431">			SwingUtilities.invokeLater(new SelectFirstEventRunnable());</span>
		}
<span class="nc" id="L433">	}</span>

	public void updateView()
	{
		// update HTML detailsview
<span class="nc" id="L438">		EventWrapper&lt;T&gt; selected = getSelectedEvent();</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">		if(selected != null)</span>
		{
<span class="nc" id="L441">			initMessage(selected);</span>
		}
		else
		{
<span class="nc" id="L445">			resetMessage();</span>
		}
<span class="nc" id="L447">	}</span>

<span class="nc" id="L449">	private class ScrollToBottomRunnable</span>
		implements Runnable
	{
		public void run()
		{
<span class="nc" id="L454">			table.scrollToBottom();</span>
<span class="nc" id="L455">		}</span>
	}

<span class="nc" id="L458">	private class SelectFirstEventRunnable</span>
		implements Runnable
	{
		public void run()
		{
<span class="nc" id="L463">			table.scrollToFirst();</span>
<span class="nc" id="L464">		}</span>
	}

	public void validate()
	{
<span class="nc" id="L469">		super.validate();</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">		if(logger.isDebugEnabled()) logger.debug(&quot;Validate&quot;);</span>
<span class="nc" id="L471">	}</span>

	private SoftReferenceCachingBuffer&lt;EventWrapper&lt;T&gt;&gt; createCachedBuffer(Buffer&lt;EventWrapper&lt;T&gt;&gt; buffer)
	{
<span class="nc" id="L475">		return new SoftReferenceCachingBuffer&lt;EventWrapper&lt;T&gt;&gt;(buffer);</span>
	}

	void setEventSource(EventSource&lt;T&gt; eventSource)
	{
<span class="nc" id="L480">		EventSource oldValue = this.eventSource;</span>
<span class="nc" id="L481">		this.eventSource = eventSource;</span>
<span class="nc" id="L482">		SoftReferenceCachingBuffer&lt;EventWrapper&lt;T&gt;&gt; cachedBuffer = createCachedBuffer(eventSource.getBuffer());</span>
<span class="nc" id="L483">		tableModel.setBuffer(cachedBuffer);</span>
<span class="nc" id="L484">		EventSource newValue = this.eventSource;</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">		if(logger.isDebugEnabled()) logger.debug(&quot;EventSource\nOld: {}\nNew: {}&quot;, oldValue, newValue);</span>
<span class="nc" id="L486">		firePropertyChange(EVENT_SOURCE_PROPERTY, oldValue, newValue);</span>
<span class="nc" id="L487">	}</span>

	public EventSource&lt;T&gt; getEventSource()
	{
<span class="nc" id="L491">		return eventSource;</span>
	}

	public void setScrollingToBottom(boolean scrollingToBottom)
	{
<span class="nc" id="L496">		Object oldValue = table.isScrollingToBottom();</span>
<span class="nc" id="L497">		table.setScrollingToBottom(scrollingToBottom);</span>
<span class="nc" id="L498">		Object newValue = table.isScrollingToBottom();</span>
<span class="nc" id="L499">		firePropertyChange(SCROLLING_TO_BOTTOM_PROPERTY, oldValue, newValue);</span>
<span class="nc" id="L500">	}</span>

	public boolean isScrollingToBottom()
	{
<span class="nc" id="L504">		return table.isScrollingToBottom();</span>
	}

	public boolean isPaused()
	{
<span class="nc" id="L509">		return tableModel.isPaused();</span>
	}

	public void setPaused(boolean paused)
	{
<span class="nc" id="L514">		Object oldValue = tableModel.isPaused();</span>
<span class="nc" id="L515">		tableModel.setPaused(paused);</span>
<span class="nc" id="L516">		Object newValue = tableModel.isPaused();</span>
<span class="nc" id="L517">		firePropertyChange(PAUSED_PROPERTY, oldValue, newValue);</span>
<span class="nc" id="L518">	}</span>

	public ViewContainer&lt;T&gt; resolveContainer()
	{
<span class="nc" id="L522">		Container parent = getParent();</span>
<span class="nc bnc" id="L523" title="All 4 branches missed.">		while(parent != null &amp;&amp; !(parent instanceof ViewContainer))</span>
		{
<span class="nc" id="L525">			parent = parent.getParent();</span>
		}
		// not 100% typesafe
		//noinspection unchecked
<span class="nc" id="L529">		return (ViewContainer&lt;T&gt;) parent;</span>
	}

	public void addNotify()
	{
<span class="nc" id="L534">		super.addNotify();</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">		if(logger.isDebugEnabled()) logger.debug(&quot;addNotify - parent: {}&quot;, getParent());</span>
<span class="nc" id="L536">		findPanel.setVisible(isShowingFilters());</span>
<span class="nc" id="L537">	}</span>

	public void removeNotify()
	{
<span class="nc" id="L541">		super.removeNotify();</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">		if(logger.isDebugEnabled()) logger.debug(&quot;removeNotify&quot;);</span>
<span class="nc" id="L543">	}</span>


	protected abstract EventWrapperTableModel&lt;T&gt; createTableModel(Buffer&lt;EventWrapper&lt;T&gt;&gt; buffer);

	protected abstract EventWrapperViewTable&lt;T&gt; createTable(EventWrapperTableModel&lt;T&gt; tableModel);


	private static final String EVENT_CONTAINS_CONDITION = &quot;event.contains&quot;;
	private static final String MESSAGE_CONTAINS_CONDITION = &quot;message.contains&quot;;
	private static final String LOGGER_STARTS_WITH_CONDITION = &quot;logger.startsWith&quot;;
	private static final String LOGGER_EQUALS_CONDITION = &quot;logger.equals&quot;;
<span class="nc" id="L555">	private static final String[] DEFAULT_CONDITIONS = new String[]{</span>
		EVENT_CONTAINS_CONDITION,
		MESSAGE_CONTAINS_CONDITION,
		LOGGER_STARTS_WITH_CONDITION,
		LOGGER_EQUALS_CONDITION};

	private void initTypeCombo()
	{
<span class="nc" id="L563">		Vector&lt;String&gt; itemsVector = new Vector&lt;String&gt;();</span>

<span class="nc" id="L565">		itemsVector.addAll(Arrays.asList(DEFAULT_CONDITIONS));</span>

<span class="nc" id="L567">		String[] groovyConditions = mainFrame.getAllConditionScriptFiles();</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">		if(groovyConditions != null)</span>
		{
<span class="nc" id="L570">			itemsVector.addAll(Arrays.asList(groovyConditions));</span>
		}

<span class="nc" id="L573">		ComboBoxModel model = new DefaultComboBoxModel(itemsVector);</span>
<span class="nc" id="L574">		findTypeCombo.setModel(model);</span>
<span class="nc" id="L575">	}</span>

	public void dispose()
	{
<span class="nc" id="L579">		tableModel.dispose();</span>
<span class="nc" id="L580">		taskManager.removeTaskListener(findResultListener);</span>
<span class="nc" id="L581">	}</span>

	public boolean isDisposed()
	{
<span class="nc" id="L585">		return tableModel.isDisposed();</span>
	}

	public void resetFind()
	{
<span class="nc" id="L590">		findTextField.setText(&quot;&quot;);</span>
<span class="nc" id="L591">		setFilterCondition(null);</span>
<span class="nc" id="L592">	}</span>

	protected void setSelectedEvent(EventWrapper&lt;T&gt; selectedEvent)
	{
<span class="nc" id="L596">		Object oldValue = this.selectedEvent;</span>
<span class="nc" id="L597">		this.selectedEvent = selectedEvent;</span>
<span class="nc" id="L598">		Object newValue = this.selectedEvent;</span>
<span class="nc" id="L599">		firePropertyChange(SELECTED_EVENT_PROPERTY, oldValue, newValue);</span>
<span class="nc" id="L600">	}</span>

	public EventWrapper&lt;T&gt; getSelectedEvent()
	{
<span class="nc" id="L604">		return selectedEvent;</span>
	}

<span class="nc" id="L607">	class MyFocusTraversalPolicy</span>
		extends FocusTraversalPolicy
	{
		public Component getComponentAfter(Container aContainer, Component aComponent)
		{
<span class="nc bnc" id="L612" title="All 2 branches missed.">			if(aComponent.equals(table))</span>
			{
<span class="nc" id="L614">				return messagePane;</span>
			}
<span class="nc bnc" id="L616" title="All 2 branches missed.">			if(aComponent.equals(messagePane))</span>
			{
<span class="nc bnc" id="L618" title="All 2 branches missed.">				if(isShowingFilters())</span>
				{
<span class="nc" id="L620">					return findNotButton;</span>
				}
<span class="nc" id="L622">				return table;</span>
			}
<span class="nc bnc" id="L624" title="All 2 branches missed.">			if(aComponent.equals(findNotButton))</span>
			{
<span class="nc" id="L626">				return findTypeCombo;</span>
			}
<span class="nc bnc" id="L628" title="All 2 branches missed.">			if(aComponent.equals(findTypeCombo))</span>
			{
<span class="nc" id="L630">				return findTextField;</span>
			}
<span class="nc bnc" id="L632" title="All 2 branches missed.">			if(aComponent.equals(findTextField))</span>
			{
<span class="nc bnc" id="L634" title="All 2 branches missed.">				if(findPrevButton.isEnabled())</span>
				{
<span class="nc" id="L636">					return findPrevButton;</span>
				}
<span class="nc bnc" id="L638" title="All 2 branches missed.">				if(findNextButton.isEnabled())</span>
				{
<span class="nc" id="L640">					return findNextButton;</span>
				}
<span class="nc" id="L642">				return table;</span>
			}
<span class="nc bnc" id="L644" title="All 2 branches missed.">			if(aComponent.equals(findPrevButton))</span>
			{
<span class="nc bnc" id="L646" title="All 2 branches missed.">				if(findNextButton.isEnabled())</span>
				{
<span class="nc" id="L648">					return findNextButton;</span>
				}
<span class="nc" id="L650">				return table;</span>
			}
<span class="nc bnc" id="L652" title="All 2 branches missed.">			if(aComponent.equals(findNextButton))</span>
			{
<span class="nc" id="L654">				return table;</span>
			}
<span class="nc bnc" id="L656" title="All 2 branches missed.">			if(aComponent.equals(findPanel))</span>
			{
<span class="nc" id="L658">				return table;</span>
			}
			// I guess focus was inside table so focus component after table.
<span class="nc bnc" id="L661" title="All 2 branches missed.">			if(logger.isInfoEnabled())</span>
			{
<span class="nc" id="L663">				logger</span>
<span class="nc" id="L664">					.info(&quot;Moving focus forward to messagePane since it was not explicitly handled. (component={})&quot;, aComponent);</span>
			}
<span class="nc" id="L666">			return messagePane;</span>
		}

		public Component getComponentBefore(Container aContainer, Component aComponent)
		{
<span class="nc bnc" id="L671" title="All 2 branches missed.">			if(aComponent.equals(messagePane))</span>
			{
<span class="nc" id="L673">				return table;</span>
			}
<span class="nc bnc" id="L675" title="All 2 branches missed.">			if(aComponent.equals(findNotButton))</span>
			{
<span class="nc" id="L677">				return messagePane;</span>
			}
<span class="nc bnc" id="L679" title="All 2 branches missed.">			if(aComponent.equals(findTypeCombo))</span>
			{
<span class="nc" id="L681">				return findNotButton;</span>
			}
<span class="nc bnc" id="L683" title="All 2 branches missed.">			if(aComponent.equals(findTextField))</span>
			{
<span class="nc" id="L685">				return findTypeCombo;</span>
			}
<span class="nc bnc" id="L687" title="All 2 branches missed.">			if(aComponent.equals(findPrevButton))</span>
			{
<span class="nc" id="L689">				return findTextField;</span>
			}
<span class="nc bnc" id="L691" title="All 2 branches missed.">			if(aComponent.equals(findNextButton))</span>
			{
<span class="nc bnc" id="L693" title="All 2 branches missed.">				if(findPrevButton.isEnabled())</span>
				{
<span class="nc" id="L695">					return findPrevButton;</span>
				}
<span class="nc" id="L697">				return findTextField;</span>
			}

<span class="nc bnc" id="L700" title="All 2 branches missed.">			if(aComponent.equals(findPanel))</span>
			{
<span class="nc" id="L702">				return messagePane;</span>
			}

			// table
<span class="nc bnc" id="L706" title="All 2 branches missed.">			if(isShowingFilters())</span>
			{
<span class="nc bnc" id="L708" title="All 2 branches missed.">				if(findNextButton.isEnabled())</span>
				{
<span class="nc" id="L710">					return findNextButton;</span>
				}
<span class="nc bnc" id="L712" title="All 2 branches missed.">				if(findPrevButton.isEnabled())</span>
				{
<span class="nc" id="L714">					return findPrevButton;</span>
				}
<span class="nc" id="L716">				return findTextField;</span>
			}
			// I guess focus was inside table so focus component before table.
<span class="nc bnc" id="L719" title="All 2 branches missed.">			if(logger.isInfoEnabled())</span>
			{
<span class="nc" id="L721">				logger</span>
<span class="nc" id="L722">					.info(&quot;Moving focus backward to messagePane since it was not explicitly handled. (component={})&quot;, aComponent);</span>
			}
<span class="nc" id="L724">			return messagePane;</span>
		}

		public Component getFirstComponent(Container aContainer)
		{
<span class="nc" id="L729">			return table;</span>
		}

		public Component getLastComponent(Container aContainer)
		{
<span class="nc" id="L734">			return messagePane;</span>
		}

		public Component getDefaultComponent(Container aContainer)
		{
<span class="nc" id="L739">			return table;</span>
		}
	}

	public EventWrapperTableModel&lt;T&gt; getTableModel()
	{
<span class="nc" id="L745">		return tableModel;</span>
	}


	protected void initMessage(EventWrapper wrapper)
	{
<span class="nc" id="L751">		String message = mainFrame.createMessage(wrapper);</span>
<span class="nc" id="L752">		URL messageViewRootUrl = mainFrame.getApplicationPreferences().getDetailsViewRootUrl();</span>
		try
		{
<span class="nc" id="L755">			messagePane.setDocumentFromString(message, messageViewRootUrl.toExternalForm(), xhtmlNamespaceHandler);</span>
		}
<span class="nc" id="L757">		catch(Throwable t)</span>
		{
<span class="nc bnc" id="L759" title="All 2 branches missed.">			if(logger.isWarnEnabled()) logger.warn(&quot;Exception while setting message!&quot;, t);</span>
<span class="nc" id="L760">			writeErrorMessage(message);</span>
<span class="nc" id="L761">		}</span>
<span class="nc" id="L762">	}</span>

	protected void resetMessage()
	{
<span class="nc" id="L766">		String message = &quot;&lt;html&gt;&lt;body&gt;No event selected.&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<span class="nc" id="L767">		URL messageViewRootUrl = mainFrame.getApplicationPreferences().getDetailsViewRootUrl();</span>
		try
		{
<span class="nc" id="L770">			messagePane.setDocumentFromString(message, messageViewRootUrl.toExternalForm(), xhtmlNamespaceHandler);</span>
		}
<span class="nc" id="L772">		catch(Throwable t)</span>
		{
<span class="nc bnc" id="L774" title="All 2 branches missed.">			if(logger.isWarnEnabled()) logger.warn(&quot;Exception while setting message!&quot;, t);</span>
<span class="nc" id="L775">			writeErrorMessage(message);</span>
<span class="nc" id="L776">		}</span>
<span class="nc" id="L777">	}</span>

	private void writeErrorMessage(String message)
	{
<span class="nc" id="L781">		File appPath = mainFrame.getApplicationPreferences().getStartupApplicationPath();</span>
<span class="nc" id="L782">		File errorPath = new File(appPath, &quot;errors&quot;);</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">		if(errorPath.mkdirs())</span>
		{
<span class="nc bnc" id="L785" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;Created errors directory '{}'.&quot;, errorPath);</span>
		}
<span class="nc" id="L787">		SimpleDateFormat format = new SimpleDateFormat(&quot;yyyyMMdd'T'HHmmssSSSZ&quot;);</span>
<span class="nc" id="L788">		String filename = format.format(new Date());</span>
<span class="nc" id="L789">		File errorFile = new File(errorPath, filename);</span>
<span class="nc" id="L790">		FileOutputStream fos = null;</span>
		try
		{
<span class="nc" id="L793">			fos = new FileOutputStream(errorFile);</span>
<span class="nc" id="L794">			OutputStreamWriter osw = new OutputStreamWriter(fos, &quot;UTF-8&quot;);</span>
<span class="nc" id="L795">			osw.append(message);</span>
<span class="nc" id="L796">			osw.flush();</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">			if(logger.isInfoEnabled()) logger.info(&quot;Faulty message written to '{}'.&quot;, errorFile.getAbsolutePath());</span>
		}
<span class="nc" id="L799">		catch(Throwable e)</span>
		{
<span class="nc bnc" id="L801" title="All 2 branches missed.">			if(logger.isWarnEnabled())</span>
			{
<span class="nc" id="L803">				logger.warn(&quot;Exception while writing faulty message to '&quot; + errorFile.getAbsolutePath() + &quot;'!&quot;, e);</span>
			}
		}
		finally
		{
<span class="nc" id="L808">			IOUtils.closeQuietly(fos);</span>
		}

<span class="nc" id="L811">	}</span>

	/**
	 * Does also disable scrollingToBottom and selects the clicked row, if any.
	 *
	 * @param p the point
	 * @return the EventWrapper at the given point.
	 */
	private EventWrapper&lt;T&gt; getEventWrapper(Point p)
	{
<span class="nc" id="L821">		int row = table.rowAtPoint(p);</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">		if(-1 == row)</span>
		{
<span class="nc" id="L824">			return null;</span>
		}
		// row = table.convertRowIndexToModel(row);
		// 1.6, not needed
<span class="nc" id="L828">		table.setScrollingToBottom(false);</span>
<span class="nc" id="L829">		table.selectRow(row);</span>
<span class="nc" id="L830">		return tableModel.getValueAt(row);</span>
	}

	private void applyFilter()
	{
<span class="nc" id="L835">		String text = findTextField.getText();</span>
		Condition condition;
		//boolean error=false;
<span class="nc" id="L838">		String errorMessage = null;</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">		if(text == null)</span>
		{
<span class="nc" id="L841">			text = &quot;&quot;;</span>
		}
<span class="nc bnc" id="L843" title="All 2 branches missed.">		if(text.startsWith(GROOVY_IDENTIFIER))</span>
		{
<span class="nc" id="L845">			String scriptName = text.substring(GROOVY_IDENTIFIER.length());</span>

<span class="nc" id="L847">			int idx = scriptName.indexOf('#');</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">			if(idx &gt; -1)</span>
			{
<span class="nc bnc" id="L850" title="All 2 branches missed.">				if(idx + 1 &lt; scriptName.length())</span>
				{
<span class="nc" id="L852">					text = scriptName.substring(idx + 1);</span>
				}
				else
				{
<span class="nc" id="L856">					text = &quot;&quot;;</span>
				}
<span class="nc" id="L858">				scriptName = scriptName.substring(0, idx);</span>
			}
			else
			{
<span class="nc" id="L862">				text = &quot;&quot;;</span>
			}
<span class="nc bnc" id="L864" title="All 2 branches missed.">			if(logger.isDebugEnabled())</span>
			{
<span class="nc" id="L866">				logger.debug(&quot;GroovyCondition with scriptName '{}' and searchString '{}'&quot;, scriptName, text);</span>
			}
<span class="nc" id="L868">			File resolvedScriptFile = mainFrame.resolveConditionScriptFile(scriptName);</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">			if(resolvedScriptFile != null)</span>
			{
				// there is a file...
<span class="nc" id="L872">				condition = new GroovyCondition(resolvedScriptFile.getAbsolutePath(), text);</span>
			}
			else
			{
<span class="nc" id="L876">				errorMessage = &quot;Couldn't find groovy script '&quot; + scriptName + &quot;'.&quot;;</span>
<span class="nc" id="L877">				condition = null;</span>
			}
<span class="nc" id="L879">		}</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">		else if(text.startsWith(SAVED_CONDITION_IDENTIFIER))</span>
		{
<span class="nc" id="L882">			String conditionName = text.substring(SAVED_CONDITION_IDENTIFIER.length());</span>
<span class="nc" id="L883">			SavedCondition savedCondition = mainFrame.getApplicationPreferences().resolveSavedCondition(conditionName);</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">			if(savedCondition != null)</span>
			{
<span class="nc" id="L886">				condition = savedCondition.getCondition();</span>
			}
			else
			{
<span class="nc" id="L890">				errorMessage = &quot;Couldn't find saved condition '&quot; + conditionName + &quot;'.&quot;;</span>
<span class="nc" id="L891">				condition = null;</span>
			}
<span class="nc" id="L893">		}</span>
		else
		{
			// create condition matching the selected type
<span class="nc" id="L897">			String selectedType = (String) findTypeCombo.getSelectedItem();</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">			if(EVENT_CONTAINS_CONDITION.equals(selectedType))</span>
			{
<span class="nc" id="L900">				condition = new EventContainsCondition(text);</span>
			}
<span class="nc bnc" id="L902" title="All 2 branches missed.">			else if(MESSAGE_CONTAINS_CONDITION.equals(selectedType))</span>
			{
<span class="nc" id="L904">				condition = new MessageContainsCondition(text);</span>
			}
<span class="nc bnc" id="L906" title="All 2 branches missed.">			else if(LOGGER_STARTS_WITH_CONDITION.equals(selectedType))</span>
			{
<span class="nc" id="L908">				condition = new LoggerStartsWithCondition(text);</span>
			}
<span class="nc bnc" id="L910" title="All 2 branches missed.">			else if(LOGGER_EQUALS_CONDITION.equals(selectedType))</span>
			{
<span class="nc" id="L912">				condition = new LoggerEqualsCondition(text);</span>
			}
			else
			{
				// we assume a groovy condition...
<span class="nc" id="L917">				File resolvedScriptFile = mainFrame.resolveConditionScriptFile(selectedType);</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">				if(resolvedScriptFile != null)</span>
				{
					// there is a file...
<span class="nc" id="L921">					condition = new GroovyCondition(resolvedScriptFile.getAbsolutePath(), text);</span>
				}
				else
				{
<span class="nc" id="L925">					condition = null;</span>
				}
			}
		}
<span class="nc bnc" id="L929" title="All 2 branches missed.">		if(errorMessage != null)</span>
		{
			// problem with condition
<span class="nc" id="L932">			findTextField.setBackground(ERROR_COLOR);</span>
<span class="nc" id="L933">			findTextField.setToolTipText(errorMessage);</span>
		}
		else
		{
<span class="nc" id="L937">			findTextField.setBackground(Color.WHITE);</span>
<span class="nc" id="L938">			findTextField.setToolTipText(null);</span>
		}
<span class="nc bnc" id="L940" title="All 2 branches missed.">		if(condition != null)</span>
		{
			// wrap in Not if not is selected.
<span class="nc bnc" id="L943" title="All 2 branches missed.">			if(findNotButton.isSelected())</span>
			{
<span class="nc" id="L945">				condition = new Not(condition);</span>
			}
		}
<span class="nc bnc" id="L948" title="All 2 branches missed.">		if(logger.isDebugEnabled()) logger.debug(&quot;Setting condition: {}&quot;, condition);</span>
<span class="nc" id="L949">		setFilterCondition(condition);</span>
<span class="nc" id="L950">	}</span>

	public void setFilterCondition(Condition condition)
	{
<span class="nc" id="L954">		Object old = this.filterCondition;</span>
<span class="nc" id="L955">		this.filterCondition = condition;</span>
<span class="nc" id="L956">		table.setFilterCondition(filterCondition);</span>
<span class="nc" id="L957">		firePropertyChange(FILTER_CONDITION_PROPERTY, old, condition);</span>
<span class="nc" id="L958">	}</span>

	public Condition getFilterCondition()
	{
<span class="nc" id="L962">		return filterCondition;</span>
	}

	public void clear()
	{
<span class="nc" id="L967">		tableModel.clear();</span>
<span class="nc" id="L968">		table.requestFocusInWindow();</span>
<span class="nc" id="L969">	}</span>

	public void findPrevious(int currentRow, Condition condition)
	{
<span class="nc bnc" id="L973" title="All 2 branches missed.">		if(condition != null)</span>
		{
<span class="nc" id="L975">			ProgressingCallable&lt;Long&gt; callable = new FindPreviousCallable&lt;T&gt;(tableModel, currentRow, condition);</span>
<span class="nc" id="L976">			executeFind(callable, &quot;Find previous&quot;, currentRow, condition);</span>
		}
<span class="nc" id="L978">	}</span>

	public void findNext(int currentRow, Condition condition)
	{
<span class="nc bnc" id="L982" title="All 2 branches missed.">		if(condition != null)</span>
		{
<span class="nc" id="L984">			ProgressingCallable&lt;Long&gt; callable = new FindNextCallable&lt;T&gt;(tableModel, currentRow, condition);</span>
<span class="nc" id="L985">			executeFind(callable, &quot;Find next&quot;, currentRow, condition);</span>
		}
<span class="nc" id="L987">	}</span>

	public void setSelectedRow(int row)
	{
<span class="nc bnc" id="L991" title="All 2 branches missed.">		if(row &gt; -1)</span>
		{
<span class="nc bnc" id="L993" title="All 2 branches missed.">			if(isScrollingToBottom())</span>
			{
<span class="nc" id="L995">				setScrollingToBottom(false);</span>
			}
<span class="nc" id="L997">			table.selectRow(row);</span>
		}
<span class="nc" id="L999">	}</span>

	public int getSelectedRow()
	{
<span class="nc" id="L1003">		ListSelectionModel selectionModel = table.getSelectionModel();</span>
<span class="nc" id="L1004">		return selectionModel.getLeadSelectionIndex();</span>
	}

	private void updateStatusText()
	{
<span class="nc" id="L1009">		int eventCount = tableModel.getRowCount();</span>
<span class="nc" id="L1010">		StringBuilder statusText = new StringBuilder();</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">		if(eventCount &lt; 1)</span>
		{
<span class="nc" id="L1013">			statusText.append(&quot;No events.&quot;);</span>
		}
		else
		{
<span class="nc bnc" id="L1017" title="All 2 branches missed.">			if(eventCount == 1)</span>
			{
<span class="nc" id="L1019">				statusText.append(&quot;One event.&quot;);</span>
			}
			else
			{
<span class="nc" id="L1023">				statusText.append(eventCountFormat.format(eventCount)).append(&quot; events.&quot;);</span>
			}
<span class="nc" id="L1025">			long size = getSizeOnDisk();</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">			if(size &gt; 0)</span>
			{
<span class="nc" id="L1028">				statusText.append(&quot;   Size on disk: &quot;)</span>
<span class="nc" id="L1029">					.append(HumanReadable.getHumanReadableSize(size, true, false)).append(&quot;bytes&quot;);</span>

<span class="nc" id="L1031">				statusText.append(&quot;   Average event: &quot;)</span>
<span class="nc" id="L1032">					.append(HumanReadable.getHumanReadableSize(size / eventCount, true, false)).append(&quot;bytes&quot;);</span>
			}
		}

<span class="nc" id="L1036">		statusLabel.setText(statusText.toString());</span>
<span class="nc" id="L1037">	}</span>

	protected long getSizeOnDisk()
	{
<span class="nc" id="L1041">		Buffer buffer = getEventSource().getBuffer();</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">		if(buffer instanceof CodecFileBuffer)</span>
		{
<span class="nc" id="L1044">			CodecFileBuffer cfb = (CodecFileBuffer) buffer;</span>
<span class="nc" id="L1045">			return cfb.getDataFile().length();</span>
		}
<span class="nc" id="L1047">		return -1;</span>
	}

	public Buffer&lt;EventWrapper&lt;T&gt;&gt; getSourceBuffer()
	{
<span class="nc" id="L1052">		Buffer&lt;EventWrapper&lt;T&gt;&gt; buffer = eventSource.getBuffer();</span>

<span class="nc bnc" id="L1054" title="All 2 branches missed.">		if(buffer instanceof FilteringBuffer)</span>
		{
<span class="nc" id="L1056">			FilteringBuffer&lt;EventWrapper&lt;T&gt;&gt; filteringBuffer = (FilteringBuffer&lt;EventWrapper&lt;T&gt;&gt;) buffer;</span>
<span class="nc" id="L1057">			return filteringBuffer.getSourceBuffer();</span>
		}
<span class="nc" id="L1059">		return buffer;</span>
	}

	public Condition getBufferCondition()
	{
<span class="nc" id="L1064">		Buffer&lt;EventWrapper&lt;T&gt;&gt; buffer = eventSource.getBuffer();</span>

<span class="nc bnc" id="L1066" title="All 2 branches missed.">		if(buffer instanceof FilteringBuffer)</span>
		{
<span class="nc" id="L1068">			FilteringBuffer&lt;EventWrapper&lt;T&gt;&gt; filteringBuffer = (FilteringBuffer&lt;EventWrapper&lt;T&gt;&gt;) buffer;</span>
<span class="nc" id="L1069">			return filteringBuffer.getCondition();</span>
		}
<span class="nc" id="L1071">		return null;</span>
	}

	public void copySelection()
	{
<span class="nc" id="L1076">		copyAction.actionPerformed(null);</span>
<span class="nc" id="L1077">	}</span>

	/**
	 * @return the combination of the tables filter condition and the condition of a filtered buffer.
	 */
	public Condition getCombinedCondition()
	{
<span class="nc" id="L1084">		Condition previousCondition = getBufferCondition();</span>

<span class="nc" id="L1086">		Condition currentFilter = table.getFilterCondition();</span>

<span class="nc bnc" id="L1088" title="All 2 branches missed.">		if(previousCondition == null)</span>
		{
<span class="nc" id="L1090">			return currentFilter;</span>
		}

		try
		{
			// clone the previous condition so we don't change it while active
<span class="nc" id="L1096">			Condition previousClone = previousCondition.clone();</span>
<span class="nc bnc" id="L1097" title="All 2 branches missed.">			if(currentFilter == null)</span>
			{
<span class="nc" id="L1099">				return previousClone;</span>
			}
			And and;
<span class="nc bnc" id="L1102" title="All 2 branches missed.">			if(previousClone instanceof And)</span>
			{
<span class="nc" id="L1104">				and = (And) previousClone;</span>
			}
			else
			{
<span class="nc" id="L1108">				and = new And();</span>
<span class="nc" id="L1109">				ArrayList&lt;Condition&gt; conditions = new ArrayList&lt;Condition&gt;();</span>
<span class="nc" id="L1110">				conditions.add(previousClone);</span>
<span class="nc" id="L1111">				and.setConditions(conditions);</span>
			}
<span class="nc" id="L1113">			List&lt;Condition&gt; conditions = and.getConditions();</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">			if(conditions == null)</span>
			{
<span class="nc" id="L1116">				conditions = new ArrayList&lt;Condition&gt;();</span>
			}
<span class="nc bnc" id="L1118" title="All 2 branches missed.">			if(!conditions.contains(currentFilter))</span>
			{
				// don't add duplicates
<span class="nc" id="L1121">				conditions.add(currentFilter);</span>
			}
<span class="nc bnc" id="L1123" title="All 2 branches missed.">			if(conditions.size() &gt; 1)</span>
			{
<span class="nc bnc" id="L1125" title="All 2 branches missed.">				if(logger.isInfoEnabled()) logger.info(&quot;Setting and-conditions: {}&quot;, conditions);</span>
<span class="nc" id="L1126">				and.setConditions(conditions);</span>
<span class="nc" id="L1127">				return and;</span>
			}
			else
			{
<span class="nc" id="L1131">				return currentFilter;</span>
			}
		}
<span class="nc" id="L1134">		catch(CloneNotSupportedException ex)</span>
		{
<span class="nc bnc" id="L1136" title="All 2 branches missed.">			if(logger.isWarnEnabled()) logger.warn(&quot;Exception while cloning!&quot;, ex);</span>
		}
<span class="nc" id="L1138">		return null;</span>
	}

	private void createFilteredView()
	{
<span class="nc" id="L1143">		ViewContainer&lt;T&gt; container = resolveContainer();</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">		if(container != null)</span>
		{
<span class="nc" id="L1146">			container.addFilteredView(this);</span>
		}
<span class="nc" id="L1148">	}</span>

	/**
	 * If the currently selected event is in a filtered tab, the same event is displayed in the
	 * unfiltered view.
	 */
	public void showUnfilteredEvent()
	{
<span class="nc" id="L1156">		int row = getSelectedRow();</span>
<span class="nc bnc" id="L1157" title="All 2 branches missed.">		if(row &gt;= 0)</span>
		{
<span class="nc" id="L1159">			ViewContainer&lt;T&gt; container = resolveContainer();</span>
<span class="nc bnc" id="L1160" title="All 2 branches missed.">			if(container != null)</span>
			{

<span class="nc" id="L1163">				Buffer&lt;EventWrapper&lt;T&gt;&gt; buffer = eventSource.getBuffer();</span>
<span class="nc bnc" id="L1164" title="All 2 branches missed.">				if(buffer instanceof FilteringBuffer)</span>
				{
<span class="nc" id="L1166">					FilteringBuffer&lt;EventWrapper&lt;T&gt;&gt; filteringBuffer = (FilteringBuffer&lt;EventWrapper&lt;T&gt;&gt;) buffer;</span>
<span class="nc" id="L1167">					long unfilteredRow = filteringBuffer.getSourceIndex(row);</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">					if(unfilteredRow &gt;= 0)</span>
					{
<span class="nc bnc" id="L1170" title="All 2 branches missed.">						if(logger.isInfoEnabled())</span>
						{
<span class="nc" id="L1172">							logger.info(&quot;Show unfiltered event {} for filtered event {}...&quot;, unfilteredRow, row);</span>
						}
<span class="nc" id="L1174">						EventWrapperViewPanel&lt;T&gt; defaultView = container.getDefaultView();</span>
<span class="nc" id="L1175">						container.showDefaultView();</span>
<span class="nc" id="L1176">						defaultView.setSelectedRow((int) unfilteredRow);</span>
					}
				}
			}
		}
<span class="nc" id="L1181">	}</span>

	private class TableMouseListener
		implements MouseListener
	{
		public TableMouseListener()
<span class="nc" id="L1187">		{</span>
<span class="nc" id="L1188">		}</span>

		public void mouseClicked(MouseEvent evt)
		{
<span class="nc bnc" id="L1192" title="All 2 branches missed.">			if(evt.isPopupTrigger())</span>
			{
<span class="nc" id="L1194">				showPopup(evt);</span>
			}
<span class="nc bnc" id="L1196" title="All 4 branches missed.">			else if(evt.getClickCount() &gt; 1 &amp;&amp; evt.getButton() == MouseEvent.BUTTON1)</span>
			{
<span class="nc bnc" id="L1198" title="All 2 branches missed.">				if((evt.getModifiersEx() &amp; InputEvent.SHIFT_DOWN_MASK) != 0)</span>
				{
<span class="nc" id="L1200">					Point p = evt.getPoint();</span>
<span class="nc" id="L1201">					EventWrapper&lt;T&gt; wrapper = getEventWrapper(p);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">					if(wrapper != null)</span>
					{
<span class="nc" id="L1204">						T event = wrapper.getEvent();</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">						if(event instanceof LoggingEvent)</span>
						{
<span class="nc" id="L1207">							LoggingEvent loggingEvent = (LoggingEvent) event;</span>
<span class="nc" id="L1208">							ExtendedStackTraceElement[] callStack = loggingEvent.getCallStack();</span>
<span class="nc bnc" id="L1209" title="All 4 branches missed.">							if(callStack != null &amp;&amp; callStack.length &gt; 0)</span>
							{
<span class="nc" id="L1211">								mainFrame.goToSource(callStack[0].getStackTraceElement());</span>
							}
						}
					}
<span class="nc" id="L1215">				}</span>
				else
				{
<span class="nc" id="L1218">					showUnfilteredEvent();</span>
				}
			}
<span class="nc" id="L1221">		}</span>


		private void showPopup(MouseEvent evt)
		{
<span class="nc" id="L1226">			Point p = evt.getPoint();</span>
<span class="nc" id="L1227">			EventWrapper&lt;T&gt; wrapper = getEventWrapper(p); // To ensure that the event below the mouse is selected.</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;Show popup at {} for event {}.&quot;, p, wrapper);</span>
<span class="nc" id="L1229">			mainFrame.showPopup(table, p);</span>
<span class="nc" id="L1230">		}</span>

		public void mousePressed(MouseEvent evt)
		{
<span class="nc bnc" id="L1234" title="All 2 branches missed.">			if(evt.isPopupTrigger())</span>
			{
<span class="nc" id="L1236">				showPopup(evt);</span>
			}
<span class="nc" id="L1238">		}</span>

		public void mouseReleased(MouseEvent evt)
		{
<span class="nc bnc" id="L1242" title="All 2 branches missed.">			if(evt.isPopupTrigger())</span>
			{
<span class="nc" id="L1244">				showPopup(evt);</span>
			}
<span class="nc" id="L1246">		}</span>

		public void mouseEntered(MouseEvent e)
		{
<span class="nc" id="L1250">		}</span>

		public void mouseExited(MouseEvent e)
		{
<span class="nc" id="L1254">		}</span>

	}

	private class EventViewMouseListener
		implements MouseListener
	{
		public EventViewMouseListener()
<span class="nc" id="L1262">		{</span>
<span class="nc" id="L1263">		}</span>

		private void showPopup(MouseEvent evt)
		{
<span class="nc" id="L1267">			Point p = evt.getPoint();</span>
<span class="nc" id="L1268">			mainFrame.showPopup(messagePane, p);</span>
<span class="nc" id="L1269">		}</span>

		public void mouseClicked(MouseEvent evt)
		{
<span class="nc" id="L1273">			messagePane.requestFocusInWindow();</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">			if(evt.isPopupTrigger())</span>
			{
<span class="nc" id="L1276">				showPopup(evt);</span>
			}
<span class="nc" id="L1278">		}</span>

		public void mousePressed(MouseEvent evt)
		{
<span class="nc bnc" id="L1282" title="All 2 branches missed.">			if(evt.isPopupTrigger())</span>
			{
<span class="nc" id="L1284">				showPopup(evt);</span>
			}
<span class="nc" id="L1286">		}</span>

		public void mouseReleased(MouseEvent evt)
		{
<span class="nc bnc" id="L1290" title="All 2 branches missed.">			if(evt.isPopupTrigger())</span>
			{
<span class="nc" id="L1292">				showPopup(evt);</span>
			}
<span class="nc" id="L1294">		}</span>

		public void mouseEntered(MouseEvent e)
		{
<span class="nc" id="L1298">		}</span>

		public void mouseExited(MouseEvent e)
		{
<span class="nc" id="L1302">		}</span>

	}

<span class="nc" id="L1306">	private class TableRowSelectionListener</span>
		implements ListSelectionListener
	{
<span class="nc" id="L1309">		private final Logger logger = LoggerFactory.getLogger(TableRowSelectionListener.class);</span>

		public void valueChanged(ListSelectionEvent e)
		{
<span class="nc" id="L1313">			int row = getSelectedRow();</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;Selected row: {}.&quot;, row);</span>

<span class="nc bnc" id="L1316" title="All 2 branches missed.">			if(row &gt;= 0)</span>
			{
<span class="nc" id="L1318">				EventWrapper&lt;T&gt; event = tableModel.getValueAt(row);</span>
<span class="nc" id="L1319">				setSelectedEvent(event);</span>
<span class="nc" id="L1320">				initMessage(event);</span>
<span class="nc" id="L1321">			}</span>
			else
			{
<span class="nc" id="L1324">				setSelectedEvent(null);</span>
<span class="nc" id="L1325">				resetMessage();</span>
			}
<span class="nc" id="L1327">		}</span>
	}

	/**
	 * Disables &quot;Scroll to Bottom&quot; in case of adjusting, i.e. if the scrollbar is dragged.
	 */
<span class="nc" id="L1333">	private class ScrollbarChangeListner</span>
		implements ChangeListener
	{
<span class="nc" id="L1336">		private final Logger logger = LoggerFactory.getLogger(ScrollbarChangeListner.class);</span>

		public void stateChanged(ChangeEvent evt)
		{
<span class="nc bnc" id="L1340" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;changeEvent: {}&quot;, evt);</span>

<span class="nc bnc" id="L1342" title="All 2 branches missed.">			if(isScrollingToBottom())</span>
			{
<span class="nc bnc" id="L1344" title="All 2 branches missed.">				if(verticalLogScrollbar.getModel().getValueIsAdjusting())</span>
				{
<span class="nc" id="L1346">					setScrollingToBottom(false);</span>
				}
			}
<span class="nc" id="L1349">		}</span>
	}

	public void focusTable()
	{
<span class="nc" id="L1354">		table.requestFocusInWindow();</span>
<span class="nc" id="L1355">	}</span>

	public void focusMessagePane()
	{
<span class="nc" id="L1359">		messagePane.requestFocusInWindow();</span>
<span class="nc" id="L1360">	}</span>

<span class="nc" id="L1362">	class EventWrapperViewChangeListener</span>
		implements PropertyChangeListener
	{
<span class="nc" id="L1365">		final Logger logger = LoggerFactory.getLogger(EventWrapperViewChangeListener.class);</span>

		public void propertyChange(PropertyChangeEvent event)
		{
<span class="nc" id="L1369">			String propertyName = event.getPropertyName();</span>
<span class="nc bnc" id="L1370" title="All 2 branches missed.">			if(EventWrapperViewTable.SCROLLING_TO_BOTTOM_PROPERTY.equals(propertyName))</span>
			{
<span class="nc" id="L1372">				Object oldValue = event.getOldValue();</span>
<span class="nc" id="L1373">				Object newValue = event.getNewValue();</span>
<span class="nc" id="L1374">				firePropertyChange(SCROLLING_TO_BOTTOM_PROPERTY, oldValue, newValue);</span>
<span class="nc" id="L1375">			}</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">			else if(EventWrapperViewTable.FILTER_CONDITION_PROPERTY.equals(propertyName))</span>
			{
<span class="nc bnc" id="L1378" title="All 2 branches missed.">				if(null == event.getNewValue())</span>
				{
<span class="nc" id="L1380">					findPrevAction.setEnabled(false);</span>
<span class="nc" id="L1381">					findNextAction.setEnabled(false);</span>
				}
				else
				{
<span class="nc" id="L1385">					findPrevAction.setEnabled(true);</span>
<span class="nc" id="L1386">					findNextAction.setEnabled(true);</span>
				}
			}
<span class="nc" id="L1389">		}</span>
	}

	private class ReplaceFilterAction
		extends AbstractAction
	{
		private static final long serialVersionUID = 3876315232050114189L;

		public ReplaceFilterAction()
<span class="nc" id="L1398">		{</span>
<span class="nc" id="L1399">			super();</span>
<span class="nc" id="L1400">			putValue(Action.SHORT_DESCRIPTION, &quot;Replace filter.&quot;);</span>
<span class="nc" id="L1401">			KeyStroke accelerator = KeyStrokes.resolveAcceleratorKeyStroke(&quot;shift ENTER&quot;);</span>
<span class="nc bnc" id="L1402" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;accelerator: {}&quot;, accelerator);</span>
<span class="nc" id="L1403">			putValue(Action.ACCELERATOR_KEY, accelerator);</span>
<span class="nc" id="L1404">		}</span>

		public void actionPerformed(ActionEvent e)
		{
<span class="nc bnc" id="L1408" title="All 2 branches missed.">			if(logger.isInfoEnabled()) logger.info(&quot;Replace filter.&quot;);</span>
<span class="nc" id="L1409">			ViewContainer&lt;T&gt; container = resolveContainer();</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">			if(container != null)</span>
			{
<span class="nc" id="L1412">				container.replaceFilteredView(EventWrapperViewPanel.this);</span>
			}
<span class="nc" id="L1414">		}</span>
	}

<span class="nc" id="L1417">	private class FindTextFieldListener</span>
		implements ActionListener, DocumentListener
	{

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1423">			applyFilter();</span>
<span class="nc bnc" id="L1424" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;modifiers: &quot; + e.getModifiers());</span>
<span class="nc" id="L1425">			findTextField.selectAll();</span>
<span class="nc" id="L1426">			createFilteredView();</span>
<span class="nc" id="L1427">		}</span>

		public void insertUpdate(DocumentEvent e)
		{
<span class="nc" id="L1431">			applyFilter();</span>
<span class="nc" id="L1432">		}</span>

		public void removeUpdate(DocumentEvent e)
		{
<span class="nc" id="L1436">			applyFilter();</span>
<span class="nc" id="L1437">		}</span>

		public void changedUpdate(DocumentEvent e)
		{
<span class="nc" id="L1441">			applyFilter();</span>
<span class="nc" id="L1442">		}</span>
	}

	/**
	 * This action has different enabled logic than the one in ViewActions
	 */
	private class FindNextAction
		extends AbstractAction
	{
		private static final long serialVersionUID = -6469494975854597398L;

		public FindNextAction()
<span class="nc" id="L1454">		{</span>
<span class="nc" id="L1455">			super();</span>
			Icon icon;
			{
<span class="nc" id="L1458">				URL url = EventWrapperViewPanel.class.getResource(&quot;/tango/16x16/actions/go-down.png&quot;);</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">				if(url != null)</span>
				{
<span class="nc" id="L1461">					icon = new ImageIcon(url);</span>
				}
				else
				{
<span class="nc" id="L1465">					icon = null;</span>
				}
			}
<span class="nc" id="L1468">			putValue(Action.SMALL_ICON, icon);</span>
<span class="nc" id="L1469">			putValue(Action.SHORT_DESCRIPTION, &quot;Find next.&quot;);</span>
<span class="nc" id="L1470">			KeyStroke accelerator = KeyStrokes.resolveAcceleratorKeyStroke(KeyStrokes.COMMAND_ALIAS + &quot; shift G&quot;);</span>
<span class="nc bnc" id="L1471" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;accelerator: {}&quot;, accelerator);</span>
<span class="nc" id="L1472">			putValue(Action.ACCELERATOR_KEY, accelerator);</span>
<span class="nc" id="L1473">		}</span>

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1477">			findNext(getSelectedRow(), getFilterCondition());</span>
<span class="nc" id="L1478">		}</span>
	}

	/**
	 * This action has different enabled logic than the one in ViewActions
	 */
	private class FindPreviousAction
		extends AbstractAction
	{
		private static final long serialVersionUID = -8192948220602398223L;

		public FindPreviousAction()
<span class="nc" id="L1490">		{</span>
<span class="nc" id="L1491">			super();</span>
			Icon icon;
			{
<span class="nc" id="L1494">				URL url = EventWrapperViewPanel.class.getResource(&quot;/tango/16x16/actions/go-up.png&quot;);</span>
<span class="nc bnc" id="L1495" title="All 2 branches missed.">				if(url != null)</span>
				{
<span class="nc" id="L1497">					icon = new ImageIcon(url);</span>
				}
				else
				{
<span class="nc" id="L1501">					icon = null;</span>
				}
			}
<span class="nc" id="L1504">			putValue(Action.SMALL_ICON, icon);</span>
<span class="nc" id="L1505">			putValue(Action.SHORT_DESCRIPTION, &quot;Find previous.&quot;);</span>
<span class="nc" id="L1506">			KeyStroke accelerator = KeyStrokes.resolveAcceleratorKeyStroke(KeyStrokes.COMMAND_ALIAS + &quot; G&quot;);</span>
<span class="nc bnc" id="L1507" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;accelerator: {}&quot;, accelerator);</span>
<span class="nc" id="L1508">			putValue(Action.ACCELERATOR_KEY, accelerator);</span>
<span class="nc" id="L1509">		}</span>

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1513">			findPrevious(getSelectedRow(), getFilterCondition());</span>
<span class="nc" id="L1514">		}</span>
	}

	private class CloseFindAction
		extends AbstractAction
	{
		private static final long serialVersionUID = -7757686292973276423L;

		public CloseFindAction()
<span class="nc" id="L1523">		{</span>
<span class="nc" id="L1524">			super();</span>
			Icon icon;
			{
<span class="nc" id="L1527">				URL url = EventWrapperViewPanel.class.getResource(&quot;/tango/16x16/emblems/emblem-unreadable.png&quot;);</span>
<span class="nc bnc" id="L1528" title="All 2 branches missed.">				if(url != null)</span>
				{
<span class="nc" id="L1530">					icon = new ImageIcon(url);</span>
				}
				else
				{
<span class="nc" id="L1534">					icon = null;</span>
				}
			}
<span class="nc" id="L1537">			putValue(Action.SMALL_ICON, icon);</span>
<span class="nc" id="L1538">			putValue(Action.SHORT_DESCRIPTION, &quot;Close&quot;);</span>
<span class="nc" id="L1539">			KeyStroke accelerator = KeyStrokes.resolveAcceleratorKeyStroke(&quot;ESCAPE&quot;);</span>
<span class="nc bnc" id="L1540" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;accelerator: {}&quot;, accelerator);</span>
<span class="nc" id="L1541">			putValue(Action.ACCELERATOR_KEY, accelerator);</span>
<span class="nc" id="L1542">		}</span>

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1546">			ViewContainer&lt;T&gt; container = resolveContainer();</span>
<span class="nc bnc" id="L1547" title="All 2 branches missed.">			if(container != null)</span>
			{
<span class="nc" id="L1549">				ProgressGlassPane progressPanel = container.getProgressPanel();</span>
<span class="nc" id="L1550">				progressPanel.getFindCancelAction().cancelSearch();</span>
<span class="nc" id="L1551">				setShowingFilters(false);</span>
			}
<span class="nc" id="L1553">		}</span>
	}

	private void executeFind(Callable&lt;Long&gt; callable, String name, int currentRow, Condition condition)
	{
<span class="nc" id="L1558">		Map&lt;String, String&gt; metaData = CallableMetaData.createFindMetaData(condition, eventSource, currentRow);</span>

<span class="nc" id="L1560">		String description = &quot;Executing '&quot; + name + &quot;' for condition &quot; + metaData</span>
<span class="nc" id="L1561">			.get(CallableMetaData.FIND_TASK_META_CONDITION)</span>
			+ &quot; on &quot; + metaData
<span class="nc" id="L1563">			.get(CallableMetaData.FIND_TASK_META_SOURCE_IDENTIFIER) + &quot; starting at row &quot; + currentRow + &quot;.&quot;;</span>

<span class="nc" id="L1565">		enableFindComponents(false);</span>
<span class="nc" id="L1566">		findResultListener.setCallable(callable);</span>
<span class="nc" id="L1567">		Task&lt;Long&gt; task = taskManager.startTask(callable, name, description, metaData);</span>
<span class="nc" id="L1568">		ViewContainer&lt;T&gt; container = resolveContainer();</span>
<span class="nc bnc" id="L1569" title="All 2 branches missed.">		if(container != null)</span>
		{
<span class="nc" id="L1571">			container.showSearchPanel(task);</span>
		}
<span class="nc" id="L1573">	}</span>

<span class="nc" id="L1575">	class FindResultListener</span>
		implements TaskListener&lt;Long&gt;
	{
		private Callable&lt;Long&gt; callable;

		public void taskCreated(Task&lt;Long&gt; longTask)
		{

<span class="nc" id="L1583">		}</span>

		public void executionFailed(Task&lt;Long&gt; task, ExecutionException exception)
		{
<span class="nc bnc" id="L1587" title="All 2 branches missed.">			if(logger.isDebugEnabled())</span>
			{
<span class="nc" id="L1589">				logger.debug(&quot;in executionFailed:\n     task: {}\nthis.callable: {}&quot;, task, this.callable);</span>
			}
<span class="nc bnc" id="L1591" title="All 2 branches missed.">			if(this.callable == task.getCallable())</span>
			{
<span class="nc bnc" id="L1593" title="All 2 branches missed.">				if(logger.isInfoEnabled()) logger.info(&quot;Find execution failed!&quot;, exception);</span>
<span class="nc" id="L1594">				finished();</span>
			}
<span class="nc" id="L1596">		}</span>

		public void executionFinished(Task&lt;Long&gt; task, Long result)
		{
<span class="nc bnc" id="L1600" title="All 2 branches missed.">			if(logger.isDebugEnabled())</span>
			{
<span class="nc" id="L1602">				logger.debug(&quot;in executionFinished:\n     task: {}\nthis.callable: {}&quot;, task, this.callable);</span>
			}
<span class="nc bnc" id="L1604" title="All 2 branches missed.">			if(this.callable == task.getCallable())</span>
			{
<span class="nc bnc" id="L1606" title="All 2 branches missed.">				if(logger.isInfoEnabled()) logger.info(&quot;Find execution finished: {}!&quot;, result);</span>
<span class="nc bnc" id="L1607" title="All 4 branches missed.">				if(result != null &amp;&amp; result &gt;= 0)</span>
				{
<span class="nc" id="L1609">					int row = result.intValue(); // this will always work</span>
<span class="nc" id="L1610">					setSelectedRow(row);</span>
				}
<span class="nc" id="L1612">				finished();</span>
			}
<span class="nc" id="L1614">		}</span>

		public void executionCanceled(Task&lt;Long&gt; task)
		{
<span class="nc bnc" id="L1618" title="All 2 branches missed.">			if(logger.isDebugEnabled())</span>
			{
<span class="nc" id="L1620">				logger.debug(&quot;in executionCanceled:\n     task: {}\nthis.callable: {}&quot;, task, this.callable);</span>
			}
<span class="nc bnc" id="L1622" title="All 2 branches missed.">			if(this.callable == task.getCallable())</span>
			{
<span class="nc bnc" id="L1624" title="All 2 branches missed.">				if(logger.isInfoEnabled()) logger.info(&quot;Find execution canceled.&quot;);</span>
<span class="nc" id="L1625">				finished();</span>
			}
<span class="nc" id="L1627">		}</span>

		public void progressUpdated(Task&lt;Long&gt; task, int progress)
		{
<span class="nc bnc" id="L1631" title="All 2 branches missed.">			if(logger.isDebugEnabled())</span>
			{
<span class="nc" id="L1633">				logger</span>
<span class="nc" id="L1634">					.debug(&quot;in progressUpdated:\task: {}\n   this.callable: {}&quot;, task, this.callable);</span>
			}
<span class="nc bnc" id="L1636" title="All 2 branches missed.">			if(this.callable == task.getCallable())</span>
			{
				// to catch updates after cancel.
<span class="nc bnc" id="L1639" title="All 2 branches missed.">				if(logger.isDebugEnabled()) logger.debug(&quot;Progress update: {}&quot;, progress);</span>
<span class="nc" id="L1640">				ViewContainer&lt;T&gt; container = resolveContainer();</span>
<span class="nc bnc" id="L1641" title="All 2 branches missed.">				if(container != null)</span>
				{
<span class="nc" id="L1643">					ProgressGlassPane progressPanel = container.getProgressPanel();</span>
<span class="nc" id="L1644">					progressPanel.setProgress(progress);</span>
				}
			}
<span class="nc" id="L1647">		}</span>

		private void finished()
		{
<span class="nc bnc" id="L1651" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;Executing FindResultListener.finished().&quot;);</span>

<span class="nc" id="L1653">			ViewContainer&lt;T&gt; container = resolveContainer();</span>
<span class="nc bnc" id="L1654" title="All 2 branches missed.">			if(container != null)</span>
			{
<span class="nc" id="L1656">				ProgressGlassPane progressPanel = container.getProgressPanel();</span>
<span class="nc" id="L1657">				progressPanel.getFindCancelAction().setTask(null);</span>
<span class="nc" id="L1658">				setCallable(null);</span>
<span class="nc" id="L1659">				container.hideSearchPanel();</span>
			}

<span class="nc" id="L1662">			enableFindComponents(true);</span>
<span class="nc" id="L1663">		}</span>

		public void setCallable(Callable&lt;Long&gt; callable)
		{
<span class="nc bnc" id="L1667" title="All 2 branches missed.">			if(logger.isDebugEnabled())</span>
			{
				//noinspection ThrowableInstanceNeverThrown
<span class="nc" id="L1670">				logger</span>
<span class="nc" id="L1671">					.debug(&quot;Setting task...\n     newCallable: &quot; + callable + &quot;\npreviousCallable: &quot; + this.callable, new Throwable());</span>
			}
<span class="nc" id="L1673">			this.callable = callable;</span>
<span class="nc" id="L1674">		}</span>
	}

	void enableFindComponents(boolean enabled)
	{
<span class="nc" id="L1679">		closeFindAction.setEnabled(enabled);</span>
<span class="nc" id="L1680">		findTextField.setEnabled(enabled);</span>
<span class="nc bnc" id="L1681" title="All 2 branches missed.">		if(table.getFilterCondition() != null)</span>
		{
<span class="nc" id="L1683">			findPrevAction.setEnabled(enabled);</span>
<span class="nc" id="L1684">			findNextAction.setEnabled(enabled);</span>
		}
		else
		{
<span class="nc" id="L1688">			findPrevAction.setEnabled(false);</span>
<span class="nc" id="L1689">			findNextAction.setEnabled(false);</span>
		}
<span class="nc" id="L1691">	}</span>

	protected abstract void closeConnection(SourceIdentifier sourceIdentifier);

<span class="nc" id="L1695">	private class StatusTableModelListener</span>
		implements TableModelListener
	{

		public void tableChanged(TableModelEvent e)
		{
<span class="nc bnc" id="L1701" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;TableModelEvent: {}&quot;, e);</span>
<span class="nc" id="L1702">			updateStatusText();</span>
<span class="nc" id="L1703">		}</span>
	}

<span class="nc" id="L1706">	private class FindTypeSelectionActionListener</span>
		implements ActionListener
	{

		public void actionPerformed(ActionEvent e)
		{
<span class="nc" id="L1712">			applyFilter();</span>
<span class="nc" id="L1713">		}</span>
	}

<span class="nc" id="L1716">	private class SplitPaneListener</span>
		implements PropertyChangeListener
	{
		public void propertyChange(PropertyChangeEvent evt)
		{
<span class="nc bnc" id="L1721" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;Splitpane change!&quot;);</span>
<span class="nc" id="L1722">			String propertyName = evt.getPropertyName();</span>
<span class="nc bnc" id="L1723" title="All 2 branches missed.">			if(&quot;dividerLocation&quot;.equals(propertyName))</span>
			{
<span class="nc" id="L1725">				scrollToEvent();</span>
			}
<span class="nc" id="L1727">		}</span>
	}

<span class="nc" id="L1730">	private class MessageFocusListener</span>
		implements FocusListener
	{

		public void focusGained(FocusEvent e)
		{
<span class="nc" id="L1736">			messagePane.setBorder(focusedBorder);</span>
<span class="nc" id="L1737">		}</span>

		public void focusLost(FocusEvent e)
		{
<span class="nc" id="L1741">			messagePane.setBorder(unfocusedBorder);</span>
<span class="nc" id="L1742">		}</span>
	}
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>