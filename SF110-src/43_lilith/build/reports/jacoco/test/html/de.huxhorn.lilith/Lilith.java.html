<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Lilith.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">43_lilith</a> &gt; <a href="index.source.html" class="el_package">de.huxhorn.lilith</a> &gt; <span class="el_source">Lilith.java</span></div><h1>Lilith.java</h1><pre class="source lang-java linenums">/*
 * Lilith - a log event viewer.
 * Copyright (C) 2007-2009 Joern Huxhorn
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package de.huxhorn.lilith;

import de.huxhorn.lilith.appender.InternalLilithAppender;
import de.huxhorn.lilith.handler.Slf4JHandler;
import de.huxhorn.lilith.swing.ApplicationPreferences;
import de.huxhorn.lilith.swing.LicenseAgreementDialog;
import de.huxhorn.lilith.swing.MainFrame;
import de.huxhorn.lilith.swing.SplashScreen;
import de.huxhorn.lilith.swing.callables.IndexingCallable;
import de.huxhorn.sulky.sounds.jlayer.JLayerSounds;
import de.huxhorn.sulky.swing.Windows;
import de.huxhorn.sulky.tasks.ProgressingCallable;

import ch.qos.logback.classic.LoggerContext;
import ch.qos.logback.classic.joran.JoranConfigurator;
import ch.qos.logback.core.joran.spi.JoranException;
import ch.qos.logback.core.util.StatusPrinter;
import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.CommandLineParser;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.apache.commons.cli.PosixParser;
import org.apache.commons.io.FileUtils;
import org.apache.commons.io.IOUtils;
import org.simplericity.macify.eawt.Application;
import org.simplericity.macify.eawt.DefaultApplication;
import org.slf4j.ILoggerFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintStream;
import java.lang.reflect.InvocationTargetException;
import java.net.URL;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Properties;
import java.util.logging.Handler;

import javax.swing.*;

<span class="nc" id="L67">public class Lilith</span>
{
	public static final String APP_NAME;
	public static final String APP_VERSION;
	public static final String APP_BUILD_NUMBER;
	public static final long APP_TIMESTAMP;

	private static final String VERBOSE_SHORT = &quot;v&quot;;
	private static final String PRINT_HELP_SHORT = &quot;h&quot;;
	private static final String FLUSH_PREFERENCES_SHORT = &quot;F&quot;;
	private static final String FLUSH_LICENSED_SHORT = &quot;L&quot;;
	private static final String INDEX_SHORT = &quot;i&quot;;
	private static final String ENABLE_BONJOUR_SHORT = &quot;b&quot;;
	private static final String CREATE_MD5_SHORT = &quot;m&quot;;

	private static final String VERBOSE = &quot;verbose&quot;;
	private static final String PRINT_HELP = &quot;help&quot;;
	private static final String FLUSH_PREFERENCES = &quot;flushPrefs&quot;;
	private static final String FLUSH_LICENSED = &quot;flushLicensed&quot;;
	private static final String INDEX = &quot;indexFile&quot;;
	private static final String ENABLE_BONJOUR = &quot;bonjour&quot;;
	private static final String CREATE_MD5 = &quot;md5&quot;;


	private static Thread.UncaughtExceptionHandler uncaughtExceptionHandler;

	static
	{
		// I access InternalLilithAppender *before* any Logger is used.
		// Otherwise an obscure ClassNotFoundException is thrown in MainFrame.
<span class="nc" id="L97">		InternalLilithAppender.getSourceIdentifier();</span>

<span class="nc" id="L99">		final Logger logger = LoggerFactory.getLogger(Lilith.class);</span>

<span class="nc" id="L101">		InputStream is = Lilith.class.getResourceAsStream(&quot;/app.properties&quot;);</span>
<span class="nc" id="L102">		Properties p = new Properties();</span>
		try
		{
<span class="nc" id="L105">			p.load(is);</span>
		}
<span class="nc" id="L107">		catch(IOException ex)</span>
		{
<span class="nc bnc" id="L109" title="All 2 branches missed.">			if(logger.isErrorEnabled()) logger.error(&quot;Couldn't find app info resource!&quot;, ex);</span>
			//ex.printStackTrace();
		}
		finally
		{
<span class="nc" id="L114">			IOUtils.closeQuietly(is);</span>
		}
<span class="nc" id="L116">		APP_NAME = p.getProperty(&quot;application.name&quot;);</span>
<span class="nc" id="L117">		APP_VERSION = p.getProperty(&quot;application.version&quot;);</span>
<span class="nc" id="L118">		APP_BUILD_NUMBER = p.getProperty(&quot;application.buildNumber&quot;);</span>
<span class="nc" id="L119">		String tsStr = p.getProperty(&quot;application.timestamp&quot;);</span>
<span class="nc" id="L120">		long ts = -1;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if(tsStr != null)</span>
		{
			try
			{
<span class="nc" id="L125">				ts = Long.parseLong(tsStr);</span>
			}
<span class="nc" id="L127">			catch(NumberFormatException ex)</span>
			{
<span class="nc bnc" id="L129" title="All 2 branches missed.">				if(logger.isErrorEnabled()) logger.error(&quot;Exception while reading timestamp!&quot;, ex);</span>
<span class="nc" id="L130">			}</span>
		}
		else
		{
<span class="nc bnc" id="L134" title="All 2 branches missed.">			if(logger.isErrorEnabled()) logger.error(&quot;Application-timestamp not found!&quot;);</span>
		}

<span class="nc" id="L137">		APP_TIMESTAMP = ts;</span>
<span class="nc" id="L138">	}</span>

	// TODO: - Shortcut in tooltip of toolbars...?
	// TODO: - check termination of every started thread

	public static void main(String args[])
	{
<span class="nc" id="L145">		final Logger logger = LoggerFactory.getLogger(Lilith.class);</span>

		{
			// initialize java.util.logging to use slf4j...
<span class="nc" id="L149">			Handler handler = new Slf4JHandler();</span>
<span class="nc" id="L150">			java.util.logging.Logger rootLogger = java.util.logging.Logger.getLogger(&quot;&quot;);</span>
<span class="nc" id="L151">			rootLogger.addHandler(handler);</span>
<span class="nc" id="L152">			rootLogger.setLevel(java.util.logging.Level.WARNING);</span>
		}

<span class="nc" id="L155">		CommandLineParser parser = new PosixParser();</span>

<span class="nc" id="L157">		Options options = new Options();</span>
<span class="nc" id="L158">		options.addOption(PRINT_HELP_SHORT, PRINT_HELP, false, &quot;show this help.&quot;);</span>
<span class="nc" id="L159">		options.addOption(VERBOSE_SHORT, VERBOSE, false, &quot;show more info.&quot;);</span>
<span class="nc" id="L160">		options.addOption(FLUSH_PREFERENCES_SHORT, FLUSH_PREFERENCES, false, &quot;flush gui preferences.&quot;);</span>
<span class="nc" id="L161">		options.addOption(FLUSH_LICENSED_SHORT, FLUSH_LICENSED, false, &quot;flush licensed.&quot;);</span>
<span class="nc" id="L162">		options.addOption(ENABLE_BONJOUR_SHORT, ENABLE_BONJOUR, false, &quot;disable Bonjor.&quot;);</span>
<span class="nc" id="L163">		options.addOption(INDEX_SHORT, INDEX, false, &quot;indexes the given file.&quot;);</span>
<span class="nc" id="L164">		options.addOption(CREATE_MD5_SHORT, CREATE_MD5, false, &quot;create an MD5 checksum for the given file.&quot;);</span>
<span class="nc" id="L165">		boolean verbose = false;</span>
<span class="nc" id="L166">		boolean flushPrefs = false;</span>
<span class="nc" id="L167">		boolean flushLicensed = false;</span>
<span class="nc" id="L168">		boolean enableBonjour = false;</span>
<span class="nc" id="L169">		boolean indexFileOpt = false;</span>
<span class="nc" id="L170">		boolean createMd5 = false;</span>
		boolean printHelp;
<span class="nc" id="L172">		String[] originalArgs = args;</span>
<span class="nc" id="L173">		int exitCode = 0;</span>
		try
		{
			// parse the command line arguments
<span class="nc" id="L177">			CommandLine line = parser.parse(options, args);</span>

<span class="nc" id="L179">			verbose = line.hasOption(VERBOSE_SHORT);</span>
<span class="nc" id="L180">			printHelp = line.hasOption(PRINT_HELP_SHORT);</span>
<span class="nc" id="L181">			flushPrefs = line.hasOption(FLUSH_PREFERENCES_SHORT);</span>
<span class="nc" id="L182">			flushLicensed = line.hasOption(FLUSH_LICENSED_SHORT);</span>
<span class="nc" id="L183">			enableBonjour = line.hasOption(ENABLE_BONJOUR_SHORT);</span>
<span class="nc" id="L184">			indexFileOpt = line.hasOption(INDEX_SHORT);</span>
<span class="nc" id="L185">			createMd5 = line.hasOption(CREATE_MD5_SHORT);</span>
<span class="nc" id="L186">			args = line.getArgs(); // remaining unparsed args...</span>
		}
<span class="nc" id="L188">		catch(ParseException exp)</span>
		{
<span class="nc" id="L190">			exitCode = -1;</span>
<span class="nc" id="L191">			printHelp = true;</span>
<span class="nc" id="L192">		}</span>

<span class="nc" id="L194">		String appTitle = APP_NAME + &quot; V&quot; + APP_VERSION + &quot;.&quot; + APP_BUILD_NUMBER;</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if(verbose)</span>
		{
<span class="nc" id="L197">			SimpleDateFormat sdf = new SimpleDateFormat(&quot;yyyy-MM-dd'T'HH:mm:ss&quot;);</span>
<span class="nc" id="L198">			Date d = new Date(APP_TIMESTAMP);</span>

<span class="nc" id="L200">			appTitle += &quot; - &quot; + sdf.format(d);</span>
		}
<span class="nc" id="L202">		System.out.println(&quot; _     _ _ _ _   _     \n&quot; +</span>
			&quot;| |   (_) (_) |_| |__  \n&quot; +
			&quot;| |   | | | | __| '_ \\ \n&quot; +
			&quot;| |___| | | | |_| | | |\n&quot; +
			&quot;|_____|_|_|_|\\__|_| |_|&quot;);
<span class="nc" id="L207">		System.out.println(appTitle);</span>
<span class="nc" id="L208">		System.out.println(&quot;\nCopyright (C) 2007-2008  Joern Huxhorn\n\n&quot; +</span>
			&quot;This program comes with ABSOLUTELY NO WARRANTY!\n\n&quot; +
			&quot;This is free software, and you are welcome to redistribute it\n&quot; +
			&quot;under certain conditions.\n&quot; +
			&quot;You should have received a copy of the GNU General Public License\n&quot; +
			&quot;along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.\n&quot;);
<span class="nc" id="L214">		System.out.println(&quot;Use commandline option -h to view help.\n\n&quot;);</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">		if(createMd5)</span>
		{
<span class="nc" id="L218">			File input = new File(args[0]);</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">			if(!input.isFile())</span>
			{
<span class="nc bnc" id="L222" title="All 2 branches missed.">				if(logger.isWarnEnabled()) logger.warn(&quot;{} isn't a file!&quot;, input.getAbsolutePath());</span>
<span class="nc" id="L223">				return;</span>
			}
<span class="nc" id="L225">			File output = new File(input.getParentFile(), input.getName() + &quot;.md5&quot;);</span>

			try
			{

<span class="nc" id="L230">				FileInputStream fis = new FileInputStream(input);</span>
<span class="nc" id="L231">				byte[] md5 = ApplicationPreferences.getMD5(fis);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">				if(md5 == null)</span>
				{
<span class="nc bnc" id="L234" title="All 2 branches missed.">					if(logger.isWarnEnabled())</span>
					{
<span class="nc" id="L236">						logger.warn(&quot;Couldn't calculate checksum for {}!&quot;, input.getAbsolutePath());</span>
					}
<span class="nc" id="L238">					return;</span>
				}
<span class="nc" id="L240">				FileOutputStream fos = new FileOutputStream(output);</span>
<span class="nc" id="L241">				fos.write(md5);</span>
<span class="nc" id="L242">				fos.close();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">				if(logger.isInfoEnabled())</span>
				{
<span class="nc" id="L245">					logger.info(&quot;Wrote checksum of {} to {}.&quot;, input.getAbsolutePath(), output.getAbsolutePath());</span>
				}
			}
<span class="nc" id="L248">			catch(IOException e)</span>
			{
<span class="nc bnc" id="L250" title="All 2 branches missed.">				if(logger.isWarnEnabled()) logger.warn(&quot;Exception while creating checksum!&quot;, e);</span>
<span class="nc" id="L251">			}</span>
<span class="nc" id="L252">			return;</span>
		}

<span class="nc bnc" id="L255" title="All 2 branches missed.">		if(verbose)</span>
		{
<span class="nc bnc" id="L257" title="All 2 branches missed.">			for(int i = 0; i &lt; originalArgs.length; i++)</span>
			{
<span class="nc" id="L259">				System.out.println(&quot;originalArgs[&quot; + i + &quot;]: &quot; + originalArgs[i]);</span>
			}
<span class="nc bnc" id="L261" title="All 2 branches missed.">			for(int i = 0; i &lt; args.length; i++)</span>
			{
<span class="nc" id="L263">				System.out.println(&quot;args[&quot; + i + &quot;]: &quot; + args[i]);</span>
			}
<span class="nc" id="L265">			System.out.println(&quot;\n&quot;);</span>
		}

<span class="nc" id="L268">		ILoggerFactory loggerFactory = LoggerFactory.getILoggerFactory();</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if(loggerFactory instanceof LoggerContext)</span>
		{
<span class="nc" id="L271">			LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if(verbose)</span>
			{
				// reset previous configuration initially loaded from logback.xml
<span class="nc" id="L275">				loggerContext.reset();</span>
<span class="nc" id="L276">				JoranConfigurator configurator = new JoranConfigurator();</span>
<span class="nc" id="L277">				configurator.setContext(loggerContext);</span>
				URL configUrl;
<span class="nc" id="L279">				configUrl = Lilith.class.getResource(&quot;/logbackVerbose.xml&quot;);</span>
				try
				{
<span class="nc" id="L282">					configurator.doConfigure(configUrl);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">					if(logger.isDebugEnabled()) logger.debug(&quot;Configured logging with {}.&quot;, configUrl);</span>
<span class="nc" id="L284">					StatusPrinter.print(loggerContext);</span>
				}
<span class="nc" id="L286">				catch(JoranException ex)</span>
				{
<span class="nc bnc" id="L288" title="All 2 branches missed.">					if(logger.isErrorEnabled()) logger.error(&quot;Error configuring logging framework!&quot;, ex);</span>
<span class="nc" id="L289">					StatusPrinter.print(loggerContext);</span>
<span class="nc" id="L290">				}</span>
			}
		}

<span class="nc bnc" id="L294" title="All 2 branches missed.">		if(flushPrefs)</span>
		{
<span class="nc" id="L296">			ApplicationPreferences prefs = new ApplicationPreferences();</span>
<span class="nc" id="L297">			prefs.reset();</span>
<span class="nc" id="L298">			prefs.setLicensed(false);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">			if(logger.isInfoEnabled()) logger.info(&quot;Flushed preferences...&quot;);</span>
<span class="nc" id="L300">			return;</span>
		}

<span class="nc bnc" id="L303" title="All 2 branches missed.">		if(flushLicensed)</span>
		{
<span class="nc" id="L305">			ApplicationPreferences prefs = new ApplicationPreferences();</span>
<span class="nc" id="L306">			prefs.setLicensed(false);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">			if(logger.isInfoEnabled()) logger.info(&quot;Flushed licensed...&quot;);</span>
<span class="nc" id="L308">			return;</span>
		}

<span class="nc bnc" id="L311" title="All 2 branches missed.">		if(printHelp)</span>
		{
<span class="nc" id="L313">			HelpFormatter formatter = new HelpFormatter();</span>
<span class="nc" id="L314">			formatter.printHelp(&quot;lilith&quot;, options);</span>
<span class="nc" id="L315">			System.exit(exitCode);</span>
		}

<span class="nc bnc" id="L318" title="All 2 branches missed.">		if(indexFileOpt)</span>
		{
<span class="nc bnc" id="L320" title="All 2 branches missed.">			if(args.length &gt;= 2)</span>
			{
<span class="nc" id="L322">				String logFileStr = args[0];</span>
<span class="nc" id="L323">				String indexFileStr = args[1];</span>
<span class="nc" id="L324">				File logFile = new File(logFileStr);</span>
<span class="nc" id="L325">				File indexFile = new File(indexFileStr);</span>
<span class="nc" id="L326">				IndexingCallable callable = new IndexingCallable(logFile, indexFile);</span>
<span class="nc" id="L327">				callable.addPropertyChangeListener(new IndexingChangeListener());</span>
				try
				{
<span class="nc" id="L330">					long count = callable.call();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">					if(logger.isInfoEnabled())</span>
					{
<span class="nc" id="L333">						logger.info(&quot;Finished indexing {}. Number of events: {}&quot;, logFile.getAbsolutePath(), count);</span>
					}
<span class="nc" id="L335">					System.exit(0);</span>
				}
<span class="nc" id="L337">				catch(Exception e)</span>
				{
<span class="nc bnc" id="L339" title="All 2 branches missed.">					if(logger.isErrorEnabled())</span>
					{
<span class="nc" id="L341">						logger.error(&quot;Exception while indexing '&quot; + logFile.getAbsolutePath() + &quot;'!&quot;, e);</span>
					}
<span class="nc" id="L343">					System.exit(-1);</span>
<span class="nc" id="L344">				}</span>

			}
<span class="nc bnc" id="L347" title="All 2 branches missed.">			if(logger.isErrorEnabled()) logger.error(&quot;Missing file argument!&quot;);</span>
<span class="nc" id="L348">			System.exit(-1);</span>
		}

<span class="nc" id="L351">		uncaughtExceptionHandler = new Thread.UncaughtExceptionHandler()</span>
<span class="nc" id="L352">		{</span>
			public void uncaughtException(Thread t, Throwable e)
			{
<span class="nc" id="L355">				System.err.println(&quot;\n-----\nThread &quot; + t.getName() + &quot; threw an exception!&quot;);</span>
<span class="nc" id="L356">				e.printStackTrace(System.err);</span>
<span class="nc" id="L357">			}</span>
		};

<span class="nc" id="L360">		Thread.setDefaultUncaughtExceptionHandler(uncaughtExceptionHandler);</span>

<span class="nc" id="L362">		SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L363">		{</span>

			public void run()
			{
<span class="nc" id="L367">				Thread.currentThread().setUncaughtExceptionHandler(uncaughtExceptionHandler);</span>
<span class="nc" id="L368">			}</span>
		});
<span class="nc" id="L370">		startUI(appTitle, enableBonjour);</span>
<span class="nc" id="L371">	}</span>

	private static void updateSplashStatus(final SplashScreen splashScreen, final String status)
		throws InvocationTargetException, InterruptedException
	{
<span class="nc bnc" id="L376" title="All 2 branches missed.">		if(splashScreen != null)</span>
		{
<span class="nc" id="L378">			SwingUtilities.invokeAndWait(new Runnable()</span>
<span class="nc" id="L379">			{</span>

				public void run()
				{
<span class="nc bnc" id="L383" title="All 2 branches missed.">					if(!splashScreen.isVisible())</span>
					{
<span class="nc" id="L385">						Windows.showWindow(splashScreen, null, true);</span>
					}
<span class="nc" id="L387">					splashScreen.toFront();</span>
<span class="nc" id="L388">					splashScreen.setStatusText(status);</span>
<span class="nc" id="L389">				}</span>
			});
		}
<span class="nc" id="L392">	}</span>

	private static void hideSplashScreen(final SplashScreen splashScreen)
		throws InvocationTargetException, InterruptedException
	{
<span class="nc bnc" id="L397" title="All 2 branches missed.">		if(splashScreen != null)</span>
		{
<span class="nc" id="L399">			SwingUtilities.invokeAndWait(new Runnable()</span>
<span class="nc" id="L400">			{</span>
				public void run()
				{
<span class="nc" id="L403">					splashScreen.setVisible(false);</span>
<span class="nc" id="L404">				}</span>
			});
		}
<span class="nc" id="L407">	}</span>

	public static void startUI(final String appTitle, boolean enableBonjour)
	{
<span class="nc" id="L411">		final Logger logger = LoggerFactory.getLogger(Lilith.class);</span>
<span class="nc" id="L412">		UIManager.installLookAndFeel(&quot;JGoodies Windows&quot;, &quot;com.jgoodies.looks.windows.WindowsLookAndFeel&quot;);</span>
<span class="nc" id="L413">		UIManager.installLookAndFeel(&quot;JGoodies Plastic&quot;, &quot;com.jgoodies.looks.plastic.PlasticLookAndFeel&quot;);</span>
<span class="nc" id="L414">		UIManager.installLookAndFeel(&quot;JGoodies Plastic 3D&quot;, &quot;com.jgoodies.looks.plastic.Plastic3DLookAndFeel&quot;);</span>
<span class="nc" id="L415">		UIManager.installLookAndFeel(&quot;JGoodies Plastic XP&quot;, &quot;com.jgoodies.looks.plastic.PlasticXPLookAndFeel&quot;);</span>
		//UIManager.installLookAndFeel(&quot;Napkin&quot;, &quot;net.sourceforge.napkinlaf.NapkinLookAndFeel&quot;);
<span class="nc" id="L417">		Application application = new DefaultApplication();</span>
<span class="nc" id="L418">		ApplicationPreferences applicationPreferences = new ApplicationPreferences();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">		if(application.isMac())</span>
		{
			// Use Apple Aqua L&amp;F screen menu bar if available; set property before any frames created
			try
			{
<span class="nc" id="L424">				System.setProperty(&quot;apple.laf.useScreenMenuBar&quot;, &quot;true&quot;);</span>
			}
<span class="nc" id="L426">			catch(Exception e)</span>
			{
				// try the older menu bar property
<span class="nc" id="L429">				System.setProperty(&quot;com.apple.macos.useScreenMenuBar&quot;, &quot;true&quot;);</span>
				// this shouldn't happen since we only run on 1.5+
<span class="nc" id="L431">			}</span>
		}

		// init look &amp; feel
<span class="nc" id="L435">		String lookAndFeel = applicationPreferences.getLookAndFeel();</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">		if(lookAndFeel != null)</span>
		{
			try
			{
<span class="nc bnc" id="L440" title="All 2 branches missed.">				for(UIManager.LookAndFeelInfo info : UIManager.getInstalledLookAndFeels())</span>
				{
<span class="nc bnc" id="L442" title="All 2 branches missed.">					if(lookAndFeel.equals(info.getName()))</span>
					{
<span class="nc" id="L444">						String lafClassName = info.getClassName();</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">						if(logger.isDebugEnabled()) logger.debug(&quot;Setting look&amp;feel to {}.&quot;, lafClassName);</span>
<span class="nc" id="L446">						UIManager.setLookAndFeel(lafClassName);</span>
<span class="nc" id="L447">						break;</span>
					}
				}
			}
<span class="nc" id="L451">			catch(UnsupportedLookAndFeelException e)</span>
			{
				// ignore
			}
<span class="nc" id="L455">			catch(ClassNotFoundException e)</span>
			{
				// ignore
			}
<span class="nc" id="L459">			catch(InstantiationException e)</span>
			{
				// ignore
			}
<span class="nc" id="L463">			catch(IllegalAccessException e)</span>
			{
				// ignore
<span class="nc" id="L466">			}</span>
		}

<span class="nc" id="L469">		boolean splashScreenDisabled = applicationPreferences.isSplashScreenDisabled();</span>
		try
		{
<span class="nc" id="L472">			SplashScreen splashScreen = null;</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">			if(!splashScreenDisabled)</span>
			{
<span class="nc" id="L475">				CreateSplashRunnable createRunnable = new CreateSplashRunnable(appTitle);</span>
<span class="nc" id="L476">				SwingUtilities.invokeAndWait(createRunnable);</span>
<span class="nc" id="L477">				splashScreen = createRunnable.getSplashScreen();</span>
<span class="nc" id="L478">				Thread.sleep(500); // so the splash gets the chance to get displayed :(</span>
<span class="nc" id="L479">				updateSplashStatus(splashScreen, &quot;Initialized application preferences...&quot;);</span>
			}

<span class="nc" id="L482">			File startupApplicationPath = applicationPreferences.getStartupApplicationPath();</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">			if(startupApplicationPath.mkdirs())</span>
			{
<span class="nc bnc" id="L485" title="All 2 branches missed.">				if(logger.isDebugEnabled()) logger.debug(&quot;Created '{}'.&quot;, startupApplicationPath.getAbsolutePath());</span>
			}

			// System.err redirection
			{
<span class="nc" id="L490">				File errorLog = new File(startupApplicationPath, &quot;errors.log&quot;);</span>
<span class="nc" id="L491">				boolean freshFile = false;</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">				if(!errorLog.isFile())</span>
				{
<span class="nc" id="L494">					freshFile = true;</span>
				}
				try
				{
<span class="nc" id="L498">					FileOutputStream fos = new FileOutputStream(errorLog, true);</span>
<span class="nc" id="L499">					PrintStream ps = new PrintStream(fos, true);</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">					if(!freshFile)</span>
					{
<span class="nc" id="L502">						ps.println(&quot;----------------------------------------&quot;);</span>
					}
<span class="nc" id="L504">					SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss.SSSZ&quot;);</span>
<span class="nc" id="L505">					ps.println(&quot;Started &quot; + APP_NAME + &quot; V&quot; + APP_VERSION + &quot; at &quot; + format.format(new Date()));</span>
<span class="nc" id="L506">					System.setErr(ps);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">					if(logger.isInfoEnabled()) logger.info(&quot;Writing System.err to '{}'.&quot;, errorLog.getAbsolutePath());</span>
				}
<span class="nc" id="L509">				catch(FileNotFoundException e)</span>
				{
<span class="nc" id="L511">					e.printStackTrace();</span>
<span class="nc" id="L512">				}</span>
			}

<span class="nc" id="L515">			File prevPathFile = new File(startupApplicationPath, ApplicationPreferences.PREVIOUS_APPLICATION_PATH_FILENAME);</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">			if(prevPathFile.isFile())</span>
			{
<span class="nc" id="L518">				updateSplashStatus(splashScreen, &quot;Moving application path content...&quot;);</span>
<span class="nc" id="L519">				moveApplicationPathContent(prevPathFile, startupApplicationPath);</span>
			}
<span class="nc bnc" id="L521" title="All 2 branches missed.">			if(!applicationPreferences.isLicensed())</span>
			{
<span class="nc" id="L523">				hideSplashScreen(splashScreen);</span>

<span class="nc" id="L525">				LicenseAgreementDialog licenseDialog = new LicenseAgreementDialog();</span>
<span class="nc" id="L526">				Windows.showWindow(licenseDialog, null, true);</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">				if(licenseDialog.isLicenseAgreed())</span>
				{
<span class="nc" id="L529">					applicationPreferences.setLicensed(true);</span>
				}
				else
				{
<span class="nc bnc" id="L533" title="All 2 branches missed.">					if(logger.isWarnEnabled()) logger.warn(&quot;Didn't accept license! Exiting...&quot;);</span>
<span class="nc" id="L534">					System.exit(-1);</span>
				}
			}

<span class="nc" id="L538">			updateSplashStatus(splashScreen, &quot;Creating main window...&quot;);</span>
<span class="nc" id="L539">			CreateMainFrameRunnable createMain = new CreateMainFrameRunnable(applicationPreferences, splashScreen, appTitle, enableBonjour);</span>
<span class="nc" id="L540">			SwingUtilities.invokeAndWait(createMain);</span>
<span class="nc" id="L541">			final MainFrame frame = createMain.getMainFrame();</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">			if(logger.isDebugEnabled()) logger.debug(&quot;After show...&quot;);</span>
<span class="nc" id="L543">			updateSplashStatus(splashScreen, &quot;Initializing application...&quot;);</span>
<span class="nc" id="L544">			SwingUtilities.invokeAndWait(new Runnable()</span>
<span class="nc" id="L545">			{</span>

				public void run()
				{
<span class="nc" id="L549">					frame.startUp();</span>
<span class="nc" id="L550">				}</span>
			});
<span class="nc" id="L552">			hideSplashScreen(splashScreen);</span>

		}
<span class="nc" id="L555">		catch(InterruptedException ex)</span>
		{
<span class="nc bnc" id="L557" title="All 2 branches missed.">			if(logger.isInfoEnabled()) logger.info(&quot;Interrupted...&quot;, ex);</span>
		}
<span class="nc" id="L559">		catch(InvocationTargetException ex)</span>
		{
<span class="nc bnc" id="L561" title="All 2 branches missed.">			if(logger.isWarnEnabled()) logger.warn(&quot;InvocationTargetException...&quot;, ex);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">			if(logger.isWarnEnabled()) logger.warn(&quot;Target-Exception: &quot;, ex.getTargetException());</span>

<span class="nc" id="L564">		}</span>
<span class="nc" id="L565">	}</span>


	static class CreateSplashRunnable
		implements Runnable
	{
		private SplashScreen splashScreen;
		private String appTitle;

		public CreateSplashRunnable(String appTitle)
<span class="nc" id="L575">		{</span>
<span class="nc" id="L576">			this.appTitle = appTitle;</span>
<span class="nc" id="L577">		}</span>

		public void run()
		{
<span class="nc" id="L581">			splashScreen = new SplashScreen(appTitle);</span>
<span class="nc" id="L582">			Windows.showWindow(splashScreen, null, true);</span>
<span class="nc" id="L583">		}</span>

		public SplashScreen getSplashScreen()
		{
<span class="nc" id="L587">			return splashScreen;</span>
		}
	}

	static class CreateMainFrameRunnable
		implements Runnable
	{
		private SplashScreen splashScreen;
		private MainFrame mainFrame;
		private ApplicationPreferences applicationPreferences;
		private String appTitle;
		private boolean enableBonjour;

		public CreateMainFrameRunnable(ApplicationPreferences applicationPreferences, SplashScreen splashScreen, String appTitle, boolean enableBonjour)
<span class="nc" id="L601">		{</span>
<span class="nc" id="L602">			this.splashScreen = splashScreen;</span>
<span class="nc" id="L603">			this.enableBonjour = enableBonjour;</span>
<span class="nc" id="L604">			this.appTitle = appTitle;</span>
<span class="nc" id="L605">			this.applicationPreferences = applicationPreferences;</span>
<span class="nc" id="L606">		}</span>

		public void run()
		{
<span class="nc" id="L610">			mainFrame = new MainFrame(applicationPreferences, splashScreen, appTitle, enableBonjour);</span>
<span class="nc" id="L611">			mainFrame.setSounds(new JLayerSounds());</span>
<span class="nc" id="L612">			mainFrame.setSize(1024, 768);</span>
<span class="nc" id="L613">			Windows.showWindow(mainFrame, null, false);</span>
<span class="nc" id="L614">		}</span>

		public MainFrame getMainFrame()
		{
<span class="nc" id="L618">			return mainFrame;</span>
		}
	}

	/**
	 * @param prevPathFile           the file that contains (!!!) the previous application path - not the previous application path itself!
	 * @param startupApplicationPath the current application path, i.e. the destination path.
	 */
	private static void moveApplicationPathContent(File prevPathFile, File startupApplicationPath)
	{
<span class="nc" id="L628">		final Logger logger = LoggerFactory.getLogger(Lilith.class);</span>

<span class="nc" id="L630">		InputStream is = null;</span>
<span class="nc" id="L631">		String prevPathStr = null;</span>
		try
		{
<span class="nc" id="L634">			is = new FileInputStream(prevPathFile);</span>
<span class="nc" id="L635">			prevPathStr = IOUtils.toString(is);</span>
		}
<span class="nc" id="L637">		catch(IOException ex)</span>
		{
<span class="nc bnc" id="L639" title="All 2 branches missed.">			if(logger.isWarnEnabled()) logger.warn(&quot;Exception while reading previous application path!&quot;, ex);</span>
		}
		finally
		{
<span class="nc" id="L643">			IOUtils.closeQuietly(is);</span>
		}
<span class="nc bnc" id="L645" title="All 2 branches missed.">		if(prevPathStr != null)</span>
		{
<span class="nc" id="L647">			File prevPath = new File(prevPathStr);</span>
			try
			{
<span class="nc" id="L650">				FileUtils.copyDirectory(prevPath, startupApplicationPath);</span>
<span class="nc" id="L651">				FileUtils.deleteDirectory(prevPath);</span>
			}
<span class="nc" id="L653">			catch(IOException ex)</span>
			{
<span class="nc bnc" id="L655" title="All 2 branches missed.">				if(logger.isWarnEnabled())</span>
				{
<span class="nc" id="L657">					logger.warn(&quot;Exception while moving content of previous application path '&quot; + prevPath</span>
<span class="nc" id="L658">						.getAbsolutePath() + &quot;' to new one '&quot; + startupApplicationPath.getAbsolutePath() + &quot;'!&quot;, ex);</span>
				}
<span class="nc" id="L660">			}</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">			if(logger.isInfoEnabled())</span>
			{
<span class="nc" id="L663">				logger</span>
<span class="nc" id="L664">					.info(&quot;Moved content from previous application path '{}' to new application path '{}'.&quot;, prevPath.getAbsolutePath(), startupApplicationPath.getAbsolutePath());</span>
			}
		}
<span class="nc" id="L667">		prevPathFile.delete();</span>
<span class="nc" id="L668">	}</span>


<span class="nc" id="L671">	private static class IndexingChangeListener</span>
		implements PropertyChangeListener
	{
<span class="nc" id="L674">		private final Logger logger = LoggerFactory.getLogger(Lilith.class);</span>

		/**
		 * This method gets called when a bound property is changed.
		 *
		 * @param evt A PropertyChangeEvent object describing the event source
		 *            and the property that has changed.
		 */

		public void propertyChange(PropertyChangeEvent evt)
		{
<span class="nc bnc" id="L685" title="All 2 branches missed.">			if(ProgressingCallable.PROGRESS_PROPERTY_NAME.equals(evt.getPropertyName()))</span>
			{
<span class="nc bnc" id="L687" title="All 2 branches missed.">				if(logger.isInfoEnabled()) logger.info(&quot;Progress: {}%&quot;, evt.getNewValue());</span>
			}
<span class="nc" id="L689">		}</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>