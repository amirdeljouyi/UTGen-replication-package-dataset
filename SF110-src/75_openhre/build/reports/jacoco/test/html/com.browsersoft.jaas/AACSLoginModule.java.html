<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AACSLoginModule.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">75_openhre</a> &gt; <a href="index.source.html" class="el_package">com.browsersoft.jaas</a> &gt; <span class="el_source">AACSLoginModule.java</span></div><h1>AACSLoginModule.java</h1><pre class="source lang-java linenums">/*
 *   CVS $Id: AACSLoginModule.java,v 1.1 2006/11/06 19:52:19 grodecki Exp $
 * 
 *   ====================================================================
 *                 Open Source Health Records Exchange
 *   ====================================================================
 *
 *   Copyright (C) 2005 Browsersoft Inc.
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License, version 2, 
 *   as published by the Free Software Foundation.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   The GNU General Public License is available at
 *   http://www.fsf.org/licensing/licenses/gpl.html
 *
 *   Email: info@openhre.org
 *   Web:   http://www.openhre.org
 */
package com.browsersoft.jaas;

import java.util.*;
import java.io.IOException;
import javax.security.auth.*;
import javax.security.auth.callback.*;
import javax.security.auth.login.*;
import javax.security.auth.spi.*;

import com.browsersoft.aacs.Login;
import com.browsersoft.aacs.User;

/**
 * &lt;p&gt; This sample LoginModule authenticates users with a password.
 * 
 * &lt;p&gt; This LoginModule only recognizes one user:	testUser
 * &lt;p&gt; testUser's password is:	testPassword
 *
 * &lt;p&gt; If testUser successfully authenticates itself,
 * an &lt;code&gt;AACSPrincipal&lt;/code&gt; with the testUser's user name
 * is added to the Subject.
 *
 * &lt;p&gt; This LoginModule recognizes the debug option.
 * If set to true in the login Configuration,
 * debug messages will be output to the output stream, System.out.
 *
 * &lt;p&gt; The config option specifies the AACS Properties file,
 * without the assumed &quot;.properties&quot; suffix.
 *
 * @version $Id: AACSLoginModule.java,v 1.1 2006/11/06 19:52:19 grodecki Exp $
 */
<span class="nc" id="L56">public class AACSLoginModule implements LoginModule {</span>

    // initial state
    private Subject subject;
    private CallbackHandler callbackHandler;
    private Map sharedState; // shared between the LoginModules
    private Map options;

    // configurable option
<span class="nc" id="L65">    private boolean debug = false;</span>

    // the authentication status
<span class="nc" id="L68">    private boolean succeeded = false;</span>
<span class="nc" id="L69">    private boolean commitSucceeded = false;</span>

    // username and password
    private String username;
    private char[] password;

    // Principals
    private AACSUserPrincipal userPrincipal;
    private AACSRolePrincipal rolePrincipal;
    
    // AACS Beans
    private User user;
    private Login login;
    
    // Default and actual AACS properties file
    private final static String aacsProps = &quot;/AACS&quot;;
<span class="nc" id="L85">    private static String propsfile = null;</span>

    /**
     * Initialize this &lt;code&gt;LoginModule&lt;/code&gt;.
     *
     * &lt;p&gt;
     *
     * @param subject the &lt;code&gt;Subject&lt;/code&gt; to be authenticated. &lt;p&gt;
     *
     * @param callbackHandler a &lt;code&gt;CallbackHandler&lt;/code&gt; for communicating
     *			with the end user (prompting for user names and
     *			passwords, for example). &lt;p&gt;
     *
     * @param sharedState shared &lt;code&gt;LoginModule&lt;/code&gt; state. &lt;p&gt;
     *
     * @param options options specified in the login
     *			&lt;code&gt;Configuration&lt;/code&gt; for this particular
     *			&lt;code&gt;LoginModule&lt;/code&gt;.
     */
    public void initialize(Subject subject, CallbackHandler callbackHandler,
			Map sharedState, Map options) {
 
<span class="nc" id="L107">	this.subject = subject;</span>
<span class="nc" id="L108">	this.callbackHandler = callbackHandler;</span>
<span class="nc" id="L109">	this.sharedState = sharedState;</span>
<span class="nc" id="L110">	this.options = options;</span>
	
<span class="nc" id="L112">	user = null;</span>
<span class="nc" id="L113">	login = null;</span>

	// initialize any configured options
<span class="nc" id="L116">	debug = &quot;true&quot;.equalsIgnoreCase((String)options.get(&quot;debug&quot;));</span>
	
<span class="nc bnc" id="L118" title="All 2 branches missed.">	if (propsfile == null) {</span>
		// only do the first time
<span class="nc" id="L120">		propsfile = (String)options.get(&quot;config&quot;);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if (propsfile == null) propsfile = aacsProps;</span>
<span class="nc" id="L122">		Login.setConfigFile(propsfile);</span>
<span class="nc" id="L123">		Login.init();</span>
	}
	
<span class="nc bnc" id="L126" title="All 2 branches missed.">	if (debug) System.out.println(&quot;AACSLoginModule initialized&quot;);</span>
	
<span class="nc" id="L128">    }</span>

    /**
     * Authenticate the user with a user name and password.
     *
     * &lt;p&gt;
     *
     * @return true in all cases since this &lt;code&gt;LoginModule&lt;/code&gt;
     *		should not be ignored.
     *
     * @exception FailedLoginException if the authentication fails. &lt;p&gt;
     *
     * @exception LoginException if this &lt;code&gt;LoginModule&lt;/code&gt;
     *		is unable to perform the authentication.
     */
    public boolean login() throws LoginException {

<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (debug) System.out.println(&quot;AACSLoginModule login() called&quot;);</span>

    // prompt for a user name and password
<span class="nc bnc" id="L148" title="All 2 branches missed.">	if (callbackHandler == null)</span>
<span class="nc" id="L149">	    throw new LoginException(&quot;Error: no CallbackHandler available &quot; +</span>
			&quot;to garner authentication information from the user&quot;);

<span class="nc" id="L152">	Callback[] callbacks = new Callback[2];</span>
<span class="nc" id="L153">	callbacks[0] = new NameCallback(&quot;user name: &quot;);</span>
<span class="nc" id="L154">	callbacks[1] = new PasswordCallback(&quot;password: &quot;, false);</span>
 
	try {
<span class="nc" id="L157">	    callbackHandler.handle(callbacks);</span>
<span class="nc" id="L158">	    username = ((NameCallback)callbacks[0]).getName();</span>
<span class="nc" id="L159">	    char[] tmpPassword = ((PasswordCallback)callbacks[1]).getPassword();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">	    if (tmpPassword == null) {</span>
		// treat a NULL password as an empty password
<span class="nc" id="L162">		tmpPassword = new char[0];</span>
	    }
<span class="nc" id="L164">	    password = new char[tmpPassword.length];</span>
<span class="nc" id="L165">	    System.arraycopy(tmpPassword, 0,</span>
			password, 0, tmpPassword.length);
<span class="nc" id="L167">	    ((PasswordCallback)callbacks[1]).clearPassword();</span>
 
<span class="nc" id="L169">	} catch (java.io.IOException ioe) {</span>
<span class="nc" id="L170">	    throw new LoginException(ioe.toString());</span>
<span class="nc" id="L171">	} catch (UnsupportedCallbackException uce) {</span>
<span class="nc" id="L172">	    throw new LoginException(&quot;Error: &quot; + uce.getCallback().toString() +</span>
		&quot; not available to garner authentication information &quot; +
		&quot;from the user&quot;);
<span class="nc" id="L175">	}</span>

	// print debugging information
<span class="nc bnc" id="L178" title="All 2 branches missed.">	if (debug) {</span>
<span class="nc" id="L179">	    System.out.println(&quot;\t\t[AACSLoginModule] &quot; +</span>
				&quot;user entered user name: &quot; +
				username);
<span class="nc" id="L182">	    System.out.print(&quot;\t\t[AACSLoginModule] &quot; +</span>
				&quot;user entered password: &quot;);
<span class="nc bnc" id="L184" title="All 2 branches missed.">	    for (int i = 0; i &lt; password.length; i++)</span>
<span class="nc" id="L185">		System.out.print(password[i]);</span>
<span class="nc" id="L186">	    System.out.println();</span>
	}

	// verify the username/password
<span class="nc" id="L190">	login = new Login(username);</span>
<span class="nc" id="L191">	login.setPassword(new String(password));</span>
<span class="nc" id="L192">	user = login.authenticate();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">	if (user != null) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">	    if (debug)</span>
<span class="nc" id="L195">		System.out.println(&quot;\t\t[AACSLoginModule] &quot; +</span>
				&quot;authentication succeeded&quot;);
<span class="nc" id="L197">	    succeeded = true;</span>
<span class="nc" id="L198">	    return true;</span>
	} else {
	    // authentication failed -- clean out state
<span class="nc bnc" id="L201" title="All 2 branches missed.">	    if (debug)</span>
<span class="nc" id="L202">		System.out.println(&quot;\t\t[AACSLoginModule] &quot; +</span>
				&quot;authentication failed&quot;);
<span class="nc" id="L204">	    succeeded = false;</span>
<span class="nc" id="L205">	    username = null;</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">	    for (int i = 0; i &lt; password.length; i++)</span>
<span class="nc" id="L207">		password[i] = ' ';</span>
<span class="nc" id="L208">	    password = null;</span>
<span class="nc" id="L209">		throw new FailedLoginException(&quot;Login Incorrect&quot;);</span>
	}
    }

    /**
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication succeeded
     * (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL LoginModules
     * succeeded).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (checked by retrieving the private state saved by the
     * &lt;code&gt;login&lt;/code&gt; method), then this method associates a
     * &lt;code&gt;AACSUserPrincipal&lt;/code&gt; and &lt;code&gt;AACSRolePrincipal&lt;/code&gt;
     * with the &lt;code&gt;Subject&lt;/code&gt; located in the
     * &lt;code&gt;LoginModule&lt;/code&gt;.  If this LoginModule's own
     * authentication attempted failed, then this method removes
     * any state that was originally saved.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the commit fails.
     *
     * @return true if this LoginModule's own login and commit
     *		attempts succeeded, or false otherwise.
     */
    public boolean commit() throws LoginException {
<span class="nc bnc" id="L236" title="All 2 branches missed.">	if (succeeded == false) {</span>
<span class="nc" id="L237">	    return false;</span>
	} else {
	    // add a Principal (authenticated identity)
	    // to the Subject

	    // add an AACSUserPrincipal to the Subject
<span class="nc" id="L243">	    userPrincipal = new AACSUserPrincipal(username);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">	    if (!subject.getPrincipals().contains(userPrincipal))</span>
<span class="nc" id="L245">	    	subject.getPrincipals().add(userPrincipal);</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">	    if (debug) {</span>
<span class="nc" id="L248">		System.out.println(&quot;\t\t[AACSLoginModule] &quot; +</span>
				&quot;added AACSUserPrincipal [&quot;+userPrincipal+&quot;] to Subject&quot;);
	    }
	    // add the &quot;aacs_role&quot; to the Subject
<span class="nc" id="L252">	    rolePrincipal = new AACSRolePrincipal(&quot;aacs_role&quot;);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">	    if (!subject.getPrincipals().contains(rolePrincipal))</span>
<span class="nc" id="L254">	    	subject.getPrincipals().add(rolePrincipal);</span>

<span class="nc bnc" id="L256" title="All 2 branches missed.">	    if (debug) {</span>
<span class="nc" id="L257">		System.out.println(&quot;\t\t[AACSLoginModule] &quot; +</span>
				&quot;added AACSRolePrincipal [&quot;+rolePrincipal+&quot;] to Subject&quot;);
	    }

	    // in any case, clean out state
<span class="nc" id="L262">	    username = null;</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">	    for (int i = 0; i &lt; password.length; i++)</span>
<span class="nc" id="L264">	    	password[i] = ' ';</span>
<span class="nc" id="L265">	    password = null;</span>

<span class="nc" id="L267">	    commitSucceeded = true;</span>
<span class="nc" id="L268">	    return true;</span>
	}
    }

    /**
     * &lt;p&gt; This method is called if the LoginContext's
     * overall authentication failed.
     * (the relevant REQUIRED, REQUISITE, SUFFICIENT and OPTIONAL LoginModules
     * did not succeed).
     *
     * &lt;p&gt; If this LoginModule's own authentication attempt
     * succeeded (checked by retrieving the private state saved by the
     * &lt;code&gt;login&lt;/code&gt; and &lt;code&gt;commit&lt;/code&gt; methods),
     * then this method cleans up any state that was originally saved.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the abort fails.
     *
     * @return false if this LoginModule's own login and/or commit attempts
     *		failed, and true otherwise.
     */
    public boolean abort() throws LoginException {
<span class="nc bnc" id="L291" title="All 2 branches missed.">	if (succeeded == false) {</span>
<span class="nc" id="L292">	    return false;</span>
<span class="nc bnc" id="L293" title="All 4 branches missed.">	} else if (succeeded == true &amp;&amp; commitSucceeded == false) {</span>
	    // login succeeded but overall authentication failed
<span class="nc" id="L295">	    succeeded = false;</span>
<span class="nc" id="L296">	    username = null;</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">	    if (password != null) {</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">		for (int i = 0; i &lt; password.length; i++)</span>
<span class="nc" id="L299">		    password[i] = ' ';</span>
<span class="nc" id="L300">		password = null;</span>
	    }
<span class="nc" id="L302">	    userPrincipal = null;</span>
<span class="nc" id="L303">	    rolePrincipal = null;</span>
	} else {
	    // overall authentication succeeded and commit succeeded,
	    // but someone else's commit failed
<span class="nc" id="L307">	    logout();</span>
	}
<span class="nc" id="L309">	return true;</span>
    }

    /**
     * Logout the user.
     *
     * &lt;p&gt; This method removes the &lt;code&gt;AACSPrincipal&lt;/code&gt;
     * that was added by the &lt;code&gt;commit&lt;/code&gt; method.
     *
     * &lt;p&gt;
     *
     * @exception LoginException if the logout fails.
     *
     * @return true in all cases since this &lt;code&gt;LoginModule&lt;/code&gt;
     *          should not be ignored.
     */
    public boolean logout() throws LoginException {

<span class="nc" id="L327">	subject.getPrincipals().remove(userPrincipal);</span>
<span class="nc" id="L328">	succeeded = false;</span>
<span class="nc" id="L329">	succeeded = commitSucceeded;</span>
<span class="nc" id="L330">	username = null;</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">	if (password != null) {</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">	    for (int i = 0; i &lt; password.length; i++)</span>
<span class="nc" id="L333">	    	password[i] = ' ';</span>
<span class="nc" id="L334">	    password = null;</span>
	}
<span class="nc" id="L336">	userPrincipal = null;</span>
<span class="nc" id="L337">	rolePrincipal = null;</span>
<span class="nc" id="L338">	user =  null;</span>
<span class="nc" id="L339">	login = null;</span>
<span class="nc" id="L340">	return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>