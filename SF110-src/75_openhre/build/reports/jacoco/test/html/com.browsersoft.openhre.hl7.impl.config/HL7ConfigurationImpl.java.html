<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HL7ConfigurationImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">75_openhre</a> &gt; <a href="index.source.html" class="el_package">com.browsersoft.openhre.hl7.impl.config</a> &gt; <span class="el_source">HL7ConfigurationImpl.java</span></div><h1>HL7ConfigurationImpl.java</h1><pre class="source lang-java linenums">/*
 *   ====================================================================
 *                 Open Source Health Records Exchange
 *   ====================================================================
 *
 *   Copyright (C) 2006 Browsersoft Inc.
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License, version 2,
 *   as published by the Free Software Foundation.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   The GNU General Public License is available at
 *   http://www.fsf.org/licensing/licenses/gpl.html
 *
 *   Email: info@openhre.org
 *   Web:   http://www.openhre.org
 */

package com.browsersoft.openhre.hl7.impl.config;

import com.browsersoft.openhre.hl7.api.config.*;
import com.browsersoft.openhre.hl7.api.parse.HL7PrimitiveDataTypeReader;
import com.browsersoft.openhre.hl7.api.regular.MessageTracer;
import com.browsersoft.openhre.hl7.api.regular.InvalidExpressionException;
import com.browsersoft.openhre.hl7.api.regular.ExpressionElementMapperItem;
import com.browsersoft.openhre.hl7.impl.regular.MessageTracerImpl;
import org.w3c.dom.Node;

public class HL7ConfigurationImpl implements HL7Configuration {

    private HL7MessageMap messages;
    private HL7DataTypeMap dataTypes;
    private HL7SegmentMap segments;
    private HL7TableMap tables;
    private HL7PatternsForCatchValues patterns;

    private HL7MessageConfigReader messagesReader;
    private HL7SegmentsConfigReader segmentsReader;
    private HL7DataTypeConfigReader dataTypeReader;
    private HL7TablesConfigReader tablesReader;

<span class="nc" id="L47">    public HL7ConfigurationImpl() {</span>
<span class="nc" id="L48">        patterns = new HL7PatternsForCatchValuesImpl();</span>

<span class="nc" id="L50">        messagesReader = new  HL7MessageConfigReaderImpl();</span>
<span class="nc" id="L51">        segmentsReader = new  HL7SegmentsConfigReaderImpl();</span>
<span class="nc" id="L52">        dataTypeReader = new  HL7DataTypeConfigReaderImpl();</span>
<span class="nc" id="L53">        tablesReader = new  HL7TablesConfigReaderImpl();</span>

<span class="nc" id="L55">        messages = new HL7MessageMapImpl();</span>
<span class="nc" id="L56">        segments = new HL7SegmentMapImpl();</span>
<span class="nc" id="L57">        dataTypes = new HL7DataTypeMapImpl();</span>
<span class="nc" id="L58">        tables = new HL7TableMapImpl();</span>
<span class="nc" id="L59">    }</span>

    public void readConfigurations( Node messagesNode, Node segmentsNode, Node dataTypesNode, Node tablesNode ) throws InvalidConfigDataStructureException {

<span class="nc" id="L63">        readMessagesConfiguration(messagesNode);</span>
<span class="nc" id="L64">        readSegmentsConfiguration(segmentsNode);</span>
<span class="nc" id="L65">        readDataTypesConfiguration(dataTypesNode);</span>
<span class="nc" id="L66">        readTablesConfiguration(tablesNode);</span>

<span class="nc" id="L68">    }</span>

    public void readMessagesConfiguration( Node messagesNode ) throws InvalidConfigDataStructureException {
<span class="nc" id="L71">        messagesReader.readConfiguration(messagesNode, messages);</span>
<span class="nc" id="L72">    }</span>

    public void readSegmentsConfiguration( Node segmentsNode ) throws InvalidConfigDataStructureException {
<span class="nc" id="L75">        segmentsReader.readConfiguration(segmentsNode, segments);</span>
<span class="nc" id="L76">    }</span>

    public void readDataTypesConfiguration( Node dataTypesNode ) throws InvalidConfigDataStructureException {
<span class="nc" id="L79">        dataTypeReader.readConfiguration(dataTypesNode, dataTypes);</span>
<span class="nc" id="L80">    }</span>

    public void readTablesConfiguration( Node tablesNode ) throws InvalidConfigDataStructureException {
<span class="nc" id="L83">        tablesReader.readConfiguration(tablesNode, tables);</span>
<span class="nc" id="L84">    }</span>

    public void connectConfigurations() throws InvalidConfigDataStructureException {

<span class="nc" id="L88">        patterns.clearAll();</span>

<span class="nc" id="L90">        String[] messagesIds = messages.getMessageIds();</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">        for ( int i = 0 ; i &lt; messagesIds.length ; i++ ) {</span>

<span class="nc" id="L94">            HL7Message message = messages.getItem(messagesIds[i]);</span>

<span class="nc" id="L96">            MessageTracer tracer = new MessageTracerImpl();</span>
            try {
<span class="nc" id="L98">                tracer.buildMatrixForMessage(message);</span>
<span class="nc" id="L99">            } catch ( InvalidExpressionException e ) {</span>
<span class="nc" id="L100">                throw new InvalidConfigDataStructureException( message.getID(), 31);</span>
<span class="nc" id="L101">            }</span>

<span class="nc bnc" id="L103" title="All 2 branches missed.">            for ( int j = 0; j &lt; tracer.getMapper().size(); j++ ) {</span>
<span class="nc" id="L104">                ExpressionElementMapperItem mapperItem = tracer.getMapper().getItem(j);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">                if ( mapperItem.getType() == ExpressionElementMapperItem.SEGMENT_ITEM ) {</span>
<span class="nc" id="L106">                    String segmentID = mapperItem.getID();</span>
<span class="nc" id="L107">                    HL7Segment segment = segments.getItem(segmentID);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    if ( segment == null ) {</span>
<span class="nc" id="L109">                       throw new InvalidConfigDataStructureException( segmentID, 8);</span>
                    }
<span class="nc" id="L111">                    mapperItem.setSegment(segment);</span>
<span class="nc" id="L112">                    mapperItem.setID(segmentID.substring(0,3));</span>
                }
            }


<span class="nc" id="L117">            message.setTracer(tracer);</span>



        }

<span class="nc" id="L123">        String[] segmentsIds = segments.getSegmentsIds();</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">        for ( int i = 0 ; i &lt; segmentsIds.length ; i++ ) {</span>
<span class="nc" id="L126">            HL7Segment segment = segments.getItem(segmentsIds[i]);</span>
<span class="nc" id="L127">            connectFields(segment.getFields());</span>
        }

<span class="nc" id="L130">        String[] dataTypesIds = dataTypes.getTypeIds();</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">        for ( int i = 0 ; i &lt; dataTypesIds.length ; i++ ) {</span>
<span class="nc" id="L133">            HL7DataType dataType = dataTypes.getItem(dataTypesIds[i]);</span>

<span class="nc" id="L135">            HL7DataTypePartList parts = dataType.getParts();</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">            for ( int j = 0 ; j &lt; parts.size(); j++ ) {</span>
<span class="nc" id="L138">                connectDataTypePart(parts.getItem(j));</span>
            }
        }


<span class="nc" id="L143">    }</span>

    private void connectDataTypePart( HL7DataTypePart part ) throws InvalidConfigDataStructureException {

<span class="nc bnc" id="L147" title="All 2 branches missed.">        if ( part.getType() == HL7DataTypePart.PART_TYPE_PRIMITIVE ) {</span>

<span class="nc" id="L149">            HL7DataTypePartPrimitive primitivePart = (HL7DataTypePartPrimitive) part;</span>
<span class="nc" id="L150">            String readerClassName = primitivePart.getReader();</span>
            Object readerObject;
            try {
<span class="nc" id="L153">                readerObject = getInstanceFromClassName(readerClassName);</span>
<span class="nc" id="L154">            } catch ( Exception e ) {</span>
<span class="nc" id="L155">                throw new InvalidConfigDataStructureException( readerClassName, 20 );</span>
<span class="nc" id="L156">            }</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if ( !(readerObject instanceof HL7PrimitiveDataTypeReader) ) {</span>
<span class="nc" id="L158">                throw new InvalidConfigDataStructureException( readerClassName, 21 );</span>
            }
<span class="nc" id="L160">            primitivePart.setInstanceReader((HL7PrimitiveDataTypeReader) readerObject);</span>

<span class="nc" id="L162">        } else {</span>

<span class="nc" id="L164">            HL7DataTypePartSubPart subPart = (HL7DataTypePartSubPart) part;</span>
<span class="nc" id="L165">            String subPartId = subPart.getSubPartID();</span>

<span class="nc" id="L167">            HL7DataType type = dataTypes.getItem(subPartId);</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">            if ( type == null ) {</span>
<span class="nc" id="L170">                throw new InvalidConfigDataStructureException(subPartId, 9);</span>
            }

<span class="nc" id="L173">            subPart.setSubType(type);</span>

        }

<span class="nc" id="L177">    }</span>

    private Object getInstanceFromClassName ( String className ) throws ClassNotFoundException, IllegalAccessException, InstantiationException {
<span class="nc" id="L180">        Class classForObject = Class.forName(className);</span>
<span class="nc" id="L181">        return classForObject.newInstance();</span>
    }

    private void connectFields ( HL7FieldList fields ) throws InvalidConfigDataStructureException {

<span class="nc bnc" id="L186" title="All 2 branches missed.">        for ( int i = 0 ; i &lt; fields.size() ; i++ ) {</span>

<span class="nc" id="L188">            HL7Field field = fields.getItem(i);</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">            if ( field.getDependingType() == HL7Field.TYPE_DEPENDING_GIVEN ) {</span>
<span class="nc" id="L191">                HL7FieldGivenDependingProcessorImpl given = (HL7FieldGivenDependingProcessorImpl) field.getDependingProcessor();</span>
<span class="nc" id="L192">                String from = given.getFrom();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                if ( !from.equals(&quot;&quot;)) {</span>
<span class="nc" id="L194">                    patterns.addPattern(from);</span>
                }
            }

<span class="nc" id="L198">            HL7Table objectTable = tables.getItem(field.getTable());</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">            if ( objectTable == null ) {</span>
                // tables configuration isn't complete..
            }
<span class="nc" id="L202">            field.setTableObject(objectTable);</span>


        }

<span class="nc" id="L207">    }</span>

    private void connectGroup ( HL7MessageGroup group ) throws InvalidConfigDataStructureException {

<span class="nc bnc" id="L211" title="All 2 branches missed.">        for ( int i = 0 ; i &lt; group.size() ; i++ ) {</span>

<span class="nc" id="L213">            HL7MessageGroupItem item = group.getItem(i);</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">            if ( item.getType() == HL7MessageGroupItem.ITEM_TYPE_SEGMENT ) {</span>
<span class="nc" id="L216">                connectSegment ( (HL7MessageSegment) item );</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">            } else if ( item.getType() == HL7MessageGroupItem.ITEM_TYPE_GROUP ) {</span>
<span class="nc" id="L218">                connectGroup((HL7MessageGroup) item);</span>
            }

        }

<span class="nc" id="L223">     }</span>

    private void connectSegment ( HL7MessageSegment segment ) throws InvalidConfigDataStructureException {

<span class="nc" id="L227">        HL7Segment objectSegment = segments.getItem(segment.getID());</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if ( objectSegment == null ) {</span>
<span class="nc" id="L229">            throw new InvalidConfigDataStructureException(segment.getID(), 8);</span>
        }
<span class="nc" id="L231">        segment.setSegment(objectSegment);</span>

<span class="nc" id="L233">    }</span>

    public  HL7PatternsForCatchValues  getPatterns() {
<span class="nc" id="L236">        return patterns;</span>
    }

    public void setPatterns( HL7PatternsForCatchValues patterns ) {
<span class="nc" id="L240">        this.patterns = patterns;</span>
<span class="nc" id="L241">    }</span>

    public HL7MessageMap getMessages() {
<span class="nc" id="L244">        return messages;</span>
    }

    public void setMessages( HL7MessageMap messages ) {
<span class="nc" id="L248">        this.messages = messages;</span>
<span class="nc" id="L249">    }</span>

    public HL7DataTypeMap getDataTypes() {
<span class="nc" id="L252">        return dataTypes;</span>
    }

    public void setDataTypes( HL7DataTypeMap dataTypes ) {
<span class="nc" id="L256">        this.dataTypes = dataTypes;</span>
<span class="nc" id="L257">    }</span>

    public HL7SegmentMap getSegments() {
<span class="nc" id="L260">        return segments;</span>
    }

    public void setSegments( HL7SegmentMap segments ) {
<span class="nc" id="L264">        this.segments = segments;</span>
<span class="nc" id="L265">    }</span>

    public HL7TableMap getTables() {
<span class="nc" id="L268">        return tables;</span>
    }

    public void setTables( HL7TableMap tables ) {
<span class="nc" id="L272">        this.tables = tables;</span>
<span class="nc" id="L273">    }</span>

    public String toString() {
<span class="nc" id="L276">        String ret = messages.toString();</span>
<span class="nc" id="L277">        ret += segments.toString();</span>
<span class="nc" id="L278">        ret += dataTypes.toString();</span>
<span class="nc" id="L279">        ret += tables.toString();</span>
<span class="nc" id="L280">        return ret;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>