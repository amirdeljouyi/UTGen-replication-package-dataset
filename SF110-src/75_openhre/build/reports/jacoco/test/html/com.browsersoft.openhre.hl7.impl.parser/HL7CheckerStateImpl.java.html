<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HL7CheckerStateImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">75_openhre</a> &gt; <a href="index.source.html" class="el_package">com.browsersoft.openhre.hl7.impl.parser</a> &gt; <span class="el_source">HL7CheckerStateImpl.java</span></div><h1>HL7CheckerStateImpl.java</h1><pre class="source lang-java linenums">/*
 *   ====================================================================
 *                 Open Source Health Records Exchange
 *   ====================================================================
 *
 *   Copyright (C) 2006 Browsersoft Inc.
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License, version 2,
 *   as published by the Free Software Foundation.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   The GNU General Public License is available at
 *   http://www.fsf.org/licensing/licenses/gpl.html
 *
 *   Email: info@openhre.org
 *   Web:   http://www.openhre.org
 */


package com.browsersoft.openhre.hl7.impl.parser;

import com.browsersoft.openhre.hl7.api.config.HL7Configuration;
import com.browsersoft.openhre.hl7.api.config.HL7DataType;
import com.browsersoft.openhre.hl7.api.config.HL7DataTypePart;
import com.browsersoft.openhre.hl7.api.config.HL7DataTypePartSubPart;
import com.browsersoft.openhre.hl7.api.config.HL7Field;
import com.browsersoft.openhre.hl7.api.config.HL7FieldList;
import com.browsersoft.openhre.hl7.api.config.HL7Segment;
import com.browsersoft.openhre.hl7.api.parse.HL7Checker;
import com.browsersoft.openhre.hl7.api.parse.HL7CheckerHandler;
import com.browsersoft.openhre.hl7.api.parse.HL7CheckerState;
import com.browsersoft.openhre.hl7.api.parse.ParserException;
import com.browsersoft.openhre.hl7.api.regular.MessageTracer;

<span class="nc" id="L40">public class HL7CheckerStateImpl implements HL7CheckerState {</span>

    private HL7CheckerHandler handler;

    //segment
    private HL7Segment actualSegment;
    private HL7Configuration configuration;

    //field
    private HL7Field actualField;
    private int actualFieldPosition;
    private int actualFieldRepeatableIndex;
<span class="nc" id="L52">    private int actualFieldLength = 0;</span>

    //part
    private HL7DataType actualDataType;
<span class="nc" id="L56">    private int actualDataTypePartsPossition = 0;</span>
    private HL7DataType actualComponentDataType;
<span class="nc" id="L58">    private int actualDataTypeSubPartsPossition = 0;</span>
    private HL7DataType actualSubComponentDataType;


    private boolean seriousError;
    private MessageTracer messageTracer;

    public boolean isSeriousError() {
<span class="nc" id="L66">        return seriousError;</span>
    }

    public void setSeriousError( boolean seriousError ) {
<span class="nc" id="L70">       this.seriousError = seriousError;</span>
<span class="nc" id="L71">    }</span>

    public MessageTracer getMessageTracer() {
<span class="nc" id="L74">        return messageTracer;</span>
    }

    public void setMessageTracer( MessageTracer messageTracer ) {
<span class="nc" id="L78">        this.messageTracer = messageTracer;</span>
<span class="nc" id="L79">    }</span>

    /* Subcomponents function */
    public void eventBeginSubComponent() {

<span class="nc bnc" id="L84" title="All 2 branches missed.">        if ( actualComponentDataType == null ) {</span>
<span class="nc" id="L85">           return;</span>
        }

<span class="nc bnc" id="L88" title="All 2 branches missed.">        if ( actualDataTypeSubPartsPossition &gt;=  actualComponentDataType.getParts().size() ) {</span>
<span class="nc" id="L89">           generateError( 27, actualComponentDataType.getID());</span>
<span class="nc" id="L90">           setSeriousError(true);</span>
<span class="nc" id="L91">           return;</span>
        }

<span class="nc" id="L94">        HL7DataTypePart part = actualComponentDataType.getParts().getItem(actualDataTypeSubPartsPossition);</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">        if ( part.getType() == HL7DataTypePart.PART_TYPE_PRIMITIVE ) {</span>
            // only for single subcomponent
<span class="nc" id="L98">            actualSubComponentDataType = actualComponentDataType;</span>
<span class="nc" id="L99">            return;</span>
        }

<span class="nc" id="L102">        String idOfSubpart = ((HL7DataTypePartSubPart) part).getSubPartID();</span>
<span class="nc" id="L103">        actualSubComponentDataType = configuration.getDataTypes().getItem(idOfSubpart);</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">        if ( !isDataTypePrimitive(actualSubComponentDataType)) {</span>
<span class="nc" id="L106">            generateError( 25, actualSubComponentDataType.getID());</span>
<span class="nc" id="L107">            setSeriousError(true);</span>
<span class="nc" id="L108">            return;</span>
        }

<span class="nc bnc" id="L111" title="All 2 branches missed.">        if ( actualSubComponentDataType == null ) {</span>
<span class="nc" id="L112">           generateError ( 9, idOfSubpart);</span>
<span class="nc" id="L113">            setSeriousError(true);</span>
<span class="nc" id="L114">            return;</span>
        }

<span class="nc" id="L117">        actualDataTypeSubPartsPossition++;</span>

<span class="nc" id="L119">    }</span>

    public void addToActualFieldLength( int length ) {
<span class="nc" id="L122">        actualFieldLength += length;</span>
<span class="nc" id="L123">    }</span>

    /* Component functions */
    public void eventBeginComponent() {

<span class="nc" id="L128">        resetBeginComponent();</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">        if ( actualDataType == null ) {</span>
<span class="nc" id="L131">            return;</span>
        }

        // CM data type
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if ( actualDataType.getID().equals(&quot;CM&quot;)) {</span>
<span class="nc" id="L136">            actualComponentDataType = configuration.getDataTypes().getItem(&quot;ST&quot;);</span>
<span class="nc" id="L137">            return;</span>
        }

<span class="nc bnc" id="L140" title="All 2 branches missed.">        if ( isDataTypePrimitive( actualDataType ) ) {</span>
            //more components in primitive type
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if ( actualDataTypePartsPossition &gt; 0) {</span>
<span class="nc" id="L143">                generateError( 22, actualDataType.getID() );</span>
<span class="nc" id="L144">                setSeriousError(true);</span>
<span class="nc" id="L145">                return;</span>
            }
<span class="nc" id="L147">            actualComponentDataType = actualDataType;</span>

        } else {

<span class="nc bnc" id="L151" title="All 2 branches missed.">            if ( actualDataTypePartsPossition &gt;=  actualDataType.getParts().size() ) {</span>
<span class="nc" id="L152">                generateError( 22, actualDataType.getID() + &quot; &quot; + (actualDataTypePartsPossition + 1) + &quot;th(defined:&quot; + actualDataType.getParts().size() + &quot;)&quot;);</span>
<span class="nc" id="L153">                setSeriousError(true);</span>
<span class="nc" id="L154">                return;</span>
            }
<span class="nc" id="L156">            HL7DataTypePart part = actualDataType.getParts().getItem(actualDataTypePartsPossition);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if ( part.getType() == HL7DataTypePart.PART_TYPE_PRIMITIVE ) {</span>
                //something wrong - Primitive type may be defined only as single subpart
<span class="nc" id="L159">                generateError( 26, actualDataType.getID());</span>
<span class="nc" id="L160">                setSeriousError(true);</span>
<span class="nc" id="L161">                return;</span>
            }
<span class="nc" id="L163">            String idOfSubPart = ((HL7DataTypePartSubPart) part).getSubPartID();</span>

<span class="nc" id="L165">            actualComponentDataType = configuration.getDataTypes().getItem(idOfSubPart);</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">            if ( actualComponentDataType == null ) {</span>
<span class="nc" id="L168">                generateError ( 9, idOfSubPart);</span>
<span class="nc" id="L169">                setSeriousError(true);</span>
<span class="nc" id="L170">                return;</span>
            }

        }

<span class="nc" id="L175">        actualDataTypePartsPossition++;</span>

<span class="nc" id="L177">    }</span>


    public boolean isDataTypePrimitive( HL7DataType dataType ) {
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if ( dataType.getParts().size() != 1 ) {</span>
<span class="nc" id="L182">            return false;</span>
        } else {
<span class="nc bnc" id="L184" title="All 2 branches missed.">            return dataType.getParts().getItem(0).getType() == HL7DataTypePart.PART_TYPE_PRIMITIVE;</span>
        }
    }

    /* Field functions */
    public void eventBeginField( boolean repeatable ) {
        //System.out.println(&quot;eventBeginField:&quot; + repeatable );
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if ( actualSegment == null ) {</span>
<span class="nc" id="L192">            return;</span>
        }

<span class="nc bnc" id="L195" title="All 2 branches missed.">        if ( !repeatable ) {</span>
            //set the actual field
<span class="nc" id="L197">            resetBeginField();</span>
<span class="nc" id="L198">            HL7FieldList fields = actualSegment.getFields();</span>

<span class="nc bnc" id="L200" title="All 4 branches missed.">            if ( actualFieldPosition &gt;= 0 &amp;&amp; actualFieldPosition &lt; fields.size() ) {</span>
<span class="nc" id="L201">                actualField = fields.getItem(actualFieldPosition);</span>
<span class="nc" id="L202">                actualFieldPosition++;</span>
            } else {
<span class="nc" id="L204">                generateError ( 16, getNameOfActualField());  // More fields in segment then defined</span>
<span class="nc" id="L205">                actualField = null;</span>
<span class="nc" id="L206">                setSeriousError(true);</span>
<span class="nc" id="L207">                return;</span>
            }

<span class="nc" id="L210">        } else {</span>
<span class="nc" id="L211">            resetBeginRepeatableField();</span>

        }

<span class="nc" id="L215">        findActualDataType();</span>

<span class="nc" id="L217">    }</span>


    private void findActualDataType() {

<span class="nc bnc" id="L222" title="All 2 branches missed.">        if ( actualField == null ) {</span>
<span class="nc" id="L223">            return;</span>
        }

<span class="nc bnc" id="L226" title="All 3 branches missed.">        switch ( actualField.getDependingType() ) {</span>
            case HL7Field.TYPE_DEPENDING_NORMAL:
<span class="nc" id="L228">               String typeID = actualField.getDataTypeID();</span>
<span class="nc" id="L229">               actualDataType = configuration.getDataTypes().getItem(typeID);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">               if ( actualDataType == null ) {</span>
<span class="nc" id="L231">                 generateError ( 9, typeID);</span>
<span class="nc" id="L232">                 setSeriousError(true);</span>
<span class="nc" id="L233">                 return;</span>
               }
               break;
            case HL7Field.TYPE_DEPENDING_REPEATABLE:
            case HL7Field.TYPE_DEPENDING_GIVEN:
                try {
<span class="nc" id="L239">                    actualDataType = actualField.getDependingProcessor().getDataTypeForSituation(this);</span>
<span class="nc" id="L240">                } catch ( ParserException e ) {</span>
<span class="nc" id="L241">                    generateError( e.getMessageCode(), e.getPostfix());</span>
<span class="nc" id="L242">                    setSeriousError(true);</span>
<span class="nc" id="L243">                    return;</span>
<span class="nc" id="L244">                }</span>
                break;

        }


<span class="nc" id="L250">    }</span>

    /* Segment functions */

    public void eventBeginSegment( String segmentID ) {

<span class="nc" id="L256">        resetBeginSegment();</span>

<span class="nc" id="L258">        messageTracer.processNextSegment(segmentID);</span>

<span class="nc" id="L260">    }</span>



    public void generateError( int code, String message ) {
<span class="nc" id="L265">        String segmentID = &quot;&quot;;</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if ( actualSegment != null ) {</span>
<span class="nc" id="L267">            segmentID = actualSegment.getID();</span>
        }
<span class="nc" id="L269">        String fieldID = &quot;&quot;;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if ( actualField != null ) {</span>
<span class="nc" id="L271">            fieldID = segmentID + &quot;.&quot; + actualField.getSequential();</span>
        }
<span class="nc" id="L273">        handler.error( HL7Checker.TYPE_ERROR, code, message, segmentID, fieldID );</span>
<span class="nc" id="L274">    }</span>

    public void generateWarning( int code, String message ) {
<span class="nc" id="L277">        String segmentID = &quot;&quot;;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if ( actualSegment != null ) {</span>
<span class="nc" id="L279">            segmentID = actualSegment.getID();</span>
        }
<span class="nc" id="L281">        String fieldID = &quot;&quot;;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if ( actualField != null ) {</span>
<span class="nc" id="L283">            fieldID = segmentID + &quot;.&quot; + actualField.getSequential();</span>
        }
<span class="nc" id="L285">        handler.error( HL7Checker.TYPE_WARNING, code, message, segmentID, fieldID );</span>
<span class="nc" id="L286">    }</span>

    private String getNameOfActualField() {
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if ( actualSegment != null  &amp;&amp; actualField != null ) {</span>
<span class="nc" id="L290">            return actualSegment.getID() + &quot;.&quot; + actualField.getSequential();</span>
        }  else {
<span class="nc" id="L292">            return &quot;&quot;;</span>
        }
    }

    public HL7CheckerHandler getCheckerHandler() {
<span class="nc" id="L297">        return handler;</span>
    }

    public void setCheckerHandler( HL7CheckerHandler handler ) {
<span class="nc" id="L301">        this.handler = handler;</span>
<span class="nc" id="L302">    }</span>

    public void resetBeginComponent() {
<span class="nc" id="L305">        actualSubComponentDataType = null;</span>
<span class="nc" id="L306">        actualDataTypeSubPartsPossition = 0;</span>
<span class="nc" id="L307">    }</span>

    public void resetBeginField() {
<span class="nc" id="L310">        actualFieldRepeatableIndex = 0;</span>
<span class="nc" id="L311">        actualFieldLength = 0;</span>
<span class="nc" id="L312">        actualField = null;</span>
<span class="nc" id="L313">        actualDataType = null;</span>
<span class="nc" id="L314">        actualDataTypePartsPossition = 0;</span>
<span class="nc" id="L315">        resetBeginComponent();</span>
<span class="nc" id="L316">    }</span>

    public void resetBeginRepeatableField() {
<span class="nc" id="L319">        actualFieldRepeatableIndex++;</span>
<span class="nc" id="L320">        actualFieldLength = 0;</span>
<span class="nc" id="L321">        actualDataTypePartsPossition = 0;</span>
<span class="nc" id="L322">        resetBeginComponent();</span>
<span class="nc" id="L323">    }</span>

    public void resetBeginSegment() {
<span class="nc" id="L326">        resetBeginField();</span>
<span class="nc" id="L327">        actualFieldPosition = 0;</span>
<span class="nc" id="L328">        actualSegment = null;</span>
<span class="nc" id="L329">    }</span>

    public HL7Segment getActualSegment() {
<span class="nc" id="L332">        return actualSegment;</span>
    }

    public void setActualSegment( HL7Segment actualSegment ) {
<span class="nc" id="L336">        this.actualSegment = actualSegment;</span>
<span class="nc" id="L337">    }</span>

    public int getActualFieldPosition() {
<span class="nc" id="L340">        return actualFieldPosition;</span>
    }

    public void setActualFieldPosition( int actualFieldPosition ) {
<span class="nc" id="L344">        this.actualFieldPosition = actualFieldPosition;</span>
<span class="nc" id="L345">    }</span>

    public HL7Field getActualField() {
<span class="nc" id="L348">        return actualField;</span>
    }

    public void setActualField( HL7Field actualField ) {
<span class="nc" id="L352">        this.actualField = actualField;</span>
<span class="nc" id="L353">    }</span>

    public int getActualFieldLength() {
<span class="nc" id="L356">        return actualFieldLength;</span>
    }

    public void setActualFieldLength( int actualFieldLength ) {
<span class="nc" id="L360">        this.actualFieldLength = actualFieldLength;</span>
<span class="nc" id="L361">    }</span>


    public int getActualDataTypePartsPossition() {
<span class="nc" id="L365">        return actualDataTypePartsPossition;</span>
    }

    public void setActualDataTypePartsPossition( int actualDataTypePartsPossition ) {
<span class="nc" id="L369">        this.actualDataTypePartsPossition = actualDataTypePartsPossition;</span>
<span class="nc" id="L370">    }</span>

    public int getActualDataTypeSubPartsPossition() {
<span class="nc" id="L373">        return actualDataTypeSubPartsPossition;</span>
    }

    public void setActualDataTypeSubPartsPossition( int actualDataTypeSubPartsPossition ) {
<span class="nc" id="L377">        this.actualDataTypeSubPartsPossition = actualDataTypeSubPartsPossition;</span>
<span class="nc" id="L378">    }</span>

    public int getActualFieldRepeatableIndex() {
<span class="nc" id="L381">        return actualFieldRepeatableIndex;</span>
    }

    public void setActualFieldRepeatableIndex( int actualFieldRepeatableIndex ) {
<span class="nc" id="L385">        this.actualFieldRepeatableIndex = actualFieldRepeatableIndex;</span>
<span class="nc" id="L386">    }</span>

    public HL7DataType getActualDataType() {
<span class="nc" id="L389">        return actualDataType;</span>
    }

    public void setActualDataType( HL7DataType actualDataType ) {
<span class="nc" id="L393">        this.actualDataType = actualDataType;</span>
<span class="nc" id="L394">    }</span>

    public HL7Configuration getConfiguration() {
<span class="nc" id="L397">        return configuration;</span>
    }

    public void setConfiguration( HL7Configuration configuration ) {
<span class="nc" id="L401">        this.configuration = configuration;</span>
<span class="nc" id="L402">    }</span>

    public HL7DataType getActualComponentDataType() {
<span class="nc" id="L405">        return actualComponentDataType;</span>
    }

    public void setActualComponentDataType( HL7DataType actualComponentDataType ) {
<span class="nc" id="L409">        this.actualComponentDataType = actualComponentDataType;</span>
<span class="nc" id="L410">    }</span>

    public HL7DataType getActualSubComponentDataType() {
<span class="nc" id="L413">        return actualSubComponentDataType;</span>
    }

    public void setActualSubComponentDataType( HL7DataType actualSubComponentDataType ) {
<span class="nc" id="L417">        this.actualSubComponentDataType = actualSubComponentDataType;</span>
<span class="nc" id="L418">    }</span>

    public String toString() {

<span class="nc" id="L422">        String ret = &quot;&quot;;</span>

<span class="nc bnc" id="L424" title="All 2 branches missed.">        if ( actualSegment != null ) {</span>
<span class="nc" id="L425">            ret += &quot;ACTUAL_SEGMENT:&quot; + actualSegment.getID()+ &quot;\n&quot;;</span>
        }

<span class="nc bnc" id="L428" title="All 2 branches missed.">        if ( actualField != null ) {</span>
<span class="nc" id="L429">            ret += &quot;ACTUAL_FIELD:&quot; + actualSegment.getID() + &quot;.&quot; + actualField.getSequential() + &quot;\n&quot;;</span>
        }

<span class="nc" id="L432">        ret += &quot;actualFieldPosition:&quot; + actualFieldPosition + &quot;\n&quot;;</span>
<span class="nc" id="L433">        ret += &quot;actualFieldRepeatableIndex:&quot; + actualFieldRepeatableIndex + &quot;\n&quot;;</span>
<span class="nc" id="L434">        ret += &quot;actualFieldLength:&quot; + actualFieldLength + &quot;\n&quot;;</span>

<span class="nc bnc" id="L436" title="All 2 branches missed.">        if ( actualDataType != null ) {</span>
<span class="nc" id="L437">            ret += &quot;actualDataType:&quot; + actualDataType.getID() + &quot;\n&quot;;</span>
        }

<span class="nc" id="L440">        ret += &quot;actualDataTypePartsPossition:&quot; + actualDataTypePartsPossition + &quot;\n&quot;;</span>

<span class="nc bnc" id="L442" title="All 2 branches missed.">        if ( actualComponentDataType != null ) {</span>
<span class="nc" id="L443">            ret += &quot;actualComponentDataType:&quot; + actualComponentDataType.getID() + &quot;\n&quot;;</span>
        }

<span class="nc" id="L446">        ret += &quot;actualDataTypeSubPartsPossition:&quot; + actualDataTypeSubPartsPossition + &quot;\n&quot;;</span>

<span class="nc bnc" id="L448" title="All 2 branches missed.">        if ( actualSubComponentDataType != null ) {</span>
<span class="nc" id="L449">            ret += &quot;actualSubComponentDataType:&quot; + actualSubComponentDataType.getID() + &quot;\n&quot;;</span>
        }

<span class="nc" id="L452">        return ret;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>