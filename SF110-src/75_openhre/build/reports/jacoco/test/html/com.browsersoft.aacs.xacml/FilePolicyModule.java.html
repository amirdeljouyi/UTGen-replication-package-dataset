<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FilePolicyModule.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">75_openhre</a> &gt; <a href="index.source.html" class="el_package">com.browsersoft.aacs.xacml</a> &gt; <span class="el_source">FilePolicyModule.java</span></div><h1>FilePolicyModule.java</h1><pre class="source lang-java linenums">/*
 * @(#)FilePolicyModule.java
 *
 * Copyright 2003-2006 Sun Microsystems, Inc. All Rights Reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 *   1. Redistribution of source code must retain the above copyright notice,
 *      this list of conditions and the following disclaimer.
 * 
 *   2. Redistribution in binary form must reproduce the above copyright
 *      notice, this list of conditions and the following disclaimer in the
 *      documentation and/or other materials provided with the distribution.
 *
 * Neither the name of Sun Microsystems, Inc. or the names of contributors may
 * be used to endorse or promote products derived from this software without
 * specific prior written permission.
 * 
 * This software is provided &quot;AS IS,&quot; without a warranty of any kind. ALL
 * EXPRESS OR IMPLIED CONDITIONS, REPRESENTATIONS AND WARRANTIES, INCLUDING
 * ANY IMPLIED WARRANTY OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE
 * OR NON-INFRINGEMENT, ARE HEREBY EXCLUDED. SUN MICROSYSTEMS, INC. (&quot;SUN&quot;)
 * AND ITS LICENSORS SHALL NOT BE LIABLE FOR ANY DAMAGES SUFFERED BY LICENSEE
 * AS A RESULT OF USING, MODIFYING OR DISTRIBUTING THIS SOFTWARE OR ITS
 * DERIVATIVES. IN NO EVENT WILL SUN OR ITS LICENSORS BE LIABLE FOR ANY LOST
 * REVENUE, PROFIT OR DATA, OR FOR DIRECT, INDIRECT, SPECIAL, CONSEQUENTIAL,
 * INCIDENTAL OR PUNITIVE DAMAGES, HOWEVER CAUSED AND REGARDLESS OF THE THEORY
 * OF LIABILITY, ARISING OUT OF THE USE OF OR INABILITY TO USE THIS SOFTWARE,
 * EVEN IF SUN HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
 *
 * You acknowledge that this software is not designed or intended for use in
 * the design, construction, operation or maintenance of any nuclear facility.
 */

package com.browsersoft.aacs.xacml;

import com.browsersoft.aacs.Login;
import com.sun.xacml.AbstractPolicy;
import com.sun.xacml.EvaluationCtx;
import com.sun.xacml.MatchResult;
import com.sun.xacml.ParsingException;
import com.sun.xacml.Policy;

import com.sun.xacml.ctx.Status;
import com.sun.xacml.PolicyReference;
import com.sun.xacml.PolicySet;

import com.sun.xacml.finder.PolicyFinder;
import com.sun.xacml.finder.PolicyFinderModule;
import com.sun.xacml.finder.PolicyFinderResult;
import com.sun.xacml.PolicyMetaData;
import com.sun.xacml.PolicyReference;
import com.sun.xacml.PolicySet;
import com.sun.xacml.VersionConstraints;


import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Set;

import java.util.logging.Level;
import java.util.logging.Logger;
import java.net.MalformedURLException;
import java.net.URI;
import java.net.URL;
import com.sun.xacml.support.finder.PolicyReader;



/**
 * This module represents a collection of files containing polices,
 * each of which will be searched through when trying to find a
 * policy that is applicable to a specific request. It does not support
 * policy references.
 * &lt;p&gt;
 * Note that this class used to be provided in the
 * &lt;code&gt;com.sun.xacml.finder.impl&lt;/code&gt; package with a warning that it
 * would move out of the core packages eventually. This is partly because
 * this class doesn't represent standard functionality, and partly because
 * it isn't designed to be generally useful as anything more than an
 * example. Because so many people have used this class, however, it stayed
 * in place until the 2.0 release.
 * &lt;p&gt;
 * As of the 2.0 release, you may still use this class (in its new location),
 * but you are encouraged to migrate to the new support modules that are
 * much richer and designed for general-purpose use. Also, note that the
 * &lt;code&gt;loadPolicy&lt;/code&gt; methods that used to be available from this class
 * have been removed. That functionality has been replaced by the much more
 * useful &lt;code&gt;PolicyReader&lt;/code&gt; class. If you need to load policies
 * directly, you should consider that new class.
 *
 * @since 1.0
 * @author Seth Proctor
 */
public class FilePolicyModule 
		extends com.sun.xacml.support.finder.FilePolicyModule {

    // the reader used to load all policies
    private PolicyReader reader;

    // the Policy directory
    private String policyDir;

    // the schema file we're using, if any
<span class="nc" id="L112">    private File schemaFile = null;</span>

    // the logger we'll use for all messages
<span class="nc" id="L115">    private static final Logger logger =</span>
<span class="nc" id="L116">        Logger.getLogger(FilePolicyModule.class.getName());</span>

    /**
     * Constructor which retrieves the schema file to validate policies against
     * from the &lt;code&gt;PolicyReader.POLICY_SCHEMA_PROPERTY&lt;/code&gt;. If the
     * retrieved property is null, then no schema validation will occur.
     */
    public FilePolicyModule() {
<span class="nc" id="L124">    	super();</span>

<span class="nc" id="L126">        String schemaName =</span>
<span class="nc" id="L127">            System.getProperty(PolicyReader.POLICY_SCHEMA_PROPERTY);</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (schemaName != null)</span>
<span class="nc" id="L130">            schemaFile = new File(schemaName);</span>
<span class="nc" id="L131">    }</span>

    /**
     * Constructor that uses the specified &lt;code&gt;File&lt;/code&gt; as the schema
     * file for XML validation. If schema validation is not desired, a null
     * value should be used.
     *
     * @param schemaFile the schema file to validate policies against,
     *                   or null if schema validation is not desired.
     */
    public FilePolicyModule(File schemaFile) {
<span class="nc" id="L142">    	super(schemaFile);</span>
<span class="nc" id="L143">    	this.schemaFile = schemaFile;</span>
<span class="nc" id="L144">    }</span>

    /**
     * Constructor that uses the specified &lt;code&gt;String&lt;/code&gt; as the schema
     * file for XML validation. If schema validation is not desired, a null
     * value should be used.
     *
     * @param schemaFile the schema file to validate policies against,
     *                   or null if schema validation is not desired.
     */
    public FilePolicyModule(String schemaFile) {
<span class="nc" id="L155">    	super(schemaFile);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        this.schemaFile = ((schemaFile != null) ? new File(schemaFile) : null);    </span>
<span class="nc" id="L157">    }</span>

    /**
     * Constructor that specifies a set of initial policy files to use. This
     * retrieves the schema file to validate policies against from the
     * &lt;code&gt;PolicyReader.POLICY_SCHEMA_PROPERTY&lt;/code&gt;. If the retrieved
     * property is null, then no schema validation will occur.
     *
     * @param fileNames a &lt;code&gt;List&lt;/code&gt; of &lt;code&gt;String&lt;/code&gt;s that
     *                  identify policy files
     */
    public FilePolicyModule(List fileNames) {
<span class="nc" id="L169">    	super(fileNames);</span>

<span class="nc" id="L171">        String schemaName =</span>
<span class="nc" id="L172">            System.getProperty(PolicyReader.POLICY_SCHEMA_PROPERTY);</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (schemaName != null)</span>
<span class="nc" id="L175">            schemaFile = new File(schemaName);</span>
<span class="nc" id="L176">    }</span>

    /**
     * Constructor that specifies a set of initial policy files to use and
     * the schema file used to validate the policies. If schema validation is
     * not desired, a null value should be used.
     *
     * @param fileNames a &lt;code&gt;List&lt;/code&gt; of &lt;code&gt;String&lt;/code&gt;s that
     *                  identify policy files
     * @param schemaFile the schema file to validate policies against,
     *                   or null if schema validation is not desired.
     */
    public FilePolicyModule(List fileNames, String schemaFile) {
<span class="nc" id="L189">        super(fileNames,schemaFile);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        this.schemaFile = ((schemaFile != null) ? new File(schemaFile) : null);    </span>
<span class="nc" id="L191">    }</span>

    /**
     * Initializes the &lt;code&gt;FilePolicyModule&lt;/code&gt; by loading
     * the policies contained in the collection of files associated
     * with this module. This method also uses the specified 
     * &lt;code&gt;PolicyFinder&lt;/code&gt; to help in instantiating PolicySets.
     * 
     * init() also gets the Policy file directory to be used for
     * resolving references.
     *
     * @param finder a PolicyFinder used to help in instantiating PolicySets
     */
    public void init(PolicyFinder finder) {
<span class="nc" id="L205">    	super.init(finder);</span>
<span class="nc" id="L206">    	reader = new PolicyReader(finder, logger, schemaFile);</span>
<span class="nc" id="L207">    	policyDir = Login.getProps().getProperty(</span>
    		&quot;XACMLPolicyDir&quot;, &quot;webapps/share/WEB-INF/classes/xacml/policy/&quot;);
<span class="nc" id="L209">    }</span>

    /**
     * Always returns &lt;code&gt;true&lt;/code&gt; since this module does support
     * finding policies based on reference.
     *
     * @return true
     */
    public boolean isIdReferenceSupported() {
<span class="nc" id="L218">        return true;</span>
    }

    /**
     * Attempts to find a policy by reference, based on the provided
     * parameters. Specifically, this module will try to treat the reference
     * as a URL, and resolve that URL directly. If the reference is not
     * a valid URL, cannot be resolved, or does not resolve to an XACML
     * policy, then no matching policy is returned. This method never
     * returns an error.
     *
     * @param idReference an identifier specifying some policy
     * @param type type of reference (policy or policySet) as identified by
     *             the fields in &lt;code&gt;PolicyReference&lt;/code&gt;
     * @param constraints any optional constraints on the version of the
     *                    referenced policy (this will never be null, but
     *                    it may impose no constraints, and in fact will
     *                    never impose constraints when used from a pre-2.0
     *                    XACML policy)
     * @param parentMetaData the meta-data from the parent policy, which
     *                       provides XACML version, factories, etc.
     *
     * @return the result of looking for a matching policy
     */
    public PolicyFinderResult findPolicy(URI idReference, int type,
                                         VersionConstraints constraints,
                                         PolicyMetaData parentMetaData) {
        // see if the URI is in fact a URL
<span class="nc" id="L246">        URL url = null;</span>
        try {
<span class="nc" id="L248">            url = new URL(&quot;file:&quot;+policyDir+idReference.toString()+&quot;.xml&quot;);</span>
<span class="nc" id="L249">        } catch (MalformedURLException murle) {</span>
            // it's not a URL, so we can't handle this reference
<span class="nc" id="L251">            return new PolicyFinderResult();</span>
<span class="nc" id="L252">        }</span>

        // try resolving the URL
<span class="nc" id="L255">        AbstractPolicy policy = null;</span>
        try {
<span class="nc" id="L257">            policy = reader.readPolicy(url);</span>
<span class="nc" id="L258">        } catch (ParsingException pe) {</span>
            // An error loading the policy could be many things (the URL
            // doesn't actually resolve a policy, the server is down, the
            // policy is invalid, etc.). This could be interpreted as an
            // error case, or simply as a case where no applicable policy
            // is available (as is done when we pre-load policies). This
            // module chooses the latter interpretation.
<span class="nc" id="L265">            return new PolicyFinderResult();</span>
<span class="nc" id="L266">        }</span>

        // check that we got the right kind of policy...if we didn't, then
        // we can't handle the reference
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (type == PolicyReference.POLICY_REFERENCE) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">            if (! (policy instanceof Policy))</span>
<span class="nc" id="L272">                return new PolicyFinderResult();</span>
        } else {
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (! (policy instanceof PolicySet))</span>
<span class="nc" id="L275">                return new PolicyFinderResult();</span>
        }

        // finally, check that the constraints match ... note that in a more
        // powerful module, you could actually have used the constraints to
        // construct a more specific URL, passed the constraints to the
        // server, etc., but this example module is staying simple
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (! constraints.meetsConstraint(policy.getVersion()))</span>
<span class="nc" id="L283">            return new PolicyFinderResult();</span>

        // if we got here, then we successfully resolved a policy that is
        // the correct type, so return it
<span class="nc" id="L287">        return new PolicyFinderResult(policy);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>