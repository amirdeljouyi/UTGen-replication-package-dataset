<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>User.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">75_openhre</a> &gt; <a href="index.source.html" class="el_package">com.browsersoft.aacs</a> &gt; <span class="el_source">User.java</span></div><h1>User.java</h1><pre class="source lang-java linenums">/*
 *   CVS $Id: User.java,v 1.1 2006/11/06 19:51:47 grodecki Exp $
 * 
 *   ====================================================================
 *                 Open Source Health Records Exchange
 *   ====================================================================
 *
 *   Copyright (C) 2005 Browsersoft Inc.
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License, version 2, 
 *   as published by the Free Software Foundation.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   The GNU General Public License is available at
 *   http://www.fsf.org/licensing/licenses/gpl.html
 *
 *   Email: info@openhre.org
 *   Web:   http://www.openhre.org
 */
package com.browsersoft.aacs;

import java.io.Serializable;
import java.security.MessageDigest;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Properties;
import java.util.Set;
import java.util.StringTokenizer;

import javax.naming.ldap.LdapContext;

import org.apache.xerces.impl.dv.util.Base64;


/**
 * User class contains all the necessary attributes of a logged in user
 * @author $Author: grodecki $
 * @version $Id: User.java,v 1.1 2006/11/06 19:51:47 grodecki Exp $
 */
public class User implements Comparable, Serializable {
   // static final long serialVersionUID = -3313178117323543078L;
    static final long serialVersionUID = 6729362233633496647L;

<span class="fc" id="L49">    private String userId = &quot;&quot;;   		// id (key)</span>
    private String ipAddr;   			// current IP address
<span class="fc" id="L51">    private String userName = &quot;&quot;;    	//cn CommonName</span>
<span class="fc" id="L52">    private String email=&quot;&quot;;</span>
    private Set roles;
    private Set groups;
    private Set activegroups;			// Groups active for the user based on his location
<span class="fc" id="L56">	private String passvalidstart=&quot;&quot;;</span>
<span class="fc" id="L57">	private String passrenewal=&quot;&quot;;</span>
<span class="fc" id="L58">	private boolean passchange = false;	// user password change required before using the system?</span>
    private Set allowedips;
    LdapContext dctx;
    // private String dn;  //Distinguished name    (cn, o, c)
<span class="fc" id="L62">    private String country = &quot;&quot;;                // c</span>
<span class="fc" id="L63">    private String organization = &quot;&quot;;           // o</span>
<span class="fc" id="L64">    private String passwd = &quot;&quot;; // encrypted    // userPassword</span>
<span class="fc" id="L65">    private String sn = &quot;&quot;; // surname</span>
    private transient MessageDigest sha;
<span class="fc" id="L67">    private static String sep = System.getProperty(&quot;line.separator&quot;);</span>
<span class="fc" id="L68">    private static String salt = &quot;XXXX&quot;;</span>

<span class="fc" id="L70">    private static org.apache.log4j.Logger cat </span>
<span class="fc" id="L71">      = org.apache.log4j.Logger.getLogger(User.class.getName());</span>

<span class="fc" id="L73">    public User() {</span>
<span class="fc" id="L74">    }</span>

    /**
     * User object constructed from userId and userName
     */
    public User(String userId, String userName) {
<span class="fc" id="L80">    	this();</span>
    	//	System.out.println(&quot;userId: &quot;+userId);
<span class="fc" id="L82">        this.userId = userId.trim();        //id</span>
<span class="fc" id="L83">        this.userName = userName.trim();      //cn</span>
<span class="fc" id="L84">    }</span>
    
    public void init() {
        try {
<span class="fc" id="L88">            sha = MessageDigest.getInstance(&quot;SHA-1&quot;);</span>
<span class="nc" id="L89">        } catch (java.security.NoSuchAlgorithmException e) {</span>
<span class="nc" id="L90">            cat.error(&quot;SHA-1 constructor failed: &quot;,e);</span>
<span class="fc" id="L91">        }</span>
<span class="fc" id="L92">    }</span>

    /**
     * get userId previously set
     * @return userId
     */
    public String getUserId() {
        //	System.out.println(&quot;getUserId: &quot;+userId);
<span class="fc" id="L100">        return userId;</span>
    }

    /**
     * set the UserId
     * @param id to be set
     */
    public void setUserId(String id) {
<span class="fc" id="L108">        userId = id.trim();</span>
<span class="fc" id="L109">    }</span>

    /**
     * encode the  password
     * @param password to be encoded
     */
    public void encodePassword(String password) {
        // only set password if it is non null.
<span class="pc bpc" id="L117" title="1 of 6 branches missed.">        if (passwd != null &amp;&amp; (password != null) &amp;&amp; !password.equals(&quot;&quot;))</span>
<span class="fc" id="L118">          passwd = createDigest(salt.getBytes(), password);</span>
<span class="fc" id="L119">    }</span>

    /**
     * Validate the password
     * @param password
     * @return
     */
    public boolean checkPassword(String password) {
<span class="fc bfc" id="L127" title="All 2 branches covered.">        if (passwd == null) return false;</span>
<span class="fc" id="L128">        return checkDigest(passwd, password);</span>
    }
    
    /**
     * set the encrypted password
     * @param password  as encrypted digest (SHA algorithm)
     */
    public void setPassword(String password) {
<span class="fc" id="L136">        passwd = password;</span>
<span class="fc" id="L137">    }</span>

    /**
     * get the encrypted Password
     * @return encrypted password string
     */
    public String getPassword() {
<span class="fc" id="L144">        return passwd;</span>
    }

    /**
     * set the SurName
     * @param surname
     */
    public void setSurName(String surname) {
<span class="fc" id="L152">        sn = surname;</span>
<span class="fc" id="L153">    }</span>

    /**
     * get the SurName
     * @return sn
     */
    public String getSurName() {
<span class="fc" id="L160">        return sn;</span>
    }

    /**
     * get userName
     * @return userName
     */
    public String getUserName() {
<span class="fc" id="L168">        return userName;</span>
    }

    /**
     * set the User Name (cn field in LDAP
     * @param name
     */
    public void setUserName(String name) {
<span class="fc" id="L176">        userName = name.trim();</span>
<span class="fc" id="L177">    }</span>

    /**
     * get the IpAddr of this user
     * @return String containing ipAddr
     */
    public String getIpAddr() {
<span class="fc" id="L184">        return ipAddr;</span>
    }

    /**
     * set the IpAddr of this user
     * @param ipAddr  (should validate the address)
     */
    public void setIpAddr(String ipAddr) {
<span class="fc" id="L192">        this.ipAddr = ipAddr;</span>
<span class="fc" id="L193">    }</span>
    
    public String getEmail() {
<span class="nc" id="L196">        return email;</span>
    }

    public void setEmail(String email) {
<span class="fc" id="L200">        email = email.trim();</span>
<span class="fc" id="L201">    }</span>
    
    public Set getRoles() {
<span class="fc" id="L204">        return roles;</span>
    }

    public void addRole(String role) {
<span class="fc bfc" id="L208" title="All 2 branches covered.">        if (roles == null)</span>
<span class="fc" id="L209">            roles = new HashSet();</span>
<span class="fc" id="L210">        roles.add(role);</span>
<span class="fc" id="L211">    }</span>

    public Set getGroups() {
<span class="fc" id="L214">        return groups;</span>
    }

    public void addGroup(String group) {
<span class="fc bfc" id="L218" title="All 2 branches covered.">        if (groups == null)</span>
<span class="fc" id="L219">            groups = new HashSet();</span>
<span class="fc" id="L220">        groups.add(group);</span>
<span class="fc" id="L221">    }</span>
    
    public Set getActivegroups() {
<span class="fc" id="L224">        return activegroups;</span>
    }

    public void addActivegroup(String group) {
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (activegroups == null)</span>
<span class="fc" id="L229">            activegroups = new HashSet();</span>
<span class="fc" id="L230">        activegroups.add(group);</span>
<span class="fc" id="L231">    }</span>
    
    public String getPassvalidstart() {
<span class="nc" id="L234">	    return passvalidstart;</span>
	}
	
	public void setPassvalidstart(String passvalidstart) {
<span class="fc" id="L238">		this.passvalidstart = passvalidstart;</span>
<span class="fc" id="L239">	}</span>

	public String getPassrenewal() {
<span class="fc" id="L242">	    return passrenewal;</span>
	}
	
	public void setPassrenewal(String passrenewal) {
<span class="fc" id="L246">		this.passrenewal = passrenewal;</span>
<span class="fc" id="L247">	}	</span>

	public boolean getPasschange() {
<span class="fc" id="L250">	    return passchange;</span>
	}
	
	public void setPasschange(boolean passchange) {
<span class="fc" id="L254">		this.passchange = passchange;</span>
<span class="fc" id="L255">	}</span>
        
    public Set getAllowedips() {
<span class="fc" id="L258">        return allowedips;</span>
    }

    public void addAllowedip(String allowed_ip) {
<span class="fc bfc" id="L262" title="All 2 branches covered.">        if (allowedips == null)</span>
<span class="fc" id="L263">            allowedips = new HashSet();</span>
<span class="fc" id="L264">        allowedips.add(allowed_ip);</span>
<span class="fc" id="L265">    }</span>
    
    public void setLdapContext(LdapContext dctx) {
<span class="fc" id="L268">        this.dctx = dctx;</span>
<span class="fc" id="L269">    }</span>
    
    public LdapContext getLdapContext() {
<span class="fc" id="L272">        return dctx;</span>
    }
    
    /**
     * set the Distinguished Name of the person
     * @param dn containing distinguished name    (should check its validity)
     */
    public void setDN(String dn) {
      //  cat.debug(&quot;setDN: &quot; + dn);
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (dn != null) {</span>
<span class="fc" id="L282">            StringTokenizer st = new StringTokenizer(dn, &quot;,&quot;);</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">            while (st.hasMoreTokens()) {</span>
<span class="fc" id="L284">                String tok = st.nextToken();</span>
<span class="fc" id="L285">                StringTokenizer stoken = new StringTokenizer(tok, &quot;=&quot;);</span>
<span class="fc" id="L286">                String name = stoken.nextToken();</span>
                // System.out.println(&quot;token: &quot;+tok +&quot; name: &quot;+name);
<span class="fc bfc" id="L288" title="All 2 branches covered.">                if (name.trim().equals(&quot;o&quot;)) {</span>
<span class="fc" id="L289">                    organization = stoken.nextToken();</span>
                    //   cat.debug(&quot;org: &quot;+organization);
                    //break;
<span class="fc bfc" id="L292" title="All 2 branches covered.">                } else if (name.trim().equals(&quot;c&quot;)) {</span>
<span class="fc" id="L293">                    country = stoken.nextToken();</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">                } else if (name.trim().equals(&quot;cn&quot;)) {</span>
<span class="fc" id="L295">                    userName = stoken.nextToken();</span>
                }

<span class="fc" id="L298">            }</span>
<span class="fc" id="L299">        }</span>
        else
<span class="fc" id="L301">          cat.warn(&quot;setDN: dn is null&quot;);</span>
<span class="fc" id="L302">        return;</span>
    }

    /**
     * set the salt for encryption
     * @param theSalt
     */
    public static void setSalt(String theSalt) {
<span class="fc" id="L310">        salt = theSalt;</span>
<span class="fc" id="L311">    }</span>

    /**
     * get the Distinguished Name of the Person
     * @return String containing the distinguished name
     */
    public String getDN() {
<span class="fc" id="L318">        return &quot;cn=&quot; + userName + &quot;, o=&quot; + organization + &quot;, c=&quot; + country;</span>
        //  return dn;
    }

    /**
     * get the country (c) parameter
     * @return country
     */
    public String getCountry() {
<span class="fc" id="L327">        return country;</span>
    }

    /**
     * set the country parameter
     * @param c country
     */
    public void setCountry(String c) {
<span class="fc" id="L335">        country = c;</span>
<span class="fc" id="L336">    }</span>

    /**
     * get the Organization of the user from the Distinguished Name dn
     * @return String representing the organization
     * The dn string is of the form cn=&quot;name&quot;, o=&quot;organization&quot;, c=&quot;country&quot;
     */
    public String getOrg() {

<span class="fc" id="L345">        return organization;</span>
    }
    /**
     * Return a Properties sheet with identification
     * @return
     */
    public Properties getCredentials() {
<span class="fc" id="L352">        Properties props = new Properties();</span>
<span class="fc" id="L353">        props.setProperty(&quot;subjectDN&quot;, getDN());</span>
<span class="fc" id="L354">        props.setProperty(&quot;EMail&quot;,getUserId());</span>
<span class="fc" id="L355">        return props;</span>
    }
    
    /**
     * set the organization
     */
    public void setOrg(String org) {
<span class="fc" id="L362">        organization = org;</span>
<span class="fc" id="L363">    }</span>

    /**
     * copy nonempty fiels into the fields of object
     * @param newUser
     */
    public void update(User newUser) {
<span class="fc" id="L370">        organization = newUser.getOrg();</span>
<span class="fc" id="L371">        country = newUser.getCountry();</span>
<span class="fc" id="L372">        roles = newUser.getRoles();</span>
<span class="fc" id="L373">        groups = newUser.getGroups();</span>
<span class="fc" id="L374">        userName = newUser.getUserName();</span>
<span class="fc" id="L375">        sn = newUser.getSurName();</span>
<span class="fc" id="L376">        passwd = newUser.getPassword();</span>
<span class="fc" id="L377">        userId = newUser.getUserId();</span>

<span class="fc" id="L379">    }</span>

    /**
     * String representation of user is simply its userId;
     * @return String representation of User
     */
    public String toString() {

        // char sep = '\n';
<span class="fc" id="L388">        StringBuffer buff = new StringBuffer();</span>
<span class="fc" id="L389">        buff.append(&quot;dn: &quot; + getDN() + sep);</span>
<span class="fc" id="L390">        buff.append(&quot;cn: &quot; + getUserName() + sep);</span>
<span class="fc" id="L391">        buff.append(&quot;id: &quot; + getUserId() + sep);</span>
<span class="fc" id="L392">        buff.append(&quot;sn: &quot; + getSurName() + sep);</span>
<span class="fc" id="L393">        buff.append(&quot;userPassword: &quot; + getPassword() + sep);</span>
        
<span class="fc bfc" id="L395" title="All 2 branches covered.">        if (getRoles() != null) {</span>
<span class="fc" id="L396">	        Iterator it = getRoles().iterator();</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">	        while (it.hasNext())</span>
<span class="fc" id="L398">	            buff.append(&quot;role: &quot; + (String)(it.next()) + sep);</span>
        }
        
<span class="fc bfc" id="L401" title="All 2 branches covered.">        if (getGroups() != null) {</span>
<span class="fc" id="L402">	        Iterator it = getGroups().iterator();</span>
<span class="fc bfc" id="L403" title="All 2 branches covered.">	        while (it.hasNext())</span>
<span class="fc" id="L404">	            buff.append(&quot;group: &quot; + (String)(it.next()) + sep);</span>
        }
        
<span class="fc bfc" id="L407" title="All 2 branches covered.">        if (getIpAddr() != null) buff.append(&quot;ip: &quot;+ getIpAddr() +sep);</span>
<span class="fc" id="L408">        buff.append(&quot;objectClass: top&quot; + sep);</span>
<span class="fc" id="L409">        buff.append(&quot;objectClass: person&quot; + sep);</span>
<span class="fc" id="L410">        return buff.toString();</span>
    }

    /**
     * String representation with user defined separator
     * @param sep
     * @return String representation of User
     */
    public String toString(String sep) {
<span class="fc" id="L419">        StringBuffer buff = new StringBuffer();</span>
<span class="fc" id="L420">        buff.append(&quot;dn: &quot; + getDN() + sep);</span>
<span class="fc" id="L421">        buff.append(&quot;cn: &quot; + getUserName() + sep);</span>
<span class="fc" id="L422">        buff.append(&quot;id: &quot; + getUserId() + sep);</span>
<span class="fc" id="L423">        buff.append(&quot;sn: &quot; + getSurName() + sep);</span>
<span class="fc" id="L424">        buff.append(&quot;userPassword: &quot; + getPassword() + sep);</span>
        
<span class="fc" id="L426">        Set rolebuf = new HashSet();</span>
<span class="fc" id="L427">        rolebuf = getRoles();</span>
<span class="fc" id="L428">        Iterator it = rolebuf.iterator();</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">        while (it.hasNext())</span>
<span class="fc" id="L430">            buff.append(&quot;role: &quot; + (String)(it.next()) + sep);</span>
        
<span class="fc" id="L432">        Set groupbuf = new HashSet();</span>
<span class="fc" id="L433">        groupbuf = getGroups();</span>
<span class="fc" id="L434">        it = groupbuf.iterator();</span>
<span class="fc bfc" id="L435" title="All 2 branches covered.">        while (it.hasNext())</span>
<span class="fc" id="L436">            buff.append(&quot;group: &quot; + (String)(it.next()) + sep);</span>
        
<span class="fc" id="L438">        buff.append(&quot;objectClass: top&quot; + sep);</span>
<span class="fc" id="L439">        buff.append(&quot;objectClass: person&quot; + sep);</span>
<span class="fc" id="L440">        return buff.toString();</span>
    }

    /**
     * create hashCode combining unique userId and ipAddr so user 
     * is distinguished coming from different &quot;locations&quot;
     */
    public int hashCode() {
        // Improve hashcode calculation using member variables of this class
<span class="nc" id="L449">        return 13 * userId.hashCode() + 7 * ipAddr.hashCode();</span>
    }

    /**
     *  Equality check for user to see if he is already known.
     */
    public boolean equals(Object user) {
        // Return true if the result of the compareTo() method is zero
<span class="fc bfc" id="L457" title="All 2 branches covered.">        return compareTo(user) == 0;</span>
    }

    /**
     *  Compare to operation to see if the input user is the same as this user.
     */
    public int compareTo(Object user) {
        // Compare the user IDs of the two user objects -
        //  result is zero if they're identical (uses String compareTo function)
<span class="fc" id="L466">        int result = userId.compareTo(((User) user).getUserId());</span>

        // If result is zero from previous method, return the comparison of IP addresses.
        // Otherwise, return the result.
<span class="fc bfc" id="L470" title="All 2 branches covered.">        return result == 0 ? ipAddr.compareTo(((User) user).getIpAddr()) : result;</span>
    }
    /**
     * Create Digest for each input identity
     * @param salt to set the base for the encryption
     * @param identity to be encrypted
     */

    public String createDigest(byte[] salt, String identity) {
<span class="fc bfc" id="L479" title="All 2 branches covered.">        String label = (salt.length &gt; 0) ? &quot;{SSHA}&quot; : &quot;{SHA}&quot;;</span>

<span class="fc bfc" id="L481" title="All 2 branches covered.">        if (sha == null) init();</span>
<span class="fc" id="L482">        sha.reset();</span>
<span class="fc" id="L483">        sha.update(identity.getBytes());</span>
<span class="fc" id="L484">        sha.update(salt);</span>
<span class="fc" id="L485">        byte[] pwhash = sha.digest();</span>
<span class="fc" id="L486">        return label + new String(Base64.encode(concatenate(pwhash, salt)));</span>
    }

    /**
     * Check Digest against identity
     * @param digest is digest to be checked against
     * @param identity to be checked
     */
    public boolean checkDigest(String digest, String identity) {
<span class="fc bfc" id="L495" title="All 2 branches covered.">        if (digest.regionMatches(true, 0, &quot;{SHA}&quot;, 0, 5)) {</span>
<span class="fc" id="L496">            digest = digest.substring(5); // ignore the label</span>
<span class="fc bfc" id="L497" title="All 2 branches covered.">        } else if (digest.regionMatches(true, 0, &quot;{SSHA}&quot;, 0, 6)) {</span>
<span class="fc" id="L498">            digest = digest.substring(6); // ignore the label</span>
        }

<span class="fc" id="L501">        byte[][] hs = split(Base64.decode(digest.getBytes()), 20);</span>
<span class="fc" id="L502">        byte[] hash = hs[0];</span>
<span class="fc" id="L503">        byte[] salt = hs[1];</span>

<span class="fc bfc" id="L505" title="All 2 branches covered.">        if (sha == null) init();</span>
<span class="fc" id="L506">        sha.reset();</span>
<span class="fc" id="L507">        sha.update(identity.getBytes());</span>
<span class="fc" id="L508">        sha.update(salt);</span>
<span class="fc" id="L509">        byte[] pwhash = sha.digest();</span>
<span class="fc" id="L510">        boolean valid = true;</span>
<span class="fc bfc" id="L511" title="All 2 branches covered.">        if (!MessageDigest.isEqual(hash, pwhash)) {</span>
<span class="fc" id="L512">            valid = false;</span>
<span class="fc" id="L513">            cat.warn(&quot;doesn't match: &quot; + identity);</span>

        }

<span class="fc" id="L517">        return valid;</span>
    }
    /**
     * Combine two byte arrays
     * @param l first byte array
     * @param r second byte array
     * @return byte[] combined byte array
     */
    private static byte[] concatenate(byte[] l, byte[] r) {
<span class="fc" id="L526">        byte[] b = new byte[l.length + r.length];</span>
<span class="fc" id="L527">        System.arraycopy(l, 0, b, 0, l.length);</span>
<span class="fc" id="L528">        System.arraycopy(r, 0, b, l.length, r.length);</span>
<span class="fc" id="L529">        return b;</span>
    }

    /**
     * split a byte array in two
     * @param src byte array to be split
     * @param n element at which to split the byte array
     * @return byte[][]  two byte arrays that have been split
     */
    private static byte[][] split(byte[] src, int n) {
        byte[] l, r;
<span class="fc bfc" id="L540" title="All 4 branches covered.">        if (src == null || src.length &lt;= n) {</span>
<span class="fc" id="L541">            l = src;</span>
<span class="fc" id="L542">            r = new byte[0];</span>
        } else {
<span class="fc" id="L544">            l = new byte[n];</span>
<span class="fc" id="L545">            r = new byte[src.length - n];</span>
<span class="fc" id="L546">            System.arraycopy(src, 0, l, 0, n);</span>
<span class="fc" id="L547">            System.arraycopy(src, n, r, 0, r.length);</span>
        }
<span class="fc" id="L549">        byte[][] lr = {l, r};</span>
<span class="fc" id="L550">        return lr;</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>