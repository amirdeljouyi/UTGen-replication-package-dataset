<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Login.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">75_openhre</a> &gt; <a href="index.source.html" class="el_package">com.browsersoft.aacs</a> &gt; <span class="el_source">Login.java</span></div><h1>Login.java</h1><pre class="source lang-java linenums">/*
 *   CVS $Id: Login.java,v 1.1 2006/11/06 19:51:47 grodecki Exp $
 * 
 *   ====================================================================
 *                 Open Source Health Records Exchange
 *   ====================================================================
 *
 *   Copyright (C) 2005, 2006 Browsersoft Inc.
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License, version 2, 
 *   as published by the Free Software Foundation.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   The GNU General Public License is available at
 *   http://www.fsf.org/licensing/licenses/gpl.html
 *
 *   Email: info@openhre.org
 *   Web:   http://www.openhre.org
 */
package com.browsersoft.aacs;

import java.io.File;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Properties;
import java.util.Set;
import java.util.StringTokenizer;
import java.util.TimeZone;

import javax.security.auth.login.LoginException;

import org.apache.log4j.FileAppender;
import org.apache.log4j.Level;
import org.apache.log4j.Logger;
import org.apache.log4j.SimpleLayout;

import com.browsersoft.aacs.xacml.PDPadapter;
import com.browsersoft.aacs.xacml.RequestBuilder;
import com.sun.xacml.Indenter;
import com.sun.xacml.ctx.RequestCtx;

/**
 * This class manages authentication and user 
 * attribute retrieval when a user tries to log in.
 */

public class Login {


    //private static String[] names = null;

	//private static String[] mail = null;

<span class="nc" id="L63">    private String username = &quot;&quot;;</span>
<span class="nc" id="L64">    private static String organization = &quot;OPENHRE&quot;;</span>
<span class="nc" id="L65">    private static String country = &quot;US&quot;;</span>
<span class="nc" id="L66">    private String password = &quot;&quot;;</span>
<span class="nc" id="L67">    private String userid = &quot;&quot;;</span>
<span class="nc" id="L68">    private String ipAddr = &quot;&quot;;</span>
   // private static String userdb = &quot;users&quot;;
<span class="nc" id="L70">    private static String configFile = &quot;AACS&quot;; //AACS.properties</span>
<span class="nc" id="L71">    private static String authType = &quot;simple&quot;;</span>
<span class="nc" id="L72">    private static String xacmlConfig = &quot;&quot;;</span>
<span class="nc" id="L73">    private static String securityLog = &quot;&quot;;</span>
<span class="nc" id="L74">    private static String securityLogFilePath = &quot;&quot;;</span>
    
    private final static String appDateFormat = &quot;MM/dd/yyyy&quot;;			// Date format used by OpenHRE
    private final static String ldapGTFormat = &quot;yyyyMMddHHmmssZ&quot;;		// LDAP GeneralizedTime Format

    private static Properties props;

    private static UserMgr userMgr;
    private static PDPadapter pdpadapter;
    private User user;
    private LdapService lservice;
    
<span class="nc" id="L86">    private static Logger cat = Logger.getLogger(Login.class.getName());</span>
    

    /**
     * Public default constructor
     */
<span class="nc" id="L92">    public Login() {</span>

<span class="nc" id="L94">    }</span>

    /**
     * Construct a Login with a UserId
     */
    public Login(String userId) {
<span class="nc" id="L100">    	this();</span>
<span class="nc" id="L101">    	this.setUserId(userId);</span>
<span class="nc" id="L102">    }</span>

    /**
     * Construct a Login with a UserId and IP Address
     */
    public Login(String userId, String ipAddr) {
<span class="nc" id="L108">    	this(userId);</span>
<span class="nc" id="L109">    	this.setIpAddr(ipAddr);</span>
<span class="nc" id="L110">    }</span>

    /**
     * @param theConfigFile the properties file
     */
    public static void setConfigFile(String theConfigFile) {
<span class="nc" id="L116">        configFile = theConfigFile;</span>
<span class="nc" id="L117">    }</span>
    /**
     * Load and get the Properties from the Config File
     * @param theConfigFile the properties file
     */
    public static Properties getProps(String theConfigFile) {
<span class="nc" id="L123">    	setConfigFile(theConfigFile);</span>
<span class="nc" id="L124">    	return getProps();</span>
    }
    /**
     * Load and get the Properties from the preset Config File
     */
    public static Properties getProps() {
<span class="nc" id="L130">    	init();</span>
<span class="nc" id="L131">    	return props;</span>
    }
    /**
     * Initialize and load all the users.
     */
    public static String getSecurityLogFilePath() {
<span class="nc" id="L137">        return securityLogFilePath;</span>
    }
    public static void init() {
<span class="nc bnc" id="L140" title="All 2 branches missed.">    	if (props != null) return;</span>
<span class="nc" id="L141">        props = new Properties();</span>
<span class="nc" id="L142">        cat.info(&quot;Loading Properties from &quot; + configFile);</span>
<span class="nc" id="L143">    	loadProperties(props, configFile);</span>
    	
        // set the default organization and country
<span class="nc" id="L146">        organization = props.getProperty(&quot;organization&quot;, &quot;OPENHRE&quot;);</span>
<span class="nc" id="L147">        country = props.getProperty(&quot;country&quot;, &quot;US&quot;);</span>
<span class="nc" id="L148">        authType = props.getProperty(&quot;AuthType&quot;, &quot;simple&quot;);</span>
<span class="nc" id="L149">        xacmlConfig = props.getProperty(&quot;XACMLConfig&quot;, &quot;&quot;);</span>

<span class="nc" id="L151">        cat.info(&quot;organization is &quot; + organization);</span>
<span class="nc" id="L152">        cat.info(&quot;country is &quot; + country);</span>
<span class="nc" id="L153">        cat.info(&quot;AuthType is &quot; + authType);</span>
<span class="nc" id="L154">        cat.info(&quot;XACMLConfig is &quot; + xacmlConfig);</span>
        
<span class="nc" id="L156">        securityLog = props.getProperty(&quot;SecurityLog&quot;, &quot;&quot;);</span>
        // create security log file if it doesn't exist
        try {
<span class="nc" id="L159">            File file = new File(securityLog);</span>
<span class="nc" id="L160">            securityLogFilePath = file.getAbsolutePath();</span>
<span class="nc" id="L161">            cat.info(&quot;Preparing Security Log file &quot; + securityLogFilePath);</span>
        
            // Create file if it does not exist
<span class="nc" id="L164">            file.createNewFile();</span>
            
            // Get the XACML PDPadapter
<span class="nc" id="L167">            pdpadapter = new PDPadapter(xacmlConfig);</span>
            
<span class="nc" id="L169">        } catch (Exception e) {</span>
<span class="nc" id="L170">            cat.fatal(&quot;Exception initializing Login manager&quot;,e);</span>
<span class="nc" id="L171">            e.printStackTrace();</span>
<span class="nc" id="L172">        }</span>
        
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (userMgr == null) {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">	        if (authType.equals(&quot;simple&quot;)) {        	</span>
<span class="nc" id="L176">	            userMgr = new SimpleUserMgr(configFile);</span>
	        }
<span class="nc bnc" id="L178" title="All 2 branches missed.">	        else if (authType.equals(&quot;krb5&quot;)) {        	</span>
<span class="nc" id="L179">	            userMgr = new KrbUserMgr();</span>
	        }
        }
       
<span class="nc" id="L183">    }</span>

    public static void loadProperties(Properties props, String configFile) {
 	   	try {
<span class="nc" id="L187"> 	   		props.load(Login.class.getResourceAsStream(configFile+&quot;.properties&quot;));</span>
<span class="nc" id="L188"> 	   	} catch (Exception e) {</span>
<span class="nc" id="L189"> 	   		System.out.println(&quot;Could not read &quot;+configFile+&quot;.properties&quot;);</span>
<span class="nc" id="L190"> 	   		e.printStackTrace();</span>
<span class="nc" id="L191"> 	   	}</span>
<span class="nc" id="L192">    }</span>


    /** set the username  and get the user corresponding to the resulting dn
     * @param username
     */
    public void setUsername(String username) {
//		System.out.println(&quot;setting username: &quot; +username);
//        user = null;
<span class="nc" id="L201">        this.username = username.trim();</span>
        //user = userMgr.getUser(username, organization);
<span class="nc" id="L203">        user.setUserName(username);</span>
<span class="nc" id="L204">        cat.debug(&quot;setUserName: &quot;+username);</span>

<span class="nc" id="L206">    }</span>

    /**
     * Get filepath of security log.
     * ASSUMPTION: init() was called (i.e. securityLog was initialized)
     * @return absolute filepath
     */


    /**
     * get the current username  from user if defined
     */
    public String getUsername() {
<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (user != null)</span>
<span class="nc" id="L220">            return user.getUserName();</span>
        else
<span class="nc" id="L222">            return username;</span>
    }
    /**
     * set ipAddr for login
     * @param ipAddr
     */
    public void setIpAddr(String ipAddr) {
<span class="nc" id="L229">        this.ipAddr = ipAddr;</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (user != null)</span>
<span class="nc" id="L231">            user.setIpAddr(ipAddr);</span>
<span class="nc" id="L232">    }</span>
    /**
     * get ipAddress of user if defined
     * return String
     */
    public String getIpAddr() {
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (user != null)</span>
<span class="nc" id="L239">            return user.getIpAddr();</span>
        else
<span class="nc" id="L241">            return ipAddr;</span>
    }
    /**
     * set the password
     * @param password
     */
    public void setPassword(String password) {
<span class="nc" id="L248">        this.password = password;</span>
<span class="nc" id="L249">    }</span>


    /**
     *  set the email address
     * @param email address
     */
/*    public void setEmail(String email) {
//		System.out.println(&quot;setting email: &quot;+email);
        this.email = email;
        if (user != null) user.setUserId(email);
    }
*/
    
    /**
     * set the active user from the userId
     * @param userId
     */
    public void setUserId(String usrId) {
<span class="nc" id="L268">    	userid = usrId;</span>
<span class="nc" id="L269">        cat.debug(&quot;setUserId: &quot;+userid);</span>

<span class="nc" id="L271">    }</span>
    

    /**
     * get the current User
     */
    public User getUser() {
<span class="nc" id="L278">        return user;</span>
    }
    

    /**
     * get the current User ID
     */
    public String getUserId() {
        //getUser();
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (user != null)</span>
<span class="nc" id="L288">            return user.getUserId();</span>
        else
<span class="nc" id="L290">            return null;</span>
    }
    

    /**
     * get the current email address
     */
    public String getEmail() {
        //getUser();
<span class="nc bnc" id="L299" title="All 2 branches missed.">        if (user != null)</span>
<span class="nc" id="L300">            return user.getUserId();</span>
        else
<span class="nc" id="L302">            return null;</span>
    }
    
    /**
     * get the current LdapService
     */
    public LdapService getLdapService() {
<span class="nc bnc" id="L309" title="All 2 branches missed.">        if (lservice == null)</span>
<span class="nc" id="L310">        	return (lservice = new LdapService(user.getLdapContext()));</span>
        else
<span class="nc" id="L312">        	return lservice;</span>
    }

        /**
     * get the User from one of two ways. Return the current user if it is already defined.
     * First see if there is a defined email address (userId) and get the user directly
     * If not, then check the organization table and the the associated table of username
     * using the username and organization (country is defaulted to &quot;US&quot;).
     */
/*    public User getUser() {
        //   try {
        // makeDN();
        if (user != null) return user;
        if (userid != null || userid != &quot;&quot;)
            user = userMgr.getUser(userid);
        else
            user = userMgr.getUser(username, organization, userid);
        cat.debug(&quot;getUser: &quot;+user);
        return user;

    }
*/
    /**
     * return the role of the current user.
     * @return String containing the Role of the current user
     /
    public String getRole() {
        if (user != null)
            return user.getRole();
        else
            return null;
    }

    /**
     * get the Distinguished Name of the user
     * @return String containing the distinguished name
     /
    public String getDN() {
        if (user != null)
            return user.getDN();
        else
            return null;
    }
    */
    
    /**
     * Authorize a User without checking the password.
     * Note that this should only be called for Users
     * that are already Authenticated.
     * @return user
     */
    public User authorize() 
			throws LoginException {
<span class="nc" id="L365">        user = null;</span>
        
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (userMgr == null) </span>
<span class="nc" id="L368">        	throw new LoginException(&quot;UserMgr undefined&quot;);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (password == null)</span>
<span class="nc" id="L370">            throw new LoginException(&quot;Password not supplied&quot;);</span>

<span class="nc" id="L372">    	user = userMgr.getUser(this.userid);</span>
<span class="nc" id="L373">    	user.setIpAddr(this.ipAddr);</span>
    	
		// compare password validity start date with current date
<span class="nc" id="L376">		Date today = new Date();</span>
<span class="nc" id="L377">		Date pwvd = null; </span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">		if ((user.getPassvalidstart() != null)</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">		&amp;&amp; (!user.getPassvalidstart().equals(&quot;&quot;))) {					</span>
<span class="nc" id="L380">		    pwvd = convertDateFromUTC(user.getPassvalidstart());</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">			if (!dateCompare(pwvd, today)) {</span>
<span class="nc" id="L382">			    log(user, &quot;Not allowed to login currently.&quot;);</span>
<span class="nc" id="L383">			    user = null;</span>
<span class="nc" id="L384">			    throw new LoginException( </span>
			    	&quot;Not allowed to login currently.&quot;);
			}
		}

		// check if user needs to change password before proceeding
<span class="nc" id="L390">		user.setPasschange(false);</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">		if ((user.getPassvalidstart() != null) </span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">		&amp;&amp;  (user.getPassrenewal() != null)	</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">		&amp;&amp;  (!user.getPassvalidstart().equals(&quot;&quot;))</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">		&amp;&amp;  (!user.getPassrenewal().equals(&quot;&quot;))</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">		&amp;&amp;  (!user.getPassrenewal().equals(&quot;-1&quot;))) {					</span>
<span class="nc" id="L396">			Calendar c1 = Calendar.getInstance(); </span>
<span class="nc" id="L397">		    c1.setTime(pwvd);</span>
<span class="nc" id="L398">		    c1.add(Calendar.DATE, Integer.parseInt(user.getPassrenewal()));</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">		    if (dateCompare(c1.getTime(), today)) {</span>
<span class="nc" id="L400">		    	user.setPasschange(true);</span>
		    }
		}
		
		// Performing IP based filtering and active groups determination 
		// based on current location.
		// Make sure that AuthType=krb5 and IPfiltering=yes in the properties file.
<span class="nc bnc" id="L407" title="All 2 branches missed.">		if ((user.getAllowedips() != null)</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">		&amp;&amp;  (props.getProperty(&quot;AuthType&quot;, &quot;krb5&quot;).equals(&quot;krb5&quot;)) </span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">		&amp;&amp;  (props.getProperty(&quot;IPfiltering&quot;, &quot;yes&quot;).equals(&quot;yes&quot;))) {</span>

<span class="nc" id="L411">		    int currentip = getIpInteger(user.getIpAddr());</span>
		    
		    // IP based filtering
<span class="nc" id="L414">		    cat.info(&quot;Performing IP filtering for &quot; + getUserId());</span>
		    			    
<span class="nc" id="L416">		    boolean ipcheck_result = ipRangeCheck(user.getAllowedips(), currentip);</span>
		    					
<span class="nc bnc" id="L418" title="All 2 branches missed.">			if (ipcheck_result == false) {</span>
<span class="nc" id="L419">			    log(user, &quot;Not authorized from the current IP address.&quot;);</span>
<span class="nc" id="L420">			    throw new LoginException(</span>
			    	&quot;Not authorized from the current IP address.&quot;);
			}
			
			// Active groups determination
<span class="nc" id="L425">			cat.info(&quot;Determining active groups for &quot; + getUserId());</span>
			boolean faccheck_result;
			
			// get all groups from LDAPservice
<span class="nc" id="L429">			Set usergrps = user.getGroups();</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">			if (usergrps != null</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">			&amp;&amp;  usergrps.size() &gt; 0) {</span>
				// Setup the interface to the LDAP server
<span class="nc" id="L433">		        getLdapService();</span>
		        //session.setAttribute(&quot;ldapservice&quot;, lservice);	
		        
<span class="nc" id="L436">				Iterator grpit = usergrps.iterator();	</span>
				
<span class="nc bnc" id="L438" title="All 2 branches missed.">			    while (grpit.hasNext()) {</span>
			        // Fetch each group's details from LDAP
<span class="nc" id="L440">				    Group grp = (Group)lservice.getGroup(grpit.next().toString());</span>
				    
<span class="nc" id="L442">				    faccheck_result = ipRangeCheck(grp.getAllowedips(), currentip);</span>
				    					
<span class="nc bnc" id="L444" title="All 2 branches missed.">					if (faccheck_result == true) {</span>
<span class="nc" id="L445">					    log(user, &quot;Active group: &quot; + grp.getCn());</span>
<span class="nc" id="L446">					    user.addActivegroup(grp.getCn());</span>
					}						    
<span class="nc" id="L448">				}</span>
<span class="nc bnc" id="L449" title="All 4 branches missed.">			    if (user.getActivegroups() == null || user.getActivegroups().size() == 0) {</span>
<span class="nc" id="L450">			        log(user,&quot; Accessing from remote location.&quot;);</span>
<span class="nc" id="L451">			        user.addActivegroup(&quot;remote&quot;);</span>
			    }
			}
		} // end IP based filtering and Active groups determination				
		
<span class="nc" id="L456">    	return user;</span>
    }


    /** 
     * Authenticate the user by checking the password
     * and then Authorize them.
     * @return user
     */
    public User authenticate(String userid, 
    						String password, 
    						String ipaddr) 
    		throws LoginException {
<span class="nc" id="L469">    	this.userid = userid;</span>
<span class="nc" id="L470">    	this.password = password;</span>
<span class="nc" id="L471">    	this.ipAddr = ipaddr;</span>
    	
<span class="nc" id="L473">    	return authenticate();</span>
    }

    /** 
     * Authorize a pre-Authenticated User
     * @return user
     */
    public User authorize(String userid, String ipaddr) 
    		throws LoginException {
<span class="nc" id="L482">    	this.userid = userid;</span>
<span class="nc" id="L483">    	this.ipAddr = ipaddr;</span>
    	
<span class="nc" id="L485">    	return authorize();</span>
    }

    /** 
     * Authenticate the user by checking the password
     * and then Authorize them.
     * @return user
     */
    public User authenticate() 
    		throws LoginException {
        
<span class="nc" id="L496">        user = null;</span>
        
<span class="nc bnc" id="L498" title="All 2 branches missed.">        if (userMgr == null) </span>
<span class="nc" id="L499">        	throw new LoginException(&quot;UserMgr undefined&quot;);</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">        if (password == null)</span>
<span class="nc" id="L501">            throw new LoginException(&quot;Password not supplied&quot;);</span>

<span class="nc bnc" id="L503" title="All 2 branches missed.">        if (!userMgr.checkSecret(userid, password, authType)) {</span>
<span class="nc" id="L504">            cat.warn(&quot;Invalid Password! User: &quot; + username + &quot; ,userid: &quot; + userid);</span>
<span class="nc" id="L505">            throw new LoginException(&quot;Password invalid&quot;);</span>
        }
<span class="nc" id="L507">    	user = userMgr.getUser();</span>
<span class="nc" id="L508">    	user.setIpAddr(this.ipAddr);</span>
    	
<span class="nc" id="L510">    	authorize();</span>
    	
<span class="nc" id="L512">		return user;</span>
    }

    /**
     * check permissions for the current user
     */
    public boolean accessDecision(User usr, String resource, String action) {
<span class="nc bnc" id="L519" title="All 2 branches missed.">    	if (&quot;simple&quot;.equals(authType)) {</span>
<span class="nc" id="L520">    		cat.debug(&quot;accessDecision() always true for simple authType&quot;);</span>
<span class="nc" id="L521">    		return true;</span>
    	}
<span class="nc bnc" id="L523" title="All 2 branches missed.">		if (cat.isDebugEnabled()) {</span>
<span class="nc" id="L524">    		cat.debug(&quot;User for accessDecision() is &quot; + usr);</span>
<span class="nc" id="L525">    		cat.debug(&quot;resource is &quot; + resource);</span>
<span class="nc" id="L526">    		cat.debug(&quot;action is &quot; + action);</span>
<span class="nc" id="L527">        	cat.debug(&quot;XACMLConfig is &quot; + xacmlConfig);</span>
    	}
<span class="nc bnc" id="L529" title="All 2 branches missed.">    	if (usr == null) return false;</span>
        
<span class="nc" id="L531">        boolean ac_result = false;</span>
        
        try {
            // create XACML request            
<span class="nc" id="L535">            RequestCtx request =</span>
                new RequestCtx(
<span class="nc" id="L537">                	RequestBuilder.setupSubjects(usr.getUserId(),usr.getRoles(), </span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                			usr.getActivegroups() == null</span>
<span class="nc" id="L539">                			? usr.getGroups() : usr.getActivegroups()</span>
                		), 
<span class="nc" id="L541">                		RequestBuilder.setupResource(resource),</span>
<span class="nc" id="L542">                		RequestBuilder.setupAction(action), new HashSet());</span>
            
            // encode the Request and print it to standard out
<span class="nc" id="L545">            request.encode(System.out, new Indenter());</span>
            
<span class="nc bnc" id="L547" title="All 2 branches missed.">            if (pdpadapter.makeDecision(request) == 0)</span>
<span class="nc" id="L548">                ac_result = true;</span>
            else
<span class="nc" id="L550">                ac_result = false;</span>
<span class="nc" id="L551">	        cat.debug(&quot;Access Decision: &quot; + ac_result);</span>
<span class="nc" id="L552">        } catch (Exception e) {</span>
<span class="nc" id="L553">            cat.error(e);</span>
<span class="nc" id="L554">            e.printStackTrace();</span>
<span class="nc" id="L555">        }</span>
        
<span class="nc" id="L557">        return ac_result;</span>
        
    }
    
    public void log(User user, String info) {
<span class="nc" id="L562">        FileAppender appender = null;</span>
	    try {
<span class="nc" id="L564">	         appender = new FileAppender(new SimpleLayout(), securityLog, true);</span>
<span class="nc" id="L565">	    } catch(Exception e) {</span>
<span class="nc" id="L566">	        cat.error(e);</span>
<span class="nc" id="L567">	    }</span>
<span class="nc" id="L568">	    cat.addAppender(appender);</span>
<span class="nc" id="L569">	    Level oldlevel = cat.getLevel();</span>
<span class="nc" id="L570">	    cat.setLevel((Level) Level.INFO);</span>
<span class="nc" id="L571">	    Date now = new Date();</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">	    if (user == null) {</span>
<span class="nc" id="L573">            cat.info(now + &quot; - &quot; + username + &quot; - &quot; + userid +</span>
                 &quot; - &quot; + ipAddr + &quot; -- &quot; + info);
	    } else {
            // new log format (for better parsing in Cocoon)
<span class="nc" id="L577">            cat.info(now + &quot; - &quot; + user.getUserName() + &quot; - &quot; + user.getUserId() +</span>
<span class="nc" id="L578">                 &quot; - &quot; + user.getIpAddr() + &quot; -- &quot; + info);</span>
	    }
<span class="nc" id="L580">	    cat.setLevel(oldlevel);</span>
<span class="nc" id="L581">	    cat.removeAppender(appender);</span>
<span class="nc" id="L582">    }</span>
    

    /**
     * logout the current user
     */
    public void logOut() {
<span class="nc" id="L589">    	userMgr.logOut();</span>
<span class="nc" id="L590">    	user = null;</span>
<span class="nc" id="L591">        password = null;</span>
<span class="nc" id="L592">        username = null;</span>
<span class="nc" id="L593">    }</span>
    
	private Date convertDateFromUTC(String specdatetime) {
	    // Extract from LDAP GeneralizedTime format and Convert date 
	    // and time from UTC time to local time
<span class="nc" id="L598">       TimeZone localtime = TimeZone.getDefault();</span>
<span class="nc" id="L599">       SimpleDateFormat df1 = new SimpleDateFormat(appDateFormat);</span>
<span class="nc" id="L600">       df1.setTimeZone(localtime);</span>

<span class="nc" id="L602">       SimpleDateFormat df2 = new SimpleDateFormat(ldapGTFormat);	       </span>
<span class="nc" id="L603">       Date specdate = null;</span>
       try {
<span class="nc" id="L605">           specdate = df2.parse(specdatetime);</span>
<span class="nc" id="L606">       } catch (ParseException pe){</span>
<span class="nc" id="L607">           pe.printStackTrace();</span>
<span class="nc" id="L608">       }       </span>
<span class="nc" id="L609">       return specdate;	    </span>
	}
	
	private boolean dateCompare(Date date1, Date date2) {
<span class="nc" id="L613">	    Calendar c1 = Calendar.getInstance(); </span>
<span class="nc" id="L614">	    Calendar c2 = Calendar.getInstance(); </span>
<span class="nc" id="L615">	    c1.setTime(date1); </span>
<span class="nc" id="L616">		c2.setTime(date2); </span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">	    if (c1.before(c2))</span>
<span class="nc" id="L618">	       return true;</span>
	    else
<span class="nc" id="L620">	       return false;</span>
	}
	
	private int getIpInteger(String ip) {
<span class="nc" id="L624">	    StringTokenizer st = new StringTokenizer(ip, &quot;.&quot;);</span>
<span class="nc" id="L625">	    int bitposition = 24;</span>
<span class="nc" id="L626">	    int ipnumber = 0;</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">	    while (st.hasMoreTokens()) {</span>
<span class="nc" id="L628">	        String curtoken = st.nextToken();</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">	        if (ipnumber == 0)</span>
<span class="nc" id="L630">	            ipnumber = (Integer.parseInt(curtoken) &lt;&lt; bitposition);</span>
	        else
<span class="nc" id="L632">	            ipnumber = ipnumber | (Integer.parseInt(curtoken) &lt;&lt; bitposition);</span>
<span class="nc" id="L633">	        bitposition -= 8;</span>
<span class="nc" id="L634">	    }</span>
<span class="nc" id="L635">	    return ipnumber;</span>
	}
		
	private boolean ipRangeCheck(Set allowedips, int currentip) {
	    // Check if the current IP address falls between the given range of allowed IP addresses
	    
<span class="nc" id="L641">	    boolean ipmatch = false;</span>
	    
<span class="nc bnc" id="L643" title="All 2 branches missed.">	    if (allowedips == null) {</span>
<span class="nc" id="L644">	        cat.debug(&quot;No IP address range specified.&quot;);</span>
<span class="nc" id="L645">	        return false;</span>
	    }
	    
<span class="nc" id="L648">	    Set allowed_ips = new HashSet();</span>
<span class="nc" id="L649">	    allowed_ips = (HashSet)allowedips;</span>
<span class="nc" id="L650">		Iterator ipit = allowed_ips.iterator();	</span>
		
<span class="nc bnc" id="L652" title="All 2 branches missed.">	    while (ipit.hasNext()) {</span>
<span class="nc" id="L653">		    int finalip = 0;						</span>
<span class="nc" id="L654">		    int n = 0;			// subnet mask bits</span>
		    
		    // get the IP address and the subnet mask bits (if any)
<span class="nc" id="L657">		    StringTokenizer st = new StringTokenizer(ipit.next().toString(), &quot;/&quot;);</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">		    if (st.hasMoreTokens()) {</span>
<span class="nc" id="L659">		        finalip = getIpInteger(st.nextToken());</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">		        if (st.hasMoreTokens())</span>
<span class="nc" id="L661">		        	n = Integer.parseInt(st.nextToken());</span>
		    }
		        
		    // Every IP address allowed for the user
<span class="nc bnc" id="L665" title="All 2 branches missed.">		    if (finalip == 0) {</span>
<span class="nc" id="L666">		        cat.info(&quot;All IP addresses allowed.&quot;);</span>
<span class="nc" id="L667">		        ipmatch = true;</span>
		    }
		    
<span class="nc bnc" id="L670" title="All 2 branches missed.">		    if (n != 0) {</span>
				// compute an n bit subnet mask, all 1s except for last n bits.
<span class="nc" id="L672">				int subnet = ~( ( 1 &lt;&lt; n ) - 1 );</span>
									    
<span class="nc" id="L674">			    int t1 = finalip &amp; subnet;</span>
<span class="nc" id="L675">			    int t2 = currentip &amp; subnet;</span>
			    
<span class="nc bnc" id="L677" title="All 2 branches missed.">			    if (t1 == t2) </span>
<span class="nc" id="L678">			        ipmatch = true;</span>
			    
<span class="nc" id="L680">		    } else {</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">		        if (finalip == currentip)</span>
<span class="nc" id="L682">			        ipmatch = true;</span>
		    }					        
<span class="nc" id="L684">		}</span>
<span class="nc" id="L685">	    return ipmatch;</span>
	}
	
	/**
	 * Change the User's password
	 * (this should be moved to KrbUserMgr)
	 */
	public void changePassword(String newpass) 
			throws Exception {
        // read the configuration properties
<span class="nc bnc" id="L695" title="All 2 branches missed.">		if (cat.isDebugEnabled()) cat.debug(&quot;using props &quot;+props);</span>
<span class="nc" id="L696">		String krbrealm = props.getProperty(&quot;krbrealm&quot;, &quot;YOUR-KERBEROS-REALM&quot;);</span>
<span class="nc" id="L697">		String editkrb = props.getProperty(&quot;editkrb&quot;, &quot;no&quot;);</span>
<span class="nc" id="L698">		String kadminLocal = props.getProperty(&quot;kadmin.local&quot;, &quot;kadmin.local&quot;);</span>
<span class="nc" id="L699">        int exitVal = 0;</span>
        
<span class="nc" id="L701">        String userid = user.getUserId();</span>
        // strip only the unique username from the userid
<span class="nc" id="L703">        int ind = userid.indexOf(&quot;@&quot;);</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">    	if (ind &gt; 0)</span>
<span class="nc" id="L705">    	    userid = userid.substring(0,ind);</span>
    	
<span class="nc" id="L707">        cat.debug(&quot;editkrb: &quot; + editkrb);</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">		if (editkrb.toLowerCase().equals(&quot;yes&quot;)) {</span>
		    
	        // Execute the UNIX command to reset the principal's password in the Kerberos 
		    // database.
	        // Assumption: The web server and the kerberos server are running on the same UNIX
	        // based machine.Otherwise please modify the following according to your settings.
	        				        	
<span class="nc" id="L715">	        String krbprinc = userid + &quot;@&quot; + krbrealm;</span>
<span class="nc" id="L716">		    cat.info(&quot;Reseting principal \&quot;&quot; + krbprinc + &quot;\&quot;'s password in &quot; +</span>
		    		&quot;the Kerberos database&quot;);
<span class="nc" id="L718">		    Runtime rt = Runtime.getRuntime();</span>
		   	
		    // Create a String array consisting of the command and its arguments
<span class="nc" id="L721">		    String[] cmd = {kadminLocal, &quot;-p &quot; + userid, </span>
		            &quot;-q \&quot;\&quot;cpw -pw &quot; + newpass + &quot; &quot; + krbprinc + &quot;\&quot;\&quot;&quot;};
<span class="nc" id="L723">		    cat.debug(&quot;exec'ing Runtime command: &quot; + cmd[0]+' '+cmd[1]+' '+cmd[2]);</span>
<span class="nc" id="L724">		    Process ps = rt.exec(cmd);</span>
		    
			// For printing error messages
<span class="nc" id="L727">			StreamHandler errorHandler = new</span>
<span class="nc" id="L728">				StreamHandler(ps.getErrorStream(), &quot;ERROR&quot;);            </span>
            
            // For printing output
<span class="nc" id="L731">			StreamHandler outputHandler = new</span>
<span class="nc" id="L732">				StreamHandler(ps.getInputStream(), &quot;OUTPUT&quot;);</span>
                
            // Start printing
<span class="nc" id="L735">            errorHandler.start();</span>
<span class="nc" id="L736">            outputHandler.start();</span>
                                    
            // Print exit value
<span class="nc" id="L739">		    exitVal = ps.waitFor();</span>
<span class="nc" id="L740">		    cat.debug(&quot;Kerberos update status: &quot; + exitVal);					    </span>
		}
		
<span class="nc bnc" id="L743" title="All 2 branches missed.">		if (exitVal == 0) {</span>
		    
<span class="nc" id="L745">		    getLdapService();</span>
<span class="nc" id="L746">		    Person person = lservice.getPerson(userid);</span>
<span class="nc" id="L747">		    person.setPasschange(&quot;no&quot;);</span>
		    // Put current date as password valid start date
<span class="nc" id="L749">		    Date today = new Date();</span>
<span class="nc" id="L750">		    SimpleDateFormat sdf = new SimpleDateFormat(ldapGTFormat);	</span>
<span class="nc" id="L751">		    person.setPassvalidstart(sdf.format(today));</span>
		    
<span class="nc bnc" id="L753" title="All 2 branches missed.">			if (lservice.updatePerson(person, person.getDn()) == true) {</span>
			}
		    else
<span class="nc" id="L756">				throw new LoginException(</span>
					&quot;Cannot update your profile. Please contact the administrator!&quot;);
<span class="nc" id="L758">	    } else</span>
<span class="nc" id="L759">	    	throw new LoginException(</span>
				&quot;Cannot update your profile. Please contact the administrator!&quot;);
	  
<span class="nc" id="L762">	}</span>
	
  /*  /** obtain list of valid users
     * @return String[] list of known users
     /
    public static String[] getNames() {
        if (names == null) {
            if (userMgr == null) init();
            names = userMgr.getUserNames();
        }

        return names;
    }

    /**
     * return known email addresses
     * @return String[] list of known emails
     /
    public static String[] getMail() {
        if (mail == null) {
            if (userMgr == null) init();
            mail = userMgr.getUserIds();
        }
        /*
        {
            if (id == null) init();
            ArrayList v = null;
            try {
                JDBMEnumeration e = id.keys();
                v = new ArrayList();
                while (e.hasMoreElements()) {
                    v.add(e.nextElement());
                }
            } catch (IOException e1) {
                cat.error(&quot;getMail: &quot; + e1);
                return new String[0];
            }
            mail = new String[v.size()];
            cat.debug(&quot;getMail: &quot;+mail.length+ &quot; elements&quot;);
            v.toArray(mail);
        }  /
        return mail;
    }


    /**
     *  set the SimpleUserMgr containing the Users.
     * @param theUserMgr to be used
     /
    public static void setUserMgr(UserMgr theUserMgr) {
        userMgr = theUserMgr;
    }

    /**
     * get the SimpleUserMgr that contains the Users
     * @return SimpleUserMgr
     /
    public static SimpleUserMgr getUserMgr() {
        return userMgr;
    }

    /**
     * get all the users in memory
     * @return String
     /
    public String toString() {
        return userMgr.export();
        /*
        StringBuffer buff = new StringBuffer();
        try {
            JDBMEnumeration c = id.values();
            while (c.hasMoreElements()) {
                buff.append(c.nextElement().toString() + '\n');
            }
        } catch (IOException e) {
            cat.error(&quot;getUsers: &quot; + e);
        }
        return buff.toString();
        /
    }

    /**
     * test program
     /
    public static void main(String[] argv) {
        Login login = new Login();
      //  SimpleUserMgr.setConfigFile(argv[0]);
        // SimpleUserMgr usrMgr = new SimpleUserMgr(argv[0]);
        // usrMgr.init();
        login.setConfigFile(argv[0]);
        login.init();
        login.getUserMgr().addUser(&quot;cn=Jim Smith, o=LANL, c=US&quot;, &quot;Jim Smith&quot;, &quot;Smith&quot;, &quot;smith@foo.com&quot;, &quot;submitter&quot;, &quot;junk&quot;);
        login.getUserMgr().addUser(&quot;dn: cn=Dave Barry, o=UNM, c=US\ncn: Dave Barry\nemail: barry@goofoff.com\nsn: Barry\nuserPassword: stuff\nrole: staff&quot;);

        login.setUsername(&quot;Dave Barry&quot;);
        login.setOrg(&quot;UNM&quot;);
        login.setUsername(&quot;Dave Barry&quot;);
        cat.debug(login.getUser());
        login.getUserMgr().delUser(&quot;smith@foo.com&quot;);
        String[] mail = Login.getMail();
        cat.debug(&quot;Mail: &quot;+mail[0]);
        cat.debug(login.getUserMgr().getMailbyOrg(&quot;LANL&quot;));
        String[] names = Login.getNames();
        cat.debug(&quot;names: &quot;+names[0]);
        System.out.println(login.toString());

    } */
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>