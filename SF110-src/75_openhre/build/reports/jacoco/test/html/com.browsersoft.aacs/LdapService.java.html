<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LdapService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">75_openhre</a> &gt; <a href="index.source.html" class="el_package">com.browsersoft.aacs</a> &gt; <span class="el_source">LdapService.java</span></div><h1>LdapService.java</h1><pre class="source lang-java linenums">/*
 *   CVS $Id: LdapService.java,v 1.1 2006/11/06 19:51:47 grodecki Exp $
 * 
 *   ====================================================================
 *                 Open Source Health Records Exchange
 *   ====================================================================
 *
 *   Copyright (C) 2005 Browsersoft Inc.
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License, version 2, 
 *   as published by the Free Software Foundation.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU General Public License for more details.
 *
 *   The GNU General Public License is available at
 *   http://www.fsf.org/licensing/licenses/gpl.html
 *
 *   Email: info@openhre.org
 *   Web:   http://www.openhre.org
 */
package com.browsersoft.aacs;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Hashtable;
import java.util.List;
import java.util.Properties;

import javax.naming.Context;
import javax.naming.NamingEnumeration;
import javax.naming.NamingException;
import javax.naming.directory.Attribute;
import javax.naming.directory.Attributes;
import javax.naming.directory.DirContext;
import javax.naming.directory.SearchControls;
import javax.naming.directory.SearchResult;
import javax.naming.ldap.InitialLdapContext;
import javax.naming.ldap.LdapContext;

/**
 * @author gsharma
 *
 * LdapService is used as a service for the administrator 
 * to retrieve and modify all the information stored
 * in an LDAP server.
 * 
 */

public class LdapService {
    
<span class="nc" id="L57">    private static org.apache.log4j.Logger cat</span>
<span class="nc" id="L58">      = org.apache.log4j.Logger.getLogger(LdapService.class.getName());</span>
	
<span class="nc" id="L60">	private static Properties props = new Properties();</span>
<span class="nc" id="L61">    private static String configFile = &quot;/KrbLdap&quot;;</span>

    private String basedn;
    private List people;
    private List roles;
    private List groups;
    private LdapContext dctx;
    private SearchControls ctls;	//SearchControls determines scope of search and what gets 
									// returned as a result of the search.
    
<span class="nc" id="L71">    public LdapService(LdapContext dctx) {</span>
<span class="nc" id="L72">        this.dctx = dctx;</span>
<span class="nc" id="L73">        init();</span>
<span class="nc" id="L74">    }</span>
    
    private void init() {
<span class="nc" id="L77">        ctls = new SearchControls();		</span>

        // read the configuration properties
<span class="nc" id="L80">        cat.debug(&quot;loading properties from &quot;+configFile);</span>
<span class="nc" id="L81"> 	    Login.loadProperties(props, configFile);</span>
<span class="nc" id="L82">        basedn = props.getProperty(&quot;basedn&quot;, &quot;dc=arch,dc=org&quot;);</span>
<span class="nc" id="L83">        cat.debug(&quot;got properties &quot;+props);</span>
<span class="nc" id="L84">    }</span>
    
    private NamingEnumeration fetch(String namecontext, String[] attrIDs, String filter) {
<span class="nc" id="L87">        NamingEnumeration answer = null;</span>
        try {            
<span class="nc" id="L89">    		ctls.setReturningObjFlag (false);</span>
<span class="nc" id="L90">    		ctls.setReturningAttributes(attrIDs);		// Specify the ids of the attributes to return</span>
<span class="nc" id="L91">    		ctls.setSearchScope(SearchControls.SUBTREE_SCOPE);</span>
<span class="nc" id="L92">    		answer = dctx.search(namecontext, filter, ctls);  		</span>
<span class="nc" id="L93">    	} catch (NamingException ne) {</span>
<span class="nc" id="L94">    		ne.printStackTrace();</span>
<span class="nc" id="L95">    	} catch (Exception e) {</span>
<span class="nc" id="L96">    		e.printStackTrace();</span>
<span class="nc" id="L97">    	}</span>
<span class="nc" id="L98">        return answer; </span>
    }
    
    public Person getPerson(String uid) {
<span class="nc" id="L102">        Person person = new Person();</span>
                
<span class="nc" id="L104">        NamingEnumeration answer = fetch(&quot;ou=people,&quot;+basedn, null, &quot;(uid=&quot;+ uid +&quot;)&quot;);</span>
        
        try {
<span class="nc" id="L107">		    cat.debug(&quot;Person found:&quot;);</span>
		    
<span class="nc bnc" id="L109" title="All 2 branches missed.">	        while (answer.hasMore()) {</span>
<span class="nc" id="L110">				SearchResult sr = (SearchResult)answer.next();</span>
<span class="nc" id="L111">				Attributes attrs = sr.getAttributes();</span>
<span class="nc" id="L112">				ArrayList person_roles = new ArrayList();</span>
<span class="nc" id="L113">				ArrayList person_groups = new ArrayList();</span>
							    
<span class="nc bnc" id="L115" title="All 2 branches missed.">				if (attrs == null) {</span>
<span class="nc" id="L116">				    cat.debug(&quot;This result has no attributes&quot;);</span>
				} else {
<span class="nc bnc" id="L118" title="All 2 branches missed.">				    for (NamingEnumeration naming_enum = attrs.getAll(); naming_enum.hasMore();) {</span>
<span class="nc" id="L119">					    Attribute attrib = (Attribute)naming_enum.next();</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">					    if (attrib.getID().equals(&quot;cn&quot;)) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L123">					            person.setCn((String)e.next());</span>
<span class="nc" id="L124">					            cat.debug(&quot;cn: &quot; + person.getCn());</span>
					        }
					    }					    
<span class="nc bnc" id="L127" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;uid&quot;)) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L129">					            person.setUid((String)e.next());</span>
<span class="nc" id="L130">					            cat.debug(&quot;uid: &quot; + person.getUid());</span>
					        }
					    }					    
<span class="nc bnc" id="L133" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;sn&quot;)) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L135">					            person.setSn((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L138" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;givenName&quot;)) {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L140">					            person.setGivenname((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L143" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;mail&quot;)) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L145">					            person.setEmail((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L148" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;telephoneNumber&quot;)) {</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L150">					            person.setTelephoneNumber((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L153" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;facsimileTelephoneNumber&quot;)) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L155">					            person.setFaxTelephoneNumber((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L158" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;postalAddress&quot;)) {</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L160">					            person.setPostalAddress((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L163" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;employeeType&quot;)) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L165">					            person_roles.add((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L168" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;ou&quot;)) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L170">					            person_groups.add((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L173" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;ipHostNumber&quot;)) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L175">					            person.addAllowedip((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L178" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;krb5ValidStart&quot;)) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L180">					            person.setPassvalidstart((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L183" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;krb5MaxRenew&quot;)) {</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L185">					            person.setPassrenewal((String)e.next());</span>
					        }
					    }
<span class="nc bnc" id="L188" title="All 2 branches missed.">					    else if (attrib.getID().equals(&quot;krb5MaxLife&quot;)) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">					            if(((String)e.next()).equals(&quot;-1&quot;))</span>
<span class="nc" id="L191">					                person.setPasschange(&quot;yes&quot;);</span>
					            else
<span class="nc" id="L193">					                person.setPasschange(&quot;no&quot;);</span>
					        }
					    }
					   
<span class="nc" id="L197">				    } // end for</span>
				    
				    // set DN
<span class="nc" id="L200">				    person.setDn(&quot;uid=&quot;+person.getUid()+&quot;,ou=people,&quot;+basedn);</span>
				    
<span class="nc bnc" id="L202" title="All 2 branches missed.">				    if (person_roles.size() &gt; 0) {</span>
				        // Convert ArrayList to String[] for forms to handle roles as selected options
<span class="nc" id="L204">				        person.setRoles((String[])person_roles.toArray(new String[person_roles.size()]));</span>
				    }
				    
<span class="nc bnc" id="L207" title="All 2 branches missed.">				    if (person_groups.size() &gt; 0) {</span>
				        // Convert ArrayList to String[] for forms to handle groups as selected options
<span class="nc" id="L209">				        person.setGroups((String[])person_groups.toArray(new String[person_groups.size()]));</span>
				    }
				    
				} // end else
<span class="nc" id="L213">			}</span>
<span class="nc" id="L214">        } catch (Exception e) {</span>
<span class="nc" id="L215">            e.printStackTrace();</span>
<span class="nc" id="L216">        }</span>
<span class="nc" id="L217">        return person;</span>
    }
    
    public Collection getPeople() {
        //if (people == null) {
<span class="nc" id="L222">            people = new ArrayList();</span>
            
<span class="nc" id="L224">            String[] at = {&quot;uid&quot; ,&quot;cn&quot;};</span>
<span class="nc" id="L225">	        NamingEnumeration answer = fetch(&quot;ou=people,&quot;+basedn, at, &quot;(uid=*)&quot;);</span>
	        
	        try {
<span class="nc" id="L228">			    cat.debug(&quot;People found:&quot;);</span>
			    
<span class="nc bnc" id="L230" title="All 2 branches missed.">		        while (answer.hasMore()) {</span>
<span class="nc" id="L231">					SearchResult sr = (SearchResult)answer.next();</span>
<span class="nc" id="L232">					Attributes attrs = sr.getAttributes();</span>
<span class="nc" id="L233">					String person_cn = null;</span>
<span class="nc" id="L234">		    		String person_uid = null;</span>
				    
<span class="nc bnc" id="L236" title="All 2 branches missed.">					if (attrs == null) {</span>
<span class="nc" id="L237">					    cat.debug(&quot;This result has no attributes&quot;);</span>
					} else {
<span class="nc bnc" id="L239" title="All 2 branches missed.">					    for (NamingEnumeration naming_enum = attrs.getAll(); naming_enum.hasMore();) {</span>
<span class="nc" id="L240">						    Attribute attrib = (Attribute)naming_enum.next();</span>
						    
				    		
<span class="nc bnc" id="L243" title="All 2 branches missed.">						    if (attrib.getID().equals(&quot;cn&quot;)) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">						        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L245">					    		    person_cn  = (String)e.next();</span>
						        }
						    }
						    
<span class="nc bnc" id="L249" title="All 2 branches missed.">						    else if (attrib.getID().equals(&quot;uid&quot;)) {</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">						        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L251">						            person_uid  = (String)e.next();</span>
						        }
						    }
						    
<span class="nc bnc" id="L255" title="All 4 branches missed.">					    	if ((person_cn != null) &amp;&amp; (person_uid != null)) {</span>
<span class="nc" id="L256">						    		people.add(new Person(person_uid, person_cn));</span>
<span class="nc" id="L257">						    		cat.debug(person_cn + &quot; (&quot; + person_uid + &quot;) &quot;);</span>
<span class="nc" id="L258">						    		person_cn = null;</span>
<span class="nc" id="L259">						    		person_uid = null;</span>
					    	}
<span class="nc" id="L261">					    }</span>
					}
<span class="nc" id="L263">				}</span>
<span class="nc" id="L264">	        } catch (Exception e) {</span>
<span class="nc" id="L265">	            e.printStackTrace();</span>
<span class="nc" id="L266">	        }</span>
        //}

<span class="nc" id="L269">		Collections.sort(people, new peopleComparator());    </span>
<span class="nc" id="L270">        return people;</span>
    }
    
    public Collection getRoles() {        
        //if (roles == null) {
<span class="nc" id="L275">            roles = new ArrayList();</span>
	        
<span class="nc" id="L277">	        String[] at = {&quot;cn&quot;};</span>
<span class="nc" id="L278">	        NamingEnumeration answer = fetch(&quot;ou=roles,&quot;+basedn, at, &quot;(cn=*)&quot;);</span>
	        
	        try {
<span class="nc" id="L281">			    cat.debug(&quot;Roles found:&quot;);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">		        while (answer.hasMore()) {</span>
<span class="nc" id="L283">					SearchResult sr = (SearchResult)answer.next();</span>
<span class="nc" id="L284">					Attributes attrs = sr.getAttributes();</span>
				    
<span class="nc bnc" id="L286" title="All 2 branches missed.">					if (attrs == null) {</span>
<span class="nc" id="L287">					    cat.debug(&quot;This result has no attributes&quot;);</span>
					} else {
<span class="nc bnc" id="L289" title="All 2 branches missed.">						for (NamingEnumeration naming_enum = attrs.getAll(); naming_enum.hasMore();) {</span>
<span class="nc" id="L290">						    Attribute attrib = (Attribute)naming_enum.next();</span>
						   					    
<span class="nc bnc" id="L292" title="All 2 branches missed.">						   for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L293">					    		String role_cn = (String)e.next();</span>
<span class="nc" id="L294">					    		roles.add(new Role(role_cn));</span>
<span class="nc" id="L295">					    		cat.debug(role_cn);</span>
<span class="nc" id="L296">						    }</span>
<span class="nc" id="L297">						}</span>
					}
<span class="nc" id="L299">				}</span>
<span class="nc" id="L300">	        } catch (Exception e) {</span>
<span class="nc" id="L301">	            e.printStackTrace();</span>
<span class="nc" id="L302">	        }</span>
        //}
<span class="nc" id="L304">		Collections.sort(roles, new roleComparator());    </span>
<span class="nc" id="L305">        return roles;</span>
    }
    
    public Collection getGroups() {
        //if (groups == null) {
<span class="nc" id="L310">            groups = new ArrayList();</span>
	        
<span class="nc" id="L312">	        String[] at = {&quot;cn&quot;, &quot;ipHostNumber&quot;};</span>
<span class="nc" id="L313">	        NamingEnumeration answer = fetch(&quot;ou=groups,&quot;+basedn, at, &quot;(cn=*)&quot;);</span>
	        
	        try {
<span class="nc" id="L316">	            cat.debug(&quot;Groups found:&quot;);</span>
	            
<span class="nc bnc" id="L318" title="All 2 branches missed.">		        while (answer.hasMore()) {</span>
<span class="nc" id="L319">					SearchResult sr = (SearchResult)answer.next();</span>
<span class="nc" id="L320">					Attributes attrs = sr.getAttributes();</span>
<span class="nc" id="L321">					ArrayList group_ips = null;</span>
					
<span class="nc bnc" id="L323" title="All 2 branches missed.">					if (attrs == null) {</span>
<span class="nc" id="L324">					    cat.debug(&quot;This result has no attributes&quot;);</span>
					} else {
<span class="nc bnc" id="L326" title="All 2 branches missed.">						for (NamingEnumeration naming_enum = attrs.getAll(); naming_enum.hasMore();) {</span>
<span class="nc" id="L327">						    Attribute attrib = (Attribute)naming_enum.next();</span>
						   					    
<span class="nc bnc" id="L329" title="All 2 branches missed.">						   for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
						       // ipHostNumber attribute is returned before the cn attribute for each group.
						       // There can be 0 or more IP address ranges.
<span class="nc bnc" id="L332" title="All 2 branches missed.">						       if (attrib.getID().equals(&quot;ipHostNumber&quot;)) {					    		    </span>
<span class="nc" id="L333">					    		    String group_ip = (String)e.next();</span>
<span class="nc" id="L334">					    		    cat.debug(group_ip);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">					    		    if (!group_ip.trim().equals(&quot;0&quot;)) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">						    		    if (group_ips == null)</span>
<span class="nc" id="L337">						    		        group_ips = new ArrayList();</span>
<span class="nc" id="L338">						    		    group_ips.add(group_ip);</span>
					    		    }
<span class="nc" id="L340">					    		}</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">					    		else if (attrib.getID().equals(&quot;cn&quot;)) {</span>
<span class="nc" id="L342">					    		    String group_cn = (String)e.next();</span>
<span class="nc" id="L343">					    		    groups.add(new Group(group_cn, group_ips));</span>
<span class="nc" id="L344">					    		    cat.debug(group_cn);</span>
<span class="nc" id="L345">					    		}</span>
						    }
<span class="nc" id="L347">						}</span>
					}
<span class="nc" id="L349">				}</span>
<span class="nc" id="L350">	        } catch (Exception e) {</span>
<span class="nc" id="L351">	            e.printStackTrace();</span>
<span class="nc" id="L352">	        }</span>
        //}
<span class="nc" id="L354">		Collections.sort(groups, new groupComparator());    </span>
<span class="nc" id="L355">		return groups;</span>
    }
    
    public Group getGroup(String cn) {
<span class="nc" id="L359">        Group grp = new Group(cn);</span>
                
<span class="nc" id="L361">        NamingEnumeration answer = fetch(&quot;ou=groups,&quot;+basedn, null, &quot;(cn=&quot;+ cn +&quot;)&quot;);</span>
        
        try {
<span class="nc bnc" id="L364" title="All 2 branches missed.">		    while (answer.hasMore()) {</span>
<span class="nc" id="L365">				SearchResult sr = (SearchResult)answer.next();</span>
<span class="nc" id="L366">				Attributes attrs = sr.getAttributes();</span>
							    
<span class="nc bnc" id="L368" title="All 2 branches missed.">				if (attrs == null) {</span>
<span class="nc" id="L369">				    cat.debug(&quot;This result has no attributes&quot;);</span>
				} else {
<span class="nc bnc" id="L371" title="All 2 branches missed.">				    for (NamingEnumeration naming_enum = attrs.getAll(); naming_enum.hasMore();) {</span>
<span class="nc" id="L372">					    Attribute attrib = (Attribute)naming_enum.next();</span>

<span class="nc bnc" id="L374" title="All 2 branches missed.">					    if (attrib.getID().equals(&quot;ipHostNumber&quot;)) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">					        for (NamingEnumeration e = attrib.getAll();e.hasMore();) {</span>
<span class="nc" id="L376">					            grp.addAllowedip((String)e.next());</span>
					        }
					    }				   
<span class="nc" id="L379">				    } // end for				    </span>
				} // end else
<span class="nc" id="L381">			}</span>
<span class="nc" id="L382">        } catch (Exception e) {</span>
<span class="nc" id="L383">            e.printStackTrace();</span>
<span class="nc" id="L384">        }</span>
<span class="nc" id="L385">        return grp;</span>
    }
        
    public boolean addPerson(Person person) {
        // for now we are using simple authentication for LDAP since there seems to be the following
        // error with GSSAPI authentication (which works for search) while requesting a modification to LDAP:
        // javax.naming.AuthenticationNotSupportedException: 
        // [LDAP: error code 8 - modifications require authentication]
        // Awaiting reply from mailing lists.
		
		//String ldapurl = props.getProperty(&quot;ldapurl&quot;, &quot;ldap://someldapserver.com:389&quot;);

		// Set up the environment for creating the initial context
		//Hashtable env = new Hashtable(11);
		//env.put(Context.INITIAL_CONTEXT_FACTORY, 
		//    &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
		//env.put(Context.PROVIDER_URL, ldapurl);
		
		//env.put(Context.SECURITY_AUTHENTICATION,&quot;simple&quot;);
		//env.put(Context.SECURITY_PRINCIPAL,&quot;cn=xxx,dc=arch,dc=org&quot;); // specify the username
		//env.put(Context.SECURITY_CREDENTIALS,&quot;secret&quot;);           // specify the password

        try {
			// Create the initial context
            //LdapContext ctx = new InitialLdapContext(env,null);
<span class="nc" id="L410">         	dctx.bind(person.getDn(), person); // was getting error code 8</span>
<span class="nc" id="L411">            return true;</span>
<span class="nc" id="L412">        } catch (NamingException ne) {</span>
<span class="nc" id="L413">    		ne.printStackTrace();</span>
<span class="nc" id="L414">    		return false;</span>
<span class="nc" id="L415">    	} catch (Exception e) {</span>
<span class="nc" id="L416">    		e.printStackTrace();</span>
<span class="nc" id="L417">    		return false;</span>
    	}
    }
    
    public boolean updatePerson(Person person, String olddn) {
        // for now we are using simple authentication for LDAP since there seems to be the following
        // error with GSSAPI authentication (which works for search) while requesting a modification to LDAP:
        // javax.naming.AuthenticationNotSupportedException: 
        // [LDAP: error code 8 - modifications require authentication]
        // Awaiting reply from mailing lists.

		//String ldapurl = props.getProperty(&quot;ldapurl&quot;, &quot;ldap://someldapserver.com:389&quot;);
		//String basedn = props.getProperty(&quot;basedn&quot;, &quot;dc=arch,dc=org&quot;);
			
		// Set up the environment for creating the initial context
		//Hashtable env = new Hashtable(11);
		//env.put(Context.INITIAL_CONTEXT_FACTORY, 
		//    &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
		//env.put(Context.PROVIDER_URL, ldapurl);

		//env.put(Context.SECURITY_AUTHENTICATION,&quot;simple&quot;);
		//env.put(Context.SECURITY_PRINCIPAL,&quot;cn=xxx,dc=arch,dc=org&quot;); // specify the username
		//env.put(Context.SECURITY_CREDENTIALS,&quot;secret&quot;);           // specify the password
		
        try {
			// Create the initial context
			//LdapContext ctx = new InitialLdapContext(env,null);
			
<span class="nc" id="L445">			String newdn = person.getDn();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">			if (olddn.compareTo(newdn) != 0)</span>
<span class="nc" id="L447">			    dctx.rename(olddn,newdn);</span>
			
<span class="nc" id="L449">			person.setAttributes();</span>
<span class="nc" id="L450">		    dctx.modifyAttributes(newdn, DirContext.REPLACE_ATTRIBUTE, person.getAttributes());</span>
		
<span class="nc" id="L452">            return true;</span>
<span class="nc" id="L453">        } catch (NamingException ne) {</span>
<span class="nc" id="L454">    		ne.printStackTrace();</span>
<span class="nc" id="L455">    		return false;</span>
<span class="nc" id="L456">    	} catch (Exception e) {</span>
<span class="nc" id="L457">    		e.printStackTrace();</span>
<span class="nc" id="L458">    		return false;</span>
    	}
    }
    
    public boolean deletePerson(String dn) {
        // for now we are using simple authentication for LDAP since there seems to be the following
        // error with GSSAPI authentication (which works for search) while requesting a modification to LDAP:
        // javax.naming.AuthenticationNotSupportedException: 
        // [LDAP: error code 8 - modifications require authentication]
        // Awaiting reply from mailing lists.

		//String ldapurl = props.getProperty(&quot;ldapurl&quot;, &quot;ldap://someldapserver.com:389&quot;);
		//String basedn = props.getProperty(&quot;basedn&quot;, &quot;dc=arch,dc=org&quot;);
			
		// Set up the environment for creating the initial context
		//Hashtable env = new Hashtable(11);
		//env.put(Context.INITIAL_CONTEXT_FACTORY, 
		//    &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
		//env.put(Context.PROVIDER_URL, ldapurl);

		//env.put(Context.SECURITY_AUTHENTICATION,&quot;simple&quot;);
		//env.put(Context.SECURITY_PRINCIPAL,&quot;cn=xxx,dc=arch,dc=org&quot;); // specify the username
		//env.put(Context.SECURITY_CREDENTIALS,&quot;secret&quot;);           // specify the password

        try {
			// Create the initial context
			//LdapContext ctx = new InitialLdapContext(env,null);
<span class="nc" id="L485">		    dctx.destroySubcontext(dn);</span>
<span class="nc" id="L486">            return true;</span>
<span class="nc" id="L487">        } catch (NamingException ne) {</span>
<span class="nc" id="L488">    		ne.printStackTrace();</span>
<span class="nc" id="L489">    		return false;</span>
<span class="nc" id="L490">    	} catch (Exception e) {</span>
<span class="nc" id="L491">    		e.printStackTrace();</span>
<span class="nc" id="L492">    		return false;</span>
    	}
    }

    public boolean addRole(Role role) {
        // for now we are using simple authentication for LDAP since there seems to be the following
        // error with GSSAPI authentication (which works for search) while requesting a modification to LDAP:
        // javax.naming.AuthenticationNotSupportedException: 
        // [LDAP: error code 8 - modifications require authentication]
        // Awaiting reply from mailing lists.

		//String ldapurl = props.getProperty(&quot;ldapurl&quot;, &quot;ldap://someldapserver.com:389&quot;);
		//String basedn = props.getProperty(&quot;basedn&quot;, &quot;dc=arch,dc=org&quot;);
		
		// Set up the environment for creating the initial context
		//Hashtable env = new Hashtable(11);
		//env.put(Context.INITIAL_CONTEXT_FACTORY, 
		//    &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
		//env.put(Context.PROVIDER_URL, ldapurl);
		
		//env.put(Context.SECURITY_AUTHENTICATION,&quot;simple&quot;);
		//env.put(Context.SECURITY_PRINCIPAL,&quot;cn=xxx,dc=arch,dc=org&quot;); // specify the username
		//env.put(Context.SECURITY_CREDENTIALS,&quot;secret&quot;);           // specify the password

        try {
			// Create the initial context
			//LdapContext ctx = new InitialLdapContext(env,null);
<span class="nc" id="L519">		    dctx.bind(role.getDn(), role);</span>
<span class="nc" id="L520">            return true;</span>
<span class="nc" id="L521">        } catch (NamingException ne) {</span>
<span class="nc" id="L522">    		ne.printStackTrace();</span>
<span class="nc" id="L523">    		return false;</span>
<span class="nc" id="L524">    	} catch (Exception e) {</span>
<span class="nc" id="L525">    		e.printStackTrace();</span>
<span class="nc" id="L526">    		return false;</span>
    	}
    }
    
    public boolean deleteRole(String dn) {
        // for now we are using simple authentication for LDAP since there seems to be the following
        // error with GSSAPI authentication (which works for search) while requesting a modification to LDAP:
        // javax.naming.AuthenticationNotSupportedException: 
        // [LDAP: error code 8 - modifications require authentication]
        // Awaiting reply from mailing lists.

		//String ldapurl = props.getProperty(&quot;ldapurl&quot;, &quot;ldap://someldapserver.com:389&quot;);
		//String basedn = props.getProperty(&quot;basedn&quot;, &quot;dc=arch,dc=org&quot;);
			
		// Set up the environment for creating the initial context
		//Hashtable env = new Hashtable(11);
		//env.put(Context.INITIAL_CONTEXT_FACTORY, 
		//    &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
		//env.put(Context.PROVIDER_URL, ldapurl);

		//env.put(Context.SECURITY_AUTHENTICATION,&quot;simple&quot;);
		//env.put(Context.SECURITY_PRINCIPAL,&quot;cn=xxx,dc=arch,dc=org&quot;); // specify the username
		//env.put(Context.SECURITY_CREDENTIALS,&quot;secret&quot;);           // specify the password

        try {
			// Create the initial context
			//LdapContext ctx = new InitialLdapContext(env,null);
<span class="nc" id="L553">		    dctx.destroySubcontext(dn);</span>
<span class="nc" id="L554">            return true;</span>
<span class="nc" id="L555">        } catch (NamingException ne) {</span>
<span class="nc" id="L556">    		ne.printStackTrace();</span>
<span class="nc" id="L557">    		return false;</span>
<span class="nc" id="L558">    	} catch (Exception e) {</span>
<span class="nc" id="L559">    		e.printStackTrace();</span>
<span class="nc" id="L560">    		return false;</span>
    	}
    }
    
    public boolean addGroup(Group group) {
        // for now we are using simple authentication for LDAP since there seems to be the following
        // error with GSSAPI authentication (which works for search) while requesting a modification to LDAP:
        // javax.naming.AuthenticationNotSupportedException: 
        // [LDAP: error code 8 - modifications require authentication]
        // Awaiting reply from mailing lists.

		//String ldapurl = props.getProperty(&quot;ldapurl&quot;, &quot;ldap://someldapserver.com:389&quot;);
		//String basedn = props.getProperty(&quot;basedn&quot;, &quot;dc=arch,dc=org&quot;);
		
		// Set up the environment for creating the initial context
		//Hashtable env = new Hashtable(11);
		//env.put(Context.INITIAL_CONTEXT_FACTORY, 
		//    &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
		//env.put(Context.PROVIDER_URL, ldapurl);
		
		//env.put(Context.SECURITY_AUTHENTICATION,&quot;simple&quot;);
		//env.put(Context.SECURITY_PRINCIPAL,&quot;cn=xxx,dc=arch,dc=org&quot;); // specify the username
		//env.put(Context.SECURITY_CREDENTIALS,&quot;secret&quot;);           // specify the password

        try {
			// Create the initial context
			//LdapContext ctx = new InitialLdapContext(env,null);
<span class="nc" id="L587">		    dctx.bind(group.getDn(), group);</span>
<span class="nc" id="L588">            return true;</span>
<span class="nc" id="L589">        } catch (NamingException ne) {</span>
<span class="nc" id="L590">    		ne.printStackTrace();</span>
<span class="nc" id="L591">    		return false;</span>
<span class="nc" id="L592">    	} catch (Exception e) {</span>
<span class="nc" id="L593">    		e.printStackTrace();</span>
<span class="nc" id="L594">    		return false;</span>
    	}
    }
    
    public boolean deleteGroup(String dn) {
        // for now we are using simple authentication for LDAP since there seems to be the following
        // error with GSSAPI authentication (which works for search) while requesting a modification to LDAP:
        // javax.naming.AuthenticationNotSupportedException: 
        // [LDAP: error code 8 - modifications require authentication]
        // Awaiting reply from mailing lists.

		//String ldapurl = props.getProperty(&quot;ldapurl&quot;, &quot;ldap://someldapserver.com:389&quot;);
		//String basedn = props.getProperty(&quot;basedn&quot;, &quot;dc=arch,dc=org&quot;);
			
		// Set up the environment for creating the initial context
		//Hashtable env = new Hashtable(11);
		//env.put(Context.INITIAL_CONTEXT_FACTORY, 
		//    &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
		//env.put(Context.PROVIDER_URL, ldapurl);

		//env.put(Context.SECURITY_AUTHENTICATION,&quot;simple&quot;);
		//env.put(Context.SECURITY_PRINCIPAL,&quot;cn=xxx,dc=arch,dc=org&quot;); // specify the username
		//env.put(Context.SECURITY_CREDENTIALS,&quot;secret&quot;);           // specify the password

        try {
			// Create the initial context
			//LdapContext ctx = new InitialLdapContext(env,null);
<span class="nc" id="L621">		    dctx.destroySubcontext(dn);</span>
<span class="nc" id="L622">            return true;</span>
<span class="nc" id="L623">        } catch (NamingException ne) {</span>
<span class="nc" id="L624">    		ne.printStackTrace();</span>
<span class="nc" id="L625">    		return false;</span>
<span class="nc" id="L626">    	} catch (Exception e) {</span>
<span class="nc" id="L627">    		e.printStackTrace();</span>
<span class="nc" id="L628">    		return false;</span>
    	}
    }
    
    public boolean updateGroup(Group grp) {
        // for now we are using simple authentication for LDAP since there seems to be the following
        // error with GSSAPI authentication (which works for search) while requesting a modification to LDAP:
        // javax.naming.AuthenticationNotSupportedException: 
        // [LDAP: error code 8 - modifications require authentication]
        // Awaiting reply from mailing lists.

		//String ldapurl = props.getProperty(&quot;ldapurl&quot;, &quot;ldap://someldapserver.com:389&quot;);
		//String basedn = props.getProperty(&quot;basedn&quot;, &quot;dc=arch,dc=org&quot;);
			
		// Set up the environment for creating the initial context
		//Hashtable env = new Hashtable(11);
		//env.put(Context.INITIAL_CONTEXT_FACTORY, 
		//    &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
		//env.put(Context.PROVIDER_URL, ldapurl);

		//env.put(Context.SECURITY_AUTHENTICATION,&quot;simple&quot;);
		//env.put(Context.SECURITY_PRINCIPAL,&quot;cn=xxx,dc=arch,dc=org&quot;); // specify the username
		//env.put(Context.SECURITY_CREDENTIALS,&quot;secret&quot;);           // specify the password
		
        try {
			// Create the initial context
			//LdapContext ctx = new InitialLdapContext(env,null);			
<span class="nc" id="L655">		    dctx.modifyAttributes(grp.getDn(), DirContext.REPLACE_ATTRIBUTE, grp.getAttributes());</span>
<span class="nc" id="L656">            return true;</span>
<span class="nc" id="L657">        } catch (NamingException ne) {</span>
<span class="nc" id="L658">    		ne.printStackTrace();</span>
<span class="nc" id="L659">    		return false;</span>
<span class="nc" id="L660">    	} catch (Exception e) {</span>
<span class="nc" id="L661">    		e.printStackTrace();</span>
<span class="nc" id="L662">    		return false;</span>
    	}
    }

<span class="nc" id="L666">    class peopleComparator implements Comparator {</span>
		public int compare(Object o0, Object o1) {
<span class="nc" id="L668">			Person p0 = (Person) o0;</span>
<span class="nc" id="L669">			Person p1 = (Person) o1;</span>
			// compare cn first
<span class="nc" id="L671">			int cnComp = p0.getCn().toUpperCase().compareTo(p1.getCn().toUpperCase());</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">			if (cnComp != 0) {</span>
<span class="nc" id="L673">				return cnComp;</span>
			}
			// if cn same then compare uids
<span class="nc" id="L676">			int uidComp = p0.getUid().toUpperCase().compareTo(p1.getUid().toUpperCase());</span>
<span class="nc" id="L677">			return uidComp;</span>
		}
	}
    
<span class="nc" id="L681">    class roleComparator implements Comparator {</span>
		public int compare(Object o0, Object o1) {
<span class="nc" id="L683">			Role r0 = (Role) o0;</span>
<span class="nc" id="L684">			Role r1 = (Role) o1;</span>
			// compare cn
<span class="nc" id="L686">			int cnComp = r0.getCn().toUpperCase().compareTo(r1.getCn().toUpperCase());</span>
<span class="nc" id="L687">				return cnComp;			</span>
		}
	}
    
<span class="nc" id="L691">    class groupComparator implements Comparator {</span>
		public int compare(Object o0, Object o1) {
<span class="nc" id="L693">			Group g0 = (Group) o0;</span>
<span class="nc" id="L694">			Group g1 = (Group) o1;</span>
			// compare cn
<span class="nc" id="L696">			int cnComp = g0.getCn().toUpperCase().compareTo(g1.getCn().toUpperCase());</span>
<span class="nc" id="L697">				return cnComp;			</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>