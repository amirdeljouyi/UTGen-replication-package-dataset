<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConsumerStore.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">66_openjms</a> &gt; <a href="index.source.html" class="el_package">org.exolab.jms.tools.migration.proxy</a> &gt; <span class="el_source">ConsumerStore.java</span></div><h1>ConsumerStore.java</h1><pre class="source lang-java linenums">/**
 * Redistribution and use of this software and associated documentation
 * (&quot;Software&quot;), with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * 1. Redistributions of source code must retain copyright
 *    statements and notices.  Redistributions must also contain a
 *    copy of this document.
 *
 * 2. Redistributions in binary form must reproduce the
 *    above copyright notice, this list of conditions and the
 *    following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * 3. The name &quot;Exolab&quot; must not be used to endorse or promote
 *    products derived from this Software without prior written
 *    permission of Exoffice Technologies.  For written permission,
 *    please contact info@exolab.org.
 *
 * 4. Products derived from this Software may not be called &quot;Exolab&quot;
 *    nor may &quot;Exolab&quot; appear in their names without prior written
 *    permission of Exoffice Technologies. Exolab is a registered
 *    trademark of Exoffice Technologies.
 *
 * 5. Due credit should be given to the Exolab Project
 *    (http://www.exolab.org/).
 *
 * THIS SOFTWARE IS PROVIDED BY EXOFFICE TECHNOLOGIES AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
 * NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
 * EXOFFICE TECHNOLOGIES OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Copyright 2005 (C) Exoffice Technologies Inc. All Rights Reserved.
 */
package org.exolab.jms.tools.migration.proxy;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Connection;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import javax.jms.JMSException;

import org.exolab.jms.client.JmsDestination;
import org.exolab.jms.client.JmsQueue;
import org.exolab.jms.persistence.PersistenceException;
import org.exolab.jms.persistence.SQLHelper;
import org.exolab.jms.tools.migration.Store;
import org.exolab.jms.tools.migration.StoreIterator;


/**
 * Provides persistency for {@link Consumer} instances.
 *
 * @author &lt;a href=&quot;mailto:tma@netspace.net.au&quot;&gt;Tim Anderson&lt;/a&gt;
 * @version $Revision: 1.2 $ $Date: 2005/10/20 14:07:03 $
 */
public class ConsumerStore implements Store, DBConstants {

    /**
     * The destination store.
     */
    private final DestinationStore _destinations;

    /**
     * The database connection.
     */
    private final Connection _connection;

    /**
     * The seed used to generate identifiers for consumers.
     */
<span class="nc" id="L83">    private long _seed = 0;</span>


    /**
     * Construct a new &lt;code&gt;ConsumerStore&lt;/code&gt;.
     *
     * @param destinations the destination store
     * @param connection the database connection
     */
<span class="nc" id="L92">    public ConsumerStore(DestinationStore destinations, Connection connection) {</span>
<span class="nc" id="L93">        _destinations = destinations;</span>
<span class="nc" id="L94">        _connection = connection;</span>
<span class="nc" id="L95">    }</span>

    /**
     * Export the consumers.
     *
     * @return an iterator over the collection
     * @throws JMSException         for any JMS error
     * @throws PersistenceException for any persistence error
     */
    public StoreIterator exportCollection() throws JMSException,
            PersistenceException {
<span class="nc" id="L106">        List consumerIds = getConsumerIds();</span>
<span class="nc" id="L107">        return new ConsumerIterator(consumerIds);</span>
    }

    /**
     * Import consumers into the store.
     *
     * @param iterator an iterator over the collection
     * @throws JMSException         for any JMS error
     * @throws PersistenceException for any persistence error
     */
    public void importCollection(StoreIterator iterator) throws JMSException,
            PersistenceException {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L120">            Consumer consumer = (Consumer) iterator.next();</span>
<span class="nc" id="L121">            add(consumer);</span>
<span class="nc" id="L122">        }</span>
<span class="nc" id="L123">    }</span>

    /**
     * Returns the number of elements in the collection.
     *
     * @return the number of elements in the collection
     * @throws PersistenceException for any persistence error
     */
    public int size() throws PersistenceException {
<span class="nc" id="L132">        return getConsumerIds().size();</span>
    }

    /**
     * Add a new consumer.
     *
     * @param consumer the consumer to add
     * @throws PersistenceException for any persistence error
     */
    public synchronized void add(Consumer consumer)
            throws PersistenceException {
<span class="nc" id="L143">        PreparedStatement insert = null;</span>
        try {
<span class="nc" id="L145">            long consumerId = ++_seed;</span>

<span class="nc" id="L147">            insert = _connection.prepareStatement(</span>
                    &quot;insert into &quot; + CONSUMER_TABLE + &quot; values (?, ?, ?, ?)&quot;);

<span class="nc" id="L150">            insert.setLong(1, consumerId);</span>
<span class="nc" id="L151">            insert.setString(2, consumer.getName());</span>
<span class="nc" id="L152">            insert.setString(3, consumer.getClientID());</span>
<span class="nc" id="L153">            insert.setBoolean(4, consumer.isQueueConsumer());</span>
<span class="nc" id="L154">            insert.executeUpdate();</span>

<span class="nc" id="L156">            addSubscriptions(consumerId, consumer);</span>
<span class="nc" id="L157">        } catch (SQLException exception) {</span>
<span class="nc" id="L158">            throw new PersistenceException(&quot;Failed to add consumer&quot;,</span>
                                           exception);
        } finally {
<span class="nc" id="L161">            SQLHelper.close(insert);</span>
        }
<span class="nc" id="L163">    }</span>

    /**
     * Returns a consumer for a given identifier.
     *
     * @param consumerId the identity of the consumer
     * @return the consumer corresponding to &lt;code&gt;consumerId&lt;/code&gt; or
     *         &lt;code&gt;null&lt;/code&gt; if no such consumer exists
     * @throws PersistenceException for any persistence error
     */
    public Consumer get(long consumerId) throws PersistenceException {
<span class="nc" id="L174">        Consumer result = null;</span>
<span class="nc" id="L175">        PreparedStatement select = null;</span>
<span class="nc" id="L176">        ResultSet set = null;</span>
        try {
<span class="nc" id="L178">            select = _connection.prepareStatement(</span>
                    &quot;select name, client_id, queue_consumer from &quot;
                    + CONSUMER_TABLE + &quot; where consumer_id = ?&quot;);
<span class="nc" id="L181">            select.setLong(1, consumerId);</span>
<span class="nc" id="L182">            set = select.executeQuery();</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">            if (set.next()) {</span>
<span class="nc" id="L184">                String name = set.getString(1);</span>
<span class="nc" id="L185">                String clientId = set.getString(2);</span>
<span class="nc" id="L186">                boolean isQueue = set.getBoolean(3);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                if (isQueue) {</span>
<span class="nc" id="L188">                    result = new Consumer(new JmsQueue(name));</span>
                } else {
<span class="nc" id="L190">                    result = new Consumer(name, clientId);</span>
                }
<span class="nc" id="L192">                getSubscriptions(consumerId, result);</span>
            }
<span class="nc" id="L194">        } catch (SQLException exception) {</span>
<span class="nc" id="L195">            throw new PersistenceException(&quot;Failed to get consumer&quot;,</span>
                                           exception);
        } finally {
<span class="nc" id="L198">            SQLHelper.close(set);</span>
<span class="nc" id="L199">            SQLHelper.close(select);</span>
        }
<span class="nc" id="L201">        return result;</span>
    }

    /**
     * Returns all consumer identifiers.
     *
     * @return a list of consumer identifiers
     * @throws PersistenceException for any persistence error
     */
    public List getConsumerIds() throws PersistenceException {
<span class="nc" id="L211">        ArrayList result = new ArrayList();</span>

<span class="nc" id="L213">        PreparedStatement select = null;</span>
<span class="nc" id="L214">        ResultSet set = null;</span>
        try {
<span class="nc" id="L216">            select = _connection.prepareStatement(</span>
                    &quot;select consumer_id from &quot; + CONSUMER_TABLE);

<span class="nc" id="L219">            set = select.executeQuery();</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            while (set.next()) {</span>
<span class="nc" id="L221">                long consumerId = set.getLong(&quot;consumer_id&quot;);</span>
<span class="nc" id="L222">                result.add(new Long(consumerId));</span>
<span class="nc" id="L223">            }</span>
<span class="nc" id="L224">        } catch (SQLException exception) {</span>
<span class="nc" id="L225">            throw new PersistenceException(</span>
                    &quot;Failed to retrieve consumer identifiers&quot;, exception);
        } finally {
<span class="nc" id="L228">            SQLHelper.close(set);</span>
<span class="nc" id="L229">            SQLHelper.close(select);</span>
        }
<span class="nc" id="L231">        return result;</span>
    }

    /**
     * Add subscriptions for a consumer.
     *
     * @param consumerId the identity of the consumer
     * @param consumer   the consumer
     * @throws PersistenceException for any persistence error
     */
    protected void addSubscriptions(long consumerId, Consumer consumer)
            throws PersistenceException {
<span class="nc" id="L243">        Iterator iterator = consumer.getSubscriptions().iterator();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L245">            Subscription subscription = (Subscription) iterator.next();</span>
<span class="nc" id="L246">            long destinationId = _destinations.getId(</span>
<span class="nc" id="L247">                    subscription.getDestination());</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (destinationId == -1) {</span>
<span class="nc" id="L249">                throw new PersistenceException(</span>
                        &quot;Destination identifier not found for destination=&quot;
<span class="nc" id="L251">                        + subscription.getDestination().getName());</span>
            }

<span class="nc" id="L254">            PreparedStatement insert = null;</span>
            try {
<span class="nc" id="L256">                insert = _connection.prepareStatement(</span>
                        &quot;insert into &quot; + SUBSCRIPTION_TABLE + &quot; values (?, ?)&quot;);

<span class="nc" id="L259">                insert.setLong(1, consumerId);</span>
<span class="nc" id="L260">                insert.setLong(2, destinationId);</span>
<span class="nc" id="L261">                insert.executeUpdate();</span>
<span class="nc" id="L262">            } catch (SQLException exception) {</span>
<span class="nc" id="L263">                throw new PersistenceException(&quot;Failed to insert subscription&quot;,</span>
                                               exception);
            } finally {
<span class="nc" id="L266">                SQLHelper.close(insert);</span>
            }

<span class="nc" id="L269">            addMessages(consumerId, destinationId, subscription);</span>
<span class="nc" id="L270">        }</span>
<span class="nc" id="L271">    }</span>

    /**
     * Add messages for a subscription.
     *
     * @param consumerId    the identity of the consumer
     * @param destinationId the identify of the destination
     * @param subscription  the consumer subscription
     * @throws PersistenceException for any persistence error
     */
    protected void addMessages(long consumerId, long destinationId,
                               Subscription subscription)
            throws PersistenceException {

<span class="nc" id="L285">        Iterator iterator = subscription.getMessages().iterator();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L287">            MessageState message = (MessageState) iterator.next();</span>

<span class="nc" id="L289">            PreparedStatement insert = null;</span>
            try {
<span class="nc" id="L291">                insert = _connection.prepareStatement(</span>
                        &quot;insert into &quot; + MESSAGE_HANDLE_TABLE + &quot; &quot;
                        + &quot;(message_id, destination_id, consumer_id, delivered)&quot;
                        + &quot; values (?, ?, ?, ?)&quot;);
<span class="nc" id="L295">                insert.setString(1, message.getMessageId());</span>
<span class="nc" id="L296">                insert.setLong(2, destinationId);</span>
<span class="nc" id="L297">                insert.setLong(3, consumerId);</span>
<span class="nc" id="L298">                insert.setBoolean(4, message.getDelivered());</span>
<span class="nc" id="L299">                insert.executeUpdate();</span>
<span class="nc" id="L300">            } catch (SQLException exception) {</span>
<span class="nc" id="L301">                throw new PersistenceException(</span>
                        &quot;Failed to insert subscription state&quot;, exception);
            } finally {
<span class="nc" id="L304">                SQLHelper.close(insert);</span>
            }
<span class="nc" id="L306">        }</span>
<span class="nc" id="L307">    }</span>

    /**
     * Get subscriptions for a consumer.
     *
     * @param consumerId the identity of the consumer
     * @param consumer   the consumer to populate
     * @throws PersistenceException for any persistence error
     */
    protected void getSubscriptions(long consumerId, Consumer consumer)
            throws PersistenceException {

<span class="nc" id="L319">        PreparedStatement select = null;</span>
<span class="nc" id="L320">        ResultSet set = null;</span>
        try {
<span class="nc" id="L322">            select = _connection.prepareStatement(</span>
                    &quot;select destination_id &quot;
                    + &quot;from &quot; + SUBSCRIPTION_TABLE
                    + &quot; where consumer_id = ?&quot;);
<span class="nc" id="L326">            select.setLong(1, consumerId);</span>

<span class="nc" id="L328">            set = select.executeQuery();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">            while (set.next()) {</span>
<span class="nc" id="L330">                long destinationId = set.getLong(&quot;destination_id&quot;);</span>
<span class="nc" id="L331">                JmsDestination destination = _destinations.get(destinationId);</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                if (destination == null) {</span>
<span class="nc" id="L333">                    throw new PersistenceException(</span>
                            &quot;Failed to locate destination for id=&quot;
                            + destinationId);
                }
<span class="nc" id="L337">                Subscription subscription = new Subscription(destination);</span>
<span class="nc" id="L338">                getMessages(consumerId, destinationId, subscription);</span>
<span class="nc" id="L339">                consumer.addSubscription(subscription);</span>
<span class="nc" id="L340">            }</span>
<span class="nc" id="L341">        } catch (SQLException exception) {</span>
<span class="nc" id="L342">            throw new PersistenceException(</span>
                    &quot;Failed to get subscriptions for consumer=&quot; + consumerId,
                    exception);
        } finally {
<span class="nc" id="L346">            SQLHelper.close(set);</span>
<span class="nc" id="L347">            SQLHelper.close(select);</span>
        }
<span class="nc" id="L349">    }</span>

    /**
     * Get messages for a subscription.
     *
     * @param consumerId    the identity of the consumer
     * @param destinationId the identify of the destination
     * @param subscription  the consumer subscription
     * @throws SQLException if a database error is encountered
     */
    protected void getMessages(long consumerId, long destinationId,
                               Subscription subscription)
            throws SQLException {

<span class="nc" id="L363">        PreparedStatement select = null;</span>
<span class="nc" id="L364">        ResultSet set = null;</span>
        try {
<span class="nc" id="L366">            select = _connection.prepareStatement(</span>
                    &quot;select message_id, delivered &quot;
                    + &quot;from &quot; + MESSAGE_HANDLE_TABLE
                    + &quot; where consumer_id = ? and destination_id = ?&quot;);
<span class="nc" id="L370">            select.setLong(1, consumerId);</span>
<span class="nc" id="L371">            select.setLong(2, destinationId);</span>

<span class="nc" id="L373">            set = select.executeQuery();</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">            while (set.next()) {</span>
<span class="nc" id="L375">                String messageId = set.getString(&quot;message_id&quot;);</span>
<span class="nc" id="L376">                boolean delivered = set.getBoolean(&quot;delivered&quot;);</span>
<span class="nc" id="L377">                subscription.addMessage(messageId, delivered);</span>
<span class="nc" id="L378">            }</span>
        } finally {
<span class="nc" id="L380">            SQLHelper.close(set);</span>
<span class="nc" id="L381">            SQLHelper.close(select);</span>
        }
<span class="nc" id="L383">    }</span>

    private class ConsumerIterator implements StoreIterator {

        private Iterator _iterator;

<span class="nc" id="L389">        public ConsumerIterator(List consumerIds) {</span>
<span class="nc" id="L390">            _iterator = consumerIds.iterator();</span>
<span class="nc" id="L391">        }</span>

        public boolean hasNext() {
<span class="nc" id="L394">            return _iterator.hasNext();</span>
        }

        public Object next() throws PersistenceException {
<span class="nc" id="L398">            Consumer result = null;</span>

<span class="nc" id="L400">            Long consumerId = (Long) _iterator.next();</span>

<span class="nc" id="L402">            result = get(consumerId.longValue());</span>
<span class="nc" id="L403">            return result;</span>
        }
    }

}



</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>