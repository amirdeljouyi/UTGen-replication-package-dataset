<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractMessageHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">66_openjms</a> &gt; <a href="index.source.html" class="el_package">org.exolab.jms.tools.migration.proxy</a> &gt; <span class="el_source">AbstractMessageHandler.java</span></div><h1>AbstractMessageHandler.java</h1><pre class="source lang-java linenums">/**
 * Redistribution and use of this software and associated documentation
 * (&quot;Software&quot;), with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * 1. Redistributions of source code must retain copyright
 *    statements and notices.  Redistributions must also contain a
 *    copy of this document.
 *
 * 2. Redistributions in binary form must reproduce the
 *    above copyright notice, this list of conditions and the
 *    following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * 3. The name &quot;Exolab&quot; must not be used to endorse or promote
 *    products derived from this Software without prior written
 *    permission of Exoffice Technologies.  For written permission,
 *    please contact info@exolab.org.
 *
 * 4. Products derived from this Software may not be called &quot;Exolab&quot;
 *    nor may &quot;Exolab&quot; appear in their names without prior written
 *    permission of Exoffice Technologies. Exolab is a registered
 *    trademark of Exoffice Technologies.
 *
 * 5. Due credit should be given to the Exolab Project
 *    (http://www.exolab.org/).
 *
 * THIS SOFTWARE IS PROVIDED BY EXOFFICE TECHNOLOGIES AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
 * NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
 * EXOFFICE TECHNOLOGIES OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Copyright 2005 (C) Exoffice Technologies Inc. All Rights Reserved.
 *
 * $Id: AbstractMessageHandler.java,v 1.2 2005/10/20 14:07:03 tanderson Exp $
 */
package org.exolab.jms.tools.migration.proxy;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.sql.Blob;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import javax.jms.Destination;
import javax.jms.JMSException;
import javax.jms.Message;

import org.exolab.jms.client.JmsDestination;
import org.exolab.jms.persistence.PersistenceException;
import org.exolab.jms.persistence.SQLHelper;


/**
 * Abstract implementation of the  &lt;code&gt;MessageHandler&lt;/code&gt; interface.
 *
 * @author &lt;a href=&quot;mailto:tma@netspace.net.au&quot;&gt;Tim Anderson&lt;/a&gt;
 * @version $Revision: 1.2 $ $Date: 2005/10/20 14:07:03 $
 */
abstract class AbstractMessageHandler implements MessageHandler, DBConstants {

    /**
     * The destination store.
     */
    private final DestinationStore _destinations;

    /**
     * The database connection.
     */
    private Connection _connection;


    /**
     * Construct a new &lt;code&gt;AbstractMessageHandler&lt;/code&gt;.
     *
     * @param destinations the destination store
     * @param connection   the database connection
     */
    public AbstractMessageHandler(DestinationStore destinations,
<span class="nc" id="L95">                                  Connection connection) {</span>
<span class="nc" id="L96">        _destinations = destinations;</span>
<span class="nc" id="L97">        _connection = connection;</span>
<span class="nc" id="L98">    }</span>

    /**
     * Add a message.
     *
     * @param message the message to add
     * @throws JMSException         for any JMS error
     * @throws PersistenceException for any persistence error
     */
    public void add(Message message) throws JMSException, PersistenceException {
<span class="nc" id="L108">        add(message, getType());</span>
<span class="nc" id="L109">    }</span>

    /**
     * Returns a message given its identifier.
     *
     * @param messageId the identifier of the message to retrieve
     * @return the message corresponding to &lt;code&gt;messageId&lt;/code&gt;
     * @throws JMSException         for any JMS error
     * @throws PersistenceException for any persistence error
     */
    public Message get(String messageId) throws JMSException,
            PersistenceException {
<span class="nc" id="L121">        Message message = newMessage();</span>
<span class="nc" id="L122">        get(messageId, message);</span>
<span class="nc" id="L123">        return message;</span>
    }

    /**
     * Returns the type of message that this handler supports.
     *
     * @return the type of message
     */
    protected abstract String getType();

    /**
     * Create a new message.
     *
     * @return a new message
     * @throws JMSException for any JMS error
     */
    protected abstract Message newMessage() throws JMSException;

    /**
     * Populate the message body.
     *
     * @param body    the message body
     * @param message the message to populate
     * @throws JMSException         for any JMS error
     * @throws PersistenceException for any persistence error
     */
    protected abstract void setBody(Object body, Message message)
            throws JMSException, PersistenceException;

    /**
     * Returns the body of the message.
     *
     * @param message the message
     * @return the body of the message
     * @throws JMSException for any JMS error
     */
    protected abstract Object getBody(Message message) throws JMSException;

    /**
     * Populate a message.
     *
     * @param messageId the message identifier
     * @param message   the message to populate
     * @throws JMSException         for any JMS error
     * @throws PersistenceException for any persistence error
     */
    protected void get(String messageId, Message message)
            throws JMSException, PersistenceException {
<span class="nc" id="L171">        PreparedStatement select = null;</span>
<span class="nc" id="L172">        ResultSet set = null;</span>
        try {
<span class="nc" id="L174">            select = _connection.prepareStatement(</span>
                    &quot;select * from &quot; + MESSAGE_TABLE + &quot; where message_id = ?&quot;);
<span class="nc" id="L176">            select.setString(1, messageId);</span>
<span class="nc" id="L177">            set = select.executeQuery();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (!set.next()) {</span>
<span class="nc" id="L179">                throw new PersistenceException(</span>
                        &quot;Message not found, JMSMessageID=&quot; + messageId);
            }
<span class="nc" id="L182">            String correlationId = set.getString(&quot;correlation_id&quot;);</span>
<span class="nc" id="L183">            int deliveryMode = set.getInt(&quot;delivery_mode&quot;);</span>
<span class="nc" id="L184">            long destinationId = set.getLong(&quot;destination_id&quot;);</span>
<span class="nc" id="L185">            long expiration = set.getLong(&quot;expiration&quot;);</span>
<span class="nc" id="L186">            int priority = set.getInt(&quot;priority&quot;);</span>
<span class="nc" id="L187">            boolean redelivered = set.getBoolean(&quot;redelivered&quot;);</span>
<span class="nc" id="L188">            long replyToId = set.getLong(&quot;reply_to_id&quot;);</span>
<span class="nc" id="L189">            long timestamp = set.getLong(&quot;timestamp&quot;);</span>
<span class="nc" id="L190">            String type = set.getString(&quot;type&quot;);</span>

<span class="nc" id="L192">            Destination destination = _destinations.get(destinationId);</span>

<span class="nc" id="L194">            message.setJMSMessageID(messageId);</span>
<span class="nc" id="L195">            message.setJMSCorrelationID(correlationId);</span>
<span class="nc" id="L196">            message.setJMSDeliveryMode(deliveryMode);</span>
<span class="nc" id="L197">            message.setJMSDestination(destination);</span>
<span class="nc" id="L198">            message.setJMSExpiration(expiration);</span>
<span class="nc" id="L199">            message.setJMSPriority(priority);</span>
<span class="nc" id="L200">            message.setJMSRedelivered(redelivered);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (replyToId != 0) {</span>
<span class="nc" id="L202">                Destination replyTo = _destinations.get(replyToId);</span>
<span class="nc" id="L203">                message.setJMSReplyTo(replyTo);</span>
            }
<span class="nc" id="L205">            message.setJMSTimestamp(timestamp);</span>
<span class="nc" id="L206">            message.setJMSType(type);</span>

<span class="nc" id="L208">            Blob blob = set.getBlob(&quot;body&quot;);</span>
            Object body;
            try {
<span class="nc" id="L211">                body = deserialize(blob);</span>
<span class="nc" id="L212">            } catch (Exception exception) {</span>
<span class="nc" id="L213">                throw new PersistenceException(</span>
                        &quot;Failed to deserialize message body, JMSMessageID=&quot;
                        + messageId, exception);
<span class="nc" id="L216">            }</span>
<span class="nc" id="L217">            setBody(body, message);</span>
<span class="nc" id="L218">        } catch (SQLException exception) {</span>
<span class="nc" id="L219">            throw new PersistenceException(</span>
                    &quot;Failed to populate message, JMSMessageID=&quot;
                    + messageId, exception);
        } finally {
<span class="nc" id="L223">            SQLHelper.close(set);</span>
<span class="nc" id="L224">            SQLHelper.close(select);</span>
        }

<span class="nc" id="L227">        getProperties(messageId, message);</span>
<span class="nc" id="L228">    }</span>

    /**
     * Populate message properties.
     *
     * @param messageId the message identifier
     * @param message   the message to populate
     * @throws JMSException         for any JMS error
     * @throws PersistenceException for any persistence error
     */
    protected void getProperties(String messageId, Message message)
            throws JMSException, PersistenceException {

<span class="nc" id="L241">        Map properties = getProperties(messageId);</span>
<span class="nc" id="L242">        Iterator iterator = properties.entrySet().iterator();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L244">            Map.Entry entry = (Map.Entry) iterator.next();</span>
<span class="nc" id="L245">            String name = (String) entry.getKey();</span>
<span class="nc" id="L246">            Object value = entry.getValue();</span>
<span class="nc" id="L247">            message.setObjectProperty(name, value);</span>
<span class="nc" id="L248">        }</span>
<span class="nc" id="L249">    }</span>

    /**
     * Add a message.
     *
     * @param message the message to add
     * @param type    the type of the message
     * @throws JMSException         for any JMS error
     * @throws PersistenceException for any persistence error
     */
    protected void add(Message message, String type)
            throws JMSException, PersistenceException {

<span class="nc" id="L262">        PreparedStatement insert = null;</span>
<span class="nc" id="L263">        String messageId = null;</span>
        try {
<span class="nc" id="L265">            insert = _connection.prepareStatement(</span>
                    &quot;insert into &quot; + MESSAGE_TABLE
                    + &quot; values  (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;);

<span class="nc" id="L269">            messageId = message.getJMSMessageID();</span>

<span class="nc" id="L271">            long destinationId = _destinations.getId(</span>
<span class="nc" id="L272">                    (JmsDestination) message.getJMSDestination());</span>
            
            // insert message header
<span class="nc" id="L275">            insert.setString(1, messageId);</span>
<span class="nc" id="L276">            insert.setString(2, type);</span>
<span class="nc" id="L277">            insert.setString(3, message.getJMSCorrelationID());</span>
<span class="nc" id="L278">            insert.setInt(4, message.getJMSDeliveryMode());</span>
<span class="nc" id="L279">            insert.setLong(5, destinationId);</span>
<span class="nc" id="L280">            insert.setLong(6, message.getJMSExpiration());</span>
<span class="nc" id="L281">            insert.setInt(7, message.getJMSPriority());</span>
<span class="nc" id="L282">            insert.setBoolean(8, message.getJMSRedelivered());</span>
<span class="nc" id="L283">            long replyToId = 0;</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            if (message.getJMSReplyTo() != null) {</span>
<span class="nc" id="L285">                JmsDestination replyTo =</span>
<span class="nc" id="L286">                        (JmsDestination) message.getJMSReplyTo();</span>
<span class="nc" id="L287">                replyToId = _destinations.getId(replyTo);</span>
            }
<span class="nc" id="L289">            insert.setLong(9, replyToId);</span>
<span class="nc" id="L290">            insert.setLong(10, message.getJMSTimestamp());</span>
<span class="nc" id="L291">            insert.setString(11, message.getJMSType());</span>
<span class="nc" id="L292">            Object body = getBody(message);</span>
            byte[] blob;
            try {
<span class="nc" id="L295">                blob = serialize(body);</span>
<span class="nc" id="L296">            } catch (Exception exception) {</span>
<span class="nc" id="L297">                throw new PersistenceException(</span>
                        &quot;Failed to serialize message body, JMSMessageID=&quot;
                        + messageId, exception);
<span class="nc" id="L300">            }</span>
<span class="nc" id="L301">            insert.setObject(12, blob);</span>

<span class="nc" id="L303">            insert.executeUpdate();</span>
            
            // insert header properties
<span class="nc" id="L306">            Enumeration iterator = message.getPropertyNames();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">            while (iterator.hasMoreElements()) {</span>
<span class="nc" id="L308">                String name = (String) iterator.nextElement();</span>
<span class="nc" id="L309">                Object value = message.getObjectProperty(name);</span>
<span class="nc" id="L310">                addProperty(messageId, name, value);</span>
<span class="nc" id="L311">            }</span>
<span class="nc" id="L312">            _connection.commit();</span>
<span class="nc" id="L313">        } catch (SQLException exception) {</span>
<span class="nc" id="L314">            throw new PersistenceException(</span>
                    &quot;Failed to add message, JMSMessageID=&quot; + messageId,
                    exception);
        } finally {
<span class="nc" id="L318">            SQLHelper.close(insert);</span>
        }
<span class="nc" id="L320">    }</span>

    /**
     * Returns properties for a message.
     *
     * @param messageId the message identifier
     * @return a map of properties
     * @throws PersistenceException for any persistence error
     */
    protected Map getProperties(String messageId)
            throws PersistenceException {

<span class="nc" id="L332">        HashMap result = new HashMap();</span>

<span class="nc" id="L334">        PreparedStatement select = null;</span>
<span class="nc" id="L335">        ResultSet set = null;</span>
        try {
<span class="nc" id="L337">            select = _connection.prepareStatement(</span>
                    &quot;select name, value from &quot; + MESSAGE_PROPERTIES_TABLE
                    + &quot; where message_id = ?&quot;);
<span class="nc" id="L340">            select.setString(1, messageId);</span>
<span class="nc" id="L341">            set = select.executeQuery();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            while (set.next()) {</span>
<span class="nc" id="L343">                String name = set.getString(&quot;name&quot;);</span>
<span class="nc" id="L344">                Blob blob = set.getBlob(&quot;value&quot;);</span>
                Object value;
                try {
<span class="nc" id="L347">                    value = deserialize(blob);</span>
<span class="nc" id="L348">                } catch (Exception exception) {</span>
<span class="nc" id="L349">                    String message = &quot;Failed to destream property for &quot;</span>
                            + &quot;message, JMSMessageID=&quot; + messageId
                            + &quot;, property=&quot; + name;
<span class="nc" id="L352">                    throw new PersistenceException(message, exception);</span>
<span class="nc" id="L353">                }</span>
<span class="nc" id="L354">                result.put(name, value);</span>
<span class="nc" id="L355">            }</span>
<span class="nc" id="L356">        } catch (SQLException exception) {</span>
<span class="nc" id="L357">            throw new PersistenceException(</span>
                    &quot;Failed to get properties for message, JMSMessageID=&quot;
                    + messageId, exception);
        } finally {
<span class="nc" id="L361">            SQLHelper.close(set);</span>
<span class="nc" id="L362">            SQLHelper.close(select);</span>
        }
<span class="nc" id="L364">        return result;</span>
    }

    /**
     * Add a property.
     *
     * @param messageId the message identifier
     * @param name      the property name
     * @param value     the property value
     * @throws PersistenceException for any persistence error
     */
    protected void addProperty(String messageId,
                               String name, Object value)
            throws PersistenceException {

        byte[] blob;
        try {
<span class="nc" id="L381">            blob = serialize(value);</span>
<span class="nc" id="L382">        } catch (IOException exception) {</span>
<span class="nc" id="L383">            String message = &quot;Failed to serialize property for message, &quot;</span>
                    + &quot;JMSMessageID=&quot; + messageId + &quot;, name=&quot; + name;
<span class="nc bnc" id="L385" title="All 2 branches missed.">            if (value != null) {</span>
<span class="nc" id="L386">                message += &quot; of type &quot; + value.getClass().getName();</span>
            }
<span class="nc" id="L388">            throw new PersistenceException(message, exception);</span>
<span class="nc" id="L389">        }</span>

<span class="nc" id="L391">        PreparedStatement insert = null;</span>
        try {
<span class="nc" id="L393">            insert = _connection.prepareStatement(</span>
                    &quot;insert into &quot; + MESSAGE_PROPERTIES_TABLE
                    + &quot; values (?, ?, ?)&quot;);
<span class="nc" id="L396">            insert.setString(1, messageId);</span>
<span class="nc" id="L397">            insert.setString(2, name);</span>
<span class="nc" id="L398">            insert.setObject(3, blob);</span>
<span class="nc" id="L399">            insert.executeUpdate();</span>
<span class="nc" id="L400">        } catch (SQLException exception) {</span>
<span class="nc" id="L401">            throw new PersistenceException(</span>
                    &quot;Failed to add property for message, JMSMessageID=&quot;
                    + messageId + &quot;, name=&quot; + name + &quot;, value=&quot; + value,
                    exception);
        } finally {
<span class="nc" id="L406">            SQLHelper.close(insert);</span>
        }
<span class="nc" id="L408">    }</span>

    /**
     * Helper to serialize an object to a byte array.
     *
     * @param object the object to serialize
     * @return the serialized object
     * @throws IOException if the object cannot be serialized
     */
    public byte[] serialize(Object object) throws IOException {
        byte[] result;
<span class="nc" id="L419">        ByteArrayOutputStream bstream = new ByteArrayOutputStream();</span>
<span class="nc" id="L420">        ObjectOutputStream ostream = new ObjectOutputStream(bstream);</span>
<span class="nc" id="L421">        ostream.writeObject(object);</span>
<span class="nc" id="L422">        ostream.close();</span>
<span class="nc" id="L423">        result = bstream.toByteArray();</span>
<span class="nc" id="L424">        return result;</span>
    }

    /**
     * Helper to deserialize an object from a byte array.
     *
     * @param blob the blob containing object to deserialize
     * @return the destreamed object
     * @throws ClassNotFoundException if the class of a serialized object cannot
     *                                be found.
     * @throws IOException            if the object cannot be deserialized
     * @throws SQLException           if there is an error accessing the
     *                                &lt;code&gt;blob&lt;/code&gt;
     */
    protected Object deserialize(Blob blob)
            throws ClassNotFoundException, IOException, SQLException {
<span class="nc" id="L440">        Object result = null;</span>

<span class="nc bnc" id="L442" title="All 2 branches missed.">        if (blob != null) {</span>
<span class="nc" id="L443">            ObjectInputStream istream = new ObjectInputStream(</span>
<span class="nc" id="L444">                    blob.getBinaryStream());</span>
<span class="nc" id="L445">            result = istream.readObject();</span>
<span class="nc" id="L446">            istream.close();</span>
        }
<span class="nc" id="L448">        return result;</span>
    }

    /**
     * Returns the database connection.
     *
     * @return the connection to the database
     */
    protected Connection getConnection() {
<span class="nc" id="L457">        return _connection;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>