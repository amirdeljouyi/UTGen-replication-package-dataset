<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DBTool.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">66_openjms</a> &gt; <a href="index.source.html" class="el_package">org.exolab.jms.tools.db</a> &gt; <span class="el_source">DBTool.java</span></div><h1>DBTool.java</h1><pre class="source lang-java linenums">/**
 * Redistribution and use of this software and associated documentation
 * (&quot;Software&quot;), with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * 1. Redistributions of source code must retain copyright
 *    statements and notices.  Redistributions must also contain a
 *    copy of this document.
 *
 * 2. Redistributions in binary form must reproduce the
 *    above copyright notice, this list of conditions and the
 *    following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * 3. The name &quot;Exolab&quot; must not be used to endorse or promote
 *    products derived from this Software without prior written
 *    permission of Exoffice Technologies.  For written permission,
 *    please contact info@exolab.org.
 *
 * 4. Products derived from this Software may not be called &quot;Exolab&quot;
 *    nor may &quot;Exolab&quot; appear in their names without prior written
 *    permission of Exoffice Technologies. Exolab is a registered
 *    trademark of Exoffice Technologies.
 *
 * 5. Due credit should be given to the Exolab Project
 *    (http://www.exolab.org/).
 *
 * THIS SOFTWARE IS PROVIDED BY EXOFFICE TECHNOLOGIES AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
 * NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
 * EXOFFICE TECHNOLOGIES OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Copyright 2001-2005 (C) Exoffice Technologies Inc. All Rights Reserved.
 *
 * $Id: DBTool.java,v 1.4 2005/11/12 12:47:37 tanderson Exp $
 */
package org.exolab.jms.tools.db;

import java.sql.Connection;
import java.sql.SQLException;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.apache.log4j.xml.DOMConfigurator;

import org.exolab.jms.config.Configuration;
import org.exolab.jms.config.ConfigurationReader;
import org.exolab.jms.config.RdbmsDatabaseConfiguration;
import org.exolab.jms.persistence.DBCPConnectionManager;
import org.exolab.jms.persistence.DBConnectionManager;
import org.exolab.jms.persistence.PersistenceException;
import org.exolab.jms.persistence.RDBMSAdapter;
import org.exolab.jms.util.CommandLine;


/**
 * This class provides support for creating and destroying OpenJMS tables in
 * RDBMS databases.
 *
 * @author &lt;a href=&quot;mailto:tima@intalio.com&quot;&gt;Tim Anderson&lt;/a&gt;
 * @version $Revision: 1.4 $ $Date: 2005/11/12 12:47:37 $
 */
public class DBTool {

    /**
     * The connection manager.
     */
    private DBConnectionManager _connections;

    /**
     * The RDBMS tool.
     */
    private RDBMSTool _tool;

    /**
     * The logger.
     */
<span class="nc" id="L86">    private static final Log _log = LogFactory.getLog(DBTool.class);</span>


    /**
     * Construct a new &lt;code&gt;DBTool&lt;/code&gt;.
     *
     * @param config the configuration to use.
     * @throws PersistenceException for any error
     */
<span class="nc" id="L95">    public DBTool(Configuration config) throws PersistenceException {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (config == null) {</span>
<span class="nc" id="L97">            throw new IllegalArgumentException(&quot;Argument 'config' is null&quot;);</span>
        }
<span class="nc" id="L99">        init(config);</span>
<span class="nc" id="L100">    }</span>

    /**
     * Construct an instance with the path to an openjms XML configuration file.
     *
     * @param path the path to an openjms XML configuration file
     * @throws PersistenceException if a connection cannot be established
     */
<span class="nc" id="L108">    public DBTool(String path) throws PersistenceException {</span>
        Configuration config;
        try {
<span class="nc" id="L111">            config = ConfigurationReader.read(path);</span>
<span class="nc" id="L112">        } catch (Exception exception) {</span>
<span class="nc" id="L113">            throw new PersistenceException(exception.getMessage());</span>
<span class="nc" id="L114">        }</span>
<span class="nc" id="L115">        DOMConfigurator.configure(config.getLoggerConfiguration().getFile());</span>
<span class="nc" id="L116">        init(config);</span>
<span class="nc" id="L117">    }</span>

    /**
     * Creates the database tables using the default schema.
     *
     * @throws PersistenceException if the tables cannot be created
     */
    public void create() throws PersistenceException {
<span class="nc" id="L125">        Database schema = SchemaHelper.getSchema();</span>
<span class="nc" id="L126">        _tool.create(schema);</span>
<span class="nc" id="L127">    }</span>

    /**
     * Creates the database tables from the specified schema.
     *
     * @param path the path to an XML database schema file
     * @throws PersistenceException if the tables cannot be created
     */
    public void create(String path) throws PersistenceException {
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (path == null) {</span>
<span class="nc" id="L137">            throw new IllegalArgumentException(&quot;Argument 'path' is null&quot;);</span>
        }
<span class="nc" id="L139">        Database schema = SchemaHelper.getSchema(path);</span>
<span class="nc" id="L140">        _tool.create(schema);</span>
<span class="nc" id="L141">    }</span>

    /**
     * Drop the database tables from the default schema.
     *
     * @throws PersistenceException if the tables cannot be dropped
     */
    public void drop() throws PersistenceException {
<span class="nc" id="L149">        Database schema = SchemaHelper.getSchema();</span>
<span class="nc" id="L150">        _tool.drop(schema);</span>
<span class="nc" id="L151">    }</span>

    /**
     * Drop the database tables from the specified schema.
     *
     * @param path the path to an XML database schema file
     * @throws PersistenceException if the tables cannot be dropped
     */
    public void drop(String path) throws PersistenceException {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (path == null) {</span>
<span class="nc" id="L161">            throw new IllegalArgumentException(&quot;Argument 'path' is null&quot;);</span>
        }
<span class="nc" id="L163">        Database schema = SchemaHelper.getSchema(path);</span>
<span class="nc" id="L164">        _tool.drop(schema);</span>
<span class="nc" id="L165">    }</span>

    /**
     * Deletes all data from the database tables.
     *
     * @throws PersistenceException if the tables can't be deleted
     */
    public void delete() throws PersistenceException {
<span class="nc" id="L173">        Database schema = SchemaHelper.getSchema();</span>
<span class="nc" id="L174">        _tool.delete(schema);</span>
<span class="nc" id="L175">    }</span>

    /**
     * Migrates the database tables to the latest version.
     *
     * @throws PersistenceException if the database cannot be migrated
     */
    public void migrate() throws PersistenceException {
<span class="nc" id="L183">        Connection connection = _connections.getConnection();</span>

<span class="nc" id="L185">        String fromVersion = SchemaHelper.getSchemaVersion(connection);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (fromVersion == null) {</span>
<span class="nc" id="L187">            throw new PersistenceException(</span>
                    &quot;Cannot migrate schema - existing schema version cannot be &quot;
                    + &quot;determined&quot;);
        }
<span class="nc" id="L191">        String toVersion = RDBMSAdapter.SCHEMA_VERSION;</span>
<span class="nc" id="L192">        SchemaConverter converter =</span>
<span class="nc" id="L193">                SchemaConverterFactory.create(fromVersion, toVersion,</span>
                                              connection);
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (converter != null) {</span>
            try {
<span class="nc" id="L197">                _log.info(&quot;Migrating schema from version=&quot; +</span>
                          fromVersion + &quot; to version=&quot; + toVersion);
<span class="nc" id="L199">                converter.convert();</span>
<span class="nc" id="L200">                _log.info(&quot;Successfully migrated schema&quot;);</span>
<span class="nc" id="L201">            } catch (PersistenceException exception) {</span>
<span class="nc" id="L202">                _log.error(&quot;Schema migration from version=&quot; + fromVersion +</span>
                           &quot; to version=&quot; + toVersion + &quot; failed&quot;,
                           exception);
<span class="nc" id="L205">                throw exception;</span>
<span class="nc" id="L206">            }</span>
        } else {
<span class="nc" id="L208">            throw new PersistenceException(</span>
                    &quot;Incompatible schema types. Expected schema version=&quot;
                    + fromVersion + &quot;, but got schema version=&quot; + toVersion);
        }
<span class="nc" id="L212">    }</span>

    /**
     * Deallocate any resources.
     *
     * @throws SQLException if the database connection cannot be closed
     */
    public void close() throws SQLException {
<span class="nc" id="L220">        _tool.close();</span>
<span class="nc" id="L221">    }</span>

    public static void main(String args[]) {
<span class="nc" id="L224">        CommandLine commands = new CommandLine(args);</span>

<span class="nc" id="L226">        DBTool tool = null;</span>
<span class="nc" id="L227">        String config = commands.value(&quot;config&quot;);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (config != null) {</span>
            try {
<span class="nc" id="L230">                tool = new DBTool(config);</span>
<span class="nc" id="L231">            } catch (Exception exception) {</span>
<span class="nc" id="L232">                _log.error(exception, exception);</span>
<span class="nc" id="L233">                System.exit(1);</span>
<span class="nc" id="L234">            }</span>
        } else {
<span class="nc" id="L236">            usage();</span>
<span class="nc" id="L237">            System.exit(1);</span>
        }
<span class="nc" id="L239">        boolean create = commands.exists(&quot;create&quot;);</span>
<span class="nc" id="L240">        boolean drop = commands.exists(&quot;drop&quot;);</span>
<span class="nc" id="L241">        boolean recreate = commands.exists(&quot;recreate&quot;);</span>
<span class="nc" id="L242">        boolean delete = commands.exists(&quot;delete&quot;);</span>
<span class="nc" id="L243">        boolean migrate = commands.exists(&quot;migrate&quot;);</span>
<span class="nc" id="L244">        String schema = commands.value(&quot;schema&quot;);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (create) {</span>
            try {
<span class="nc bnc" id="L247" title="All 2 branches missed.">                if (schema != null) {</span>
<span class="nc" id="L248">                    tool.create(schema);</span>
                } else {
<span class="nc" id="L250">                    tool.create();</span>
                }
<span class="nc" id="L252">                System.out.println(&quot;Successfully created tables&quot;);</span>
<span class="nc" id="L253">            } catch (Exception exception) {</span>
<span class="nc" id="L254">                _log.error(exception, exception);</span>
<span class="nc" id="L255">                System.exit(1);</span>
<span class="nc" id="L256">            }</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        } else if (drop) {</span>
            try {
<span class="nc bnc" id="L259" title="All 2 branches missed.">                if (schema != null) {</span>
<span class="nc" id="L260">                    tool.drop(schema);</span>
                } else {
<span class="nc" id="L262">                    tool.drop();</span>
                }
<span class="nc" id="L264">                System.out.println(&quot;Successfully dropped tables&quot;);</span>
<span class="nc" id="L265">            } catch (Exception exception) {</span>
<span class="nc" id="L266">                _log.error(exception, exception);</span>
<span class="nc" id="L267">                System.exit(1);</span>
<span class="nc" id="L268">            }</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        } else if (recreate) {</span>
            try {
<span class="nc bnc" id="L271" title="All 2 branches missed.">                if (schema != null) {</span>
<span class="nc" id="L272">                    tool.drop(schema);</span>
<span class="nc" id="L273">                    tool.create(schema);</span>
                } else {
<span class="nc" id="L275">                    tool.drop();</span>
<span class="nc" id="L276">                    tool.create();</span>
                }
<span class="nc" id="L278">                System.out.println(&quot;Successfully recreated tables&quot;);</span>
<span class="nc" id="L279">            } catch (Exception exception) {</span>
<span class="nc" id="L280">                _log.error(exception, exception);</span>
<span class="nc" id="L281">                System.exit(1);</span>
<span class="nc" id="L282">            }</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        } else if (delete) {</span>
            try {
<span class="nc" id="L285">                tool.delete();</span>
<span class="nc" id="L286">            } catch (Exception exception) {</span>
<span class="nc" id="L287">                _log.error(exception, exception);</span>
<span class="nc" id="L288">                System.exit(1);</span>
<span class="nc" id="L289">            }</span>
<span class="nc" id="L290">            System.out.println(&quot;Sucessfully deleted data&quot;);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        } else if (migrate) {</span>
            try {
<span class="nc" id="L293">                tool.migrate();</span>
<span class="nc" id="L294">            } catch (Exception exception) {</span>
<span class="nc" id="L295">                _log.error(exception, exception);</span>
<span class="nc" id="L296">                System.exit(1);</span>
<span class="nc" id="L297">            }</span>
<span class="nc" id="L298">            System.out.println(&quot;Sucessfully migrated database&quot;);</span>
        } else {
<span class="nc" id="L300">            usage();</span>
<span class="nc" id="L301">            System.exit(1);</span>
        }
        try {
<span class="nc" id="L304">            tool.close();</span>
<span class="nc" id="L305">        } catch (Exception exception) {</span>
<span class="nc" id="L306">            _log.error(exception, exception);</span>
<span class="nc" id="L307">        }</span>
<span class="nc" id="L308">    }</span>

    /**
     * Initialise this.
     *
     * @param config the configuration to use
     * @throws PersistenceException for any error
     */
    private void init(Configuration config) throws PersistenceException {
<span class="nc" id="L317">        RdbmsDatabaseConfiguration rdbms =</span>
<span class="nc" id="L318">                config.getDatabaseConfiguration()</span>
<span class="nc" id="L319">                .getRdbmsDatabaseConfiguration();</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">        if (rdbms == null) {</span>
<span class="nc" id="L321">            throw new PersistenceException(</span>
                    &quot;Configuration not configured to use an RDBMS&quot;);
        }
<span class="nc" id="L324">        _connections = new DBCPConnectionManager();</span>
<span class="nc" id="L325">        _connections.setDriver(rdbms.getDriver());</span>
<span class="nc" id="L326">        _connections.setURL(rdbms.getUrl());</span>
<span class="nc" id="L327">        _connections.setUser(rdbms.getUser());</span>
<span class="nc" id="L328">        _connections.setPassword(rdbms.getPassword());</span>
<span class="nc" id="L329">        _connections.init();</span>
<span class="nc" id="L330">        _tool = new RDBMSTool(_connections.getConnection());</span>
<span class="nc" id="L331">    }</span>


    /**
     * Displays usage information for this tool when invoked from the command
     * line.
     */
    private static void usage() {
<span class="nc" id="L339">        System.err.println(</span>
<span class="nc" id="L340">                &quot;usage: &quot; + DBTool.class.getName()</span>
                + &quot; &lt;arguments&gt; [options]\n&quot;
                + &quot;arguments:\n&quot;
                + &quot;  -create -config &lt;path&gt;   creates the database tables\n&quot;
                + &quot;  -drop -config &lt;path&gt;     drops the database tables\n&quot;
                + &quot;  -recreate -config &lt;path&gt; recreates the database tables\n&quot;
                + &quot;  -delete -config &lt;path&gt;   deletes all data, leaving tables&quot;
                + &quot;\n&quot;
                + &quot;  -migrate -config &lt;path&gt;  migrates the database to the &quot;
                + &quot;latest schema version\n\n&quot;
                + &quot;options:\n&quot;
                + &quot;  -schema &lt;schema&gt;\n&quot;);
<span class="nc" id="L352">        System.err.println(</span>
                &quot;where:\n&quot;
                + &quot;  path      is the path to an OpenJMS configuration file\n&quot;
                + &quot;  schema    is an XML document specifying the database &quot;
                + &quot;schema\n&quot;
                + &quot;            If not specified, the default schema will be &quot;
                + &quot;used&quot;);
<span class="nc" id="L359">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>