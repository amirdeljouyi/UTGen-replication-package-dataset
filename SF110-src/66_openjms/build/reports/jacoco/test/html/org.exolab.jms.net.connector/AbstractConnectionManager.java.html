<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractConnectionManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">66_openjms</a> &gt; <a href="index.source.html" class="el_package">org.exolab.jms.net.connector</a> &gt; <span class="el_source">AbstractConnectionManager.java</span></div><h1>AbstractConnectionManager.java</h1><pre class="source lang-java linenums">/**
 * Redistribution and use of this software and associated documentation
 * (&quot;Software&quot;), with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * 1. Redistributions of source code must retain copyright
 *    statements and notices.  Redistributions must also contain a
 *    copy of this document.
 *
 * 2. Redistributions in binary form must reproduce the
 *    above copyright notice, this list of conditions and the
 *    following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * 3. The name &quot;Exolab&quot; must not be used to endorse or promote
 *    products derived from this Software without prior written
 *    permission of Exoffice Technologies.  For written permission,
 *    please contact info@exolab.org.
 *
 * 4. Products derived from this Software may not be called &quot;Exolab&quot;
 *    nor may &quot;Exolab&quot; appear in their names without prior written
 *    permission of Exoffice Technologies. Exolab is a registered
 *    trademark of Exoffice Technologies.
 *
 * 5. Due credit should be given to the Exolab Project
 *    (http://www.exolab.org/).
 *
 * THIS SOFTWARE IS PROVIDED BY EXOFFICE TECHNOLOGIES AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
 * NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
 * EXOFFICE TECHNOLOGIES OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Copyright 2003-2005 (C) Exoffice Technologies Inc. All Rights Reserved.
 *
 * $Id: AbstractConnectionManager.java,v 1.6 2005/06/04 14:43:59 tanderson Exp $
 */
package org.exolab.jms.net.connector;

import java.security.Principal;
import java.util.Collection;
import java.util.HashMap;
import java.util.Map;
import java.util.Iterator;

import org.exolab.jms.net.uri.URI;


/**
 * Abstract implementation of the {@link ConnectionManager} interface.
 *
 * @author &lt;a href=&quot;mailto:tma@netspace.net.au&quot;&gt;Tim Anderson&lt;/a&gt;
 * @version $Revision: 1.6 $ $Date: 2005/06/04 14:43:59 $
 * @todo - code smell - implements ConnectionFactory
 */
public abstract class AbstractConnectionManager
        implements ConnectionManager, ConnectionFactory {

    /**
     * The set of managed connection factories, and their corresponding
     * ConnectionPools.
     */
<span class="nc" id="L70">    private final Map _factories = new HashMap();</span>

    /**
     * The invocation handler.
     */
    private final InvocationHandler _handler;

    /**
     * The connection authenticator.
     */
    private final Authenticator _authenticator;

    /**
     * The set of known connection factories, and their associated
     * ManagedConnectionFactorys.
     */
<span class="nc" id="L86">    private final Map _connectionFactories = new HashMap();</span>
    
    /**
     * Configuration properties. May be &lt;code&gt;null&lt;/code&gt;.
     */
    private final Map _properties;

    /**
     * The caller event listener.
     */
    private CallerListener _listener;


    /**
     * Construct a new &lt;code&gt;AbstractConnectionManager&lt;/code&gt;.
     *
     * @param handler       the invocation handler
     * @param authenticator the connection authenticator
     * @param properties    configuration properties. May be &lt;code&gt;null&lt;/code&gt;
     */
    public AbstractConnectionManager(InvocationHandler handler,
                                     Authenticator authenticator,
<span class="nc" id="L108">                                     Map properties) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (handler == null) {</span>
<span class="nc" id="L110">            throw new IllegalArgumentException(&quot;Argument 'handler' is null&quot;);</span>
        }
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (authenticator == null) {</span>
<span class="nc" id="L113">            throw new IllegalArgumentException(</span>
                    &quot;Argument 'authenticator' is null&quot;);
        }
<span class="nc" id="L116">        _handler = handler;</span>
<span class="nc" id="L117">        _authenticator = authenticator;</span>
<span class="nc" id="L118">        _properties = properties;</span>
<span class="nc" id="L119">    }</span>

    /**
     * Allocate a new connection.
     *
     * @param factory   used by application server to delegate connection
     *                  matching/creation
     * @param principal the security principal
     * @param info      the connection request info
     * @return the new connection
     * @throws ResourceException if the connection cannot be allocated
     */
    public Connection allocateConnection(ManagedConnectionFactory factory,
                                         Principal principal,
                                         ConnectionRequestInfo info)
            throws ResourceException {

<span class="nc" id="L136">        ConnectionPool pool = getConnectionPool(factory);</span>
<span class="nc" id="L137">        ManagedConnection connection = pool.matchManagedConnections(principal,</span>
                                                                    info);
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (connection == null) {</span>
<span class="nc" id="L140">            connection = pool.createManagedConnection(principal, info);</span>
        }
<span class="nc" id="L142">        return connection.getConnection();</span>
    }

    /**
     * Start accepting connections.
     *
     * @param factory used to delegate acceptor matching/creation
     * @param info    connection request info
     * @throws ResourceException if the connections cannot be accepted
     */
    public void accept(ManagedConnectionFactory factory,
                       ConnectionRequestInfo info) throws ResourceException {
<span class="nc" id="L154">        ConnectionPool pool = getConnectionPool(factory);</span>
<span class="nc" id="L155">        ManagedConnectionAcceptor acceptor =</span>
<span class="nc" id="L156">                pool.matchManagedConnectionAcceptors(info);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (acceptor == null) {</span>
<span class="nc" id="L158">            acceptor = pool.createManagedConnectionAcceptor(_authenticator,</span>
                                                            info);
<span class="nc" id="L160">            acceptor.accept(pool.getManagedConnectionAcceptorListener());</span>
        }
<span class="nc" id="L162">    }</span>

    /**
     * Determines if this factory supports connections to the specified URI.
     *
     * @param uri the connection address
     * @return &lt;code&gt;true&lt;/code&gt; if this factory supports the URI;
     *         &lt;code&gt;false&lt;/code&gt; otherwise
     */
    public boolean canConnect(URI uri) {
<span class="nc" id="L172">        ConnectionFactory factory = getFactoryForConnect(uri);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        return (factory != null);</span>
    }

    /**
     * Returns a connection to the specified URI, using the default connection
     * properties.
     *
     * @param principal the security principal. May be &lt;code&gt;null&lt;/code&gt;
     * @param uri       the connection address
     * @return a connection to &lt;code&gt;uri&lt;/code&gt;
     * @throws ResourceException if a connection cannot be established
     */
    public Connection getConnection(Principal principal, URI uri)
            throws ResourceException {
<span class="nc" id="L187">        return getConnection(principal, uri, null);</span>
    }

    /**
     * Returns a connection to the specified URI, using the specified connection
     * properties.
     *
     * @param principal  the security principal. May be &lt;code&gt;null&lt;/code&gt;
     * @param uri        the connection address
     * @param properties connection properties. If &lt;code&gt;null&lt;/code&gt;, use the
     *                   default connection properties
     * @return a connection to &lt;code&gt;uri&lt;/code&gt;
     * @throws ResourceException if a connection cannot be established
     */
    public Connection getConnection(Principal principal, URI uri,
                                    Map properties)
            throws ResourceException {
<span class="nc" id="L204">        ConnectionFactory factory = getFactoryForConnect(uri);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (factory == null) {</span>
<span class="nc" id="L206">            throw new ResourceException(&quot;No connector for URI=&quot; + uri);</span>
        }
<span class="nc" id="L208">        return factory.getConnection(principal, uri, properties);</span>
    }

    /**
     * Determines if this factory supports listening for new connections on the
     * specified URI.
     *
     * @param uri the connection address
     * @return &lt;code&gt;true&lt;/code&gt; if this factory supports the URI;
     *         &lt;code&gt;false&lt;/code&gt; otherwise
     */
    public boolean canAccept(URI uri) {
<span class="nc" id="L220">        ConnectionFactory factory = getFactoryForAccept(uri);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">        return (factory != null);</span>
    }

    /**
     * Listen for new connections on the specified URI, using the default
     * connection acceptor properties.
     *
     * @param uri the connection address
     * @throws ResourceException if connections can't be accepted on the
     *                           specified URI
     */
    public void accept(URI uri) throws ResourceException {
<span class="nc" id="L233">        accept(uri, null);</span>
<span class="nc" id="L234">    }</span>

    /**
     * Listen for new connections on the specified URI, using the specified
     * acceptor properties.
     *
     * @param uri        the connection address
     * @param properties acceptor properties. May be &lt;code&gt;null&lt;/code&gt;
     * @throws ResourceException if connections can't be accepted on the
     *                           specified URI
     */
    public void accept(URI uri, Map properties)
            throws ResourceException {
<span class="nc" id="L247">        ConnectionFactory factory = getFactoryForAccept(uri);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (factory == null) {</span>
<span class="nc" id="L249">            throw new ResourceException(&quot;No connector for URI=&quot; + uri);</span>
        }
<span class="nc" id="L251">        factory.accept(uri, properties);</span>
<span class="nc" id="L252">    }</span>

    /**
     * Sets the caller event listener.
     *
     * @param listener the listener
     */
    public synchronized void setCallerListener(CallerListener listener) {
<span class="nc" id="L260">        _listener = listener;</span>
<span class="nc" id="L261">        Iterator iterator = _factories.values().iterator();</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L263">            ConnectionPool pool = (ConnectionPool) iterator.next();</span>
<span class="nc" id="L264">            pool.setCallerListener(_listener);</span>
<span class="nc" id="L265">        }</span>
<span class="nc" id="L266">    }</span>

    /**
     * Close this connection manager.
     *
     * @throws ResourceException if a connection pool cannot be closed
     */
    public synchronized void close() throws ResourceException {
<span class="nc" id="L274">        Iterator iterator = _factories.values().iterator();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L276">            ConnectionPool pool = (ConnectionPool) iterator.next();</span>
<span class="nc" id="L277">            pool.close();</span>
<span class="nc" id="L278">        }</span>
<span class="nc" id="L279">        _factories.clear();</span>
<span class="nc" id="L280">    }</span>

    /**
     * Returns the first factory which can support connections to the specified
     * URI.
     *
     * @param uri the URI
     * @return the first factory which can support connections to
     *         &lt;code&gt;uri&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt; if none support it
     */
    protected synchronized ConnectionFactory getFactoryForConnect(URI uri) {
<span class="nc" id="L291">        ConnectionFactory result = null;</span>
<span class="nc" id="L292">        Iterator iterator = _connectionFactories.keySet().iterator();</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L294">            ConnectionFactory factory = (ConnectionFactory) iterator.next();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (factory.canConnect(uri)) {</span>
<span class="nc" id="L296">                result = factory;</span>
<span class="nc" id="L297">                break;</span>
            }
<span class="nc" id="L299">        }</span>
<span class="nc" id="L300">        return result;</span>
    }

    /**
     * Returns the first factory which can accept connections on the specified
     * URI.
     *
     * @param uri the URI
     * @return the first factory which can accept connections on
     *         &lt;code&gt;uri&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt; if none support it
     */
    protected synchronized ConnectionFactory getFactoryForAccept(URI uri) {
<span class="nc" id="L312">        ConnectionFactory result = null;</span>
<span class="nc" id="L313">        Iterator iterator = _connectionFactories.keySet().iterator();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L315">            ConnectionFactory factory = (ConnectionFactory) iterator.next();</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (factory.canAccept(uri)) {</span>
<span class="nc" id="L317">                result = factory;</span>
<span class="nc" id="L318">                break;</span>
            }
<span class="nc" id="L320">        }</span>
<span class="nc" id="L321">        return result;</span>
    }

    /**
     * Register a managed connection factory.
     *
     * @param factory the factory to register
     * @throws ResourceException if the registration fails
     */
    protected synchronized void addManagedConnectionFactory(
            ManagedConnectionFactory factory) throws ResourceException {
<span class="nc" id="L332">        ConnectionPool pool = createConnectionPool(factory, _handler, this);</span>
<span class="nc" id="L333">        pool.setCallerListener(_listener);</span>
<span class="nc" id="L334">        _factories.put(factory, pool);</span>
<span class="nc" id="L335">        _connectionFactories.put(factory.createConnectionFactory(this),</span>
                                 factory);
<span class="nc" id="L337">    }</span>

    /**
     * Returns all registered managed connection factories.
     *
     * @return all registered managed connection factories
     */
    protected synchronized Collection getManagedConnectionFactories() {
<span class="nc" id="L345">        return _factories.keySet();</span>
    }
    
    /**
     * Creates a new connection pool.
     * 
     * @param factory  the managed connection factory
     * @param handler  the invocation handler, assigned to each new managed
     *                 connection
     * @param resolver the connection factory for resolving connections via
     *                 their URI
     * @throws ResourceException if the pool can't be created
     */
    protected ConnectionPool createConnectionPool(
            ManagedConnectionFactory factory, InvocationHandler handler,
            ConnectionFactory resolver) throws ResourceException {
<span class="nc" id="L361">        return new DefaultConnectionPool(factory, handler, resolver, </span>
                                         _properties);
    }

    /**
     * Returns the {@link ConnectionPool} which pools connections for the
     * specified factory.
     *
     * @param factory the factory to locate the pool for
     * @return the connection pool for &lt;code&gt;factory&lt;/code&gt;
     * @throws ResourceException if no connection pool exists
     */
    protected synchronized ConnectionPool getConnectionPool(
            ManagedConnectionFactory factory) throws ResourceException {
<span class="nc" id="L375">        ConnectionPool pool = (ConnectionPool) _factories.get(factory);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">        if (pool == null) {</span>
<span class="nc" id="L377">            throw new ResourceException(&quot;Connection pool not found&quot;);</span>
        }
<span class="nc" id="L379">        return pool;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>