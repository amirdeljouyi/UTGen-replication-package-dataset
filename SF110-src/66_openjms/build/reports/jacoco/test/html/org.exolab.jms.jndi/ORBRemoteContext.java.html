<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ORBRemoteContext.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">66_openjms</a> &gt; <a href="index.source.html" class="el_package">org.exolab.jms.jndi</a> &gt; <span class="el_source">ORBRemoteContext.java</span></div><h1>ORBRemoteContext.java</h1><pre class="source lang-java linenums">/**
 * Redistribution and use of this software and associated documentation
 * (&quot;Software&quot;), with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * 1. Redistributions of source code must retain copyright
 *    statements and notices.  Redistributions must also contain a
 *    copy of this document.
 *
 * 2. Redistributions in binary form must reproduce the
 *    above copyright notice, this list of conditions and the
 *    following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * 3. The name &quot;Exolab&quot; must not be used to endorse or promote
 *    products derived from this Software without prior written
 *    permission of Exoffice Technologies.  For written permission,
 *    please contact info@exolab.org.
 *
 * 4. Products derived from this Software may not be called &quot;Exolab&quot;
 *    nor may &quot;Exolab&quot; appear in their names without prior written
 *    permission of Exoffice Technologies. Exolab is a registered
 *    trademark of Exoffice Technologies.
 *
 * 5. Due credit should be given to the Exolab Project
 *    (http://www.exolab.org/).
 *
 * THIS SOFTWARE IS PROVIDED BY EXOFFICE TECHNOLOGIES AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
 * NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
 * EXOFFICE TECHNOLOGIES OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Copyright 2005 (C) Exoffice Technologies Inc. All Rights Reserved.
 *
 * $Id: ORBRemoteContext.java,v 1.1 2005/11/18 03:29:41 tanderson Exp $
 */
package org.exolab.jms.jndi;

import java.util.Hashtable;
import java.util.NoSuchElementException;
import javax.naming.Binding;
import javax.naming.Context;
import javax.naming.Name;
import javax.naming.NameParser;
import javax.naming.NamingEnumeration;
import javax.naming.NamingException;

import org.codehaus.spice.jndikit.RemoteContext;
import org.exolab.jms.net.proxy.Proxy;


/**
 * &lt;code&gt;Context&lt;/code&gt; implementation that reference counts the
 * underlying provider.
 *
 * @author &lt;a href=&quot;mailto:tma@netspace.net.au&quot;&gt;Tim Anderson&lt;/a&gt;
 * @version $Revision: 1.1 $ $Date: 2005/11/18 03:29:41 $
 */
class ORBRemoteContext implements Context {

    /**
     * Environment key for the naming provider reference counter.
     */
<span class="nc" id="L72">    private static String REFERENCE_KEY = &quot;NamingProviderReferenceCounter&quot;;</span>

    /**
     * The context.
     */
    private RemoteContext _context;


    /**
     * Construct a new &lt;code&gt;ORBRemoteContext&lt;/code&gt;.
     *
     * @param context the context to delegate requests to
     * @throws NamingException for any error
     */
<span class="nc" id="L86">    public ORBRemoteContext(RemoteContext context) throws NamingException {</span>
<span class="nc" id="L87">        _context = context;</span>
<span class="nc" id="L88">        reference();</span>
<span class="nc" id="L89">    }</span>

    /**
     * Retrieves the named object.
     *
     * @param name the name of the object to look up
     * @return	the object bound to &lt;tt&gt;name&lt;/tt&gt;
     * @throws	NamingException if a naming exception is encountered
     */
    public Object lookup(Name name) throws NamingException {
<span class="nc" id="L99">        return wrap(_context.lookup(name));</span>
    }

    /**
     * Retrieves the named object.
     *
     * @param name the name of the object to look up
     * @return	the object bound to &lt;tt&gt;name&lt;/tt&gt;
     * @throws	NamingException if a naming exception is encountered
     */
    public Object lookup(String name) throws NamingException {
<span class="nc" id="L110">        return wrap(_context.lookup(name));</span>
    }

    /**
     * Binds a name to an object.
     *
     * @param name the name to bind; may not be empty
     * @param obj  the object to bind; possibly null
     * @throws	NamingException if a naming exception is encountered
     */
    public void bind(Name name, Object obj) throws NamingException {
<span class="nc" id="L121">        _context.bind(name, obj);</span>
<span class="nc" id="L122">    }</span>

    /**
     * Binds a name to an object.
     *
     * @param name the name to bind; may not be empty
     * @param obj  the object to bind; possibly null
     * @throws	NamingException if a naming exception is encountered
     */
    public void bind(String name, Object obj) throws NamingException {
<span class="nc" id="L132">        _context.bind(name, obj);</span>
<span class="nc" id="L133">    }</span>

    /**
     * Binds a name to an object, overwriting any existing binding.
     *
     * @param name the name to bind; may not be empty
     * @param obj  the object to bind; possibly null
     * @throws	NamingException if a naming exception is encountered
     */
    public void rebind(Name name, Object obj) throws NamingException {
<span class="nc" id="L143">        _context.rebind(name, obj);</span>
<span class="nc" id="L144">    }</span>

    /**
     * Binds a name to an object, overwriting any existing binding.
     *
     * @param name the name to bind; may not be empty
     * @param obj  the object to bind; possibly null
     * @throws	NamingException if a naming exception is encountered
     */
    public void rebind(String name, Object obj) throws NamingException {
<span class="nc" id="L154">        _context.rebind(name, obj);</span>
<span class="nc" id="L155">    }</span>

    /**
     * Unbinds the named object.
     *
     * @param name the name to unbind; may not be empty
     * @throws	NamingException if a naming exception is encountered
     */
    public void unbind(Name name) throws NamingException {
<span class="nc" id="L164">        _context.unbind(name);</span>
<span class="nc" id="L165">    }</span>

    /**
     * Unbinds the named object.
     *
     * @param name the name to unbind; may not be empty
     * @throws	NamingException if a naming exception is encountered
     */
    public void unbind(String name) throws NamingException {
<span class="nc" id="L174">        _context.unbind(name);</span>
<span class="nc" id="L175">    }</span>

    /**
     * Binds a new name to the object bound to an old name, and unbinds
     * the old name.
     *
     * @param oldName the name of the existing binding; may not be empty
     * @param newName the name of the new binding; may not be empty
     * @throws	NamingException if a naming exception is encountered
     */
    public void rename(Name oldName, Name newName) throws NamingException {
<span class="nc" id="L186">        _context.rename(oldName, newName);</span>
<span class="nc" id="L187">    }</span>

    /**
     * Binds a new name to the object bound to an old name, and unbinds
     * the old name.
     *
     * @param oldName the name of the existing binding; may not be empty
     * @param newName the name of the new binding; may not be empty
     * @throws	NamingException if a naming exception is encountered
     */
    public void rename(String oldName, String newName) throws NamingException {
<span class="nc" id="L198">        _context.rename(oldName, newName);</span>
<span class="nc" id="L199">    }</span>

    /**
     * Enumerates the names bound in the named context, along with the
     * class names of objects bound to them.
     *
     * @param name the name of the context to list
     * @return	an enumeration of the names and class names of the
     * bindings in this context.  Each element of the
     * enumeration is of type &lt;tt&gt;NameClassPair&lt;/tt&gt;.
     * @throws	NamingException if a naming exception is encountered
     */
    public NamingEnumeration list(Name name) throws NamingException {
<span class="nc" id="L212">        return _context.list(name);</span>
    }

    /**
     * Enumerates the names bound in the named context, along with the
     * class names of objects bound to them.
     *
     * @param name the name of the context to list
     * @return	an enumeration of the names and class names of the
     * bindings in this context.  Each element of the
     * enumeration is of type &lt;tt&gt;NameClassPair&lt;/tt&gt;.
     * @throws	NamingException if a naming exception is encountered
     */
    public NamingEnumeration list(String name) throws NamingException {
<span class="nc" id="L226">        return _context.list(name);</span>
    }

    /**
     * Enumerates the names bound in the named context, along with the
     * objects bound to them.
     *
     * @param name the name of the context to list
     * @return	an enumeration of the bindings in this context.
     * Each element of the enumeration is of type
     * &lt;tt&gt;Binding&lt;/tt&gt;.
     * @throws	NamingException if a naming exception is encountered
     */
    public NamingEnumeration listBindings(Name name) throws NamingException {
<span class="nc" id="L240">        return new ORBNamingEnumeration(_context.listBindings(name));</span>
    }

    /**
     * Enumerates the names bound in the named context, along with the
     * objects bound to them.
     *
     * @param name the name of the context to list
     * @return	an enumeration of the bindings in this context.
     * Each element of the enumeration is of type
     * &lt;tt&gt;Binding&lt;/tt&gt;.
     * @throws	NamingException if a naming exception is encountered
     */
    public NamingEnumeration listBindings(String name) throws NamingException {
<span class="nc" id="L254">        return _context.listBindings(name);</span>
    }

    /**
     * Destroys the named context and removes it from the namespace.
     *
     * @param name the name of the context to be destroyed; may not be empty
     * @throws	NamingException if a naming exception is encountered
     */
    public void destroySubcontext(Name name) throws NamingException {
<span class="nc" id="L264">        _context.destroySubcontext(name);</span>
<span class="nc" id="L265">    }</span>

    /**
     * Destroys the named context and removes it from the namespace.
     *
     * @param name the name of the context to be destroyed; may not be empty
     * @throws	NamingException if a naming exception is encountered
     */
    public void destroySubcontext(String name) throws NamingException {
<span class="nc" id="L274">        _context.destroySubcontext(name);</span>
<span class="nc" id="L275">    }</span>

    /**
     * Creates and binds a new context.
     *
     * @param name the name of the context to create; may not be empty
     * @return	the newly created context
     * @throws	NamingException if a naming exception is encountered
     */
    public Context createSubcontext(Name name) throws NamingException {
<span class="nc" id="L285">        return (Context) wrap(_context.createSubcontext(name));</span>
    }

    /**
     * Creates and binds a new context.
     *
     * @param name the name of the context to create; may not be empty
     * @return	the newly created context
     * @throws	NamingException if a naming exception is encountered
     */
    public Context createSubcontext(String name) throws NamingException {
<span class="nc" id="L296">        return (Context) wrap(_context.createSubcontext(name));</span>
    }

    /**
     * Retrieves the named object, following links except
     * for the terminal atomic component of the name.
     *
     * @param name the name of the object to look up
     * @return	the object bound to &lt;tt&gt;name&lt;/tt&gt;, not following the
     * terminal link (if any).
     * @throws	NamingException if a naming exception is encountered
     */
    public Object lookupLink(Name name) throws NamingException {
<span class="nc" id="L309">        return wrap(_context.lookupLink(name));</span>
    }

    /**
     * Retrieves the named object, following links except
     * for the terminal atomic component of the name.
     *
     * @param name the name of the object to look up
     * @return	the object bound to &lt;tt&gt;name&lt;/tt&gt;, not following the
     * terminal link (if any)
     * @throws	NamingException if a naming exception is encountered
     */
    public Object lookupLink(String name) throws NamingException {
<span class="nc" id="L322">        return wrap(_context.lookupLink(name));</span>
    }

    /**
     * Retrieves the parser associated with the named context.
     *
     * @param name the name of the context from which to get the parser
     * @return	a name parser that can parse compound names into their atomic
     * components
     * @throws	NamingException if a naming exception is encountered
     */
    public NameParser getNameParser(Name name) throws NamingException {
<span class="nc" id="L334">        return _context.getNameParser(name);</span>
    }

    /**
     * Retrieves the parser associated with the named context.
     *
     * @param name the name of the context from which to get the parser
     * @return	a name parser that can parse compound names into their atomic
     * components
     * @throws	NamingException if a naming exception is encountered
     */
    public NameParser getNameParser(String name) throws NamingException {
<span class="nc" id="L346">        return _context.getNameParser(name);</span>
    }

    /**
     * Composes the name of this context with a name relative to
     * this context.
     *
     * @param name   a name relative to this context
     * @param prefix the name of this context relative to one of its ancestors
     * @return	the composition of &lt;code&gt;prefix&lt;/code&gt; and &lt;code&gt;name&lt;/code&gt;
     * @throws	NamingException if a naming exception is encountered
     */
    public Name composeName(Name name, Name prefix) throws NamingException {
<span class="nc" id="L359">        return _context.composeName(name, prefix);</span>
    }

    /**
     * Composes the name of this context with a name relative to
     * this context.
     *
     * @param name   a name relative to this context
     * @param prefix the name of this context relative to one of its ancestors
     * @return	the composition of &lt;code&gt;prefix&lt;/code&gt; and &lt;code&gt;name&lt;/code&gt;
     * @throws	NamingException if a naming exception is encountered
     */
    public String composeName(String name, String prefix)
            throws NamingException {
<span class="nc" id="L373">        return _context.composeName(name, prefix);</span>
    }

    /**
     * Adds a new environment property to the environment of this
     * context.  If the property already exists, its value is overwritten.
     *
     * @param propName the name of the environment property to add; may not be null
     * @param propVal  the value of the property to add; may not be null
     * @return	the previous value of the property, or null if the property was
     * not in the environment before
     * @throws	NamingException if a naming exception is encountered
     */
    public Object addToEnvironment(String propName, Object propVal)
            throws NamingException {
<span class="nc" id="L388">        return _context.addToEnvironment(propName, propVal);</span>
    }

    /**
     * Removes an environment property from the environment of this
     * context.  See class description for more details on environment
     * properties.
     *
     * @param propName the name of the environment property to remove; may not be null
     * @return	the previous value of the property, or null if the property was
     * not in the environment
     * @throws	NamingException if a naming exception is encountered
     */
    public Object removeFromEnvironment(String propName)
            throws NamingException {
<span class="nc" id="L403">        return _context.removeFromEnvironment(propName);</span>
    }

    /**
     * Retrieves the environment in effect for this context.
     *
     * @return	the environment of this context; never null
     * @throws	NamingException if a naming exception is encountered
     */
    public Hashtable getEnvironment() throws NamingException {
<span class="nc" id="L413">        return _context.getEnvironment();</span>
    }

    /**
     * Closes this context.
     *
     * @throws	NamingException if a naming exception is encountered
     */
    public void close() throws NamingException {
<span class="nc bnc" id="L422" title="All 2 branches missed.">        if (_context != null) {</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">            if (dereference() &lt;= 0) {</span>
<span class="nc" id="L424">                Object provider = getEnvironment().get(</span>
                        RemoteContext.NAMING_PROVIDER);
<span class="nc bnc" id="L426" title="All 2 branches missed.">                if (provider instanceof Proxy) {</span>
<span class="nc" id="L427">                    ((Proxy) provider).disposeProxy();</span>
                }
            }
<span class="nc" id="L430">            _context.close();</span>
<span class="nc" id="L431">            _context = null;</span>
        }
<span class="nc" id="L433">    }</span>

    /**
     * Retrieves the full name of this context within its own namespace.
     *
     * @return	this context's name in its own namespace; never null
     * @throws	NamingException if a naming exception is encountered
     */
    public String getNameInNamespace() throws NamingException {
<span class="nc" id="L442">        return _context.getNameInNamespace();</span>
    }

    /**
     * Called by the garbage collector on an object when garbage collection
     * determines that there are no more references to the object.
     *
     * @throws Throwable the &lt;code&gt;Exception&lt;/code&gt; raised by this method
     */
    protected void finalize() throws Throwable {
<span class="nc" id="L452">        close();</span>
<span class="nc" id="L453">    }</span>

    /**
     * Wrap the supplied object in an &lt;code&gt;ORBRemoteContext&lt;/code&gt; iff it
     * is an instance of &lt;code&gt;RemoteContext&lt;/code&gt;, otherwise returns the
     * object unchanged.
     *
     * @param object the object to wrap
     * @return the supplied object in an &lt;code&gt;ORBRemoteContext&lt;/code&gt; iff it
     * is an instance of &lt;code&gt;RemoteContext&lt;/code&gt;, otherwise returns the
     * object unchanged.
     * @throws NamingException if a naming exception is encountered
     */
    private Object wrap(Object object) throws NamingException {
<span class="nc bnc" id="L467" title="All 2 branches missed.">        if (object instanceof RemoteContext) {</span>
<span class="nc" id="L468">            return new ORBRemoteContext((RemoteContext) object);</span>
        }
<span class="nc" id="L470">        return object;</span>
    }

    /**
     * Increment the reference count of the provider. This is the number
     * of &lt;code&gt;Context&lt;/code&gt; instances that refer to it.
     *
     * @throws NamingException for any naming error
     */
    private void reference() throws NamingException {
<span class="nc" id="L480">        Ref ref = (Ref) _context.getEnvironment().get(REFERENCE_KEY);</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (ref == null) {</span>
<span class="nc" id="L482">            ref = new Ref();</span>
<span class="nc" id="L483">            _context.addToEnvironment(REFERENCE_KEY, ref);</span>
        }
<span class="nc" id="L485">        ref.inc();</span>
<span class="nc" id="L486">    }</span>

    /**
     * Dereference the reference count of the provider.
     *
     * @return the number of references
     * @throws NamingException for any naming error
     */
    private int dereference() throws NamingException {
<span class="nc" id="L495">        Ref ref = (Ref) _context.getEnvironment().get(REFERENCE_KEY);</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">        return (ref != null) ? ref.dec() : 0;</span>
    }


    /**
     * Helper to wrap any &lt;code&gt;RemoteContext&lt;/code&gt; instances returned
     * by a &lt;code&gt;NamingEnumeration&lt;/code&gt; in &lt;code&gt;ORBRemoteContext&lt;/code&gt;
     * instances.
     */
    private static class ORBNamingEnumeration implements NamingEnumeration {

        /**
         * The enumeration.
         */
        private final NamingEnumeration _iterator;

        /**
         * Construct a new &lt;code&gt;ORBNamingEnumeration&lt;/code&gt;.
         *
         * @param iterator the enumeration to delegate to
         */
<span class="nc" id="L517">        private ORBNamingEnumeration(NamingEnumeration iterator) {</span>
<span class="nc" id="L518">            _iterator = iterator;</span>
<span class="nc" id="L519">        }</span>

        /**
         * Retrieves the next element in the enumeration.
         *
         * @return the next element in the enumeration.
         * @throws NamingException for any naming error
         * @throws java.util.NoSuchElementException If attempting to get the next element when none is available.
         */
        public Object next() throws NamingException {
<span class="nc" id="L529">            return wrap(_iterator.next());</span>
        }

        /**
         * Determines whether there are any more elements in the enumeration.
         *
         * @throws NamingException for any naming error.
         * @return		true if there is more in the enumeration; false otherwise.
         */
        public boolean hasMore() throws NamingException {
<span class="nc" id="L539">            return _iterator.hasMore();</span>
        }

        /**
         * Closes this enumeration.
         *
         * @throws NamingException for any naming error
         */
        public void close() throws NamingException {
<span class="nc" id="L548">            _iterator.close();</span>
<span class="nc" id="L549">        }</span>

        /**
         * Tests if this enumeration contains more elements.
         *
         * @return &lt;code&gt;true&lt;/code&gt; if and only if this enumeration object
         *         contains at least one more element to provide;
         *         &lt;code&gt;false&lt;/code&gt; otherwise.
         */
        public boolean hasMoreElements() {
<span class="nc" id="L559">            return _iterator.hasMoreElements();</span>
        }

        /**
         * Returns the next element of this enumeration if this enumeration
         * object has at least one more element to provide.
         *
         * @return the next element of this enumeration.
         * @throws java.util.NoSuchElementException if no more elements exist.
         */
        public Object nextElement() {
            try {
<span class="nc" id="L571">                return wrap(_iterator.nextElement());</span>
<span class="nc" id="L572">            } catch (NamingException exception) {</span>
<span class="nc" id="L573">                throw new NoSuchElementException(exception.getMessage());</span>
            }
        }

        /**
         * Wraps any &lt;code&gt;Context&lt;/code&gt; instances in &lt;code&gt;ORBRemoteContext&lt;/code&gt;.
         *
         * @param obj the object
         * @return obj
         * @throws NamingException for any naming error
         */
        private Object wrap(Object obj) throws NamingException {
<span class="nc bnc" id="L585" title="All 2 branches missed.">            if (obj instanceof Binding) {</span>
<span class="nc" id="L586">                Binding binding = (Binding) obj;</span>
<span class="nc" id="L587">                Object bound = binding.getObject();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">                if (bound instanceof RemoteContext) {</span>
<span class="nc" id="L589">                    binding.setObject(</span>
                            new ORBRemoteContext((RemoteContext) bound));
                }
            }
<span class="nc" id="L593">            return obj;</span>
        }
    }

    /**
     * Helper to maintain a reference count.
     */
    private static class Ref {

        /**
         * The reference count.
         */
        private int _count;

        /**
         * Increment the reference count.
         *
         * @return the reference count
         */
        public synchronized int inc() {
<span class="nc" id="L613">            return ++_count;</span>
        }

        /**
         * Decrement the reference count.
         *
         * @return the reference count
         */
        public synchronized int dec() {
<span class="nc" id="L622">            return --_count;</span>
        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>