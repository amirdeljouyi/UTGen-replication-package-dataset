<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JmsServerStubImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">66_openjms</a> &gt; <a href="index.source.html" class="el_package">org.exolab.jms.client.net</a> &gt; <span class="el_source">JmsServerStubImpl.java</span></div><h1>JmsServerStubImpl.java</h1><pre class="source lang-java linenums">/**
 * Redistribution and use of this software and associated documentation
 * (&quot;Software&quot;), with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * 1. Redistributions of source code must retain copyright
 *    statements and notices.  Redistributions must also contain a
 *    copy of this document.
 *
 * 2. Redistributions in binary form must reproduce the
 *    above copyright notice, this list of conditions and the
 *    following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * 3. The name &quot;Exolab&quot; must not be used to endorse or promote
 *    products derived from this Software without prior written
 *    permission of Exoffice Technologies.  For written permission,
 *    please contact info@exolab.org.
 *
 * 4. Products derived from this Software may not be called &quot;Exolab&quot;
 *    nor may &quot;Exolab&quot; appear in their names without prior written
 *    permission of Exoffice Technologies. Exolab is a registered
 *    trademark of Exoffice Technologies.
 *
 * 5. Due credit should be given to the Exolab Project
 *    (http://www.exolab.org/).
 *
 * THIS SOFTWARE IS PROVIDED BY EXOFFICE TECHNOLOGIES AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
 * NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
 * EXOFFICE TECHNOLOGIES OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Copyright 2000-2005 (C) Exoffice Technologies Inc. All Rights Reserved.
 *
 * $Id: JmsServerStubImpl.java,v 1.5 2005/11/18 03:29:41 tanderson Exp $
 */
package org.exolab.jms.client.net;

import java.rmi.AccessException;
import java.rmi.NotBoundException;
import java.rmi.RemoteException;
import java.util.HashMap;
import java.util.Map;
import javax.jms.ExceptionListener;
import javax.jms.InvalidClientIDException;
import javax.jms.JMSException;
import javax.jms.JMSSecurityException;

import org.exolab.jms.client.JmsServerStubIfc;
import org.exolab.jms.net.connector.Caller;
import org.exolab.jms.net.connector.CallerListener;
import org.exolab.jms.net.orb.ORB;
import org.exolab.jms.net.registry.Registry;
import org.exolab.jms.net.proxy.Proxy;
import org.exolab.jms.server.ServerConnection;
import org.exolab.jms.server.ServerConnectionFactory;


/**
 * This class is responsible for returning a reference to the remote JMS
 * server.
 *
 * @author &lt;a href=&quot;mailto:jima@comware.com.au&quot;&gt;Jim Alateras&lt;/a&gt;
 * @author &lt;a href=&quot;mailto:tma@netspace.net.au&quot;&gt;Tim Anderson&lt;/a&gt;
 * @version $Revision: 1.5 $ $Date: 2005/11/18 03:29:41 $
 */
public class JmsServerStubImpl implements JmsServerStubIfc, CallerListener {

    /**
     * The ORB.
     */
    private ORB _orb;

    /**
     * Properties used to establish a connection to the remote server.
     */
    private final Map _properties;

    /**
     * The server URI;
     */
    private final String _serverURI;

    /**
     * Default user to connect to server. May be &lt;code&gt;null&lt;/code&gt;.
     */
    private final String _defaultUser;

    /**
     * Default user's password. May be &lt;code&gt;null&lt;/code&gt;.
     */
    private final String _defaultPassword;

    /**
     * The exception listener, which is shared by all the connections to the
     * server.
     */
<span class="nc" id="L106">    private ExceptionListener _listener = null;</span>


    /**
     * Construct a new &lt;code&gt;JmsServerStubImpl&lt;/code&gt;.
     *
     * @param properties  properties to initialise this with
     * @param environment the environment used. May be &lt;code&gt;null&lt;/code&gt;
     */
<span class="nc" id="L115">    public JmsServerStubImpl(Map properties, Map environment) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (properties == null) {</span>
<span class="nc" id="L117">            throw new IllegalArgumentException(&quot;Argument 'properties' is null&quot;);</span>
        }
<span class="nc" id="L119">        _properties = properties;</span>

<span class="nc" id="L121">        _serverURI = (String) properties.get(ORB.PROVIDER_URI);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (_serverURI == null) {</span>
<span class="nc" id="L123">            throw new IllegalArgumentException(</span>
                    &quot;Argument 'properties' does not contain property &quot;
                    + ORB.PROVIDER_URI);
        }
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (environment != null) {</span>
<span class="nc" id="L128">            _defaultUser = (String) environment.get(ORB.SECURITY_PRINCIPAL);</span>
<span class="nc" id="L129">            _defaultPassword = (String) environment.get(</span>
                    ORB.SECURITY_CREDENTIALS);
        } else {
<span class="nc" id="L132">            _defaultUser = null;</span>
<span class="nc" id="L133">            _defaultPassword = null;</span>
        }
<span class="nc" id="L135">    }</span>

    /**
     * Creates a connection with the specified user identity.
     * &lt;p/&gt;
     * The connection is created in stopped mode. No messages will be delivered
     * until the &lt;code&gt;Connection.start&lt;/code&gt; method is explicitly called.
     * &lt;p/&gt;
     * If &lt;code&gt;clientID&lt;/code&gt; is specified, it indicates the pre-configured
     * client identifier associated with the client
     * &lt;code&gt;ConnectionFactory&lt;/code&gt; object.
     *
     * @param clientID the pre-configured client identifier. May be
     *                 &lt;code&gt;null&lt;/code&gt;.
     * @param user     the caller's user name. May be &lt;code&gt;null&lt;/code&gt;
     * @param password the caller's password. May be &lt;code&gt;null&lt;/code&gt;
     * @return a newly created connection
     * @throws InvalidClientIDException if the JMS client specifies an invalid
     *                                  or duplicate client ID.
     * @throws JMSException             if the JMS provider fails to create the
     *                                  connection due to some internal error.
     * @throws JMSSecurityException     if client authentication fails due to an
     *                                  invalid user name or password.
     */
    public ServerConnection createConnection(String clientID, String user,
                                             String password)
            throws JMSException {
        ServerConnection stub;

<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L165">            user = _defaultUser;</span>
<span class="nc" id="L166">            password = _defaultPassword;</span>
        }

<span class="nc" id="L169">        ServerConnectionFactory factory</span>
<span class="nc" id="L170">                = getServerConnectionFactory(user, password);</span>
        try {
<span class="nc" id="L172">            ServerConnection connection</span>
<span class="nc" id="L173">                    = factory.createConnection(clientID, user, password);</span>
<span class="nc" id="L174">            stub = new JmsConnectionStubImpl(connection, _orb, _serverURI,</span>
                                             user, password);
        } finally {
<span class="nc bnc" id="L177" title="All 2 branches missed.">            if (factory instanceof Proxy) {</span>
<span class="nc" id="L178">                ((Proxy) factory).disposeProxy();</span>
            }
        }
<span class="nc" id="L181">        return stub;</span>
    }

    /**
     * Set the exception listener so that the client can be notified of client
     * disconnection events.
     *
     * @param listener the exception listener
     */
    public void setExceptionListener(ExceptionListener listener) {
<span class="nc" id="L191">        _listener = listener;</span>
<span class="nc" id="L192">    }</span>

    /**
     * Notifies that a caller has been disconnected.
     *
     * @param caller the caller that was disconnected
     */
    public void disconnected(Caller caller) {
<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (_listener != null) {</span>
<span class="nc" id="L201">            _listener.onException(new JMSException(&quot;Lost connection&quot;));</span>
        }
<span class="nc" id="L203">    }</span>

    /**
     * Looks up and returns the {@link ServerConnectionFactory} instance bound
     * in the registry.
     *
     * @param user     the caller's user name. May be &lt;code&gt;null&lt;/code&gt;
     * @param password the caller's password. May be &lt;code&gt;null&lt;/code&gt;
     * @return the bound {@link ServerConnectionFactory}
     * @throws JMSException if lookup fails
     */
    private synchronized ServerConnectionFactory getServerConnectionFactory(
            String user, String password)
            throws JMSException {
<span class="nc" id="L217">        ServerConnectionFactory factory = null;</span>
<span class="nc" id="L218">        Map properties = _properties;</span>

<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (user != null) {</span>
<span class="nc" id="L221">            properties = new HashMap(_properties);</span>
<span class="nc" id="L222">            properties.put(ORB.SECURITY_PRINCIPAL, user);</span>
<span class="nc" id="L223">            properties.put(ORB.SECURITY_CREDENTIALS, password);</span>
        }
<span class="nc" id="L225">        Registry registry = null;</span>
        try {
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (_orb == null) {</span>
<span class="nc" id="L228">                _orb = SharedORB.getInstance();</span>
            }
<span class="nc" id="L230">            registry = _orb.getRegistry(properties);</span>
<span class="nc" id="L231">        } catch (AccessException exception) {</span>
<span class="nc" id="L232">            JMSSecurityException error = new JMSSecurityException(</span>
<span class="nc" id="L233">                    exception.getMessage());</span>
<span class="nc" id="L234">            error.setLinkedException(exception);</span>
<span class="nc" id="L235">            throw error;</span>
<span class="nc" id="L236">        } catch (RemoteException exception) {</span>
<span class="nc" id="L237">            JMSException error = new JMSException(</span>
                    &quot;Failed to get registry service for URL: &quot; + _serverURI);
<span class="nc" id="L239">            error.setLinkedException(exception);</span>
<span class="nc" id="L240">            throw error;</span>
<span class="nc" id="L241">        }</span>

        try {
<span class="nc" id="L244">            factory = (ServerConnectionFactory) registry.lookup(&quot;server&quot;);</span>
<span class="nc" id="L245">        } catch (NotBoundException exception) {</span>
<span class="nc" id="L246">            throw new JMSException(</span>
                    &quot;Server is not bound in the registry for URL: &quot;
                    + _serverURI);
<span class="nc" id="L249">        } catch (RemoteException exception) {</span>
<span class="nc" id="L250">            JMSException error = new JMSException(</span>
                    &quot;Failed to lookup OpenJMS server for URL: &quot; + _serverURI);
<span class="nc" id="L252">            error.setLinkedException(exception);</span>
<span class="nc" id="L253">            throw error;</span>
<span class="nc" id="L254">        }</span>
        try {
<span class="nc" id="L256">            _orb.addCallerListener(_serverURI, this);</span>
<span class="nc" id="L257">        } catch (RemoteException exception) {</span>
<span class="nc" id="L258">            JMSException error = new JMSException(</span>
                    &quot;Failed to register for disconnection notification for &quot;
                    + &quot;URL: &quot; + _serverURI);
<span class="nc" id="L261">            error.setLinkedException(exception);</span>
<span class="nc" id="L262">            throw error;</span>
<span class="nc" id="L263">        }</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (registry instanceof Proxy) {</span>
<span class="nc" id="L266">            ((Proxy) registry).disposeProxy();</span>
        }
<span class="nc" id="L268">        return factory;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>