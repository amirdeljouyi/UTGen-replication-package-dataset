<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JmsServer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">66_openjms</a> &gt; <a href="index.source.html" class="el_package">org.exolab.jms.server</a> &gt; <span class="el_source">JmsServer.java</span></div><h1>JmsServer.java</h1><pre class="source lang-java linenums">/**
 * Redistribution and use of this software and associated documentation
 * (&quot;Software&quot;), with or without modification, are permitted provided
 * that the following conditions are met:
 *
 * 1. Redistributions of source code must retain copyright
 *    statements and notices.  Redistributions must also contain a
 *    copy of this document.
 *
 * 2. Redistributions in binary form must reproduce the
 *    above copyright notice, this list of conditions and the
 *    following disclaimer in the documentation and/or other
 *    materials provided with the distribution.
 *
 * 3. The name &quot;Exolab&quot; must not be used to endorse or promote
 *    products derived from this Software without prior written
 *    permission of Exoffice Technologies.  For written permission,
 *    please contact info@exolab.org.
 *
 * 4. Products derived from this Software may not be called &quot;Exolab&quot;
 *    nor may &quot;Exolab&quot; appear in their names without prior written
 *    permission of Exoffice Technologies. Exolab is a registered
 *    trademark of Exoffice Technologies.
 *
 * 5. Due credit should be given to the Exolab Project
 *    (http://www.exolab.org/).
 *
 * THIS SOFTWARE IS PROVIDED BY EXOFFICE TECHNOLOGIES AND CONTRIBUTORS
 * ``AS IS'' AND ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT
 * NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
 * EXOFFICE TECHNOLOGIES OR ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
 * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * Copyright 2000-2005 (C) Exoffice Technologies Inc. All Rights Reserved.
 *
 * $Id: JmsServer.java,v 1.6 2006/02/23 11:17:40 tanderson Exp $
 */
package org.exolab.jms.server;

import java.io.PrintStream;
import javax.naming.NamingException;

import org.apache.log4j.xml.DOMConfigurator;

import org.exolab.jms.authentication.AuthenticationMgr;
import org.exolab.jms.authentication.UserManager;
import org.exolab.jms.config.Configuration;
import org.exolab.jms.config.ConfigurationLoader;
import org.exolab.jms.config.LoggerConfiguration;
import org.exolab.jms.events.BasicEventManager;
import org.exolab.jms.gc.GarbageCollectionService;
import org.exolab.jms.lease.LeaseManager;
import org.exolab.jms.messagemgr.ConsumerManagerImpl;
import org.exolab.jms.messagemgr.DestinationCacheFactory;
import org.exolab.jms.messagemgr.DestinationConfigurator;
import org.exolab.jms.messagemgr.DestinationManagerImpl;
import org.exolab.jms.messagemgr.MessageMgr;
import org.exolab.jms.messagemgr.ResourceManager;
import org.exolab.jms.messagemgr.DestinationBinder;
import org.exolab.jms.persistence.DatabaseService;
import org.exolab.jms.scheduler.Scheduler;
import org.exolab.jms.service.ServiceException;
import org.exolab.jms.service.ServiceManager;
import org.exolab.jms.service.Services;
import org.exolab.jms.service.ServiceThreadListener;
import org.exolab.jms.util.CommandLine;
import org.exolab.jms.util.Version;
import org.exolab.jms.common.threads.DefaultThreadPoolFactory;


/**
 * This class contains the main line for instantiating the JMS Server. It
 * dynamically detemrines, from the configuration information which of the
 * servers to implement and then calls the init method on them.
 *
 * @author &lt;a href=&quot;mailto:jima@exoffice.com&quot;&gt;Jim Alateras&lt;/a&gt;
 * @author &lt;a href=&quot;mailto:tma@netspace.net.au&quot;&gt;Tim Anderson&lt;/a&gt;
 * @version $Revision: 1.6 $ $Date: 2006/02/23 11:17:40 $
 */
public class JmsServer {

    /**
     * The service manager.
     */
<span class="nc" id="L92">    private Services _services = new ServiceManager();</span>

    /**
     * The configuration of this server.
     */
    private Configuration _config;


    /**
     * Construct a new &lt;code&gt;JmsServer&lt;/code&gt;.
     *
     * @param config the server configuration
     */
<span class="nc" id="L105">    public JmsServer(Configuration config) {</span>
<span class="nc" id="L106">        version();</span>
<span class="nc" id="L107">        _config = config;</span>
<span class="nc" id="L108">    }</span>

    /**
     * Construct a new &lt;code&gt;JmsServer&lt;/code&gt;, configured from the specified
     * configuration file.
     *
     * @param file configuration file name
     * @throws ServerException if the server cannot be created
     */
<span class="nc" id="L117">    public JmsServer(String file) throws ServerException {</span>
<span class="nc" id="L118">        version();</span>

<span class="nc" id="L120">        ConfigurationLoader loader = new ConfigurationLoader();</span>
        try {
<span class="nc" id="L122">            _config = loader.load(file);</span>
<span class="nc" id="L123">        } catch (Exception exception) {</span>
<span class="nc" id="L124">            throw new ServerException(&quot;Failed to read configuration: &quot; + file,</span>
                                      exception);
<span class="nc" id="L126">        }</span>
<span class="nc" id="L127">    }</span>

    /**
     * Initialise the server
     *
     * @throws NamingException  if administered objects cannot be bound in JNDI
     * @throws ServiceException if the server cannot be initialised
     */
    public void init() throws NamingException, ServiceException {
        // initialise the logger
<span class="nc" id="L137">        LoggerConfiguration log = _config.getLoggerConfiguration();</span>

        // @todo - need to do this in main(), to allow pluggable log factories
        // when embedding OpenJMS
<span class="nc" id="L141">        DOMConfigurator.configure(log.getFile());</span>

        // initialise the services, and start them
        try {
<span class="nc" id="L145">            registerServices();</span>
<span class="nc" id="L146">            _services.start();</span>
<span class="nc" id="L147">        } catch (ServiceException exception) {</span>
<span class="nc" id="L148">            throw new ServerException(</span>
                    &quot;Failed to start services&quot;, exception);
<span class="nc" id="L150">        }</span>
<span class="nc" id="L151">    }</span>

    /**
     * This is the main line for the JMS Server. It processes the command line
     * argument, instantiates an instance of the server class and calls the init
     * routine on it.
     */
    public static void main(String[] args) {
        try {
<span class="nc" id="L160">            CommandLine cmdline = new CommandLine(args);</span>

<span class="nc" id="L162">            boolean helpSet = cmdline.exists(&quot;help&quot;);</span>
<span class="nc" id="L163">            boolean versionSet = cmdline.exists(&quot;version&quot;);</span>
<span class="nc" id="L164">            boolean configSet = cmdline.exists(&quot;config&quot;);</span>

<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (helpSet) {</span>
<span class="nc" id="L167">                usage();</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            } else if (versionSet) {</span>
<span class="nc" id="L169">                version();</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">            } else if (!configSet &amp;&amp; args.length != 0) {</span>
                // invalid argument specified
<span class="nc" id="L172">                usage();</span>
            } else {
<span class="nc" id="L174">                String config = cmdline.value(&quot;config&quot;,</span>
<span class="nc" id="L175">                                              getOpenJMSHome()</span>
                                              + &quot;/config/openjms.xml&quot;);
<span class="nc" id="L177">                JmsServer server = new JmsServer(config);</span>
<span class="nc" id="L178">                server.init();</span>
            }
<span class="nc" id="L180">        } catch (Exception exception) {</span>
<span class="nc" id="L181">            exception.printStackTrace();</span>
            // force termination of any threads
<span class="nc" id="L183">            System.exit(-1);</span>
<span class="nc" id="L184">        }</span>
<span class="nc" id="L185">    }</span>

    public static void version() {
<span class="nc" id="L188">        System.err.println(Version.TITLE + &quot; &quot; + Version.VERSION);</span>
<span class="nc" id="L189">        System.err.println(Version.COPYRIGHT);</span>
<span class="nc" id="L190">        System.err.println(Version.VENDOR_URL);</span>
<span class="nc" id="L191">    }</span>

    /**
     * Print out information on running this sevice
     */
    protected static void usage() {
<span class="nc" id="L197">        PrintStream out = System.out;</span>

<span class="nc" id="L199">        out.println(&quot;\n\n&quot;);</span>
<span class="nc" id="L200">        out.println(&quot;=====================================================&quot;);</span>
<span class="nc" id="L201">        out.println(&quot;Usage information for org.exolab.jms.server.JmsServer&quot;);</span>
<span class="nc" id="L202">        out.println(&quot;=====================================================&quot;);</span>
<span class="nc" id="L203">        out.println(&quot;\norg.exolab.jms.server.JmsServer&quot;);</span>
<span class="nc" id="L204">        out.println(&quot;    [-config &lt;xml config file&gt; | -version | -help]\n&quot;);</span>
<span class="nc" id="L205">        out.println(&quot;\t-config  file name of xml-based config file\n&quot;);</span>
<span class="nc" id="L206">        out.println(&quot;\t-version displays OpenJMS version information\n&quot;);</span>
<span class="nc" id="L207">        out.println(&quot;\t-help    displays this screen\n&quot;);</span>
<span class="nc" id="L208">    }</span>

    /**
     * Returns the services
     *
     * @return ServiceManager
     * @deprecated no replacement
     */
    protected Services getServices() {
<span class="nc" id="L217">        return _services;</span>
    }

    /**
     * Initialise the services
     */
    protected void registerServices() throws ServiceException {
<span class="nc" id="L224">        _services.addService(_config);</span>
<span class="nc" id="L225">        _services.addService(ServiceThreadListener.class);</span>
<span class="nc" id="L226">        _services.addService(DefaultThreadPoolFactory.class);</span>
<span class="nc" id="L227">        _services.addService(BasicEventManager.class);</span>
<span class="nc" id="L228">        _services.addService(DatabaseService.class);</span>
<span class="nc" id="L229">        _services.addService(Scheduler.class);</span>
<span class="nc" id="L230">        _services.addService(LeaseManager.class);</span>
<span class="nc" id="L231">        _services.addService(GarbageCollectionService.class);</span>
<span class="nc" id="L232">        _services.addService(AuthenticationMgr.class);</span>
<span class="nc" id="L233">        _services.addService(UserManager.class);</span>
<span class="nc" id="L234">        _services.addService(DestinationCacheFactory.class);</span>
<span class="nc" id="L235">        _services.addService(DestinationManagerImpl.class);</span>
<span class="nc" id="L236">        _services.addService(ConsumerManagerImpl.class);</span>
<span class="nc" id="L237">        _services.addService(ServerConnectionManagerImpl.class);</span>
<span class="nc" id="L238">        _services.addService(ResourceManager.class);</span>
<span class="nc" id="L239">        _services.addService(AdminConnectionFactory.class);</span>
<span class="nc" id="L240">        _services.addService(AdminConnectionManager.class);</span>
<span class="nc" id="L241">        _services.addService(MessageMgr.class);</span>
<span class="nc" id="L242">        _services.addService(NameService.class);</span>
<span class="nc" id="L243">        _services.addService(DestinationBinder.class);</span>
<span class="nc" id="L244">        _services.addService(DestinationConfigurator.class);</span>
<span class="nc" id="L245">        _services.addService(ConnectorService.class);</span>
<span class="nc" id="L246">    }</span>

    /**
     * Returns the value of the &lt;code&gt;openjms.home&lt;/code&gt; system property. If
     * none is set, returns the value of the &lt;code&gt;user.dir&lt;/code&gt; property.
     *
     * @return the value of the openjms.home system property
     */
    private static String getOpenJMSHome() {
<span class="nc" id="L255">        return System.getProperty(&quot;openjms.home&quot;,</span>
<span class="nc" id="L256">                                  System.getProperty(&quot;user.dir&quot;));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>