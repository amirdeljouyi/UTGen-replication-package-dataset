<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InMemoryVariableManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">69_lhamacaw</a> &gt; <a href="index.source.html" class="el_package">macaw.persistenceLayer.demo</a> &gt; <span class="el_source">InMemoryVariableManager.java</span></div><h1>InMemoryVariableManager.java</h1><pre class="source lang-java linenums">package macaw.persistenceLayer.demo;

import macaw.businessLayer.*;
import macaw.persistenceLayer.ChangeEventGenerator;
import macaw.system.*;
import macaw.util.SearchUtility;
import macaw.util.ValidationUtility;


import java.util.ArrayList;
import java.util.HashMap;



/**
 * manages instances of {@link macaw.businessLayer.Variable} in memory.  It also supports
 * adding and deleting associations between a {@link macaw.businessLayer.Variable} and:
 * &lt;ul&gt;
 * &lt;li&gt;&gt;=1 {@link macaw.businessLayer.SupportingDocument} records.&lt;/li&gt;
 * &lt;li&gt;&gt;=1 {@link macaw.businessLayer.OntologyTerm} records. &lt;/li&gt;
 * &lt;li&gt;&gt;=1 {@link macaw.businessLayer.Variable} records (for {@link macaw.businessLayer.DerivedVariable} 
 * records only&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * &lt;p&gt; In the Macaw data entry forms, users add or remove associations through list 
 * management buttons.  Other variable associations are less obvious.  Each variable is
 * also associated with:
 * &lt;ul&gt;
 * &lt;li&gt;1 {@link macaw.businessLayer.Category} (in future it will be &gt;=1 category)&lt;/li&gt;
 * &lt;li&gt;1 {@link macaw.businessLayer.AvailabilityState}&lt;/li&gt;
 * &lt;li&gt;1 {@link macaw.businessLayer.CleaningState}&lt;/li&gt;
 * &lt;li&gt;1 {@link macaw.businessLayer.AliasFilePath}&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * &lt;p&gt;
 * In the Macaw forms, these items are shown to users in a drop down list.  Items in
 * this list can be edited through separate data entry forms (see 
 * {@link macaw.presentationLayer.CategoryStateEditor},{@link macaw.presentationLayer.CleaningStateEditor},
 * {@link macaw.presentationLayer.AvailabilityStateEditor}, {@link macaw.businessLayer.AliasFilePath}. 
 * 
 * &lt;hr&gt;
 * Copyright 2010 Medical Research Council Unit for Lifelong Health and Ageing
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *      http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.  
 * &lt;hr&gt;
 * @author Kevin Garwood (kgarwood@users.sourceforge.net)
 * @version 1.0	
 */

/*
 * Code Road Map:
 * --------------
 * Code is organised into the following sections.  Wherever possible, 
 * methods are classified based on an order of precedence described in 
 * parentheses (..).  For example, if you're trying to find a method 
 * 'getName(...)' that is both an interface method and an accessor 
 * method, the order tells you it should appear under interface.
 * 
 * Order of 
 * Precedence     Section
 * ==========     ======
 * (1)            Section Constants
 * (2)            Section Properties
 * (3)            Section Construction
 * (7)            Section Accessors and Mutators
 * (6)            Section Errors and Validation
 * (5)            Section Interfaces
 * (4)            Section Overload
 *
 */

public class InMemoryVariableManager extends InMemoryCurationConceptManager {

	// ==========================================
	// Section Constants
	// ==========================================

	// ==========================================
	// Section Properties
	// ==========================================
	private ArrayList&lt;Variable&gt; variables;
	private InMemoryListChoiceManager listChoiceManager;
	private InMemoryOntologyTermManager ontologyTermManager;
	private InMemorySupportingDocumentsManager supportingDocumentsManager;
	private HashMap&lt;Integer, Variable&gt; variableFromIdentifier;
	private int variableKey;

	// ==========================================
	// Section Construction
	// ==========================================
	public InMemoryVariableManager(InMemoryChangeEventManager changeEventManager,
								   InMemoryListChoiceManager listChoiceManager,
								   InMemoryOntologyTermManager ontologyTermManager,
								   InMemorySupportingDocumentsManager supportingDocumentsManager) {
		
<span class="fc" id="L103">		super(changeEventManager);</span>
<span class="fc" id="L104">		this.listChoiceManager = listChoiceManager;</span>
<span class="fc" id="L105">		this.ontologyTermManager = ontologyTermManager;</span>
<span class="fc" id="L106">		this.supportingDocumentsManager = supportingDocumentsManager;</span>
<span class="fc" id="L107">		variables = new ArrayList&lt;Variable&gt;();		</span>
<span class="fc" id="L108">		variableFromIdentifier = new HashMap&lt;Integer, Variable&gt;();		</span>
<span class="fc" id="L109">	}</span>
	
	// ==========================================
	// Section Accessors and Mutators
	// ==========================================

	public ArrayList&lt;Variable&gt; getOriginalVariables(User user) throws MacawException {
<span class="nc" id="L116">		return variables;</span>
	}
	
	public ArrayList&lt;Variable&gt; getVariables(User user) throws MacawException {
<span class="nc" id="L120">		ArrayList&lt;Variable&gt; cloneVariables = new ArrayList&lt;Variable&gt;();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc" id="L122">			Variable cloneVariable</span>
<span class="nc" id="L123">				= (Variable) currentVariable.clone();</span>
<span class="nc" id="L124">			cloneVariables.add(cloneVariable);</span>
<span class="nc" id="L125">		}</span>
<span class="nc" id="L126">		return cloneVariables;</span>
	}
	
	public void addRawVariable(User user, 
							   RawVariable rawVariable) throws MacawException {

<span class="fc" id="L132">		RawVariable.validateFields(rawVariable);</span>
<span class="fc" id="L133">		addVariable(user, rawVariable);</span>
<span class="fc" id="L134">	}</span>

	public void addDerivedVariable(User user, 
								   DerivedVariable derivedVariable) throws MacawException {

<span class="fc" id="L139">		addVariable(user, derivedVariable);</span>
<span class="fc" id="L140">		DerivedVariable.validateFields(derivedVariable);</span>
<span class="fc" id="L141">	}</span>

	
	public void addVariable(User user, 
							Variable variable) throws MacawException {
		
		//Part I: Validate parameters
<span class="fc" id="L148">		checkVariableDuplicates(variable);</span>
<span class="fc" id="L149">		checkListChoices(variable);</span>

		//Part II: Add Variable
<span class="fc" id="L152">		variableKey++;</span>
<span class="fc" id="L153">		variable.setIdentifier(variableKey);</span>
		
<span class="fc" id="L155">		variable.setIsNewRecord(false);</span>
<span class="fc" id="L156">		variables.add(variable);</span>
<span class="fc" id="L157">		variableFromIdentifier.put(variable.getIdentifier(), variable);</span>
		
		//Part III: Record Changes
<span class="fc" id="L160">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="fc" id="L161">			= ChangeEventGenerator.addVariableChange(user, variable);</span>
<span class="fc" id="L162">		registerChangeEvents(changeEvents);</span>
<span class="fc" id="L163">	}</span>

	public void updateRawVariable(User user, 
								  RawVariable revisedRawVariable) throws MacawException {

		//Part I: Validate parameters
		
		//check basic field errors
<span class="nc" id="L171">		RawVariable.validateFields(revisedRawVariable);</span>
		//check that variable exists
<span class="nc" id="L173">		checkVariableExists(revisedRawVariable);</span>
		//check for duplicates
<span class="nc" id="L175">		checkVariableDuplicates(revisedRawVariable);</span>
<span class="nc" id="L176">		checkListChoices(revisedRawVariable);</span>

		
		//check that at least one change was made.
<span class="nc" id="L180">		RawVariable originalRawVariable</span>
<span class="nc" id="L181">			= (RawVariable) getOriginalVariable(revisedRawVariable);</span>
<span class="nc" id="L182">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L183">			= RawVariable.detectFieldChanges(user,</span>
											 originalRawVariable, 
											 revisedRawVariable);	
		
<span class="nc bnc" id="L187" title="All 2 branches missed.">		if (changeEvents.size() == 0) {</span>
<span class="nc" id="L188">			return;</span>
		}
		
		//Part II: Perform Update
		//obtain the original object for the supporting document that
		//is requested
		
		//replace original with revised copies in the list of documents
		//associated with a given variable
<span class="nc" id="L197">		int foundIndex</span>
<span class="nc" id="L198">			= variables.indexOf(originalRawVariable);</span>
<span class="nc" id="L199">		variables.remove(foundIndex);</span>

<span class="nc" id="L201">		int currentNumberOfVariables = variables.size();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">		if (foundIndex == currentNumberOfVariables - 1) {</span>
			//add to the end to avoid array out of index errors
<span class="nc" id="L204">			variables.add(revisedRawVariable);</span>
		}
		else {
<span class="nc" id="L207">			variables.add(foundIndex, revisedRawVariable);			</span>
		}
		//replace original with revised in the list that tracks all managed
		//supporting document instances
<span class="nc" id="L211">		int identifier = originalRawVariable.getIdentifier();</span>
<span class="nc" id="L212">		variableFromIdentifier.remove(originalRawVariable);</span>
<span class="nc" id="L213">		variableFromIdentifier.put(identifier, revisedRawVariable);</span>
		
		//Part III: Record changes
<span class="nc" id="L216">		registerChangeEvents(changeEvents);</span>
<span class="nc" id="L217">	}</span>

	public void deleteRawVariables(User user, 
								   ArrayList&lt;RawVariable&gt; rawVariablesToDelete) throws MacawException {
		//Part I: Validate parameters

		//check that raw variables exist		
<span class="nc bnc" id="L224" title="All 2 branches missed.">		for (RawVariable rawVariableToDelete : rawVariablesToDelete) {</span>
<span class="nc" id="L225">			checkVariableExists(rawVariableToDelete);</span>
<span class="nc" id="L226">		}</span>
		
		//Part II: Perform the deletion operation
<span class="nc bnc" id="L229" title="All 2 branches missed.">		for (RawVariable currentRawVariable : rawVariablesToDelete) {</span>
<span class="nc" id="L230">			int identifier = currentRawVariable.getIdentifier();</span>
<span class="nc" id="L231">			RawVariable originalRawVariable</span>
<span class="nc" id="L232">				= (RawVariable) variableFromIdentifier.get(identifier);</span>
<span class="nc" id="L233">			variables.remove(originalRawVariable);</span>
<span class="nc" id="L234">			variableFromIdentifier.remove(identifier);</span>
<span class="nc" id="L235">		}		</span>
		
		//Part III: Record changes
<span class="nc" id="L238">		ArrayList&lt;MacawChangeEvent&gt; changeEvents = new ArrayList&lt;MacawChangeEvent&gt;();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">		for (RawVariable currentRawVariable : rawVariablesToDelete) {</span>
<span class="nc" id="L240">			MacawChangeEvent changeEvent</span>
<span class="nc" id="L241">				= ChangeEventGenerator.deleteVariableChanges(user, </span>
															 currentRawVariable);
<span class="nc" id="L243">			changeEvents.add(changeEvent);</span>
<span class="nc" id="L244">		}</span>
<span class="nc" id="L245">		registerChangeEvents(changeEvents);		</span>
<span class="nc" id="L246">	}</span>

	public void updateDerivedVariable(User user, 
									  DerivedVariable revisedDerivedVariable) throws MacawException {

		//Part I: Validate parameters
		
		//check basic field errors
<span class="nc" id="L254">		DerivedVariable.validateFields(revisedDerivedVariable);</span>
		//check that variable exists
<span class="nc" id="L256">		checkVariableExists(revisedDerivedVariable);</span>
		//check for duplicates
<span class="nc" id="L258">		checkVariableDuplicates(revisedDerivedVariable);</span>
<span class="nc" id="L259">		checkListChoices(revisedDerivedVariable);</span>
		
		//check that at least one change was made.
<span class="nc" id="L262">		DerivedVariable originalDerivedVariable</span>
<span class="nc" id="L263">			= (DerivedVariable) getOriginalVariable(revisedDerivedVariable);</span>
<span class="nc" id="L264">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L265">			= RawVariable.detectFieldChanges(user,</span>
											 originalDerivedVariable, 
											 revisedDerivedVariable);	
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (changeEvents.size() == 0) {</span>
<span class="nc" id="L269">			return;</span>
		}
		
		//Part II: Perform Update
		//obtain the original object for the supporting document that
		//is requested
		
		//replace original with revised copies in the list of documents
		//associated with a given variable
<span class="nc" id="L278">		int foundIndex</span>
<span class="nc" id="L279">			= variables.indexOf(originalDerivedVariable);</span>
<span class="nc" id="L280">		variables.remove(foundIndex);</span>

<span class="nc" id="L282">		int currentNumberOfVariables = variables.size();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if (foundIndex == currentNumberOfVariables - 1) {</span>
			//add to the end to avoid array out of index errors
<span class="nc" id="L285">			variables.add(revisedDerivedVariable);</span>
		}
		else {
<span class="nc" id="L288">			variables.add(foundIndex, revisedDerivedVariable);			</span>
		}
		//replace original with revised in the list that tracks all managed
		//supporting document instances
<span class="nc" id="L292">		int identifier = originalDerivedVariable.getIdentifier();</span>
<span class="nc" id="L293">		variableFromIdentifier.remove(originalDerivedVariable);</span>
<span class="nc" id="L294">		variableFromIdentifier.put(identifier, revisedDerivedVariable);</span>
		
		//Part III: Record changes
<span class="nc" id="L297">		registerChangeEvents(changeEvents);		</span>
<span class="nc" id="L298">	}</span>

	public void deleteDerivedVariables(User user, 
									   ArrayList&lt;DerivedVariable&gt; derivedVariablesToDelete) throws MacawException {

		//Part I: Validate parameters
		//check that derived variables exist		
<span class="nc bnc" id="L305" title="All 2 branches missed.">		for (DerivedVariable derivedVariableToDelete : derivedVariablesToDelete) {</span>
<span class="nc" id="L306">			checkVariableExists(derivedVariableToDelete);</span>
<span class="nc" id="L307">		}</span>
		
		//Part II: Perform the deletion operation
<span class="nc bnc" id="L310" title="All 2 branches missed.">		for (DerivedVariable currentDerivedVariable : derivedVariablesToDelete) {</span>
<span class="nc" id="L311">			int identifier = currentDerivedVariable.getIdentifier();</span>
<span class="nc" id="L312">			DerivedVariable originalDerivedVariable</span>
<span class="nc" id="L313">				= (DerivedVariable) variableFromIdentifier.get(identifier);</span>
<span class="nc" id="L314">			variables.remove(originalDerivedVariable);</span>
<span class="nc" id="L315">			variableFromIdentifier.remove(identifier);</span>
<span class="nc" id="L316">		}		</span>
		
		//Part III: Record changes
<span class="nc" id="L319">		String userID = user.getUserID();</span>
<span class="nc" id="L320">		ArrayList&lt;MacawChangeEvent&gt; changeEvents = new ArrayList&lt;MacawChangeEvent&gt;();</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">		for (DerivedVariable currentDerivedVariable : derivedVariablesToDelete) {</span>
<span class="nc" id="L322">			String changeMessage</span>
<span class="nc" id="L323">				= MacawMessages.getMessage(&quot;derivedVariable.saveChanges.deleteRecord&quot;,</span>
<span class="nc" id="L324">										   currentDerivedVariable.getDisplayName());</span>
<span class="nc" id="L325">			MacawChangeEvent changeEvent</span>
				= new MacawChangeEvent(ChangeEventType.VARIABLE,
									   changeMessage, 
									   userID);	
<span class="nc" id="L329">			changeEvent.setChangedObjectIdentifier(currentDerivedVariable.getIdentifier());</span>
<span class="nc" id="L330">			changeEvent.setVariableOwnerID(currentDerivedVariable.getIdentifier());</span>
<span class="nc" id="L331">			changeEvents.add(changeEvent);</span>
<span class="nc" id="L332">		}	</span>
		
<span class="nc" id="L334">		registerChangeEvents(changeEvents);	</span>
<span class="nc" id="L335">	}</span>
	
	public ArrayList&lt;VariableSummary&gt; getSummaryDataForAllVariables(User user) throws MacawException {
<span class="nc" id="L338">		ArrayList&lt;VariableSummary&gt; variableSummaries = new ArrayList&lt;VariableSummary&gt;();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc" id="L340">			variableSummaries.add(currentVariable.createVariableSummary());</span>
<span class="nc" id="L341">		}</span>
<span class="nc" id="L342">		return variableSummaries;		</span>
	}

	public Variable getCompleteVariableData(User user, VariableSummary variableSummary) throws MacawException {
<span class="nc" id="L346">		int identifier = variableSummary.getIdentifier();</span>
<span class="nc" id="L347">		Variable variable = variableFromIdentifier.get(identifier);</span>
		
<span class="nc bnc" id="L349" title="All 2 branches missed.">		if (variable == null) {</span>
			//ERROR: derived variable does not exist
<span class="nc" id="L351">			String errorMessage</span>
<span class="nc" id="L352">				= MacawMessages.getMessage(&quot;variable.error.nonExistent&quot;,</span>
<span class="nc" id="L353">											variableSummary.getDisplayName());</span>
<span class="nc" id="L354">			MacawException exception = new MacawException();</span>
<span class="nc" id="L355">			exception.addErrorMessage(MacawErrorType.NON_EXISTENT_VARIABLE_FOR_SUMMARY,</span>
									  errorMessage);
<span class="nc" id="L357">			throw exception;			</span>
		}		

<span class="nc" id="L360">		Variable cloneVariable = (Variable) variable.clone();</span>
<span class="nc" id="L361">		return cloneVariable;</span>
	}

	/**
	public Variable getVariable(User user,
								String variableName) throws MacawException {
		
		if (variableName == null) {
			return null;
		}
		
		for (Variable variable : variables) {
			if (variable.getName().equals(variableName) == true) {
				return variable;
			}
		}		
		
		return null;
	}
	*/
	
	public ArrayList&lt;OntologyTerm&gt; getAssociatedOntologyTerms(User user,
															  Variable variable) throws MacawException {

		//PartI: Check derived variable exists
<span class="nc" id="L386">		checkVariableExists(variable);</span>

		//Part II get source variables for derived variable
<span class="nc" id="L389">		Variable originalVariable</span>
<span class="nc" id="L390">			= (Variable) getOriginalVariable(variable);</span>
		//make a copy of the list of source variables
<span class="nc" id="L392">		ArrayList&lt;OntologyTerm&gt; ontologyTerms = originalVariable.getOntologyTerms();</span>
		
<span class="nc" id="L394">		ArrayList&lt;OntologyTerm&gt; cloneOntologyTerms = new ArrayList&lt;OntologyTerm&gt;();</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">		for (OntologyTerm currentOntologyTerm : ontologyTerms) {</span>
<span class="nc" id="L396">			OntologyTerm originalOntologyTerm</span>
<span class="nc" id="L397">				= ontologyTermManager.getOriginalOntologyTerm(currentOntologyTerm);</span>
<span class="nc" id="L398">			OntologyTerm cloneSourceVariable = (OntologyTerm) originalOntologyTerm.clone();</span>
<span class="nc" id="L399">			cloneOntologyTerms.add(cloneSourceVariable);</span>
<span class="nc" id="L400">		}</span>

<span class="nc" id="L402">		return cloneOntologyTerms;</span>
	}
	
	public void associateOntologyTerms(User user,
									   Variable variable,
									   ArrayList&lt;OntologyTerm&gt; ontologyTermsToAssociate) throws MacawException {

		//Part I: Validate parameters
<span class="fc" id="L410">		checkVariableExists(variable);	</span>
<span class="fc bfc" id="L411" title="All 2 branches covered.">		for (OntologyTerm ontologyTermToAssociate : ontologyTermsToAssociate) {</span>
<span class="fc" id="L412">			ontologyTermManager.checkOntologyTermExists(ontologyTermToAssociate);</span>
<span class="fc" id="L413">			checkDuplicateTermAssociation(variable, </span>
										  ontologyTermToAssociate);
<span class="fc" id="L415">		}</span>
		
		//Part II: Perform associate ontology terms operation
<span class="fc" id="L418">		Variable originalVariable</span>
<span class="fc" id="L419">			= (Variable) getOriginalVariable(variable);		</span>
<span class="fc bfc" id="L420" title="All 2 branches covered.">		for (OntologyTerm ontologyTermToAdd : ontologyTermsToAssociate) {</span>
			/*
			String changeMessage
				= MacawMessages.getMessage(&quot;ontologyTerm.addTermToVariable.saveChanges.add&quot;,
											originalVariable.getDisplayName(),
											ontologyTermToAdd.getDisplayName());
			*/
<span class="fc" id="L427">			originalVariable.addOntologyTerm(ontologyTermToAdd);</span>
<span class="fc" id="L428">		}</span>

		//Part III: Record changes
		
		//the code below is commented out until we have settled more on the design
		//of ontology terms.
		
		/**
		String userID = user.getUserID();
		ArrayList&lt;MacawChangeEvent&gt; changeEvents = new ArrayList&lt;MacawChangeEvent&gt;();
		for (OntologyTerm ontologyTermToAdd : ontologyTermsToAssociate) {
			String changeMessage
				= MacawMessages.getMessage(&quot;ontologyTerm.addTermToVariable.saveChanges.add&quot;,
											originalVariable.getDisplayName(),
											ontologyTermToAdd.getDisplayName());
			MacawChangeEvent changeEvent
				= new MacawChangeEvent(ChangeEventType.ONTOLOGY_TERM,
										changeMessage,
										userID);
			changeEvent.setChangedObjectIdentifier(ontologyTermToAdd.getIdentifier());
			changeEvent.setVariableOwnerID(originalVariable.getIdentifier());
			originalVariable.addOntologyTerm(ontologyTermToAdd);
		}
		*/

		
		
<span class="fc" id="L455">	}</span>
	
	public void disassociateOntologyTerms(User user,
									  	  Variable variable,
									  	  ArrayList&lt;OntologyTerm&gt; ontologyTermsToDisassociate) throws MacawException {

		//Part I: Validate parameters
<span class="nc" id="L462">		checkVariableExists(variable);	</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">		for (OntologyTerm ontologyTermToDisAssociate : ontologyTermsToDisassociate) {</span>
<span class="nc" id="L464">			ontologyTermManager.checkOntologyTermExists(ontologyTermToDisAssociate);</span>
<span class="nc" id="L465">			checkTermAssociationExists(variable, </span>
									   ontologyTermToDisAssociate);
<span class="nc" id="L467">		}</span>
		
		//Part II: Perform associate ontology terms operation
<span class="nc" id="L470">		Variable originalVariable</span>
<span class="nc" id="L471">			= (Variable) getOriginalVariable(variable);		</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">		for (OntologyTerm ontologyTermToDisAssociate : ontologyTermsToDisassociate) {</span>
<span class="nc" id="L473">			originalVariable.removeOntologyTerm(ontologyTermToDisAssociate);</span>
<span class="nc" id="L474">		}</span>

		//Part III: Record changes
		//NOTE: NOT committing provenance, defer until better ontology term system
		//implemented		
		/**
		String userID = user.getUserID();
		ArrayList&lt;MacawChangeEvent&gt; changeEvents = new ArrayList&lt;MacawChangeEvent&gt;();
		for (OntologyTerm ontologyTermToDisAssociate : ontologyTermsToDisassociate) {
			String changeMessage
				= MacawMessages.getMessage(&quot;ontologyTerm.addTermToVariable.saveChanges.add&quot;,
											originalVariable.getDisplayName(),
											ontologyTermToDisAssociate.getDisplayName());
			MacawChangeEvent changeEvent
				= new MacawChangeEvent(ChangeEventType.ONTOLOGY_TERM,
										changeMessage,
										userID);
			changeEvent.setChangedObjectIdentifier(ontologyTermToDisAssociate.getIdentifier());
			changeEvent.setVariableOwnerID(originalVariable.getIdentifier());
			originalVariable.addOntologyTerm(ontologyTermToDisAssociate);
		}
		*/
				
<span class="nc" id="L497">	}</span>
	
	public ArrayList&lt;Variable&gt; getSourceVariables(User user,
			  									  DerivedVariable derivedVariable) throws MacawException {

		//PartI: Check derived variable exists
<span class="nc" id="L503">		checkVariableExists(derivedVariable);</span>

		//Part II get source variables for derived variable
<span class="nc" id="L506">		DerivedVariable originalDerivedVariable</span>
<span class="nc" id="L507">			= (DerivedVariable) getOriginalVariable(derivedVariable);</span>
		//make a copy of the list of source variables
<span class="nc" id="L509">		ArrayList&lt;Variable&gt; originalSourceVariables = originalDerivedVariable.getSourceVariables();</span>
<span class="nc" id="L510">		ArrayList&lt;Variable&gt; cloneSourceVariables = new ArrayList&lt;Variable&gt;();</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">		for (Variable originalSourceVariable : originalSourceVariables) {</span>
<span class="nc" id="L512">			Variable cloneSourceVariable = (Variable) originalSourceVariable.clone();</span>
<span class="nc" id="L513">			cloneSourceVariables.add(cloneSourceVariable);</span>
<span class="nc" id="L514">		}</span>

<span class="nc" id="L516">		return cloneSourceVariables;</span>
	}
	
	public void associateSourceVariables(User user,
										 DerivedVariable derivedVariable,
										 ArrayList&lt;Variable&gt; sourceVariablesToAdd) throws MacawException {

		//Part I: Validate parameters
<span class="fc" id="L524">		checkVariableExists(derivedVariable);</span>
<span class="fc bfc" id="L525" title="All 2 branches covered.">		for (Variable sourceVariableToAdd : sourceVariablesToAdd) {</span>
<span class="fc" id="L526">			checkVariableExists(sourceVariableToAdd);</span>
<span class="fc" id="L527">			checkDuplicateVariableAssociation(derivedVariable,</span>
											  sourceVariableToAdd);
<span class="fc" id="L529">		}</span>
		
		//Part II: Perform add source variables operation
<span class="fc" id="L532">		DerivedVariable originalDerivedVariable</span>
<span class="fc" id="L533">			= (DerivedVariable) getOriginalVariable(derivedVariable);		</span>
<span class="fc bfc" id="L534" title="All 2 branches covered.">		for (Variable sourceVariableToAdd : sourceVariablesToAdd) {</span>
<span class="fc" id="L535">			Variable originalSourceVariable</span>
<span class="fc" id="L536">				= getOriginalVariable(sourceVariableToAdd);</span>
<span class="fc" id="L537">			originalDerivedVariable.addSourceVariable(originalSourceVariable);</span>
<span class="fc" id="L538">		}</span>

		//Part III: Record changes
<span class="fc" id="L541">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="fc" id="L542">			= ChangeEventGenerator.associateSourceVariablesChanges(user,</span>
																   derivedVariable,
																   sourceVariablesToAdd);
<span class="fc" id="L545">		registerChangeEvents(changeEvents);				</span>
<span class="fc" id="L546">	}</span>


	public void disassociateSourceVariables(User user,
				  					  		DerivedVariable derivedVariable,
				  					  		ArrayList&lt;Variable&gt; sourceVariablesToDelete) throws MacawException {

		//Part I: Validate parameters
<span class="nc" id="L554">		checkVariableExists(derivedVariable);</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">		for (Variable sourceVariableToDelete : sourceVariablesToDelete) {</span>
<span class="nc" id="L556">			checkVariableExists(sourceVariableToDelete);</span>
<span class="nc" id="L557">			checkVariableAssociationExists(derivedVariable, sourceVariableToDelete);</span>
<span class="nc" id="L558">		}</span>
		
		//Part II: Perform add source variables operation
<span class="nc" id="L561">		DerivedVariable originalDerivedVariable</span>
<span class="nc" id="L562">			= (DerivedVariable) getOriginalVariable(derivedVariable);		</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">		for (Variable sourceVariableToDelete : sourceVariablesToDelete) {</span>
<span class="nc" id="L564">			Variable originalSourceVariable</span>
<span class="nc" id="L565">				= getOriginalVariable(sourceVariableToDelete);</span>
<span class="nc" id="L566">			originalDerivedVariable.removeSourceVariable(originalSourceVariable);</span>
<span class="nc" id="L567">		}</span>

		//Part III: Record changes
<span class="nc" id="L570">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L571">			= ChangeEventGenerator.disassociateSourceVariablesChanges(user,</span>
			    													  derivedVariable,
			    													  sourceVariablesToDelete);		
<span class="nc" id="L574">		registerChangeEvents(changeEvents);		</span>
<span class="nc" id="L575">	}</span>

	public Variable getOriginalVariable(Variable variable) {
<span class="fc" id="L578">		int identifier = variable.getIdentifier();</span>
<span class="fc" id="L579">		Variable originalVariable</span>
<span class="fc" id="L580">			= variableFromIdentifier.get(identifier);</span>
<span class="fc" id="L581">		return originalVariable;</span>
	}

	public Variable getVariable(User user,
								String variableName) throws MacawException {
<span class="nc bnc" id="L586" title="All 2 branches missed.">		if (ValidationUtility.isEmptyValue(variableName) == true) {</span>
<span class="nc" id="L587">			return null;</span>
		}
		
<span class="nc" id="L590">		SearchUtility searchUtility = new SearchUtility(variableName);		</span>

<span class="nc bnc" id="L592" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc" id="L593">			String currentVariableName </span>
<span class="nc" id="L594">				= currentVariable.getName();</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">			if (searchUtility.valueExactlyMatches(currentVariableName) == true) {</span>
<span class="nc" id="L596">				Variable result = (Variable) currentVariable.clone(); </span>
<span class="nc" id="L597">				return result;</span>
			}
<span class="nc" id="L599">		}</span>

<span class="nc" id="L601">		return null;</span>
	}
	
	public ArrayList&lt;VariableSummary&gt; getVariableSummariesForCategory(User user,
																	  String categoryName) throws MacawException {	
		
<span class="nc" id="L607">		SearchUtility searchUtility = new SearchUtility(categoryName);		</span>

<span class="nc" id="L609">		ArrayList&lt;VariableSummary&gt; variableSummaries = new ArrayList&lt;VariableSummary&gt;();</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc" id="L611">			String currentVariableCategory = currentVariable.getCategory();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">			if (searchUtility.valueExactlyMatches(currentVariableCategory) == true) {</span>
<span class="nc" id="L613">				variableSummaries.add(currentVariable.createVariableSummary());</span>
			}
<span class="nc" id="L615">		}</span>
		
<span class="nc" id="L617">		return variableSummaries;	</span>
	}
	
	public String[] getStudyYears(User user) throws MacawException {
<span class="nc" id="L621">		ArrayList&lt;String&gt; studyYears = new ArrayList&lt;String&gt;();</span>
		
<span class="nc bnc" id="L623" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc" id="L624">			String yearOfVariable = currentVariable.getYear();</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">			if ( (ValidationUtility.isBlank(yearOfVariable) == false) &amp;&amp;</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">				 (studyYears.contains(yearOfVariable) == false)) {</span>
<span class="nc" id="L627">				studyYears.add(yearOfVariable);				</span>
			}			
<span class="nc" id="L629">		}</span>
				
<span class="nc" id="L631">		String[] results</span>
<span class="nc" id="L632">			= studyYears.toArray(new String[0]);</span>
<span class="nc" id="L633">		return results;</span>
	}

	public String[] getVariableNames(User user) throws MacawException {
<span class="nc" id="L637">		ArrayList&lt;String&gt; variableNames = new ArrayList&lt;String&gt;();</span>
		
<span class="nc bnc" id="L639" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc" id="L640">			variableNames.add(currentVariable.getName());				</span>
<span class="nc" id="L641">		}</span>
				
<span class="nc" id="L643">		String[] results</span>
<span class="nc" id="L644">			= variableNames.toArray(new String[0]);</span>
<span class="nc" id="L645">		return results;		</span>
	}

	
	public ArrayList&lt;Category&gt; getCategoriesForVariable(User user,
														String variableName) throws MacawException {

<span class="nc" id="L652">		ArrayList&lt;Category&gt; categories = new ArrayList&lt;Category&gt;();</span>
		
<span class="nc" id="L654">		Variable variable = getVariable(user, variableName);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">		if (variable != null) {</span>
<span class="nc" id="L656">			String categoryName = variable.getCategory();</span>
<span class="nc" id="L657">			Category category </span>
<span class="nc" id="L658">				= listChoiceManager.getCategory(categoryName);</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">			if (category != null) {</span>
<span class="nc" id="L660">				categories.add(category);</span>
			}
		}		
<span class="nc" id="L663">		return categories;</span>
	}
	
	public ArrayList&lt;SupportingDocument&gt; getSupportingDocuments(User user,
																Variable variable) throws MacawException {
<span class="nc" id="L668">		Variable originalVariable = getOriginalVariable(variable);		</span>
<span class="nc" id="L669">		ArrayList&lt;SupportingDocument&gt; supportingDocuments</span>
<span class="nc" id="L670">			= originalVariable.getSupportingDocuments();</span>
<span class="nc" id="L671">		ArrayList&lt;SupportingDocument&gt; cloneSupportingDocuments</span>
			= new ArrayList&lt;SupportingDocument&gt;();
<span class="nc bnc" id="L673" title="All 2 branches missed.">		for (SupportingDocument currentSupportingDocument : supportingDocuments) {</span>
<span class="nc" id="L674">			SupportingDocument originalSupportingDocument</span>
<span class="nc" id="L675">				= supportingDocumentsManager.getOriginalSupportingDocument(currentSupportingDocument);</span>
<span class="nc" id="L676">			SupportingDocument cloneSupportingDocument</span>
<span class="nc" id="L677">				= (SupportingDocument) originalSupportingDocument.clone();</span>
<span class="nc" id="L678">			cloneSupportingDocuments.add(cloneSupportingDocument);</span>
<span class="nc" id="L679">		}</span>

<span class="nc" id="L681">		return cloneSupportingDocuments;		</span>
	}

	public void associateSupportingDocuments(User user,
											 Variable variable,
											 ArrayList&lt;SupportingDocument&gt; supportingDocumentsToAdd) throws MacawException {

		//Part I: Validate parameters
		//check basic field errors
<span class="fc" id="L690">		checkVariableExists(variable);</span>
<span class="pc bpc" id="L691" title="1 of 2 branches missed.">		if (supportingDocumentsToAdd.size() == 0) {</span>
<span class="nc" id="L692">			return;</span>
		}
		
<span class="fc" id="L695">		Variable originalVariable = getOriginalVariable(variable);		</span>
<span class="fc bfc" id="L696" title="All 2 branches covered.">		for (SupportingDocument supportingDocument : supportingDocumentsToAdd) {</span>
<span class="fc" id="L697">			supportingDocumentsManager.checkSupportingDocumentExists(supportingDocument);</span>
<span class="fc" id="L698">			checkDuplicateDocumentAssociation(originalVariable, supportingDocument);</span>
<span class="fc" id="L699">		}</span>

		//Part II: Add Document and Record Changes
<span class="fc" id="L702">		originalVariable.addSupportingDocuments(supportingDocumentsToAdd);</span>
				
		//Part III: Record Changes	
<span class="fc" id="L705">		ArrayList&lt;MacawChangeEvent&gt; changeEvents = new ArrayList&lt;MacawChangeEvent&gt;();</span>
<span class="fc bfc" id="L706" title="All 2 branches covered.">		for (SupportingDocument supportingDocument : supportingDocumentsToAdd) {</span>
<span class="pc bpc" id="L707" title="1 of 2 branches missed.">			if (originalVariable.containsSupportingDocument(supportingDocument) == false) {</span>
<span class="nc" id="L708">				originalVariable.addSupportingDocument(supportingDocument);</span>
<span class="nc" id="L709">				String changeMessage</span>
<span class="nc" id="L710">					= MacawMessages.getMessage(&quot;variable.saveChanges.associateDocument&quot;,</span>
<span class="nc" id="L711">												supportingDocument.getDisplayName(),</span>
<span class="nc" id="L712">												variable.getDisplayName());</span>
			
<span class="nc" id="L714">				MacawChangeEvent changeEvent</span>
					= new MacawChangeEvent(ChangeEventType.VARIABLE, 
											changeMessage, 
<span class="nc" id="L717">											user.getUserID());</span>

<span class="nc" id="L719">				changeEvent.setChangedObjectIdentifier(supportingDocument.getIdentifier());</span>
<span class="nc" id="L720">				changeEvent.setVariableOwnerID(variable.getIdentifier());</span>
<span class="nc" id="L721">				changeEvents.add(changeEvent);</span>
			}
<span class="fc" id="L723">		}</span>

<span class="fc" id="L725">		registerChangeEvents(changeEvents);</span>
<span class="fc" id="L726">	}</span>
	
	public void disassociateSupportingDocuments(User user,
												Variable variable,
												ArrayList&lt;SupportingDocument&gt; supportingDocumentsToDelete) throws MacawException {

		//Part I: Validate parameters
<span class="nc" id="L733">		checkVariableExists(variable);</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">		if (supportingDocumentsToDelete.size() == 0) {</span>
<span class="nc" id="L735">			return;</span>
		}
<span class="nc bnc" id="L737" title="All 2 branches missed.">		for (SupportingDocument supportingDocumentToDelete : supportingDocumentsToDelete) {</span>
<span class="nc" id="L738">			supportingDocumentsManager.checkSupportingDocumentExists(supportingDocumentToDelete);</span>
<span class="nc" id="L739">		}</span>
<span class="nc bnc" id="L740" title="All 2 branches missed.">		for (SupportingDocument supportingDocument : supportingDocumentsToDelete) {</span>
<span class="nc" id="L741">			checkDocumentAssociationExists(variable, </span>
								  		   supportingDocument);
<span class="nc" id="L743">		}</span>
		
		//Part II: Add Document
<span class="nc" id="L746">		variable.removeSupportingDocuments(supportingDocumentsToDelete);</span>

		//Part III: Record Changes	
<span class="nc" id="L749">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L750">			= ChangeEventGenerator.disassociateSupportingDocumentsChanges(user,</span>
					  													  variable,
					  													  supportingDocumentsToDelete);
<span class="nc" id="L753">		registerChangeEvents(changeEvents);	</span>
<span class="nc" id="L754">	}</span>
	
	public ArrayList&lt;ValueLabel&gt; getValueLabels(User user,
												Variable variable) throws MacawException {
<span class="nc" id="L758">		Variable originalVariable = getOriginalVariable(variable);		</span>
<span class="nc" id="L759">		ArrayList&lt;ValueLabel&gt; valueLabels</span>
<span class="nc" id="L760">			= originalVariable.getValueLabels();</span>
<span class="nc" id="L761">		ArrayList&lt;ValueLabel&gt; cloneValueLabels</span>
			= new ArrayList&lt;ValueLabel&gt;();
<span class="nc bnc" id="L763" title="All 2 branches missed.">		for (ValueLabel currentValueLabel : valueLabels) {</span>
<span class="nc" id="L764">			ValueLabel cloneValueLabel</span>
<span class="nc" id="L765">				= (ValueLabel) currentValueLabel.clone();</span>
<span class="nc" id="L766">			cloneValueLabels.add(cloneValueLabel);</span>
<span class="nc" id="L767">		}</span>

<span class="nc" id="L769">		return cloneValueLabels;		</span>
	}
	
	public void updateOntologyTermReferences(OntologyTerm targetOntologyTerm) {
<span class="nc" id="L773">		int targetIdentifier = targetOntologyTerm.getIdentifier();</span>
		
<span class="nc bnc" id="L775" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc" id="L776">			ArrayList&lt;OntologyTerm&gt; ontologyTerms</span>
<span class="nc" id="L777">				= currentVariable.getOntologyTerms();</span>
<span class="nc" id="L778">			int numberOfOntologyTerms = ontologyTerms.size();</span>
<span class="nc" id="L779">			int foundIndex = -1;</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">			for (int i = 0; i &lt; numberOfOntologyTerms; i++) {</span>
<span class="nc" id="L781">				int currentIdentifier</span>
<span class="nc" id="L782">					= ontologyTerms.get(i).getIdentifier();</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">				if (currentIdentifier == targetIdentifier) {</span>
<span class="nc" id="L784">					foundIndex = i;</span>
<span class="nc" id="L785">					break;</span>
				}
			}
			
<span class="nc bnc" id="L789" title="All 2 branches missed.">			if (foundIndex != -1) {</span>
				//item was found
<span class="nc" id="L791">				ontologyTerms.remove(foundIndex);</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">				if (foundIndex == numberOfOntologyTerms -1) {</span>
					//item was found at the end
<span class="nc" id="L794">					ontologyTerms.add(targetOntologyTerm);					</span>
				}
				else {
<span class="nc" id="L797">					ontologyTerms.add(foundIndex, targetOntologyTerm);</span>
				}				
			}
<span class="nc" id="L800">		}</span>
<span class="nc" id="L801">	}</span>
	
	public void deleteOntologyTermReferences(ArrayList&lt;OntologyTerm&gt; targetOntologyTerms) {
		
<span class="nc bnc" id="L805" title="All 2 branches missed.">		for (OntologyTerm ontologyTermToDelete : targetOntologyTerms) {</span>
<span class="nc" id="L806">			deleteOntologyTermReference(ontologyTermToDelete);</span>
<span class="nc" id="L807">		}</span>
<span class="nc" id="L808">	}</span>
	
	private void deleteOntologyTermReference(OntologyTerm targetOntologyTerm) {
<span class="nc" id="L811">		int targetIdentifier = targetOntologyTerm.getIdentifier();</span>
		
<span class="nc bnc" id="L813" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc" id="L814">			ArrayList&lt;OntologyTerm&gt; ontologyTerms</span>
<span class="nc" id="L815">				= currentVariable.getOntologyTerms();</span>
<span class="nc" id="L816">			int numberOfOntologyTerms = ontologyTerms.size();</span>
<span class="nc" id="L817">			int foundIndex = -1;</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">			for (int i = 0; i &lt; numberOfOntologyTerms; i++) {</span>
<span class="nc" id="L819">				int currentIdentifier</span>
<span class="nc" id="L820">					= ontologyTerms.get(i).getIdentifier();</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">				if (currentIdentifier == targetIdentifier) {</span>
<span class="nc" id="L822">					foundIndex = i;</span>
<span class="nc" id="L823">					break;</span>
				}
			}
			
<span class="nc bnc" id="L827" title="All 2 branches missed.">			if (foundIndex != -1) {</span>
				//item was found
<span class="nc" id="L829">				ontologyTerms.remove(foundIndex);</span>
			}
<span class="nc" id="L831">		}		</span>
<span class="nc" id="L832">	}</span>
	
	public int getRawVariableIdentifier(User user,
										RawVariable rawVariable) throws MacawException {
		
<span class="nc bnc" id="L837" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">			if (rawVariable.hasSameDisplayName(currentVariable) == true) {</span>
<span class="nc" id="L839">				return currentVariable.getIdentifier();</span>
			}
<span class="nc" id="L841">		}</span>
		
<span class="nc" id="L843">		return -1;</span>
	}

	public int getDerivedVariableIdentifier(User user,
											DerivedVariable derivedVariable) throws MacawException {
		
<span class="nc bnc" id="L849" title="All 2 branches missed.">		for (Variable currentVariable : variables) {</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">			if (derivedVariable.hasSameDisplayName(currentVariable) == true) {</span>
<span class="nc" id="L851">				return currentVariable.getIdentifier();</span>
			}
<span class="nc" id="L853">		}</span>
		
<span class="nc" id="L855">		return -1;		</span>
	}
	
	public void clear() {
<span class="nc" id="L859">		variableKey = 0;</span>
<span class="nc" id="L860">		variables.clear();</span>
<span class="nc" id="L861">		variableFromIdentifier.clear();</span>
<span class="nc" id="L862">	}</span>

	public Variable getAlternativeVariable(Variable targetVariable) throws MacawException {	
<span class="nc" id="L865">		Variable originalVariable</span>
<span class="nc" id="L866">			= (Variable) getOriginalVariable(targetVariable);</span>
<span class="nc" id="L867">		return originalVariable.getAlternativeVariable();</span>
	}

	public void setAlternativeVariable(User user,
									   Variable targetVariable,
									   Variable updatedAlternativeVariable) throws MacawException {

<span class="nc" id="L874">		checkVariableExists(targetVariable);</span>
<span class="nc bnc" id="L875" title="All 2 branches missed.">		if (updatedAlternativeVariable != null) {</span>
<span class="nc" id="L876">			checkVariableExists(updatedAlternativeVariable);</span>
		
<span class="nc bnc" id="L878" title="All 2 branches missed.">			if (targetVariable.getIdentifier() == updatedAlternativeVariable.getIdentifier()) {</span>
				//prevents a rare but nasty case of recursion!
<span class="nc" id="L880">				String errorMessage</span>
<span class="nc" id="L881">					= MacawMessages.getMessage(&quot;variable.error.selfReferencingAlternativeVariable&quot;,</span>
<span class="nc" id="L882">												targetVariable.getDisplayName());</span>
<span class="nc" id="L883">				MacawException exception</span>
					= new MacawException(MacawErrorType.SELF_REFERENCING_ALTERNATIVE_VARIABLE,
										 errorMessage);
<span class="nc" id="L886">				throw exception;</span>
			}
		}

<span class="nc" id="L890">		MacawChangeEvent changeEvent</span>
<span class="nc" id="L891">			= Variable.detectChangesInAlternativeVariable(user, </span>
														  targetVariable, 
														  updatedAlternativeVariable);
<span class="nc bnc" id="L894" title="All 2 branches missed.">		if (changeEvent == null) {</span>
			//no change so don't bother
<span class="nc" id="L896">			return;</span>
		}

<span class="nc" id="L899">		Variable originalVariable</span>
<span class="nc" id="L900">			= (Variable) getOriginalVariable(targetVariable);				</span>
<span class="nc" id="L901">		Variable originalAlternativeVariable</span>
<span class="nc" id="L902">			= (Variable) getOriginalVariable(updatedAlternativeVariable);</span>
<span class="nc" id="L903">		originalVariable.setAlternativeVariable(originalAlternativeVariable);</span>
		
		//Part III: Record changes
<span class="nc" id="L906">		registerChangeEvent(changeEvent);</span>
<span class="nc" id="L907">	}</span>

	// ==========================================
	// Section Errors and Validation
	// ==========================================
	
	public void checkVariableExists(Variable variable) throws MacawException {
<span class="fc" id="L914">		Variable originalVariable</span>
<span class="fc" id="L915">			= (Variable) getOriginalVariable(variable);</span>
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">		if (originalVariable == null) {</span>
			//ERROR: derived variable does not exist
<span class="nc" id="L918">			String errorMessage</span>
<span class="nc" id="L919">				= MacawMessages.getMessage(&quot;general.error.nonExistentItem&quot;,</span>
<span class="nc" id="L920">										   variable.getDisplayName());</span>
<span class="nc" id="L921">			MacawException exception </span>
				= new MacawException(MacawErrorType.NON_EXISTENT_VARIABLE,
									 errorMessage);
<span class="nc" id="L924">			throw exception;			</span>
		}		
<span class="fc" id="L926">	}</span>

	private void checkVariableDuplicates(Variable targetVariable) throws MacawException {
<span class="fc" id="L929">		String targetVariableDisplayName</span>
<span class="fc" id="L930">			= targetVariable.getDisplayName();</span>
		
<span class="fc bfc" id="L932" title="All 2 branches covered.">		for (Variable currentVariable : variables) {</span>
<span class="fc" id="L933">			String currentVariableDisplayName</span>
<span class="fc" id="L934">				= currentVariable.getDisplayName();</span>
			
<span class="pc bpc" id="L936" title="1 of 2 branches missed.">			if (targetVariableDisplayName.equals(currentVariableDisplayName) == true) {</span>
<span class="nc" id="L937">				int targetVariableIdentifier = targetVariable.getIdentifier();</span>
<span class="nc" id="L938">				int currentVariableIdentifier = currentVariable.getIdentifier();</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">				if (targetVariableIdentifier != currentVariableIdentifier) {</span>
<span class="nc" id="L940">					String errorMessage</span>
<span class="nc" id="L941">						= MacawMessages.getMessage(&quot;variable.error.duplicateExists&quot;,</span>
												   targetVariableDisplayName);
<span class="nc" id="L943">					MacawException exception</span>
						= new MacawException(MacawErrorType.DUPLICATE_VARIABLE,
											 errorMessage);
<span class="nc" id="L946">					throw exception;</span>
				}				
			}
<span class="fc" id="L949">		}		</span>
<span class="fc" id="L950">	}</span>
	
	private void checkDuplicateVariableAssociation(DerivedVariable derivedVariable, 
			   									   Variable sourceVariable) throws MacawException {

<span class="fc" id="L955">		DerivedVariable originalDerivedVariable</span>
<span class="fc" id="L956">			= (DerivedVariable) getOriginalVariable(derivedVariable);</span>
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">		if (originalDerivedVariable.containsSourceVariable(sourceVariable) == true) {</span>
			//already contains
<span class="nc" id="L959">			String errorMessage</span>
<span class="nc" id="L960">				= MacawMessages.getMessage(&quot;variable.error.duplicateTermAssociation&quot;,</span>
<span class="nc" id="L961">											derivedVariable.getDisplayName(),</span>
<span class="nc" id="L962">											sourceVariable.getDisplayName());</span>

<span class="nc" id="L964">			MacawException exception </span>
				= new MacawException(MacawErrorType.DUPLICATE_VARIABLE_ASSOCIATION,
									 errorMessage);				
<span class="nc" id="L967">			throw exception;</span>
		}
<span class="fc" id="L969">	}</span>

	private void checkVariableAssociationExists(DerivedVariable derivedVariable, 
												Variable sourceVariable) throws MacawException {

<span class="nc" id="L974">		DerivedVariable originalDerivedVariable</span>
<span class="nc" id="L975">			= (DerivedVariable) getOriginalVariable(derivedVariable);</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">		if (originalDerivedVariable.containsSourceVariable(sourceVariable) == false) {	</span>
<span class="nc" id="L977">			MacawException exception = new MacawException();</span>
<span class="nc" id="L978">			String errorMessage</span>
<span class="nc" id="L979">				= MacawMessages.getMessage(&quot;derivedVariable.error.nonExistentVariableAssociation&quot;,</span>
<span class="nc" id="L980">											derivedVariable.getDisplayName(),</span>
<span class="nc" id="L981">											sourceVariable.getDisplayName());</span>
<span class="nc" id="L982">			exception.addErrorMessage(MacawErrorType.NON_EXISTENT_VARIABLE_ASSOCIATION,</span>
									  errorMessage);
<span class="nc" id="L984">			throw exception;</span>
		}
<span class="nc" id="L986">	}</span>
		
	private void checkDocumentAssociationExists(Variable variable,
												SupportingDocument targetSupportingDocument) throws MacawException {

<span class="nc" id="L991">		MacawException exception = new MacawException();</span>
<span class="nc" id="L992">		String errorMessage</span>
<span class="nc" id="L993">			= MacawMessages.getMessage(&quot;variable.error.nonExistentDocumentAssociation&quot;,</span>
<span class="nc" id="L994">										targetSupportingDocument.getDisplayName(),</span>
<span class="nc" id="L995">										variable.getDisplayName());</span>
<span class="nc" id="L996">		exception.addErrorMessage(MacawErrorType.NON_EXISTENT_DOCUMENT_ASSOCIATION,</span>
								  errorMessage);

<span class="nc" id="L999">		ArrayList&lt;SupportingDocument&gt; existingSupportingDocuments</span>
<span class="nc" id="L1000">			= variable.getSupportingDocuments();</span>

<span class="nc" id="L1002">		boolean associationExists = false;</span>
<span class="nc" id="L1003">		int targetIdentifier = targetSupportingDocument.getIdentifier();</span>

<span class="nc bnc" id="L1005" title="All 2 branches missed.">		for (SupportingDocument existingSupportingDocument : existingSupportingDocuments) {</span>
<span class="nc" id="L1006">			int currentIdentifier</span>
<span class="nc" id="L1007">				= existingSupportingDocument.getIdentifier();</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">			if (currentIdentifier == targetIdentifier) {</span>
<span class="nc" id="L1009">				associationExists = true;</span>
<span class="nc" id="L1010">				break;</span>
			}
<span class="nc" id="L1012">		}</span>

<span class="nc bnc" id="L1014" title="All 2 branches missed.">		if (associationExists == false) {</span>
<span class="nc" id="L1015">			throw exception;</span>
		}		
<span class="nc" id="L1017">	}</span>

	private void checkDuplicateDocumentAssociation(Variable variable,
												   SupportingDocument targetSupportingDocument) throws MacawException {
	
<span class="fc" id="L1022">		String errorMessage</span>
<span class="fc" id="L1023">			= MacawMessages.getMessage(&quot;variable.error.duplicateDocumentAssociation&quot;,</span>
<span class="fc" id="L1024">										targetSupportingDocument.getDisplayName(),</span>
<span class="fc" id="L1025">										variable.getDisplayName());</span>
<span class="fc" id="L1026">		MacawException exception </span>
			= new MacawException(MacawErrorType.DUPLICATE_DOCUMENT_ASSOCIATION,
								 errorMessage);

<span class="fc" id="L1030">		ArrayList&lt;SupportingDocument&gt; existingSupportingDocuments</span>
<span class="fc" id="L1031">			= variable.getSupportingDocuments();</span>
<span class="fc bfc" id="L1032" title="All 2 branches covered.">		if (existingSupportingDocuments.size() == 0) {</span>
			//no chance of duplicates because variable doesn't have any
			//supporting documents yet
<span class="fc" id="L1035">			return;</span>
		}

<span class="fc" id="L1038">		boolean duplicateAssociationExists = false;</span>
<span class="fc" id="L1039">		int targetIdentifier = targetSupportingDocument.getIdentifier();</span>

<span class="fc bfc" id="L1041" title="All 2 branches covered.">		for (SupportingDocument existingSupportingDocument : existingSupportingDocuments) {</span>
<span class="fc" id="L1042">			int currentIdentifier = existingSupportingDocument.getIdentifier();</span>
<span class="pc bpc" id="L1043" title="1 of 2 branches missed.">			if (currentIdentifier == targetIdentifier) {</span>
<span class="nc" id="L1044">				duplicateAssociationExists = true;</span>
<span class="nc" id="L1045">				break;</span>
			}
<span class="fc" id="L1047">		}</span>

<span class="pc bpc" id="L1049" title="1 of 2 branches missed.">		if (duplicateAssociationExists == true) {</span>
<span class="nc" id="L1050">			throw exception;</span>
		}		
<span class="fc" id="L1052">	}</span>

	private void checkDuplicateTermAssociation(Variable variable, 
			   								   OntologyTerm ontologyTerm) throws MacawException {

<span class="fc" id="L1057">		Variable originalVariable</span>
<span class="fc" id="L1058">			= (Variable) getOriginalVariable(variable);		</span>
<span class="pc bpc" id="L1059" title="1 of 2 branches missed.">		if (variable.containsOntologyTerm(ontologyTerm) == true) {</span>
			//association already exists
<span class="nc" id="L1061">			String errorMessage</span>
<span class="nc" id="L1062">				= MacawMessages.getMessage(&quot;variable.error.duplicateTermAssociation&quot;,</span>
<span class="nc" id="L1063">											variable.getDisplayName(),</span>
<span class="nc" id="L1064">											ontologyTerm.getDisplayName());</span>
<span class="nc" id="L1065">			MacawException exception </span>
				= new MacawException(MacawErrorType.DUPLICATE_ONTOLOGY_TERM_ASSOCIATION,
									 errorMessage);
<span class="nc" id="L1068">			throw exception;</span>
		}	
<span class="fc" id="L1070">	}</span>

	private void checkTermAssociationExists(Variable variable, 
			   								OntologyTerm ontologyTerm) throws MacawException {

<span class="nc" id="L1075">		Variable originalVariable</span>
<span class="nc" id="L1076">			= (Variable) getOriginalVariable(variable);		</span>
<span class="nc bnc" id="L1077" title="All 2 branches missed.">		if (variable.containsOntologyTerm(ontologyTerm) == false) {</span>
<span class="nc" id="L1078">			MacawException exception = new MacawException();</span>
<span class="nc" id="L1079">			String errorMessage</span>
<span class="nc" id="L1080">				= MacawMessages.getMessage(&quot;variable.error.nonExistentTermAssociation&quot;,</span>
<span class="nc" id="L1081">											variable.getDisplayName(),</span>
<span class="nc" id="L1082">											ontologyTerm.getDisplayName());</span>
<span class="nc" id="L1083">			exception.addErrorMessage(MacawErrorType.NON_EXISTENT_ONTOLOGY_TERM_ASSOCIATION,</span>
									  errorMessage);
<span class="nc" id="L1085">			throw exception;			</span>
		}	
<span class="nc" id="L1087">	}</span>
	
	private void checkListChoices(Variable variable) throws MacawException {
<span class="fc" id="L1090">		Category category = new Category();</span>
<span class="fc" id="L1091">		category.setName(variable.getCategory());</span>
		//listChoiceManager.getCategoryIdentifier(category, variable);

<span class="fc bfc" id="L1094" title="All 2 branches covered.">		if (variable.isCleaned() == true) {</span>
<span class="fc" id="L1095">			CleaningState cleaningState = new CleaningState();</span>
<span class="fc" id="L1096">			cleaningState.setName(variable.getCleaningStatus());</span>
<span class="fc" id="L1097">			listChoiceManager.getCleaningStateIdentifier(cleaningState, variable);</span>
		}

<span class="fc" id="L1100">		AvailabilityState availabilityState = new AvailabilityState();</span>
<span class="fc" id="L1101">		availabilityState.setName(variable.getAvailability());</span>

<span class="fc" id="L1103">		listChoiceManager.getAvailabilityStateIdentifier(availabilityState, variable);</span>
		
<span class="fc" id="L1105">		AliasFilePath aliasFilePath = new AliasFilePath();</span>
<span class="fc" id="L1106">		aliasFilePath.setAlias(variable.getAlias());</span>
<span class="fc" id="L1107">		aliasFilePath.setFilePath(variable.getFilePath());</span>
<span class="fc" id="L1108">		listChoiceManager.getAliasFilePathIdentifier(aliasFilePath, variable);</span>
<span class="fc" id="L1109">	}</span>

	
	// ==========================================
	// Section Interfaces
	// ==========================================

	// ==========================================
	// Section Overload
	// ==========================================

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>