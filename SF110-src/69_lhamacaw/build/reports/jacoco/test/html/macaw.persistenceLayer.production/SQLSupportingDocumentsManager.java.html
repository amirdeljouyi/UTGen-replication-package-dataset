<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLSupportingDocumentsManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">69_lhamacaw</a> &gt; <a href="index.source.html" class="el_package">macaw.persistenceLayer.production</a> &gt; <span class="el_source">SQLSupportingDocumentsManager.java</span></div><h1>SQLSupportingDocumentsManager.java</h1><pre class="source lang-java linenums">package macaw.persistenceLayer.production;


import macaw.businessLayer.*;
import macaw.persistenceLayer.ChangeEventGenerator;
import macaw.system.MacawChangeEvent;
import macaw.system.MacawErrorType;
import macaw.system.MacawException;
import macaw.system.MacawMessages;

import java.sql.*;
import java.util.ArrayList;

/**
 * &lt;p&gt;&lt;/p&gt;
 * &lt;hr&gt;
 * Copyright 2010 Medical Research Council Unit for Lifelong Health and Ageing
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *      http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.  
 * &lt;hr&gt;
 * @author Kevin Garwood (kgarwood@users.sourceforge.net)
 * @version 1.0	
 */

/*
 * Code Road Map:
 * --------------
 * Code is organised into the following sections.  Wherever possible, 
 * methods are classified based on an order of precedence described in 
 * parentheses (..).  For example, if you're trying to find a method 
 * 'getName(...)' that is both an interface method and an accessor 
 * method, the order tells you it should appear under interface.
 * 
 * Order of 
 * Precedence     Section
 * ==========     ======
 * (1)            Section Constants
 * (2)            Section Properties
 * (3)            Section Construction
 * (7)            Section Accessors and Mutators
 * (6)            Section Errors and Validation
 * (5)            Section Interfaces
 * (4)            Section Overload
 *
 */

public class SQLSupportingDocumentsManager extends SQLCurationConceptManager {

	// ==========================================
	// Section Constants
	// ==========================================

	// ==========================================
	// Section Properties
	// ==========================================
	
	// ==========================================
	// Section Construction
	// ==========================================
	public SQLSupportingDocumentsManager(SQLChangeEventManager changeEventManager) {
<span class="fc" id="L68">		super(changeEventManager);</span>
<span class="fc" id="L69">	}</span>
	
	public void createTable(Connection connection) throws MacawException {
<span class="nc" id="L72">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L73">		query.append(&quot;CREATE TABLE supporting_documents (&quot;);</span>
<span class="nc" id="L74">		query.append(&quot;identifier INT AUTO_INCREMENT NOT NULL,&quot;);</span>
<span class="nc" id="L75">		query.append(&quot;title VARCHAR(255) NOT NULL,&quot;);</span>
<span class="nc" id="L76">		query.append(&quot;document_code VARCHAR(255) NOT NULL,&quot;);</span>
<span class="nc" id="L77">		query.append(&quot;description VARCHAR(255),&quot;);</span>
<span class="nc" id="L78">		query.append(&quot;file_name VARCHAR(255),&quot;);</span>
<span class="nc" id="L79">		query.append(&quot;file_path VARCHAR(255),&quot;);</span>
<span class="nc" id="L80">		query.append(&quot;deleted_at DATETIME,&quot;);</span>
<span class="nc" id="L81">		query.append(&quot;PRIMARY KEY(identifier));&quot;);</span>
		
<span class="nc" id="L83">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L85">			statement</span>
<span class="nc" id="L86">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L87">			statement.executeUpdate();							</span>
		}
<span class="nc" id="L89">		catch(SQLException exception) {</span>
<span class="nc" id="L90">			log.logException(exception);</span>
<span class="nc" id="L91">			String errorMessage</span>
<span class="nc" id="L92">				= MacawMessages.getMessage(&quot;sql.error.unableToCreateTables&quot;);</span>
<span class="nc" id="L93">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CREATE_TABLES,
									 errorMessage);
<span class="nc" id="L96">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L99">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}
<span class="nc" id="L101">	}</span>
	
	// ==========================================
	// Section Accessors and Mutators
	// ==========================================

	public ArrayList&lt;SupportingDocument&gt; getAllSupportingDocuments(Connection connection,
																   User user) throws MacawException {

<span class="nc" id="L110">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L111">		query.append(&quot;SELECT identifier,&quot;);</span>
<span class="nc" id="L112">		query.append(&quot;title,&quot;);</span>
<span class="nc" id="L113">		query.append(&quot;document_code,&quot;);		</span>
<span class="nc" id="L114">		query.append(&quot;description,&quot;);</span>
<span class="nc" id="L115">		query.append(&quot;file_name,&quot;);</span>
<span class="nc" id="L116">		query.append(&quot;file_path &quot;);</span>
<span class="nc" id="L117">		query.append(&quot;FROM supporting_documents &quot;);</span>
<span class="nc" id="L118">		query.append(&quot;WHERE deleted_at IS NULL &quot;);</span>
<span class="nc" id="L119">		query.append(&quot;ORDER BY title ASC;&quot;);</span>

<span class="nc" id="L121">		ResultSet resultSet = null;</span>
<span class="nc" id="L122">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L124">			ArrayList&lt;SupportingDocument&gt; results </span>
				= new ArrayList&lt;SupportingDocument&gt;();
<span class="nc" id="L126">			statement</span>
<span class="nc" id="L127">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L128">			resultSet = statement.executeQuery();						</span>

<span class="nc bnc" id="L130" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L131">				SupportingDocument supportingDocument = new SupportingDocument();</span>
<span class="nc" id="L132">				supportingDocument.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L133">				supportingDocument.setTitle(resultSet.getString(2));</span>
<span class="nc" id="L134">				supportingDocument.setDocumentCode(resultSet.getString(3));</span>
<span class="nc" id="L135">				supportingDocument.setDescription(resultSet.getString(4));</span>
<span class="nc" id="L136">				supportingDocument.setFileName(resultSet.getString(5));</span>
<span class="nc" id="L137">				supportingDocument.setFilePath(resultSet.getString(6));</span>
<span class="nc" id="L138">				results.add(supportingDocument);</span>
<span class="nc" id="L139">			}</span>
			
<span class="nc" id="L141">			return results;</span>
		}
<span class="nc" id="L143">		catch(SQLException exception) {</span>
<span class="nc" id="L144">			String errorMessage</span>
<span class="nc" id="L145">				= MacawMessages.getMessage(&quot;sql.error.unableToGetAllSupportingDocuments&quot;);</span>
<span class="nc" id="L146">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ALL_SUPPORTING_DOCUMENTS,
									 errorMessage);
<span class="nc" id="L149">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L152">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
	}



	public void addSupportingDocument(Connection connection,
									  User user,
									  SupportingDocument supportingDocument) throws MacawException {


		//Part I: Validate parameters
		//check basic field errors
<span class="nc" id="L165">		SupportingDocument.validateFields(supportingDocument);	</span>
		//check for duplicates
<span class="nc" id="L167">		checkSupportingDocumentCodeDuplicates(connection, supportingDocument);</span>
<span class="nc" id="L168">		checkSupportingDocumentDuplicates(connection, supportingDocument);</span>

		//Part II: Perform the add supporting document operation
<span class="nc" id="L171">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L172">		query.append(&quot;INSERT INTO supporting_documents &quot;);</span>
<span class="nc" id="L173">		query.append(&quot;(title,&quot;);</span>
<span class="nc" id="L174">		query.append(&quot;document_code,&quot;);</span>
<span class="nc" id="L175">		query.append(&quot;description,&quot;);</span>
<span class="nc" id="L176">		query.append(&quot;file_name,&quot;);</span>
<span class="nc" id="L177">		query.append(&quot;file_path,&quot;);</span>
<span class="nc" id="L178">		query.append(&quot;deleted_at) &quot;);</span>
<span class="nc" id="L179">		query.append(&quot;VALUES (?, ?, ?, ?, ?, ?);&quot;);</span>

<span class="nc" id="L181">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L183">			statement</span>
<span class="nc" id="L184">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L185">			statement.setString(1, supportingDocument.getTitle());</span>
<span class="nc" id="L186">			statement.setString(2, supportingDocument.getDocumentCode());</span>
<span class="nc" id="L187">			statement.setString(3, supportingDocument.getDescription());</span>
<span class="nc" id="L188">			statement.setString(4, supportingDocument.getFileName());</span>
<span class="nc" id="L189">			statement.setString(5, supportingDocument.getFilePath());</span>
<span class="nc" id="L190">			statement.setDate(6, null);</span>
			
<span class="nc" id="L192">			statement.executeUpdate();	</span>
			
			//Part III: Record changes
<span class="nc" id="L195">			ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L196">				= ChangeEventGenerator.addSupportingDocumentChange(user, </span>
																   supportingDocument);
<span class="nc" id="L198">			registerChangeEvents(connection, changeEvents);</span>
		}
<span class="nc" id="L200">		catch(SQLException exception) {</span>
<span class="nc" id="L201">			String errorMessage</span>
<span class="nc" id="L202">				= MacawMessages.getMessage(&quot;sql.error.unableToAddSupportingDocument&quot;,</span>
<span class="nc" id="L203">											supportingDocument.getDisplayName());</span>
<span class="nc" id="L204">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CREATE_SUPPORTING_DOCUMENT,
									 errorMessage);
<span class="nc" id="L207">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L210">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}
<span class="nc" id="L212">	}</span>

	public void updateSupportingDocument(Connection connection,
										 User user,
										 SupportingDocument revisedSupportingDocument) throws MacawException {

		//Part I: Validate parameters
		//check that document exists
<span class="nc" id="L220">		checkSupportingDocumentExists(connection,</span>
									  revisedSupportingDocument);
		//check basic field errors
<span class="nc" id="L223">		SupportingDocument.validateFields(revisedSupportingDocument);		</span>
		//check for duplicates
<span class="nc" id="L225">		checkSupportingDocumentCodeDuplicates(connection,</span>
											  revisedSupportingDocument);
<span class="nc" id="L227">		checkSupportingDocumentDuplicates(connection,</span>
										  revisedSupportingDocument);

		//check that at least one change was made
<span class="nc" id="L231">		SupportingDocument originalSupportingDocument</span>
<span class="nc" id="L232">			= getOriginalSupportingDocument(connection,</span>
											revisedSupportingDocument);
<span class="nc" id="L234">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L235">			= SupportingDocument.detectFieldChanges(user,</span>
													originalSupportingDocument, 
													revisedSupportingDocument);	
<span class="nc bnc" id="L238" title="All 2 branches missed.">		if (changeEvents.size() == 0) {</span>
<span class="nc" id="L239">			return;</span>
		}
		
		//Part II: Perform update operation
<span class="nc" id="L243">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L244">		query.append(&quot;UPDATE supporting_documents &quot;);</span>
<span class="nc" id="L245">		query.append(&quot;SET title = ?,&quot;);</span>
<span class="nc" id="L246">		query.append(&quot;document_code = ?,&quot;);</span>
<span class="nc" id="L247">		query.append(&quot;description = ?,&quot;);</span>
<span class="nc" id="L248">		query.append(&quot;file_name= ?,&quot;);</span>
<span class="nc" id="L249">		query.append(&quot;file_path= ? &quot;);</span>
<span class="nc" id="L250">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L251">		query.append(&quot;identifier=?;&quot;);</span>
		
<span class="nc" id="L253">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L255">			statement</span>
<span class="nc" id="L256">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L257">			statement.setString(1, revisedSupportingDocument.getTitle());</span>
<span class="nc" id="L258">			statement.setString(2, revisedSupportingDocument.getDocumentCode());</span>
<span class="nc" id="L259">			statement.setString(3, revisedSupportingDocument.getDescription());</span>
<span class="nc" id="L260">			statement.setString(4, revisedSupportingDocument.getFileName());</span>
<span class="nc" id="L261">			statement.setString(5, revisedSupportingDocument.getFilePath());</span>
<span class="nc" id="L262">			statement.setInt(6, revisedSupportingDocument.getIdentifier());</span>
<span class="nc" id="L263">			statement.executeUpdate();</span>
			
			//Part III: Record changes
<span class="nc" id="L266">			registerChangeEvents(connection, changeEvents);</span>
		}
<span class="nc" id="L268">		catch(SQLException exception) {</span>
<span class="nc" id="L269">			String errorMessage</span>
<span class="nc" id="L270">				= MacawMessages.getMessage(&quot;sql.error.unableToUpdateSupportingDocument&quot;,</span>
<span class="nc" id="L271">											revisedSupportingDocument.getDisplayName());</span>
<span class="nc" id="L272">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_UPDATE_SUPPORTING_DOCUMENT,
									 errorMessage);
<span class="nc" id="L275">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L278">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}	
<span class="nc" id="L280">	}</span>

	public void deleteSupportingDocuments(Connection connection,
										  User user,
										  ArrayList&lt;SupportingDocument&gt; supportingDocumentsToDelete) throws MacawException {
		
		//Part I: Validate parameters
		//verify that supporting documents are associated with variable
<span class="nc bnc" id="L288" title="All 2 branches missed.">		for (SupportingDocument supportingDocument : supportingDocumentsToDelete) {</span>
<span class="nc" id="L289">			checkSupportingDocumentExists(connection,</span>
										  supportingDocument);
<span class="nc" id="L291">		}</span>

		//Part II: Perform the delete operation
<span class="nc" id="L294">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L295">		query.append(&quot;UPDATE supporting_documents &quot;);</span>
<span class="nc" id="L296">		query.append(&quot;SET deleted_at=NOW() &quot;);</span>
<span class="nc" id="L297">		query.append(&quot;WHERE identifier=?;&quot;);</span>

<span class="nc" id="L299">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L301">			statement</span>
<span class="nc" id="L302">				= connection.prepareStatement(query.toString());</span>

<span class="nc" id="L304">			Time deletionDate = new Time(System.currentTimeMillis());</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			for (SupportingDocument currentSupportingDocument : supportingDocumentsToDelete) {</span>
				//statement.setTime(1, deletionDate);
<span class="nc" id="L307">				statement.setInt(1, currentSupportingDocument.getIdentifier());</span>
<span class="nc" id="L308">				statement.executeUpdate();		</span>
<span class="nc" id="L309">			}		</span>
		}
<span class="nc" id="L311">		catch(SQLException exception) {</span>
<span class="nc" id="L312">			String errorMessage</span>
<span class="nc" id="L313">				= MacawMessages.getMessage(&quot;sql.error.unableToDeleteSupportingDocuments&quot;);</span>
<span class="nc" id="L314">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_DELETE_SUPPORTING_DOCUMENT,
									 errorMessage);
<span class="nc" id="L317">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L320">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}			
<span class="nc" id="L322">	}</span>

	public int getSupportingDocumentIdentifier(Connection connection,
			   								   SupportingDocument supportingDocument) throws MacawException {

<span class="nc" id="L327">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L328">		query.append(&quot;SELECT identifier &quot;);</span>
<span class="nc" id="L329">		query.append(&quot;FROM supporting_documents &quot;);</span>
<span class="nc" id="L330">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L331">		query.append(&quot;title=? AND document_code=?;&quot;);</span>

<span class="nc" id="L333">		ResultSet resultSet = null;</span>
<span class="nc" id="L334">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L336">			statement</span>
<span class="nc" id="L337">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L338">			statement.setString(1, supportingDocument.getTitle());</span>
<span class="nc" id="L339">			statement.setString(2, supportingDocument.getDocumentCode());</span>
<span class="nc" id="L340">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">			if (resultSet.next() == true) {</span>
<span class="nc" id="L342">				return resultSet.getInt(1);</span>
			}
			else {
<span class="nc" id="L345">				return -1;</span>
			}
		}
<span class="nc" id="L348">		catch(SQLException exception) {</span>
<span class="nc" id="L349">			String errorMessage</span>
<span class="nc" id="L350">				= MacawMessages.getMessage(&quot;sql.error.unableToGetSupportingDocumentIdentifier&quot;);</span>
<span class="nc" id="L351">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_SUPPORTING_DOCUMENT_IDENTIFIER,
									 errorMessage);
<span class="nc" id="L354">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L357">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
	}

	public void clear(Connection connection) throws MacawException {

<span class="nc" id="L363">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L365">			statement</span>
<span class="nc" id="L366">				= connection.prepareStatement(&quot;DELETE FROM supporting_documents;&quot;);</span>
<span class="nc" id="L367">			statement.executeUpdate();</span>
		}
<span class="nc" id="L369">		catch(SQLException exception) {</span>
<span class="nc" id="L370">			exception.printStackTrace(System.out);</span>
<span class="nc" id="L371">			String errorMessage</span>
<span class="nc" id="L372">				= MacawMessages.getMessage(&quot;sql.error.unableToClearTable&quot;);</span>
<span class="nc" id="L373">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_CLEAR_TABLE,
									 errorMessage);
<span class="nc" id="L376">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L379">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}
<span class="nc" id="L381">	}</span>

	// ==========================================
	// Section Errors and Validation
	// ==========================================
	public void checkSupportingDocumentExists(Connection connection,
											  SupportingDocument targetSupportingDocument) throws MacawException {

<span class="nc" id="L389">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L390">		query.append(&quot;SELECT 1 &quot;);</span>
<span class="nc" id="L391">		query.append(&quot;FROM supporting_documents &quot;);</span>
<span class="nc" id="L392">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L393">		query.append(&quot;identifier=?;&quot;);</span>
		
<span class="nc" id="L395">		ResultSet resultSet = null;</span>
<span class="nc" id="L396">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L398">			statement</span>
<span class="nc" id="L399">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L400">			statement.setInt(1, targetSupportingDocument.getIdentifier());</span>
<span class="nc" id="L401">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">			if (resultSet.next() == false) {</span>
				//items have same display name but different IDs. Therefore
				//the candidate is a duplicate
<span class="nc" id="L405">				String errorMessage</span>
<span class="nc" id="L406">					= MacawMessages.getMessage(&quot;general.error.nonExistentItem&quot;,</span>
<span class="nc" id="L407">												targetSupportingDocument.getDisplayName());</span>
<span class="nc" id="L408">				MacawException exception</span>
					= new MacawException(MacawErrorType.NON_EXISTENT_SUPPORTING_DOCUMENT,
										 errorMessage);
<span class="nc" id="L411">				throw exception;</span>
			}
		}
<span class="nc" id="L414">		catch(SQLException exception) {</span>
<span class="nc" id="L415">			String errorMessage</span>
<span class="nc" id="L416">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckSupportingDocumentExists&quot;);</span>
<span class="nc" id="L417">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_DOCUMENT_EXISTS,
									 errorMessage);
<span class="nc" id="L420">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L423">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}					
<span class="nc" id="L425">	}</span>

	private void checkSupportingDocumentDuplicates(Connection connection,
			   								   	   SupportingDocument candidateSupportingDocument) throws MacawException {

		
<span class="nc" id="L431">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L432">		query.append(&quot;SELECT identifier &quot;);</span>
<span class="nc" id="L433">		query.append(&quot;FROM supporting_documents &quot;);</span>
<span class="nc" id="L434">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L435">		query.append(&quot;title=? AND document_code=?;&quot;);</span>

<span class="nc" id="L437">		ResultSet resultSet = null;</span>
<span class="nc" id="L438">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L440">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L441">			statement.setString(1, candidateSupportingDocument.getTitle());</span>
<span class="nc" id="L442">			statement.setString(2, candidateSupportingDocument.getDocumentCode());</span>
<span class="nc" id="L443">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">			if (resultSet.next() == true) {</span>
<span class="nc" id="L445">				int resultIdentifier = resultSet.getInt(1);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">				if (resultIdentifier != candidateSupportingDocument.getIdentifier()) {</span>
					//items have same display name but different IDs. Therefore
					//the candidate is a duplicate
<span class="nc" id="L449">					String errorMessage</span>
<span class="nc" id="L450">						= MacawMessages.getMessage(&quot;valueLabel.error.duplicateExists&quot;,</span>
<span class="nc" id="L451">													candidateSupportingDocument.getDisplayName());</span>
<span class="nc" id="L452">					MacawException exception</span>
						= new MacawException(MacawErrorType.DUPLICATE_VALUE_LABEL,
											 errorMessage);
<span class="nc" id="L455">					throw exception;</span>
				}
			}
		}
<span class="nc" id="L459">		catch(SQLException exception) {</span>
<span class="nc" id="L460">			String errorMessage</span>
<span class="nc" id="L461">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckDocumentDuplicates&quot;);</span>
<span class="nc" id="L462">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_DOCUMENT_DUPLICATES,
									 errorMessage);
<span class="nc" id="L465">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L468">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
<span class="nc" id="L470">	}</span>

	private void checkSupportingDocumentCodeDuplicates(Connection connection,
			  										   SupportingDocument supportingDocument) throws MacawException {
	
<span class="nc" id="L475">		StringBuilder query = new StringBuilder();</span>

<span class="nc" id="L477">		ResultSet resultSet = null;</span>
<span class="nc" id="L478">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L480">			query.append(&quot;SELECT identifier &quot;);</span>
<span class="nc" id="L481">			query.append(&quot;FROM supporting_documents &quot;);</span>
<span class="nc" id="L482">			query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L483">			query.append(&quot;document_code=?;&quot;);</span>
<span class="nc" id="L484">			statement</span>
<span class="nc" id="L485">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L486">			statement.setString(1, supportingDocument.getDocumentCode());</span>
<span class="nc" id="L487">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">			if (resultSet.next() == true) {</span>
<span class="nc" id="L489">				int resultIdentifier = resultSet.getInt(1);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">				if (resultIdentifier != supportingDocument.getIdentifier()) {				</span>
					//items have same display name but different IDs. Therefore
					//the candidate is a duplicate
<span class="nc" id="L493">					String errorMessage</span>
<span class="nc" id="L494">						= MacawMessages.getMessage(&quot;supportingDocument.error.duplicateDocumentCodeExists&quot;,</span>
<span class="nc" id="L495">													supportingDocument.getDocumentCode());</span>
<span class="nc" id="L496">					MacawException exception </span>
						= new MacawException(MacawErrorType.DUPLICATE_SUPPORTING_DOCUMENT_CODE,
											errorMessage);
<span class="nc" id="L499">					throw exception;</span>
				}
			}
		}
<span class="nc" id="L503">		catch(SQLException exception) {</span>
<span class="nc" id="L504">			String errorMessage</span>
<span class="nc" id="L505">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckDocumentCodeDuplicates&quot;);</span>
<span class="nc" id="L506">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_DOCUMENT_DUPLICATES,
									 errorMessage);
<span class="nc" id="L509">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L512">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
<span class="nc" id="L514">	}</span>

	public SupportingDocument getOriginalSupportingDocument(Connection connection,
															SupportingDocument targetSupportingDocument) throws MacawException {

		
<span class="nc" id="L520">		checkSupportingDocumentExists(connection,</span>
				   					  targetSupportingDocument);

<span class="nc" id="L523">		int identifier = targetSupportingDocument.getIdentifier();</span>
<span class="nc" id="L524">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L525">		query.append(&quot;SELECT title,&quot;);</span>
<span class="nc" id="L526">		query.append(&quot;document_code,&quot;);</span>
<span class="nc" id="L527">		query.append(&quot;description,&quot;);</span>
<span class="nc" id="L528">		query.append(&quot;file_name,&quot;);</span>
<span class="nc" id="L529">		query.append(&quot;file_path &quot;);</span>
<span class="nc" id="L530">		query.append(&quot;FROM supporting_documents &quot;);</span>
<span class="nc" id="L531">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L532">		query.append(&quot;identifier=?;&quot;);</span>
<span class="nc" id="L533">		ResultSet resultSet = null;</span>
<span class="nc" id="L534">		PreparedStatement statement = null;</span>

		try {
<span class="nc" id="L537">			statement</span>
<span class="nc" id="L538">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L539">			statement.setInt(1, identifier);</span>
<span class="nc" id="L540">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L541">			resultSet.next();</span>
<span class="nc" id="L542">			SupportingDocument originalSupportingDocument</span>
				= new SupportingDocument();
<span class="nc" id="L544">			originalSupportingDocument.setIdentifier(identifier);</span>
<span class="nc" id="L545">			originalSupportingDocument.setTitle(resultSet.getString(1));</span>
<span class="nc" id="L546">			originalSupportingDocument.setDescription(resultSet.getString(2));</span>
<span class="nc" id="L547">			originalSupportingDocument.setTitle(resultSet.getString(3));</span>
<span class="nc" id="L548">			originalSupportingDocument.setTitle(resultSet.getString(4));</span>
<span class="nc" id="L549">			originalSupportingDocument.setTitle(resultSet.getString(5));</span>
<span class="nc" id="L550">			return originalSupportingDocument;</span>
		}
<span class="nc" id="L552">		catch(SQLException exception) {</span>
<span class="nc" id="L553">			String errorMessage</span>
<span class="nc" id="L554">				= MacawMessages.getMessage(&quot;sql.error.unableToGetOriginalDocument&quot;);</span>
<span class="nc" id="L555">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ORIGINAL_SUPPORTING_DOCUMENT,
									 errorMessage);
<span class="nc" id="L558">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L561">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
	}
	
	// ==========================================
	// Section Interfaces
	// ==========================================

	// ==========================================
	// Section Overload
	// ==========================================

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>