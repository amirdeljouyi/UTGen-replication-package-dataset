<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductionCurationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">69_lhamacaw</a> &gt; <a href="index.source.html" class="el_package">macaw.persistenceLayer.production</a> &gt; <span class="el_source">ProductionCurationService.java</span></div><h1>ProductionCurationService.java</h1><pre class="source lang-java linenums">package macaw.persistenceLayer.production;

import macaw.businessLayer.*;
import macaw.persistenceLayer.*;
import macaw.system.*;

import java.sql.*;
import java.util.ArrayList;


/**
 * Implements the interface {@link macaw.businessLayer.MacawCurationAPI} as a curation service
 * which stores data in a MySQL database.  The structure of ProductionCurationService
 * is very similar to that of {@link macaw.persistenceLayer.demo.DemonstrationCurationService}.
 * Both classes delegate handling API calls to manager classes that are each designed
 * to support a major concept from the package &lt;code&gt;macaw.model&lt;/code&gt; 
 * (eg: {@link macaw.businessLayer.SupportingDocument}, {@link macaw.businessLayer.Variable}, 
 * {@link macaw.businessLayer.User}) 
 * &lt;hr&gt;
 * Copyright 2010 Medical Research Council Unit for Lifelong Health and Ageing
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *      http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.  
 * &lt;hr&gt;
 * @author Kevin Garwood (kgarwood@users.sourceforge.net)
 * @version 1.0	
 */

/*
 * Code Road Map:
 * --------------
 * Code is organised into the following sections.  Wherever possible, 
 * methods are classified based on an order of precedence described in 
 * parentheses (..).  For example, if you're trying to find a method 
 * 'getName(...)' that is both an interface method and an accessor 
 * method, the order tells you it should appear under interface.
 * 
 * Order of 
 * Precedence     Section
 * ==========     ======
 * (1)            Section Constants
 * (2)            Section Properties
 * (3)            Section Construction
 * (7)            Section Accessors and Mutators
 * (6)            Section Errors and Validation
 * (5)            Section Interfaces
 * (4)            Section Overload
 *
 */

public class ProductionCurationService implements MacawCurationAPI {
	
	// ==========================================
	// Section Constants
	// ==========================================

	// ==========================================
	// Section Properties
	// ==========================================
	private SQLConnectionManager sqlConnectionManager;
	private SQLFilterQueries filterQueries;
	private SQLListChoiceManager listChoiceManager;
	private SQLSupportingDocumentsManager documentsManager;
	private SQLValueLabelManager valueLabelsManager;
	private SQLChangeEventManager changeEventManager;
	private SQLUserManager userManager;
	private SQLVariableManager variableManager;
	private SQLOntologyTermManager ontologyTermManager;
	private MacawSecurityAPI securityValidationService;
	private Log log;
	// ==========================================
	// Section Construction
	// ==========================================
<span class="fc" id="L80">	public ProductionCurationService(SessionProperties sessionProperties) throws MacawException {</span>
<span class="fc" id="L81">		changeEventManager = new SQLChangeEventManager(sessionProperties.getLog());</span>

<span class="fc" id="L83">		sqlConnectionManager </span>
			= new SQLConnectionManager(sessionProperties);
<span class="fc" id="L85">		userManager = new SQLUserManager(changeEventManager,</span>
										 sqlConnectionManager);
<span class="fc" id="L87">		securityValidationService = userManager;</span>
<span class="fc" id="L88">		sessionProperties.setProperty(SessionProperties.SECURITY_SERVICE, securityValidationService);</span>
		
<span class="fc" id="L90">		log = sessionProperties.getLog();</span>
<span class="fc" id="L91">		userManager.setLog(log);</span>
		
<span class="fc" id="L93">		documentsManager </span>
			= new SQLSupportingDocumentsManager(changeEventManager);
<span class="fc" id="L95">		documentsManager.setLog(log);</span>
<span class="fc" id="L96">		listChoiceManager </span>
			= new SQLListChoiceManager(changeEventManager);
<span class="fc" id="L98">		listChoiceManager.setLog(log);</span>
<span class="fc" id="L99">		valueLabelsManager </span>
			= new SQLValueLabelManager(changeEventManager);
<span class="fc" id="L101">		valueLabelsManager.setLog(log);</span>
		
<span class="fc" id="L103">		ontologyTermManager</span>
			= new SQLOntologyTermManager(changeEventManager);
<span class="fc" id="L105">		ontologyTermManager.setLog(log);</span>

<span class="fc" id="L107">		filterQueries </span>
			= new SQLFilterQueries(log, listChoiceManager);
		
<span class="fc" id="L110">		variableManager</span>
			= new SQLVariableManager(changeEventManager,
									 listChoiceManager,
									 ontologyTermManager,
									 documentsManager);
<span class="fc" id="L115">		variableManager.setLog(log);</span>
<span class="fc" id="L116">	}</span>
		
	// ==========================================
	// Section Accessors and Mutators
	// ==========================================

	// ==========================================
	// Section Errors and Validation
	// ==========================================

	// ==========================================
	// Section Interfaces
	// ==========================================
	
	public void addRawVariable(User user,
							   RawVariable rawVariable) throws MacawException {
		
<span class="nc" id="L133">		checkValidUser(user);</span>
<span class="nc" id="L134">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L136">			initialiseConnection(connection);</span>
<span class="nc" id="L137">			variableManager.addRawVariable(connection,</span>
										   user,
										   rawVariable);
<span class="nc" id="L140">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L142">		catch(MacawException exception) {</span>
<span class="nc" id="L143">			rollBack(connection);</span>
<span class="nc" id="L144">			throw exception;</span>
		}
		finally {
<span class="nc" id="L147">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L149">	}</span>
	
	public void deleteRawVariables(User user,
				  				   ArrayList&lt;RawVariable&gt; rawVariables) throws MacawException {

<span class="nc" id="L154">		checkValidUser(user);</span>
<span class="nc" id="L155">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L157">			initialiseConnection(connection);</span>
<span class="nc" id="L158">			variableManager.deleteRawVariables(connection,</span>
											   user,
											   rawVariables);
<span class="nc" id="L161">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L163">		catch(MacawException exception) {</span>
<span class="nc" id="L164">			rollBack(connection);</span>
<span class="nc" id="L165">			throw exception;</span>
		}
		finally {
<span class="nc" id="L168">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L170">	}</span>
	
	public void updateRawVariable(User user,
								  RawVariable rawVariable) throws MacawException {
	
<span class="nc" id="L175">		checkValidUser(user);</span>
<span class="nc" id="L176">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L178">			initialiseConnection(connection);</span>
<span class="nc" id="L179">			variableManager.updateRawVariable(connection,</span>
											  user,
											  rawVariable);
<span class="nc" id="L182">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L184">		catch(MacawException exception) {</span>
<span class="nc" id="L185">			rollBack(connection);</span>
<span class="nc" id="L186">			throw exception;</span>
		}
		finally {
<span class="nc" id="L189">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L191">	}</span>

	
	public int getRawVariableIdentifier(User user,
										RawVariable rawVariable) throws MacawException {

<span class="nc" id="L197">		checkValidUser(user);</span>
<span class="nc" id="L198">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L200">			return variableManager.getRawVariableIdentifier(connection,</span>
															user,
															rawVariable);
		}
		finally {
<span class="nc" id="L205">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public void addDerivedVariable(User user,
								   DerivedVariable derivedVariable) throws MacawException {
	

<span class="nc" id="L213">		checkValidUser(user);</span>
<span class="nc" id="L214">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L216">			initialiseConnection(connection);</span>
<span class="nc" id="L217">			variableManager.addDerivedVariable(connection,</span>
											   user,
											   derivedVariable);
<span class="nc" id="L220">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L222">		catch(MacawException exception) {</span>
<span class="nc" id="L223">			rollBack(connection);</span>
<span class="nc" id="L224">			throw exception;</span>
		}
		finally {
<span class="nc" id="L227">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L229">	}</span>
	
	public void deleteDerivedVariables(User user,
				  	  				   ArrayList&lt;DerivedVariable&gt; derivedVariables) throws MacawException {
	
<span class="nc" id="L234">		checkValidUser(user);</span>
<span class="nc" id="L235">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L237">			initialiseConnection(connection);</span>
<span class="nc" id="L238">			variableManager.deleteDerivedVariables(connection,</span>
											   	   user,
											   	   derivedVariables);
<span class="nc" id="L241">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L243">		catch(MacawException exception) {</span>
<span class="nc" id="L244">			rollBack(connection);	</span>
<span class="nc" id="L245">			throw exception;</span>
		}
		finally {
<span class="nc" id="L248">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L250">	}</span>
	
	public void updateDerivedVariable(User user,
									  DerivedVariable derivedVariable) throws MacawException {

<span class="nc" id="L255">		checkValidUser(user);</span>
<span class="nc" id="L256">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L258">			initialiseConnection(connection);</span>
<span class="nc" id="L259">			variableManager.updateDerivedVariable(connection,</span>
											   	  user,
											   	  derivedVariable);
<span class="nc" id="L262">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L264">		catch(MacawException exception) {</span>
<span class="nc" id="L265">			rollBack(connection);</span>
<span class="nc" id="L266">			throw exception;</span>
		}
		finally {
<span class="nc" id="L269">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L271">	}</span>

	public int getDerivedVariableIdentifier(User user,
											DerivedVariable derivedVariable) throws MacawException {

<span class="nc" id="L276">		checkValidUser(user);</span>
<span class="nc" id="L277">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L279">			return variableManager.getDerivedVariableIdentifier(connection,</span>
																user,
																derivedVariable);
		}
		finally {
<span class="nc" id="L284">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public Variable getVariable(User user, String variableName) throws MacawException {

<span class="nc" id="L290">		checkValidUser(user);</span>
<span class="nc" id="L291">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L293">			Variable variable = variableManager.getVariable(connection, variableName);</span>
<span class="nc" id="L294">			return variable;</span>
		}
		finally {
<span class="nc" id="L297">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public Variable getOriginalVariable(User user, Variable variable) throws MacawException {
<span class="nc" id="L302">		checkValidUser(user);</span>

<span class="nc" id="L304">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L306">			return variableManager.getOriginalVariable(connection, variable);</span>
		}
		finally {
<span class="nc" id="L309">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public ArrayList&lt;ValueLabel&gt; getValueLabels(User user,
			   									Variable variable) throws MacawException {

<span class="nc" id="L316">		checkValidUser(user);</span>
<span class="nc" id="L317">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L319">			return valueLabelsManager.getValueLabels(connection, </span>
													 user,
													 variable); 
		}
		finally {
<span class="nc" id="L324">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	public void addValueLabels(User user,
			   				   Variable variable,
			   				   ArrayList&lt;ValueLabel&gt; valueLabels) throws MacawException {

<span class="nc" id="L332">		checkValidUser(user);</span>
<span class="nc" id="L333">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L335">			initialiseConnection(connection);</span>
<span class="nc" id="L336">			valueLabelsManager.addValueLabels(connection, </span>
											  user,
											  variable, 
											  valueLabels);
<span class="nc" id="L340">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L342">		catch(MacawException exception) {</span>
<span class="nc" id="L343">			rollBack(connection);</span>
<span class="nc" id="L344">			throw exception;</span>
		}
		finally {
<span class="nc" id="L347">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L349">	}</span>
	
	public void updateValueLabels(User user,
								  Variable variable,
								  ArrayList&lt;ValueLabel&gt; valueLabels) throws MacawException {

<span class="nc" id="L355">		checkValidUser(user);</span>
<span class="nc" id="L356">		Connection connection = sqlConnectionManager.getConnection();</span>

		try {
<span class="nc" id="L359">			initialiseConnection(connection);</span>
<span class="nc" id="L360">			valueLabelsManager.updateValueLabels(connection, </span>
											 	 user,
											 	 variable, 
											 	 valueLabels);
<span class="nc" id="L364">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L366">		catch(MacawException exception) {</span>
<span class="nc" id="L367">			rollBack(connection);</span>
<span class="nc" id="L368">			throw exception;</span>
		}
		finally {
<span class="nc" id="L371">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L373">	}</span>

	public void deleteValueLabels(User user,
								  Variable variable,
								  ArrayList&lt;ValueLabel&gt; valueLabels) throws MacawException {
	

<span class="nc" id="L380">		checkValidUser(user);</span>
<span class="nc" id="L381">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L383">			initialiseConnection(connection);</span>
<span class="nc" id="L384">			valueLabelsManager.deleteValueLabels(connection, </span>
											 	 user,
											 	 variable, 
											 	 valueLabels);
<span class="nc" id="L388">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L390">		catch(MacawException exception) {</span>
<span class="nc" id="L391">			rollBack(connection);</span>
<span class="nc" id="L392">			throw exception;</span>
		}
		finally {
<span class="nc" id="L395">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L397">	}</span>

	public int getValueLabelIdentifier(User user,
			  						   Variable variable,
			  						   ValueLabel valueLabel) throws MacawException {

<span class="nc" id="L403">		checkValidUser(user);</span>
<span class="nc" id="L404">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L406">			return valueLabelsManager.getValueLabelIdentifier(connection, </span>
						 	 								  variable, 
						 	 								  valueLabel);
		}
		finally {
<span class="nc" id="L411">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public ArrayList&lt;SupportingDocument&gt; getAllSupportingDocuments(User user) throws MacawException {

<span class="nc" id="L417">		checkValidUser(user);</span>
<span class="nc" id="L418">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L420">			ArrayList&lt;SupportingDocument&gt; results</span>
<span class="nc" id="L421">				= documentsManager.getAllSupportingDocuments(connection, </span>
														  	 user);
<span class="nc" id="L423">			return results;</span>
		}
		finally {
<span class="nc" id="L426">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public ArrayList&lt;SupportingDocument&gt; getSupportingDocuments(User user,
																Variable variable) throws MacawException{
	

<span class="nc" id="L434">		checkValidUser(user);</span>
<span class="nc" id="L435">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L437">			ArrayList&lt;SupportingDocument&gt; results</span>
<span class="nc" id="L438">				= variableManager.getAssociatedSupportingDocuments(connection, </span>
																   user,
																   variable);
<span class="nc" id="L441">			return results;</span>
		}
		finally {
<span class="nc" id="L444">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public void addSupportingDocument(User user,
									  SupportingDocument supportingDocument) throws MacawException{
		
<span class="nc" id="L451">		checkValidUser(user);</span>
<span class="nc" id="L452">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L454">			initialiseConnection(connection);</span>
<span class="nc" id="L455">			documentsManager.addSupportingDocument(connection,</span>
												   user,
												   supportingDocument);
<span class="nc" id="L458">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L460">		catch(MacawException exception) {</span>
<span class="nc" id="L461">			rollBack(connection);</span>
<span class="nc" id="L462">			throw exception;</span>
		}
		finally {
<span class="nc" id="L465">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L467">	}</span>
	
	public void updateSupportingDocument(User user,
										 SupportingDocument supportingDocument) throws MacawException{
		
<span class="nc" id="L472">		checkValidUser(user);</span>
<span class="nc" id="L473">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L475">			initialiseConnection(connection);</span>
<span class="nc" id="L476">			documentsManager.updateSupportingDocument(connection,</span>
													  user,
												  	  supportingDocument);
<span class="nc" id="L479">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L481">		catch(MacawException exception) {</span>
<span class="nc" id="L482">			rollBack(connection);</span>
<span class="nc" id="L483">			throw exception;</span>
		}
		finally {
<span class="nc" id="L486">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L488">	}</span>
	
	public void deleteSupportingDocuments(User user,
										  ArrayList&lt;SupportingDocument&gt; supportingDocuments) throws MacawException{
		
<span class="nc" id="L493">		checkValidUser(user);</span>
<span class="nc" id="L494">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L496">			initialiseConnection(connection);</span>
<span class="nc" id="L497">			documentsManager.deleteSupportingDocuments(connection,</span>
													   user,
												  	   supportingDocuments);
<span class="nc" id="L500">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L502">		catch(MacawException exception) {</span>
<span class="nc" id="L503">			rollBack(connection);</span>
<span class="nc" id="L504">			throw exception;</span>
		}
		finally {
<span class="nc" id="L507">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L509">	}</span>
	
	public int getSupportingDocumentIdentifier(User user,
			  								   SupportingDocument supportingDocument) throws MacawException{

<span class="nc" id="L514">		checkValidUser(user);</span>
<span class="nc" id="L515">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L517">			return documentsManager.getSupportingDocumentIdentifier(connection,</span>
																	supportingDocument);
		}
		finally {
<span class="nc" id="L521">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
		
	public void associateSupportingDocumentsWithVariable(User user,
														 Variable variable,
														 ArrayList&lt;SupportingDocument&gt; supportingDocuments) throws MacawException{

<span class="nc" id="L529">		checkValidUser(user);</span>
<span class="nc" id="L530">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L532">			initialiseConnection(connection);</span>
<span class="nc" id="L533">			variableManager.associateSupportingDocuments(connection,</span>
														 user,
												  		 variable,
												  		 supportingDocuments);
<span class="nc" id="L537">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L539">		catch(MacawException exception) {</span>
<span class="nc" id="L540">			rollBack(connection);</span>
<span class="nc" id="L541">			throw exception;</span>
		}
		finally {
<span class="nc" id="L544">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L546">	}</span>
	
	public void disassociateSupportingDocumentsFromVariable(User user,
														 	Variable variable,
														 	ArrayList&lt;SupportingDocument&gt; supportingDocuments) throws MacawException{

<span class="nc" id="L552">		checkValidUser(user);</span>
<span class="nc" id="L553">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L555">			initialiseConnection(connection);</span>
<span class="nc" id="L556">			variableManager.disassociateSupportingDocuments(connection,</span>
															user,
															variable,
															supportingDocuments);
<span class="nc" id="L560">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L562">		catch(MacawException exception) {</span>
<span class="nc" id="L563">			rollBack(connection);</span>
<span class="nc" id="L564">			throw exception;</span>
		}
		finally {
<span class="nc" id="L567">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L569">	}</span>

	public ArrayList&lt;Variable&gt; getSourceVariables(User user,
												  DerivedVariable derivedVariable) throws MacawException {

<span class="nc" id="L574">		checkValidUser(user);</span>
<span class="nc" id="L575">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L577">			return variableManager.getSourceVariables(connection,</span>
													  user,
											   		  derivedVariable);
		}
		finally {
<span class="nc" id="L582">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public void associateSourceVariables(User user,
										 DerivedVariable derivedVariable,
										 ArrayList&lt;Variable&gt; sourceVariablesToAdd) throws MacawException {

<span class="nc" id="L590">		checkValidUser(user);</span>
<span class="nc" id="L591">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L593">			initialiseConnection(connection);</span>
<span class="nc" id="L594">			variableManager.associateSourceVariables(connection,</span>
													 user,
													 derivedVariable,
													 sourceVariablesToAdd);
<span class="nc" id="L598">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L600">		catch(MacawException exception) {</span>
<span class="nc" id="L601">			rollBack(connection);</span>
<span class="nc" id="L602">			throw exception;</span>
		}
		finally {
<span class="nc" id="L605">			sqlConnectionManager.releaseConnection(connection);</span>
		}	
<span class="nc" id="L607">	}</span>

	public void disassociateSourceVariables(User user,
											DerivedVariable derivedVariable,
											ArrayList&lt;Variable&gt; sourceVariablesToDelete) throws MacawException {
		
<span class="nc" id="L613">		checkValidUser(user);</span>
<span class="nc" id="L614">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L616">			initialiseConnection(connection);</span>
<span class="nc" id="L617">			variableManager.disassociateSourceVariables(connection,</span>
														user,
												  		derivedVariable,
												  		sourceVariablesToDelete);
<span class="nc" id="L621">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L623">		catch(MacawException exception) {</span>
<span class="nc" id="L624">			rollBack(connection);</span>
<span class="nc" id="L625">			throw exception;</span>
		}
		finally {
<span class="nc" id="L628">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L630">	}</span>

	public String[] getStudyYears(User user) throws MacawException {
<span class="nc" id="L633">		checkValidUser(user);</span>
<span class="nc" id="L634">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L636">			return variableManager.getStudyYears(connection);</span>
		}
		finally {
<span class="nc" id="L639">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public ArrayList&lt;VariableSummary&gt; getSummaryDataForAllVariables(User user) throws MacawException {
<span class="nc" id="L644">		checkValidUser(user);</span>
<span class="nc" id="L645">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L647">			return variableManager.getSummaryDataForAllVariables(connection);</span>
		}
		finally {
<span class="nc" id="L650">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public Variable getCompleteVariableData(User user, VariableSummary variableSummary) throws MacawException {
<span class="nc" id="L655">		checkValidUser(user);</span>
<span class="nc" id="L656">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L658">			return variableManager.getCompleteVariableData(connection, </span>
														   user, 
														   variableSummary);
		}
		finally {
<span class="nc" id="L663">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public ArrayList&lt;Category&gt; getCategories(User user) throws MacawException {
<span class="nc" id="L668">		checkValidUser(user);</span>
<span class="nc" id="L669">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L671">			return listChoiceManager.getCategories(connection, user);</span>
		}
		finally {
<span class="nc" id="L674">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public void addCategory(User user, 
							Category category) throws MacawException {

<span class="nc" id="L681">		checkValidUser(user);</span>
<span class="nc" id="L682">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L684">			initialiseConnection(connection);</span>
<span class="nc" id="L685">			listChoiceManager.addCategory(connection, </span>
										  user,
										  category);
<span class="nc" id="L688">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L690">		catch(MacawException exception) {</span>
<span class="nc" id="L691">			rollBack(connection);</span>
<span class="nc" id="L692">			throw exception;</span>
		}
		finally {
<span class="nc" id="L695">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L697">	}</span>
	
	public void updateCategory(User user, 
							   Category category) throws MacawException {

<span class="nc" id="L702">		checkValidUser(user);</span>
<span class="nc" id="L703">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L705">			initialiseConnection(connection);</span>
<span class="nc" id="L706">			listChoiceManager.updateCategory(connection, </span>
											 user,
											 category);
<span class="nc" id="L709">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L711">		catch(MacawException exception) {</span>
<span class="nc" id="L712">			rollBack(connection);</span>
<span class="nc" id="L713">			throw exception;</span>
		}
		finally {
<span class="nc" id="L716">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L718">	}</span>
	
	public void deleteCategories(User user, 
								 ArrayList&lt;Category&gt; categories) throws MacawException {

<span class="nc" id="L723">		checkValidUser(user);</span>
<span class="nc" id="L724">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L726">			initialiseConnection(connection);</span>
<span class="nc" id="L727">			listChoiceManager.deleteCategories(connection, user, categories);</span>
<span class="nc" id="L728">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L730">		catch(MacawException exception) {</span>
<span class="nc" id="L731">			rollBack(connection);</span>
<span class="nc" id="L732">			throw exception;</span>
		}
		finally {
<span class="nc" id="L735">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L737">	}</span>

	public int getCategoryIdentifier(User user,
									 Variable variable,
				  					 Category category) throws MacawException {

<span class="nc" id="L743">		checkValidUser(user);</span>
<span class="nc" id="L744">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L746">			return listChoiceManager.getCategoryIdentifier(connection, </span>
														   variable,
														   category);
		}
		finally {
<span class="nc" id="L751">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	/**
	 * Methods for data libraries
	 */
	public ArrayList&lt;AliasFilePath&gt; getAliasFilePaths(User user) throws MacawException {		

<span class="nc" id="L760">		checkValidUser(user);</span>
<span class="nc" id="L761">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L763">			return listChoiceManager.getAliasFilePaths(connection);</span>
		}
		finally {
<span class="nc" id="L766">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	public void addAliasFilePath(User user, 
			 				   AliasFilePath aliasFilePath) throws MacawException {
		
<span class="nc" id="L773">		checkValidUser(user);</span>
<span class="nc" id="L774">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L776">			initialiseConnection(connection);</span>
<span class="nc" id="L777">			listChoiceManager.addAliasFilePath(connection, aliasFilePath);</span>
<span class="nc" id="L778">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L780">		catch(MacawException exception) {</span>
<span class="nc" id="L781">			rollBack(connection);</span>
<span class="nc" id="L782">			throw exception;</span>
		}
		finally {
<span class="nc" id="L785">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L787">	}</span>
	
	public void updateAliasFilePath(User user, 
								  AliasFilePath aliasFilePath) throws MacawException {
		
<span class="nc" id="L792">		checkValidUser(user);</span>
<span class="nc" id="L793">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L795">			initialiseConnection(connection);</span>
<span class="nc" id="L796">			listChoiceManager.updateAliasFilePath(connection, </span>
												  user,
												  aliasFilePath);
<span class="nc" id="L799">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L801">		catch(MacawException exception) {</span>
<span class="nc" id="L802">			rollBack(connection);</span>
<span class="nc" id="L803">			throw exception;</span>
		}
		finally {
<span class="nc" id="L806">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L808">	}</span>
	
	public void deleteAliasFilePaths(User user, 
				 					ArrayList&lt;AliasFilePath&gt; aliasFilePaths) throws MacawException {

<span class="nc" id="L813">		checkValidUser(user);</span>
<span class="nc" id="L814">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L816">			initialiseConnection(connection);</span>
<span class="nc" id="L817">			listChoiceManager.deleteAliasFilePaths(connection, aliasFilePaths);</span>
<span class="nc" id="L818">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L820">		catch(MacawException exception) {</span>
<span class="nc" id="L821">			rollBack(connection);</span>
<span class="nc" id="L822">			throw exception;</span>
		}
		finally {
<span class="nc" id="L825">			sqlConnectionManager.releaseConnection(connection);</span>
		}	
<span class="nc" id="L827">	}</span>

	public int getAliasFilePathIdentifier(User user, 
									      Variable variable,
									      AliasFilePath aliasFilePath) throws MacawException {

<span class="nc" id="L833">		checkValidUser(user);</span>
<span class="nc" id="L834">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L836">			return listChoiceManager.getAliasFilePathIdentifier(connection, </span>
																variable,
																aliasFilePath);
		}
		finally {
<span class="nc" id="L841">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	public String getFilePathFromAlias(User user,
									   String currentAlias) throws MacawException {
		
<span class="nc" id="L848">		checkValidUser(user);</span>
<span class="nc" id="L849">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L851">			return listChoiceManager.getFilePathFromAlias(connection, </span>
														  currentAlias);
		}
		finally {
<span class="nc" id="L855">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	/**
	 * Methods for managing cleaning states
	 */
	public ArrayList&lt;CleaningState&gt; getCleaningStates(User user) throws MacawException {	

<span class="nc" id="L864">		checkValidUser(user);</span>
<span class="nc" id="L865">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L867">			return listChoiceManager.getCleaningStates(connection, user);</span>
		}
		finally {
<span class="nc" id="L870">			sqlConnectionManager.releaseConnection(connection);</span>
		}	
	}

	public void addCleaningState(User user, 
			 					 CleaningState cleaningState) throws MacawException {
		
<span class="nc" id="L877">		checkValidUser(user);</span>
<span class="nc" id="L878">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L880">			initialiseConnection(connection);</span>
<span class="nc" id="L881">			listChoiceManager.addCleaningState(connection, cleaningState);</span>
<span class="nc" id="L882">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L884">		catch(MacawException exception) {</span>
<span class="nc" id="L885">			rollBack(connection);</span>
<span class="nc" id="L886">			throw exception;</span>
		}
		finally {
<span class="nc" id="L889">			sqlConnectionManager.releaseConnection(connection);</span>
		}	
<span class="nc" id="L891">	}</span>
	
	public void updateCleaningState(User user, 
									CleaningState cleaningState) throws MacawException {

<span class="nc" id="L896">		checkValidUser(user);</span>
<span class="nc" id="L897">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L899">			initialiseConnection(connection);</span>
<span class="nc" id="L900">			listChoiceManager.updateCleaningState(connection, user, cleaningState);</span>
<span class="nc" id="L901">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L903">		catch(MacawException exception) {</span>
<span class="nc" id="L904">			rollBack(connection);</span>
<span class="nc" id="L905">			throw exception;</span>
		}
		finally {
<span class="nc" id="L908">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L910">	}</span>
	
	public void deleteCleaningStates(User user, 
				 					 ArrayList&lt;CleaningState&gt; cleaningStates) throws MacawException {
		
<span class="nc" id="L915">		checkValidUser(user);</span>
<span class="nc" id="L916">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L918">			initialiseConnection(connection);</span>
<span class="nc" id="L919">			listChoiceManager.deleteCleaningStates(connection, cleaningStates);</span>
<span class="nc" id="L920">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L922">		catch(MacawException exception) {</span>
<span class="nc" id="L923">			rollBack(connection);</span>
<span class="nc" id="L924">			throw exception;</span>
		}
		finally {
<span class="nc" id="L927">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L929">	}</span>

	public int getCleaningStateIdentifier(User user, 
										  Variable variable,
										  CleaningState cleaningState) throws MacawException {

<span class="nc" id="L935">		checkValidUser(user);</span>
<span class="nc" id="L936">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L938">			return listChoiceManager.getCleaningStateIdentifier(connection, </span>
																variable,
																cleaningState);
		}
		finally {
<span class="nc" id="L943">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}
	
	/**
	 * Methods for managing availability states
	 */
	public ArrayList&lt;AvailabilityState&gt; getAvailabilityStates(User user) throws MacawException {
<span class="nc" id="L951">		checkValidUser(user);</span>
<span class="nc" id="L952">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L954">			return listChoiceManager.getAvailabilityStates(connection);</span>
		}
		finally {
<span class="nc" id="L957">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	public void addAvailabilityState(User user, 
			 						 AvailabilityState availabilityState) throws MacawException {

<span class="nc" id="L964">		checkValidUser(user);</span>
<span class="nc" id="L965">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L967">			initialiseConnection(connection);</span>
<span class="nc" id="L968">			listChoiceManager.addAvailabilityState(connection,</span>
												   user,
												   availabilityState);
<span class="nc" id="L971">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L973">		catch(MacawException exception) {</span>
<span class="nc" id="L974">			rollBack(connection);</span>
<span class="nc" id="L975">			throw exception;</span>
		}
		finally {
<span class="nc" id="L978">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L980">	}</span>
	
	public void updateAvailabilityState(User user, 
										AvailabilityState availabilityState) throws MacawException {

<span class="nc" id="L985">		checkValidUser(user);</span>
<span class="nc" id="L986">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L988">			initialiseConnection(connection);</span>
<span class="nc" id="L989">			listChoiceManager.updateAvailabilityState(connection, availabilityState);</span>
<span class="nc" id="L990">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L992">		catch(MacawException exception) {</span>
<span class="nc" id="L993">			rollBack(connection);</span>
<span class="nc" id="L994">			throw exception;</span>
		}
		finally {
<span class="nc" id="L997">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L999">	}</span>
	
	public void deleteAvailabilityStates(User user, 
								   		 ArrayList&lt;AvailabilityState&gt; availabilityStates) throws MacawException {

<span class="nc" id="L1004">		checkValidUser(user);</span>
<span class="nc" id="L1005">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1007">			initialiseConnection(connection);</span>
<span class="nc" id="L1008">			listChoiceManager.deleteAvailabilityStates(connection, availabilityStates);</span>
<span class="nc" id="L1009">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1011">		catch(MacawException exception) {</span>
<span class="nc" id="L1012">			rollBack(connection);</span>
<span class="nc" id="L1013">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1016">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L1018">	}</span>

	public int getAvailabilityStateIdentifier(User user, 
											  Variable variable,
	   		 								  AvailabilityState availabilityState) throws MacawException {

<span class="nc" id="L1024">		checkValidUser(user);</span>
<span class="nc" id="L1025">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1027">			return listChoiceManager.getAvailabilityStateIdentifier(connection, </span>
																	variable,
																	availabilityState);
		}
		finally {
<span class="nc" id="L1032">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	public ArrayList&lt;VariableSummary&gt; filterVariableSummaries(User user,
			   										  		  String searchText,
			   										  		  String year,
			   										  		  String category,
			   										  		  VariableTypeFilter variableTypeFilter) throws MacawException {

<span class="nc" id="L1042">		checkValidUser(user);</span>
<span class="nc" id="L1043">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1045">			return filterQueries.filterVariableSummaries(connection,</span>
														 searchText,
														 year,
														 category,
														 variableTypeFilter);
		}
		finally {
<span class="nc" id="L1052">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}
	
	public ArrayList&lt;SupportingDocument&gt; filterSupportingDocuments(User user,
			   													   String documentTitle,
			   													   String documentCode) throws MacawException {

<span class="nc" id="L1060">		checkValidUser(user);</span>
<span class="nc" id="L1061">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1063">			return filterQueries.filterSupportingDocuments(connection,</span>
														   documentTitle,
														   documentCode);
		}
		finally {
<span class="nc" id="L1068">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	public ArrayList&lt;OntologyTerm&gt; filterOntologyTerms(User user,
													   String term,
													   String description) throws MacawException {

<span class="nc" id="L1076">		checkValidUser(user);</span>
<span class="nc" id="L1077">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1079">			return filterQueries.filterOntologyTerms(connection,</span>
													 term,
													 description);
		}
		finally {
<span class="nc" id="L1084">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}
	
	public ArrayList&lt;OntologyTerm&gt; getAllOntologyTerms(User user) throws MacawException {

<span class="nc" id="L1090">		checkValidUser(user);</span>
<span class="nc" id="L1091">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1093">			return ontologyTermManager.getAllOntologyTerms(connection,</span>
														   user);
		}
		finally {
<span class="nc" id="L1097">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public ArrayList&lt;OntologyTerm&gt; getOntologyTerms(User user,
													Variable variable) throws MacawException {

<span class="nc" id="L1104">		checkValidUser(user);</span>
<span class="nc" id="L1105">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1107">			return variableManager.getAssociatedOntologyTerms(connection,</span>
															  user,
															  variable);
		}
		finally {
<span class="nc" id="L1112">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public void addOntologyTerm(User user,
								OntologyTerm ontologyTerm) throws MacawException {

<span class="nc" id="L1119">		checkValidUser(user);</span>
<span class="nc" id="L1120">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1122">			initialiseConnection(connection);</span>
<span class="nc" id="L1123">			ontologyTermManager.addOntologyTerm(connection,</span>
												user,
												ontologyTerm);
<span class="nc" id="L1126">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1128">		catch(MacawException exception) {</span>
<span class="nc" id="L1129">			rollBack(connection);</span>
<span class="nc" id="L1130">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1133">			sqlConnectionManager.releaseConnection(connection);</span>
		}				
<span class="nc" id="L1135">	}</span>
	
	public void updateOntologyTerm(User user,
								   OntologyTerm ontologyTerm) throws MacawException {

<span class="nc" id="L1140">		checkValidUser(user);</span>
<span class="nc" id="L1141">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1143">			initialiseConnection(connection);</span>
<span class="nc" id="L1144">			ontologyTermManager.updateOntologyTerm(connection,</span>
												   user,
												   ontologyTerm);
<span class="nc" id="L1147">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1149">		catch(MacawException exception) {</span>
<span class="nc" id="L1150">			rollBack(connection);</span>
<span class="nc" id="L1151">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1154">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L1156">	}</span>
	
	public void deleteOntologyTerms(User user,
								    ArrayList&lt;OntologyTerm&gt; ontologyTermsToDelete) throws MacawException {

<span class="nc" id="L1161">		checkValidUser(user);</span>
<span class="nc" id="L1162">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1164">			initialiseConnection(connection);</span>
<span class="nc" id="L1165">			ontologyTermManager.deleteOntologyTerms(connection,</span>
												    user,
												    ontologyTermsToDelete);
<span class="nc" id="L1168">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1170">		catch(MacawException exception) {</span>
<span class="nc" id="L1171">			rollBack(connection);</span>
<span class="nc" id="L1172">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1175">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L1177">	}</span>

	public int getOntologyTermIdentifier(User user,
		    							 OntologyTerm ontologyTerm) throws MacawException {

<span class="nc" id="L1182">		checkValidUser(user);</span>
<span class="nc" id="L1183">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1185">			return ontologyTermManager.getOntologyTermIdentifier(connection,</span>
																 ontologyTerm);
		}
		finally {
<span class="nc" id="L1189">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public void associateOntologyTermsWithVariable(User user,
										   		   Variable variable,
										   		   ArrayList&lt;OntologyTerm&gt; ontologyTerms) throws MacawException {

<span class="nc" id="L1197">		checkValidUser(user);</span>
<span class="nc" id="L1198">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1200">			initialiseConnection(connection);</span>
<span class="nc" id="L1201">			variableManager.associateOntologyTerms(connection,</span>
												   user,
												   variable,
												   ontologyTerms);
<span class="nc" id="L1205">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1207">		catch(MacawException exception) {</span>
<span class="nc" id="L1208">			rollBack(connection);</span>
<span class="nc" id="L1209">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1212">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L1214">	}</span>
	
	public void disassociateOntologyTermsFromVariable(User user,
	   	  											  Variable variable,
	   	  											  ArrayList&lt;OntologyTerm&gt; ontologyTerms) throws MacawException {

<span class="nc" id="L1220">		checkValidUser(user);</span>
<span class="nc" id="L1221">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1223">			initialiseConnection(connection);</span>
<span class="nc" id="L1224">			variableManager.disassociateOntologyTerms(connection,</span>
													  user,
													  variable,
													  ontologyTerms);
<span class="nc" id="L1228">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1230">		catch(MacawException exception) {</span>
<span class="nc" id="L1231">			rollBack(connection);</span>
<span class="nc" id="L1232">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1235">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L1237">	}</span>

	public ArrayList&lt;MacawChangeEvent&gt; getChangeHistoryForVariable(User user,
				   												   Variable variable) throws MacawException {

<span class="nc" id="L1242">		checkValidUser(user);</span>
<span class="nc" id="L1243">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1245">			return changeEventManager.getChangeHistoryForVariable(connection,</span>
																  variable);
		}
		finally {
<span class="nc" id="L1249">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}
	public ArrayList&lt;MacawChangeEvent&gt; getChangeHistoryForSupportingDocument(User user,
																			 SupportingDocument supportingDocument) throws MacawException {

<span class="nc" id="L1255">		checkValidUser(user);</span>
<span class="nc" id="L1256">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1258">			return changeEventManager.getChangeHistoryForSupportingDocument(connection,</span>
																			supportingDocument);
		}
		finally {
<span class="nc" id="L1262">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	public ArrayList&lt;MacawChangeEvent&gt; getChangeHistoryForValueLabels(User user,
																	  Variable variable) throws MacawException {

<span class="nc" id="L1269">		checkValidUser(user);</span>
<span class="nc" id="L1270">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1272">			return changeEventManager.getChangeHistoryForValueLabels(connection,</span>
																	 variable);
		}
		finally {
<span class="nc" id="L1276">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public ArrayList&lt;MacawChangeEvent&gt; getChangeHistoryForListChoices(User user) throws MacawException {
<span class="nc" id="L1281">		checkValidUser(user);</span>
<span class="nc" id="L1282">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1284">			return changeEventManager.getChangeHistoryForListChoices(connection);</span>
		}
		finally {
<span class="nc" id="L1287">			sqlConnectionManager.releaseConnection(connection);</span>
		}	
	}

	
	public ArrayList&lt;MacawChangeEvent&gt; getChangeHistoryByUser(User user) throws MacawException {
<span class="nc" id="L1293">		checkValidUser(user);</span>
<span class="nc" id="L1294">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1296">			return changeEventManager.getChangeHistoryForUser(connection,</span>
															  user);
		}
		finally {
<span class="nc" id="L1300">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public ArrayList&lt;User&gt; getUsers(User admin) throws MacawException {
<span class="nc" id="L1305">		checkValidAdministrator(admin);</span>
<span class="nc" id="L1306">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1308">			return userManager.getUsers(admin);</span>
		}
		finally {
<span class="nc" id="L1311">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public void addUser(User admin, 
						User user) throws MacawException {
<span class="nc" id="L1317">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1319">			initialiseConnection(connection);</span>
<span class="nc" id="L1320">			userManager.addUser(connection, </span>
								admin, 
								user);
<span class="nc" id="L1323">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1325">		catch(MacawException exception) {</span>
<span class="nc" id="L1326">			rollBack(connection);</span>
<span class="nc" id="L1327">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1330">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L1332">	}</span>
	
	public void updateUser(User admin, User user) throws MacawException {
<span class="nc" id="L1335">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1337">			initialiseConnection(connection);</span>
<span class="nc" id="L1338">			userManager.updateUser(connection, </span>
									admin,
									user);
<span class="nc" id="L1341">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1343">		catch(MacawException exception) {</span>
<span class="nc" id="L1344">			rollBack(connection);</span>
<span class="nc" id="L1345">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1348">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L1350">	}</span>
	
	public void deleteUsers(User admin, ArrayList&lt;User&gt; usersToDelete) throws MacawException {
<span class="nc" id="L1353">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1355">			initialiseConnection(connection);</span>
<span class="nc" id="L1356">			userManager.deleteUsers(connection, </span>
									admin,
									usersToDelete);
<span class="nc" id="L1359">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1361">		catch(MacawException exception) {</span>
<span class="nc" id="L1362">			rollBack(connection);</span>
<span class="nc" id="L1363">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1366">			sqlConnectionManager.releaseConnection(connection);</span>
		}				
<span class="nc" id="L1368">	}</span>

	public int getUserIdentifier(User admin, 
								 User user) throws MacawException {
		
<span class="nc" id="L1373">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1375">			return userManager.getUserIdentifier(connection, </span>
												 admin,
												 user);
		}
		finally {
<span class="nc" id="L1380">			sqlConnectionManager.releaseConnection(connection);</span>
		}				
	}
		
	public void checkValidAdministrator(User admin) throws MacawException {
<span class="nc" id="L1385">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1387">			securityValidationService.validateAdministrator(admin);</span>
		}
		finally {
<span class="nc" id="L1390">			sqlConnectionManager.releaseConnection(connection);</span>
		}				
<span class="nc" id="L1392">	}</span>
	
	public void clear(User admin) throws MacawException {
<span class="nc" id="L1395">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {			
<span class="nc" id="L1397">			initialiseConnection(connection);</span>
<span class="nc" id="L1398">			checkValidAdministrator(admin);</span>

<span class="nc" id="L1400">			changeEventManager.clear(connection);</span>
<span class="nc" id="L1401">			userManager.clear(connection);</span>
<span class="nc" id="L1402">			valueLabelsManager.clear(connection);</span>
<span class="nc" id="L1403">			listChoiceManager.clear(connection);</span>
<span class="nc" id="L1404">			documentsManager.clear(connection);</span>
<span class="nc" id="L1405">			ontologyTermManager.clear(connection);</span>
<span class="nc" id="L1406">			variableManager.clear(connection);</span>
<span class="nc" id="L1407">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1409">		catch(MacawException exception) {</span>
<span class="nc" id="L1410">			rollBack(connection);</span>
<span class="nc" id="L1411">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1414">			sqlConnectionManager.releaseConnection(connection);</span>
		}
<span class="nc" id="L1416">	}</span>
	
	public void clearAllChanges(User admin) throws MacawException {
<span class="nc" id="L1419">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1421">			securityValidationService.validateAdministrator(admin);</span>
<span class="nc" id="L1422">			changeEventManager.clearAllChanges(connection);</span>
		}
		finally {
<span class="nc" id="L1425">			sqlConnectionManager.releaseConnection(connection);</span>
		}				
<span class="nc" id="L1427">	}</span>
	
	public ArrayList&lt;MacawChangeEvent&gt; getAllChanges(User admin) throws MacawException {
<span class="nc" id="L1430">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1432">			securityValidationService.validateAdministrator(admin);</span>
<span class="nc" id="L1433">			return changeEventManager.getAllChanges(connection);</span>
		}
		finally {
<span class="nc" id="L1436">			sqlConnectionManager.releaseConnection(connection);</span>
		}				
	}


	public Variable getAlternativeVariable(User user,
			   Variable targetVariable) throws MacawException {
<span class="nc" id="L1443">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1445">			securityValidationService.validateAdministrator(user);</span>
<span class="nc" id="L1446">			return variableManager.getAlternativeVariable(connection, user, targetVariable);</span>
		}
		finally {
<span class="nc" id="L1449">			sqlConnectionManager.releaseConnection(connection);</span>
		}				
	}

	public void setAlternativeVariable(User user, 
									   Variable targetVariable,
									   Variable alternativeVariable) throws MacawException {

<span class="nc" id="L1457">		Connection connection = sqlConnectionManager.getConnection();</span>
		try {
<span class="nc" id="L1459">			initialiseConnection(connection);</span>
<span class="nc" id="L1460">			checkValidUser(user);</span>
<span class="nc" id="L1461">			variableManager.setAlternativeVariable(connection, </span>
												   user, 
												   targetVariable,
												   alternativeVariable);
<span class="nc" id="L1465">			commitDatabaseChanges(connection);</span>
		}
<span class="nc" id="L1467">		catch(MacawException exception) {</span>
<span class="nc" id="L1468">			rollBack(connection);</span>
<span class="nc" id="L1469">			throw exception;</span>
		}
		finally {
<span class="nc" id="L1472">			sqlConnectionManager.releaseConnection(connection);</span>
		}			
<span class="nc" id="L1474">	}</span>
	
	public void checkValidUser(User user) throws MacawException {
<span class="nc" id="L1477">		securityValidationService.validateUser(user);		</span>
<span class="nc" id="L1478">	}</span>

	public int getNumberOfConnections() {
<span class="nc" id="L1481">		return sqlConnectionManager.getNumberOfConnections();</span>
	}
	
	
	public void initialiseConnection(Connection connection) throws MacawException {
		try {
<span class="nc" id="L1487">			connection.setAutoCommit(false);</span>
		}
<span class="nc" id="L1489">		catch(SQLException exception) {</span>
<span class="nc" id="L1490">			log.logException(exception);</span>
<span class="nc" id="L1491">			String errorMessage</span>
<span class="nc" id="L1492">				= MacawMessages.getMessage(&quot;sql.error.unableToInitialiseConnection&quot;);</span>
<span class="nc" id="L1493">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_INITIALISE_CONNECTION,
									 errorMessage);
<span class="nc" id="L1496">			throw macawException;</span>
<span class="nc" id="L1497">		}	</span>
<span class="nc" id="L1498">	}</span>

	public void commitDatabaseChanges(Connection connection) throws MacawException {
		try {
<span class="nc" id="L1502">			connection.commit();</span>
<span class="nc" id="L1503">			connection.setAutoCommit(true);</span>
		}
<span class="nc" id="L1505">		catch(SQLException exception) {</span>
<span class="nc" id="L1506">			log.logException(exception);</span>
<span class="nc" id="L1507">			String errorMessage</span>
<span class="nc" id="L1508">				= MacawMessages.getMessage(&quot;sql.error.unableToCommitChanges&quot;);</span>
<span class="nc" id="L1509">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_COMMIT_CHANGES,
									 errorMessage);
<span class="nc" id="L1512">			throw macawException;</span>
<span class="nc" id="L1513">		}</span>
<span class="nc" id="L1514">	}</span>

	
	public void rollBack(Connection connection) throws MacawException {
		try {
<span class="nc" id="L1519">			connection.rollback();</span>
<span class="nc" id="L1520">			connection.setAutoCommit(true);</span>
		}
<span class="nc" id="L1522">		catch(SQLException exception) {</span>
<span class="nc" id="L1523">			log.logException(exception);</span>
<span class="nc" id="L1524">			String errorMessage</span>
<span class="nc" id="L1525">				= MacawMessages.getMessage(&quot;sql.error.unableToRollbackChanges&quot;);</span>
<span class="nc" id="L1526">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_ROLLBACK,
									 errorMessage);
<span class="nc" id="L1529">			throw macawException;</span>
<span class="nc" id="L1530">		}</span>
<span class="nc" id="L1531">	}</span>
	
	// ==========================================
	// Section Overload
	// ==========================================

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>