<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLVariableManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">69_lhamacaw</a> &gt; <a href="index.source.html" class="el_package">macaw.persistenceLayer.production</a> &gt; <span class="el_source">SQLVariableManager.java</span></div><h1>SQLVariableManager.java</h1><pre class="source lang-java linenums">package macaw.persistenceLayer.production;

import java.sql.*;
import java.util.ArrayList;

import macaw.businessLayer.*;
import macaw.persistenceLayer.ChangeEventGenerator;
import macaw.system.*;

/**
 * &lt;p&gt;&lt;/p&gt;
 * &lt;hr&gt;
 * Copyright 2010 Medical Research Council Unit for Lifelong Health and Ageing
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *      http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.  
 * &lt;hr&gt;
 * @author Kevin Garwood (kgarwood@users.sourceforge.net)
 * @version 1.0	
 */

/*
 * Code Road Map:
 * --------------
 * Code is organised into the following sections.  Wherever possible, 
 * methods are classified based on an order of precedence described in 
 * parentheses (..).  For example, if you're trying to find a method 
 * 'Name(...)' that is both an interface method and an accessor 
 * method, the order tells you it should appear under interface.
 * 
 * Order of 
 * Precedence     Section
 * ==========     ======
 * (1)            Section Constants
 * (2)            Section Properties
 * (3)            Section Construction
 * (7)            Section Accessors and Mutators
 * (6)            Section Errors and Validation
 * (5)            Section Interfaces
 * (4)            Section Overload
 *
 */

public class SQLVariableManager extends SQLCurationConceptManager {

	// ==========================================
	// Section Constants
	// ==========================================

	// ==========================================
	// Section Properties
	// ==========================================
	private SQLListChoiceManager listChoiceManager;
	private SQLOntologyTermManager ontologyTermManager;
	private SQLSupportingDocumentsManager supportingDocumentsManager;
	
	// ==========================================
	// Section Construction
	// ==========================================
	public SQLVariableManager(SQLChangeEventManager changeEventManager,
							  SQLListChoiceManager listChoiceManager,
							  SQLOntologyTermManager ontologyTermManager,
							  SQLSupportingDocumentsManager supportingDocumentsManager) {
<span class="fc" id="L70">		super(changeEventManager);</span>
<span class="fc" id="L71">		this.listChoiceManager = listChoiceManager;</span>
<span class="fc" id="L72">		this.ontologyTermManager = ontologyTermManager;</span>
<span class="fc" id="L73">		this.supportingDocumentsManager = supportingDocumentsManager;</span>
<span class="fc" id="L74">	}</span>
	// ==========================================
	// Section Accessors and Mutators
	// ==========================================

	public void createTables(Connection connection) throws MacawException {
		try {
			//creating tables to support all variables
<span class="nc" id="L82">			createVariablesTable(connection);</span>
			//createRawVariablesTable(connection);
			
			//creates source variables for the benefit of managing derived variables
<span class="nc" id="L86">			createSupportingDocumentsForVariables(connection);</span>
<span class="nc" id="L87">			createOntologyTermsForVariablesTable(connection);</span>
<span class="nc" id="L88">			createSourceVariablesTable(connection);		</span>
		}
<span class="nc" id="L90">		catch(SQLException exception) {</span>
<span class="nc" id="L91">			log.logException(exception);</span>
<span class="nc" id="L92">			String errorMessage</span>
<span class="nc" id="L93">				= MacawMessages.getMessage(&quot;sql.error.unableToCreateTables&quot;);</span>
<span class="nc" id="L94">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CREATE_TABLES,
									 errorMessage);
<span class="nc" id="L97">			throw macawException;</span>
<span class="nc" id="L98">		}</span>
<span class="nc" id="L99">	}</span>
	
	private void createVariablesTable(Connection connection) throws  SQLException {
<span class="nc" id="L102">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L103">		query.append(&quot;CREATE TABLE variables (&quot;);</span>
<span class="nc" id="L104">		query.append(&quot;identifier INT AUTO_INCREMENT NOT NULL,&quot;);</span>
<span class="nc" id="L105">		query.append(&quot;category_id INT,&quot;);</span>
<span class="nc" id="L106">		query.append(&quot;name VARCHAR(255),&quot;);</span>
<span class="nc" id="L107">		query.append(&quot;year VARCHAR(255),&quot;);</span>
<span class="nc" id="L108">		query.append(&quot;form VARCHAR(255),&quot;);</span>
<span class="nc" id="L109">		query.append(&quot;question_number VARCHAR(255),&quot;);</span>
<span class="nc" id="L110">		query.append(&quot;label VARCHAR(255),&quot;);</span>
<span class="nc" id="L111">		query.append(&quot;is_coded BOOLEAN,&quot;);</span>
<span class="nc" id="L112">		query.append(&quot;is_cleaned BOOLEAN,&quot;);</span>
<span class="nc" id="L113">		query.append(&quot;cleaning_status_id INT,&quot;);</span>
<span class="nc" id="L114">		query.append(&quot;cleaning_description VARCHAR(255),&quot;);</span>
<span class="nc" id="L115">		query.append(&quot;availability_id INT,&quot;);</span>
<span class="nc" id="L116">		query.append(&quot;code_book_number VARCHAR(255),&quot;);</span>
<span class="nc" id="L117">		query.append(&quot;column_start VARCHAR(255),&quot;);</span>
<span class="nc" id="L118">		query.append(&quot;column_end VARCHAR(255),&quot;);</span>
<span class="nc" id="L119">		query.append(&quot;alias_id INT,&quot;);</span>
<span class="nc" id="L120">		query.append(&quot;file_path VARCHAR(255),&quot;);</span>
<span class="nc" id="L121">		query.append(&quot;notes VARCHAR(255),&quot;);</span>
<span class="nc" id="L122">		query.append(&quot;is_derived_variable BOOLEAN,&quot;);</span>
<span class="nc" id="L123">		query.append(&quot;alternative_variable_id INT,&quot;);</span>
<span class="nc" id="L124">		query.append(&quot;deleted_at DATETIME,&quot;);</span>
<span class="nc" id="L125">		query.append(&quot;PRIMARY KEY(identifier));&quot;);</span>
		
<span class="nc" id="L127">		PreparedStatement statement = null;</span>
<span class="nc" id="L128">		statement</span>
<span class="nc" id="L129">			= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L130">		statement.executeUpdate();							</span>
<span class="nc" id="L131">	}</span>

	public void createSupportingDocumentsForVariables(Connection connection) throws SQLException {
<span class="nc" id="L134">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L135">		query.append(&quot;CREATE TABLE supporting_documents_for_variables (&quot;);</span>
<span class="nc" id="L136">		query.append(&quot;identifier INT AUTO_INCREMENT NOT NULL,&quot;);</span>
<span class="nc" id="L137">		query.append(&quot;variable_id INT NOT NULL,&quot;);</span>
<span class="nc" id="L138">		query.append(&quot;document_id INT NOT NULL,&quot;);</span>
<span class="nc" id="L139">		query.append(&quot;PRIMARY KEY(identifier));&quot;);</span>
<span class="nc" id="L140">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L142">			statement</span>
<span class="nc" id="L143">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L144">			statement.executeUpdate();							</span>
		}
		finally {
<span class="nc bnc" id="L147" title="All 2 branches missed.">			if (statement != null) {</span>
<span class="nc" id="L148">				statement.close();</span>
			}
		}		
<span class="nc" id="L151">	}</span>

	public void createOntologyTermsForVariablesTable(Connection connection) throws SQLException {

<span class="nc" id="L155">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L156">		query.append(&quot;CREATE TABLE ontology_terms_for_variables (&quot;);</span>
<span class="nc" id="L157">		query.append(&quot;identifier INT AUTO_INCREMENT NOT NULL,&quot;);</span>
<span class="nc" id="L158">		query.append(&quot;ontology_term_id INT NOT NULL,&quot;);</span>
<span class="nc" id="L159">		query.append(&quot;variable_id INT NOT NULL,&quot;);</span>
<span class="nc" id="L160">		query.append(&quot;PRIMARY KEY(identifier));&quot;);</span>

<span class="nc" id="L162">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L164">			statement</span>
<span class="nc" id="L165">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L166">			statement.executeUpdate();							</span>
		}
		finally {
<span class="nc bnc" id="L169" title="All 2 branches missed.">			if (statement != null) {</span>
<span class="nc" id="L170">				statement.close();</span>
			}
		}		
<span class="nc" id="L173">	}</span>
	
	/**
	 * we don't need to create a derivedVariables table because there are no 
	 * concepts beyond the ones in Variables we need to retain.  The exception is
	 * the list of source variables for each derived variable but that is handled in 
	 * a separate table.
	 */
	
	/**
	 * stores associations of source variables with derived variables.
	 * These links correspond to these methods in {@link macaw.businessLayer.Variable}:
	 * &lt;ul&gt;
	 * &lt;li&gt;&lt;code&gt;addSourceVariable(Variable sourceVariable)&lt;/code&gt;&lt;/li&gt;
	 * &lt;li&gt;&lt;code&gt;removeSourceVariables(ArrayList&lt;Variable&gt; variablesToDelete);&lt;/code&gt;&lt;/li&gt;
	 * &lt;li&gt;...&lt;/li&gt;
	 * &lt;/ul&gt;
	 */
	public void createSourceVariablesTable(Connection connection) throws  SQLException {
<span class="nc" id="L192">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L193">		query.append(&quot;CREATE TABLE source_variables (&quot;);</span>
<span class="nc" id="L194">		query.append(&quot;identifier INT AUTO_INCREMENT NOT NULL,&quot;);</span>
<span class="nc" id="L195">		query.append(&quot;derived_variable_id INT NOT NULL,&quot;);</span>
<span class="nc" id="L196">		query.append(&quot;source_variable_id INT NOT NULL,&quot;);</span>
<span class="nc" id="L197">		query.append(&quot;PRIMARY KEY(identifier));&quot;);</span>
		
<span class="nc" id="L199">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L201">			statement</span>
<span class="nc" id="L202">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L203">			statement.executeUpdate();							</span>
		}
		finally {
<span class="nc bnc" id="L206" title="All 2 branches missed.">			if (statement != null) {</span>
<span class="nc" id="L207">				statement.close();</span>
			}
		}		
<span class="nc" id="L210">	}</span>

	public void addRawVariable(Connection connection,
							   User user,
							   RawVariable rawVariable) throws MacawException {
		
		//Part I: Validate parameters
<span class="nc" id="L217">		RawVariable.validateFields(rawVariable);</span>
<span class="nc" id="L218">		checkVariableDuplicates(connection, rawVariable);</span>
<span class="nc" id="L219">		checkListChoices(connection, rawVariable);</span>
		//check that at least one change was made.
<span class="nc" id="L221">		addVariable(connection, user, rawVariable);</span>
<span class="nc" id="L222">	}</span>

	public void addDerivedVariable(Connection connection,
								   User user,
								   DerivedVariable derivedVariable) throws MacawException {

		//Part I: Validate parameters
<span class="nc" id="L229">		DerivedVariable.validateFields(derivedVariable);</span>
<span class="nc" id="L230">		checkVariableDuplicates(connection, derivedVariable);</span>
<span class="nc" id="L231">		checkListChoices(connection, derivedVariable);</span>
		
		//check that at least one change was made.
<span class="nc" id="L234">		addVariable(connection, user, derivedVariable);</span>
<span class="nc" id="L235">	}</span>
	
	private int addVariable(Connection connection,
							User user,
							Variable variable) throws MacawException {
		
<span class="nc" id="L241">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L242">		query.append(&quot;INSERT INTO variables &quot;);</span>
<span class="nc" id="L243">		query.append(&quot;(category_id,&quot;);</span>
<span class="nc" id="L244">		query.append(&quot;name,&quot;);</span>
<span class="nc" id="L245">		query.append(&quot;year,&quot;);</span>
<span class="nc" id="L246">		query.append(&quot;form,&quot;);</span>
<span class="nc" id="L247">		query.append(&quot;question_number,&quot;);</span>
<span class="nc" id="L248">		query.append(&quot;label,&quot;);</span>
<span class="nc" id="L249">		query.append(&quot;is_coded,&quot;);</span>
<span class="nc" id="L250">		query.append(&quot;is_cleaned,&quot;);</span>
<span class="nc" id="L251">		query.append(&quot;cleaning_status_id,&quot;);</span>
<span class="nc" id="L252">		query.append(&quot;cleaning_description,&quot;);</span>
<span class="nc" id="L253">		query.append(&quot;availability_id,&quot;);</span>
<span class="nc" id="L254">		query.append(&quot;code_book_number,&quot;);</span>
<span class="nc" id="L255">		query.append(&quot;column_start,&quot;);</span>
<span class="nc" id="L256">		query.append(&quot;column_end,&quot;);</span>
<span class="nc" id="L257">		query.append(&quot;alias_id,&quot;);</span>
<span class="nc" id="L258">		query.append(&quot;file_path,&quot;);</span>
<span class="nc" id="L259">		query.append(&quot;notes,&quot;);</span>
<span class="nc" id="L260">		query.append(&quot;is_derived_variable,&quot;);</span>
<span class="nc" id="L261">		query.append(&quot;alternative_variable_id,&quot;);</span>
<span class="nc" id="L262">		query.append(&quot;deleted_at) &quot;);</span>
<span class="nc" id="L263">		query.append(&quot;VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);&quot;);</span>
		
<span class="nc" id="L265">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L267">			statement</span>
<span class="nc" id="L268">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L269">			Category category = new Category();</span>
<span class="nc" id="L270">			category.setName(variable.getCategory());</span>
<span class="nc" id="L271">			int categoryID</span>
<span class="nc" id="L272">				= listChoiceManager.getCategoryIdentifier(connection,</span>
														  variable,
														  category);			
<span class="nc" id="L275">			statement.setInt(1, categoryID);</span>
<span class="nc" id="L276">			statement.setString(2, variable.getName());</span>
<span class="nc" id="L277">			statement.setString(3, variable.getYear());</span>
<span class="nc" id="L278">			statement.setString(4, variable.getForm());</span>
<span class="nc" id="L279">			statement.setString(5, variable.getQuestionNumber());</span>
			
<span class="nc" id="L281">			statement.setString(6, variable.getLabel());</span>
			
<span class="nc bnc" id="L283" title="All 2 branches missed.">			if (variable.isCoded() == true) {</span>
<span class="nc" id="L284">				statement.setInt(7, 1);</span>
			}
			else {
<span class="nc" id="L287">				statement.setInt(7, 0);				</span>
			}

<span class="nc bnc" id="L290" title="All 2 branches missed.">			if (variable.isCleaned() == true) {</span>
<span class="nc" id="L291">				statement.setInt(8, 1);</span>
			}
			else {
<span class="nc" id="L294">				statement.setInt(8, 0);				</span>
			}
			
<span class="nc bnc" id="L297" title="All 2 branches missed.">			if (variable.isCleaned() == true) {</span>
<span class="nc" id="L298">				CleaningState cleaningState = new CleaningState();</span>
<span class="nc" id="L299">				cleaningState.setName(variable.getCleaningStatus());</span>
<span class="nc" id="L300">				int cleaningStatusID</span>
<span class="nc" id="L301">					= listChoiceManager.getCleaningStateIdentifier(connection,</span>
																   variable,
																   cleaningState);
<span class="nc" id="L304">				statement.setInt(9, cleaningStatusID);</span>
<span class="nc" id="L305">			}</span>
			else {
<span class="nc" id="L307">				statement.setInt(9, 0);				</span>
			}
<span class="nc" id="L309">			statement.setString(10, variable.getCleaningDescription());</span>
<span class="nc" id="L310">			AvailabilityState availabilityState = new AvailabilityState();</span>
<span class="nc" id="L311">			availabilityState.setName(variable.getAvailability());</span>
<span class="nc" id="L312">			int availabilityID</span>
<span class="nc" id="L313">				= listChoiceManager.getAvailabilityStateIdentifier(connection,</span>
																   variable,
																   availabilityState);
<span class="nc" id="L316">			statement.setInt(11, availabilityID);</span>
			
<span class="nc" id="L318">			statement.setString(12, variable.getCodeBookNumber());</span>
<span class="nc" id="L319">			statement.setString(13, variable.getColumnStart());</span>
<span class="nc" id="L320">			statement.setString(14, variable.getColumnEnd());</span>
			
<span class="nc" id="L322">			AliasFilePath aliasFilePath = new AliasFilePath();</span>
<span class="nc" id="L323">			aliasFilePath.setAlias(variable.getAlias());</span>
<span class="nc" id="L324">			int aliasFilePathID</span>
<span class="nc" id="L325">				= listChoiceManager.getAliasFilePathIdentifier(connection,</span>
															   variable,
															   aliasFilePath);
<span class="nc" id="L328">			statement.setInt(15, aliasFilePathID);</span>
<span class="nc" id="L329">			statement.setString(16, variable.getFilePath());</span>
<span class="nc" id="L330">			statement.setString(17, variable.getNotes());</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">			if (variable instanceof DerivedVariable) {</span>
<span class="nc" id="L332">				statement.setInt(18, 1);				</span>
			}
			else {
<span class="nc" id="L335">				statement.setInt(18, 0);				</span>
			}

<span class="nc" id="L338">			Variable alternativeVariable = variable.getAlternativeVariable();</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">			if (alternativeVariable == null) {</span>
<span class="nc" id="L340">				statement.setInt(19, 0);</span>
			}
			else {
<span class="nc" id="L343">				statement.setInt(19, alternativeVariable.getIdentifier());</span>
			}
			
<span class="nc" id="L346">			statement.setDate(20, null);</span>
			
<span class="nc" id="L348">			statement.executeUpdate();</span>
			
<span class="nc" id="L350">			int primaryKey = getVariablePrimaryKey(connection, variable);</span>
<span class="nc" id="L351">			variable.setIdentifier(primaryKey);</span>
			
			//Part III: Record changes
<span class="nc" id="L354">			ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L355">				= ChangeEventGenerator.addVariableChange(user, variable);</span>

<span class="nc" id="L357">			registerChangeEvents(connection, changeEvents);</span>
			
			//now retrieve the identifier
			/**
			ResultSet primaryKeyResult
				= statement.getGeneratedKeys();
			*/
			//TODO there HAS to be a better way to retrieve the identity of an
			//inserted record.  Does not appear to be supported with the org.gjt.mm.mysql.jdbc2 driver
			
			//primaryKeyResult.next();
			//int primaryKey = primaryKeyResult.getInt(1);
<span class="nc" id="L369">			return primaryKey;</span>
		}
<span class="nc" id="L371">		catch(SQLException exception) {</span>
<span class="nc" id="L372">			exception.printStackTrace(System.out);</span>

<span class="nc" id="L374">			log.logException(exception);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">			if (variable instanceof RawVariable) {</span>
<span class="nc" id="L376">				String errorMessage</span>
<span class="nc" id="L377">					= MacawMessages.getMessage(&quot;sql.error.unableToAddRawVariable&quot;,</span>
<span class="nc" id="L378">												variable.getDisplayName());</span>
<span class="nc" id="L379">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_CREATE_RAW_VARIABLE,
										 errorMessage);
<span class="nc" id="L382">				throw macawException;</span>
			}
			else {
<span class="nc" id="L385">				String errorMessage</span>
<span class="nc" id="L386">					= MacawMessages.getMessage(&quot;sql.error.unableToAddDerivedVariable&quot;,</span>
<span class="nc" id="L387">												variable.getDisplayName());</span>
<span class="nc" id="L388">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_CREATE_DERIVED_VARIABLE,
										 errorMessage);
<span class="nc" id="L391">				throw macawException;				</span>
			}
		}	
		finally {
<span class="nc" id="L395">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}		
	}
	
	public void deleteRawVariables(Connection connection,
								   User user,
			   					   ArrayList&lt;RawVariable&gt; rawVariablesToDelete) throws MacawException {

		//Part I: Validate parameters
<span class="nc bnc" id="L404" title="All 2 branches missed.">		for (RawVariable rawVariableToDelete : rawVariablesToDelete) {</span>
<span class="nc" id="L405">			checkVariableExists(connection, rawVariableToDelete);</span>
<span class="nc" id="L406">		}</span>

		//Part II: Perform delete operation
<span class="nc bnc" id="L409" title="All 2 branches missed.">		for (RawVariable currentRawVariable : rawVariablesToDelete) {</span>
<span class="nc" id="L410">			deleteVariable(connection, user, currentRawVariable);</span>
<span class="nc" id="L411">		}		</span>
	
		//Part III: Record changes
<span class="nc" id="L414">		ArrayList&lt;MacawChangeEvent&gt; changeEvents </span>
			= new ArrayList&lt;MacawChangeEvent&gt;();
<span class="nc bnc" id="L416" title="All 2 branches missed.">		for (RawVariable rawVariableToDelete : rawVariablesToDelete) {</span>
<span class="nc" id="L417">			MacawChangeEvent changeEvent</span>
<span class="nc" id="L418">				= ChangeEventGenerator.deleteVariableChanges(user, </span>
															 rawVariableToDelete);
<span class="nc" id="L420">			changeEvents.add(changeEvent);</span>
<span class="nc" id="L421">		}		</span>
<span class="nc" id="L422">		registerChangeEvents(connection, changeEvents);		</span>
<span class="nc" id="L423">	}</span>
	
	public void deleteDerivedVariables(Connection connection,
									   User user,
									   ArrayList&lt;DerivedVariable&gt; derivedVariables) throws MacawException {

		//Part I: Validate parameters
<span class="nc bnc" id="L430" title="All 2 branches missed.">		for (DerivedVariable derivedVariableToDelete : derivedVariables) {</span>
<span class="nc" id="L431">			checkVariableExists(connection, derivedVariableToDelete);</span>
<span class="nc" id="L432">		}</span>

		//Part II: Perform delete operation (includes recording change)
<span class="nc bnc" id="L435" title="All 2 branches missed.">		for (DerivedVariable currentDerivedVariable : derivedVariables) {</span>
<span class="nc" id="L436">			deleteVariable(connection, user, currentDerivedVariable);</span>
<span class="nc" id="L437">		}		</span>
<span class="nc" id="L438">	}</span>

	private void deleteVariable(Connection connection,
								User user,
								Variable variable) throws MacawException {
		
<span class="nc" id="L444">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L445">		query.append(&quot;UPDATE variables &quot;);</span>
<span class="nc" id="L446">		query.append(&quot;SET deleted_at=NOW() &quot;);</span>
<span class="nc" id="L447">		query.append(&quot;WHERE identifier=?;&quot;);</span>
				
<span class="nc" id="L449">		ResultSet resultSet = null;</span>
<span class="nc" id="L450">		PreparedStatement statement = null;</span>
		try {
			//Part II: Perform the delete operation
<span class="nc" id="L453">			Time deletionDate = new Time(System.currentTimeMillis());</span>
<span class="nc" id="L454">			statement</span>
<span class="nc" id="L455">				= connection.prepareStatement(query.toString());</span>
			//statement.setTime(1, deletionDate);
<span class="nc" id="L457">			statement.setInt(1, variable.getIdentifier());</span>
<span class="nc" id="L458">			statement.executeUpdate();			</span>
		}
<span class="nc" id="L460">		catch(SQLException exception) {</span>
<span class="nc" id="L461">			exception.printStackTrace(System.out);</span>
<span class="nc" id="L462">			log.logException(exception);</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">			if (variable instanceof RawVariable) {</span>
<span class="nc" id="L464">				String errorMessage</span>
<span class="nc" id="L465">					= MacawMessages.getMessage(&quot;sql.error.unableToDeleteRawVariable&quot;,</span>
<span class="nc" id="L466">												variable.getDisplayName());</span>
<span class="nc" id="L467">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_DELETE_RAW_VARIABLE,
										 errorMessage);
<span class="nc" id="L470">				throw macawException;				</span>
			}
			else {
<span class="nc" id="L473">				String errorMessage</span>
<span class="nc" id="L474">					= MacawMessages.getMessage(&quot;sql.error.unableToDeleteDerivedVariable&quot;);</span>
<span class="nc" id="L475">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_DELETE_DERIVED_VARIABLE,
										 errorMessage);
<span class="nc" id="L478">				throw macawException;								</span>
			}
		}	
		finally {
<span class="nc" id="L482">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}			
<span class="nc" id="L484">	}</span>
		
	public void updateRawVariable(Connection connection,
								  User user,
								  RawVariable revisedRawVariable) throws MacawException {

		//Part I: Validate parameters
<span class="nc" id="L491">		RawVariable.validateFields(revisedRawVariable);</span>
<span class="nc" id="L492">		checkVariableExists(connection, revisedRawVariable);</span>
<span class="nc" id="L493">		checkVariableDuplicates(connection, revisedRawVariable);</span>
<span class="nc" id="L494">		checkListChoices(connection, revisedRawVariable);</span>

		//check that at least one change was made.
<span class="nc" id="L497">		RawVariable originalRawVariable</span>
<span class="nc" id="L498">			= (RawVariable) getOriginalVariable(connection,</span>
												revisedRawVariable);
<span class="nc" id="L500">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L501">			= RawVariable.detectFieldChanges(user,</span>
											 originalRawVariable, 
											 revisedRawVariable);	
		
<span class="nc bnc" id="L505" title="All 2 branches missed.">		if (changeEvents.size() == 0) {</span>
<span class="nc" id="L506">			return;</span>
		}

<span class="nc" id="L509">		updateVariable(connection, user, revisedRawVariable);</span>
<span class="nc" id="L510">		registerChangeEvents(connection, changeEvents);		</span>
<span class="nc" id="L511">	}</span>
	
	public void updateDerivedVariable(Connection connection,
									  User user,
									  DerivedVariable revisedDerivedVariable) throws MacawException {
		
		//check basic field errors
<span class="nc" id="L518">		DerivedVariable.validateFields(revisedDerivedVariable);</span>
		//check that variable exists
<span class="nc" id="L520">		checkVariableExists(connection, revisedDerivedVariable);</span>
<span class="nc" id="L521">		checkListChoices(connection, revisedDerivedVariable);</span>
		
		//check that at least one change was made.
<span class="nc" id="L524">		DerivedVariable originalDerivedVariable</span>
<span class="nc" id="L525">			= (DerivedVariable) getOriginalVariable(connection,</span>
													revisedDerivedVariable);
<span class="nc" id="L527">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L528">			= DerivedVariable.detectFieldChanges(user,</span>
												 originalDerivedVariable, 
											 	 revisedDerivedVariable);	
		
<span class="nc bnc" id="L532" title="All 2 branches missed.">		if (changeEvents.size() == 0) {</span>
<span class="nc" id="L533">			return;</span>
		}
		
<span class="nc" id="L536">		updateVariable(connection, user, revisedDerivedVariable);</span>
<span class="nc" id="L537">		registerChangeEvents(connection, changeEvents);</span>
<span class="nc" id="L538">	}</span>

	public void updateVariable(Connection connection,
							   User user,
							   Variable revisedVariable) throws MacawException {

		//check for duplicates
<span class="nc" id="L545">		checkVariableDuplicates(connection, revisedVariable);</span>
		
<span class="nc" id="L547">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L548">		query.append(&quot;UPDATE variables &quot;);</span>
<span class="nc" id="L549">		query.append(&quot;SET category_id=?,&quot;);</span>
<span class="nc" id="L550">		query.append(&quot;name=?,&quot;);</span>
<span class="nc" id="L551">		query.append(&quot;year=?,&quot;);</span>
<span class="nc" id="L552">		query.append(&quot;form=?,&quot;);</span>
<span class="nc" id="L553">		query.append(&quot;question_number=?,&quot;);</span>
<span class="nc" id="L554">		query.append(&quot;label=?,&quot;);</span>
<span class="nc" id="L555">		query.append(&quot;is_coded=?,&quot;);</span>
<span class="nc" id="L556">		query.append(&quot;is_cleaned=?,&quot;);</span>
<span class="nc" id="L557">		query.append(&quot;cleaning_status_id=?,&quot;);</span>
<span class="nc" id="L558">		query.append(&quot;cleaning_description=?,&quot;);</span>
<span class="nc" id="L559">		query.append(&quot;availability_id=?,&quot;);</span>
<span class="nc" id="L560">		query.append(&quot;code_book_number=?,&quot;);</span>
<span class="nc" id="L561">		query.append(&quot;column_start=?,&quot;);</span>
<span class="nc" id="L562">		query.append(&quot;column_end=?,&quot;);</span>
<span class="nc" id="L563">		query.append(&quot;alias_id=?,&quot;);</span>
<span class="nc" id="L564">		query.append(&quot;file_path=?,&quot;);</span>
<span class="nc" id="L565">		query.append(&quot;notes=?,&quot;);</span>
<span class="nc" id="L566">		query.append(&quot;alternative_variable_id=? &quot;);</span>
<span class="nc" id="L567">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L568">		query.append(&quot;identifier=?;&quot;);</span>

<span class="nc" id="L570">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L572">			statement</span>
<span class="nc" id="L573">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L574">			Category category = new Category();</span>
<span class="nc" id="L575">			category.setName(revisedVariable.getCategory());</span>
<span class="nc" id="L576">			int categoryID</span>
<span class="nc" id="L577">				= listChoiceManager.getCategoryIdentifier(connection,</span>
														  revisedVariable,
														  category);			
<span class="nc" id="L580">			statement.setInt(1, categoryID);</span>
<span class="nc" id="L581">			statement.setString(2, revisedVariable.getName());</span>
<span class="nc" id="L582">			statement.setString(3, revisedVariable.getYear());</span>
<span class="nc" id="L583">			statement.setString(4, revisedVariable.getForm());</span>
<span class="nc" id="L584">			statement.setString(5, revisedVariable.getQuestionNumber());</span>
<span class="nc" id="L585">			statement.setString(6, revisedVariable.getLabel());</span>

<span class="nc bnc" id="L587" title="All 2 branches missed.">			if (revisedVariable.isCoded() == true) {</span>
<span class="nc" id="L588">				statement.setInt(7, 1);				</span>
			}
			else {
<span class="nc" id="L591">				statement.setInt(7, 0);</span>
			}

<span class="nc bnc" id="L594" title="All 2 branches missed.">			if (revisedVariable.isCleaned() == true) {</span>
<span class="nc" id="L595">				statement.setInt(8, 1);				</span>
			}
			else {
<span class="nc" id="L598">				statement.setInt(8, 0);</span>
			}

<span class="nc" id="L601">			CleaningState cleaningState = new CleaningState();</span>
<span class="nc" id="L602">			cleaningState.setName(revisedVariable.getCleaningStatus());</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">			if (revisedVariable.isCleaned() == true) {</span>
<span class="nc" id="L604">				int cleaningStatusID</span>
<span class="nc" id="L605">					= listChoiceManager.getCleaningStateIdentifier(connection,</span>
																   revisedVariable,
																   cleaningState);
<span class="nc" id="L608">				statement.setInt(9, cleaningStatusID);</span>
<span class="nc" id="L609">			}</span>
			else {
<span class="nc" id="L611">				statement.setInt(9, 0);				</span>
			}
			
<span class="nc" id="L614">			statement.setString(10, revisedVariable.getCleaningDescription());</span>
<span class="nc" id="L615">			AvailabilityState availabilityState = new AvailabilityState();</span>
<span class="nc" id="L616">			availabilityState.setName(revisedVariable.getAvailability());</span>
<span class="nc" id="L617">			int availabilityStateID</span>
<span class="nc" id="L618">				= listChoiceManager.getAvailabilityStateIdentifier(connection,</span>
																   revisedVariable,
																   availabilityState);			
<span class="nc" id="L621">			statement.setInt(11, availabilityStateID);</span>
<span class="nc" id="L622">			AliasFilePath aliasFilePath = new AliasFilePath();</span>
<span class="nc" id="L623">			aliasFilePath.setAlias(revisedVariable.getAlias());</span>
<span class="nc" id="L624">			int aliasFilePathID</span>
<span class="nc" id="L625">				= listChoiceManager.getAliasFilePathIdentifier(connection,</span>
															   revisedVariable,
															   aliasFilePath);			
			
<span class="nc" id="L629">			statement.setString(12, revisedVariable.getCodeBookNumber());</span>
<span class="nc" id="L630">			statement.setString(13, revisedVariable.getColumnStart());</span>
<span class="nc" id="L631">			statement.setString(14, revisedVariable.getColumnEnd());</span>
			
<span class="nc" id="L633">			statement.setInt(15, aliasFilePathID);</span>
<span class="nc" id="L634">			statement.setString(16, revisedVariable.getFilePath());</span>
<span class="nc" id="L635">			statement.setString(17, revisedVariable.getNotes());</span>
			
<span class="nc" id="L637">			Variable alternativeVariable</span>
<span class="nc" id="L638">				= revisedVariable.getAlternativeVariable();</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">			if (alternativeVariable == null) {</span>
<span class="nc" id="L640">				statement.setInt(18, 0);				</span>
			}
			else {
<span class="nc" id="L643">				statement.setInt(18, alternativeVariable.getIdentifier());								</span>
			}
			
<span class="nc" id="L646">			statement.setInt(19, revisedVariable.getIdentifier());</span>
<span class="nc" id="L647">			statement.executeUpdate();			</span>
		}
<span class="nc" id="L649">		catch(SQLException exception) {</span>
<span class="nc" id="L650">			log.logException(exception);</span>
<span class="nc bnc" id="L651" title="All 2 branches missed.">			if (revisedVariable instanceof RawVariable) {				</span>
<span class="nc" id="L652">				String errorMessage</span>
<span class="nc" id="L653">					= MacawMessages.getMessage(&quot;sql.error.unableToUpdateRawVariable&quot;);</span>
<span class="nc" id="L654">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_UPDATE_RAW_VARIABLE,
										 errorMessage);
<span class="nc" id="L657">				throw macawException;</span>
			}
			else {
<span class="nc" id="L660">				String errorMessage</span>
<span class="nc" id="L661">					= MacawMessages.getMessage(&quot;sql.error.unableToUpdateRawVariable&quot;);</span>
<span class="nc" id="L662">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_UPDATE_RAW_VARIABLE,
										 errorMessage);
<span class="nc" id="L665">				throw macawException;				</span>
			}
		}	
		finally {
<span class="nc" id="L669">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}	
<span class="nc" id="L671">	}</span>

	public int getDerivedVariableIdentifier(Connection connection,
											User user,
											DerivedVariable derivedVariable) throws MacawException {

<span class="nc" id="L677">		return getVariableIdentifier(connection,</span>
									 user,
									 derivedVariable);
	}

	public int getRawVariableIdentifier(Connection connection,
										User user,
										RawVariable rawVariable) throws MacawException {

<span class="nc" id="L686">		return getVariableIdentifier(connection,</span>
									 user,
									 rawVariable);
	}
	
	public int getVariableIdentifier(Connection connection,
									 User user,
									 Variable variable) throws MacawException {
		
<span class="nc" id="L695">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L696">		query.append(&quot;SELECT variables.identifier &quot;);</span>
<span class="nc" id="L697">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L698">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L699">		query.append(&quot;variables.name=?;&quot;);</span>

<span class="nc" id="L701">		ResultSet resultSet = null;</span>
<span class="nc" id="L702">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L704">			statement</span>
<span class="nc" id="L705">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L706">			statement.setString(1, variable.getName());</span>
<span class="nc" id="L707">			resultSet = statement.executeQuery();</span>
			
<span class="nc" id="L709">			resultSet.last();</span>
<span class="nc" id="L710">			resultSet.beforeFirst();</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">			if (resultSet.next() == false) {</span>
				//does not exist
<span class="nc" id="L713">				return -1;</span>
			}
			else {
<span class="nc" id="L716">				return resultSet.getInt(1);</span>
			}
		}
<span class="nc" id="L719">		catch(SQLException exception) {</span>
<span class="nc" id="L720">			log.logException(exception);</span>
<span class="nc bnc" id="L721" title="All 2 branches missed.">			if (variable instanceof RawVariable) {				</span>
<span class="nc" id="L722">				String errorMessage</span>
<span class="nc" id="L723">					= MacawMessages.getMessage(&quot;sql.error.unableToGetVariableIdentifier&quot;,</span>
<span class="nc" id="L724">												variable.getDisplayName());</span>
<span class="nc" id="L725">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_GET_VARIABLE_IDENTIFIER,
										 errorMessage);
<span class="nc" id="L728">				throw macawException;</span>
			}
			else {
<span class="nc" id="L731">				String errorMessage</span>
<span class="nc" id="L732">					= MacawMessages.getMessage(&quot;sql.error.unableToGetVariableIdentifier&quot;,</span>
<span class="nc" id="L733">												variable.getDisplayName());</span>
<span class="nc" id="L734">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_GET_VARIABLE_IDENTIFIER,
										 errorMessage);
<span class="nc" id="L737">				throw macawException;				</span>
			}
		}	
		finally {
<span class="nc" id="L741">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}			
	}
	
	
	public ArrayList&lt;Category&gt; getCategoriesForVariable(Connection connection,
														String variableName) throws MacawException {
		
		//check that variable exists
<span class="nc" id="L750">		checkVariableExists(connection, variableName);</span>
		
<span class="nc" id="L752">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L753">		query.append(&quot;SELECT categories.identifier, &quot;);</span>
<span class="nc" id="L754">		query.append(&quot;categories.name &quot;);</span>
<span class="nc" id="L755">		query.append(&quot;FROM categories, variables &quot;);</span>
<span class="nc" id="L756">		query.append(&quot;WHERE categories.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L757">		query.append(&quot;variables.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L758">		query.append(&quot;categories.identifier=variables.category_id &quot;);</span>
<span class="nc" id="L759">		query.append(&quot;AND variables.name=?;&quot;);</span>

<span class="nc" id="L761">		ResultSet resultSet = null;</span>
<span class="nc" id="L762">		PreparedStatement statement = null;</span>
		
<span class="nc" id="L764">		ArrayList&lt;Category&gt; categories = new ArrayList&lt;Category&gt;();</span>
		
		try {
<span class="nc" id="L767">			statement</span>
<span class="nc" id="L768">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L769">			statement.setString(1, variableName);</span>
			
<span class="nc" id="L771">			resultSet = statement.executeQuery();</span>
			
<span class="nc bnc" id="L773" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L774">				Category category = new Category();</span>
<span class="nc" id="L775">				category.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L776">				category.setName(resultSet.getString(2));</span>
<span class="nc" id="L777">				categories.add(category);</span>
<span class="nc" id="L778">			}</span>
			
<span class="nc" id="L780">			return categories;</span>
		}
<span class="nc" id="L782">		catch(SQLException exception) {</span>
<span class="nc" id="L783">			log.logException(exception);</span>
<span class="nc" id="L784">			String errorMessage</span>
<span class="nc" id="L785">				= MacawMessages.getMessage(&quot;sql.error.unableToGetCategoriesForVariable&quot;,</span>
											variableName);
<span class="nc" id="L787">			MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_GET_CATEGORIES_FOR_VARIABLE,
										 errorMessage);
<span class="nc" id="L790">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L793">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
	}

	public ArrayList&lt;VariableSummary&gt; getVariableSummariesForCategory(Connection connection,
			  												   		  String categoryName) throws MacawException {


<span class="nc" id="L801">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L802">		query.append(&quot;SELECT variables.identifier,&quot;);</span>
<span class="nc" id="L803">		query.append(&quot;variables.name,&quot;);</span>
<span class="nc" id="L804">		query.append(&quot;variables.year,&quot;);</span>
<span class="nc" id="L805">		query.append(&quot;variables.label,&quot;);</span>
<span class="nc" id="L806">		query.append(&quot;variables.is_derived_variable,&quot;);</span>
<span class="nc" id="L807">		query.append(&quot;variables.category_id &quot;);</span>
<span class="nc" id="L808">		query.append(&quot;FROM variables, categories &quot;);</span>
<span class="nc" id="L809">		query.append(&quot;WHERE variables.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L810">		query.append(&quot;categories.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L811">		query.append(&quot;variables.category_id=categories.identifier &quot;);</span>
<span class="nc" id="L812">		query.append(&quot;AND categories.name=? &quot;);</span>
<span class="nc" id="L813">		query.append(&quot;ORDER BY year ASC;&quot;);</span>

<span class="nc" id="L815">		ArrayList&lt;VariableSummary&gt; variableSummaries </span>
			= new ArrayList&lt;VariableSummary&gt;();

<span class="nc" id="L818">		ResultSet resultSet = null;</span>
<span class="nc" id="L819">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L821">			statement</span>
<span class="nc" id="L822">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L823">			statement.setString(1, categoryName);</span>
<span class="nc" id="L824">			resultSet = statement.executeQuery();</span>
				
<span class="nc bnc" id="L826" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
				
<span class="nc" id="L828">				VariableSummary variableSummary = new VariableSummary();</span>
<span class="nc" id="L829">				variableSummary.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L830">				variableSummary.setName(resultSet.getString(2));</span>

<span class="nc" id="L832">				String year = resultSet.getString(3);</span>
<span class="nc" id="L833">				variableSummary.setYear( year);</span>
<span class="nc" id="L834">				variableSummary.setLabel(resultSet.getString(4));</span>
				
<span class="nc bnc" id="L836" title="All 2 branches missed.">				if (resultSet.getInt(5) == 1) {</span>
<span class="nc" id="L837">					variableSummary.setDerived(true);</span>
				}
				else {
<span class="nc" id="L840">					variableSummary.setDerived(false);</span>
				}
				
<span class="nc" id="L843">				variableSummaries.add(variableSummary);</span>
<span class="nc" id="L844">			}</span>
			
<span class="nc" id="L846">			return variableSummaries;</span>
		}
<span class="nc" id="L848">		catch(SQLException exception) {</span>
<span class="nc" id="L849">			log.logException(exception);</span>
<span class="nc" id="L850">			String errorMessage</span>
<span class="nc" id="L851">				= MacawMessages.getMessage(&quot;sql.error.unableToGetSummaryVariableData&quot;);</span>
<span class="nc" id="L852">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ALL_SUMMARY_VARIABLES,
									 errorMessage);
<span class="nc" id="L855">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L858">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
	}

	
	public Variable getVariable(Connection connection,
								String variableName) throws MacawException {

<span class="nc" id="L866">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L867">		query.append(&quot;SELECT variables.identifier &quot;);</span>
<span class="nc" id="L868">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L869">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L870">		query.append(&quot;name=?;&quot;);</span>

<span class="nc" id="L872">		ResultSet resultSet = null;</span>
<span class="nc" id="L873">		PreparedStatement statement = null;</span>
		
		try {
<span class="nc" id="L876">			statement</span>
<span class="nc" id="L877">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L878">			statement.setString(1, variableName);</span>
<span class="nc" id="L879">			resultSet = statement.executeQuery();</span>
			
<span class="nc" id="L881">			resultSet.beforeFirst();</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">			if (resultSet.next() == false) {</span>
				//does not exist
<span class="nc" id="L884">				return null;</span>
			}
			else {
<span class="nc" id="L887">				int identifier = resultSet.getInt(1);</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">				if (isDerivedVariable(connection, identifier) == true) {</span>
<span class="nc" id="L889">					return getDerivedVariable(connection, identifier);</span>
				}	
				else {
<span class="nc" id="L892">					return getRawVariable(connection, identifier);</span>
				}
			}
		}
<span class="nc" id="L896">		catch(SQLException exception) {</span>
<span class="nc" id="L897">			log.logException(exception);</span>
<span class="nc" id="L898">			String errorMessage</span>
<span class="nc" id="L899">				= MacawMessages.getMessage(&quot;sql.error.unableToGetVariableIdentifier&quot;,</span>
											variableName);
<span class="nc" id="L901">			MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_GET_VARIABLE_IDENTIFIER,
										 errorMessage);
<span class="nc" id="L904">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L907">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
	}
	
	public ArrayList&lt;Variable&gt; getSourceVariables(Connection connection,
												  User user,
			  									  DerivedVariable derivedVariable) throws MacawException {

		
		//Part I: Validate parameters
<span class="nc" id="L917">		checkVariableExists(connection, derivedVariable);</span>
		
		//Part II: perform the get source variables operation
<span class="nc" id="L920">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L921">		query.append(&quot;SELECT variables.identifier, variables.is_derived_variable &quot;);</span>
<span class="nc" id="L922">		query.append(&quot;FROM source_variables, variables &quot;);</span>
<span class="nc" id="L923">		query.append(&quot;WHERE variables.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L924">		query.append(&quot;source_variables.source_variable_id=variables.identifier AND &quot;);</span>
<span class="nc" id="L925">		query.append(&quot;source_variables.derived_variable_id = ?;&quot;);</span>

<span class="nc" id="L927">		ResultSet resultSet = null;</span>
<span class="nc" id="L928">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L930">			statement</span>
<span class="nc" id="L931">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L932">			statement.setInt(1, derivedVariable.getIdentifier());</span>
<span class="nc" id="L933">			resultSet = statement.executeQuery();</span>

<span class="nc" id="L935">			ArrayList&lt;Variable&gt; sourceVariables = new ArrayList&lt;Variable&gt;();</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L937">				int variableID = resultSet.getInt(1);</span>
<span class="nc" id="L938">				boolean isDerivedVariable = resultSet.getBoolean(2);</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">				if (isDerivedVariable == true) {</span>
<span class="nc" id="L940">					DerivedVariable derivedSourceVariable</span>
<span class="nc" id="L941">						= getDerivedVariable(connection, variableID);</span>
<span class="nc" id="L942">					sourceVariables.add(derivedSourceVariable);</span>
<span class="nc" id="L943">				}</span>
				else {
<span class="nc" id="L945">					RawVariable sourceRawVariable</span>
<span class="nc" id="L946">						= getRawVariable(connection, variableID);</span>
<span class="nc" id="L947">					sourceVariables.add(sourceRawVariable);					</span>
				}
<span class="nc" id="L949">			}</span>
<span class="nc" id="L950">			return sourceVariables;</span>
		}
<span class="nc" id="L952">		catch(SQLException exception) {</span>
<span class="nc" id="L953">			log.logException(exception);</span>
<span class="nc" id="L954">			String errorMessage</span>
<span class="nc" id="L955">				= MacawMessages.getMessage(&quot;sql.error.unableToGetSourceVariables&quot;,</span>
<span class="nc" id="L956">											derivedVariable.getDisplayName());</span>
<span class="nc" id="L957">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_SOURCE_VARIABLES,
									 errorMessage);
<span class="nc" id="L960">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L963">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
	}

	public void associateSourceVariables(Connection connection,
										 User user,
										 DerivedVariable derivedVariable,
										 ArrayList&lt;Variable&gt; sourceVariablesToAdd) throws MacawException {

		//Part I: Validate parameters
<span class="nc" id="L973">		checkVariableExists(connection, derivedVariable);		</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">		for (Variable currentVariable : sourceVariablesToAdd) {</span>
<span class="nc" id="L975">			checkVariableExists(connection, currentVariable);</span>
<span class="nc" id="L976">			checkDuplicateVariableAssociation(connection, </span>
											  derivedVariable, 
											  currentVariable);
<span class="nc" id="L979">		}</span>
		
		//Part II: Perform association operation
<span class="nc" id="L982">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L983">		query.append(&quot;INSERT INTO source_variables &quot;);</span>
<span class="nc" id="L984">		query.append(&quot;(derived_variable_id,&quot;);</span>
<span class="nc" id="L985">		query.append(&quot;source_variable_id) &quot;);</span>
<span class="nc" id="L986">		query.append(&quot;VALUES (?, ?);&quot;);</span>

<span class="nc" id="L988">		ResultSet resultSet = null;</span>
<span class="nc" id="L989">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L991">			statement</span>
<span class="nc" id="L992">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L993">			int derivedVariableID = derivedVariable.getIdentifier();</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">			for (Variable sourceVariableToAdd : sourceVariablesToAdd) {</span>
<span class="nc" id="L995">				statement.setInt(1, derivedVariableID);</span>
<span class="nc" id="L996">				statement.setInt(2, sourceVariableToAdd.getIdentifier());</span>
<span class="nc" id="L997">				statement.executeUpdate();</span>
<span class="nc" id="L998">			}</span>
			
			//Part III: Associate source variables
			//Part III: Record changes
<span class="nc" id="L1002">			ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L1003">				= ChangeEventGenerator.associateSourceVariablesChanges(user,</span>
																	   derivedVariable,
																	   sourceVariablesToAdd);
<span class="nc" id="L1006">			registerChangeEvents(connection, changeEvents);				</span>
		}
<span class="nc" id="L1008">		catch(SQLException exception) {</span>
<span class="nc" id="L1009">			log.logException(exception);</span>
<span class="nc" id="L1010">			String errorMessage</span>
<span class="nc" id="L1011">				= MacawMessages.getMessage(&quot;sql.error.unableToAddSourceVariables&quot;,</span>
<span class="nc" id="L1012">											derivedVariable.getDisplayName());</span>
<span class="nc" id="L1013">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_ASSOCIATE_SOURCE_VARIABLE,
									 errorMessage);
<span class="nc" id="L1016">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1019">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
<span class="nc" id="L1021">	}</span>
	
	public void disassociateSourceVariables(Connection connection,
											User user,
											DerivedVariable derivedVariable,
											ArrayList&lt;Variable&gt; sourceVariablesToDelete) throws MacawException {

		//Part I: Validate parameters
<span class="nc" id="L1029">		checkVariableExists(connection, derivedVariable);		</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">		for (Variable currentVariable : sourceVariablesToDelete) {</span>
<span class="nc" id="L1031">			checkVariableExists(connection, currentVariable);</span>
<span class="nc" id="L1032">			checkVariableAssociationExists(connection, </span>
					  					   derivedVariable, 
					  					   currentVariable);
<span class="nc" id="L1035">		}</span>
				
		//Part II: Perform disassociation operation
<span class="nc" id="L1038">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1039">		query.append(&quot;DELETE FROM source_variables &quot;);</span>
<span class="nc" id="L1040">		query.append(&quot;WHERE derived_variable_id = ? &quot;);</span>
<span class="nc" id="L1041">		query.append(&quot;AND source_variable_id = ?;&quot;);</span>

<span class="nc" id="L1043">		ResultSet resultSet = null;</span>
<span class="nc" id="L1044">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1046">			statement</span>
<span class="nc" id="L1047">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1048">			int derivedVariableID = derivedVariable.getIdentifier();</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">			for (Variable sourceVariableToDelete : sourceVariablesToDelete) {</span>
<span class="nc" id="L1050">				statement.setInt(1, derivedVariableID);</span>
<span class="nc" id="L1051">				statement.setInt(2, sourceVariableToDelete.getIdentifier());</span>
<span class="nc" id="L1052">				statement.executeUpdate();</span>
<span class="nc" id="L1053">			}</span>
			
			//Part III: Record changes
<span class="nc" id="L1056">			ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L1057">				= ChangeEventGenerator.disassociateSourceVariablesChanges(user,</span>
				    													  derivedVariable,
				    													  sourceVariablesToDelete);		
<span class="nc" id="L1060">			registerChangeEvents(connection,</span>
								 changeEvents);	
		}
<span class="nc" id="L1063">		catch(SQLException exception) {</span>
<span class="nc" id="L1064">			log.logException(exception);</span>
<span class="nc" id="L1065">			String errorMessage</span>
<span class="nc" id="L1066">				= MacawMessages.getMessage(&quot;sql.error.unableToDeleteSourceVariables&quot;,</span>
<span class="nc" id="L1067">											derivedVariable.getDisplayName());</span>
<span class="nc" id="L1068">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_DISASSOCIATE_SOURCE_VARIABLE,
									 errorMessage);
<span class="nc" id="L1071">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L1074">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
<span class="nc" id="L1076">	}</span>

	public String[] getStudyYears(Connection connection) throws MacawException {
<span class="nc" id="L1079">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1080">		query.append(&quot;SELECT DISTINCT year &quot;);</span>
<span class="nc" id="L1081">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L1082">		query.append(&quot;WHERE deleted_at IS NULL &quot;);</span>
<span class="nc" id="L1083">		query.append(&quot;ORDER BY year DESC;&quot;);</span>

<span class="nc" id="L1085">		ResultSet resultSet = null;</span>
<span class="nc" id="L1086">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1088">			statement</span>
<span class="nc" id="L1089">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1090">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L1091">			ArrayList&lt;String&gt; years = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L1092" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L1093">				years.add(resultSet.getString(1));				</span>
			}

<span class="nc" id="L1096">			String[] results</span>
<span class="nc" id="L1097">				= years.toArray(new String[0]);</span>
<span class="nc" id="L1098">			return results;</span>
		}
<span class="nc" id="L1100">		catch(SQLException exception) {</span>
<span class="nc" id="L1101">			log.logException(exception);</span>
<span class="nc" id="L1102">			String errorMessage</span>
<span class="nc" id="L1103">				= MacawMessages.getMessage(&quot;sql.error.unableToGetStudyYears&quot;);</span>
<span class="nc" id="L1104">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_STUDY_YEARS,
									 errorMessage);
<span class="nc" id="L1107">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1110">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
	}
	
	
	public ArrayList&lt;SupportingDocument&gt; getAssociatedSupportingDocuments(Connection connection,
																		  User user,
																		  String variableName) throws MacawException {

<span class="nc" id="L1119">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1120">		query.append(&quot;SELECT supporting_documents.identifier,&quot;);</span>
<span class="nc" id="L1121">		query.append(&quot;supporting_documents.title,&quot;);</span>
<span class="nc" id="L1122">		query.append(&quot;supporting_documents.document_code,&quot;);		</span>
<span class="nc" id="L1123">		query.append(&quot;supporting_documents.description,&quot;);</span>
<span class="nc" id="L1124">		query.append(&quot;supporting_documents.file_path,&quot;);</span>
<span class="nc" id="L1125">		query.append(&quot;supporting_documents.file_path &quot;);</span>
<span class="nc" id="L1126">		query.append(&quot;FROM supporting_documents, supporting_documents_for_variables, variables &quot;);</span>
<span class="nc" id="L1127">		query.append(&quot;WHERE supporting_documents.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1128">		query.append(&quot;supporting_documents.identifier=&quot;);</span>
<span class="nc" id="L1129">		query.append(&quot;supporting_documents_for_variables.document_id AND &quot;);</span>
<span class="nc" id="L1130">		query.append(&quot;supporting_documents_for_variables.variable_id=variables.identifier &quot;);</span>
<span class="nc" id="L1131">		query.append(&quot;AND variables.name=? &quot;);</span>
<span class="nc" id="L1132">		query.append(&quot;ORDER BY title ASC;&quot;);</span>

<span class="nc" id="L1134">		ResultSet resultSet = null;</span>
<span class="nc" id="L1135">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1137">			ArrayList&lt;SupportingDocument&gt; results </span>
				= new ArrayList&lt;SupportingDocument&gt;();
<span class="nc" id="L1139">			statement</span>
<span class="nc" id="L1140">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1141">			statement.setString(1, variableName);</span>
<span class="nc" id="L1142">			resultSet = statement.executeQuery();						</span>

<span class="nc bnc" id="L1144" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L1145">				SupportingDocument supportingDocument = new SupportingDocument();</span>
<span class="nc" id="L1146">				supportingDocument.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L1147">				supportingDocument.setTitle(resultSet.getString(2));</span>
<span class="nc" id="L1148">				supportingDocument.setDocumentCode(resultSet.getString(3));</span>
<span class="nc" id="L1149">				supportingDocument.setDescription(resultSet.getString(4));</span>
<span class="nc" id="L1150">				supportingDocument.setFileName(resultSet.getString(5));</span>
<span class="nc" id="L1151">				supportingDocument.setFilePath(resultSet.getString(6));</span>
<span class="nc" id="L1152">				results.add(supportingDocument);</span>
<span class="nc" id="L1153">			}</span>
			
<span class="nc" id="L1155">			return results;</span>
		}
<span class="nc" id="L1157">		catch(SQLException exception) {</span>
<span class="nc" id="L1158">			String errorMessage</span>
<span class="nc" id="L1159">				= MacawMessages.getMessage(&quot;sql.error.unableToGetSupportingDocuments&quot;,</span>
											variableName);
<span class="nc" id="L1161">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_SUPPORTING_DOCUMENTS,
									 errorMessage);
<span class="nc" id="L1164">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1167">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
	}

	public ArrayList&lt;SupportingDocument&gt; getAssociatedSupportingDocuments(Connection connection,
																		  User user,
																		  Variable variable) throws MacawException {

<span class="nc" id="L1175">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1176">		query.append(&quot;SELECT supporting_documents.identifier,&quot;);</span>
<span class="nc" id="L1177">		query.append(&quot;supporting_documents.title,&quot;);</span>
<span class="nc" id="L1178">		query.append(&quot;supporting_documents.document_code,&quot;);		</span>
<span class="nc" id="L1179">		query.append(&quot;supporting_documents.description,&quot;);</span>
<span class="nc" id="L1180">		query.append(&quot;supporting_documents.file_path,&quot;);</span>
<span class="nc" id="L1181">		query.append(&quot;supporting_documents.file_path &quot;);</span>
<span class="nc" id="L1182">		query.append(&quot;FROM supporting_documents, supporting_documents_for_variables &quot;);</span>
<span class="nc" id="L1183">		query.append(&quot;WHERE supporting_documents.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1184">		query.append(&quot;supporting_documents.identifier=&quot;);</span>
<span class="nc" id="L1185">		query.append(&quot;supporting_documents_for_variables.document_id AND &quot;);</span>
<span class="nc" id="L1186">		query.append(&quot;supporting_documents_for_variables.variable_id=? &quot;);</span>
<span class="nc" id="L1187">		query.append(&quot;ORDER BY title ASC;&quot;);</span>

<span class="nc" id="L1189">		ResultSet resultSet = null;</span>
<span class="nc" id="L1190">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1192">			ArrayList&lt;SupportingDocument&gt; results </span>
				= new ArrayList&lt;SupportingDocument&gt;();
<span class="nc" id="L1194">			statement</span>
<span class="nc" id="L1195">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1196">			statement.setInt(1, variable.getIdentifier());</span>
<span class="nc" id="L1197">			resultSet = statement.executeQuery();						</span>

<span class="nc bnc" id="L1199" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L1200">				SupportingDocument supportingDocument = new SupportingDocument();</span>
<span class="nc" id="L1201">				supportingDocument.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L1202">				supportingDocument.setTitle(resultSet.getString(2));</span>
<span class="nc" id="L1203">				supportingDocument.setDocumentCode(resultSet.getString(3));</span>
<span class="nc" id="L1204">				supportingDocument.setDescription(resultSet.getString(4));</span>
<span class="nc" id="L1205">				supportingDocument.setFileName(resultSet.getString(5));</span>
<span class="nc" id="L1206">				supportingDocument.setFilePath(resultSet.getString(6));</span>
<span class="nc" id="L1207">				results.add(supportingDocument);</span>
<span class="nc" id="L1208">			}</span>

<span class="nc" id="L1210">			return results;</span>
		}
<span class="nc" id="L1212">		catch(SQLException exception) {</span>
<span class="nc" id="L1213">			String errorMessage</span>
<span class="nc" id="L1214">				= MacawMessages.getMessage(&quot;sql.error.unableToGetSupportingDocuments&quot;,</span>
<span class="nc" id="L1215">						variable.getDisplayName());</span>
<span class="nc" id="L1216">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_SUPPORTING_DOCUMENTS,
									 errorMessage);
<span class="nc" id="L1219">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1222">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
	}

	public void associateSupportingDocuments(Connection connection,
											 User user,
											 Variable variable,
											 ArrayList&lt;SupportingDocument&gt; supportingDocumentsToAdd) throws MacawException {

<span class="nc" id="L1231">		checkVariableExists(connection,</span>
							variable);

<span class="nc bnc" id="L1234" title="All 2 branches missed.">		if (supportingDocumentsToAdd.size() == 0) {</span>
<span class="nc" id="L1235">			return;</span>
		}
		
<span class="nc" id="L1238">		Variable originalVariable = getOriginalVariable(connection, variable);		</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">		for (SupportingDocument supportingDocument : supportingDocumentsToAdd) {</span>
<span class="nc" id="L1240">			supportingDocumentsManager.checkSupportingDocumentExists(connection,</span>
																	 supportingDocument);
<span class="nc" id="L1242">			checkDuplicateDocumentAssociation(connection, </span>
											  originalVariable, 
											  supportingDocument);
<span class="nc" id="L1245">		}</span>
	
		//Part II: Perform the associate supporting document operation
<span class="nc" id="L1248">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1249">		query.append(&quot;INSERT INTO supporting_documents_for_variables &quot;);</span>
<span class="nc" id="L1250">		query.append(&quot;(variable_id, document_id) &quot;);</span>
<span class="nc" id="L1251">		query.append(&quot;VALUES (?,?)&quot;);</span>
		
<span class="nc" id="L1253">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1255">			statement</span>
<span class="nc" id="L1256">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1257">			int variableIdentifier = variable.getIdentifier();</span>
<span class="nc bnc" id="L1258" title="All 2 branches missed.">			for (SupportingDocument supportingDocument : supportingDocumentsToAdd) {</span>
<span class="nc" id="L1259">				statement.setInt(1, variableIdentifier);</span>
<span class="nc" id="L1260">				statement.setInt(2, supportingDocument.getIdentifier());</span>
<span class="nc" id="L1261">				statement.executeUpdate();</span>
<span class="nc" id="L1262">			}</span>
			
			//Part III: Record changes
<span class="nc" id="L1265">			ArrayList&lt;MacawChangeEvent&gt; changeEvents = new ArrayList&lt;MacawChangeEvent&gt;();</span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">			for (SupportingDocument supportingDocument : supportingDocumentsToAdd) {</span>
<span class="nc" id="L1267">				String changeMessage</span>
<span class="nc" id="L1268">					= MacawMessages.getMessage(&quot;variable.saveChanges.associateDocument&quot;,</span>
<span class="nc" id="L1269">												supportingDocument.getDisplayName(),</span>
<span class="nc" id="L1270">												variable.getDisplayName());</span>
				
<span class="nc" id="L1272">				MacawChangeEvent changeEvent</span>
					= new MacawChangeEvent(ChangeEventType.VARIABLE, 
										   changeMessage, 
<span class="nc" id="L1275">										   user.getUserID());</span>

<span class="nc" id="L1277">				changeEvent.setChangedObjectIdentifier(supportingDocument.getIdentifier());</span>
<span class="nc" id="L1278">				changeEvent.setVariableOwnerID(variable.getIdentifier());</span>
<span class="nc" id="L1279">				changeEvents.add(changeEvent);</span>
<span class="nc" id="L1280">			}</span>

<span class="nc" id="L1282">			registerChangeEvents(connection, changeEvents);</span>
		}
<span class="nc" id="L1284">		catch(SQLException exception) {</span>
<span class="nc" id="L1285">			log.logException(exception);</span>
<span class="nc" id="L1286">			String errorMessage</span>
<span class="nc" id="L1287">				= MacawMessages.getMessage(&quot;sql.error.unableToAddDocumentsToVariable&quot;,</span>
<span class="nc" id="L1288">											variable.getDisplayName());</span>
<span class="nc" id="L1289">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_ASSOCIATE_DOCUMENT,
									 errorMessage);
<span class="nc" id="L1292">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1295">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}	
<span class="nc" id="L1297">	}</span>

	public void disassociateSupportingDocuments(Connection connection,
												User user,
			 									Variable variable,
			 									ArrayList&lt;SupportingDocument&gt; supportingDocumentsToDelete) throws MacawException {


<span class="nc" id="L1305">		checkVariableExists(connection, variable);</span>

<span class="nc bnc" id="L1307" title="All 2 branches missed.">		if (supportingDocumentsToDelete.size() == 0) {</span>
<span class="nc" id="L1308">			return;</span>
		}

<span class="nc" id="L1311">		Variable originalVariable = getOriginalVariable(connection, variable);		</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">		for (SupportingDocument supportingDocument : supportingDocumentsToDelete) {</span>
<span class="nc" id="L1313">			supportingDocumentsManager.checkSupportingDocumentExists(connection,</span>
																	 supportingDocument);
<span class="nc" id="L1315">			checkDocumentAssociationExists(connection, </span>
								  		   originalVariable, 
								  		   supportingDocument);
<span class="nc" id="L1318">		}</span>

		//Part II: Perform the associate supporting document operation
<span class="nc" id="L1321">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1322">		query.append(&quot;DELETE FROM supporting_documents_for_variables &quot;);</span>
<span class="nc" id="L1323">		query.append(&quot;WHERE variable_id=? AND document_id=?;&quot;);</span>

<span class="nc" id="L1325">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1327">			int variableIdentifier = variable.getIdentifier();</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">			for (SupportingDocument supportingDocument : supportingDocumentsToDelete) {</span>
<span class="nc" id="L1329">				statement</span>
<span class="nc" id="L1330">					= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1331">				statement.setInt(1, variableIdentifier);</span>
<span class="nc" id="L1332">				statement.setInt(2, supportingDocument.getIdentifier());</span>
<span class="nc" id="L1333">				statement.executeUpdate();</span>
<span class="nc" id="L1334">			}</span>

			//Part III: Record Changes	
<span class="nc" id="L1337">			ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L1338">				= ChangeEventGenerator.disassociateSupportingDocumentsChanges(user,</span>
						  													  variable,
						  													  supportingDocumentsToDelete);
<span class="nc" id="L1341">			registerChangeEvents(connection, changeEvents);	</span>
		}
<span class="nc" id="L1343">		catch(SQLException exception) {</span>
<span class="nc" id="L1344">			log.logException(exception);</span>
<span class="nc" id="L1345">			String errorMessage</span>
<span class="nc" id="L1346">				= MacawMessages.getMessage(&quot;sql.error.unableToDeleteDocumentsFromVariable&quot;,</span>
<span class="nc" id="L1347">											variable.getDisplayName());</span>
<span class="nc" id="L1348">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_DISASSOCIATE_DOCUMENT,
									 errorMessage);
<span class="nc" id="L1351">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1354">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}	
<span class="nc" id="L1356">	}</span>

	public ArrayList&lt;OntologyTerm&gt; getAssociatedOntologyTerms(Connection connection,
															  User user,
															  String variableName) throws MacawException {
		
<span class="nc" id="L1362">		checkVariableExists(connection, variableName);</span>
		
<span class="nc" id="L1364">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1365">		query.append(&quot;SELECT DISTINCT ontology_terms.identifier,&quot;);</span>
<span class="nc" id="L1366">		query.append(&quot;ontology_terms.term,&quot;);</span>
<span class="nc" id="L1367">		query.append(&quot;ontology_terms.ontology_name,&quot;);</span>
<span class="nc" id="L1368">		query.append(&quot;ontology_terms.description,&quot;);</span>
<span class="nc" id="L1369">		query.append(&quot;ontology_terms.name_space &quot;);</span>
<span class="nc" id="L1370">		query.append(&quot;FROM ontology_terms, ontology_terms_for_variables, variables &quot;);</span>
<span class="nc" id="L1371">		query.append(&quot;WHERE ontology_terms.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1372">		query.append(&quot;variables.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1373">		query.append(&quot;ontology_terms.identifier=&quot;);</span>
<span class="nc" id="L1374">		query.append(&quot;ontology_terms_for_variables.ontology_term_id &quot;);</span>
<span class="nc" id="L1375">		query.append(&quot;AND variables.identifier=ontology_terms_for_variables.variable_id &quot;);</span>
<span class="nc" id="L1376">		query.append(&quot;AND variables.name=?;&quot;);</span>
		
<span class="nc" id="L1378">		ResultSet resultSet = null;</span>
<span class="nc" id="L1379">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1381">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1382">			statement.setString(1, variableName);</span>
<span class="nc" id="L1383">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L1384">			ArrayList&lt;OntologyTerm&gt; results</span>
				= new ArrayList&lt;OntologyTerm&gt;();
<span class="nc bnc" id="L1386" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L1387">				OntologyTerm ontologyTerm = new OntologyTerm();</span>
<span class="nc" id="L1388">				ontologyTerm.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L1389">				ontologyTerm.setTerm(resultSet.getString(2));								</span>
<span class="nc" id="L1390">				ontologyTerm.setOntologyName(resultSet.getString(3));</span>
<span class="nc" id="L1391">				ontologyTerm.setDescription(resultSet.getString(4));</span>
<span class="nc" id="L1392">				ontologyTerm.setNameSpace(resultSet.getString(5));</span>
<span class="nc" id="L1393">				results.add(ontologyTerm);	</span>
<span class="nc" id="L1394">			}</span>
<span class="nc" id="L1395">			return results;</span>
		}
<span class="nc" id="L1397">		catch(SQLException exception) {</span>
<span class="nc" id="L1398">			String errorMessage</span>
<span class="nc" id="L1399">				= MacawMessages.getMessage(&quot;sql.error.unableToGetOntologyTerms&quot;,</span>
											variableName);
<span class="nc" id="L1401">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ONTOLOGY_TERMS,
									 errorMessage);
<span class="nc" id="L1404">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1407">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
	}

	public ArrayList&lt;OntologyTerm&gt; getAssociatedOntologyTerms(Connection connection,
															  User user,
															  Variable variable) throws MacawException {

		
<span class="nc" id="L1416">		checkVariableExists(connection, variable);</span>

<span class="nc" id="L1418">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1419">		query.append(&quot;SELECT DISTINCT ontology_terms.identifier,&quot;);</span>
<span class="nc" id="L1420">		query.append(&quot;ontology_terms.term,&quot;);</span>
<span class="nc" id="L1421">		query.append(&quot;ontology_terms.ontology_name,&quot;);</span>
<span class="nc" id="L1422">		query.append(&quot;ontology_terms.description,&quot;);</span>
<span class="nc" id="L1423">		query.append(&quot;ontology_terms.name_space &quot;);</span>
<span class="nc" id="L1424">		query.append(&quot;FROM ontology_terms, ontology_terms_for_variables, &quot;);</span>
<span class="nc" id="L1425">		query.append(&quot;variables &quot;);</span>
<span class="nc" id="L1426">		query.append(&quot;WHERE ontology_terms.deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1427">		query.append(&quot;ontology_terms.identifier=&quot;);</span>
<span class="nc" id="L1428">		query.append(&quot;ontology_terms_for_variables.ontology_term_id &quot;);</span>
<span class="nc" id="L1429">		query.append(&quot;AND ontology_terms_for_variables.variable_id=?;&quot;);</span>

<span class="nc" id="L1431">		ResultSet resultSet = null;</span>
<span class="nc" id="L1432">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1434">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1435">			statement.setInt(1, variable.getIdentifier());</span>
<span class="nc" id="L1436">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L1437">			ArrayList&lt;OntologyTerm&gt; results</span>
				= new ArrayList&lt;OntologyTerm&gt;();
<span class="nc bnc" id="L1439" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L1440">				OntologyTerm ontologyTerm = new OntologyTerm();</span>
<span class="nc" id="L1441">				ontologyTerm.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L1442">				ontologyTerm.setTerm(resultSet.getString(2));</span>

<span class="nc" id="L1444">				ontologyTerm.setOntologyName(resultSet.getString(3));</span>
<span class="nc" id="L1445">				ontologyTerm.setDescription(resultSet.getString(4));</span>
<span class="nc" id="L1446">				ontologyTerm.setNameSpace(resultSet.getString(5));</span>
<span class="nc" id="L1447">				results.add(ontologyTerm);	</span>
<span class="nc" id="L1448">			}</span>
<span class="nc" id="L1449">			return results;</span>
		}
<span class="nc" id="L1451">		catch(SQLException exception) {</span>
<span class="nc" id="L1452">			String errorMessage</span>
<span class="nc" id="L1453">				= MacawMessages.getMessage(&quot;sql.error.unableToGetOntologyTerms&quot;,</span>
<span class="nc" id="L1454">											variable.getDisplayName());</span>
<span class="nc" id="L1455">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ONTOLOGY_TERMS,
									 errorMessage);
<span class="nc" id="L1458">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1461">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
	}
	
	public void associateOntologyTerms(Connection connection,
			   						   User user,
			   						   Variable variable,
			   						   ArrayList&lt;OntologyTerm&gt; ontologyTermsToAssociate) throws MacawException {

		
		//Part I: Validate parameters
<span class="nc" id="L1472">		checkVariableExists(connection, variable);	</span>
<span class="nc bnc" id="L1473" title="All 2 branches missed.">		for (OntologyTerm ontologyTermToAssociate : ontologyTermsToAssociate) {</span>
<span class="nc" id="L1474">			ontologyTermManager.checkOntologyTermExists(connection, ontologyTermToAssociate);</span>
<span class="nc" id="L1475">			checkDuplicateTermAssociation(connection, variable, ontologyTermToAssociate);			</span>
<span class="nc" id="L1476">		}</span>
		
<span class="nc" id="L1478">		int variableID = variable.getIdentifier();</span>

<span class="nc" id="L1480">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1481">		query.append(&quot;INSERT INTO ontology_terms_for_variables &quot;);</span>
<span class="nc" id="L1482">		query.append(&quot;(ontology_term_id, variable_id) &quot;);</span>
<span class="nc" id="L1483">		query.append(&quot;VALUES (?,?);&quot;);</span>
<span class="nc" id="L1484">		ResultSet resultSet = null;</span>
<span class="nc" id="L1485">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1487">			statement = connection.prepareStatement(query.toString());			</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">			for (OntologyTerm currentOntologyTerm : ontologyTermsToAssociate) {</span>
<span class="nc" id="L1489">				statement.setInt(1, currentOntologyTerm.getIdentifier());</span>
<span class="nc" id="L1490">				statement.setInt(2, variableID);</span>
<span class="nc" id="L1491">				statement.executeUpdate();</span>
<span class="nc" id="L1492">			}</span>

			//Part III: Record changes
			//
		}
<span class="nc" id="L1497">		catch(SQLException exception) {</span>
<span class="nc" id="L1498">			log.logException(exception);</span>
<span class="nc" id="L1499">			String errorMessage</span>
<span class="nc" id="L1500">				= MacawMessages.getMessage(&quot;sql.error.unableToAddOntologyTermsToVariable&quot;,</span>
<span class="nc" id="L1501">											variable.getDisplayName());</span>
<span class="nc" id="L1502">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_ASSOCIATE_ONTOLOGY_TERM,
									 errorMessage);
<span class="nc" id="L1505">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1508">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
<span class="nc" id="L1510">	}</span>

	public void disassociateOntologyTerms(Connection connection,
										  User user,
										  Variable variable,
										  ArrayList&lt;OntologyTerm&gt; ontologyTerms) throws MacawException {

<span class="nc" id="L1517">		checkVariableExists(connection, variable);	</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">		for (OntologyTerm currentOntologyTerm : ontologyTerms) {</span>
<span class="nc" id="L1519">			ontologyTermManager.checkOntologyTermExists(connection, currentOntologyTerm);</span>
<span class="nc" id="L1520">			checkTermAssociationExists(connection, variable, currentOntologyTerm);</span>
<span class="nc" id="L1521">		}</span>
		
<span class="nc" id="L1523">		int variableID = variable.getIdentifier();</span>

<span class="nc" id="L1525">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1526">		query.append(&quot;DELETE FROM ontology_terms_for_variables &quot;);</span>
<span class="nc" id="L1527">		query.append(&quot;WHERE variable_id=? AND ontology_term_id=?;&quot;);</span>

<span class="nc" id="L1529">		ResultSet resultSet = null;</span>
<span class="nc" id="L1530">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1532">			statement = connection.prepareStatement(query.toString());			</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">			for (OntologyTerm currentOntologyTerm : ontologyTerms) {</span>
<span class="nc" id="L1534">				statement.setInt(1, variableID);</span>
<span class="nc" id="L1535">				statement.setInt(2, currentOntologyTerm.getIdentifier());</span>
<span class="nc" id="L1536">				statement.executeUpdate();</span>
<span class="nc" id="L1537">			}			</span>

			//Part III: Record changes
			//
		}
<span class="nc" id="L1542">		catch(SQLException exception) {</span>
<span class="nc" id="L1543">			log.logException(exception);</span>
<span class="nc" id="L1544">			String errorMessage</span>
<span class="nc" id="L1545">				= MacawMessages.getMessage(&quot;sql.error.unableToDeleteOntologyTermsFromVariable&quot;,</span>
<span class="nc" id="L1546">											variable.getDisplayName());</span>
<span class="nc" id="L1547">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_DISASSOCIATE_ONTOLOGY_TERM,
								 	errorMessage);
<span class="nc" id="L1550">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1553">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
<span class="nc" id="L1555">	}</span>
	
	public Variable getCompleteVariableData(Connection connection,
											User user, 
											VariableSummary variableSummary) throws MacawException {
		
		
<span class="nc" id="L1562">		int identifier = variableSummary.getIdentifier();</span>
<span class="nc bnc" id="L1563" title="All 2 branches missed.">		if (variableSummary.isDerived() == true) {</span>
<span class="nc" id="L1564">			DerivedVariable derivedVariable</span>
<span class="nc" id="L1565">				= getDerivedVariable(connection, identifier);</span>
<span class="nc" id="L1566">			return derivedVariable;</span>
		}
		else {
<span class="nc" id="L1569">			RawVariable rawVariable</span>
<span class="nc" id="L1570">				= getRawVariable(connection, identifier);</span>
<span class="nc" id="L1571">			return rawVariable;</span>
		}
	}

	//assumes that variable exists
	public RawVariable getRawVariable(Connection connection,
									  int variableID) throws MacawException {

<span class="nc" id="L1579">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1580">		query.append(&quot;SELECT &quot;);</span>
<span class="nc" id="L1581">		query.append(&quot;category_id,&quot;);</span>
<span class="nc" id="L1582">		query.append(&quot;name,&quot;);</span>
<span class="nc" id="L1583">		query.append(&quot;year,&quot;);</span>
<span class="nc" id="L1584">		query.append(&quot;form,&quot;);</span>
<span class="nc" id="L1585">		query.append(&quot;question_number,&quot;);</span>
<span class="nc" id="L1586">		query.append(&quot;label,&quot;);</span>
<span class="nc" id="L1587">		query.append(&quot;is_coded,&quot;);</span>
<span class="nc" id="L1588">		query.append(&quot;is_cleaned,&quot;);</span>
<span class="nc" id="L1589">		query.append(&quot;cleaning_status_id,&quot;);</span>
<span class="nc" id="L1590">		query.append(&quot;cleaning_description,&quot;);</span>
<span class="nc" id="L1591">		query.append(&quot;availability_id,&quot;);</span>
<span class="nc" id="L1592">		query.append(&quot;code_book_number,&quot;);</span>
<span class="nc" id="L1593">		query.append(&quot;column_start,&quot;);</span>
<span class="nc" id="L1594">		query.append(&quot;column_end,&quot;);</span>
<span class="nc" id="L1595">		query.append(&quot;alias_id,&quot;);</span>
<span class="nc" id="L1596">		query.append(&quot;notes,&quot;);</span>
<span class="nc" id="L1597">		query.append(&quot;alternative_variable_id &quot;);</span>
<span class="nc" id="L1598">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L1599">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1600">		query.append(&quot;identifier=?;&quot;);</span>

<span class="nc" id="L1602">		ResultSet resultSet = null;</span>
<span class="nc" id="L1603">		PreparedStatement statement = null;		</span>
		try {
<span class="nc" id="L1605">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1606">			statement.setInt(1, variableID);</span>
<span class="nc" id="L1607">			resultSet = statement.executeQuery();</span>
			//there should be exactly one result
<span class="nc" id="L1609">			resultSet.next();</span>

<span class="nc" id="L1611">			RawVariable rawVariable = new RawVariable();</span>
<span class="nc" id="L1612">			rawVariable.setIdentifier(variableID);</span>

<span class="nc" id="L1614">			int categoryID = resultSet.getInt(1);</span>

<span class="nc" id="L1616">			rawVariable.setName(resultSet.getString(2));</span>
<span class="nc" id="L1617">			rawVariable.setYear(resultSet.getString(3));</span>
<span class="nc" id="L1618">			rawVariable.setForm(resultSet.getString(4));</span>
<span class="nc" id="L1619">			rawVariable.setQuestionNumber(resultSet.getString(5));</span>
			
<span class="nc" id="L1621">			rawVariable.setLabel(resultSet.getString(6));</span>
<span class="nc" id="L1622">			rawVariable.setCoded(resultSet.getBoolean(7));</span>
<span class="nc" id="L1623">			rawVariable.setCleaned(resultSet.getBoolean(8));</span>
<span class="nc" id="L1624">			rawVariable.setCleaningDescription(resultSet.getString(10));</span>

<span class="nc" id="L1626">			int availabilityID = resultSet.getInt(11);</span>

<span class="nc" id="L1628">			rawVariable.setCodeBookNumber(resultSet.getString(12));</span>
<span class="nc" id="L1629">			rawVariable.setColumnStart(resultSet.getString(13));</span>
<span class="nc" id="L1630">			rawVariable.setColumnEnd(resultSet.getString(14));</span>
			
<span class="nc" id="L1632">			int aliasID = resultSet.getInt(15);			</span>

<span class="nc" id="L1634">			String categoryName </span>
<span class="nc" id="L1635">				= listChoiceManager.getCategoryName(connection, </span>
													rawVariable,
													categoryID);
<span class="nc" id="L1638">			rawVariable.setCategory(categoryName);</span>
<span class="nc bnc" id="L1639" title="All 2 branches missed.">			if (rawVariable.isCleaned() == true) {</span>
<span class="nc" id="L1640">				int cleaningStatusID = resultSet.getInt(9);</span>
<span class="nc" id="L1641">				String cleaningStatus </span>
<span class="nc" id="L1642">					= listChoiceManager.getCleaningStateName(connection, </span>
															 rawVariable,
															 cleaningStatusID);
<span class="nc" id="L1645">				rawVariable.setCleaningStatus(cleaningStatus);				</span>
<span class="nc" id="L1646">			}</span>
			else {
<span class="nc" id="L1648">				rawVariable.setCleaningStatus(MacawMessages.getMessage(&quot;general.fieldValue.unknown&quot;));</span>
			}

<span class="nc" id="L1651">			String availability </span>
<span class="nc" id="L1652">				= listChoiceManager.getAvailabilityStateName(connection, </span>
															 rawVariable,
															 availabilityID);
<span class="nc" id="L1655">			rawVariable.setAvailability(availability);</span>

<span class="nc" id="L1657">			rawVariable.setNotes(resultSet.getString(16));</span>
<span class="nc" id="L1658">			int alternativeVariableID = resultSet.getInt(17);			</span>
<span class="nc bnc" id="L1659" title="All 2 branches missed.">			if (alternativeVariableID != 0) {</span>
<span class="nc bnc" id="L1660" title="All 2 branches missed.">				if (isDerivedVariable(connection, alternativeVariableID) == true) {</span>
<span class="nc" id="L1661">					DerivedVariable alternativeVariable</span>
<span class="nc" id="L1662">						= this.getDerivedVariable(connection, alternativeVariableID);</span>
<span class="nc" id="L1663">					rawVariable.setAlternativeVariable(alternativeVariable);					</span>
<span class="nc" id="L1664">				}</span>
				else {
<span class="nc" id="L1666">					RawVariable alternativeVariable</span>
<span class="nc" id="L1667">						= getRawVariable(connection, alternativeVariableID);</span>
<span class="nc" id="L1668">					rawVariable.setAlternativeVariable(alternativeVariable);</span>
				}
			}
			
<span class="nc" id="L1672">			getAliasInformation(connection,</span>
		 						aliasID,
		 						rawVariable);

<span class="nc" id="L1676">			return rawVariable;</span>
		}
<span class="nc" id="L1678">		catch(SQLException exception) {</span>
<span class="nc" id="L1679">			exception.printStackTrace(System.out);</span>
<span class="nc" id="L1680">			String errorMessage</span>
<span class="nc" id="L1681">				= MacawMessages.getMessage(&quot;sql.error.unableToGetRawVariable&quot;);</span>
<span class="nc" id="L1682">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_RAW_VARIABLE,
									 errorMessage);
<span class="nc" id="L1685">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L1688">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
	}

	//assumes that variable exists
	public DerivedVariable getDerivedVariable(Connection connection,
 	   	  									  int variableID) throws MacawException {

<span class="nc" id="L1696">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1697">		query.append(&quot;SELECT &quot;);</span>
<span class="nc" id="L1698">		query.append(&quot;category_id,&quot;);</span>
<span class="nc" id="L1699">		query.append(&quot;name,&quot;);</span>
<span class="nc" id="L1700">		query.append(&quot;year,&quot;);</span>
<span class="nc" id="L1701">		query.append(&quot;form,&quot;);</span>
<span class="nc" id="L1702">		query.append(&quot;question_number,&quot;);</span>
<span class="nc" id="L1703">		query.append(&quot;label,&quot;);</span>
<span class="nc" id="L1704">		query.append(&quot;is_coded,&quot;);</span>
<span class="nc" id="L1705">		query.append(&quot;is_cleaned,&quot;);</span>
<span class="nc" id="L1706">		query.append(&quot;cleaning_status_id,&quot;);</span>
<span class="nc" id="L1707">		query.append(&quot;cleaning_description,&quot;);</span>
<span class="nc" id="L1708">		query.append(&quot;availability_id,&quot;);</span>
<span class="nc" id="L1709">		query.append(&quot;code_book_number,&quot;);</span>
<span class="nc" id="L1710">		query.append(&quot;column_start,&quot;);</span>
<span class="nc" id="L1711">		query.append(&quot;column_end,&quot;);</span>
<span class="nc" id="L1712">		query.append(&quot;alias_id,&quot;);</span>
<span class="nc" id="L1713">		query.append(&quot;notes,&quot;);</span>
<span class="nc" id="L1714">		query.append(&quot;alternative_variable_id &quot;);</span>
<span class="nc" id="L1715">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L1716">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1717">		query.append(&quot;variables.identifier=?;&quot;);</span>

<span class="nc" id="L1719">		ResultSet resultSet = null;</span>
<span class="nc" id="L1720">		PreparedStatement statement = null;		</span>
		try {
<span class="nc" id="L1722">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1723">			statement.setInt(1, variableID);</span>
<span class="nc" id="L1724">			resultSet = statement.executeQuery();</span>
			//there should be exactly one result
<span class="nc" id="L1726">			resultSet.next();</span>

<span class="nc" id="L1728">			DerivedVariable derivedVariable = new DerivedVariable();</span>
<span class="nc" id="L1729">			derivedVariable.setIdentifier(variableID);</span>

<span class="nc" id="L1731">			int categoryID = resultSet.getInt(1);</span>

<span class="nc" id="L1733">			derivedVariable.setName(resultSet.getString(2));</span>

<span class="nc" id="L1735">			derivedVariable.setYear(resultSet.getString(3));</span>
<span class="nc" id="L1736">			derivedVariable.setForm(resultSet.getString(4));</span>
<span class="nc" id="L1737">			derivedVariable.setQuestionNumber(resultSet.getString(5));</span>
			
<span class="nc" id="L1739">			derivedVariable.setLabel(resultSet.getString(6));</span>
<span class="nc" id="L1740">			derivedVariable.setCoded(resultSet.getBoolean(7));</span>
<span class="nc" id="L1741">			derivedVariable.setCleaned(resultSet.getBoolean(8));</span>

<span class="nc" id="L1743">			derivedVariable.setCleaningDescription(resultSet.getString(10));</span>

<span class="nc" id="L1745">			int availabilityID = resultSet.getInt(11);</span>

<span class="nc" id="L1747">			derivedVariable.setCodeBookNumber(resultSet.getString(12));</span>
<span class="nc" id="L1748">			derivedVariable.setColumnStart(resultSet.getString(13));</span>
<span class="nc" id="L1749">			derivedVariable.setColumnEnd(resultSet.getString(14));</span>

<span class="nc" id="L1751">			int aliasID = resultSet.getInt(15);			</span>
<span class="nc" id="L1752">			derivedVariable.setAlias(resultSet.getString(16));</span>

			//get list choices
<span class="nc" id="L1755">			String categoryName </span>
<span class="nc" id="L1756">				= listChoiceManager.getCategoryName(connection, </span>
													derivedVariable,
													categoryID);
<span class="nc" id="L1759">			derivedVariable.setCategory(categoryName);</span>
<span class="nc" id="L1760">			String availability </span>
<span class="nc" id="L1761">				= listChoiceManager.getAvailabilityStateName(connection, </span>
															 derivedVariable,
															 availabilityID);
<span class="nc" id="L1764">			derivedVariable.setAvailability(availability);</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">			if (derivedVariable.isCleaned() == true) {</span>
<span class="nc" id="L1766">				int cleaningStatusID = resultSet.getInt(9);</span>
<span class="nc" id="L1767">				String cleaningStatus </span>
<span class="nc" id="L1768">					= listChoiceManager.getCleaningStateName(connection, </span>
															 derivedVariable,
															 cleaningStatusID);
<span class="nc" id="L1771">				derivedVariable.setCleaningStatus(cleaningStatus);				</span>
<span class="nc" id="L1772">			}</span>
			else {
<span class="nc" id="L1774">				derivedVariable.setCleaningStatus(MacawMessages.getMessage(&quot;general.fieldValue.unknown&quot;));</span>
			}

<span class="nc" id="L1777">			derivedVariable.setNotes(resultSet.getString(16));</span>
<span class="nc" id="L1778">			int alternativeVariableID = resultSet.getInt(17);			</span>
<span class="nc bnc" id="L1779" title="All 2 branches missed.">			if (alternativeVariableID != 0) {</span>
<span class="nc bnc" id="L1780" title="All 2 branches missed.">				if (isDerivedVariable(connection, alternativeVariableID) == true) {</span>
<span class="nc" id="L1781">					DerivedVariable alternativeVariable</span>
<span class="nc" id="L1782">						= this.getDerivedVariable(connection, alternativeVariableID);</span>
<span class="nc" id="L1783">					derivedVariable.setAlternativeVariable(derivedVariable);					</span>
<span class="nc" id="L1784">				}</span>
				else {
<span class="nc" id="L1786">					RawVariable alternativeVariable</span>
<span class="nc" id="L1787">						= getRawVariable(connection, alternativeVariableID);</span>
<span class="nc" id="L1788">					derivedVariable.setAlternativeVariable(alternativeVariable);</span>
				}
			}
			
<span class="nc" id="L1792">			getAliasInformation(connection,</span>
					 			aliasID,
					 			derivedVariable);

<span class="nc" id="L1796">			return derivedVariable;</span>
		}
<span class="nc" id="L1798">		catch(SQLException exception) {</span>
<span class="nc" id="L1799">			exception.printStackTrace(System.out);</span>
<span class="nc" id="L1800">			String errorMessage</span>
<span class="nc" id="L1801">				= MacawMessages.getMessage(&quot;sql.error.unableToGetDerivedVariable&quot;,</span>
<span class="nc" id="L1802">											String.valueOf(variableID));</span>
<span class="nc" id="L1803">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_DERIVED_VARIABLE,
									 errorMessage);
<span class="nc" id="L1806">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L1809">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}			
	}
	
	private void getAliasInformation(Connection connection,
									 int aliasID,
									 Variable variable) throws SQLException {

<span class="nc" id="L1817">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1818">		query.append(&quot;SELECT alias,&quot;);</span>
<span class="nc" id="L1819">		query.append(&quot;file_path &quot;);</span>
<span class="nc" id="L1820">		query.append(&quot;FROM alias_file_paths &quot;);</span>
<span class="nc" id="L1821">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1822">		query.append(&quot;identifier=?;&quot;);</span>
		
<span class="nc" id="L1824">		ResultSet resultSet = null;</span>
<span class="nc" id="L1825">		PreparedStatement statement = null;</span>

<span class="nc" id="L1827">		statement</span>
<span class="nc" id="L1828">			= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1829">		statement.setInt(1, aliasID);</span>
<span class="nc" id="L1830">		resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L1831" title="All 2 branches missed.">		if (resultSet.next() == true) {</span>
<span class="nc" id="L1832">			String alias = resultSet.getString(1);</span>
<span class="nc" id="L1833">			String filePath = resultSet.getString(2);</span>
<span class="nc" id="L1834">			variable.setAlias(alias);</span>
<span class="nc" id="L1835">			variable.setFilePath(filePath);</span>
		}
<span class="nc" id="L1837">	}</span>
	
	public ArrayList&lt;VariableSummary&gt; getSummaryDataForAllVariables(Connection connection) throws MacawException {

<span class="nc" id="L1841">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1842">		query.append(&quot;SELECT identifier,&quot;);</span>
<span class="nc" id="L1843">		query.append(&quot;name,&quot;);</span>
<span class="nc" id="L1844">		query.append(&quot;year,&quot;);</span>
<span class="nc" id="L1845">		query.append(&quot;label,&quot;);</span>
<span class="nc" id="L1846">		query.append(&quot;is_derived_variable &quot;);</span>
<span class="nc" id="L1847">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L1848">		query.append(&quot;WHERE deleted_at IS NULL &quot;);</span>
<span class="nc" id="L1849">		query.append(&quot;ORDER BY year ASC;&quot;);</span>

<span class="nc" id="L1851">		ResultSet resultSet = null;</span>
<span class="nc" id="L1852">		PreparedStatement statement = null;</span>
		try {
			
<span class="nc" id="L1855">			ArrayList&lt;VariableSummary&gt; variableSummaries </span>
				= new ArrayList&lt;VariableSummary&gt;();
<span class="nc" id="L1857">			statement</span>
<span class="nc" id="L1858">				= connection.prepareStatement(query.toString());			</span>
<span class="nc" id="L1859">			resultSet = statement.executeQuery();			</span>
			
<span class="nc bnc" id="L1861" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
				
<span class="nc" id="L1863">				VariableSummary variableSummary = new VariableSummary();</span>
<span class="nc" id="L1864">				variableSummary.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L1865">				variableSummary.setName(resultSet.getString(2));</span>

<span class="nc" id="L1867">				String year = resultSet.getString(3);</span>
<span class="nc" id="L1868">				variableSummary.setYear( year);</span>
<span class="nc" id="L1869">				variableSummary.setLabel(resultSet.getString(4));</span>
				
				
<span class="nc bnc" id="L1872" title="All 2 branches missed.">				if (resultSet.getInt(5) == 1) {</span>
<span class="nc" id="L1873">					variableSummary.setDerived(true);</span>
				}
				else {
<span class="nc" id="L1876">					variableSummary.setDerived(false);</span>
				}
				
<span class="nc" id="L1879">				variableSummaries.add(variableSummary);</span>
<span class="nc" id="L1880">			}</span>
			
<span class="nc" id="L1882">			return variableSummaries;</span>
		}
<span class="nc" id="L1884">		catch(SQLException exception) {</span>
<span class="nc" id="L1885">			log.logException(exception);</span>
<span class="nc" id="L1886">			String errorMessage</span>
<span class="nc" id="L1887">				= MacawMessages.getMessage(&quot;sql.error.unableToGetSummaryVariableData&quot;);</span>
<span class="nc" id="L1888">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ALL_SUMMARY_VARIABLES,
									 errorMessage);
<span class="nc" id="L1891">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1894">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
	}
	
	public String[] getVariableNames(Connection connection, User user) throws MacawException {

<span class="nc" id="L1900">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1901">		query.append(&quot;SELECT name &quot;);</span>
<span class="nc" id="L1902">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L1903">		query.append(&quot;WHERE deleted_at IS NULL &quot;);</span>
<span class="nc" id="L1904">		query.append(&quot;ORDER BY name ASC;&quot;);</span>

<span class="nc" id="L1906">		ResultSet resultSet = null;</span>
<span class="nc" id="L1907">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1909">			ArrayList&lt;String&gt; variableNames = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L1911">			statement</span>
<span class="nc" id="L1912">				= connection.prepareStatement(query.toString());			</span>
<span class="nc" id="L1913">			resultSet = statement.executeQuery();</span>
			
<span class="nc bnc" id="L1915" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L1916">				variableNames.add(resultSet.getString(1));</span>
			}

<span class="nc" id="L1919">			String[] results </span>
<span class="nc" id="L1920">				= variableNames.toArray(new String[0]);</span>
<span class="nc" id="L1921">			return results;</span>
		}
<span class="nc" id="L1923">		catch(SQLException exception) {</span>
<span class="nc" id="L1924">			log.logException(exception);</span>
<span class="nc" id="L1925">			String errorMessage</span>
<span class="nc" id="L1926">				= MacawMessages.getMessage(&quot;sql.error.unableToGetVariableNames&quot;);</span>
<span class="nc" id="L1927">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_VARIABLE_NAMES,
									 errorMessage);
<span class="nc" id="L1930">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L1933">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
	}

	public Variable getOriginalVariable(Connection connection,
										Variable targetVariable) throws MacawException {	

<span class="nc" id="L1940">		checkVariableExists(connection, targetVariable);</span>

		try {
<span class="nc" id="L1943">			int identifier = targetVariable.getIdentifier();</span>
<span class="nc bnc" id="L1944" title="All 2 branches missed.">			if (isDerivedVariable(connection, identifier) == true) {</span>
<span class="nc" id="L1945">				return getDerivedVariable(connection, identifier);</span>
			}	
			else {
<span class="nc" id="L1948">				return getRawVariable(connection, identifier);</span>
			}
		}
<span class="nc" id="L1951">		catch(SQLException exception) {</span>
			
<span class="nc" id="L1953">			String errorMessage</span>
<span class="nc" id="L1954">				= MacawMessages.getMessage(&quot;sql.error.unableToGetOriginalVariable&quot;,</span>
<span class="nc" id="L1955">											targetVariable.getDisplayName());</span>
<span class="nc" id="L1956">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ORIGINAL_VARIABLE,
									 errorMessage);
<span class="nc" id="L1959">			throw macawException;</span>
		}
	}

	private int getVariablePrimaryKey(Connection connection,
									  Variable variable) throws SQLException {

		//name, year, label should be enough to distinguish one 
		//variable from another.  Trying to save computation costs of
		//retrieving other things like category_id, 
		//
<span class="nc" id="L1970">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L1971">		query.append(&quot;SELECT identifier &quot;);</span>
<span class="nc" id="L1972">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L1973">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L1974">		query.append(&quot;name=? AND year=? AND label=? AND file_path=?;&quot;);</span>
		
<span class="nc" id="L1976">		ResultSet resultSet = null;</span>
<span class="nc" id="L1977">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L1979">			statement</span>
<span class="nc" id="L1980">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L1981">			statement.setString(1, variable.getName());</span>
<span class="nc" id="L1982">			statement.setString(2, variable.getYear());</span>
<span class="nc" id="L1983">			statement.setString(3, variable.getLabel());</span>
<span class="nc" id="L1984">			statement.setString(4, variable.getFilePath());</span>
<span class="nc" id="L1985">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L1986">			resultSet.next();</span>
<span class="nc" id="L1987">			return resultSet.getInt(1);			</span>
		}
		finally {
<span class="nc" id="L1990">			SQLUtilities.closeStatementsWithoutCatch(statement, resultSet);</span>
		}		
	}
	
	/**
	 * assumes that variable exists
	 * @param connection
	 * @param variableIdentifier
	 * @return
	 * @throws SQLException
	 */
	private boolean isDerivedVariable(Connection connection,
									  int variableIdentifier) throws SQLException {
		
<span class="nc" id="L2004">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2005">		query.append(&quot;SELECT is_derived_variable &quot;);</span>
<span class="nc" id="L2006">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L2007">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L2008">		query.append(&quot;identifier=?;&quot;);</span>
		
<span class="nc" id="L2010">		PreparedStatement statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L2011">		statement.setInt(1, variableIdentifier);</span>
<span class="nc" id="L2012">		ResultSet resultSet = statement.executeQuery();</span>
<span class="nc" id="L2013">		resultSet.next();</span>
<span class="nc" id="L2014">		return resultSet.getBoolean(1);</span>
	}
	
	public void clear(Connection connection) throws MacawException {

<span class="nc" id="L2019">		ResultSet resultSet = null;</span>
<span class="nc" id="L2020">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L2022">			statement</span>
<span class="nc" id="L2023">				= connection.prepareStatement(&quot;DELETE FROM variables;&quot;);</span>
<span class="nc" id="L2024">			statement.executeUpdate();</span>

<span class="nc" id="L2026">			statement</span>
<span class="nc" id="L2027">				= connection.prepareStatement(&quot;DELETE FROM supporting_documents_for_variables;&quot;);</span>
<span class="nc" id="L2028">			statement.executeUpdate();</span>
			
<span class="nc" id="L2030">			statement</span>
<span class="nc" id="L2031">				= connection.prepareStatement(&quot;DELETE FROM ontology_terms_for_variables;&quot;);</span>
<span class="nc" id="L2032">			statement.executeUpdate();</span>

<span class="nc" id="L2034">			statement</span>
<span class="nc" id="L2035">				= connection.prepareStatement(&quot;DELETE FROM source_variables;&quot;);</span>
<span class="nc" id="L2036">			statement.executeUpdate();</span>
		}
<span class="nc" id="L2038">		catch(SQLException exception) {</span>
<span class="nc" id="L2039">			exception.printStackTrace(System.out);</span>
<span class="nc" id="L2040">			String errorMessage</span>
<span class="nc" id="L2041">				= MacawMessages.getMessage(&quot;sql.error.unableToClearTable&quot;);</span>
<span class="nc" id="L2042">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_CLEAR_TABLE,
									 errorMessage);
<span class="nc" id="L2045">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L2048">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}
<span class="nc" id="L2050">	}</span>
	
	public Variable getAlternativeVariable(Connection connection,
										   User user,
										   Variable targetVariable) throws MacawException {

<span class="nc" id="L2056">		checkVariableExists(connection, targetVariable);</span>

<span class="nc" id="L2058">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2059">		query.append(&quot;SELECT alternative_variable_id &quot;);</span>
<span class="nc" id="L2060">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L2061">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L2062">		query.append(&quot;identifier=?;&quot;);</span>

<span class="nc" id="L2064">		ResultSet resultSet = null;</span>
<span class="nc" id="L2065">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L2067">			statement</span>
<span class="nc" id="L2068">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L2069">			statement.setInt(1, targetVariable.getIdentifier());</span>
<span class="nc" id="L2070">			resultSet = statement.executeQuery();</span>
			
<span class="nc" id="L2072">			resultSet.next();</span>
<span class="nc" id="L2073">			int alternativeVariableID = resultSet.getInt(1);</span>
			
<span class="nc" id="L2075">			Variable alternativeVariable = null;</span>
<span class="nc bnc" id="L2076" title="All 2 branches missed.">			if (alternativeVariableID != 0) {</span>
<span class="nc bnc" id="L2077" title="All 2 branches missed.">				if (isDerivedVariable(connection, alternativeVariableID) == true) {</span>
<span class="nc" id="L2078">					alternativeVariable = getDerivedVariable(connection, alternativeVariableID);</span>
				}
				else {
<span class="nc" id="L2081">					alternativeVariable = getRawVariable(connection, alternativeVariableID);</span>
				}
			}
<span class="nc" id="L2084">			return alternativeVariable;</span>
		}
<span class="nc" id="L2086">		catch(SQLException exception) {</span>
<span class="nc" id="L2087">			String errorMessage</span>
<span class="nc" id="L2088">				= MacawMessages.getMessage(&quot;sql.error.unableToGetAlternativeVariable&quot;,</span>
<span class="nc" id="L2089">											targetVariable.getDisplayName());</span>
<span class="nc" id="L2090">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ALTERNATIVE_VARIABLE,
									 errorMessage);
<span class="nc" id="L2093">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L2096">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
	}

	public void setAlternativeVariable(Connection connection,
									   User user, 
									   Variable targetVariable,
									   Variable updatedAlternativeVariable) throws MacawException {

		//Part I: Check parameters
<span class="nc" id="L2106">		checkVariableExists(connection, targetVariable);</span>

<span class="nc bnc" id="L2108" title="All 2 branches missed.">		if (updatedAlternativeVariable != null) {</span>
<span class="nc" id="L2109">			checkVariableExists(connection, updatedAlternativeVariable);</span>

<span class="nc bnc" id="L2111" title="All 2 branches missed.">			if (targetVariable.getIdentifier() == updatedAlternativeVariable.getIdentifier()) {</span>
				//prevents a rare but nasty case of recursion!
<span class="nc" id="L2113">				String errorMessage</span>
<span class="nc" id="L2114">					= MacawMessages.getMessage(&quot;variable.error.selfReferencingAlternativeVariable&quot;,</span>
<span class="nc" id="L2115">												targetVariable.getDisplayName());</span>
<span class="nc" id="L2116">				MacawException exception</span>
					= new MacawException(MacawErrorType.SELF_REFERENCING_ALTERNATIVE_VARIABLE,
									 	 errorMessage);
<span class="nc" id="L2119">				throw exception;</span>
			}
		}
		
<span class="nc" id="L2123">		Variable oldAlternativeVariable</span>
<span class="nc" id="L2124">			= targetVariable.getAlternativeVariable();</span>
		
<span class="nc" id="L2126">		MacawChangeEvent changeEvent</span>
<span class="nc" id="L2127">			= Variable.detectChangesInAlternativeVariable(user, </span>
														  targetVariable, 
														  updatedAlternativeVariable);
<span class="nc bnc" id="L2130" title="All 2 branches missed.">		if (changeEvent == null) {</span>
			//no change so don't bother
<span class="nc" id="L2132">			return;</span>
		}
		
<span class="nc" id="L2135">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2136">		query.append(&quot;UPDATE variables &quot;);</span>
<span class="nc" id="L2137">		query.append(&quot;SET alternative_variable_id=? &quot;);</span>
<span class="nc" id="L2138">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L2139">		query.append(&quot;identifier=?;&quot;);</span>

<span class="nc" id="L2141">		PreparedStatement statement = null;</span>
		try {
			
			//Part II: Perform Update
<span class="nc" id="L2145">			statement</span>
<span class="nc" id="L2146">				= connection.prepareStatement(query.toString());</span>
<span class="nc bnc" id="L2147" title="All 2 branches missed.">			if (updatedAlternativeVariable == null) {</span>
<span class="nc" id="L2148">				statement.setInt(1, 0);</span>
			}
			else {
<span class="nc" id="L2151">				statement.setInt(1, updatedAlternativeVariable.getIdentifier());</span>
			}
<span class="nc" id="L2153">			statement.setInt(2, targetVariable.getIdentifier());</span>
			
<span class="nc" id="L2155">			statement.executeUpdate();</span>

			//Part III: Record changes
<span class="nc" id="L2158">			registerChangeEvent(connection, changeEvent);</span>
		}
<span class="nc" id="L2160">		catch(SQLException exception) {</span>
<span class="nc" id="L2161">			String errorMessage</span>
<span class="nc" id="L2162">				= MacawMessages.getMessage(&quot;sql.error.unableToUpdateAlternativeVariable&quot;,</span>
<span class="nc" id="L2163">											updatedAlternativeVariable.getDisplayName(),</span>
<span class="nc" id="L2164">											targetVariable.getDisplayName());</span>
<span class="nc" id="L2165">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_UPDATE_ALTERNATIVE_VARIABLE,
									 errorMessage);
<span class="nc" id="L2168">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L2171">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}	
<span class="nc" id="L2173">	}</span>

	// ==========================================
	// Section Errors and Validation
	// ==========================================
	
	private void checkVariableExists(Connection connection,
			   						 Variable targetVariable) throws MacawException {

<span class="nc" id="L2182">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2183">		query.append(&quot;SELECT 1 &quot;);</span>
<span class="nc" id="L2184">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L2185">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L2186">		query.append(&quot;identifier=?;&quot;);</span>
		
<span class="nc" id="L2188">		ResultSet resultSet = null;</span>
<span class="nc" id="L2189">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L2191">			int identifier</span>
<span class="nc" id="L2192">				= targetVariable.getIdentifier();</span>
<span class="nc" id="L2193">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L2194">			statement.setInt(1, identifier);</span>
<span class="nc" id="L2195">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L2196" title="All 2 branches missed.">			if (resultSet.next() == false) {</span>
<span class="nc" id="L2197">				String errorMessage</span>
<span class="nc" id="L2198">					= MacawMessages.getMessage(&quot;general.error.nonExistentItem&quot;,</span>
<span class="nc" id="L2199">												targetVariable.getDisplayName());</span>
<span class="nc" id="L2200">				MacawException exception </span>
					= new MacawException(MacawErrorType.NON_EXISTENT_VARIABLE,
										 errorMessage);
<span class="nc" id="L2203">				throw exception;					</span>
			}
		}
<span class="nc" id="L2206">		catch(SQLException exception) {</span>
<span class="nc" id="L2207">			String errorMessage</span>
<span class="nc" id="L2208">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckVariableExists&quot;,</span>
<span class="nc" id="L2209">											targetVariable.getDisplayName());</span>
<span class="nc" id="L2210">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_VARIABLE_EXISTS,
									 errorMessage);
<span class="nc" id="L2213">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L2216">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}					
<span class="nc" id="L2218">	}</span>

	private void checkVariableExists(Connection connection,
									String variableName) throws MacawException {

<span class="nc" id="L2223">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2224">		query.append(&quot;SELECT 1 &quot;);</span>
<span class="nc" id="L2225">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L2226">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L2227">		query.append(&quot;name=?;&quot;);</span>

<span class="nc" id="L2229">		ResultSet resultSet = null;</span>
<span class="nc" id="L2230">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L2232">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L2233">			statement.setString(1, variableName);</span>
<span class="nc" id="L2234">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L2235" title="All 2 branches missed.">			if (resultSet.next() == false) {</span>
<span class="nc" id="L2236">				String errorMessage</span>
<span class="nc" id="L2237">					= MacawMessages.getMessage(&quot;general.error.nonExistentItem&quot;,</span>
												variableName);
<span class="nc" id="L2239">				MacawException exception </span>
					= new MacawException(MacawErrorType.NON_EXISTENT_VARIABLE,
										 errorMessage);
<span class="nc" id="L2242">				throw exception;					</span>
			}
		}
<span class="nc" id="L2245">		catch(SQLException exception) {</span>
<span class="nc" id="L2246">			String errorMessage</span>
<span class="nc" id="L2247">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckVariableExists&quot;,</span>
											variableName);
<span class="nc" id="L2249">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_VARIABLE_EXISTS,
									 errorMessage);
<span class="nc" id="L2252">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L2255">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}					
<span class="nc" id="L2257">	}</span>
	
	private void checkVariableDuplicates(Connection connection,
										Variable candidateVariable) throws MacawException {


<span class="nc" id="L2263">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2264">		query.append(&quot;SELECT identifier &quot;);</span>
<span class="nc" id="L2265">		query.append(&quot;FROM variables &quot;);</span>
<span class="nc" id="L2266">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L2267">		query.append(&quot;name=?;&quot;);</span>
		
<span class="nc" id="L2269">		ResultSet resultSet = null;</span>
<span class="nc" id="L2270">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L2272">			String name</span>
<span class="nc" id="L2273">				= candidateVariable.getName();</span>
<span class="nc" id="L2274">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L2275">			statement.setString(1, name);</span>
<span class="nc" id="L2276">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L2277" title="All 2 branches missed.">			if (resultSet.next() == true) {</span>
<span class="nc" id="L2278">				int resultIdentifier = resultSet.getInt(1);</span>
<span class="nc bnc" id="L2279" title="All 2 branches missed.">				if (resultIdentifier != candidateVariable.getIdentifier()) {	</span>
					//items have same display name but different IDs. Therefore
					//the candidate is a duplicate
<span class="nc" id="L2282">					String errorMessage</span>
<span class="nc" id="L2283">						= MacawMessages.getMessage(&quot;variable.error.duplicateExists&quot;,</span>
<span class="nc" id="L2284">													candidateVariable.getDisplayName());</span>
<span class="nc" id="L2285">					MacawException exception</span>
						= new MacawException(MacawErrorType.DUPLICATE_VARIABLE,
											errorMessage);
<span class="nc" id="L2288">					throw exception;				</span>
				}
			}
		}
<span class="nc" id="L2292">		catch(SQLException exception) {</span>
<span class="nc" id="L2293">			String errorMessage</span>
<span class="nc" id="L2294">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckVariableDuplicates&quot;);</span>
<span class="nc" id="L2295">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_VARIABLE_DUPLICATES,
									 errorMessage);
<span class="nc" id="L2298">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L2301">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
<span class="nc" id="L2303">	}</span>

	private void checkDuplicateDocumentAssociation(Connection connection, 
			  									   Variable variable, 
			  									   SupportingDocument supportingDocument) throws MacawException {
		
		try {
<span class="nc bnc" id="L2310" title="All 2 branches missed.">			if (documentAssociationInDatabase(connection,</span>
<span class="nc" id="L2311">											  variable.getIdentifier(),</span>
<span class="nc" id="L2312">											  supportingDocument.getIdentifier()) == true) {</span>

<span class="nc" id="L2314">				String errorMessage</span>
<span class="nc" id="L2315">					= MacawMessages.getMessage(&quot;variable.error.duplicateDocumentAssociation&quot;,</span>
<span class="nc" id="L2316">												supportingDocument.getDisplayName(),</span>
<span class="nc" id="L2317">												variable.getDisplayName());</span>
<span class="nc" id="L2318">				MacawException exception </span>
					= new MacawException(MacawErrorType.DUPLICATE_DOCUMENT_ASSOCIATION,
										errorMessage);				
<span class="nc" id="L2321">				throw exception;</span>
			}
		}
<span class="nc" id="L2324">		catch(SQLException exception) {</span>
<span class="nc" id="L2325">			String errorMessage</span>
<span class="nc" id="L2326">				= MacawMessages.getMessage(&quot;sql.error.duplicate&quot;);</span>
<span class="nc" id="L2327">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_DOCUMENT_ASSOCIATION_DUPLICATE,
									 errorMessage);
<span class="nc" id="L2330">			throw macawException;</span>
<span class="nc" id="L2331">		}</span>
<span class="nc" id="L2332">	}</span>

	private void checkDocumentAssociationExists(Connection connection, 
												Variable variable, 
												SupportingDocument supportingDocument) throws MacawException {

		try {
<span class="nc bnc" id="L2339" title="All 2 branches missed.">			if (documentAssociationInDatabase(connection,</span>
<span class="nc" id="L2340">											  variable.getIdentifier(),</span>
<span class="nc" id="L2341">											  supportingDocument.getIdentifier()) == false) {</span>

<span class="nc" id="L2343">				MacawException exception = new MacawException();</span>
<span class="nc" id="L2344">				String errorMessage</span>
<span class="nc" id="L2345">					= MacawMessages.getMessage(&quot;variable.error.nonExistentDocumentAssociation&quot;,</span>
<span class="nc" id="L2346">												supportingDocument.getDisplayName(),</span>
<span class="nc" id="L2347">												variable.getDisplayName());</span>
<span class="nc" id="L2348">				exception.addErrorMessage(MacawErrorType.NON_EXISTENT_DOCUMENT_ASSOCIATION,</span>
										  errorMessage);
<span class="nc" id="L2350">				throw exception;</span>
			}
		}
<span class="nc" id="L2353">		catch(SQLException exception) {</span>
<span class="nc" id="L2354">			String errorMessage</span>
<span class="nc" id="L2355">				= MacawMessages.getMessage(&quot;sql.error.duplicate&quot;);</span>
<span class="nc" id="L2356">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_DOCUMENT_ASSOCIATION_EXISTS,
									 errorMessage);
<span class="nc" id="L2359">			throw macawException;</span>
<span class="nc" id="L2360">		}</span>
<span class="nc" id="L2361">	}</span>

	private boolean documentAssociationInDatabase(Connection connection,
												  int variableID,
												  int supportingDocumentID) throws SQLException {

<span class="nc" id="L2367">		PreparedStatement statement = null;</span>
<span class="nc" id="L2368">		ResultSet resultSet = null;</span>
		try {
<span class="nc" id="L2370">			StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2371">			query.append(&quot;SELECT 1 &quot;);</span>
<span class="nc" id="L2372">			query.append(&quot;FROM supporting_documents_for_variables &quot;);</span>
<span class="nc" id="L2373">			query.append(&quot;WHERE variable_id=? AND document_id=?;&quot;);</span>
		
<span class="nc" id="L2375">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L2376">			statement.setInt(1, variableID);</span>
<span class="nc" id="L2377">			statement.setInt(2, supportingDocumentID);</span>
<span class="nc" id="L2378">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L2379">			return resultSet.next();</span>
		}
		finally {
<span class="nc" id="L2382">			SQLUtilities.closeStatementsWithoutCatch(statement, resultSet);</span>
		}		
	}

	
	private void checkDuplicateTermAssociation(Connection connection, 
											   Variable variable, 
											   OntologyTerm ontologyTerm) throws MacawException {

		try {
<span class="nc bnc" id="L2392" title="All 2 branches missed.">			if (ontologyTermAssociationInDatabase(connection,</span>
<span class="nc" id="L2393">												  variable.getIdentifier(),</span>
<span class="nc" id="L2394">												  ontologyTerm.getIdentifier()) == true) {</span>

<span class="nc" id="L2396">				String errorMessage</span>
<span class="nc" id="L2397">					= MacawMessages.getMessage(&quot;variable.error.duplicateTermAssociation&quot;,</span>
<span class="nc" id="L2398">												variable.getDisplayName(),</span>
<span class="nc" id="L2399">												ontologyTerm.getDisplayName());</span>
<span class="nc" id="L2400">				MacawException exception </span>
					= new MacawException(MacawErrorType.DUPLICATE_ONTOLOGY_TERM_ASSOCIATION,
										 errorMessage);				
<span class="nc" id="L2403">				throw exception;</span>
			}
		}
<span class="nc" id="L2406">		catch(SQLException exception) {</span>
<span class="nc" id="L2407">			String errorMessage</span>
<span class="nc" id="L2408">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckOntologyTermAssociationDuplicate&quot;,</span>
<span class="nc" id="L2409">											variable.getDisplayName(),</span>
<span class="nc" id="L2410">											ontologyTerm.getDisplayName());</span>
<span class="nc" id="L2411">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_ONTOLOGY_TERM_ASSOCIATION_DUPLICATE,
									 errorMessage);
<span class="nc" id="L2414">			throw macawException;</span>
<span class="nc" id="L2415">		}</span>
<span class="nc" id="L2416">	}</span>

	private void checkTermAssociationExists(Connection connection, 
											Variable variable, 
											OntologyTerm ontologyTerm) throws MacawException {

		try {
<span class="nc bnc" id="L2423" title="All 2 branches missed.">			if (ontologyTermAssociationInDatabase(connection,</span>
<span class="nc" id="L2424">												  variable.getIdentifier(),</span>
<span class="nc" id="L2425">												  ontologyTerm.getIdentifier()) == false) {</span>

<span class="nc" id="L2427">				MacawException exception = new MacawException();</span>
<span class="nc" id="L2428">				String errorMessage</span>
<span class="nc" id="L2429">					= MacawMessages.getMessage(&quot;variable.error.nonExistentTermAssociation&quot;,</span>
<span class="nc" id="L2430">												variable.getDisplayName(),</span>
<span class="nc" id="L2431">												ontologyTerm.getDisplayName());</span>
<span class="nc" id="L2432">				exception.addErrorMessage(MacawErrorType.NON_EXISTENT_ONTOLOGY_TERM_ASSOCIATION,</span>
										  errorMessage);
<span class="nc" id="L2434">				throw exception;</span>
			}
		}
<span class="nc" id="L2437">		catch(SQLException exception) {</span>
<span class="nc" id="L2438">			String errorMessage</span>
<span class="nc" id="L2439">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckOntologyTermAssociationExists&quot;,</span>
<span class="nc" id="L2440">											variable.getDisplayName(),</span>
<span class="nc" id="L2441">											ontologyTerm.getDisplayName());</span>
<span class="nc" id="L2442">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_ONTOLOGY_TERM_ASSOCIATION_EXISTS,
									 errorMessage);
<span class="nc" id="L2445">			throw macawException;</span>
<span class="nc" id="L2446">		}</span>
<span class="nc" id="L2447">	}</span>

	private boolean ontologyTermAssociationInDatabase(Connection connection,
			  										  int variableID,
			  										  int ontologyTermID) throws SQLException {

<span class="nc" id="L2453">		PreparedStatement statement = null;</span>
<span class="nc" id="L2454">		ResultSet resultSet = null;</span>
		try {
<span class="nc" id="L2456">			StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2457">			query.append(&quot;SELECT 1 &quot;);</span>
<span class="nc" id="L2458">			query.append(&quot;FROM ontology_terms_for_variables &quot;);</span>
<span class="nc" id="L2459">			query.append(&quot;WHERE variable_id=? AND ontology_term_id=?;&quot;);</span>

<span class="nc" id="L2461">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L2462">			statement.setInt(1, variableID);</span>
<span class="nc" id="L2463">			statement.setInt(2, ontologyTermID);</span>
<span class="nc" id="L2464">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L2465">			return resultSet.next();</span>
		}
		finally {
<span class="nc" id="L2468">			SQLUtilities.closeStatementsWithoutCatch(statement, resultSet);</span>
		}		
	}

	private void checkDuplicateVariableAssociation(Connection connection, 
			   									   DerivedVariable derivedVariable, 
			   									   Variable sourceVariable) throws MacawException {

		try {
<span class="nc bnc" id="L2477" title="All 2 branches missed.">			if (variableAssociationInDatabase(connection,</span>
<span class="nc" id="L2478">											  derivedVariable.getIdentifier(),</span>
<span class="nc" id="L2479">											  sourceVariable.getIdentifier()) == true) {</span>

<span class="nc" id="L2481">				String errorMessage</span>
<span class="nc" id="L2482">					= MacawMessages.getMessage(&quot;variable.error.duplicateTermAssociation&quot;,</span>
<span class="nc" id="L2483">												derivedVariable.getDisplayName(),</span>
<span class="nc" id="L2484">												sourceVariable.getDisplayName());</span>

<span class="nc" id="L2486">				MacawException exception </span>
					= new MacawException(MacawErrorType.DUPLICATE_VARIABLE_ASSOCIATION,
										 errorMessage);				
<span class="nc" id="L2489">				throw exception;</span>
			}
		}
<span class="nc" id="L2492">		catch(SQLException exception) {</span>
<span class="nc" id="L2493">			String errorMessage</span>
<span class="nc" id="L2494">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckVariableAssociationDuplicate&quot;,</span>
<span class="nc" id="L2495">											derivedVariable.getDisplayName(),</span>
<span class="nc" id="L2496">											sourceVariable.getDisplayName());</span>
<span class="nc" id="L2497">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_VARIABLE_ASSOCIATION_DUPLICATE,
									 errorMessage);
<span class="nc" id="L2500">			throw macawException;</span>
<span class="nc" id="L2501">		}</span>
<span class="nc" id="L2502">	}</span>

	private void checkVariableAssociationExists(Connection connection, 
												DerivedVariable derivedVariable, 
												Variable sourceVariable) throws MacawException {

		try {
<span class="nc bnc" id="L2509" title="All 2 branches missed.">			if (variableAssociationInDatabase(connection,</span>
<span class="nc" id="L2510">											  derivedVariable.getIdentifier(),</span>
<span class="nc" id="L2511">											  sourceVariable.getIdentifier()) == false) {</span>

<span class="nc" id="L2513">				MacawException exception = new MacawException();</span>
<span class="nc" id="L2514">				String errorMessage</span>
<span class="nc" id="L2515">					= MacawMessages.getMessage(&quot;derivedVariable.error.nonExistentVariableAssociation&quot;,</span>
<span class="nc" id="L2516">												derivedVariable.getDisplayName(),</span>
<span class="nc" id="L2517">												sourceVariable.getDisplayName());</span>
<span class="nc" id="L2518">				exception.addErrorMessage(MacawErrorType.NON_EXISTENT_VARIABLE_ASSOCIATION,</span>
										  errorMessage);
<span class="nc" id="L2520">				throw exception;</span>
			}
		}
<span class="nc" id="L2523">		catch(SQLException exception) {</span>
<span class="nc" id="L2524">			String errorMessage</span>
<span class="nc" id="L2525">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckVariableAssociationExists&quot;,</span>
<span class="nc" id="L2526">											derivedVariable.getDisplayName(),</span>
<span class="nc" id="L2527">											sourceVariable.getDisplayName());</span>
			
<span class="nc" id="L2529">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_VARIABLE_ASSOCIATION_EXISTS,
									 errorMessage);
<span class="nc" id="L2532">			throw macawException;</span>
<span class="nc" id="L2533">		}</span>
<span class="nc" id="L2534">	}</span>

	private boolean variableAssociationInDatabase(Connection connection,
												  int derivedVariableID,
												  int sourceVariableID) throws SQLException {

<span class="nc" id="L2540">		PreparedStatement statement = null;</span>
<span class="nc" id="L2541">		ResultSet resultSet = null;</span>
		try {
<span class="nc" id="L2543">			StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L2544">			query.append(&quot;SELECT 1 &quot;);</span>
<span class="nc" id="L2545">			query.append(&quot;FROM source_variables &quot;);</span>
<span class="nc" id="L2546">			query.append(&quot;WHERE derived_variable_id=? AND source_variable_id=?;&quot;);</span>

<span class="nc" id="L2548">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L2549">			statement.setInt(1, derivedVariableID);</span>
<span class="nc" id="L2550">			statement.setInt(2, sourceVariableID);</span>
<span class="nc" id="L2551">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L2552">			return resultSet.next();</span>
		}
		finally {
<span class="nc" id="L2555">			SQLUtilities.closeStatementsWithoutCatch(statement, resultSet);</span>
		}		
	}
	
	private void checkListChoices(Connection connection, 
								 Variable variable) throws MacawException {
		
<span class="nc" id="L2562">		Category category = new Category();</span>
<span class="nc" id="L2563">		category.setName(variable.getCategory());</span>
		/**
		listChoiceManager.getCategoryIdentifier(connection, 
												variable, 
												category);
		 */
		
<span class="nc bnc" id="L2570" title="All 2 branches missed.">		if (variable.isCleaned() == true) {</span>
<span class="nc" id="L2571">			CleaningState cleaningState = new CleaningState();</span>
<span class="nc" id="L2572">			cleaningState.setName(variable.getCleaningStatus());</span>
<span class="nc" id="L2573">			listChoiceManager.getCleaningStateIdentifier(connection, </span>
														 variable,
														 cleaningState);
		}
		
<span class="nc" id="L2578">		AvailabilityState availabilityState = new AvailabilityState();</span>
<span class="nc" id="L2579">		availabilityState.setName(variable.getAvailability());</span>
<span class="nc" id="L2580">		listChoiceManager.getAvailabilityStateIdentifier(connection, </span>
														 variable,
														 availabilityState);	
<span class="nc" id="L2583">		AliasFilePath aliasFilePath = new AliasFilePath();</span>
<span class="nc" id="L2584">		aliasFilePath.setAlias(variable.getAlias());</span>
<span class="nc" id="L2585">		listChoiceManager.getAliasFilePathIdentifier(connection, </span>
													 variable,
													 aliasFilePath);
<span class="nc" id="L2588">	}</span>

	
	// ==========================================
	// Section Interfaces
	// ==========================================

	// ==========================================
	// Section Overload
	// ==========================================

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>