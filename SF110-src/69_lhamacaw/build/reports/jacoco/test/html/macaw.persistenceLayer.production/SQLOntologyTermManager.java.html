<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLOntologyTermManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">69_lhamacaw</a> &gt; <a href="index.source.html" class="el_package">macaw.persistenceLayer.production</a> &gt; <span class="el_source">SQLOntologyTermManager.java</span></div><h1>SQLOntologyTermManager.java</h1><pre class="source lang-java linenums">package macaw.persistenceLayer.production;

import macaw.businessLayer.*;
import macaw.system.MacawChangeEvent;
import macaw.system.MacawErrorType;
import macaw.system.MacawException;
import macaw.system.MacawMessages;

import java.util.ArrayList;
import java.sql.*;


/**
 * &lt;p&gt;&lt;/p&gt;
 * &lt;hr&gt;
 * Copyright 2010 Medical Research Council Unit for Lifelong Health and Ageing
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *      http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.  
 * &lt;hr&gt;
 * @author Kevin Garwood (kgarwood@users.sourceforge.net)
 * @version 1.0	
 */

/*
 * Code Road Map:
 * --------------
 * Code is organised into the following sections.  Wherever possible, 
 * methods are classified based on an order of precedence described in 
 * parentheses (..).  For example, if you're trying to find a method 
 * 'getName(...)' that is both an interface method and an accessor 
 * method, the order tells you it should appear under interface.
 * 
 * Order of 
 * Precedence     Section
 * ==========     ======
 * (1)            Section Constants
 * (2)            Section Properties
 * (3)            Section Construction
 * (7)            Section Accessors and Mutators
 * (6)            Section Errors and Validation
 * (5)            Section Interfaces
 * (4)            Section Overload
 *
 */

public class SQLOntologyTermManager extends SQLCurationConceptManager {

	// ==========================================
	// Section Constants
	// ==========================================

	// ==========================================
	// Section Properties
	// ==========================================

	
	// ==========================================
	// Section Construction
	// ==========================================
	public SQLOntologyTermManager(SQLChangeEventManager changeEventManager) {
<span class="fc" id="L68">		super(changeEventManager);</span>
<span class="fc" id="L69">	}</span>
	
	// ==========================================
	// Section Accessors and Mutators
	// ==========================================

	public void createTable(Connection connection) throws MacawException {
						   					   
<span class="nc" id="L77">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L78">		query.append(&quot;CREATE TABLE ontology_terms (&quot;);</span>
<span class="nc" id="L79">		query.append(&quot;identifier INT AUTO_INCREMENT NOT NULL,&quot;);</span>
<span class="nc" id="L80">		query.append(&quot;term VARCHAR(255) NOT NULL,&quot;);</span>
<span class="nc" id="L81">		query.append(&quot;ontology_name VARCHAR(255) NOT NULL,&quot;);</span>
<span class="nc" id="L82">		query.append(&quot;description VARCHAR(255),&quot;);</span>
<span class="nc" id="L83">		query.append(&quot;name_space VARCHAR(255) NOT NULL,&quot;);</span>
<span class="nc" id="L84">		query.append(&quot;deleted_at DATETIME,&quot;);</span>
<span class="nc" id="L85">		query.append(&quot;PRIMARY KEY(identifier));&quot;);</span>
				
<span class="nc" id="L87">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L89">			statement</span>
<span class="nc" id="L90">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L91">			statement.executeUpdate();							</span>
		}
<span class="nc" id="L93">		catch(SQLException exception) {</span>
<span class="nc" id="L94">			log.logException(exception);</span>
<span class="nc" id="L95">			String errorMessage</span>
<span class="nc" id="L96">				= MacawMessages.getMessage(&quot;sql.error.unableToCreateTables&quot;);</span>
<span class="nc" id="L97">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CREATE_TABLES,
									 errorMessage);
<span class="nc" id="L100">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L103">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}
<span class="nc" id="L105">	}</span>

	public ArrayList&lt;OntologyTerm&gt; getAllOntologyTerms(Connection connection,
													   User user) throws MacawException {
		
<span class="nc" id="L110">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L111">		query.append(&quot;SELECT identifier,&quot;);</span>
<span class="nc" id="L112">		query.append(&quot;term,&quot;);</span>
<span class="nc" id="L113">		query.append(&quot;ontology_name,&quot;);</span>
<span class="nc" id="L114">		query.append(&quot;description,&quot;);</span>
<span class="nc" id="L115">		query.append(&quot;name_space &quot;);</span>
<span class="nc" id="L116">		query.append(&quot;FROM ontology_terms &quot;);</span>
<span class="nc" id="L117">		query.append(&quot;WHERE deleted_at IS NULL &quot;);</span>
<span class="nc" id="L118">		query.append(&quot;ORDER BY term ASC;&quot;);</span>

<span class="nc" id="L120">		ResultSet resultSet = null;</span>
<span class="nc" id="L121">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L123">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L124">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L125">			ArrayList&lt;OntologyTerm&gt; results</span>
				= new ArrayList&lt;OntologyTerm&gt;();
<span class="nc bnc" id="L127" title="All 2 branches missed.">			while (resultSet.next() == true) {</span>
<span class="nc" id="L128">				OntologyTerm ontologyTerm = new OntologyTerm();</span>
<span class="nc" id="L129">				ontologyTerm.setIdentifier(resultSet.getInt(1));</span>
<span class="nc" id="L130">				ontologyTerm.setTerm(resultSet.getString(2));				</span>
<span class="nc" id="L131">				ontologyTerm.setOntologyName(resultSet.getString(3));</span>
<span class="nc" id="L132">				ontologyTerm.setDescription(resultSet.getString(4));</span>
<span class="nc" id="L133">				ontologyTerm.setNameSpace(resultSet.getString(5));</span>
<span class="nc" id="L134">				results.add(ontologyTerm);</span>
<span class="nc" id="L135">			}</span>
			
<span class="nc" id="L137">			return results;</span>
		}
<span class="nc" id="L139">		catch(SQLException exception) {</span>
<span class="nc" id="L140">			String errorMessage</span>
<span class="nc" id="L141">				= MacawMessages.getMessage(&quot;sql.error.unableToGetAllOntologyTerms&quot;);</span>
<span class="nc" id="L142">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ALL_ONTOLOGY_TERMS,
									 errorMessage);
<span class="nc" id="L145">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L148">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
	}	

	public void addOntologyTerm(Connection connection,
								User user,
								OntologyTerm ontologyTerm) throws MacawException {
		
		//Part I: Validate parameters
		//check basic field errors
<span class="nc" id="L158">		OntologyTerm.validateFields(ontologyTerm);		</span>
		//check for duplicates
<span class="nc" id="L160">		checkOntologyTermDuplicates(connection, ontologyTerm);</span>
		
<span class="nc" id="L162">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L163">		query.append(&quot;INSERT INTO ontology_terms &quot;);</span>
<span class="nc" id="L164">		query.append(&quot;(term,&quot;);</span>
<span class="nc" id="L165">		query.append(&quot;ontology_name,&quot;);</span>
<span class="nc" id="L166">		query.append(&quot;description,&quot;);</span>
<span class="nc" id="L167">		query.append(&quot;name_space,&quot;);</span>
<span class="nc" id="L168">		query.append(&quot;deleted_at) &quot;);</span>
<span class="nc" id="L169">		query.append(&quot;VALUES (?, ?, ?, ?, ?);&quot;);</span>

<span class="nc" id="L171">		PreparedStatement statement = null;</span>
		try {
			//Part II: Perform the add operation
<span class="nc" id="L174">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L175">			statement.setString(1, ontologyTerm.getTerm());</span>
<span class="nc" id="L176">			statement.setString(2, ontologyTerm.getOntologyName());</span>
<span class="nc" id="L177">			statement.setString(3, ontologyTerm.getDescription());</span>
<span class="nc" id="L178">			statement.setString(4, ontologyTerm.getNameSpace());</span>
<span class="nc" id="L179">			statement.setDate(5, null);</span>
<span class="nc" id="L180">			statement.executeUpdate();</span>
			
			//Part III: Record changes
			/**
			ArrayList&lt;MacawChangeEvent&gt; changeEvents 
				= ChangeEventGenerator.addOntologyTermChange(user, ontologyTerm);

			registerChangeEvents(connection, changeEvents);
			*/
		}
<span class="nc" id="L190">		catch(SQLException exception) {</span>
<span class="nc" id="L191">			exception.printStackTrace(System.out);</span>
<span class="nc" id="L192">			String errorMessage</span>
<span class="nc" id="L193">				= MacawMessages.getMessage(&quot;sql.error.unableToAddOntologyTerm&quot;,</span>
<span class="nc" id="L194">											ontologyTerm.getDisplayName());</span>
<span class="nc" id="L195">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CREATE_ONTOLOGY_TERM,
									 errorMessage);
<span class="nc" id="L198">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L201">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}
<span class="nc" id="L203">	}</span>

	public void updateOntologyTerm(Connection connection,
								   User user,
								   OntologyTerm revisedOntologyTerm) throws MacawException {
		
		//Part I: Validate parameters
		//check basic field errors
<span class="nc" id="L211">		OntologyTerm.validateFields(revisedOntologyTerm);</span>
		//check for duplicates
<span class="nc" id="L213">		checkOntologyTermExists(connection, revisedOntologyTerm);</span>
<span class="nc" id="L214">		checkOntologyTermDuplicates(connection, revisedOntologyTerm);</span>

<span class="nc" id="L216">		OntologyTerm originalOntologyTerm</span>
<span class="nc" id="L217">			= getOriginalOntologyTerm(connection, revisedOntologyTerm);</span>
<span class="nc" id="L218">		ArrayList&lt;MacawChangeEvent&gt; changeEvents</span>
<span class="nc" id="L219">			= OntologyTerm.detectFieldChanges(user, </span>
											  originalOntologyTerm, 
											  revisedOntologyTerm);
		//check that at least one change happened
<span class="nc bnc" id="L223" title="All 2 branches missed.">		if (changeEvents.size() == 0) {</span>
<span class="nc" id="L224">			return;</span>
		}

<span class="nc" id="L227">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L228">		query.append(&quot;UPDATE ontology_terms &quot;);</span>
<span class="nc" id="L229">		query.append(&quot;SET term = ?,&quot;);</span>
<span class="nc" id="L230">		query.append(&quot;ontology_name = ?,&quot;);</span>
<span class="nc" id="L231">		query.append(&quot;description = ?,&quot;);</span>
<span class="nc" id="L232">		query.append(&quot;name_space= ? &quot;);</span>
<span class="nc" id="L233">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L234">		query.append(&quot;identifier=?;&quot;);</span>
		
<span class="nc" id="L236">		PreparedStatement statement = null;</span>
		try {
			//Part II: Perform the add operation
<span class="nc" id="L239">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L240">			statement.setString(1, revisedOntologyTerm.getTerm());</span>
<span class="nc" id="L241">			statement.setString(2, revisedOntologyTerm.getOntologyName());</span>
<span class="nc" id="L242">			statement.setString(3, revisedOntologyTerm.getDescription());</span>
<span class="nc" id="L243">			statement.setString(4, revisedOntologyTerm.getNameSpace());</span>
<span class="nc" id="L244">			statement.setInt(5, revisedOntologyTerm.getIdentifier());</span>
<span class="nc" id="L245">			statement.executeUpdate();</span>
			
			//Part III: Record changes
			/**
			 * 
			registerChangeEvents(changeEvents);
			 */
		}
<span class="nc" id="L253">		catch(SQLException exception) {</span>
<span class="nc" id="L254">			log.logException(exception);</span>
<span class="nc" id="L255">			String errorMessage</span>
<span class="nc" id="L256">				= MacawMessages.getMessage(&quot;sql.error.unableToUpdateOntologyTerm&quot;,</span>
<span class="nc" id="L257">											revisedOntologyTerm.getDisplayName());</span>
<span class="nc" id="L258">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_UPDATE_ONTOLOGY_TERM,
									 errorMessage);
<span class="nc" id="L261">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L264">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
		}
<span class="nc" id="L266">	}</span>

	public void deleteOntologyTerms(Connection connection,
								    User user,
								    ArrayList&lt;OntologyTerm&gt; ontologyTermsToDelete) throws MacawException {
		
		//Part I: Validate parameters
<span class="nc bnc" id="L273" title="All 2 branches missed.">		for (OntologyTerm currentOntologyTerm : ontologyTermsToDelete) {</span>
<span class="nc" id="L274">			checkOntologyTermExists(connection, currentOntologyTerm);</span>
<span class="nc" id="L275">		}</span>
		
<span class="nc" id="L277">		ResultSet resultSet = null;</span>
<span class="nc" id="L278">		PreparedStatement statement = null;</span>
		try {
			
<span class="nc" id="L281">			Time deletionDate = new Time(System.currentTimeMillis());</span>
<span class="nc" id="L282">			StringBuffer query = new StringBuffer();</span>
<span class="nc" id="L283">			query.append(&quot;UPDATE ontology_terms &quot;);</span>
<span class="nc" id="L284">			query.append(&quot;SET deleted_at=NOW() &quot;);</span>
<span class="nc" id="L285">			query.append(&quot;WHERE identifier=?;&quot;);</span>
<span class="nc" id="L286">			statement = connection.prepareStatement(query.toString());</span>

			//Part II: Delete term from table			
<span class="nc bnc" id="L289" title="All 2 branches missed.">			for (OntologyTerm currentOntologyTerm : ontologyTermsToDelete) {</span>
				//statement.setTime(1, deletionDate);
<span class="nc" id="L291">				statement.setInt(1, currentOntologyTerm.getIdentifier());</span>
<span class="nc" id="L292">				statement.executeUpdate();</span>
<span class="nc" id="L293">			}</span>
			
			//Part III: Record changes
			/**
			ArrayList&lt;MacawChangeEvent&gt; changeEvents
				= ChangeEventGenerator.deleteOntologyTermsChange(user,
																 ontologyTermsToDelete);
			registerChangeEvents(changeEvents);
			*/			
		}
<span class="nc" id="L303">		catch(SQLException exception) {</span>
<span class="nc" id="L304">			log.logException(exception);</span>
<span class="nc" id="L305">			String errorMessage</span>
<span class="nc" id="L306">				= MacawMessages.getMessage(&quot;sql.error.unableToDeleteOntologyTerms&quot;);</span>
<span class="nc" id="L307">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_DELETE_ONTOLOGY_TERM,
									 errorMessage);
<span class="nc" id="L310">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L313">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
<span class="nc" id="L315">	}</span>

	public int getOntologyTermIdentifier(Connection connection,
										 OntologyTerm targetOntologyTerm) throws MacawException {
		
<span class="nc" id="L320">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L321">		query.append(&quot;SELECT identifier &quot;);</span>
<span class="nc" id="L322">		query.append(&quot;FROM ontology_terms &quot;);</span>
<span class="nc" id="L323">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L324">		query.append(&quot;term=? AND name_space=?;&quot;);</span>

<span class="nc" id="L326">		ResultSet resultSet = null;</span>
<span class="nc" id="L327">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L329">			statement</span>
<span class="nc" id="L330">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L331">			statement.setString(1, targetOntologyTerm.getTerm());</span>
<span class="nc" id="L332">			statement.setString(2, targetOntologyTerm.getNameSpace());</span>
<span class="nc" id="L333">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">			if (resultSet.next() == true) {</span>
<span class="nc" id="L335">				return resultSet.getInt(1);</span>
			}
			else {
<span class="nc" id="L338">				return -1;</span>
			}
		}
<span class="nc" id="L341">		catch(SQLException exception) {</span>
<span class="nc" id="L342">			String errorMessage</span>
<span class="nc" id="L343">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckOntologyTermIdentifier&quot;);</span>
<span class="nc" id="L344">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ONTOLOGY_TERM_IDENTIFIER,
									 errorMessage);
<span class="nc" id="L347">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L350">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
	}

	public void clear(Connection connection) throws MacawException {

<span class="nc" id="L356">		ResultSet resultSet = null;</span>
<span class="nc" id="L357">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L359">			statement</span>
<span class="nc" id="L360">				= connection.prepareStatement(&quot;DELETE FROM ontology_terms;&quot;);</span>
<span class="nc" id="L361">			statement.executeUpdate();</span>
		}
<span class="nc" id="L363">		catch(SQLException exception) {</span>
<span class="nc" id="L364">			exception.printStackTrace(System.out);</span>
<span class="nc" id="L365">			String errorMessage</span>
<span class="nc" id="L366">				= MacawMessages.getMessage(&quot;sql.error.unableToClearTable&quot;);</span>
<span class="nc" id="L367">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_CLEAR_TABLE,
									 errorMessage);
<span class="nc" id="L370">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L373">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}
<span class="nc" id="L375">	}</span>

	// ==========================================
	// Section Errors and Validation
	// ==========================================

	public void checkOntologyTermExists(Connection connection,
			   							OntologyTerm targetOntologyTerm) throws MacawException {

<span class="nc" id="L384">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L385">		query.append(&quot;SELECT 1 &quot;);</span>
<span class="nc" id="L386">		query.append(&quot;FROM ontology_terms &quot;);</span>
<span class="nc" id="L387">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L388">		query.append(&quot;identifier=?;&quot;);</span>

<span class="nc" id="L390">		ResultSet resultSet = null;</span>
<span class="nc" id="L391">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L393">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L394">			statement.setInt(1, targetOntologyTerm.getIdentifier());</span>
<span class="nc" id="L395">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">			if (resultSet.next() == false) {</span>
				//items have same display name but different IDs. Therefore
				//the candidate is a duplicate
<span class="nc" id="L399">				String errorMessage</span>
<span class="nc" id="L400">					= MacawMessages.getMessage(&quot;general.error.nonExistentItem&quot;,</span>
<span class="nc" id="L401">												targetOntologyTerm.getDisplayName());</span>
<span class="nc" id="L402">				MacawException exception</span>
					= new MacawException(MacawErrorType.NON_EXISTENT_ONTOLOGY_TERM,
										 errorMessage);
<span class="nc" id="L405">				throw exception;</span>
			}
		}
<span class="nc" id="L408">		catch(SQLException exception) {</span>
<span class="nc" id="L409">			String errorMessage</span>
<span class="nc" id="L410">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckOntologyTermExists&quot;);</span>
<span class="nc" id="L411">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_ONTOLOGY_TERM_EXISTS,
									 errorMessage);
<span class="nc" id="L414">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L417">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}					
<span class="nc" id="L419">	}</span>

	private void checkOntologyTermDuplicates(Connection connection,
											 OntologyTerm targetOntologyTerm) throws MacawException {

<span class="nc" id="L424">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L425">		query.append(&quot;SELECT identifier &quot;);</span>
<span class="nc" id="L426">		query.append(&quot;FROM ontology_terms &quot;);</span>
<span class="nc" id="L427">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L428">		query.append(&quot;term=? AND (name_space=? OR ontology_name=?);&quot;);</span>

<span class="nc" id="L430">		ResultSet resultSet = null;</span>
<span class="nc" id="L431">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L433">			statement</span>
<span class="nc" id="L434">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L435">			statement.setString(1, targetOntologyTerm.getTerm());</span>
<span class="nc" id="L436">			statement.setString(2, targetOntologyTerm.getNameSpace());</span>
<span class="nc" id="L437">			statement.setString(3, targetOntologyTerm.getOntologyName());</span>
<span class="nc" id="L438">			resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">			if (resultSet.next() == true) {</span>
<span class="nc" id="L440">				int resultIdentifier = resultSet.getInt(1);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">				if (resultIdentifier != targetOntologyTerm.getIdentifier()) {</span>
					//items have same display name but different IDs. Therefore
					//the candidate is a duplicate
<span class="nc" id="L444">					String errorMessage</span>
<span class="nc" id="L445">						= MacawMessages.getMessage(&quot;ontologyTerm.error.duplicateExists&quot;,</span>
<span class="nc" id="L446">													targetOntologyTerm.getDisplayName());</span>
<span class="nc" id="L447">					MacawException exception</span>
						= new MacawException(MacawErrorType.DUPLICATE_ONTOLOGY_TERM,
											 errorMessage);
<span class="nc" id="L450">					throw exception;</span>
				}
			}
		}
<span class="nc" id="L454">		catch(SQLException exception) {</span>
<span class="nc" id="L455">			String errorMessage</span>
<span class="nc" id="L456">				= MacawMessages.getMessage(&quot;sql.error.unableToCheckOntologyTermDuplicates&quot;);</span>
<span class="nc" id="L457">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_ONTOLOGY_TERM_DUPLICATES,
									 errorMessage);
<span class="nc" id="L460">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L463">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}		
<span class="nc" id="L465">	}</span>

	public OntologyTerm getOriginalOntologyTerm(Connection connection,
												OntologyTerm targetOntologyTerm) throws MacawException {

		
<span class="nc" id="L471">		checkOntologyTermExists(connection, targetOntologyTerm);</span>
		
<span class="nc" id="L473">		int identifier = targetOntologyTerm.getIdentifier();</span>
<span class="nc" id="L474">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L475">		query.append(&quot;SELECT term,&quot;);</span>
<span class="nc" id="L476">		query.append(&quot;ontology_name,&quot;);</span>
<span class="nc" id="L477">		query.append(&quot;description,&quot;);</span>
<span class="nc" id="L478">		query.append(&quot;name_space &quot;);</span>
<span class="nc" id="L479">		query.append(&quot;FROM ontology_terms &quot;);</span>
<span class="nc" id="L480">		query.append(&quot;WHERE deleted_at IS NULL AND &quot;);</span>
<span class="nc" id="L481">		query.append(&quot;identifier=?;&quot;);</span>
<span class="nc" id="L482">		ResultSet resultSet = null;</span>
<span class="nc" id="L483">		PreparedStatement statement = null;</span>

		try {
<span class="nc" id="L486">			statement</span>
<span class="nc" id="L487">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L488">			statement.setInt(1, identifier);</span>
<span class="nc" id="L489">			resultSet = statement.executeQuery();</span>
<span class="nc" id="L490">			resultSet.next();</span>
			
<span class="nc" id="L492">			OntologyTerm originalOntologyTerm = new OntologyTerm();</span>
<span class="nc" id="L493">			originalOntologyTerm.setIdentifier(identifier);</span>
<span class="nc" id="L494">			originalOntologyTerm.setTerm(resultSet.getString(1));</span>
<span class="nc" id="L495">			originalOntologyTerm.setOntologyName(resultSet.getString(2));</span>
<span class="nc" id="L496">			originalOntologyTerm.setDescription(resultSet.getString(3));</span>
<span class="nc" id="L497">			originalOntologyTerm.setNameSpace(resultSet.getString(4));</span>

<span class="nc" id="L499">			return originalOntologyTerm;</span>
		}
<span class="nc" id="L501">		catch(SQLException exception) {</span>
<span class="nc" id="L502">			String errorMessage</span>
<span class="nc" id="L503">				= MacawMessages.getMessage(&quot;sql.error.unableToGetOriginalOntologyTerm&quot;);</span>
<span class="nc" id="L504">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_GET_ORIGINAL_ONTOLOGY_TERM,
									 errorMessage);
<span class="nc" id="L507">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L510">			SQLUtilities.closeStatementsWithCatch(statement, resultSet);</span>
		}	
	}

	// ==========================================
	// Section Interfaces
	// ==========================================

	// ==========================================
	// Section Overload
	// ==========================================

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>