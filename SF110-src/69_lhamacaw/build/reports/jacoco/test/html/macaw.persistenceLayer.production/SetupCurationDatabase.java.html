<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SetupCurationDatabase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">69_lhamacaw</a> &gt; <a href="index.source.html" class="el_package">macaw.persistenceLayer.production</a> &gt; <span class="el_source">SetupCurationDatabase.java</span></div><h1>SetupCurationDatabase.java</h1><pre class="source lang-java linenums">package macaw.persistenceLayer.production;

import macaw.businessLayer.*;
import macaw.persistenceLayer.DummyDataProvider;
import macaw.system.*;

import java.sql.*;
import java.io.*;
import java.util.PropertyResourceBundle;
import javax.swing.JFileChooser;
import javax.swing.JOptionPane;

/**
 * A convenience class that can be used to create all the database tables used by
 * the production services.
 * 
 * &lt;hr&gt;
 * Copyright 2010 Medical Research Council Unit for Lifelong Health and Ageing
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *      http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.  
 * &lt;hr&gt;
 * @author Kevin Garwood (kgarwood@users.sourceforge.net)
 * @version 1.0	
 */

/*
 * Code Road Map:
 * --------------
 * Code is organised into the following sections.  Wherever possible, 
 * methods are classified based on an order of precedence described in 
 * parentheses (..).  For example, if you're trying to find a method 
 * 'getName(...)' that is both an interface method and an accessor 
 * method, the order tells you it should appear under interface.
 * 
 * Order of 
 * Precedence     Section
 * ==========     ======
 * (1)            Section Constants
 * (2)            Section Properties
 * (3)            Section Construction
 * (7)            Section Accessors and Mutators
 * (6)            Section Errors and Validation
 * (5)            Section Interfaces
 * (4)            Section Overload
 *
 */

public class SetupCurationDatabase {

	public static final void main(String[] arguments) {
		
<span class="nc" id="L59">		SessionProperties sessionProperties </span>
			= new SessionProperties();
<span class="nc" id="L61">		StartupOptions startupOptions</span>
<span class="nc" id="L62">			= (StartupOptions) sessionProperties.getProperty(SessionProperties.STARTUP_OPTIONS);</span>
<span class="nc" id="L63">		startupOptions.setDatabaseName(&quot;macaw&quot;);</span>
		
<span class="nc" id="L65">		SetupCurationDatabase setupTool</span>
			= new SetupCurationDatabase(sessionProperties);
		
<span class="nc" id="L68">		startupOptions.processCommandLineArguments(arguments);</span>
				
		try {			
<span class="nc" id="L71">			setupTool.setup();</span>
		}
<span class="nc" id="L73">		catch(MacawException exception) {</span>
<span class="nc" id="L74">			exception.printErrors();</span>
<span class="nc" id="L75">		}</span>
<span class="nc" id="L76">	}</span>
	
	
	// ==========================================
	// Section Constants
	// ==========================================

	// ==========================================
	// Section Properties
	// ==========================================
	private String databaseName;
	private String databaseServer;
	private String databasePort;
	
	private StartupOptions startupOptions;
	
	private SessionProperties sessionProperties;
	private SQLConnectionManager sqlConnectionManager;
	private String startupPropertiesFileName;
	private SQLListChoiceManager listChoiceManager;
	private SQLSupportingDocumentsManager documentsManager;
	private SQLValueLabelManager valueLabelsManager;
	private SQLChangeEventManager changeEventManager;
	private SQLUserManager userManager;
	private SQLVariableManager variableManager;
	private SQLOntologyTermManager ontologyTermManager;
	private Log log;

	// ==========================================
	// Section Construction
	// ==========================================
<span class="nc" id="L107">	public SetupCurationDatabase(SessionProperties sessionProperties) {</span>
<span class="nc" id="L108">		log = new Log();</span>
<span class="nc" id="L109">		this.sessionProperties = sessionProperties;</span>
<span class="nc" id="L110">	}</span>
		
	public void setup() throws MacawException {

<span class="nc" id="L114">		readPropertiesFile();</span>

<span class="nc" id="L116">		Connection connection = null;</span>
<span class="nc" id="L117">		sqlConnectionManager</span>
			= new SQLConnectionManager(sessionProperties);
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (databaseExists() == true) {</span>
<span class="nc" id="L120">			String databaseAlreadyExists</span>
<span class="nc" id="L121">				= MacawMessages.getMessage(&quot;setupDatabase.databaseAlreadyExists&quot;);</span>
<span class="nc" id="L122">			JOptionPane.showMessageDialog(null, databaseAlreadyExists);</span>
<span class="nc" id="L123">			return;</span>
		}
<span class="nc" id="L125">		createDatabase();</span>
<span class="nc" id="L126">		createManagerObjects();</span>
		

		try {						
<span class="nc" id="L130">			connection = sqlConnectionManager.getConnection();			</span>
<span class="nc" id="L131">			changeEventManager.createTable(connection);</span>

<span class="nc" id="L133">			userManager.createTable(connection);</span>
<span class="nc" id="L134">			listChoiceManager.createTables(connection);</span>
<span class="nc" id="L135">			documentsManager.createTable(connection);</span>
<span class="nc" id="L136">			ontologyTermManager.createTable(connection);</span>
<span class="nc" id="L137">			valueLabelsManager.createTable(connection);</span>
<span class="nc" id="L138">			variableManager.createTables(connection);</span>
			
<span class="nc" id="L140">			String finishedInstallation</span>
<span class="nc" id="L141">				= MacawMessages.getMessage(&quot;setupDatabase.databaseSuccesfullyInstalled&quot;);</span>
<span class="nc" id="L142">			JOptionPane.showMessageDialog(null, finishedInstallation);</span>
		}
		finally {
<span class="nc" id="L145">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L147">	}</span>
	
	private Connection getConnection(String databaseURI) throws Exception {
<span class="nc" id="L150">		Connection connection = null;</span>
		
<span class="nc" id="L152">		StartupOptions startupOptions</span>
<span class="nc" id="L153">			= (StartupOptions) sessionProperties.getProperty(SessionProperties.STARTUP_OPTIONS);</span>
<span class="nc" id="L154">		String dbUserID</span>
<span class="nc" id="L155">			= startupOptions.getDbUser();</span>
<span class="nc" id="L156">		String dbPassword</span>
<span class="nc" id="L157">			= startupOptions.getDbPassword();</span>

<span class="nc bnc" id="L159" title="All 2 branches missed.">		if (dbUserID == null) {</span>
<span class="nc" id="L160">			connection </span>
<span class="nc" id="L161">				= DriverManager.getConnection(databaseURI);</span>
		}
		else {
<span class="nc" id="L164">			connection </span>
<span class="nc" id="L165">				= DriverManager.getConnection(databaseURI,</span>
											  dbUserID,
											  dbPassword);				
		}		
<span class="nc" id="L169">		return connection;</span>
	}

	
	private void readPropertiesFile() {
<span class="nc" id="L174">		databaseName = &quot;macaw&quot;;</span>
<span class="nc" id="L175">		databaseServer = &quot;localhost&quot;;</span>
		//databasePort = &quot;3306&quot;;		
		//databaseServer = &quot;prometheus&quot;;
		//databasePort = &quot;3306&quot;;		

<span class="nc" id="L180">	}</span>
	
	public boolean databaseExists() throws MacawException {
<span class="nc" id="L183">		Connection connection = null;</span>
<span class="nc" id="L184">		Statement statement = null;</span>
<span class="nc" id="L185">		ResultSet resultSet = null;</span>
		
		try {
<span class="nc" id="L188">			Class.forName(&quot;org.gjt.mm.mysql.Driver&quot;).newInstance();</span>
			
			//String databaseURI = &quot;jdbc:mysql://localhost:3306/mysql&quot;;
			//String databaseURI = &quot;jdbc:mysql://localhost/mysql&quot;;

<span class="nc" id="L193">			String databaseURI = &quot;jdbc:mysql://localhost/&quot;;</span>
<span class="nc" id="L194">			connection = getConnection(databaseURI);</span>
			
<span class="nc" id="L196">			StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L197">			query.append(&quot;SELECT SCHEMA_NAME &quot;);</span>
<span class="nc" id="L198">			query.append(&quot;FROM INFORMATION_SCHEMA.SCHEMATA &quot;);</span>
<span class="nc" id="L199">			query.append(&quot;WHERE SCHEMA_NAME = '&quot;);</span>
<span class="nc" id="L200">			query.append(databaseName);</span>
<span class="nc" id="L201">			query.append(&quot;';&quot;);</span>

<span class="nc" id="L203">			statement = connection.createStatement();</span>
<span class="nc" id="L204">			resultSet = statement.executeQuery(query.toString());</span>
<span class="nc" id="L205">			return (resultSet.next());			</span>
		}
<span class="nc" id="L207">		catch(Exception exception) {</span>
<span class="nc" id="L208">			log.logException(exception);</span>
<span class="nc" id="L209">			String errorMessage</span>
<span class="nc" id="L210">				= MacawMessages.getMessage(&quot;sqlDB.error.unableToCreateDatabase&quot;,</span>
										   databaseName);
<span class="nc" id="L212">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_CHECK_DATABASE_EXISTS,
								     errorMessage);
<span class="nc" id="L215">			throw macawException;</span>
		}
		finally {
<span class="nc" id="L218">			SQLUtilities.closeStatementsWithCatch(statement, null);</span>
			try {
<span class="nc" id="L220">				connection.close();</span>
			}
<span class="nc" id="L222">			catch(Exception exception) {</span>

<span class="nc" id="L224">			}</span>
		}		
	}

	
	private void createDatabase() throws MacawException {

<span class="nc" id="L231">		PreparedStatement statement = null;</span>
		try {		
<span class="nc" id="L233">			StringBuilder databaseURI = new StringBuilder();</span>
<span class="nc" id="L234">			databaseURI.append(&quot;jdbc:mysql://&quot;);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">			if (databaseServer == null) {</span>
<span class="nc" id="L236">				databaseURI.append(&quot;localhost&quot;);</span>
			}
			else {
<span class="nc" id="L239">				databaseURI.append(databaseServer);</span>
			}
			
<span class="nc bnc" id="L242" title="All 2 branches missed.">			if (databasePort != null) {</span>
<span class="nc" id="L243">				databaseURI.append(&quot;:&quot;);</span>
<span class="nc" id="L244">				databaseURI.append(databasePort);				</span>
			}
		
<span class="nc" id="L247">			databaseURI.append(&quot;/&quot;);</span>
			
			
			
<span class="nc" id="L251">			Class.forName(&quot;com.mysql.jdbc.Driver&quot;).newInstance();</span>

<span class="nc" id="L253">			StartupOptions startupOptions</span>
<span class="nc" id="L254">				= (StartupOptions) sessionProperties.getProperty(SessionProperties.STARTUP_OPTIONS);</span>
<span class="nc" id="L255">			String dbUser</span>
<span class="nc" id="L256">				= startupOptions.getDbUser();</span>
<span class="nc" id="L257">			String dbPassword</span>
<span class="nc" id="L258">				= startupOptions.getDbPassword();</span>

<span class="nc" id="L260">			Connection connection = null;</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">			if (dbUser == null) {</span>
<span class="nc" id="L262">				connection </span>
<span class="nc" id="L263">					= DriverManager.getConnection(databaseURI.toString());</span>
			}
			else {
<span class="nc" id="L266">				connection </span>
<span class="nc" id="L267">					= DriverManager.getConnection(databaseURI.toString(),</span>
												  dbUser,
												  dbPassword);				
			}
		
<span class="nc" id="L272">			StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L273">			query.append(&quot;CREATE DATABASE &quot;);</span>
<span class="nc" id="L274">			query.append(databaseName);</span>
<span class="nc" id="L275">			query.append(&quot;;&quot;);</span>
			
<span class="nc" id="L277">			statement</span>
<span class="nc" id="L278">				= connection.prepareStatement(query.toString());</span>
<span class="nc" id="L279">			statement.executeUpdate();	</span>
		}
<span class="nc" id="L281">		catch(Exception exception) {</span>
<span class="nc" id="L282">			exception.printStackTrace(System.out);</span>
<span class="nc" id="L283">			String errorMessage</span>
<span class="nc" id="L284">				= MacawMessages.getMessage(&quot;sql.error.unableToCreateDatabase&quot;);</span>
<span class="nc" id="L285">			MacawException macawException</span>
				= new MacawException(MacawErrorType.UNABLE_TO_CREATE_DATABASE,
									 errorMessage);
<span class="nc" id="L288">			throw macawException;</span>
		}
		finally {
			try {
<span class="nc bnc" id="L292" title="All 2 branches missed.">				if (statement != null) {</span>
<span class="nc" id="L293">					statement.close();</span>
				}
			}
<span class="nc" id="L296">			catch(SQLException exception) {</span>
<span class="nc" id="L297">				String errorMessage</span>
<span class="nc" id="L298">					= MacawMessages.getMessage(&quot;sql.error.unableToCloseConnection&quot;);</span>
<span class="nc" id="L299">				MacawException macawException </span>
					= new MacawException(MacawErrorType.UNABLE_TO_CLOSE_CONNECTION,
									 	 errorMessage);
<span class="nc" id="L302">				throw macawException;</span>
<span class="nc" id="L303">			}</span>
		}	
<span class="nc" id="L305">	}</span>
	
	private void createManagerObjects() throws MacawException {

<span class="nc" id="L309">		log = sessionProperties.getLog();</span>

<span class="nc" id="L311">		changeEventManager = new SQLChangeEventManager(sessionProperties.getLog());</span>
<span class="nc" id="L312">		userManager = new SQLUserManager(changeEventManager, sqlConnectionManager);</span>
<span class="nc" id="L313">		userManager.setLog(log);</span>

<span class="nc" id="L315">		documentsManager </span>
			= new SQLSupportingDocumentsManager(changeEventManager);
<span class="nc" id="L317">		documentsManager.setLog(log);</span>
<span class="nc" id="L318">		listChoiceManager </span>
			= new SQLListChoiceManager(changeEventManager);
		//listChoiceManager.setLog(log);
<span class="nc" id="L321">		valueLabelsManager </span>
			= new SQLValueLabelManager(changeEventManager);
<span class="nc" id="L323">		valueLabelsManager.setLog(log);</span>
		
<span class="nc" id="L325">		ontologyTermManager</span>
			= new SQLOntologyTermManager(changeEventManager);
<span class="nc" id="L327">		ontologyTermManager.setLog(log);</span>

<span class="nc" id="L329">		variableManager</span>
			= new SQLVariableManager(changeEventManager,
									 listChoiceManager,
									 ontologyTermManager,
									 documentsManager);
<span class="nc" id="L334">		variableManager.setLog(log);</span>
<span class="nc" id="L335">	}</span>
	
	private void initiallyPopulate() {
			try {				
<span class="nc" id="L339">				ProductionCurationService database</span>
					= new ProductionCurationService(sessionProperties);

<span class="nc" id="L342">				User admin = new User(&quot;admin&quot;, &quot;admin&quot;);</span>
<span class="nc" id="L343">				User jsmith = new User(&quot;jsmith&quot;, &quot;cool&quot;);</span>

<span class="nc" id="L345">				DummyDataProvider dummyDataProvider</span>
					= new DummyDataProvider(database, admin);
<span class="nc" id="L347">				dummyDataProvider.populateDatabase(jsmith);</span>
			}
<span class="nc" id="L349">			catch(MacawException exception) {</span>
<span class="nc" id="L350">				exception.printErrors();</span>
<span class="nc" id="L351">				Log log = new Log();</span>
<span class="nc" id="L352">				log.logException(exception);			</span>
<span class="nc" id="L353">			}</span>
<span class="nc" id="L354">	}</span>
	
	public void dropDatabase() throws MacawException {
<span class="nc" id="L357">		User user = new User(&quot;user&quot;, &quot;user&quot;);</span>
		
<span class="nc" id="L359">		StringBuilder query = new StringBuilder();</span>
<span class="nc" id="L360">		query.append(&quot;DROP DATABASE macaw;&quot;);</span>

<span class="nc" id="L362">		Connection connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L363">		PreparedStatement statement = null;</span>
		try {
<span class="nc" id="L365">			statement = connection.prepareStatement(query.toString());</span>
<span class="nc" id="L366">			statement.executeQuery();</span>
		}
<span class="nc" id="L368">		catch(SQLException exception) {</span>
<span class="nc" id="L369">			log.logException(exception);</span>
<span class="nc" id="L370">			String errorMessage</span>
<span class="nc" id="L371">				= MacawMessages.getMessage(&quot;sql.error.unableToCreateTables&quot;);</span>
<span class="nc" id="L372">			MacawException macawException </span>
				= new MacawException(MacawErrorType.UNABLE_TO_CREATE_TABLES,
									 errorMessage);
<span class="nc" id="L375">			throw macawException;</span>
		}	
		finally {
<span class="nc" id="L378">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
<span class="nc" id="L380">	}</span>
	
	// ==========================================
	// Section Accessors and Mutators
	// ==========================================
	public void setStartUpPropertiesFileName(String startupPropertiesFileName) {
<span class="nc" id="L386">		this.startupPropertiesFileName = startupPropertiesFileName;</span>
<span class="nc" id="L387">	}</span>
	
	public void run() {
		try {
			try {
				//Part I: Obtain the properties file that contains
				//all the startup properties
<span class="nc" id="L394">				File setupFile = new File(startupPropertiesFileName);</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">				if (setupFile.exists() == false) {</span>
<span class="nc" id="L396">					UserInterfaceFactory userInterfaceFactory</span>
						= new UserInterfaceFactory();
<span class="nc" id="L398">					JFileChooser fileChooser</span>
<span class="nc" id="L399">						= userInterfaceFactory.createFileChooser();</span>
					
<span class="nc" id="L401">					int result</span>
<span class="nc" id="L402">						= fileChooser.showOpenDialog(null);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">					if (result == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L404">						setupFile </span>
<span class="nc" id="L405">							= fileChooser.getSelectedFile();</span>
					}
					else {
<span class="nc" id="L408">						String errorMessage</span>
<span class="nc" id="L409">							= MacawMessages.getMessage(&quot;&quot;);</span>
<span class="nc" id="L410">						log.displayErrorDialog(errorMessage);</span>
<span class="nc" id="L411">						System.exit(0);</span>
					}

					//Part II: Extract important properties from the file
<span class="nc" id="L415">					FileInputStream fileInputStream</span>
						= new FileInputStream(setupFile);
<span class="nc" id="L417">					PropertyResourceBundle startupProperties</span>
						= new PropertyResourceBundle(fileInputStream);
					
<span class="nc" id="L420">					String databaseServer</span>
<span class="nc" id="L421">						= startupProperties.getString(&quot;macaw.persistenceLayer.server&quot;);</span>
<span class="nc" id="L422">					String databaseName</span>
<span class="nc" id="L423">						= startupProperties.getString(&quot;macaw.persistenceLayer.name&quot;);</span>
<span class="nc" id="L424">					StringBuilder buffer = new StringBuilder();</span>
<span class="nc" id="L425">					buffer.append(&quot;jdbc:mysql://&quot;);</span>
					
<span class="nc bnc" id="L427" title="All 2 branches missed.">					if (databaseServer == null) {</span>
<span class="nc" id="L428">						buffer.append(&quot;localhost&quot;);</span>
					}
					else {
<span class="nc" id="L431">						buffer.append(databaseServer);</span>
					}
					
					/**
					if (databasePort != null) {
						buffer.append(&quot;:&quot;);
						buffer.append(databasePort);
					}
					 */
					
<span class="nc" id="L441">					StringBuilder databaseURL = new StringBuilder();</span>
					//String 
					
					
<span class="nc" id="L445">					Class.forName(&quot;com.mysql.jdbc.Driver&quot;).newInstance();</span>
					//Connection connection = DriverManager.getConnection(databaseURL);

					//
				}
			}
<span class="nc" id="L451">			catch(Exception exception) {</span>
<span class="nc" id="L452">				log.logException(exception);</span>
<span class="nc" id="L453">			}</span>
						
<span class="nc" id="L455">			createDatabase();</span>
		}
<span class="nc" id="L457">		catch(MacawException exception) {</span>
<span class="nc" id="L458">			Log log = new Log();</span>
<span class="nc" id="L459">			log.logException(exception);</span>
<span class="nc" id="L460">		}</span>
		
		
<span class="nc" id="L463">	}</span>
	
	// ==========================================
	// Section Errors and Validation
	// ==========================================

	// ==========================================
	// Section Interfaces
	// ==========================================

	// ==========================================
	// Section Overload
	// ==========================================

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>