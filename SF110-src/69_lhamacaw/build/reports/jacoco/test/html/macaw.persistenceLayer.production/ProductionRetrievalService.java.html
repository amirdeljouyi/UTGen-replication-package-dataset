<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductionRetrievalService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">69_lhamacaw</a> &gt; <a href="index.source.html" class="el_package">macaw.persistenceLayer.production</a> &gt; <span class="el_source">ProductionRetrievalService.java</span></div><h1>ProductionRetrievalService.java</h1><pre class="source lang-java linenums">package macaw.persistenceLayer.production;

import macaw.system.Log;
import macaw.system.MacawException;
import macaw.system.SessionProperties;
import macaw.businessLayer.*;

import java.sql.Connection;
import java.util.ArrayList;

/**
 * Implements the {@link macaw.businessLayer.MacawRetrievalAPI} interface as a service which retrieves
 * all of its data from a database.    
 * 
 * &lt;code&gt;DemonstrationRetrievalService&lt;/code&gt; delegates the implementations 
 * of {@link macaw.businessLayer.MacawRetrievalAPI} methods to manager classes whose names are prefixed
 * with &quot;SQL&quot; (eg: {@link macaw.persistenceLayer.production.SQLVariableManager}).
 * 
 * The main duties of this class are 
 * &lt;ol&gt;
 * &lt;li&gt;validate users before the methods are allowed to proceed&lt;/li&gt; 
 * &lt;li&gt;log any exceptions that are thrown.&lt;/li&gt;
 * &lt;/ol&gt;
 * 
 * &lt;p&gt;
 * For security reasons, exceptions are caught rather than thrown to the calling class.  
 * &lt;hr&gt;
 * Copyright 2010 Medical Research Council Unit for Lifelong Health and Ageing
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *      http://www.apache.org/licenses/LICENSE-2.0
 * Unless required by applicable law or agreed to in writing, software 
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.  
 * &lt;hr&gt;
 * @author Kevin Garwood (kgarwood@users.sourceforge.net)
 * @version 1.0	
 */

/*
 * Code Road Map:
 * --------------
 * Code is organised into the following sections.  Wherever possible, 
 * methods are classified based on an order of precedence described in 
 * parentheses (..).  For example, if you're trying to find a method 
 * 'getName(...)' that is both an interface method and an accessor 
 * method, the order tells you it should appear under interface.
 * 
 * Order of 
 * Precedence     Section
 * ==========     ======
 * (1)            Section Constants
 * (2)            Section Properties
 * (3)            Section Construction
 * (7)            Section Accessors and Mutators
 * (6)            Section Errors and Validation
 * (5)            Section Interfaces
 * (4)            Section Overload
 *
 */

public class ProductionRetrievalService implements MacawRetrievalAPI {

	// ==========================================
	// Section Constants
	// ==========================================

	// ==========================================
	// Section Properties
	// ==========================================
	private SQLConnectionManager sqlConnectionManager;
	private SQLUserManager userManager;
	private SQLListChoiceManager listChoiceManager;
	private SQLVariableManager variableManager;
	private SQLValueLabelManager valueLabelsManager;
	private SQLOntologyTermManager ontologyTermManager;
	private SQLSupportingDocumentsManager documentsManager;
	
	private MacawSecurityAPI securityValidationService;
	private Log log;
	
	// ==========================================
	// Section Construction
	// ==========================================
<span class="fc" id="L88">	public ProductionRetrievalService(SessionProperties sessionProperties) throws MacawException {</span>

<span class="fc" id="L90">		log = sessionProperties.getLog();</span>
		
<span class="fc" id="L92">		sqlConnectionManager </span>
			= new SQLConnectionManager(sessionProperties);

		
<span class="fc" id="L96">		userManager = new SQLUserManager(null, sqlConnectionManager);</span>
<span class="fc" id="L97">		securityValidationService = userManager;</span>
<span class="fc" id="L98">		valueLabelsManager </span>
			= new SQLValueLabelManager(null);
<span class="fc" id="L100">		valueLabelsManager.setLog(log);</span>
		
<span class="fc" id="L102">		ontologyTermManager</span>
			= new SQLOntologyTermManager(null);
<span class="fc" id="L104">		ontologyTermManager.setLog(log);</span>

<span class="fc" id="L106">		listChoiceManager </span>
			= new SQLListChoiceManager(null);
<span class="fc" id="L108">		listChoiceManager.setLog(log);</span>
		
		
<span class="fc" id="L111">		documentsManager </span>
			= new SQLSupportingDocumentsManager(null);
<span class="fc" id="L113">		documentsManager.setLog(log);</span>
	
<span class="fc" id="L115">		variableManager</span>
			= new SQLVariableManager(null,
									 listChoiceManager,
									 ontologyTermManager,
									 documentsManager);
<span class="fc" id="L120">		variableManager.setLog(log);</span>
<span class="fc" id="L121">	}</span>
	
	// ==========================================
	// Section Accessors and Mutators
	// ==========================================
	
	// ==========================================
	// Section Errors and Validation
	// ==========================================

	// ==========================================
	// Section Interfaces
	// ==========================================

	public User getUserFromID(User user, String userID) {		
<span class="nc" id="L136">		Connection connection = null;</span>
		try {
<span class="nc" id="L138">			checkValidUser(user);</span>
<span class="nc" id="L139">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L140">			return userManager.getUserFromID(connection, user, userID);</span>
		}
<span class="nc" id="L142">		catch(MacawException exception) {</span>
<span class="nc" id="L143">			log.logException(exception);</span>
<span class="nc" id="L144">			return null;</span>
		}
		
		finally {
<span class="nc" id="L148">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public ArrayList&lt;User&gt; getUnverifiedUsers(User user) {
<span class="nc" id="L153">		Connection connection = null;</span>
		try {
<span class="nc" id="L155">			checkValidUser(user);</span>
<span class="nc" id="L156">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L157">			return userManager.getUnverifiedUsers(connection, user);</span>
		}
<span class="nc" id="L159">		catch(MacawException exception) {</span>
<span class="nc" id="L160">			log.logException(exception);</span>
<span class="nc" id="L161">			ArrayList&lt;User&gt; emptyUserList = new ArrayList&lt;User&gt;();</span>
<span class="nc" id="L162">			return emptyUserList;</span>
		}
		
		finally {
<span class="nc" id="L166">			sqlConnectionManager.releaseConnection(connection);</span>
		}	
	}

	public ArrayList&lt;User&gt; getUsers(User admin) {
		try {
<span class="nc" id="L172">			checkValidAdministrator(admin);</span>
<span class="nc" id="L173">			return userManager.getUsers(admin);</span>
		}
<span class="nc" id="L175">		catch(MacawException exception) {</span>
<span class="nc" id="L176">			log.logException(exception);</span>
<span class="nc" id="L177">			ArrayList&lt;User&gt; emptyUserList = new ArrayList&lt;User&gt;();</span>
<span class="nc" id="L178">			return emptyUserList;</span>
		}
	}
	
	public User getUserFromEmail(User user, String email) {
<span class="nc" id="L183">		Connection connection = null;</span>
		try {
<span class="nc" id="L185">			checkValidUser(user);</span>
<span class="nc" id="L186">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L187">			return userManager.getUserFromEmail(connection, user, email);</span>

		}
<span class="nc" id="L190">		catch(MacawException exception) {</span>
<span class="nc" id="L191">			log.logException(exception);</span>
<span class="nc" id="L192">			return null;</span>
		}
		finally {
<span class="nc" id="L195">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public ArrayList&lt;Category&gt; getCategories(User user) {
<span class="nc" id="L200">		Connection connection = null;</span>
		try {
<span class="nc" id="L202">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L203">			checkValidUser(user);</span>
<span class="nc" id="L204">			return listChoiceManager.getCategories(connection, user);</span>
		}
<span class="nc" id="L206">		catch(MacawException exception) {</span>
<span class="nc" id="L207">			log.logException(exception);</span>
<span class="nc" id="L208">			return null;</span>
		}
		finally {
<span class="nc" id="L211">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public ArrayList&lt;AvailabilityState&gt; getAvailabilityStates(User user) {
<span class="nc" id="L216">		Connection connection = null;</span>
		try {
<span class="nc" id="L218">			checkValidUser(user);</span>
<span class="nc" id="L219">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L220">			return listChoiceManager.getAvailabilityStates(connection);</span>
		}
<span class="nc" id="L222">		catch(MacawException exception) {</span>
<span class="nc" id="L223">			log.logException(exception);</span>
<span class="nc" id="L224">			return null;</span>
		}
		finally {
<span class="nc" id="L227">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	/**
	 * Methods for managing cleaning states
	 */
	public ArrayList&lt;CleaningState&gt; getCleaningStates(User user) {	
<span class="nc" id="L235">		Connection connection = null;</span>
		try {
<span class="nc" id="L237">			checkValidUser(user);</span>
<span class="nc" id="L238">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L239">			return listChoiceManager.getCleaningStates(connection, user);</span>
		}
<span class="nc" id="L241">		catch(MacawException exception) {</span>
<span class="nc" id="L242">			log.logException(exception);</span>
<span class="nc" id="L243">			return null;</span>
		}
		finally {
<span class="nc" id="L246">			sqlConnectionManager.releaseConnection(connection);</span>
		}	
	}
	
	public ArrayList&lt;ValueLabel&gt; getValueLabels(User user,
												String variableName) {

<span class="nc" id="L253">		Connection connection = null;</span>
		try {
<span class="nc" id="L255">			checkValidUser(user);</span>
<span class="nc" id="L256">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L257">			return valueLabelsManager.getValueLabels(connection, </span>
													 user,
													 variableName); 
		}
<span class="nc" id="L261">		catch(MacawException exception) {</span>
<span class="nc" id="L262">			log.logException(exception);</span>
<span class="nc" id="L263">			return null;</span>
		}
		finally {
<span class="nc" id="L266">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}
	
	public ArrayList&lt;OntologyTerm&gt; getOntologyTerms(User user,
													String variableName) {

<span class="nc" id="L273">		Connection connection = null;</span>
		try {
<span class="nc" id="L275">			checkValidUser(user);</span>
<span class="nc" id="L276">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L277">			return variableManager.getAssociatedOntologyTerms(connection,</span>
															  user,
															  variableName);
		}
<span class="nc" id="L281">		catch(MacawException exception) {</span>
<span class="nc" id="L282">			log.logException(exception);</span>
<span class="nc" id="L283">			return null;</span>
		}
		finally {
<span class="nc" id="L286">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public ArrayList&lt;OntologyTerm&gt; getOntologyTerms(User user,
													Variable variable) {

<span class="nc" id="L293">		Connection connection = null;</span>
		try {
<span class="nc" id="L295">			checkValidUser(user);</span>
<span class="nc" id="L296">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L297">			return variableManager.getAssociatedOntologyTerms(connection,</span>
					  										  user,
					  										  variable);
		}
<span class="nc" id="L301">		catch(MacawException exception) {</span>
<span class="nc" id="L302">			log.logException(exception);</span>
<span class="nc" id="L303">			return null;</span>
		}
		finally {
<span class="nc" id="L306">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public ArrayList&lt;SupportingDocument&gt; getSupportingDocuments(User user,
														  		String variableName) {

<span class="nc" id="L313">		Connection connection = null;</span>
		try {
<span class="nc" id="L315">			checkValidUser(user);</span>
<span class="nc" id="L316">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L317">			return variableManager.getAssociatedSupportingDocuments(connection,</span>
						  									  		user,
						  									  		variableName);
		}
<span class="nc" id="L321">		catch(MacawException exception) {</span>
<span class="nc" id="L322">			log.logException(exception);</span>
<span class="nc" id="L323">			return null;</span>
		}
		finally {
<span class="nc" id="L326">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	
	
	/**
	 * Methods for data libraries
	 */
	public ArrayList&lt;AliasFilePath&gt; getAliasFilePaths(User user) {		
<span class="nc" id="L336">		Connection connection = null;</span>
		try {
<span class="nc" id="L338">			checkValidUser(user);</span>
<span class="nc" id="L339">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L340">			return listChoiceManager.getAliasFilePaths(connection);</span>
		}
<span class="nc" id="L342">		catch(MacawException exception) {</span>
<span class="nc" id="L343">			log.logException(exception);</span>
<span class="nc" id="L344">			return null;</span>
		}
		finally {
<span class="nc" id="L347">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}
	
	public AliasFilePath getAliasFilePath(User user, String cardNumber) {

<span class="nc" id="L353">		Connection connection = null;</span>
		try {
<span class="nc" id="L355">			checkValidUser(user);</span>
<span class="nc" id="L356">			connection = sqlConnectionManager.getConnection();			</span>
<span class="nc" id="L357">			return listChoiceManager.getAliasFilePath(connection, cardNumber);</span>
		}
<span class="nc" id="L359">		catch(MacawException exception) {</span>
<span class="nc" id="L360">			log.logException(exception);</span>
<span class="nc" id="L361">			return null;</span>
		}
		finally {
<span class="nc" id="L364">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}

	public ArrayList&lt;AliasFilePath&gt; getAliasFilePathsMatchingName(User user, 
																  String regularExpression) {

<span class="nc" id="L371">		Connection connection = null;</span>
		try {
<span class="nc" id="L373">			checkValidUser(user);</span>
<span class="nc" id="L374">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L375">			return listChoiceManager.getAliasFilePathsMatchingName(connection, regularExpression);</span>
		}
<span class="nc" id="L377">		catch(MacawException exception) {</span>
<span class="nc" id="L378">			log.logException(exception);</span>
<span class="nc" id="L379">			return null;</span>
		}
		finally {
<span class="nc" id="L382">			sqlConnectionManager.releaseConnection(connection);</span>
		}
	}	

	public ArrayList&lt;Category&gt; getCategoriesForVariable(User user,
														String variableName){

<span class="nc" id="L389">		Connection connection = null;</span>
		try {
<span class="nc" id="L391">			checkValidUser(user);</span>
<span class="nc" id="L392">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L393">			return variableManager.getCategoriesForVariable(connection, variableName);</span>
		}
<span class="nc" id="L395">		catch(MacawException exception) {</span>
<span class="nc" id="L396">			log.logException(exception);</span>
<span class="nc" id="L397">			ArrayList&lt;Category&gt; emptyList</span>
				= new ArrayList&lt;Category&gt;();
<span class="nc" id="L399">			return emptyList;</span>
		}
		finally {
<span class="nc" id="L402">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	public ArrayList&lt;VariableSummary&gt; getVariableSummariesForCategory(User user, 
																	  String categoryName) {

<span class="nc" id="L409">		Connection connection = null;</span>
		try {
<span class="nc" id="L411">			checkValidUser(user);</span>
<span class="nc" id="L412">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L413">			return variableManager.getVariableSummariesForCategory(connection, categoryName);</span>
		}
<span class="nc" id="L415">		catch(MacawException exception) {</span>
<span class="nc" id="L416">			log.logException(exception);</span>
<span class="nc" id="L417">			ArrayList&lt;VariableSummary&gt; emptyList</span>
				= new ArrayList&lt;VariableSummary&gt;();
<span class="nc" id="L419">			return emptyList;</span>
		}
		finally {
<span class="nc" id="L422">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public String[] getVariableNames(User user) {
<span class="nc" id="L427">		Connection connection = null;</span>
		
		try {
<span class="nc" id="L430">			checkValidUser(user);</span>
<span class="nc" id="L431">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L432">			return variableManager.getVariableNames(connection, user);</span>
		}
<span class="nc" id="L434">		catch(MacawException exception) {</span>
<span class="nc" id="L435">			log.logException(exception);</span>
<span class="nc" id="L436">			return(new String[0]);</span>
		}
		finally {
<span class="nc" id="L439">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}

	public Variable getVariable(User user, String variableName) {
<span class="nc" id="L444">		Connection connection = null;</span>
		try {
<span class="nc" id="L446">			checkValidUser(user);</span>
<span class="nc" id="L447">			connection = sqlConnectionManager.getConnection();</span>
<span class="nc" id="L448">			return variableManager.getVariable(connection, variableName);</span>
		}
<span class="nc" id="L450">		catch(MacawException exception) {</span>
<span class="nc" id="L451">			log.logException(exception);</span>
<span class="nc" id="L452">			return null;</span>
		}
		finally {
<span class="nc" id="L455">			sqlConnectionManager.releaseConnection(connection);</span>
		}		
	}
	
	private void checkValidUser(User user) throws MacawException {
<span class="nc" id="L460">		securityValidationService.validateUser(user);	</span>
<span class="nc" id="L461">	}</span>

	private void checkValidAdministrator(User user) throws MacawException {
<span class="nc" id="L464">		securityValidationService.validateAdministrator(user);	</span>
<span class="nc" id="L465">	}</span>
	
	// ==========================================
	// Section Overload
	// ==========================================
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>