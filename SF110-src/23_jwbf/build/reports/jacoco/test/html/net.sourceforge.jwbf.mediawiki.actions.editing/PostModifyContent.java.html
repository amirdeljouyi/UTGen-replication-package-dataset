<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostModifyContent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">23_jwbf</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.jwbf.mediawiki.actions.editing</a> &gt; <span class="el_source">PostModifyContent.java</span></div><h1>PostModifyContent.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2007 Thomas Stock.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 * Contributors:
 *
 */
package net.sourceforge.jwbf.mediawiki.actions.editing;

import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_09;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_10;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_11;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_12;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_13;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_14;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_15;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_16;

import java.util.HashSet;
import java.util.Hashtable;
import java.util.Set;

import lombok.extern.slf4j.Slf4j;
import net.sourceforge.jwbf.core.actions.Get;
import net.sourceforge.jwbf.core.actions.Post;
import net.sourceforge.jwbf.core.actions.util.ActionException;
import net.sourceforge.jwbf.core.actions.util.HttpAction;
import net.sourceforge.jwbf.core.actions.util.ProcessException;
import net.sourceforge.jwbf.core.bots.util.JwbfException;
import net.sourceforge.jwbf.core.contentRep.ContentAccessable;
import net.sourceforge.jwbf.core.contentRep.SimpleArticle;
import net.sourceforge.jwbf.mediawiki.actions.MediaWiki;
import net.sourceforge.jwbf.mediawiki.actions.util.MWAction;
import net.sourceforge.jwbf.mediawiki.actions.util.SupportedBy;
import net.sourceforge.jwbf.mediawiki.actions.util.VersionException;
import net.sourceforge.jwbf.mediawiki.bots.MediaWikiBot;

/**
 *
 *
 * Writes an article.
 *
 *
 * @author Thomas Stock
 */
<span class="nc" id="L57">@Slf4j</span>
@SupportedBy({ MW1_09, MW1_10, MW1_11, MW1_12, MW1_13, MW1_14, MW1_15, MW1_16})
public class PostModifyContent extends MWAction {

<span class="nc" id="L61">  private boolean first = true;</span>
<span class="nc" id="L62">  private boolean second = true;</span>

  private final ContentAccessable a;
<span class="nc" id="L65">  private Hashtable&lt;String, String&gt; tab = new Hashtable&lt;String, String&gt;();</span>
  private MediaWikiBot bot;
<span class="nc" id="L67">  private GetApiToken apiReq = null;</span>
<span class="nc" id="L68">  private HttpAction apiGet = null;</span>
<span class="nc" id="L69">  private HttpAction initOldGet = null;</span>
<span class="nc" id="L70">  private Post postModify = null;</span>
<span class="nc" id="L71">  private boolean apiEdit = false;</span>
  /**
   * @param bot a
   * @param a the
   * @throws ProcessException a
   * @throws ActionException a
   */
  public PostModifyContent(MediaWikiBot bot, final SimpleArticle a) throws ActionException, ProcessException {
<span class="nc" id="L79">    super(bot.getVersion());</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">    if (a.getTitle().length() &lt; 1) {</span>
<span class="nc" id="L81">      throw new ActionException(&quot;imposible request, no title&quot;);</span>
    }
<span class="nc" id="L83">    this.a = a;</span>
<span class="nc" id="L84">    this.bot = bot;</span>
<span class="nc" id="L85">  }</span>

  /**
   * {@inheritDoc}
   */
  public HttpAction getNextMessage() {

<span class="nc bnc" id="L92" title="All 2 branches missed.">    if (first) {</span>
      try {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (!bot.isEditApi())</span>
<span class="nc" id="L95">          throw new VersionException(&quot;write api off - user triggerd&quot;);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        switch (bot.getVersion()) {</span>
          case MW1_09:
          case MW1_10:
          case MW1_11:
          case MW1_12:
<span class="nc" id="L101">            throw new VersionException(&quot;write api not available&quot;);</span>
          default:
            break;
        }
<span class="nc" id="L105">        first = false;</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (!(bot.getUserinfo().getRights().contains(&quot;edit&quot;)</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            &amp;&amp; bot.getUserinfo().getRights().contains(&quot;writeapi&quot;))) {</span>
<span class="nc" id="L108">          throw new VersionException(&quot;write api not avalibal&quot;);</span>
        }
<span class="nc" id="L110">        apiReq = new GetApiToken(GetApiToken.Intoken.EDIT,</span>
<span class="nc" id="L111">            a.getTitle(), bot.getVersion(), bot.getUserinfo());</span>
<span class="nc" id="L112">        apiGet = apiReq.getNextMessage();</span>
<span class="nc" id="L113">        apiEdit = true;</span>
<span class="nc" id="L114">        return apiGet;</span>

<span class="nc" id="L116">      } catch (VersionException e) {</span>
<span class="nc" id="L117">        String uS = &quot;/index.php?title=&quot;</span>
<span class="nc" id="L118">            + MediaWiki.encode(a.getTitle()) // TODO check encoding here</span>
            + &quot;&amp;action=edit&amp;dontcountme=s&quot;;
<span class="nc" id="L120">        initOldGet = new Get(uS);</span>
<span class="nc" id="L121">        first = false;</span>
<span class="nc" id="L122">        return initOldGet;</span>
<span class="nc" id="L123">      } catch (JwbfException e) {</span>
<span class="nc" id="L124">        throw new RuntimeException(e);</span>
      }
    }
<span class="nc bnc" id="L127" title="All 2 branches missed.">    if (apiEdit) {</span>
<span class="nc" id="L128">      String uS = &quot;/api.php?action=edit&amp;title=&quot; + MediaWiki.encode(a.getTitle());</span>
<span class="nc" id="L129">      postModify = new Post(uS);</span>
<span class="nc" id="L130">      postModify.addParam(&quot;summary&quot;, a.getEditSummary());</span>
<span class="nc" id="L131">      postModify.addParam(&quot;text&quot;, a.getText());</span>
      try {
<span class="nc" id="L133">        Set&lt;String&gt; groups = bot.getUserinfo().getGroups();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (!isIntersectionEmpty(groups, MediaWiki.BOT_GROUPS)) {</span>
<span class="nc" id="L135">          postModify.addParam(&quot;bot&quot;, &quot;&quot;);</span>
        }
<span class="nc" id="L137">      } catch (JwbfException e) {</span>
<span class="nc" id="L138">        log.warn(&quot;{}&quot;, e);</span>
<span class="nc" id="L139">      }</span>

      //			postModify.addParam(&quot;watch&quot;, &quot;unknown&quot;)
<span class="nc bnc" id="L142" title="All 2 branches missed.">      if (a.isMinorEdit())</span>
<span class="nc" id="L143">        postModify.addParam(&quot;minor&quot;, &quot;&quot;);</span>
      else
<span class="nc" id="L145">        postModify.addParam(&quot;notminor&quot;, &quot;&quot;);</span>
<span class="nc" id="L146">      postModify.addParam(&quot;token&quot;, apiReq.getToken());</span>

<span class="nc" id="L148">    } else {</span>
<span class="nc" id="L149">      String uS = &quot;/index.php?title=&quot; + MediaWiki.encode(a.getTitle())</span>
          + &quot;&amp;action=submit&quot;;

<span class="nc" id="L152">      postModify = new Post(uS);</span>
<span class="nc" id="L153">      postModify.addParam(&quot;wpSave&quot;, &quot;Save&quot;);</span>

<span class="nc" id="L155">      postModify.addParam(&quot;wpStarttime&quot;, tab.get(&quot;wpStarttime&quot;));</span>

<span class="nc" id="L157">      postModify.addParam(&quot;wpEditToken&quot;, tab.get(&quot;wpEditToken&quot;));</span>

<span class="nc" id="L159">      postModify.addParam(&quot;wpEdittime&quot;, tab.get(&quot;wpEdittime&quot;));</span>

<span class="nc" id="L161">      postModify.addParam(&quot;wpTextbox1&quot;, a.getText());</span>

<span class="nc" id="L163">      String editSummaryText = a.getEditSummary();</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">      if (editSummaryText != null &amp;&amp; editSummaryText.length() &gt; 200) {</span>
<span class="nc" id="L165">        editSummaryText = editSummaryText.substring(0, 200);</span>
      }

<span class="nc" id="L168">      postModify.addParam(&quot;wpSummary&quot;, editSummaryText);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">      if (a.isMinorEdit()) {</span>

<span class="nc" id="L171">        postModify.addParam(&quot;wpMinoredit&quot;, &quot;1&quot;);</span>

      }

<span class="nc" id="L175">      log.info(&quot;WRITE: &quot; + a.getTitle());</span>


    }
<span class="nc" id="L179">    second = false;</span>

<span class="nc" id="L181">    return postModify;</span>
  }

  /**
   * {@inheritDoc}
   */
  @Override
  public boolean hasMoreMessages() {
<span class="nc bnc" id="L189" title="All 4 branches missed.">    return first || second;</span>
  }
  /**
   * {@inheritDoc}
   */
  @Override
  public String processReturningText(String s, HttpAction hm)
      throws ProcessException {
<span class="nc bnc" id="L197" title="All 2 branches missed.">    if (s.contains(&quot;error&quot;)) {</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">      if (s.length() &gt; 700) {</span>
<span class="nc" id="L199">        s = s.substring(0, 700);</span>
      }
<span class="nc" id="L201">      throw new ProcessException(s);</span>
    }
<span class="nc bnc" id="L203" title="All 4 branches missed.">    if (initOldGet != null &amp;&amp; hm.getRequest().equals(initOldGet.getRequest())) {</span>
<span class="nc" id="L204">      getWpValues(s, tab);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L206">        log.debug(tab.toString());</span>
      }

<span class="nc bnc" id="L209" title="All 4 branches missed.">    } else if (apiGet != null &amp;&amp; hm.getRequest().equals(apiGet.getRequest())) {</span>
<span class="nc" id="L210">      log.debug(&quot;parseapi&quot;);</span>
<span class="nc" id="L211">      apiReq.processReturningText(s, hm);</span>
    }


<span class="nc" id="L215">    return s;</span>
  }

  /**
   *
   * @param text
   *            where to search
   * @param tab
   *            tabel with required values
   */
  private void getWpValues(final String text, Hashtable&lt;String, String&gt; tab) {

<span class="nc" id="L227">    String[] tParts = text.split(&quot;\n&quot;);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">    for (int i = 0; i &lt; tParts.length; i++) {</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">      if (tParts[i].indexOf(&quot;wpEditToken&quot;) &gt; 0) {</span>
        // \&lt;input type='hidden' value=\&quot;(.*?)\&quot; name=\&quot;wpEditToken\&quot;
<span class="nc" id="L231">        int begin = tParts[i].indexOf(&quot;value&quot;) + 7;</span>
<span class="nc" id="L232">        int end = tParts[i].indexOf(&quot;name&quot;) - 2;</span>
<span class="nc" id="L233">        tab.put(&quot;wpEditToken&quot;, tParts[i].substring(begin, end));</span>

<span class="nc bnc" id="L235" title="All 2 branches missed.">      } else if (tParts[i].indexOf(&quot;wpEdittime&quot;) &gt; 0) {</span>
        // value=&quot;(\d+)&quot; name=[&quot;\']wpEdittime[&quot;\']
<span class="nc" id="L237">        int begin = tParts[i].indexOf(&quot;value&quot;) + 7;</span>
<span class="nc" id="L238">        int end = tParts[i].indexOf(&quot;name&quot;) - 2;</span>

<span class="nc" id="L240">        tab.put(&quot;wpEdittime&quot;, tParts[i].substring(begin, end));</span>

<span class="nc bnc" id="L242" title="All 2 branches missed.">      } else if (tParts[i].indexOf(&quot;wpStarttime&quot;) &gt; 0) {</span>
        // value=&quot;(\d+)&quot; name=[&quot;\']wpStarttime[&quot;\']
<span class="nc" id="L244">        int begin = tParts[i].indexOf(&quot;value&quot;) + 7;</span>
<span class="nc" id="L245">        int end = tParts[i].indexOf(&quot;name&quot;) - 2;</span>

<span class="nc" id="L247">        tab.put(&quot;wpStarttime&quot;, tParts[i].substring(begin, end));</span>

      }
    }

<span class="nc" id="L252">  }</span>

  /**
   * @param a a
   * @param b a
   * @return true if one or both sets are &lt;code&gt;null&lt;/code&gt; or the intersection of sets is empty.
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public static boolean isIntersectionEmpty(Set&lt;?&gt; a, Set&lt;?&gt; b) {
<span class="nc bnc" id="L261" title="All 4 branches missed.">    if (a != null &amp;&amp; b != null) {</span>
<span class="nc" id="L262">      Set&lt;?&gt; aTemp = new HashSet(a);</span>
<span class="nc" id="L263">      Set&lt;?&gt; bTemp = new HashSet(b);</span>
<span class="nc" id="L264">      aTemp.retainAll(bTemp);</span>
<span class="nc" id="L265">      bTemp.retainAll(aTemp);</span>
<span class="nc bnc" id="L266" title="All 4 branches missed.">      return !(aTemp.size() &gt; 0 &amp;&amp; bTemp.size() &gt; 0);</span>
    }
<span class="nc" id="L268">    return true;</span>
  }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>