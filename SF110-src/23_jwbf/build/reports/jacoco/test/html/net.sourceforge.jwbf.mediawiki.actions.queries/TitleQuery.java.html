<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TitleQuery.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">23_jwbf</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.jwbf.mediawiki.actions.queries</a> &gt; <span class="el_source">TitleQuery.java</span></div><h1>TitleQuery.java</h1><pre class="source lang-java linenums">package net.sourceforge.jwbf.mediawiki.actions.queries;

import java.util.Collection;
import java.util.Iterator;
import java.util.Vector;

import lombok.extern.slf4j.Slf4j;
import net.sourceforge.jwbf.core.actions.util.ActionException;
import net.sourceforge.jwbf.core.actions.util.HttpAction;
import net.sourceforge.jwbf.core.actions.util.ProcessException;
import net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version;
import net.sourceforge.jwbf.mediawiki.actions.util.MWAction;
import net.sourceforge.jwbf.mediawiki.actions.util.VersionException;
import net.sourceforge.jwbf.mediawiki.bots.MediaWikiBot;

/**
 * Abstract class which is superclass of all titleiterations, represented by the sufix &quot;Titles&quot;.
 * 
 * @author Thomas Stock
 * @param &lt;T&gt; of
 */
<span class="fc" id="L22">@Slf4j</span>
public abstract class TitleQuery&lt;T&gt; implements Iterable&lt;T&gt;, Iterator&lt;T&gt; {

  protected Iterator&lt;T&gt; titleIterator;
  private InnerAction inner;
  private final MediaWikiBot bot;

  /** Information necessary to get the next api page. */
<span class="fc" id="L30">  protected String nextPageInfo = &quot;&quot;;</span>

  protected final String getNextPageInfo() {
<span class="nc" id="L33">    return nextPageInfo;</span>
  }

<span class="fc" id="L36">  protected TitleQuery(MediaWikiBot bot) throws VersionException {</span>
<span class="fc" id="L37">    this.bot = bot;</span>
<span class="nc" id="L38">    inner = getInnerAction(bot.getVersion());</span>
<span class="nc" id="L39">  }</span>

  protected InnerAction getInnerAction(Version v) throws VersionException {
<span class="nc" id="L42">    return new InnerAction(v);</span>
  }
  /**
   * {@inheritDoc}
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  public final Iterator&lt;T&gt; iterator() {
    try {
<span class="nc" id="L50">      return (Iterator&lt;T&gt;) clone();</span>
<span class="nc" id="L51">    } catch (CloneNotSupportedException e) {</span>
<span class="nc" id="L52">      log.error(&quot;cloning should be supported&quot;);</span>
<span class="nc" id="L53">      e.printStackTrace();</span>
<span class="nc" id="L54">      return null;</span>
    }
  }
  /**
   * {@inheritDoc}
   */
  public final boolean hasNext() {
<span class="nc" id="L61">    doCollection();</span>
<span class="nc" id="L62">    return titleIterator.hasNext();</span>
  }
  /**
   * {@inheritDoc}
   */
  public final T next() {
<span class="nc" id="L68">    doCollection();</span>
<span class="nc" id="L69">    return titleIterator.next();</span>
  }
  /**
   * {@inheritDoc}
   */
  public final void remove() {
<span class="nc" id="L75">    titleIterator.remove();</span>
<span class="nc" id="L76">  }</span>

  protected abstract HttpAction prepareCollection();


  private boolean hasNextPage() {
<span class="nc bnc" id="L82" title="All 4 branches missed.">    return nextPageInfo != null &amp;&amp; nextPageInfo.length() &gt; 0;</span>
  }



  private void doCollection() {


<span class="nc bnc" id="L90" title="All 6 branches missed.">    if (inner.init || (!titleIterator.hasNext() &amp;&amp; hasNextPage())) {</span>
<span class="nc" id="L91">      inner.init = false;</span>
      try {
<span class="nc" id="L93">        inner.setHasMoreMessages(true);</span>
<span class="nc" id="L94">        inner.msg = prepareCollection();</span>

<span class="nc" id="L96">        bot.performAction(inner);</span>



<span class="nc" id="L100">      } catch (ActionException ae) {</span>
<span class="nc" id="L101">        ae.printStackTrace();</span>

<span class="nc" id="L103">      } catch (ProcessException e) {</span>
<span class="nc" id="L104">        e.printStackTrace();</span>

<span class="nc" id="L106">      }</span>
    }
<span class="nc" id="L108">  }</span>

  protected abstract Collection&lt;T&gt; parseArticleTitles(String s);
  protected abstract String parseHasMore(final String s);
  /**
   * Inner helper class for this type.
   * @author Thomas Stock
   *
   */
  public class InnerAction extends MWAction {

    private HttpAction msg;
<span class="nc" id="L120">    private boolean init = true;</span>

<span class="nc" id="L122">    protected InnerAction(Version v) throws VersionException {</span>
<span class="nc" id="L123">      super(v);</span>
<span class="nc" id="L124">    }</span>

    protected void setMessage(HttpAction msg) {
<span class="nc" id="L127">      this.msg = msg;</span>
<span class="nc" id="L128">    }</span>
    /**
     * {@inheritDoc}
     */
    public HttpAction getNextMessage() {
<span class="nc" id="L133">      return msg;</span>
    }


    /**
     * {@inheritDoc}
     */
    @Override
    public String processAllReturningText(final String s)
        throws ProcessException {
<span class="nc" id="L143">      Collection&lt;T&gt; knownResults = new Vector&lt;T&gt;();</span>

<span class="nc" id="L145">      knownResults.addAll(parseArticleTitles(s));</span>
<span class="nc" id="L146">      nextPageInfo = parseHasMore(s);</span>

<span class="nc" id="L148">      titleIterator = knownResults.iterator();</span>
<span class="nc" id="L149">      return &quot;&quot;;</span>
    }

  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>