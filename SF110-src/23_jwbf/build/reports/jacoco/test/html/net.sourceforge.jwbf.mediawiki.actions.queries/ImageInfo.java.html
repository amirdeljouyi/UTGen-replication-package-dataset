<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImageInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">23_jwbf</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.jwbf.mediawiki.actions.queries</a> &gt; <span class="el_source">ImageInfo.java</span></div><h1>ImageInfo.java</h1><pre class="source lang-java linenums">package net.sourceforge.jwbf.mediawiki.actions.queries;

import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_11;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_12;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_13;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_14;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_15;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_16;

import java.awt.image.BufferedImage;
import java.io.IOException;
import java.io.Reader;
import java.io.StringReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;

import javax.imageio.ImageIO;

import lombok.extern.slf4j.Slf4j;
import net.sourceforge.jwbf.core.actions.Get;
import net.sourceforge.jwbf.core.actions.util.ActionException;
import net.sourceforge.jwbf.core.actions.util.HttpAction;
import net.sourceforge.jwbf.core.actions.util.ProcessException;
import net.sourceforge.jwbf.mediawiki.actions.MediaWiki;
import net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version;
import net.sourceforge.jwbf.mediawiki.actions.util.MWAction;
import net.sourceforge.jwbf.mediawiki.actions.util.SupportedBy;
import net.sourceforge.jwbf.mediawiki.actions.util.VersionException;
import net.sourceforge.jwbf.mediawiki.bots.MediaWikiBot;

import org.apache.commons.lang.math.NumberUtils;
import org.jdom.Document;
import org.jdom.Element;
import org.jdom.JDOMException;
import org.jdom.input.SAXBuilder;
import org.xml.sax.InputSource;

/**
 * Action to receive the full address of an image. Like &quot;Img.gif&quot; to
 * &quot;http://wikihost.tld/w/images/x/y/Img.gif&quot;.
 * 
 * @author Thomas Stock
 * 
 */
<span class="nc" id="L49">@Slf4j</span>
@SupportedBy({ MW1_11, MW1_12, MW1_13, MW1_14, MW1_15, MW1_16 })
public class ImageInfo extends MWAction {
<span class="nc" id="L52">  private static final Map&lt;String, String&gt; EMPTY_STRING_MAP = Collections</span>
<span class="nc" id="L53">      .emptyMap();</span>

  public static final String WIDTH = &quot;iiurlwidth&quot;;
  public static final String HEIGHT = &quot;iiurlheight&quot;;

<span class="nc" id="L58">  private String urlOfImage = &quot;&quot;;</span>
  private Get msg;
  private final MediaWikiBot bot;
<span class="nc" id="L61">  private boolean selfEx = true;</span>
<span class="nc" id="L62">  private Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();</span>

  /**
   * 
   * Get an absolute url to an image.
   * 
   * @param bot
   *          a
   * @param name
   *          of, like &quot;Test.gif&quot;
   * @throws VersionException
   *           if not supported
   */
  public ImageInfo(MediaWikiBot bot, String name) throws VersionException {
<span class="nc" id="L76">    this(bot, name, EMPTY_STRING_MAP);</span>
<span class="nc" id="L77">  }</span>

  public ImageInfo(MediaWikiBot bot, String name, Map&lt;String, String&gt; params)
      throws VersionException {
<span class="nc" id="L81">    super(bot.getVersion());</span>
<span class="nc" id="L82">    this.bot = bot;</span>
<span class="nc" id="L83">    map.putAll(params);</span>
<span class="nc" id="L84">    prepareMsg(name);</span>
<span class="nc" id="L85">  }</span>

  public ImageInfo(MediaWikiBot bot, String name, String[][] params)
      throws VersionException {
<span class="nc" id="L89">    super(bot.getVersion());</span>
<span class="nc" id="L90">    this.bot = bot;</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">    if (params != null) {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">      for (String[] param : params) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (param.length == 2) {</span>
<span class="nc" id="L94">          String key = param[0];</span>
<span class="nc" id="L95">          String value = param[1];</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">          if (key != null &amp;&amp; value != null)</span>
<span class="nc" id="L97">            map.put(key, value);</span>
        }
      }
    }
<span class="nc" id="L101">    prepareMsg(name);</span>
<span class="nc" id="L102">  }</span>

  private void prepareMsg(String name) {
<span class="nc" id="L105">    int width = NumberUtils.toInt(map.get(WIDTH));</span>
<span class="nc" id="L106">    int height = NumberUtils.toInt(map.get(HEIGHT));</span>
<span class="nc" id="L107">    String addProps = &quot;&quot;;</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (width &gt; 0)</span>
<span class="nc" id="L109">      addProps += &quot;&amp;&quot; + WIDTH + &quot;=&quot; + width;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">    if (height &gt; 0)</span>
<span class="nc" id="L111">      addProps += &quot;&amp;&quot; + HEIGHT + &quot;=&quot; + height;</span>

<span class="nc bnc" id="L113" title="All 2 branches missed.">    if (bot.getVersion().greaterEqThen(Version.MW1_15)) {</span>
<span class="nc" id="L114">      msg = new Get(&quot;/api.php?action=query&amp;titles=File:&quot;</span>
<span class="nc" id="L115">          + MediaWiki.encode(name) + &quot;&amp;prop=imageinfo&quot; + addProps</span>
          + &quot;&amp;iiprop=url&amp;format=xml&quot;);
    } else {
<span class="nc" id="L118">      msg = new Get(&quot;/api.php?action=query&amp;titles=Image:&quot;</span>
<span class="nc" id="L119">          + MediaWiki.encode(name) + &quot;&amp;prop=imageinfo&quot; + addProps</span>
          + &quot;&amp;iiprop=url&amp;format=xml&quot;);
    }
<span class="nc" id="L122">  }</span>

  /**
   * @return position like &quot;http://server.tld/path/to/Test.gif&quot;
   * @throws ProcessException
   *           on
   */
  public String getUrlAsString() throws ProcessException {
    try {
<span class="nc" id="L131">      selfEx = false;</span>
<span class="nc" id="L132">      bot.performAction(this);</span>
<span class="nc" id="L133">    } catch (ActionException e1) {</span>
<span class="nc" id="L134">      e1.printStackTrace();</span>
    } finally {
<span class="nc" id="L136">      selfEx = true;</span>
    }
    try {
<span class="nc" id="L139">      new URL(urlOfImage);</span>
<span class="nc" id="L140">    } catch (MalformedURLException e) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">      if (bot.getHostUrl().length() &lt;= 0) {</span>
<span class="nc" id="L142">        throw new ProcessException(&quot;please use the constructor with hostUrl; &quot;</span>
            + urlOfImage);
      }
<span class="nc" id="L145">      urlOfImage = bot.getHostUrl() + urlOfImage;</span>
<span class="nc" id="L146">    }</span>
<span class="nc" id="L147">    return urlOfImage;</span>
  }

  public URL getUrl() throws MalformedURLException, ProcessException {
<span class="nc" id="L151">    return new URL(getUrlAsString());</span>
  }

  /**
   * {@inheritDoc}
   * 
   * @deprecated see super
   */
  @Deprecated
  @Override
  public boolean isSelfExecuter() {
<span class="nc" id="L162">    return selfEx;</span>
  }

  /**
   * @return a
   * @throws ProcessException
   *           on
   * @throws ActionException
   *           on
   * @throws IOException
   *           on
   */
  public BufferedImage getAsImage() throws ProcessException, IOException {
<span class="nc" id="L175">    return ImageIO.read(new URL(getUrlAsString()));</span>
  }

  /**
   * {@inheritDoc}
   */
  @Override
  public String processAllReturningText(String s) throws ProcessException {
<span class="nc" id="L183">    findUrlOfImage(s);</span>
<span class="nc" id="L184">    return &quot;&quot;;</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  private void findContent(final Element root) throws ProcessException {

<span class="nc" id="L190">    Iterator&lt;Element&gt; el = root.getChildren().iterator();</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">    while (el.hasNext()) {</span>
<span class="nc" id="L192">      Element element = el.next();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">      if (element.getQualifiedName().equalsIgnoreCase(&quot;ii&quot;)) {</span>
<span class="nc" id="L194">        urlOfImage = element.getAttributeValue(&quot;url&quot;);</span>

<span class="nc" id="L196">        return;</span>
      } else {
<span class="nc" id="L198">        findContent(element);</span>
      }
<span class="nc" id="L200">    }</span>

<span class="nc" id="L202">  }</span>

  private void findUrlOfImage(String s) throws ProcessException {
<span class="nc" id="L205">    SAXBuilder builder = new SAXBuilder();</span>
<span class="nc" id="L206">    Element root = null;</span>
    try {
<span class="nc" id="L208">      Reader i = new StringReader(s);</span>
<span class="nc" id="L209">      Document doc = builder.build(new InputSource(i));</span>
<span class="nc" id="L210">      root = doc.getRootElement();</span>

<span class="nc" id="L212">    } catch (JDOMException e) {</span>
<span class="nc" id="L213">      log.warn(&quot;&quot;, e);</span>
<span class="nc" id="L214">    } catch (IOException e) {</span>
<span class="nc" id="L215">      log.warn(&quot;&quot;, e);</span>
<span class="nc" id="L216">    }</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">    if (root != null)</span>
<span class="nc" id="L218">      findContent(root);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">    if (urlOfImage.length() &lt; 1)</span>
<span class="nc" id="L220">      throw new ProcessException(&quot;Could not find this image&quot;);</span>
<span class="nc" id="L221">  }</span>

  /**
   * {@inheritDoc}
   */
  public HttpAction getNextMessage() {
<span class="nc" id="L227">    return msg;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>