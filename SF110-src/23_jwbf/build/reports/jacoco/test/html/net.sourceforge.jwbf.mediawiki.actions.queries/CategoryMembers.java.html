<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CategoryMembers.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">23_jwbf</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.jwbf.mediawiki.actions.queries</a> &gt; <span class="el_source">CategoryMembers.java</span></div><h1>CategoryMembers.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2007 Thomas Stock.
 * 
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 * 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 * 
 * Contributors:
 * 
 */
package net.sourceforge.jwbf.mediawiki.actions.queries;

import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_11;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_12;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_13;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_14;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_15;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

import lombok.extern.slf4j.Slf4j;
import net.sourceforge.jwbf.core.actions.Get;
import net.sourceforge.jwbf.core.actions.util.ProcessException;
import net.sourceforge.jwbf.mediawiki.actions.MediaWiki;
import net.sourceforge.jwbf.mediawiki.actions.util.MWAction;
import net.sourceforge.jwbf.mediawiki.actions.util.SupportedBy;
import net.sourceforge.jwbf.mediawiki.actions.util.VersionException;
import net.sourceforge.jwbf.mediawiki.bots.MediaWikiBot;

/**
 * A abstract action class using the MediaWiki-api's &quot;list=categorymembers &quot;.
 * For further information see &lt;a href=
 * &quot;http://www.mediawiki.org/wiki/API:Query_-_Lists#categorymembers_.2F_cm&quot;&gt;API
 * documentation&lt;/a&gt;.
 * 
 * TODO change visibilty to package, refactor test
 * 
 * @author Thomas Stock
 */
<span class="nc" id="L49">@Slf4j</span>
@SupportedBy({ MW1_11, MW1_12, MW1_13, MW1_14, MW1_15 })
abstract class CategoryMembers extends MWAction {

  /** constant value for the bllimit-parameter. **/
  protected static final int LIMIT = 50;

  protected final MediaWikiBot bot;
  /**
   * information necessary to get the next api page.
   */
<span class="nc" id="L60">  protected String nextPageInfo = null;</span>
<span class="nc" id="L61">  protected boolean hasMoreResults = false;</span>

<span class="nc" id="L63">  protected boolean init = true;</span>
  /**
   * Name of the category.
   */
  protected final String categoryName;

<span class="nc" id="L69">  protected RequestBuilder requestBuilder = null;</span>

  protected final int[] namespace;
<span class="nc" id="L72">  private String namespaceStr = &quot;&quot;;</span>

  /**
   * The private constructor, which is used to create follow-up actions.
   * 
   * @throws VersionException
   *           on version problems
   */
  protected CategoryMembers(MediaWikiBot bot, String categoryName,
      int[] namespace) throws VersionException {
<span class="nc" id="L82">    super(bot.getVersion());</span>
<span class="nc" id="L83">    this.namespace = namespace.clone();</span>
<span class="nc" id="L84">    namespaceStr = createNsString(namespace);</span>
<span class="nc" id="L85">    this.categoryName = categoryName.replace(&quot; &quot;, &quot;_&quot;);</span>
<span class="nc" id="L86">    this.bot = bot;</span>
<span class="nc" id="L87">    createRequestor();</span>

<span class="nc" id="L89">  }</span>

  private void createRequestor() {

<span class="nc bnc" id="L93" title="All 2 branches missed.">    switch (bot.getVersion()) {</span>
      case MW1_11:
<span class="nc" id="L95">        requestBuilder = new RequestBuilder_1_11();</span>
<span class="nc" id="L96">        break;</span>

      default:
<span class="nc" id="L99">        requestBuilder = new RequestBuilder();</span>
        break;
    }

<span class="nc" id="L103">  }</span>

  /**
   * generates the next MediaWiki-request (GetMethod) and adds it to msgs.
   * 
   * @return a
   */
  protected final Get generateFirstRequest() {

<span class="nc" id="L112">    return new Get(requestBuilder.first(categoryName));</span>
  }

  /**
   * generates the next MediaWiki-request (GetMethod) and adds it to msgs.
   * 
   * 
   * @param cmcontinue
   *          the value for the blcontinue parameter, null for the generation of
   *          the initial request
   * @return a
   */
  protected final Get generateContinueRequest(String cmcontinue) {

    try {

<span class="nc" id="L128">      return new Get(requestBuilder.continiue(cmcontinue));</span>

<span class="nc" id="L130">    } catch (NullPointerException e) {</span>
<span class="nc" id="L131">      e.printStackTrace();</span>
    }
<span class="nc" id="L133">    return null;</span>

  }

  /**
   * deals with the MediaWiki api's response by parsing the provided text.
   * 
   * @param s
   *          the answer to the most recently generated MediaWiki-request
   * 
   * @return empty string
   */
  @Override
  public String processAllReturningText(final String s) throws ProcessException {
<span class="nc" id="L147">    parseArticleTitles(s);</span>
<span class="nc" id="L148">    parseHasMore(s);</span>
<span class="nc" id="L149">    return &quot;&quot;;</span>
  }

  /**
   * gets the information about a follow-up page from a provided api response.
   * If there is one, a new request is added to msgs by calling generateRequest.
   * 
   * @param s
   *          text for parsing
   */
  private void parseHasMore(final String s) {

    // get the blcontinue-value

<span class="nc" id="L163">    Pattern p = Pattern.compile(&quot;&lt;query-continue&gt;.*?&quot;</span>
        + &quot;&lt;categorymembers *cmcontinue=\&quot;([^\&quot;]*)\&quot; */&gt;&quot;
        + &quot;.*?&lt;/query-continue&gt;&quot;, Pattern.DOTALL | Pattern.MULTILINE);

<span class="nc" id="L167">    Matcher m = p.matcher(s);</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">    if (m.find()) {</span>
<span class="nc" id="L170">      nextPageInfo = m.group(1);</span>
<span class="nc" id="L171">      hasMoreResults = true;</span>
    } else {
<span class="nc" id="L173">      hasMoreResults = false;</span>
    }
<span class="nc bnc" id="L175" title="All 2 branches missed.">    if (log.isDebugEnabled())</span>
<span class="nc" id="L176">      log.debug(&quot;has more = &quot; + hasMoreResults);</span>

<span class="nc" id="L178">  }</span>

  /**
   * picks the article name from a MediaWiki api response.
   * 
   * @param s
   *          text for parsing
   */
  private final void parseArticleTitles(String s) {

    // get the backlink titles and add them all to the titleCollection

<span class="nc" id="L190">    Pattern p = Pattern</span>
<span class="nc" id="L191">        .compile(&quot;&lt;cm pageid=\&quot;(.*?)\&quot; ns=\&quot;(.*?)\&quot; title=\&quot;(.*?)\&quot; /&gt;&quot;);</span>

<span class="nc" id="L193">    Matcher m = p.matcher(s);</span>

<span class="nc bnc" id="L195" title="All 2 branches missed.">    while (m.find()) {</span>

<span class="nc" id="L197">      addCatItem(m.group(3), Integer.parseInt(m.group(1)),</span>
<span class="nc" id="L198">          Integer.parseInt(m.group(2)));</span>

    }
<span class="nc" id="L201">    finalizeParse();</span>
<span class="nc" id="L202">  }</span>

  protected abstract void finalizeParse();

  protected abstract void addCatItem(String title, int pageid, int ns);

  protected class RequestBuilder_1_11 extends RequestBuilder {

<span class="nc" id="L210">    RequestBuilder_1_11() {</span>
<span class="nc" id="L211">      super();</span>
<span class="nc" id="L212">    }</span>

    @Override
    String continiue(String cmcontinue) {
<span class="nc" id="L216">      String uS = &quot;&quot;;</span>
<span class="nc" id="L217">      String nsinj = &quot;&quot;;</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">      if (namespaceStr.length() &gt; 0) {</span>
<span class="nc" id="L219">        nsinj = &quot;&amp;cmnamespace=&quot; + MediaWiki.encode(namespaceStr);</span>
      }
<span class="nc" id="L221">      uS = &quot;/api.php?action=query&amp;list=categorymembers&quot; + &quot;&amp;cmcategory=&quot;</span>
<span class="nc" id="L222">          + MediaWiki.encode(categoryName) + nsinj + &quot;&amp;cmcontinue=&quot;</span>
<span class="nc" id="L223">          + MediaWiki.encode(cmcontinue) + &quot;&amp;cmlimit=&quot; + LIMIT + &quot;&amp;format=xml&quot;;</span>
<span class="nc" id="L224">      return uS;</span>
    }

    @Override
    String first(String categoryName) {
<span class="nc" id="L229">      String uS = &quot;&quot;;</span>
<span class="nc" id="L230">      String nsinj = &quot;&quot;;</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">      if (namespaceStr.length() &gt; 0) {</span>
<span class="nc" id="L232">        nsinj = &quot;&amp;cmnamespace=&quot; + MediaWiki.encode(namespaceStr);</span>
      }

<span class="nc" id="L235">      uS = &quot;/api.php?action=query&amp;list=categorymembers&quot; + &quot;&amp;cmcategory=&quot;</span>
<span class="nc" id="L236">          + MediaWiki.encode(categoryName) + nsinj + &quot;&amp;cmlimit=&quot; + LIMIT</span>
          + &quot;&amp;format=xml&quot;;
<span class="nc" id="L238">      return uS;</span>
    }

  }

  protected class RequestBuilder {

<span class="nc" id="L245">    RequestBuilder() {</span>

<span class="nc" id="L247">    }</span>

    String continiue(String cmcontinue) {
<span class="nc" id="L250">      String uS = &quot;&quot;;</span>
<span class="nc" id="L251">      String nsinj = &quot;&quot;;</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">      if (namespaceStr.length() &gt; 0) {</span>
<span class="nc" id="L253">        nsinj = &quot;&amp;cmnamespace=&quot; + MediaWiki.encode(namespaceStr);</span>
      }

      // TODO: do not add Category: - instead, change other methods' descs (e.g.
      // in MediaWikiBot)

<span class="nc" id="L259">      uS = &quot;/api.php?action=query&amp;list=categorymembers&quot; + &quot;&amp;cmtitle=Category:&quot;</span>
<span class="nc" id="L260">          + MediaWiki.encode(categoryName) + nsinj + &quot;&amp;cmcontinue=&quot;</span>
<span class="nc" id="L261">          + MediaWiki.encode(cmcontinue) + &quot;&amp;cmlimit=&quot; + LIMIT + &quot;&amp;format=xml&quot;;</span>
<span class="nc" id="L262">      return uS;</span>
    }

    String first(String categoryName) {
<span class="nc" id="L266">      String uS = &quot;&quot;;</span>
<span class="nc" id="L267">      String nsinj = &quot;&quot;;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">      if (namespaceStr.length() &gt; 0) {</span>
<span class="nc" id="L269">        nsinj = &quot;&amp;cmnamespace=&quot; + MediaWiki.encode(namespaceStr);</span>
      }

      // TODO: do not add Category: - instead, change other methods' descs (e.g.
      // in MediaWikiBot)

<span class="nc" id="L275">      uS = &quot;/api.php?action=query&amp;list=categorymembers&quot; + &quot;&amp;cmtitle=Category:&quot;</span>
<span class="nc" id="L276">          + MediaWiki.encode(categoryName) + nsinj + &quot;&amp;cmlimit=&quot; + LIMIT</span>
          + &quot;&amp;format=xml&quot;;
<span class="nc" id="L278">      return uS;</span>
    }

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>