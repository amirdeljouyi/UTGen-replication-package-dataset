<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpActionClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">23_jwbf</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.jwbf.core.actions</a> &gt; <span class="el_source">HttpActionClient.java</span></div><h1>HttpActionClient.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2007 Thomas Stock.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 * Contributors:
 *
 */

package net.sourceforge.jwbf.core.actions;

import java.io.BufferedReader;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URL;
import java.nio.charset.Charset;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import lombok.extern.slf4j.Slf4j;
import net.sourceforge.jwbf.JWBF;
import net.sourceforge.jwbf.core.actions.util.ActionException;
import net.sourceforge.jwbf.core.actions.util.CookieException;
import net.sourceforge.jwbf.core.actions.util.HttpAction;
import net.sourceforge.jwbf.core.actions.util.ProcessException;

import org.apache.http.HttpHost;
import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.apache.http.StatusLine;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpRequestBase;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.client.params.ClientPNames;
import org.apache.http.cookie.Cookie;
import org.apache.http.entity.mime.MultipartEntity;
import org.apache.http.entity.mime.content.FileBody;
import org.apache.http.entity.mime.content.StringBody;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.params.HttpParams;


/**
 * The main interaction class.
 *
 * @author Thomas Stock
 *
 */
<span class="nc" id="L65">@Slf4j</span>
public class HttpActionClient {

  private HttpClient client;

<span class="nc" id="L70">  private String path = &quot;&quot;;</span>

  private HttpHost host;

  private int prevHash;




  public HttpActionClient(final URL url) {
<span class="nc" id="L80">    this(new DefaultHttpClient(), url);</span>
<span class="nc" id="L81">  }</span>
  /**
   *
   * @param client
   *            a
   * @param url
   *            like &quot;http://host/of/wiki/&quot;
   */
<span class="nc" id="L89">  public HttpActionClient(final HttpClient client, final URL url) {</span>

    /*
     * see for docu
     * http://jakarta.apache.org/commons/httpclient/preference-api.html
     */


<span class="nc bnc" id="L97" title="All 2 branches missed.">    if (url.getPath().length() &gt; 1) {</span>
<span class="nc" id="L98">      path = url.getPath().substring(0, url.getPath().lastIndexOf(&quot;/&quot;));</span>
    }
<span class="nc" id="L100">    client.getParams().setParameter(&quot;http.useragent&quot;,</span>
<span class="nc" id="L101">        &quot;JWBF &quot; + JWBF.getVersion(getClass())); // some wikis (e.g. Wikipedia) need this line</span>
<span class="nc" id="L102">    client.getParams().setParameter(&quot;http.protocol.expect-continue&quot;, Boolean.FALSE); // is good for wikipedia server</span>
<span class="nc" id="L103">    host = new HttpHost(url.getHost(), url.getPort(), url.getProtocol());</span>

<span class="nc" id="L105">    this.client = client;</span>
<span class="nc" id="L106">  }</span>



  /**
   *
   * @param contentProcessable
   *            a
   * @return message, never null
   * @throws ActionException
   *             on problems with http, cookies and io
   * @throws ProcessException on inner problems
   */
  public synchronized String performAction(ContentProcessable contentProcessable)
      throws ActionException, ProcessException {

<span class="nc" id="L122">    String out = &quot;&quot;;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">    while (contentProcessable.hasMoreMessages()) {</span>

<span class="nc" id="L125">      HttpRequestBase httpRequest = null;</span>
      try {

<span class="nc" id="L128">        HttpAction httpAction = contentProcessable.getNextMessage();</span>

        final String request;
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (path.length() &gt; 1) {</span>
<span class="nc" id="L132">          request = path + httpAction.getRequest();</span>
        } else {
<span class="nc" id="L134">          request = httpAction.getRequest();</span>
        }
<span class="nc" id="L136">        log.debug(request);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (httpAction instanceof Get) {</span>
<span class="nc" id="L138">          httpRequest = new HttpGet(request);</span>


<span class="nc" id="L141">          modifyRequestParams(httpRequest, httpAction);</span>

          // do get
<span class="nc" id="L144">          out = get(httpRequest, contentProcessable, httpAction);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        } else if (httpAction instanceof Post) {</span>

<span class="nc" id="L147">          httpRequest = new HttpPost(request);</span>
<span class="nc" id="L148">          modifyRequestParams(httpRequest, httpAction);</span>

          // do post
<span class="nc" id="L151">          out = post(httpRequest, contentProcessable, httpAction);</span>
        }


<span class="nc" id="L155">      } catch (IOException e1) {</span>
<span class="nc" id="L156">        throw new ActionException(e1);</span>
<span class="nc" id="L157">      } catch (IllegalArgumentException e2) {</span>
<span class="nc" id="L158">        e2.printStackTrace();</span>
<span class="nc" id="L159">        throw new ActionException(e2);</span>
<span class="nc" id="L160">      }</span>

<span class="nc" id="L162">    }</span>
<span class="nc" id="L163">    return out;</span>

  }

  private void modifyRequestParams(HttpRequestBase request, HttpAction httpAction) {
<span class="nc" id="L168">    HttpParams params = request.getParams();</span>
<span class="nc" id="L169">    params.setParameter(ClientPNames.DEFAULT_HOST, host);</span>
<span class="nc" id="L170">    params.setParameter(&quot;http.protocol.content-charset&quot;,</span>
<span class="nc" id="L171">        httpAction.getCharset());</span>
<span class="nc" id="L172">  }</span>

  private String post(HttpRequestBase requestBase, ContentProcessable contentProcessable, HttpAction ha)
      throws IOException, CookieException, ProcessException {
<span class="nc" id="L176">    Post p = (Post) ha;</span>
<span class="nc" id="L177">    MultipartEntity entity = new MultipartEntity();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">    for (String key : p.getParams().keySet()) {</span>
<span class="nc" id="L179">      Object content = p.getParams().get(key);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">      if (content != null) {</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (content instanceof String)</span>
<span class="nc" id="L182">          entity.addPart(key, new StringBody((String) content, Charset.forName(p.getCharset())));</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        else if (content instanceof File)</span>
<span class="nc" id="L184">          entity.addPart(key, new FileBody((File) content));</span>
      }
<span class="nc" id="L186">    }</span>
<span class="nc" id="L187">    ((HttpPost) requestBase).setEntity(entity);</span>
<span class="nc" id="L188">    debug(requestBase, ha, contentProcessable);</span>
<span class="nc" id="L189">    HttpResponse res = execute(requestBase);</span>


<span class="nc" id="L192">    ByteArrayOutputStream byte1 = new ByteArrayOutputStream();</span>

<span class="nc" id="L194">    res.getEntity().writeTo(byte1);</span>
<span class="nc" id="L195">    String out = new String(byte1.toByteArray());</span>
<span class="nc" id="L196">    out = contentProcessable.processReturningText(out, ha);</span>

<span class="nc bnc" id="L198" title="All 4 branches missed.">    if (contentProcessable instanceof CookieValidateable &amp;&amp; client instanceof DefaultHttpClient)</span>
<span class="nc" id="L199">      ((CookieValidateable) contentProcessable).validateReturningCookies(cookieTransform(</span>
<span class="nc" id="L200">          ((DefaultHttpClient)client).getCookieStore().getCookies()), ha);</span>
<span class="nc" id="L201">    res.getEntity().consumeContent();</span>

<span class="nc" id="L203">    return out;</span>

  }
  /**
   * Process a GET Message.
   *
   * @param requestBase
   *            a
   * @param cp
   *            a
   * @return a returning message, not null
   * @throws IOException on problems
   * @throws CookieException on problems
   * @throws ProcessException on problems
   */
  private String get(HttpRequestBase requestBase, ContentProcessable cp, HttpAction ha)
      throws IOException, CookieException, ProcessException {
<span class="nc" id="L220">    showCookies();</span>
<span class="nc" id="L221">    debug(requestBase, ha, cp);</span>
<span class="nc" id="L222">    String out = &quot;&quot;;</span>

<span class="nc" id="L224">    HttpResponse res = execute(requestBase);</span>

<span class="nc" id="L226">    StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L227">    BufferedReader br = null;</span>
    try {
<span class="nc" id="L229">      Charset charSet = Charset.forName(ha.getCharset());</span>
      //      Header header = res.getEntity().getContentType();
      //      if (header != null) {
      //        System.out.println(res.getLastHeader(&quot;Content-Encoding&quot;));
      //
      //      }

<span class="nc" id="L236">      br = new BufferedReader(new InputStreamReader(res</span>
<span class="nc" id="L237">          .getEntity().getContent(), charSet));</span>
      String line;
<span class="nc bnc" id="L239" title="All 2 branches missed.">      while ((line = br.readLine()) != null) {</span>
<span class="nc" id="L240">        sb.append(line).append(&quot;\n&quot;);</span>
      }
    } finally {
<span class="nc bnc" id="L243" title="All 2 branches missed.">      if (br != null)</span>
<span class="nc" id="L244">        br.close();</span>
    }

<span class="nc" id="L247">    out = sb.toString();</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">    if (cp != null) {</span>
<span class="nc bnc" id="L249" title="All 4 branches missed.">      if (cp instanceof CookieValidateable</span>
          &amp;&amp; client instanceof DefaultHttpClient)
<span class="nc" id="L251">        ((CookieValidateable) cp).validateReturningCookies(</span>
<span class="nc" id="L252">            cookieTransform(((DefaultHttpClient) client)</span>
<span class="nc" id="L253">                .getCookieStore().getCookies()), ha);</span>
<span class="nc" id="L254">      out = cp.processReturningText(out, ha);</span>
    }
<span class="nc" id="L256">    res.getEntity().consumeContent();</span>
<span class="nc" id="L257">    return out;</span>
  }

  private HttpResponse execute(HttpRequestBase requestBase) throws IOException,
  ClientProtocolException, ProcessException {
<span class="nc" id="L262">    HttpResponse res = client.execute(requestBase);</span>
<span class="nc" id="L263">    StatusLine statusLine = res.getStatusLine();</span>
<span class="nc" id="L264">    int code = statusLine.getStatusCode();</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">    if (code &gt;= HttpStatus.SC_BAD_REQUEST) {</span>
<span class="nc" id="L266">      throw new ProcessException(&quot;invalid status: &quot; + statusLine + &quot;; for &quot; + requestBase.getURI());</span>
    }
<span class="nc" id="L268">    return res;</span>
  }

  /**
   * Process a GET Message.
   * @param get
   *            a
   * @return a returning message, not null
   * @throws IOException on problems
   * @throws CookieException on problems
   * @throws ProcessException on problems
   */
  public byte[] get(Get get)
      throws IOException, CookieException, ProcessException {
<span class="nc" id="L282">    showCookies();</span>
<span class="nc" id="L283">    HttpGet authgets = new HttpGet(get.getRequest());</span>
<span class="nc" id="L284">    return get(authgets, null, get).getBytes();</span>
  }

  private Map&lt;String, String&gt; cookieTransform(List&lt;Cookie&gt; ca) {
<span class="nc" id="L288">    Map&lt;String, String&gt; m = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">    for (Cookie cookie : ca) {</span>
<span class="nc" id="L290">      m.put(cookie.getName(), cookie.getValue());</span>
<span class="nc" id="L291">    }</span>
<span class="nc" id="L292">    return m;</span>
  }
  /**
   * send the cookies to the logger.
   *
   * @param client
   *            a
   *            @deprecated is a bit too chatty
   */
  @Deprecated
  private void showCookies() {
<span class="nc bnc" id="L303" title="All 4 branches missed.">    if (client instanceof DefaultHttpClient  &amp;&amp; log.isDebugEnabled()) {</span>
<span class="nc" id="L304">      List&lt;Cookie&gt; cookies = ((DefaultHttpClient) client).getCookieStore().getCookies();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">      if (cookies.size() &gt; 0) {</span>
<span class="nc" id="L306">        StringBuffer cStr = new StringBuffer();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">        for (Cookie cookie : cookies) {</span>
<span class="nc" id="L308">          cStr.append(cookie.toString() + &quot;, &quot;);</span>
<span class="nc" id="L309">        }</span>
<span class="nc" id="L310">        log.debug(&quot;cookie: {&quot; + cStr + &quot;}&quot;);</span>
      }
    }
<span class="nc" id="L313">  }</span>


  private void debug(HttpUriRequest e, HttpAction ha, ContentProcessable cp) {
<span class="nc bnc" id="L317" title="All 4 branches missed.">    if (log.isDebugEnabled() &amp;&amp; cp != null) {</span>

<span class="nc" id="L319">      String continueing = &quot;&quot;;</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">      if (prevHash == cp.hashCode()) {</span>
<span class="nc" id="L321">        continueing = &quot; [continuing req]&quot;;</span>
      } else {
<span class="nc" id="L323">        continueing = &quot;&quot;;</span>
      }
<span class="nc" id="L325">      prevHash = cp.hashCode();</span>
<span class="nc" id="L326">      String epath = e.getURI().toString();</span>
<span class="nc" id="L327">      int sl = epath.lastIndexOf(&quot;/&quot;);</span>
<span class="nc" id="L328">      epath = epath.substring(0, sl);</span>
<span class="nc" id="L329">      String type = &quot;&quot;;</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">      if (ha instanceof Post) {</span>
<span class="nc" id="L331">        type = &quot;(POST &quot;;</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">      } else if (ha instanceof Get) {</span>
<span class="nc" id="L333">        type = &quot;(GET &quot;;</span>
      }
<span class="nc" id="L335">      type += cp.getClass().getSimpleName() + &quot;)&quot; + continueing;</span>
<span class="nc" id="L336">      log.debug(&quot;message &quot; + type + &quot; is: \n\t own: &quot;</span>
<span class="nc" id="L337">          +  getHostUrl()</span>
<span class="nc" id="L338">          + epath + &quot;\n\t act: &quot; + ha.getRequest());</span>
    }
<span class="nc" id="L340">  }</span>
  /**
   *
   * @return the
   */
  public String getHostUrl() {
<span class="nc" id="L346">    return host.toURI();</span>
  }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>