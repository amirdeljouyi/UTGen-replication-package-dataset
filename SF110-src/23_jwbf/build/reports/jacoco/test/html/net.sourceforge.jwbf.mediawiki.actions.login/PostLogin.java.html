<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostLogin.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">23_jwbf</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.jwbf.mediawiki.actions.login</a> &gt; <span class="el_source">PostLogin.java</span></div><h1>PostLogin.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2007 Thomas Stock.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not
 * use this file except in compliance with the License. You may obtain a copy of
 * the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 * Contributors:
 * Philipp Kohl
 * Carlos Valenzuela
 */
package net.sourceforge.jwbf.mediawiki.actions.login;

import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_11;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_12;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_13;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_14;
import static net.sourceforge.jwbf.mediawiki.actions.MediaWiki.Version.MW1_15;

import java.io.IOException;
import java.io.Reader;
import java.io.StringReader;
import java.util.HashMap;
import java.util.Map;

import lombok.extern.slf4j.Slf4j;
import net.sourceforge.jwbf.core.actions.Post;
import net.sourceforge.jwbf.core.actions.util.ActionException;
import net.sourceforge.jwbf.core.actions.util.HttpAction;
import net.sourceforge.jwbf.core.actions.util.ProcessException;
import net.sourceforge.jwbf.mediawiki.actions.util.MWAction;
import net.sourceforge.jwbf.mediawiki.actions.util.SupportedBy;
import net.sourceforge.jwbf.mediawiki.contentRep.LoginData;

import org.jdom.Document;
import org.jdom.Element;
import org.jdom.JDOMException;
import org.jdom.input.SAXBuilder;
import org.xml.sax.InputSource;

/**
 * 
 * @author Thomas Stock
 */
<span class="nc" id="L53">@Slf4j</span>
@SupportedBy({ MW1_11, MW1_12, MW1_13, MW1_14, MW1_15 })
public class PostLogin extends MWAction {

  private Post msg;

<span class="nc" id="L59">  private final String success = &quot;Success&quot;;</span>
<span class="nc" id="L60">  private final String wrongPass = &quot;WrongPass&quot;;</span>
<span class="nc" id="L61">  private final String notExists = &quot;NotExists&quot;;</span>
<span class="nc" id="L62">  private final String needToken = &quot;NeedToken&quot;;</span>
<span class="nc" id="L63">  private LoginData login = null;</span>
<span class="nc" id="L64">  private boolean reTry = false;</span>
<span class="nc" id="L65">  private boolean reTryLimit = true;</span>
  private final String username;
  private final String pw;
  private final String domain;

  /**
   * 
   * @param username
   *          the
   * @param pw
   *          password
   * @param domain
   *          a
   * @param login
   *          a
   */
  public PostLogin(final String username, final String pw, final String domain,
      LoginData login) {
<span class="nc" id="L83">    super();</span>
<span class="nc" id="L84">    this.login = login;</span>
<span class="nc" id="L85">    this.username = username;</span>
<span class="nc" id="L86">    this.pw = pw;</span>
<span class="nc" id="L87">    this.domain = domain;</span>
<span class="nc" id="L88">    msg = getLoginMsg(username, pw, domain, null);</span>

<span class="nc" id="L90">  }</span>

  private Post getLoginMsg(final String username, final String pw,
      final String domain, final String token) {
<span class="nc" id="L94">    Post pm = new Post(&quot;/api.php?action=login&amp;format=xml&quot;);</span>
<span class="nc" id="L95">    pm.addParam(&quot;lgname&quot;, username);</span>
<span class="nc" id="L96">    pm.addParam(&quot;lgpassword&quot;, pw);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">    if (domain != null)</span>
<span class="nc" id="L98">      pm.addParam(&quot;lgdomain&quot;, domain);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">    if (token != null) {</span>
<span class="nc" id="L100">      pm.addParam(&quot;lgtoken&quot;, token);</span>
    }
<span class="nc" id="L102">    return pm;</span>
  }

  /**
   * {@inheritDoc}
   */
  @Override
  public String processAllReturningText(final String s) throws ProcessException {
<span class="nc" id="L110">    SAXBuilder builder = new SAXBuilder();</span>
<span class="nc" id="L111">    Element root = null;</span>
    try {
<span class="nc" id="L113">      Reader i = new StringReader(s);</span>
<span class="nc" id="L114">      Document doc = builder.build(new InputSource(i));</span>

<span class="nc" id="L116">      root = doc.getRootElement();</span>
<span class="nc" id="L117">      findContent(root);</span>
<span class="nc" id="L118">    } catch (JDOMException e) {</span>
<span class="nc" id="L119">      log.error(e.getClass().getName() + e.getLocalizedMessage());</span>
<span class="nc" id="L120">    } catch (IOException e) {</span>
<span class="nc" id="L121">      log.error(e.getClass().getName() + e.getLocalizedMessage());</span>
<span class="nc" id="L122">    } catch (NullPointerException e) {</span>
<span class="nc" id="L123">      log.error(e.getClass().getName() + e.getLocalizedMessage());</span>
<span class="nc" id="L124">      throw new ProcessException(</span>
          &quot;No regular content was found, check your api\n::&quot; + s);
<span class="nc" id="L126">    } catch (Exception e) {</span>
<span class="nc" id="L127">      log.error(e.getClass().getName() + e.getLocalizedMessage());</span>
<span class="nc" id="L128">      throw new ProcessException(e.getLocalizedMessage());</span>
<span class="nc" id="L129">    }</span>

<span class="nc" id="L131">    return s;</span>
  }

  /**
   * 
   * @param startElement
   *          the, where the search begins
   * @throws ProcessException
   *           if problems with login
   */
  private void findContent(final Element startElement) throws ProcessException {

<span class="nc" id="L143">    Element loginEl = startElement.getChild(&quot;login&quot;);</span>
<span class="nc" id="L144">    String result = loginEl.getAttributeValue(&quot;result&quot;);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (result.equalsIgnoreCase(success)) {</span>
<span class="nc" id="L146">      Map&lt;String, String&gt; properties = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L147">      properties.put(&quot;userId&quot;, loginEl.getAttribute(&quot;lguserid&quot;).toString());</span>
<span class="nc" id="L148">      login.setup(loginEl.getAttributeValue(&quot;lgusername&quot;), true);</span>
<span class="nc bnc" id="L149" title="All 4 branches missed.">    } else if (result.equalsIgnoreCase(needToken) &amp;&amp; reTryLimit) {</span>
<span class="nc" id="L150">      msg = getLoginMsg(username, pw, domain,</span>
<span class="nc" id="L151">          loginEl.getAttributeValue(&quot;token&quot;));</span>
<span class="nc" id="L152">      reTry = true;</span>
<span class="nc" id="L153">      reTryLimit = false;</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">    } else if (result.equalsIgnoreCase(wrongPass)) {</span>
<span class="nc" id="L155">      throw new ProcessException(&quot;Wrong Password&quot;);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">    } else if (result.equalsIgnoreCase(notExists)) {</span>
<span class="nc" id="L157">      throw new ActionException(&quot;No such User&quot;);</span>
    }

<span class="nc" id="L160">  }</span>

  /**
   * {@inheritDoc}
   */
  public HttpAction getNextMessage() {
<span class="nc" id="L166">    return msg;</span>
  }

  /*
   * (non-Javadoc)
   * 
   * @see net.sourceforge.jwbf.mediawiki.actions.util.MWAction#hasMoreMessages()
   */
  @Override
  public boolean hasMoreMessages() {
<span class="nc bnc" id="L176" title="All 4 branches missed.">    boolean temp = super.hasMoreMessages() || reTry;</span>
<span class="nc" id="L177">    reTry = false;</span>
<span class="nc" id="L178">    return temp;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>