<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Request.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">71_ext4j</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.ext4j.taglib.bo</a> &gt; <span class="el_source">Request.java</span></div><h1>Request.java</h1><pre class="source lang-java linenums">/**
 * @author luc
 */
package net.sourceforge.ext4j.taglib.bo;

import java.util.Collection;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Map;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * @author luc
 *
 */
public class Request implements IRequest {

	private static final String FILE_SCHEME = &quot;file:/&quot;;
	private static final String STRING_QMARK = &quot;?&quot;;
	private static final String STRING_HASH = &quot;#&quot;;
	private static final String STRING_AND = &quot;&amp;&quot;;
	private static final String STRING_EQUAL = &quot;=&quot;;
	private static final String STRING_EMPTY = &quot;&quot;;
	
<span class="fc" id="L30">	private Map&lt;String, RequestParam&gt; mParams = new Hashtable&lt;String, RequestParam&gt;();</span>
<span class="fc" id="L31">	private boolean mIsWebRequest = false;</span>
	private String mBaseURL;
	private String mHashValue; // string after the hash (#) sign
<span class="fc" id="L34">	private boolean mNoEmptyParams = false;</span>
<span class="fc" id="L35">	private Log mLogger = LogFactory.getLog(Request.class);</span>
	
	/**
	 * 
	 */
	public Request() {
<span class="fc" id="L41">		this( (String) null, false);</span>
<span class="fc" id="L42">	}</span>
	
	public Request(boolean pNoEmptyParams) {
<span class="fc" id="L45">		this((String) null, pNoEmptyParams);</span>
<span class="fc" id="L46">	}</span>
	
	public Request(HttpServletRequest pRequest) {
<span class="fc" id="L49">		this(pRequest, false);</span>
<span class="fc" id="L50">	}</span>
	
	public Request(HttpServletRequest pOrig, boolean pNoEmptyParams) {
<span class="pc bpc" id="L53" title="3 of 4 branches missed.">		this((pOrig!=null)?pOrig.getRequestURL().toString() + ((pOrig.getQueryString() != null)?STRING_QMARK+pOrig.getQueryString():STRING_EMPTY):null, pNoEmptyParams);</span>
<span class="fc" id="L54">	}</span>
	
	public Request(String pUrl) {
<span class="fc" id="L57">		this(pUrl, false);</span>
<span class="fc" id="L58">	}</span>
<span class="fc" id="L59">	public Request(String pUrl, boolean pNoEmptyParams) {</span>
<span class="fc" id="L60">		mNoEmptyParams = pNoEmptyParams;</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">		if (pUrl != null) parse(pUrl);</span>
<span class="fc" id="L62">	}</span>
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#cleanEmptyParams()
	 */
	public IRequest cleanEmptyParams() {
<span class="fc" id="L68">		RequestParam oParam = null;</span>
<span class="fc" id="L69">		Set&lt;String&gt; oKeys = new HashSet&lt;String&gt;();</span>
<span class="fc" id="L70">		oKeys.addAll(mParams.keySet());</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">		for (String oName : oKeys) {</span>
<span class="fc" id="L72">			oParam = mParams.get(oName);</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">			if (oParam.getTotalValues() == 0) {</span>
<span class="fc" id="L74">				mParams.remove(oName);</span>
<span class="fc" id="L75">				continue;</span>
			}
<span class="fc" id="L77">			boolean oEmpty = false;</span>
<span class="fc bfc" id="L78" title="All 4 branches covered.">			for (int i = 0; i &lt; oParam.getTotalValues() &amp;&amp; !oEmpty; i++) {</span>
<span class="fc bfc" id="L79" title="All 4 branches covered.">				oEmpty = ((oParam.getValue(i) == null) || (oParam.getValue(i).trim().length() == 0));</span>
			}
<span class="fc bfc" id="L81" title="All 2 branches covered.">			if (oEmpty) mParams.remove(oName);</span>
<span class="fc" id="L82">		}</span>
<span class="fc" id="L83">		return this;</span>
	}

	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#getBaseURL()
	 */
	public String getBaseURL() {
<span class="fc" id="L90">		return mBaseURL;</span>
	}

	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#setBaseURL(java.lang.String)
	 */
	public IRequest setBaseURL(String pBaseURL) {
<span class="fc" id="L97">		mBaseURL = pBaseURL;</span>
<span class="fc" id="L98">		return this;</span>
	}

	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#isWebRequest()
	 */
	public boolean isWebRequest() {
<span class="fc" id="L105">		return mIsWebRequest;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#getParams()
	 */
	public Collection&lt;RequestParam&gt; getParams() {
<span class="fc" id="L112">		return mParams.values();</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#getParam(java.lang.String)
	 */
	public RequestParam getParam(String pName) {
<span class="fc" id="L119">		return getParam(pName, true);</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#getParam(java.lang.String, boolean)
	 */
	public RequestParam getParam(String pName, boolean pIgnoreCase) {
<span class="fc bfc" id="L126" title="All 2 branches covered.">		if (pName == null) return null;</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">		if (!pIgnoreCase) {</span>
<span class="nc" id="L128">			return mParams.get(pName);</span>
		}
<span class="fc" id="L130">		RequestParam oResult = null;</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">		for (String oKey : mParams.keySet()) {</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">			if (pName.equalsIgnoreCase(oKey)) {</span>
<span class="fc" id="L133">				oResult = mParams.get(oKey);</span>
<span class="fc" id="L134">				break;</span>
			}
<span class="fc" id="L136">		}</span>
<span class="fc" id="L137">		return oResult;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#toBaseURL()
	 */
	public IRequest toBaseURL() {
<span class="fc" id="L144">		mParams = new Hashtable&lt;String, RequestParam&gt;();</span>
<span class="fc" id="L145">		return this;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#getValue(java.lang.String, java.lang.String)
	 */
	public String getValue(String pName, String pDefault) {
<span class="fc bfc" id="L152" title="All 2 branches covered.">		if (mParams.size() == 0) return pDefault;</span>
<span class="fc" id="L153">		String oResult = pDefault;</span>
<span class="fc" id="L154">		RequestParam oParam = getParam(pName, true);</span>
<span class="fc bfc" id="L155" title="All 4 branches covered.">		if (oParam != null &amp;&amp; oParam.getTotalValues() &gt; 0) oResult = oParam.getValue(0);</span>
<span class="fc" id="L156">		return URLDecode(oResult);</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#getValue(java.lang.String, int)
	 */
	public int getValue(String pName, int pDefault) {
<span class="fc bfc" id="L163" title="All 2 branches covered.">		if (mParams.size() == 0) return pDefault;</span>
<span class="fc" id="L164">		int oResult = pDefault;</span>
<span class="fc" id="L165">		RequestParam oParam = getParam(pName, true);</span>
<span class="fc bfc" id="L166" title="All 4 branches covered.">		if (oParam != null &amp;&amp; oParam.getTotalValues() &gt; 0) oResult = oParam.getValue(0, pDefault);</span>
<span class="fc" id="L167">		return oResult;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#getHashValue()
	 */
	public String getHashValue() {
<span class="fc" id="L174">		return mHashValue;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#setHashValue(java.lang.String)
	 */
	public Request setHashValue(String pValue) {
<span class="fc" id="L181">		mHashValue = pValue;</span>
<span class="fc" id="L182">		return this;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#removeParam(java.lang.String)
	 */
	public IRequest removeParam(String pName) {
<span class="fc bfc" id="L189" title="All 2 branches covered.">		if (mParams.size() &gt; 0) {</span>
<span class="fc" id="L190">			RequestParam oParam = getParam(pName, true);</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">			if (oParam != null) mParams.remove(oParam.getName());</span>
		}
<span class="fc" id="L193">		return this;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#addParam(java.lang.String, java.lang.String)
	 */
	public IRequest addParam(String pName, String pValue) {
<span class="fc" id="L200">		RequestParam oParam = getParam(pName, true);</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">		if (oParam == null) {</span>
<span class="fc" id="L202">			oParam = new RequestParam(pName);</span>
<span class="fc" id="L203">			mParams.put(pName, oParam);</span>
		}
<span class="fc" id="L205">		oParam.addValue(URLEncode(pValue));</span>
<span class="fc" id="L206">		return this;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#setParam(java.lang.String, java.lang.String)
	 */
	public IRequest setParam(String pName, String pValue) {
<span class="fc" id="L213">		RequestParam oParam = new RequestParam(pName);</span>
<span class="fc" id="L214">		oParam.addValue(URLEncode(pValue));</span>
<span class="fc" id="L215">		return setParam(oParam);</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#setParam(com.tripfilms.webtool.businessobject.Request.RequestParam)
	 */
	public IRequest setParam(RequestParam pParam) {
<span class="fc bfc" id="L222" title="All 2 branches covered.">		if (pParam == null) return this;</span>
<span class="fc" id="L223">		mParams.put(pParam.getName(), pParam);</span>
<span class="fc" id="L224">		return this;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#getQueryString()
	 */
	public String getQueryString() {
<span class="fc" id="L231">		StringBuilder oQS = new StringBuilder();</span>
<span class="fc" id="L232">		RequestParam oParam = null;</span>
<span class="fc" id="L233">		boolean oFirstPass = true;</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">		for (String oName : mParams.keySet()) {</span>
<span class="fc" id="L235">			oParam = mParams.get(oName);</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">			for (int i = 0; i &lt; oParam.getTotalValues(); i++) {</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">				if (oFirstPass) {</span>
<span class="fc" id="L238">					oQS.append(STRING_QMARK);</span>
				} else {
<span class="fc" id="L240">					oQS.append(STRING_AND);</span>
				}
<span class="fc" id="L242">				oFirstPass = false;</span>
<span class="fc" id="L243">				oQS.append(oParam.getName() + STRING_EQUAL + oParam.getValue(i));</span>
			}
<span class="fc" id="L245">		}</span>
<span class="fc" id="L246">		return oQS.toString();</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#toString()
	 */
	@Override
	public String toString() {
<span class="fc bfc" id="L254" title="All 2 branches covered.">		return getBaseURL() + getQueryString() + ((mHashValue != null)?STRING_HASH + mHashValue:STRING_EMPTY);</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#equals(java.lang.Object)
	 */
	@Override
	public boolean equals(Object pObj) {
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">		if (!(pObj instanceof Request)) return false;</span>
<span class="fc" id="L263">		IRequest oComparedTo = (IRequest) pObj;</span>
	 	// check if same base url
<span class="pc bpc" id="L265" title="1 of 10 branches missed.">		if ((mBaseURL != null &amp;&amp; oComparedTo.getBaseURL() == null) || (mBaseURL == null &amp;&amp; oComparedTo.getBaseURL() != null) || (!mBaseURL.equalsIgnoreCase(oComparedTo.getBaseURL()))) return false;</span>
<span class="fc" id="L266">		Collection&lt;RequestParam&gt; oParams = oComparedTo.getParams();</span>
		// check if same number of params
<span class="fc bfc" id="L268" title="All 2 branches covered.">		if (oParams.size() != getParams().size()) return false;</span>
		// check each parameter
<span class="fc bfc" id="L270" title="All 2 branches covered.">		for (RequestParam oParam : oParams) {</span>
<span class="fc" id="L271">			RequestParam oMyParam = getParam(oParam.getName(), true);</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">			if (oMyParam == null) return false;</span>
			// check number of values
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">			if (oMyParam.getTotalValues() != oParam.getTotalValues()) return false;</span>
			// check values
<span class="fc bfc" id="L276" title="All 2 branches covered.">			for (int i = 0; i &lt; oMyParam.getTotalValues(); i++) {</span>
<span class="fc" id="L277">				String oMyVal = oMyParam.getValue(i);</span>
<span class="fc" id="L278">				boolean oFound = false;</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">				for (int j = 0; j &lt; oParam.getTotalValues(); j++) {</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">					if (oParam.getValue(j).equals(oMyVal)) {</span>
<span class="fc" id="L281">						oFound = true;</span>
<span class="fc" id="L282">						break;</span>
					}
				}
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">				if (!oFound) return false;</span>
			}
<span class="fc" id="L287">		}</span>
<span class="pc bpc" id="L288" title="1 of 6 branches missed.">		if (!(mHashValue == null &amp;&amp; oComparedTo.getHashValue() == null) &amp;&amp; !(mHashValue.equals(oComparedTo.getHashValue()))) return false;</span>
<span class="fc" id="L289">		return true;</span>
	}
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#hashCode()
	 */
	@Override
	public int hashCode() {
<span class="fc" id="L297">		return toString().hashCode();</span>
	}
	
	protected void parse(String pUrl) {
<span class="fc bfc" id="L301" title="All 2 branches covered.">		if (pUrl == null) return;</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">		if (pUrl.startsWith(FILE_SCHEME)) {</span>
<span class="fc" id="L303">			return;</span>
		} else {
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">			if (mLogger.isDebugEnabled()) mLogger.debug(&quot;Url \&quot;&quot; + pUrl +&quot;\&quot; is a web request&quot;);</span>
<span class="fc" id="L306">			mIsWebRequest = true;</span>
		}
		// Process &quot;#&quot; anchor
<span class="fc" id="L309">		String oUrl = pUrl;</span>
<span class="fc" id="L310">		int oHashIndex = oUrl.indexOf(STRING_HASH); </span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">		if (oHashIndex &gt; 0) {</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">			if (oHashIndex &lt; oUrl.length()) {</span>
<span class="fc" id="L313">				mHashValue = oUrl.substring(oHashIndex + 1);</span>
			}
<span class="fc" id="L315">			oUrl = oUrl.substring(0, oHashIndex);</span>
		}
<span class="fc" id="L317">		mBaseURL = oUrl;</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">		if (oUrl.indexOf(STRING_QMARK) &lt; 0) return; // no query string to parse</span>
		
		// Parsing query string
<span class="fc" id="L321">		mBaseURL = oUrl.substring(0, oUrl.indexOf(STRING_QMARK));</span>
<span class="fc" id="L322">		String oQueryString = oUrl.substring(oUrl.indexOf(STRING_QMARK) + 1).trim();</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">		if (oQueryString.length() == 0) return;</span>
<span class="fc" id="L324">		String[] oPairs = oQueryString.split(STRING_AND);</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">		for (String oName : oPairs) {</span>
<span class="fc" id="L326">			String[] oParam = oName.split(STRING_EQUAL);</span>
<span class="pc bpc" id="L327" title="2 of 4 branches missed.">			if (oParam == null || oParam.length == 0) continue; // case: ?&amp;from=1</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">			if (mLogger.isDebugEnabled()) mLogger.debug(&quot;Param/Value found for pair \&quot;&quot; + oName + &quot;\&quot; = &quot; + oParam.length);</span>
			// avoid adding empty params
<span class="fc bfc" id="L330" title="All 4 branches covered.">			if (oParam.length == 1 &amp;&amp; mNoEmptyParams) continue;</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">			String oEncodedValue = ((oParam.length == 2)?URLEncode(oParam[1]):STRING_EMPTY);</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">			if (mLogger.isDebugEnabled()) mLogger.debug(&quot;Adding param \&quot;&quot; + oParam[0] + &quot;\&quot; with value \&quot;&quot; + oEncodedValue + &quot;\&quot;.&quot;);</span>
<span class="fc" id="L333">			addParam(oParam[0], oEncodedValue);</span>
		}
<span class="fc" id="L335">	}</span>
	
	protected String URLEncode(String pValue) {
<span class="fc bfc" id="L338" title="All 2 branches covered.">		if (pValue == null) return pValue;</span>
<span class="fc" id="L339">		String oResult = pValue;</span>
		try {
			// Problem with the following: it will encode something already encoded
			//oResult = URLEncoder.encode(pValue, &quot;UTF-8&quot;);
			// New Version: encode manually the special characters
<span class="fc" id="L344">			oResult = pValue.replaceAll(&quot;&amp;&quot;, &quot;%26&quot;).replaceAll(&quot;\\?&quot;, &quot;%3F&quot;).replaceAll(&quot;#&quot;, &quot;%23&quot;).replaceAll(&quot;=&quot;, &quot;%3D&quot;).replaceAll(&quot;\\s&quot;, &quot;+&quot;);</span>
<span class="nc" id="L345">		} catch (Exception e) {</span>
<span class="nc" id="L346">			mLogger.fatal(&quot;Could not encode \&quot;&quot; + pValue + &quot;\&quot;.&quot;, e);</span>
<span class="fc" id="L347">		}</span>
<span class="fc" id="L348">		return oResult;</span>
	}
	
	protected String URLDecode(String pValue) {
<span class="fc bfc" id="L352" title="All 2 branches covered.">		if (pValue == null) return pValue;</span>
<span class="fc" id="L353">		String oResult = pValue;</span>
		try {
<span class="fc" id="L355">			oResult = pValue.replaceAll(&quot;%26&quot;, &quot;&amp;&quot;).replaceAll(&quot;%3F&quot;, &quot;\\?&quot;).replaceAll(&quot;%23&quot;, &quot;#&quot;).replaceAll(&quot;%3D&quot;, &quot;=&quot;).replaceAll(&quot;\\+&quot;, &quot; &quot;);</span>
<span class="nc" id="L356">		} catch (Exception e) {</span>
<span class="nc" id="L357">			mLogger.fatal(&quot;Could not decode \&quot;&quot; + pValue + &quot;\&quot;.&quot;, e);</span>
<span class="fc" id="L358">		}</span>
<span class="fc" id="L359">		return oResult;</span>
	}	
	
	/* (non-Javadoc)
	 * @see com.tripfilms.webtool.businessobject.IRequest#clone()
	 */
	@Override
	public IRequest clone() {
<span class="fc" id="L367">		IRequest oClone = new Request(getBaseURL() + getQueryString());</span>
<span class="fc" id="L368">		return oClone;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>