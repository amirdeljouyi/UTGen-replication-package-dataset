<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PaginationTag.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">71_ext4j</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.ext4j.taglib.tag</a> &gt; <span class="el_source">PaginationTag.java</span></div><h1>PaginationTag.java</h1><pre class="source lang-java linenums">/**
 *
 */
package net.sourceforge.ext4j.taglib.tag;

import java.io.IOException;

import javax.servlet.jsp.JspException;
import javax.servlet.jsp.JspWriter;
import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Marshaller;
import javax.xml.transform.Result;
import javax.xml.transform.Source;
import javax.xml.transform.Templates;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.TransformerFactoryConfigurationError;
import javax.xml.transform.sax.SAXTransformerFactory;
import javax.xml.transform.sax.TransformerHandler;
import javax.xml.transform.stream.StreamResult;
import javax.xml.transform.stream.StreamSource;

import net.sourceforge.ext4j.taglib.bo.DefaultResourceLoader;
import net.sourceforge.ext4j.taglib.bo.TagUtil;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.tripfilms.os.exttaglib.pagination.datatype.Page;
import com.tripfilms.os.exttaglib.pagination.datatype.Pages;
import com.tripfilms.os.exttaglib.pagination.datatype.Pagination;
import com.tripfilms.os.exttaglib.pagination.datatype.StaticPage;

/**
 * @author Luc Pezet &lt;lpezet@gmail.com&gt;
 *
 */
<span class="nc" id="L39">public class PaginationTag extends BaseSingleBox {</span>

	private static final String DEFAULT_XSL = &quot;classpath:/net/sourceforge/ext4j/taglib/simple_pagination.xsl&quot;;
	private static final long serialVersionUID = 4722503210539035774L;
	private static final String EQUALS = &quot;=&quot;;
	private static final String AMPERSAND = &quot;&amp;&quot;;
	private static final String QUESTION_MARK = &quot;?&quot;;
	private static final String DEFAULT_FROM_PARAM_NAME = &quot;from&quot;;
	private static final String DEFAULT_TO_PARAM_NAME = &quot;to&quot;;

	private int mFrom;
	private int mTotal;
	private int mByPage;
	private int mPages;
	private String mUrl;
<span class="nc" id="L54">	private String mFromParamName = DEFAULT_FROM_PARAM_NAME;</span>
<span class="nc" id="L55">	private String mToParamName = DEFAULT_TO_PARAM_NAME;</span>
<span class="nc" id="L56">	private boolean mUseFromToOnFirstPage = false;</span>
<span class="nc" id="L57">	private Log mLogger = LogFactory.getLog(PaginationTag.class);</span>

	private static JAXBContext mJAXBContext;
	private static Templates mTemplate;

	static {
		try {
<span class="nc" id="L64">			mJAXBContext = JAXBContext.newInstance(&quot;com.tripfilms.os.exttaglib.pagination.datatype&quot;);</span>
<span class="nc" id="L65">		} catch (JAXBException e) {</span>
<span class="nc" id="L66">			throw new RuntimeException(&quot;Error initializing JAXB for PaginationTag.&quot;, e);</span>
<span class="nc" id="L67">		}</span>
		try {
<span class="nc" id="L69">			mTemplate = loadTemplate(DEFAULT_XSL);</span>
<span class="nc" id="L70">		} catch (Exception e) {</span>
<span class="nc" id="L71">			throw new RuntimeException(&quot;Error loading XSL for PaginationTag.&quot;, e);</span>
<span class="nc" id="L72">		}</span>
<span class="nc" id="L73">	}</span>

	/*
	 * (non-Javadoc)
	 *
	 * @see
	 * com.tripfilms.os.exttaglib.BaseSingleBox#renderTag(javax.servlet.jsp.
	 * JspWriter)
	 */
	@Override
	public void renderTag(JspWriter pOut) throws JspException, IOException {
<span class="nc" id="L84">		Pagination oPagination = getPagination();</span>
		try {
<span class="nc" id="L86">			Marshaller oMarshaller = mJAXBContext.createMarshaller();</span>
<span class="nc" id="L87">			TransformerFactory oTxFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L88">			Result oResult = new StreamResult(pOut);</span>
<span class="nc" id="L89">			TransformerHandler oHandler = ((SAXTransformerFactory) oTxFactory).newTransformerHandler(mTemplate);</span>
<span class="nc" id="L90">			oHandler.setResult(oResult);</span>

<span class="nc" id="L92">			oMarshaller.marshal(oPagination, oHandler);</span>
<span class="nc" id="L93">		} catch (JAXBException e) {</span>
<span class="nc" id="L94">			mLogger.fatal(&quot;Error initializing JAXBContext to create Pagination XML.&quot;, e);</span>
<span class="nc" id="L95">			throw new JspException(e);</span>
<span class="nc" id="L96">		} catch (TransformerConfigurationException e) {</span>
<span class="nc" id="L97">			mLogger.fatal(&quot;Error with SAX.&quot;, e);</span>
<span class="nc" id="L98">			throw new JspException(e);</span>
<span class="nc" id="L99">		} catch (Exception e) {</span>
<span class="nc" id="L100">			mLogger.fatal(&quot;Unexpected error.&quot;, e);</span>
<span class="nc" id="L101">			throw new JspException(e);</span>
<span class="nc" id="L102">		}</span>
<span class="nc" id="L103">	}</span>

	/**
	 * Helper to set XSL template to a different one than the default one.
	 * WARNING: This will set the XSL template for all PaginationTag (static).
	 *
	 * @param pTemplateLocation
	 */
	public void setTemplate(String pTemplateLocation) throws Exception {
<span class="nc" id="L112">		Templates oNewTemplate = null;</span>
		try {
<span class="nc" id="L114">			oNewTemplate = loadTemplate(pTemplateLocation);</span>
<span class="nc" id="L115">		} catch (Exception e) {</span>
<span class="nc" id="L116">			throw new RuntimeException(e);</span>
<span class="nc" id="L117">		}</span>
<span class="nc" id="L118">		mTemplate = oNewTemplate;</span>
<span class="nc" id="L119">	}</span>

	private static Templates loadTemplate(String pTemplateLocation) throws TransformerFactoryConfigurationError, TransformerConfigurationException {
<span class="nc" id="L122">		TransformerFactory oTxFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L123">		DefaultResourceLoader oResourceLoader = new DefaultResourceLoader();</span>
<span class="nc" id="L124">		Source oSource = new StreamSource(</span>
<span class="nc" id="L125">			oResourceLoader.getResource(pTemplateLocation).toExternalForm()</span>
		);
<span class="nc" id="L127">	    return oTxFactory.newTemplates(oSource);</span>
	}

	public Pagination getPagination() throws JspException {
<span class="nc" id="L131">		Pagination oResult = new Pagination();</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">		if (mTotal &lt;= 0)</span>
<span class="nc" id="L133">			return oResult;</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">		if (mByPage &lt; 1)</span>
<span class="nc" id="L135">			mByPage = 10;</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">		if (mFrom &gt; mTotal) // then we consider it's the last page</span>
<span class="nc" id="L137">			mFrom = mTotal - 1;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">		if (mFrom &lt; 1)</span>
<span class="nc" id="L139">			mFrom = 1;</span>

<span class="nc" id="L141">		int oNbPages = mTotal / mByPage;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (mTotal % mByPage &gt; 0) // if any reminder...</span>
<span class="nc" id="L143">			oNbPages++; // ...we'll include them in an extra page</span>

		// number of pages to display
<span class="nc bnc" id="L146" title="All 2 branches missed.">		if (oNbPages &lt; mPages) {</span>
<span class="nc" id="L147">			mPages = oNbPages;</span>
		}
<span class="nc" id="L149">		oResult.setTotalPages(oNbPages);</span>

<span class="nc" id="L151">		int oCurrentPage = (mFrom - 1) / mByPage + 1;</span>
<span class="nc" id="L152">		oResult.setCurrentPage(oCurrentPage);</span>

		// first page to display in the list
<span class="nc" id="L155">		int oFirstLink = oCurrentPage - (mPages / 2);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (oFirstLink &lt; 1)</span>
<span class="nc" id="L157">			oFirstLink = 1;</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">		if (oCurrentPage &gt; oNbPages - (mPages / 2))</span>
<span class="nc" id="L159">			oFirstLink = oNbPages - mPages + 1;</span>

<span class="nc" id="L161">		String oLink = null;</span>
		// First &amp; Prev
<span class="nc" id="L163">		oLink = addFromTo(mUrl, 1, mByPage);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">		if (oCurrentPage &gt; 1) {</span>
<span class="nc" id="L165">			oResult.setFirstPage(newStaticPage(oLink));</span>
<span class="nc" id="L166">			oLink = addFromTo(mUrl, mByPage * (oCurrentPage - 1 - 1) + 1,</span>
					mByPage * (oCurrentPage - 1));
<span class="nc" id="L168">			oResult.setPreviousPage(newStaticPage(oLink));</span>
		}

		// Pages
<span class="nc" id="L172">		oResult.setPages(new Pages());</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">		for (int i = oFirstLink; i &lt; (oFirstLink + mPages); i++) {</span>
<span class="nc" id="L174">			oLink = addFromTo(mUrl, i * mByPage - mByPage + 1, i * mByPage);</span>
<span class="nc" id="L175">			oResult.getPages().getPage().add(newPage(i, oLink));</span>
		}

		// Next &amp; Last
<span class="nc bnc" id="L179" title="All 2 branches missed.">		if (oCurrentPage &lt; oNbPages) {</span>
<span class="nc" id="L180">			oLink = addFromTo(mUrl, mByPage * (oCurrentPage + 1 - 1) + 1,</span>
					mByPage * (oCurrentPage + 1));
<span class="nc" id="L182">			oResult.setNextPage(newStaticPage(oLink));</span>
<span class="nc" id="L183">			oLink = addFromTo(mUrl, (oNbPages - 1) * mByPage + 1, mByPage</span>
					* oNbPages);
<span class="nc" id="L185">			oResult.setLastPage(newStaticPage(oLink));</span>
		}

<span class="nc" id="L188">		return oResult;</span>
	}

	private Page newPage(int pNumber, String pLink) throws JspException {
<span class="nc" id="L192">		Page oResult = new Page();</span>
<span class="nc" id="L193">		oResult.setN(pNumber);</span>
<span class="nc" id="L194">		oResult.setUrl(TagUtil.rewriteURL(pLink, pageContext));</span>
<span class="nc" id="L195">		return oResult;</span>
	}

	private StaticPage newStaticPage(String pLink) throws JspException {
<span class="nc" id="L199">		StaticPage oResult = new StaticPage();</span>
<span class="nc" id="L200">		oResult.setUrl(TagUtil.rewriteURL(pLink, pageContext));</span>
<span class="nc" id="L201">		return oResult;</span>
	}

	private String addFromTo(String pURL, int pFrom, int pTo) {
<span class="nc" id="L205">		String oResult = pURL;</span>
<span class="nc bnc" id="L206" title="All 4 branches missed.">		if (pFrom &lt;= 1 &amp;&amp; !mUseFromToOnFirstPage)</span>
<span class="nc" id="L207">			return oResult;</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">		if (oResult.indexOf(QUESTION_MARK) &lt; 0)</span>
<span class="nc" id="L209">			oResult += QUESTION_MARK;</span>
<span class="nc" id="L210">		oResult += AMPERSAND + mFromParamName + EQUALS + pFrom + AMPERSAND</span>
				+ mToParamName + EQUALS + pTo;
<span class="nc" id="L212">		return oResult;</span>
	}

	public int getFrom() {
<span class="nc" id="L216">		return mFrom;</span>
	}

	public void setFrom(int pFrom) {
<span class="nc" id="L220">		mFrom = pFrom;</span>
<span class="nc" id="L221">	}</span>

	public int getTotal() {
<span class="nc" id="L224">		return mTotal;</span>
	}

	public void setTotal(int pTotal) {
<span class="nc" id="L228">		mTotal = pTotal;</span>
<span class="nc" id="L229">	}</span>

	public int getByPage() {
<span class="nc" id="L232">		return mByPage;</span>
	}

	public void setByPage(int pByPage) {
<span class="nc" id="L236">		mByPage = pByPage;</span>
<span class="nc" id="L237">	}</span>

	public int getPages() {
<span class="nc" id="L240">		return mPages;</span>
	}

	public void setPages(int pPages) {
<span class="nc" id="L244">		mPages = pPages;</span>
<span class="nc" id="L245">	}</span>

	public String getUrl() {
<span class="nc" id="L248">		return mUrl;</span>
	}

	public void setUrl(String pUrl) {
<span class="nc" id="L252">		mUrl = pUrl;</span>
<span class="nc" id="L253">	}</span>

	public String getFromParamName() {
<span class="nc" id="L256">		return mFromParamName;</span>
	}

	public void setFromParamName(String pFromParamName) {
<span class="nc" id="L260">		mFromParamName = pFromParamName;</span>
<span class="nc" id="L261">	}</span>

	public String getToParamName() {
<span class="nc" id="L264">		return mToParamName;</span>
	}

	public void setToParamName(String pToParamName) {
<span class="nc" id="L268">		mToParamName = pToParamName;</span>
<span class="nc" id="L269">	}</span>

	public boolean isUseFromToOnFirstPage() {
<span class="nc" id="L272">		return mUseFromToOnFirstPage;</span>
	}

	public void setUseFromToOnFirstPage(boolean pUseFromToOnFirstPage) {
<span class="nc" id="L276">		mUseFromToOnFirstPage = pUseFromToOnFirstPage;</span>
<span class="nc" id="L277">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>