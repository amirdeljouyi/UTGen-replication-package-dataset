<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JipRun.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">51_jiprof</a> &gt; <a href="index.source.html" class="el_package">com.tivo.jipviewer</a> &gt; <span class="el_source">JipRun.java</span></div><h1>JipRun.java</h1><pre class="source lang-java linenums">/*/////////////////////////////////////////////////////////////////////

Copyright (C) 2006 TiVo Inc.  All rights reserved.

Redistribution and use in source and binary forms, with or without 
modification, are permitted provided that the following conditions are met:

+ Redistributions of source code must retain the above copyright notice, 
  this list of conditions and the following disclaimer.
+ Redistributions in binary form must reproduce the above copyright notice, 
  this list of conditions and the following disclaimer in the documentation 
  and/or other materials provided with the distribution.
+ Neither the name of TiVo Inc nor the names of its contributors may be 
  used to endorse or promote products derived from this software without 
  specific prior written permission.

  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; 
  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE 
  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE 
  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE 
  POSSIBILITY OF SUCH DAMAGE.

/////////////////////////////////////////////////////////////////////*/

package com.tivo.jipviewer;

import java.util.Collections;
import java.util.Comparator;
import java.util.Map;
import java.util.Set;
import java.util.HashMap;
import java.util.TreeMap;
import java.util.HashSet;
import java.util.ArrayList;
import java.util.List;

<span class="nc" id="L43">class JipRun implements IJipParseHandler {</span>
    private String mDate;

    // current thread, or 0 if none...
    private long mCurThreadId;

    // maps threadId (as Long) to List&lt;JipFrame&gt;
<span class="nc" id="L50">    private Map&lt;Long, List&lt;JipFrame&gt;&gt; mThreads =</span>
        new HashMap&lt;Long, List&lt;JipFrame&gt;&gt;();

    // current interaction id or 0.
    private long mCurInteractionId;

    // current frame or null
    private JipFrame mCurFrame;

    // from each short class name to the full class name
<span class="nc" id="L60">    private Map&lt;String, String&gt; mFullClassNames = new TreeMap();</span>

    // maps from a method to the PerMethodInfo for it.
<span class="nc" id="L63">    private Map&lt;JipMethod, PerMethodInfo&gt; mPerMethods =</span>
        new HashMap&lt;JipMethod, PerMethodInfo&gt;();

    public void setDate(String date) {
<span class="nc bnc" id="L67" title="All 2 branches missed.">        if (mDate != null) {</span>
<span class="nc" id="L68">            throw new RuntimeException(&quot;already set date! (&quot; + mDate + &quot;)&quot;);</span>
        }
<span class="nc" id="L70">        mDate = date;</span>
<span class="nc" id="L71">    }</span>
    
    public void startThread(long threadId) {
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (mCurThreadId != 0) {</span>
<span class="nc" id="L75">            throw new RuntimeException(&quot;already in thread &quot; + mCurThreadId);</span>
        }
<span class="nc" id="L77">        mCurThreadId = threadId;</span>
<span class="nc" id="L78">    }</span>

    public void endThread() {
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (mCurThreadId == 0) {</span>
<span class="nc" id="L82">            throw new RuntimeException(&quot;there's no thread to end!&quot;);</span>
        }
<span class="nc" id="L84">        mCurThreadId = 0;</span>
<span class="nc" id="L85">    }</span>

    public void startInteraction(long id) {
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (mCurInteractionId != 0) {</span>
<span class="nc" id="L89">            throw new RuntimeException(&quot;already in interaction &quot; +</span>
                                       mCurInteractionId);
        }
<span class="nc" id="L92">        mCurInteractionId = id;</span>
<span class="nc" id="L93">    }</span>


    public void endInteraction() {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (mCurInteractionId == 0) {</span>
<span class="nc" id="L98">            throw new RuntimeException(&quot;there's no interaction to end!&quot;);</span>
        }
<span class="nc" id="L100">        mCurInteractionId = 0;</span>
<span class="nc" id="L101">    }</span>

    public void startFrame(String className,
                           String methodName,
                           long count,
                           long time) {

        //System.out.println(&quot;startFrame(&quot; + className + &quot;, &quot; +
                           //methodName + &quot;, &quot; + count + &quot;, &quot; + time);

        /*
         * NOTE: I'm basically ignoring className because I don't really
         *       see the usefulness of the split between className and
         *       methodName in profile.xml.  If we're gonna use the classMap,
         *       let's not include the full class name in the methodName.
         */

<span class="nc" id="L118">        JipMethod method = new JipMethod(methodName);</span>
<span class="nc" id="L119">        JipFrame frame = new JipFrame(mCurFrame, method, mCurThreadId,</span>
                                      count, time);

<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (mCurFrame == null) {</span>
<span class="nc" id="L123">            List&lt;JipFrame&gt; vFrame = mThreads.get(mCurThreadId);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (vFrame == null) {</span>
<span class="nc" id="L125">                vFrame = new ArrayList&lt;JipFrame&gt;();</span>
<span class="nc" id="L126">                mThreads.put(mCurThreadId, vFrame);</span>
            }
<span class="nc" id="L128">            vFrame.add(frame);</span>
        }
<span class="nc" id="L130">        mCurFrame = frame;</span>
<span class="nc" id="L131">    }</span>

    public void endFrame() {
<span class="nc" id="L134">        mCurFrame.computeNetTime();</span>
<span class="nc" id="L135">        updatePerMethodInfo(mCurFrame);</span>

        // pop!
<span class="nc" id="L138">        mCurFrame = mCurFrame.getParentOrNull();</span>
<span class="nc" id="L139">    }</span>

    // allocations not handled -- i want some examples first -- :)

    public void addToClassMap(String abbrev, String full) {
<span class="nc" id="L144">        mFullClassNames.put(abbrev, full);</span>
<span class="nc" id="L145">    }</span>

    public String toString() {
<span class="nc" id="L148">        StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L149">        buf.append(&quot;JipRun\n&quot;);</span>
<span class="nc" id="L150">        buf.append(&quot;{\n&quot;);</span>

<span class="nc bnc" id="L152" title="All 2 branches missed.">        for(Long threadId: mThreads.keySet()) {</span>
<span class="nc" id="L153">            int i = 1;</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            for (JipFrame f: mThreads.get(threadId)) {</span>
<span class="nc" id="L155">                buf.append(&quot;* thread &quot; + threadId + &quot; interaction &quot; +i+ &quot;\n&quot;);</span>
<span class="nc" id="L156">                buf.append(f);</span>
<span class="nc" id="L157">                i++;</span>
<span class="nc" id="L158">            }</span>
<span class="nc" id="L159">        }</span>
        
<span class="nc" id="L161">        buf.append(&quot;}\n&quot;);</span>

<span class="nc" id="L163">        return buf.toString();</span>
    }

    public Iterable&lt;Long&gt; threads() {
<span class="nc" id="L167">        return mThreads.keySet();</span>
    }

    long getTotalTimeForAllThreads() {
<span class="nc" id="L171">        long total = 0;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">        for (Long threadId: threads()) {</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            for (JipFrame frame: mThreads.get(threadId.longValue())) {</span>
<span class="nc" id="L174">                total += frame.getTotalTime();</span>
<span class="nc" id="L175">            }</span>
<span class="nc" id="L176">        }</span>
<span class="nc" id="L177">        return total;</span>
    }

    public Iterable&lt;JipFrame&gt; interactions(long threadId) {
<span class="nc" id="L181">        return mThreads.get(threadId);</span>
    }

    public Iterable&lt;JipFrame&gt; allCallers(JipMethod method) {
<span class="nc" id="L185">        Set&lt;JipFrame&gt; set = new HashSet&lt;JipFrame&gt;();</span>
<span class="nc" id="L186">        PerMethodInfo perMethod = mPerMethods.get(method);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (perMethod != null) {</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            for (JipFrame frame: perMethod.allFrames()) {</span>
<span class="nc" id="L189">                JipFrame parent = frame.getParentOrNull();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (parent != null) {</span>
<span class="nc" id="L191">                    set.add(parent);</span>
                }
<span class="nc" id="L193">            }</span>
        }

<span class="nc" id="L196">        return set;</span>
    }

    public Iterable&lt;JipFrame&gt; allCallees(JipMethod method) {
<span class="nc" id="L200">        Set set = new HashSet&lt;JipFrame&gt;();</span>
<span class="nc" id="L201">        PerMethodInfo perMethod = mPerMethods.get(method);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">        if (perMethod != null) {</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            for (JipFrame frame: perMethod.allFrames()) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">                for (JipFrame callee: frame.getChildren()) {</span>
<span class="nc" id="L205">                    set.add(callee);</span>
<span class="nc" id="L206">                }</span>
<span class="nc" id="L207">            }</span>
        }

<span class="nc" id="L210">        return set;</span>
    }

    /**
     * Returns an iterable containing PerMethodInfos in descending totalTime
     * order.
     */
    public List&lt;PerMethodInfo&gt; perMethodsInTotalTimeOrder() {
<span class="nc" id="L218">        Comparator cmp = new Comparator&lt;PerMethodInfo&gt;() {</span>
            public int compare(PerMethodInfo a, PerMethodInfo b) {
<span class="nc" id="L220">                long timeA = a.getAllThreadAllFramesTime();</span>
<span class="nc" id="L221">                long timeB = b.getAllThreadAllFramesTime();</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (timeA &lt; timeB) {</span>
<span class="nc" id="L223">                    return -1;</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                } else if (timeA &gt; timeB) {</span>
<span class="nc" id="L225">                    return 1;</span>
                } else {
<span class="nc" id="L227">                    String nameA = a.getMethod().getMethodName();</span>
<span class="nc" id="L228">                    String nameB = a.getMethod().getMethodName();</span>
<span class="nc" id="L229">                    return nameA.compareToIgnoreCase(nameB);</span>
                }
            }
        };
<span class="nc" id="L233">        List v = new ArrayList(mPerMethods.values());</span>
<span class="nc" id="L234">        Collections.sort(v, cmp);</span>
<span class="nc" id="L235">        return v;</span>
    }

    public PerMethodInfo getPerMethod(JipMethod method) {
<span class="nc" id="L239">        PerMethodInfo perMethod = mPerMethods.get(method);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (perMethod == null) {</span>
<span class="nc" id="L241">            throw new RuntimeException(&quot;unknown method (&quot; + method + &quot;)?&quot;);</span>
        }

<span class="nc" id="L244">        return perMethod;</span>
    }

    static class PerMethodInfo {
        private JipMethod mMethod;

        // NOTE: mAllThreadsAllFramesTime includes times from *all* threads.
        private long mAllThreadsAllFramesTime;
        private long mAllThreadsAllFramesTimeIncludingReentrant;
<span class="nc" id="L253">        private List&lt;JipFrame&gt; mvFrame = new ArrayList&lt;JipFrame&gt;();</span>

<span class="nc" id="L255">        PerMethodInfo(JipMethod method) {</span>
<span class="nc" id="L256">            mMethod = method;</span>
<span class="nc" id="L257">        }</span>

        JipMethod getMethod() {
<span class="nc" id="L260">            return mMethod;</span>
        }

        void addFrame(JipFrame frame) {
<span class="nc" id="L264">            mvFrame.add(frame);</span>

<span class="nc" id="L266">            long frameTime = frame.getTotalTime();</span>

<span class="nc" id="L268">            mAllThreadsAllFramesTimeIncludingReentrant += frameTime;</span>

<span class="nc bnc" id="L270" title="All 2 branches missed.">            if (! frame.isReentrant()) {</span>
<span class="nc" id="L271">                mAllThreadsAllFramesTime += frameTime;</span>
            }
<span class="nc" id="L273">        }</span>

        long getAllThreadAllFramesTime() {
<span class="nc" id="L276">            return mAllThreadsAllFramesTime;</span>
        }

        long getAllThreadAllFramesTimeIncludingReentrant() {
<span class="nc" id="L280">            return mAllThreadsAllFramesTimeIncludingReentrant;</span>
        }

        Iterable&lt;JipFrame&gt; allFrames() {
<span class="nc" id="L284">            return mvFrame;</span>
        }

        public String toString() {
<span class="nc" id="L288">            return mMethod.getMethodName();</span>
        }
    }

    private void updatePerMethodInfo(JipFrame frame) {
<span class="nc" id="L293">        JipMethod method = frame.getMethod();</span>
<span class="nc" id="L294">        PerMethodInfo perMethod = mPerMethods.get(method);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">        if (perMethod == null) {</span>
<span class="nc" id="L296">            perMethod = new PerMethodInfo(method);</span>
<span class="nc" id="L297">            mPerMethods.put(method, perMethod);</span>
        }
<span class="nc" id="L299">        perMethod.addFrame(frame);</span>
<span class="nc" id="L300">    }</span>
};
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>