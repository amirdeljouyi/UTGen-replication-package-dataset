<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FollowApp.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">41_follow</a> &gt; <a href="index.source.html" class="el_package">ghm.follow</a> &gt; <span class="el_source">FollowApp.java</span></div><h1>FollowApp.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2000-2003 Greg Merrill (greghmerrill@yahoo.com)
 * 
 * This file is part of Follow (http://follow.sf.net).
 * 
 * Follow is free software; you can redistribute it and/or modify it under the
 * terms of version 2 of the GNU General Public License as published by the Free
 * Software Foundation.
 * 
 * Follow is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License along with
 * Follow; if not, write to the Free Software Foundation, Inc., 59 Temple Place,
 * Suite 330, Boston, MA 02111-1307 USA
 */

package ghm.follow;

import ghm.follow.config.Configure;
import ghm.follow.config.FollowAppAttributes;
import ghm.follow.event.WindowTracker;
import ghm.follow.gui.About;
import ghm.follow.gui.Clear;
import ghm.follow.gui.ClearAll;
import ghm.follow.gui.Close;
import ghm.follow.gui.Debug;
import ghm.follow.gui.Delete;
import ghm.follow.gui.DeleteAll;
import ghm.follow.gui.DndFileOpener;
import ghm.follow.gui.Edit;
import ghm.follow.gui.Exit;
import ghm.follow.gui.FileFollowingPane;
import ghm.follow.gui.FollowAppAction;
import ghm.follow.gui.Menu;
import ghm.follow.gui.ComponentBuilder;
import ghm.follow.gui.Open;
import ghm.follow.gui.Pause;
import ghm.follow.gui.PopupMenu;
import ghm.follow.gui.Reset;
import ghm.follow.gui.StartupStatus;
import ghm.follow.gui.TabbedPane;
import ghm.follow.gui.ToolBar;
import ghm.follow.gui.FollowAppAction.ActionContext;
import ghm.follow.nav.Bottom;
import ghm.follow.nav.NextTab;
import ghm.follow.nav.PreviousTab;
import ghm.follow.nav.Top;
import ghm.follow.search.ClearAllHighlights;
import ghm.follow.search.ClearHighlights;
import ghm.follow.search.Find;
import ghm.follow.search.SearchableTextPane;
import ghm.follow.systemInterface.DefaultSystemInterface;
import ghm.follow.systemInterface.SystemInterface;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Cursor;
import java.awt.Dimension;
import java.awt.GraphicsEnvironment;
import java.awt.Window;
import java.awt.dnd.DropTarget;
import java.awt.event.ComponentAdapter;
import java.awt.event.ComponentEvent;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.net.URL;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.MissingResourceException;
import java.util.ResourceBundle;

import javax.swing.ImageIcon;
import javax.swing.JFrame;
import javax.swing.JMenuBar;
import javax.swing.JTabbedPane;
import javax.swing.SwingUtilities;

import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * This class' main() method is the entry point into the Follow application.
 * 
 * @see #main(String[])
 * @author &lt;a href=&quot;mailto:greghmerrill@yahoo.com&quot;&gt;Greg Merrill&lt;/a&gt;
 */
public class FollowApp
{
<span class="fc" id="L101">	public static final String FILE_SEPARATOR = System.getProperty(&quot;file.separator&quot;);</span>
	public static final String MESSAGE_LINE_SEPARATOR = &quot;\n&quot;;
<span class="fc" id="L103">	public static final boolean DEBUG = Boolean.getBoolean(&quot;follow.debug&quot;);</span>
<span class="fc" id="L104">	public static boolean HAS_SOLARIS_BUG = false;</span>

<span class="fc" id="L106">	private static Logger LOG = Logger.getLogger(FollowApp.class.getName());</span>
<span class="nc" id="L107">	private int currentCursor = Cursor.DEFAULT_CURSOR;</span>
	private Cursor defaultCursor;
	private Cursor waitCursor;
<span class="nc" id="L110">	private Map&lt;File, FileFollowingPane&gt; fileToFollowingPaneMap = new HashMap&lt;File, FileFollowingPane&gt;();</span>
	private JTabbedPane tabbedPane;
	private ToolBar toolBar;
	private PopupMenu popupMenu;
	private Menu recentFilesMenu;
	private MouseListener rightClickListener;
<span class="nc" id="L116">	private HashMap&lt;String, FollowAppAction&gt; actions = new HashMap&lt;String, FollowAppAction&gt;();</span>
	private SystemInterface systemInterface;
	private StartupStatus startupStatus;

	private FollowAppAttributes attributes;
	private static FollowApp instance;
<span class="fc" id="L122">	private static ResourceBundle resources = ResourceBundle</span>
<span class="fc" id="L123">	        .getBundle(&quot;ghm.follow.FollowAppResourceBundle&quot;);</span>
	private JFrame frame;

	// We should remove this hack once JDK 1.4 gets wide adoption on Solaris.
	static
	{
<span class="fc" id="L129">		boolean isSolaris = &quot;SunOS&quot;.equals(System.getProperty(&quot;os.name&quot;));</span>

<span class="pc bpc" id="L131" title="1 of 2 branches missed.">		if (isSolaris)</span>
		{
<span class="nc" id="L133">			String version = System.getProperty(&quot;java.version&quot;);</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">			if ((version != null) &amp;&amp; version.startsWith(&quot;1.&quot;))</span>
			{
<span class="nc" id="L136">				String substring = version.substring(2, 3);</span>
				try
				{
<span class="nc" id="L139">					int minor = Integer.parseInt(substring);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">					if (minor &lt; 4)</span>
					{
<span class="nc" id="L142">						HAS_SOLARIS_BUG = true;</span>
					}
				}
<span class="nc" id="L145">				catch (NumberFormatException nfe)</span>
				{
					// Nothing else to do.
<span class="nc" id="L148">				}</span>
			}
		}
<span class="fc" id="L151">	}</span>

	/**
	 * @param fileNames
	 *            names of files to be opened
	 */
	FollowApp(List&lt;String&gt; fileNames) throws IOException, InterruptedException,
	        InvocationTargetException
	{
<span class="nc" id="L160">		this(fileNames, null);</span>
<span class="nc" id="L161">	}</span>

	FollowApp(List&lt;String&gt; filenames, File propertyFile) throws IOException, InterruptedException,
	        InvocationTargetException
<span class="nc" id="L165">	{</span>
		// Create &amp; show startup status window
<span class="nc" id="L167">		startupStatus = new StartupStatus(resources);</span>
<span class="nc" id="L168">		centerWindowInScreen(startupStatus);</span>
<span class="nc" id="L169">		startupStatus.pack();</span>
<span class="nc" id="L170">		SwingUtilities.invokeAndWait(new Runnable()</span>
<span class="nc" id="L171">		{</span>
			public void run()
			{
<span class="nc" id="L174">				startupStatus.setVisible(true);</span>
<span class="nc" id="L175">			}</span>
		});

		// Ghastly workaround for bug in Font construction, in review by
		// Sun with review id 108683.
<span class="nc" id="L180">		GraphicsEnvironment.getLocalGraphicsEnvironment().getAvailableFontFamilyNames();</span>
<span class="nc" id="L181">		SwingUtilities.invokeAndWait(new Runnable()</span>
<span class="nc" id="L182">		{</span>
			public void run()
			{
<span class="nc" id="L185">				startupStatus.markDone(startupStatus.LOAD_SYSTEM_FONTS);</span>
<span class="nc" id="L186">			}</span>
		});

		// create frame first. the close operation is handled in WindowTracker
<span class="nc" id="L190">		frame = new JFrame(getResourceString(&quot;frame.title&quot;));</span>

		// load the attributes
<span class="nc" id="L193">		attributes = new FollowAppAttributes(propertyFile);</span>

		// add listeners to update the recent files list
<span class="nc" id="L196">		RecentFileListener rfl = new RecentFileListener();</span>
<span class="nc" id="L197">		attributes.addPropertyChangeListener(FollowAppAttributes.RECENT_FILES_KEY, rfl);</span>
<span class="nc" id="L198">		attributes.addPropertyChangeListener(FollowAppAttributes.RECENT_FILES_MAX_KEY, rfl);</span>

		// load the actions referenced in the application
<span class="nc" id="L201">		loadActions();</span>

		// initialize SystemInterface
<span class="nc" id="L204">		systemInterface = new DefaultSystemInterface(this);</span>

		// initialize menubar
<span class="nc" id="L207">		JMenuBar jMenuBar = ComponentBuilder.buildMenuBar(resources, getActions());</span>

		// set the recent files menu to local variable so it can be updated
		// easily
<span class="nc" id="L211">		recentFilesMenu = ComponentBuilder.recentFilesMenu;</span>

		// fake an event to get the menu setup initially
<span class="nc" id="L214">		rfl.propertyChange(null);</span>

		// initialize popupMenu
<span class="nc" id="L217">		popupMenu = ComponentBuilder.buildPopupMenu(getActions());</span>

		// initialize toolbar
<span class="nc" id="L220">		toolBar = ComponentBuilder.buildToolBar(getActions());</span>

		// initialize tabbedPane, but wait to open files until after frame
		// initialization
<span class="nc" id="L224">		tabbedPane = new TabbedPane(attributes);</span>
<span class="nc" id="L225">		enableDragAndDrop(tabbedPane);</span>

		// initialize frame
<span class="nc" id="L228">		initFrame(jMenuBar);</span>

		// This is an ugly hack. It seems like JFrame.setLocation() is buggy
		// on Solaris jdk versions before 1.4
<span class="nc bnc" id="L232" title="All 2 branches missed.">		if (HAS_SOLARIS_BUG)</span>
		{
<span class="nc" id="L234">			frame.setLocation(50, 50);</span>
		}
		else
		{
<span class="nc" id="L238">			frame.setLocation(attributes.getX(), attributes.getY());</span>
		}

		// track window close events. WindowTracker handles the close operation
<span class="nc" id="L242">		frame.addWindowListener(new WindowTracker(attributes, tabbedPane, systemInterface));</span>
<span class="nc" id="L243">		enableDragAndDrop(frame);</span>

		// Open files from attributes; this is done after the frame is complete
		// and all components have been added to it to make sure that the frame
		// can be shown absolutely as soon as possible. If we put this code
		// before frame creation (as in v1.0), frame creation may take longer
		// because there are more threads (spawned in the course of open())
		// contending for processor time.
<span class="nc" id="L251">		List&lt;File&gt; files = attributes.getFollowedFiles();</span>
<span class="nc" id="L252">		StringBuffer nonexistentFilesBuffer = null;</span>
<span class="nc" id="L253">		int nonexistentFileCount = 0;</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">		for (File file : files)</span>
		{
			try
			{
<span class="nc" id="L258">				openFile(file);</span>
			}
<span class="nc" id="L260">			catch (FileNotFoundException e)</span>
			{
				// This file has been deleted since the previous execution.
				// Remove it from the list of followed files
<span class="nc" id="L264">				attributes.removeFollowedFile(file);</span>
<span class="nc" id="L265">				nonexistentFileCount++;</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">				if (nonexistentFilesBuffer == null)</span>
				{
<span class="nc" id="L268">					nonexistentFilesBuffer = new StringBuffer(file.getAbsolutePath());</span>
				}
				else
				{
<span class="nc" id="L272">					nonexistentFilesBuffer.append(file.getAbsolutePath());</span>
				}
<span class="nc" id="L274">				nonexistentFilesBuffer.append(MESSAGE_LINE_SEPARATOR);</span>
<span class="nc" id="L275">			}</span>
<span class="nc" id="L276">		}</span>

		// open files from the command line
<span class="nc bnc" id="L279" title="All 2 branches missed.">		for (String filename : filenames)</span>
		{
			try
			{
<span class="nc" id="L283">				openFile(new File(filename));</span>
			}
<span class="nc" id="L285">			catch (FileNotFoundException e)</span>
			{
<span class="nc" id="L287">				String msg = MessageFormat.format(</span>
<span class="nc" id="L288">				        getResourceString(&quot;message.cmdLineFileNotFound.text&quot;),</span>
				        new Object[] { filename });
<span class="nc" id="L290">				LOG.info(msg);</span>
<span class="nc" id="L291">			}</span>
<span class="nc" id="L292">		}</span>

<span class="nc bnc" id="L294" title="All 2 branches missed.">		if (nonexistentFileCount &gt; 0)</span>
		{
			// Alert the user of the fact that one or more files have been
			// deleted since the previous execution
<span class="nc" id="L298">			String text = getResourceString(&quot;message.filesDeletedSinceLastExecution.text&quot;);</span>
<span class="nc" id="L299">			String message = MessageFormat.format(text, new Object[] { nonexistentFileCount,</span>
<span class="nc" id="L300">			        nonexistentFilesBuffer.toString() });</span>
			// String title =
			// getResourceString(&quot;message.filesDeletedSinceLastExecution.title&quot;);
			// JOptionPane.showMessageDialog(frame_, message, title,
			// JOptionPane.WARNING_MESSAGE);
<span class="nc" id="L305">			LOG.info(message);</span>
		}

<span class="nc" id="L308">		int tabCount = tabbedPane.getTabCount();</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">		if (tabCount &gt; 0)</span>
		{
<span class="nc bnc" id="L311" title="All 2 branches missed.">			if (tabCount &gt; attributes.getSelectedTabIndex())</span>
			{
<span class="nc" id="L313">				tabbedPane.setSelectedIndex(attributes.getSelectedTabIndex());</span>
			}
			else
			{
<span class="nc" id="L317">				tabbedPane.setSelectedIndex(0);</span>
			}
		}
<span class="nc" id="L320">	}</span>

	/**
	 * Close the current tab
	 */
	public void closeFile()
	{
<span class="nc" id="L327">		FileFollowingPane fileFollowingPane = getSelectedFileFollowingPane();</span>
<span class="nc" id="L328">		int tab = tabbedPane.getSelectedIndex();</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">		if (tab &gt;= 0)</span>
		{
<span class="nc" id="L331">			tabbedPane.removeTabAt(tab);</span>
<span class="nc" id="L332">			disableDragAndDrop(fileFollowingPane.getTextPane());</span>
<span class="nc" id="L333">			attributes.removeFollowedFile(fileFollowingPane.getFollowedFile());</span>
<span class="nc" id="L334">			fileFollowingPane.stopFollowing();</span>
<span class="nc" id="L335">			fileToFollowingPaneMap.remove(fileFollowingPane.getFollowedFile());</span>
		}
<span class="nc" id="L337">		updateActions();</span>
<span class="nc" id="L338">	}</span>

	/**
	 * Get a string from the resource bundle. Convenience method to shorten and
	 * centralize this common call
	 * 
	 * @param key
	 * @return The value of key in the resource bundle. null if the key is not
	 *         found.
	 */
	public static String getResourceString(String key)
	{
<span class="nc" id="L350">		String value = null;</span>
		try
		{
<span class="nc" id="L353">			value = resources.getString(key);</span>
		}
<span class="nc" id="L355">		catch (MissingResourceException mre)</span>
		{
<span class="nc" id="L357">			LOG.warning(mre.getMessage());</span>
<span class="nc" id="L358">		}</span>
<span class="nc" id="L359">		return value;</span>
	}

	/**
	 * Gets an image icon from the resource path.
	 * 
	 * @param clazz
	 *            The class to use as an entry point to the resource path. Image
	 *            path should be relative to this class.
	 * @param iconNameKey
	 *            The resource key name where the image is defined.
	 * @return An image icon based on the URL generated from the value of
	 *         iconNameKey. null if no URL can be found.
	 */
	public static ImageIcon getIcon(Class&lt;?&gt; clazz, String iconNameKey)
	{
<span class="nc" id="L375">		String filename = getResourceString(iconNameKey);</span>
<span class="nc" id="L376">		URL url = clazz.getResource(filename);</span>
<span class="nc" id="L377">		LOG.finer(&quot;Class: &quot; + clazz + &quot;, iconNameKey: &quot; + iconNameKey);</span>
<span class="nc" id="L378">		LOG.finer(&quot;filename: &quot; + filename);</span>
<span class="nc" id="L379">		LOG.finer(&quot;url: &quot; + url);</span>
<span class="nc" id="L380">		ImageIcon icon = null;</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">		if (url != null)</span>
		{
<span class="nc" id="L383">			icon = new ImageIcon(url);</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">			LOG.finer(&quot;errored: &quot; + (java.awt.MediaTracker.ERRORED == icon.getImageLoadStatus()));</span>
		}
<span class="nc" id="L386">		return icon;</span>
	}

	/**
	 * Loads the actions used in the application
	 * 
	 * @throws IOException
	 */
	private void loadActions() throws IOException
	{
		// initialize actions
<span class="nc" id="L397">		putAction(Open.NAME, new Open(this));</span>
<span class="nc" id="L398">		putAction(Close.NAME, new Close(this));</span>
<span class="nc" id="L399">		putAction(Edit.NAME, new Edit(this));</span>
<span class="nc" id="L400">		putAction(Exit.NAME, new Exit(this));</span>
<span class="nc" id="L401">		putAction(Top.NAME, new Top(this));</span>
<span class="nc" id="L402">		putAction(Bottom.NAME, new Bottom(this));</span>
<span class="nc" id="L403">		putAction(Clear.NAME, new Clear(this));</span>
<span class="nc" id="L404">		putAction(ClearAll.NAME, new ClearAll(this));</span>
<span class="nc" id="L405">		putAction(Delete.NAME, new Delete(this));</span>
<span class="nc" id="L406">		putAction(DeleteAll.NAME, new DeleteAll(this));</span>
<span class="nc" id="L407">		putAction(Configure.NAME, new Configure(this));</span>
<span class="nc" id="L408">		putAction(About.NAME, new About(this));</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">		if (DEBUG)</span>
		{
<span class="nc" id="L411">			putAction(Debug.NAME, new Debug(this));</span>
		}
<span class="nc" id="L413">		putAction(Pause.NAME, new Pause(this));</span>
<span class="nc" id="L414">		putAction(NextTab.NAME, new NextTab(this));</span>
<span class="nc" id="L415">		putAction(PreviousTab.NAME, new PreviousTab(this));</span>
<span class="nc" id="L416">		putAction(Find.NAME, new Find(this));</span>
<span class="nc" id="L417">		putAction(ClearHighlights.NAME, new ClearHighlights(this));</span>
<span class="nc" id="L418">		putAction(ClearAllHighlights.NAME, new ClearAllHighlights(this));</span>
<span class="nc" id="L419">		putAction(Reset.NAME, new Reset(this));</span>
<span class="nc" id="L420">	}</span>

	/**
	 * @param jMenuBar
	 */
	private void initFrame(JMenuBar jMenuBar)
	{
<span class="nc" id="L427">		frame.setJMenuBar(jMenuBar);</span>
<span class="nc" id="L428">		frame.getContentPane().add(toolBar, BorderLayout.NORTH);</span>
<span class="nc" id="L429">		frame.getContentPane().add(tabbedPane, BorderLayout.CENTER);</span>
<span class="nc" id="L430">		frame.setSize(attributes.getWidth(), attributes.getHeight());</span>
<span class="nc" id="L431">	}</span>

	public void show()
	{
<span class="nc" id="L435">		frame.setVisible(true);</span>
<span class="nc" id="L436">	}</span>

	public FollowAppAction getAction(String name)
	{
<span class="nc" id="L440">		return actions.get(name);</span>
	}

	/**
	 * Get all actions associated to the application
	 * 
	 * @return
	 */
	public HashMap&lt;String, FollowAppAction&gt; getActions()
	{
<span class="nc" id="L450">		return actions;</span>
	}

	/**
	 * Set an action to the action map of the application.
	 * 
	 * @param name
	 *            The key to set the action to.
	 * @param action
	 *            The action to create an association for.
	 */
	public void putAction(String name, FollowAppAction action)
	{
<span class="nc bnc" id="L463" title="All 2 branches missed.">		if (FollowAppAction.ActionContext.APP == action.getContext())</span>
<span class="nc" id="L464">			action.setEnabled(true);</span>
		else
<span class="nc" id="L466">			action.setEnabled(false);</span>
<span class="nc" id="L467">		actions.put(name, action);</span>
<span class="nc" id="L468">	}</span>

	public void openFile(File file) throws FileNotFoundException
	{
<span class="nc" id="L472">		openFile(file, attributes.autoScroll());</span>
<span class="nc" id="L473">	}</span>

	/**
	 * Warning: This method should be called only from (1) the FollowApp
	 * initializer (before any components are realized) or (2) from the event
	 * dispatching thread.
	 */
	void openFile(File file, boolean startFollowing) throws FileNotFoundException
	{
<span class="nc bnc" id="L482" title="All 2 branches missed.">		if (file == null)</span>
		{
<span class="nc" id="L484">			throw new FileNotFoundException(&quot;file is null.&quot;);</span>
		}
<span class="nc bnc" id="L486" title="All 2 branches missed.">		if (!file.exists())</span>
		{
<span class="nc" id="L488">			throw new FileNotFoundException(file.getName() + &quot; not found.&quot;);</span>
		}
<span class="nc" id="L490">		FileFollowingPane fileFollowingPane = (FileFollowingPane) fileToFollowingPaneMap.get(file);</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">		if (fileFollowingPane != null)</span>
		{
			// File is already open; merely select its tab
<span class="nc" id="L494">			tabbedPane.setSelectedComponent(fileFollowingPane);</span>
		}
		else
		{
<span class="nc" id="L498">			fileFollowingPane = new FileFollowingPane(file, attributes.getBufferSize(), attributes</span>
<span class="nc" id="L499">			        .getLatency(), attributes.autoScroll(), attributes.getFont(), attributes</span>
<span class="nc" id="L500">			        .getTabSize());</span>
<span class="nc" id="L501">			SearchableTextPane ffpTextPane = fileFollowingPane.getTextPane();</span>
<span class="nc" id="L502">			enableDragAndDrop(ffpTextPane);</span>
<span class="nc" id="L503">			fileFollowingPane.setSize(frame.getSize());</span>
<span class="nc" id="L504">			ffpTextPane.setFont(attributes.getFont());</span>
<span class="nc" id="L505">			ffpTextPane.addMouseListener(getRightClickListener());</span>
<span class="nc" id="L506">			fileToFollowingPaneMap.put(file, fileFollowingPane);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">			if (startFollowing)</span>
			{
<span class="nc" id="L509">				fileFollowingPane.startFollowing();</span>
			}
<span class="nc" id="L511">			tabbedPane.addTab(file.getName(), null, fileFollowingPane, file.getAbsolutePath());</span>
<span class="nc" id="L512">			int tabCount = tabbedPane.getTabCount();</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">			if (tabCount &lt; 10)</span>
			{
				// KeyEvent.VK_1 through KeyEvent.VK_9 is represented by the
				// ascii characters 1-9 (49-57)
<span class="nc" id="L517">				int index = tabCount - 1;</span>
<span class="nc" id="L518">				tabbedPane.setMnemonicAt(index, index + ((int) '1'));</span>
			}
<span class="nc" id="L520">			tabbedPane.setSelectedIndex(tabCount - 1);</span>
			// add a listener to set the pause icon correctly
<span class="nc" id="L522">			fileFollowingPane.addComponentListener(new ComponentAdapter()</span>
<span class="nc" id="L523">			{</span>
				public void componentShown(ComponentEvent e)
				{
<span class="nc" id="L526">					FileFollowingPane ffp = (FileFollowingPane) e.getSource();</span>
<span class="nc" id="L527">					Pause pause = (Pause) getAction(Pause.NAME);</span>
<span class="nc" id="L528">					pause.setIconByState(ffp.isFollowingPaused());</span>
<span class="nc" id="L529">				}</span>
			});

			// add the file to history
<span class="nc" id="L533">			attributes.addFollowedFile(file);</span>
<span class="nc" id="L534">			attributes.addRecentFile(file);</span>

<span class="nc" id="L536">			updateActions();</span>
		}
<span class="nc" id="L538">	}</span>

	private void updateActions()
	{
<span class="nc" id="L542">		int tabCount = tabbedPane.getTabCount();</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">		for (FollowAppAction a : actions.values())</span>
		{
<span class="nc bnc" id="L545" title="All 4 branches missed.">			if (tabCount &lt;= 1 &amp;&amp; a.getContext() == ActionContext.MULTI_FILE)</span>
<span class="nc" id="L546">				a.setEnabled(false);</span>
<span class="nc bnc" id="L547" title="All 4 branches missed.">			else if (tabCount == 0 &amp;&amp; a.getContext() == ActionContext.SINGLE_FILE)</span>
<span class="nc" id="L548">				a.setEnabled(false);</span>
			else
<span class="nc" id="L550">				a.setEnabled(true);</span>
<span class="nc" id="L551">		}</span>
<span class="nc" id="L552">	}</span>

	/**
	 * Warning: This method should be called only from the event dispatching
	 * thread.
	 * 
	 * @param cursorType
	 *            may be Cursor.DEFAULT_CURSOR or Cursor.WAIT_CURSOR
	 */
	public void setCursor(int cursorType)
	{
<span class="nc bnc" id="L563" title="All 2 branches missed.">		if (cursorType == currentCursor)</span>
		{
<span class="nc" id="L565">			return;</span>
		}
<span class="nc bnc" id="L567" title="All 3 branches missed.">		switch (cursorType)</span>
		{
		case Cursor.DEFAULT_CURSOR:
<span class="nc bnc" id="L570" title="All 2 branches missed.">			if (defaultCursor == null)</span>
			{
<span class="nc" id="L572">				defaultCursor = Cursor.getDefaultCursor();</span>
			}
<span class="nc" id="L574">			frame.setCursor(defaultCursor);</span>
<span class="nc" id="L575">			break;</span>

		case Cursor.WAIT_CURSOR:
<span class="nc bnc" id="L578" title="All 2 branches missed.">			if (waitCursor == null)</span>
			{
<span class="nc" id="L580">				waitCursor = Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR);</span>
			}
<span class="nc" id="L582">			frame.setCursor(waitCursor);</span>
<span class="nc" id="L583">			break;</span>

		default:
<span class="nc" id="L586">			throw new IllegalArgumentException(</span>
			        &quot;Supported cursors are Cursor.DEFAULT_CURSOR and Cursor.WAIT_CURSOR&quot;);
		}
<span class="nc" id="L589">		currentCursor = cursorType;</span>
<span class="nc" id="L590">	}</span>

	// Lazy initializer for the right-click listener which invokes a popup menu
	private MouseListener getRightClickListener()
	{
<span class="nc bnc" id="L595" title="All 2 branches missed.">		if (rightClickListener == null)</span>
		{
<span class="nc" id="L597">			rightClickListener = new MouseAdapter()</span>
<span class="nc" id="L598">			{</span>
				public void mouseReleased(MouseEvent e)
				{
<span class="nc bnc" id="L601" title="All 2 branches missed.">					if (SwingUtilities.isRightMouseButton(e))</span>
					{
<span class="nc" id="L603">						Component source = e.getComponent();</span>
<span class="nc" id="L604">						popupMenu.show(source, e.getX(), e.getY());</span>
					}
<span class="nc" id="L606">				}</span>
			};
		}
<span class="nc" id="L609">		return rightClickListener;</span>
	}

	public void enableDragAndDrop(Component c)
	{
		// Invoking this constructor automatically sets the component's drop
		// target
<span class="nc" id="L616">		new DropTarget(c, new DndFileOpener(this));</span>
<span class="nc" id="L617">	}</span>

	public void disableDragAndDrop(Component c)
	{
<span class="nc" id="L621">		c.setDropTarget(null);</span>
<span class="nc" id="L622">	}</span>

	public FileFollowingPane getSelectedFileFollowingPane()
	{
<span class="nc" id="L626">		return (FileFollowingPane) tabbedPane.getSelectedComponent();</span>
	}

	public List&lt;FileFollowingPane&gt; getAllFileFollowingPanes()
	{
<span class="nc" id="L631">		int tabCount = tabbedPane.getTabCount();</span>
<span class="nc" id="L632">		List&lt;FileFollowingPane&gt; allFileFollowingPanes = new ArrayList&lt;FileFollowingPane&gt;();</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">		for (int i = 0; i &lt; tabCount; i++)</span>
		{
<span class="nc" id="L635">			allFileFollowingPanes.add((FileFollowingPane) tabbedPane.getComponentAt(i));</span>
		}
<span class="nc" id="L637">		return allFileFollowingPanes;</span>
	}

	public FollowAppAttributes getAttributes()
	{
<span class="nc" id="L642">		return attributes;</span>
	}

	public Map&lt;File, FileFollowingPane&gt; getFileToFollowingPaneMap()
	{
<span class="nc" id="L647">		return fileToFollowingPaneMap;</span>
	}

	public JFrame getFrame()
	{
<span class="nc" id="L652">		return frame;</span>
	}

	public static FollowApp getInstance()
	{
<span class="nc" id="L657">		return instance;</span>
	}

	public SystemInterface getSystemInterface()
	{
<span class="nc" id="L662">		return systemInterface;</span>
	}

	public void setSystemInterface(SystemInterface systemInterface)
	{
<span class="nc" id="L667">		this.systemInterface = systemInterface;</span>
<span class="nc" id="L668">	}</span>

	public JTabbedPane getTabbedPane()
	{
<span class="nc" id="L672">		return tabbedPane;</span>
	}

	public static void centerWindowInScreen(Window window)
	{
<span class="nc" id="L677">		Dimension screenSize = window.getToolkit().getScreenSize();</span>
<span class="nc" id="L678">		Dimension windowSize = window.getPreferredSize();</span>
<span class="nc" id="L679">		window.setLocation((int) (screenSize.getWidth() / 2 - windowSize.getWidth() / 2),</span>
<span class="nc" id="L680">		        (int) (screenSize.getHeight() / 2 - windowSize.getHeight() / 2));</span>
<span class="nc" id="L681">	}</span>

	/**
	 * Invoke this method to start the Follow application. If any command-line
	 * arguments are passed in, they are assume to be filenames and are opened
	 * in the Follow application
	 * 
	 * @param args
	 *            files to be opened
	 */
	public static void main(String[] args)
	{
		try
		{
<span class="nc" id="L695">			ArrayList&lt;String&gt; fileNames = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L696">			File propFile = null;</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">			for (int i = 0; i &lt; args.length; i++)</span>
			{
<span class="nc bnc" id="L699" title="All 2 branches missed.">				if (args[i].startsWith(&quot;-&quot;))</span>
				{
<span class="nc bnc" id="L701" title="All 2 branches missed.">					if (&quot;-propFile&quot;.equalsIgnoreCase(args[i]))</span>
					{
<span class="nc" id="L703">						propFile = new File(args[++i]);</span>
					}
				}
				else
				{
<span class="nc" id="L708">					fileNames.add(args[i]);</span>
				}
			}
<span class="nc" id="L711">			instance = new FollowApp(fileNames, propFile);</span>
<span class="nc" id="L712">			SwingUtilities.invokeAndWait(new Runnable()</span>
<span class="nc" id="L713">			{</span>
				public void run()
				{
					// ensure all widgets inited before opening files
<span class="nc" id="L717">					instance.show();</span>
<span class="nc" id="L718">					instance.startupStatus.markDone(instance.startupStatus.CREATE_WIDGETS);</span>
<span class="nc" id="L719">				}</span>
			});
<span class="nc" id="L721">			instance.startupStatus.dispose();</span>
			// commented code below so that windows follow based on setting in
			// preferences which is set on the pane when the file is opened
			// for (int i=0; i &lt; instance_.tabbedPane_.getTabCount(); i++) {
			// ((FileFollowingPane)instance_.tabbedPane_.getComponentAt(i)).startFollowing();
			// }
		}
<span class="nc" id="L728">		catch (Throwable t)</span>
		{
<span class="nc" id="L730">			LOG.log(Level.SEVERE, &quot;Unhandled exception&quot;, t);</span>
<span class="nc" id="L731">			System.exit(-1);</span>
<span class="nc" id="L732">		}</span>
<span class="nc" id="L733">	}</span>

<span class="nc" id="L735">	private class RecentFileListener implements PropertyChangeListener</span>
	{
		public void propertyChange(PropertyChangeEvent evt)
		{
<span class="nc bnc" id="L739" title="All 2 branches missed.">			if (recentFilesMenu != null)</span>
			{
<span class="nc" id="L741">				recentFilesMenu.removeAll();</span>
<span class="nc" id="L742">				List&lt;File&gt; recentFiles = attributes.getRecentFiles();</span>
				// descend down the list to order files by last opened
<span class="nc bnc" id="L744" title="All 2 branches missed.">				for (int i = recentFiles.size() - 1; i &gt;= 0; i--)</span>
				{
					// have to use FollowApp.this because 'this' is now the
					// context of
					// the inner class
<span class="nc" id="L749">					recentFilesMenu.add(new Open(FollowApp.this, recentFiles.get(i)));</span>
				}
			}
<span class="nc" id="L752">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>