<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FindDialog.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">41_follow</a> &gt; <a href="index.source.html" class="el_package">ghm.follow.search</a> &gt; <span class="el_source">FindDialog.java</span></div><h1>FindDialog.java</h1><pre class="source lang-java linenums">package ghm.follow.search;

import ghm.follow.gui.FileFollowingPane;
import ghm.follow.FollowApp;

import java.awt.BorderLayout;
import java.awt.Cursor;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.util.List;

import javax.swing.BorderFactory;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComponent;
import javax.swing.JDialog;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JPanel;
import javax.swing.JRootPane;
import javax.swing.JScrollPane;
import javax.swing.JTextField;
import javax.swing.KeyStroke;
import javax.swing.border.BevelBorder;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;

public class FindDialog extends JDialog
{
	private JButton findButton;
	private JButton clearButton;
	private JButton closeButton;
	private JLabel statusBar;
	private JScrollPane resultPane;
	private String resultsLabel;
	private JTextField findField;
	private JCheckBox regEx;
	private JCheckBox caseSensitive;

	// instance of action that created this dialog
	private Find findAction;

	public FindDialog(Find find)
	{
<span class="nc" id="L51">		super(find.getApp().getFrame(), FollowApp.getResourceString(&quot;dialog.Find.title&quot;), false);</span>
		// keep a reference for use later
<span class="nc" id="L53">		findAction = find;</span>
<span class="nc" id="L54">		addKeyListener(new KeyAdapter()</span>
<span class="nc" id="L55">		{</span>
			public void keyPressed(KeyEvent e)
			{
<span class="nc bnc" id="L58" title="All 2 branches missed.">				if (e.getKeyCode() == KeyEvent.VK_ESCAPE)</span>
				{
<span class="nc" id="L60">					setVisible(false);</span>
				}
<span class="nc" id="L62">			}</span>
		});
<span class="nc" id="L64">		setResizable(false);</span>
<span class="nc" id="L65">		JComponent contentPane = (JComponent) getContentPane();</span>
<span class="nc" id="L66">		contentPane.setBorder(BorderFactory.createEmptyBorder(2, 2, 2, 2));</span>
<span class="nc" id="L67">		JPanel findPanel = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L68">		GridBagConstraints gbc = new GridBagConstraints();</span>
<span class="nc" id="L69">		gbc.anchor = GridBagConstraints.WEST;</span>
		//
		// add the find field &amp; label
		//
<span class="nc" id="L73">		gbc.ipadx = 4;</span>
<span class="nc" id="L74">		findPanel.add(new JLabel(FollowApp.getResourceString(&quot;dialog.Find.findText.label&quot;)), gbc);</span>
<span class="nc" id="L75">		findField = new JTextField(15);</span>
<span class="nc" id="L76">		findField.setHorizontalAlignment(JTextField.LEFT);</span>
<span class="nc" id="L77">		gbc.gridx = 1;</span>
<span class="nc" id="L78">		gbc.gridy = 0;</span>
<span class="nc" id="L79">		gbc.weightx = 1;</span>
<span class="nc" id="L80">		gbc.ipadx = 0;</span>
<span class="nc" id="L81">		gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L82">		findPanel.add(findField);</span>
		//
		// add the case sensitive check box
		//
<span class="nc" id="L86">		caseSensitive = new JCheckBox(FollowApp.getResourceString(&quot;dialog.Find.caseSensitive.label&quot;));</span>
<span class="nc" id="L87">		gbc.gridx = 1;</span>
<span class="nc" id="L88">		gbc.gridy = 1;</span>
<span class="nc" id="L89">		gbc.weightx = 0;</span>
<span class="nc" id="L90">		gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L91">		caseSensitive.setHorizontalAlignment(JCheckBox.LEFT);</span>
<span class="nc" id="L92">		findPanel.add(caseSensitive, gbc);</span>
		//
		// add the regular expression check box
		//
<span class="nc" id="L96">		regEx = new JCheckBox(FollowApp.getResourceString(&quot;dialog.Find.regularExpression.label&quot;));</span>
<span class="nc" id="L97">		gbc.gridx = 1;</span>
<span class="nc" id="L98">		gbc.gridy = 2;</span>
<span class="nc" id="L99">		gbc.weightx = 0;</span>
<span class="nc" id="L100">		gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L101">		regEx.setHorizontalAlignment(JCheckBox.LEFT);</span>
<span class="nc" id="L102">		findPanel.add(regEx, gbc);</span>
		//
		// add the find button
		//
<span class="nc" id="L106">		findButton = new JButton(FollowApp.getResourceString(&quot;dialog.Find.findButton.label&quot;));</span>
<span class="nc" id="L107">		findButton.setMnemonic(FollowApp.getResourceString(&quot;dialog.Find.findButton.mnemonic&quot;).charAt(0));</span>
<span class="nc" id="L108">		findButton.addActionListener(new ActionListener()</span>
<span class="nc" id="L109">		{</span>
			public void actionPerformed(ActionEvent e)
			{
<span class="nc" id="L112">				findButton_clicked(e);</span>
<span class="nc" id="L113">				findField.grabFocus();</span>
<span class="nc" id="L114">				findField.selectAll();</span>
<span class="nc" id="L115">			}</span>
		});

		// add the clear button
<span class="nc" id="L119">		clearButton = new JButton(FollowApp.getResourceString(&quot;dialog.Find.clearButton.label&quot;));</span>
<span class="nc" id="L120">		clearButton.setMnemonic(FollowApp.getResourceString(&quot;dialog.Find.clearButton.mnemonic&quot;).charAt(0));</span>
<span class="nc" id="L121">		clearButton.addActionListener(new ActionListener()</span>
<span class="nc" id="L122">		{</span>
			public void actionPerformed(ActionEvent e)
			{
<span class="nc" id="L125">				clearButton_clicked(e);</span>
<span class="nc" id="L126">				findField.grabFocus();</span>
<span class="nc" id="L127">				findField.selectAll();</span>
<span class="nc" id="L128">			}</span>
		});

		// add the close button
<span class="nc" id="L132">		closeButton = new JButton(FollowApp.getResourceString(&quot;dialog.Find.closeButton.label&quot;));</span>
<span class="nc" id="L133">		closeButton.setMnemonic(FollowApp.getResourceString(&quot;dialog.Find.closeButton.mnemonic&quot;).charAt(0));</span>
<span class="nc" id="L134">		closeButton.addActionListener(new ActionListener()</span>
<span class="nc" id="L135">		{</span>
			public void actionPerformed(ActionEvent e)
			{
<span class="nc" id="L138">				setVisible(false);</span>
<span class="nc" id="L139">			}</span>
		});
		// add the buttons to the dialog
<span class="nc" id="L142">		JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));</span>

		// create buttons
<span class="nc" id="L145">		buttonPanel.add(findButton);</span>
<span class="nc" id="L146">		buttonPanel.add(clearButton);</span>
<span class="nc" id="L147">		buttonPanel.add(closeButton);</span>

		// create status bar
<span class="nc" id="L150">		JPanel statusPanel = new JPanel(new BorderLayout());</span>
<span class="nc" id="L151">		resultPane = new JScrollPane();</span>
<span class="nc" id="L152">		resultPane.setVisible(false);</span>
<span class="nc" id="L153">		statusBar = new JLabel(&quot; &quot;);</span>
<span class="nc" id="L154">		statusBar.setFont(new Font(&quot;Arial&quot;, Font.PLAIN, 10));</span>
<span class="nc" id="L155">		statusBar.setBorder(new BevelBorder(BevelBorder.LOWERED));</span>
<span class="nc" id="L156">		statusPanel.add(statusBar, BorderLayout.CENTER);</span>
<span class="nc" id="L157">		statusPanel.add(resultPane, BorderLayout.SOUTH);</span>

		// add everything to the content pane
<span class="nc" id="L160">		contentPane.add(findPanel, BorderLayout.NORTH);</span>
<span class="nc" id="L161">		contentPane.add(buttonPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L162">		contentPane.add(statusPanel, BorderLayout.SOUTH);</span>
<span class="nc" id="L163">	}</span>

	public void initFocus()
	{
<span class="nc" id="L167">		findField.grabFocus();</span>
<span class="nc" id="L168">		findField.selectAll();</span>
<span class="nc" id="L169">	}</span>

	/**
	 * Override method to add ESCAPE key action for window close
	 * 
	 * @author Carl Hall (carl.hall@gmail.com)
	 */
	protected JRootPane createRootPane()
	{
<span class="nc" id="L178">		KeyStroke stroke = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</span>
<span class="nc" id="L179">		JRootPane rootPane = new JRootPane();</span>
<span class="nc" id="L180">		rootPane.registerKeyboardAction(new ActionListener()</span>
<span class="nc" id="L181">		{</span>
			public void actionPerformed(ActionEvent actionEvent)
			{
<span class="nc" id="L184">				closeButton.doClick();</span>
<span class="nc" id="L185">			}</span>
		}, stroke, JComponent.WHEN_IN_FOCUSED_WINDOW);
<span class="nc" id="L187">		stroke = KeyStroke.getKeyStroke(KeyEvent.VK_ENTER, 0);</span>
<span class="nc" id="L188">		rootPane.registerKeyboardAction(new ActionListener()</span>
<span class="nc" id="L189">		{</span>
			public void actionPerformed(ActionEvent actionEvent)
			{
<span class="nc" id="L192">				findButton.doClick();</span>
<span class="nc" id="L193">			}</span>
		}, stroke, JComponent.WHEN_IN_FOCUSED_WINDOW);
<span class="nc" id="L195">		return rootPane;</span>
	}

	private void findButton_clicked(ActionEvent e)
	{
<span class="nc" id="L200">		findAction.getApp().setCursor(Cursor.WAIT_CURSOR);</span>
<span class="nc" id="L201">		clearResults();</span>
<span class="nc" id="L202">		List&lt;LineResult&gt; results = doFind();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">		if (results != null)</span>
		{
<span class="nc bnc" id="L205" title="All 2 branches missed.">			if (results.size() == 0)</span>
			{
<span class="nc" id="L207">				statusBar.setText(&quot;Search term not found.&quot;);</span>
			}
			else
			{
<span class="nc" id="L211">				JList resultList = showResults(results);</span>
<span class="nc" id="L212">				resultList.addListSelectionListener(new ListSelectionListener()</span>
<span class="nc" id="L213">				{</span>
					/**
					 * Catches selection events and sets the caret within the view so that the
					 * screen scrolls
					 * 
					 * @author Carl Hall (carl.hall@gmail.com)
					 */
					public void valueChanged(ListSelectionEvent ev)
					{
<span class="nc" id="L222">						resultList_changed(ev);</span>
<span class="nc" id="L223">					}</span>
				});
			}
		}
<span class="nc" id="L227">		findAction.getApp().setCursor(Cursor.DEFAULT_CURSOR);</span>
<span class="nc" id="L228">	}</span>

	private void clearButton_clicked(ActionEvent e)
	{
<span class="nc" id="L232">		findAction.getApp().setCursor(Cursor.WAIT_CURSOR);</span>
		// get the current selected tab
<span class="nc" id="L234">		FileFollowingPane pane = findAction.getApp().getSelectedFileFollowingPane();</span>
		// clear the highlights from the searched tab
<span class="nc" id="L236">		SearchableTextPane textArea = pane.getTextPane();</span>
<span class="nc" id="L237">		textArea.removeHighlights();</span>
		// clear the status bar and result list
<span class="nc" id="L239">		clearResults();</span>
<span class="nc" id="L240">		findAction.getApp().setCursor(Cursor.DEFAULT_CURSOR);</span>
<span class="nc" id="L241">	}</span>

	/**
	 * Show results some results by creating a list and updating the status bar
	 * 
	 * @author Carl Hall (carl.hall@gmail.com)
	 * @param results
	 * @return
	 */
	private JList showResults(List&lt;LineResult&gt; results)
	{
		// create a list of the results
<span class="nc" id="L253">		JList resultList = new JList(results.toArray());</span>
<span class="nc" id="L254">		resultList.setFont(new Font(&quot;Arial&quot;, Font.PLAIN, 10));</span>

		// set the status bar
		;
<span class="nc" id="L258">		statusBar.setText(&quot; &quot; + countResults(results) + &quot; &quot; + resultsLabel);</span>

		// show the result list
<span class="nc" id="L261">		resultPane.getViewport().setView(resultList);</span>
<span class="nc" id="L262">		resultPane.setVisible(true);</span>

		// resize the dialog
<span class="nc" id="L265">		pack();</span>
<span class="nc" id="L266">		return resultList;</span>
	}

	private void resultList_changed(ListSelectionEvent ev)
	{
<span class="nc bnc" id="L271" title="All 2 branches missed.">		if (!ev.getValueIsAdjusting())</span>
		{
<span class="nc" id="L273">			JList list = (JList) ev.getSource();</span>
<span class="nc" id="L274">			int pos = list.getSelectedIndex();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (pos &gt;= 0)</span>
			{
				// get the result associated to the
				// selected position
<span class="nc" id="L279">				LineResult result = (LineResult) list.getModel().getElementAt(pos);</span>

				// get the current selected tab
				// and text area
<span class="nc" id="L283">				FileFollowingPane ffp = findAction.getApp().getSelectedFileFollowingPane();</span>
<span class="nc" id="L284">				SearchableTextPane tp = ffp.getTextPane();</span>
				// move the caret to the chosen text
<span class="nc" id="L286">				tp.setCaretPosition(result.getFirstWordPosition());</span>
			}
		}
<span class="nc" id="L289">	}</span>

	private int countResults(List&lt;LineResult&gt; results)
	{
<span class="nc" id="L293">		int count = 0;</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">		for (LineResult result : results)</span>
		{
<span class="nc" id="L296">			count += result.getWordResults().size();</span>
<span class="nc" id="L297">		}</span>
<span class="nc" id="L298">		return count;</span>
	}

	/**
	 * Clear out the results list and status bar.
	 * 
	 * @author Carl Hall (carl.hall@gmail.com)
	 */
	private void clearResults()
	{
		// clear the status bar
<span class="nc" id="L309">		statusBar.setText(&quot; &quot;);</span>

		// clear and hide the result list
<span class="nc" id="L312">		resultPane.getViewport().setView(null);</span>
<span class="nc" id="L313">		resultPane.setVisible(false);</span>

		// resize the dialog
<span class="nc" id="L316">		pack();</span>
<span class="nc" id="L317">	}</span>

	private List&lt;LineResult&gt; doFind()
	{
		// get the current selected tab
<span class="nc" id="L322">		FileFollowingPane pane = findAction.getApp().getSelectedFileFollowingPane();</span>
		// search the tab with the given text
<span class="nc" id="L324">		SearchableTextPane textArea = pane.getTextPane();</span>
<span class="nc" id="L325">		int flags = 0;</span>

<span class="nc bnc" id="L327" title="All 2 branches missed.">		if (caseSensitive.isSelected())</span>
		{
<span class="nc" id="L329">			flags |= SearchEngine.CASE_SENSITIVE;</span>
		}
<span class="nc bnc" id="L331" title="All 2 branches missed.">		if (regEx.isSelected())</span>
		{
<span class="nc" id="L333">			flags |= SearchEngine.REGEX;</span>
		}
<span class="nc" id="L335">		List&lt;LineResult&gt; results = textArea.highlight(findField.getText(), flags);</span>
		// select search term for convenience
<span class="nc" id="L337">		findField.grabFocus();</span>
<span class="nc" id="L338">		findField.selectAll();</span>
<span class="nc" id="L339">		return results;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>