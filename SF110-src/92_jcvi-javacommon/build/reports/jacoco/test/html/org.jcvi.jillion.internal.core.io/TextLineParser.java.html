<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TextLineParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">92_jcvi-javacommon</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.internal.core.io</a> &gt; <span class="el_source">TextLineParser.java</span></div><h1>TextLineParser.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2013 J. Craig Venter Institute.
 * 	This file is part of Jillion
 * 
 * 	 Jillion is free software: you can redistribute it and/or modify
 * 	it under the terms of the GNU General Public License as published by
 * 	the Free Software Foundation, either version 3 of the License, or
 * 	(at your option) any later version.
 * 	
 * 	 Jillion is distributed in the hope that it will be useful,
 * 	but WITHOUT ANY WARRANTY; without even the implied warranty of
 * 	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * 	GNU General Public License for more details.
 * 	
 * 	You should have received a copy of the GNU General Public License
 * 	along with  Jillion.  If not, see http://www.gnu.org/licenses
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
package org.jcvi.jillion.internal.core.io;

import java.io.Closeable;
import java.io.IOException;
import java.io.InputStream;
import java.io.PushbackInputStream;

import org.jcvi.jillion.core.io.IOUtil;
import org.jcvi.jillion.core.util.FIFOQueue;
/**
 * {@code TextLineParser} can read lines from on {@link InputStream}.  The main
 * difference between TextLineParser and other similar JDK classes is TextLineParser
 * will include the end of line characters in the {@link #nextLine()}
 * methods.  Most JDK classes chop off these characters and the few classes
 * that could could be configured to include these characters are slow.
 * This class considers a line to be terminated by either '\n',
 * (UNIX format) or '\r\n' (Windows/DOS) or '\r' (Apple family until Mac OS 9). 
 * &lt;p/&gt;
 * This class is not Thread-safe
 * @author dkatzel
 *
 *
 */
public final class TextLineParser implements Closeable{

	private static final char LF = '\n';
	private static final char CR = '\r';
	
	private final PushbackInputStream in;
<span class="nc" id="L50">	private final Object endOfFile = new Object();</span>
<span class="nc" id="L51">	private final FIFOQueue&lt;Object&gt; nextQueue = new FIFOQueue&lt;Object&gt;();</span>
<span class="nc" id="L52">	boolean doneFile = false;</span>
	
	private long position;
	private long numberOfBytesInNextLine;
	
	public TextLineParser(InputStream in) throws IOException{
<span class="nc" id="L58">		this(in, 0L);</span>
<span class="nc" id="L59">	}</span>
	
<span class="nc" id="L61">	public TextLineParser(InputStream in, long initialPosition) throws IOException{</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">		if(in ==null){</span>
<span class="nc" id="L63">			throw new NullPointerException(&quot;inputStream can not be null&quot;);</span>
		}
<span class="nc bnc" id="L65" title="All 2 branches missed.">		if(initialPosition &lt;0){</span>
<span class="nc" id="L66">			throw new IllegalArgumentException(&quot;initial position must be &gt;=0&quot;);</span>
		}
<span class="nc" id="L68">		this.position = initialPosition;</span>
<span class="nc" id="L69">		this.in = new PushbackInputStream(in);</span>
<span class="nc" id="L70">		getNextLine();</span>
<span class="nc" id="L71">	}</span>
	
	private void getNextLine() throws IOException{
<span class="nc bnc" id="L74" title="All 2 branches missed.">		if(doneFile){</span>
<span class="nc" id="L75">			return;</span>
		}
<span class="nc" id="L77">		StringBuilder builder = new StringBuilder(200);</span>
<span class="nc" id="L78">		numberOfBytesInNextLine=0L;</span>
		int value;
<span class="nc" id="L80">		value = in.read();</span>
		while(true){	
<span class="nc bnc" id="L82" title="All 2 branches missed.">			if(value == -1){</span>
<span class="nc" id="L83">				doneFile =true;</span>
<span class="nc" id="L84">				close();</span>
<span class="nc" id="L85">				break;</span>
			}
<span class="nc" id="L87">			numberOfBytesInNextLine++;</span>
<span class="nc" id="L88">			builder.append((char)value);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">			if(value == CR){</span>
				//check if next value is LF
				//since CR+LF is how Windows represents an end of line
<span class="nc" id="L92">				int nextChar = in.read();</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">				if(nextChar == LF){</span>
<span class="nc" id="L94">					builder.append(LF);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">				}else if(nextChar !=-1){</span>
					//not windows formatted line
					//could be Mac 0S 9 which only uses '\r'
					//put that value back
<span class="nc" id="L99">					in.unread(nextChar);</span>
<span class="nc" id="L100">					numberOfBytesInNextLine--;</span>
				}
				break;
			}
<span class="nc bnc" id="L104" title="All 2 branches missed.">			if(value == LF){</span>
<span class="nc" id="L105">				break;</span>
			}
<span class="nc" id="L107">			value = in.read();</span>
		}
<span class="nc bnc" id="L109" title="All 2 branches missed.">		if(builder.length()&gt;0){</span>
<span class="nc" id="L110">			nextQueue.add(builder.toString());</span>
		}
<span class="nc bnc" id="L112" title="All 2 branches missed.">		if(doneFile){</span>
<span class="nc" id="L113">			nextQueue.add(endOfFile);</span>
		}
		
<span class="nc" id="L116">	}</span>
	
	/**
	 * Get the number of bytes returned by
	 * {@link #nextLine()} so far.
	 * The value returned is not affected
	 * by how much looking ahead or 
	 * buffering has been done to the
	 * underlying input stream.
	 * @return a number &gt;=0.
	 */
	public long getPosition() {
<span class="nc" id="L128">		return position;</span>
	}

	/**
	 * Does the inputStream have another line
	 * to read.  If there are no more lines to read,
	 * then {@link #nextLine()} will return {@code null}.
	 * @return {@code true} if there are more lines to be read;
	 * {@code false} otherwise.
	 * @see #nextLine()
	 */
	public boolean hasNextLine(){
<span class="nc" id="L140">		Object next = nextQueue.peek();</span>
		
<span class="nc bnc" id="L142" title="All 2 branches missed.">		return next!= endOfFile;</span>
	}
	/**
	 * Get the next line (including end of line characters)
	 * as a String.
	 * @return a the next line; or {@code null} if there are no
	 * more lines.
	 * @throws IOException if there is a problem reading the next
	 * line.
	 */
	public String nextLine() throws IOException{
<span class="nc" id="L153">		Object next= nextQueue.poll();</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">		if(next == endOfFile){</span>
<span class="nc" id="L155">			return null;</span>
		}
<span class="nc" id="L157">		position+=numberOfBytesInNextLine;</span>
<span class="nc" id="L158">		getNextLine();</span>
<span class="nc" id="L159">		return (String)next;</span>
	}
	/**
	 * 
	 * {@inheritDoc}
	 */
	@Override
	public void close() throws IOException {
<span class="nc" id="L167">		IOUtil.closeAndIgnoreErrors(in);</span>
<span class="nc" id="L168">		nextQueue.clear();</span>
		
<span class="nc" id="L170">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>