<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MultiAceFileVisitorAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">92_jcvi-javacommon</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.assembly.consed.ace</a> &gt; <span class="el_source">MultiAceFileVisitorAdapter.java</span></div><h1>MultiAceFileVisitorAdapter.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2013 J. Craig Venter Institute.
 * 	This file is part of Jillion
 * 
 * 	 Jillion is free software: you can redistribute it and/or modify
 * 	it under the terms of the GNU General Public License as published by
 * 	the Free Software Foundation, either version 3 of the License, or
 * 	(at your option) any later version.
 * 	
 * 	 Jillion is distributed in the hope that it will be useful,
 * 	but WITHOUT ANY WARRANTY; without even the implied warranty of
 * 	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * 	GNU General Public License for more details.
 * 	
 * 	You should have received a copy of the GNU General Public License
 * 	along with  Jillion.  If not, see http://www.gnu.org/licenses
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
package org.jcvi.jillion.assembly.consed.ace;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.List;

import org.jcvi.jillion.core.Direction;
import org.jcvi.jillion.core.Range;
import org.jcvi.jillion.core.qual.QualitySequence;

public class MultiAceFileVisitorAdapter implements AceFileVisitor{

	private final List&lt;AceFileVisitor&gt; visitors;
	
	private List&lt;AceContigVisitor&gt; currentContigVisitors;
	private List&lt;AceContigReadVisitor&gt; currentReadVisitors;
	private List&lt;AceConsensusTagVisitor&gt; currentConsensusTagVisitors;
	
	private List&lt;AceFileVisitorCallbackAdapter&gt; currentCallbacks;
	
	private AceFileVisitorCallback ourCallback;
	public MultiAceFileVisitorAdapter(AceFileVisitor...visitors){
<span class="nc" id="L45">		this(Arrays.asList(visitors));</span>
<span class="nc" id="L46">	}</span>
<span class="nc" id="L47">	public MultiAceFileVisitorAdapter(Collection&lt;? extends AceFileVisitor&gt; visitors) {</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">		if(visitors.isEmpty()){</span>
<span class="nc" id="L49">			throw new IllegalArgumentException(&quot;must provide at least one visitor&quot;);</span>
		}
<span class="nc" id="L51">		this.visitors = new ArrayList&lt;AceFileVisitor&gt;(visitors.size());</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">		for(AceFileVisitor visitor : visitors){</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">			if(visitor ==null){</span>
<span class="nc" id="L54">				throw new NullPointerException(&quot;visitor can not be null&quot;);</span>
			}
<span class="nc" id="L56">			this.visitors.add(visitor);</span>
<span class="nc" id="L57">		}</span>
<span class="nc" id="L58">	}</span>

	private boolean handleHaltedVisitors(){
<span class="nc bnc" id="L61" title="All 2 branches missed.">		if(ourCallback ==null){</span>
			//no callbacks do nothing
<span class="nc" id="L63">			return false;</span>
		}
		//work backwards to avoid concurrent modification exception
<span class="nc bnc" id="L66" title="All 2 branches missed.">		for(int i=currentCallbacks.size(); i&gt;=0; i--){</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">			if(currentCallbacks.get(i).isHalted()){</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">				if(currentReadVisitors !=null){</span>
					//visitor lists should all be the same size
					//so indexes are in sync
<span class="nc" id="L71">					AceContigReadVisitor readVisitor =currentReadVisitors.remove(i);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">					if(readVisitor!=null){</span>
<span class="nc" id="L73">						readVisitor.halted();</span>
					}					
				}
<span class="nc bnc" id="L76" title="All 2 branches missed.">				if(currentContigVisitors !=null){</span>
<span class="nc" id="L77">					AceContigVisitor contigVisitor = currentContigVisitors.remove(i);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">					if(contigVisitor !=null){</span>
<span class="nc" id="L79">						contigVisitor.halted();</span>
					}
				}
<span class="nc bnc" id="L82" title="All 2 branches missed.">				if(currentConsensusTagVisitors !=null){</span>
<span class="nc" id="L83">					AceConsensusTagVisitor tagVisitor = currentConsensusTagVisitors.remove(i);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">					if(tagVisitor !=null){</span>
<span class="nc" id="L85">						tagVisitor.halted();</span>
					}
				}
				
<span class="nc" id="L89">				AceFileVisitor visitor = visitors.remove(i);</span>
<span class="nc" id="L90">				visitor.halted();</span>
<span class="nc" id="L91">				currentCallbacks.remove(i);</span>
			}
		}
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if(currentCallbacks.isEmpty()){</span>
			//all callbacks have been halted
<span class="nc" id="L96">			ourCallback.haltParsing();</span>
<span class="nc" id="L97">			ourCallback=null;</span>
<span class="nc" id="L98">			currentReadVisitors=null;</span>
<span class="nc" id="L99">			currentContigVisitors = null;</span>
<span class="nc" id="L100">			currentConsensusTagVisitors =null;</span>
<span class="nc" id="L101">			return true;</span>
		}
<span class="nc" id="L103">		return false;</span>
	}
	@Override
	public void visitHeader(int numberOfContigs, long totalNumberOfReads) {
<span class="nc bnc" id="L107" title="All 2 branches missed.">		for(AceFileVisitor visitor : visitors){</span>
<span class="nc" id="L108">			visitor.visitHeader(numberOfContigs, totalNumberOfReads);</span>
			
<span class="nc" id="L110">		}</span>
<span class="nc" id="L111">	}</span>

	@Override
	public AceContigVisitor visitContig(AceFileVisitorCallback callback,
			String contigId, int numberOfBases, int numberOfReads,
			int numberOfBaseSegments, boolean reverseComplemented) {
<span class="nc" id="L117">		this.ourCallback = callback;</span>
<span class="nc" id="L118">		currentCallbacks = new ArrayList&lt;AceFileVisitorCallbackAdapter&gt;(visitors.size());</span>
<span class="nc" id="L119">		currentContigVisitors = new ArrayList&lt;AceContigVisitor&gt;(visitors.size());</span>
<span class="nc" id="L120">		boolean skipContig = true;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">		for(AceFileVisitor visitor : visitors){</span>
<span class="nc" id="L122">			AceFileVisitorCallbackAdapter adaptedCallback = new AceFileVisitorCallbackAdapter(callback);</span>
<span class="nc" id="L123">			currentCallbacks.add(adaptedCallback);</span>
<span class="nc" id="L124">			AceContigVisitor contigVisitor = visitor.visitContig(adaptedCallback, contigId, numberOfBases, numberOfReads, numberOfBaseSegments, reverseComplemented);</span>
<span class="nc" id="L125">			currentContigVisitors.add(contigVisitor);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">			if(contigVisitor !=null){</span>
<span class="nc" id="L127">				skipContig=false;</span>
			}
<span class="nc" id="L129">		}</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">		if(handleHaltedVisitors()){</span>
<span class="nc" id="L131">			return null;</span>
		}
		//if none of our visitors want to
		//visit, then we can safely skip it too.
<span class="nc bnc" id="L135" title="All 2 branches missed.">		if(skipContig){</span>
<span class="nc" id="L136">			currentContigVisitors=null;</span>
<span class="nc" id="L137">			return null;</span>
		}
<span class="nc" id="L139">		return new MultiAceContigVisitor();</span>
	}

	@Override
	public void visitReadTag(String id, String type, String creator,
			long gappedStart, long gappedEnd, Date creationDate,
			boolean isTransient) {
<span class="nc bnc" id="L146" title="All 2 branches missed.">		for(AceFileVisitor visitor : visitors){</span>
<span class="nc" id="L147">			visitor.visitReadTag(id, type, creator, </span>
				gappedStart, gappedEnd, creationDate, 
				isTransient);
			
<span class="nc" id="L151">		}</span>
		
<span class="nc" id="L153">	}</span>

	@Override
	public AceConsensusTagVisitor visitConsensusTag(String id, String type,
			String creator, long gappedStart, long gappedEnd,
			Date creationDate, boolean isTransient) {
<span class="nc" id="L159">		currentConsensusTagVisitors = new ArrayList&lt;AceConsensusTagVisitor&gt;(visitors.size());</span>
<span class="nc" id="L160">		boolean skipTag=true;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">		for(AceFileVisitor visitor : visitors){</span>
<span class="nc" id="L162">			AceConsensusTagVisitor tagVisitor = visitor.visitConsensusTag(id, type, creator, gappedStart, gappedEnd, creationDate, isTransient);</span>
<span class="nc" id="L163">			currentConsensusTagVisitors.add(tagVisitor);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">			if(tagVisitor !=null){</span>
<span class="nc" id="L165">				skipTag =true;</span>
			}
<span class="nc" id="L167">		}</span>
<span class="nc bnc" id="L168" title="All 4 branches missed.">		if(handleHaltedVisitors() || skipTag){</span>
<span class="nc" id="L169">			currentConsensusTagVisitors=null;</span>
<span class="nc" id="L170">			return null;</span>
		}
		
<span class="nc" id="L173">		return new MultiAceConsensusTagVisitor();</span>
	}

	@Override
	public void visitWholeAssemblyTag(String type, String creator,
			Date creationDate, String data) {
<span class="nc bnc" id="L179" title="All 2 branches missed.">		for(AceFileVisitor visitor : visitors){</span>
<span class="nc" id="L180">			visitor.visitWholeAssemblyTag(type, creator, creationDate, data);</span>
<span class="nc" id="L181">		}</span>
		
<span class="nc" id="L183">	}</span>

	@Override
	public void visitEnd() {
<span class="nc bnc" id="L187" title="All 2 branches missed.">		for(AceFileVisitor visitor : visitors){</span>
<span class="nc" id="L188">			visitor.visitEnd();</span>
<span class="nc" id="L189">		}</span>
		
<span class="nc" id="L191">	}</span>

	@Override
	public void halted() {
		//all visitors should have been
		//removed by the time we call this
		//but just in case:
<span class="nc bnc" id="L198" title="All 2 branches missed.">		if(currentReadVisitors !=null){</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">			for(AceContigReadVisitor readVisitor : currentReadVisitors){</span>
<span class="nc" id="L200">				readVisitor.halted();</span>
<span class="nc" id="L201">			}</span>
		}
<span class="nc bnc" id="L203" title="All 2 branches missed.">		if(currentContigVisitors !=null){</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">			for(AceContigVisitor contigVisitor : currentContigVisitors){</span>
<span class="nc" id="L205">				contigVisitor.halted();</span>
<span class="nc" id="L206">			}</span>
		}
<span class="nc bnc" id="L208" title="All 2 branches missed.">		if(currentConsensusTagVisitors !=null){</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			for(AceConsensusTagVisitor tagVisitor : currentConsensusTagVisitors){</span>
<span class="nc" id="L210">				tagVisitor.halted();</span>
<span class="nc" id="L211">			}</span>
		}
<span class="nc bnc" id="L213" title="All 2 branches missed.">		for(AceFileVisitor visitor : visitors){</span>
<span class="nc" id="L214">			visitor.halted();</span>
<span class="nc" id="L215">		}</span>
		
<span class="nc" id="L217">	}</span>
	
<span class="nc" id="L219">	private class MultiAceConsensusTagVisitor implements AceConsensusTagVisitor{</span>

		@Override
		public void visitComment(String comment) {
<span class="nc bnc" id="L223" title="All 2 branches missed.">			for(AceConsensusTagVisitor visitor : currentConsensusTagVisitors){</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L225">					visitor.visitComment(comment);</span>
				}
<span class="nc" id="L227">			}</span>
<span class="nc" id="L228">			handleHaltedVisitors();</span>
<span class="nc" id="L229">		}</span>

		@Override
		public void visitData(String data) {
<span class="nc bnc" id="L233" title="All 2 branches missed.">			for(AceConsensusTagVisitor visitor : currentConsensusTagVisitors){</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L235">					visitor.visitData(data);</span>
				}
<span class="nc" id="L237">			}</span>
<span class="nc" id="L238">			handleHaltedVisitors();</span>
			
<span class="nc" id="L240">		}</span>

		@Override
		public void visitEnd() {
<span class="nc bnc" id="L244" title="All 2 branches missed.">			for(AceConsensusTagVisitor visitor : currentConsensusTagVisitors){</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L246">					visitor.visitEnd();</span>
				}
<span class="nc" id="L248">			}</span>
<span class="nc" id="L249">			handleHaltedVisitors();</span>
			
<span class="nc" id="L251">		}</span>

		@Override
		public void halted() {
			//no-op?
			//handled by outer visitor
			
<span class="nc" id="L258">		}</span>
		
	}
	
<span class="nc" id="L262">	private class MultiAceContigVisitor implements AceContigVisitor{</span>
		
		
		@Override
		public void visitBasesLine(String mixedCaseBasecalls) {
<span class="nc bnc" id="L267" title="All 2 branches missed.">			for(AceContigVisitor visitor : currentContigVisitors){</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L269">					visitor.visitBasesLine(mixedCaseBasecalls);</span>
				}
<span class="nc" id="L271">			}</span>
<span class="nc" id="L272">			handleHaltedVisitors();</span>
			
<span class="nc" id="L274">		}</span>
		@Override
		public void visitConsensusQualities(
				QualitySequence ungappedConsensusQualities) {
<span class="nc bnc" id="L278" title="All 2 branches missed.">			for(AceContigVisitor visitor : currentContigVisitors){</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L280">					visitor.visitConsensusQualities(ungappedConsensusQualities);</span>
				}				
<span class="nc" id="L282">			}</span>
<span class="nc" id="L283">			handleHaltedVisitors();</span>
			
<span class="nc" id="L285">		}</span>
		@Override
		public void visitAlignedReadInfo(String readId, Direction dir,
				int gappedStartPosition) {
<span class="nc bnc" id="L289" title="All 2 branches missed.">			for(AceContigVisitor visitor : currentContigVisitors){</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L291">					visitor.visitAlignedReadInfo(readId, dir, gappedStartPosition);</span>
				}
<span class="nc" id="L293">			}</span>
<span class="nc" id="L294">			handleHaltedVisitors();</span>
			
<span class="nc" id="L296">		}</span>
		@Override
		public void visitBaseSegment(Range gappedConsensusRange, String readId) {
<span class="nc bnc" id="L299" title="All 2 branches missed.">			for(AceContigVisitor visitor : currentContigVisitors){</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L301">					visitor.visitBaseSegment(gappedConsensusRange, readId);</span>
				}
<span class="nc" id="L303">			}</span>
<span class="nc" id="L304">			handleHaltedVisitors();</span>
			
<span class="nc" id="L306">		}</span>
		@Override
		public AceContigReadVisitor visitBeginRead(String readId,
				int gappedLength) {
<span class="nc" id="L310">			currentReadVisitors = new ArrayList&lt;AceContigReadVisitor&gt;(currentContigVisitors.size());</span>
<span class="nc" id="L311">			boolean skipRead=true;</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			for(AceContigVisitor visitor : currentContigVisitors){</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">				if(visitor ==null){</span>
<span class="nc" id="L314">					currentReadVisitors.add(null);</span>
				}else{
<span class="nc" id="L316">					AceContigReadVisitor readVisitor = visitor.visitBeginRead(readId, gappedLength);</span>
<span class="nc" id="L317">					currentReadVisitors.add(readVisitor);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">					if(readVisitor !=null){</span>
<span class="nc" id="L319">						skipRead=false;</span>
					}
				}
<span class="nc" id="L322">			}</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">			if(handleHaltedVisitors()){</span>
<span class="nc" id="L324">				return null;</span>
			}
<span class="nc bnc" id="L326" title="All 2 branches missed.">			if(skipRead){</span>
<span class="nc" id="L327">				currentReadVisitors= null;</span>
<span class="nc" id="L328">				return null;</span>
			}
<span class="nc" id="L330">			return new MultiAceContigReadVisitor();</span>
		}
		@Override
		public void visitEnd() {			
<span class="nc bnc" id="L334" title="All 2 branches missed.">			for(AceContigVisitor visitor : currentContigVisitors){</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L336">					visitor.visitEnd();</span>
				}
<span class="nc" id="L338">			}</span>
			//we are done visiting our current contigs
			//so remove them 
<span class="nc" id="L341">			currentContigVisitors = null;</span>
<span class="nc" id="L342">			handleHaltedVisitors();</span>
			
<span class="nc" id="L344">		}</span>
		@Override
		public void halted() {
			//no-op?
			//the outer visitor should handle halting
			
<span class="nc" id="L350">		}		</span>
	}
	
<span class="nc" id="L353">	private class MultiAceContigReadVisitor implements AceContigReadVisitor{</span>

		@Override
		public void visitQualityLine(int qualLeft, int qualRight,
				int alignLeft, int alignRight) {
<span class="nc bnc" id="L358" title="All 2 branches missed.">			for(AceContigReadVisitor visitor : currentReadVisitors){</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L360">					visitor.visitQualityLine(qualLeft, qualRight, alignLeft, alignRight);</span>
				}
<span class="nc" id="L362">			}</span>
<span class="nc" id="L363">			handleHaltedVisitors();</span>
<span class="nc" id="L364">		}</span>

		@Override
		public void visitTraceDescriptionLine(String traceName, String phdName,
				Date date) {
<span class="nc bnc" id="L369" title="All 2 branches missed.">			for(AceContigReadVisitor visitor : currentReadVisitors){</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L371">					visitor.visitTraceDescriptionLine(traceName, phdName, date);</span>
				}
<span class="nc" id="L373">			}</span>
<span class="nc" id="L374">			handleHaltedVisitors();</span>
			
<span class="nc" id="L376">		}</span>

		@Override
		public void visitBasesLine(String mixedCaseBasecalls) {
<span class="nc bnc" id="L380" title="All 2 branches missed.">			for(AceContigReadVisitor visitor : currentReadVisitors){</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L382">					visitor.visitBasesLine(mixedCaseBasecalls);</span>
				}
<span class="nc" id="L384">			}</span>
<span class="nc" id="L385">			handleHaltedVisitors();			</span>
<span class="nc" id="L386">		}</span>

		@Override
		public void visitEnd() {
<span class="nc bnc" id="L390" title="All 2 branches missed.">			for(AceContigReadVisitor visitor : currentReadVisitors){</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">				if(visitor !=null){</span>
<span class="nc" id="L392">					visitor.visitEnd();</span>
				}
<span class="nc" id="L394">			}</span>
<span class="nc" id="L395">			handleHaltedVisitors();</span>
<span class="nc" id="L396">			currentReadVisitors = null;</span>
<span class="nc" id="L397">		}</span>

		@Override
		public void halted() {
			//no-op?
			//the outer visitor should handle halting
<span class="nc" id="L403">		}</span>
		
	}
	
	
	private static class AceFileVisitorCallbackAdapter implements AceFileVisitorCallback{
		private final AceFileVisitorCallback callback;
		private volatile boolean halt;
		
		public AceFileVisitorCallbackAdapter(
<span class="nc" id="L413">				AceFileVisitorCallback callback) {</span>
<span class="nc" id="L414">			this.callback = callback;</span>
<span class="nc" id="L415">		}</span>

		@Override
		public boolean canCreateMemento() {
<span class="nc" id="L419">			return callback.canCreateMemento();</span>
		}

		@Override
		public AceFileVisitorMemento createMemento() {
<span class="nc" id="L424">			return callback.createMemento();</span>
		}

		@Override
		public void haltParsing() {
<span class="nc" id="L429">			halt = true;			</span>
<span class="nc" id="L430">		}</span>

		public boolean isHalted() {
<span class="nc" id="L433">			return halt;</span>
		}
		
		
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>