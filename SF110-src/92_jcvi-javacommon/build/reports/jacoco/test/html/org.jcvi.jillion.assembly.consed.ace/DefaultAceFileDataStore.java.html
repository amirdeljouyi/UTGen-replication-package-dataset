<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultAceFileDataStore.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">92_jcvi-javacommon</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.assembly.consed.ace</a> &gt; <span class="el_source">DefaultAceFileDataStore.java</span></div><h1>DefaultAceFileDataStore.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2013 J. Craig Venter Institute.
 * 	This file is part of Jillion
 * 
 * 	 Jillion is free software: you can redistribute it and/or modify
 * 	it under the terms of the GNU General Public License as published by
 * 	the Free Software Foundation, either version 3 of the License, or
 * 	(at your option) any later version.
 * 	
 * 	 Jillion is distributed in the hope that it will be useful,
 * 	but WITHOUT ANY WARRANTY; without even the implied warranty of
 * 	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * 	GNU General Public License for more details.
 * 	
 * 	You should have received a copy of the GNU General Public License
 * 	along with  Jillion.  If not, see http://www.gnu.org/licenses
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
package org.jcvi.jillion.assembly.consed.ace;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Date;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

import org.jcvi.jillion.core.Range;
import org.jcvi.jillion.core.datastore.DataStore;
import org.jcvi.jillion.core.datastore.DataStoreClosedException;
import org.jcvi.jillion.core.datastore.DataStoreException;
import org.jcvi.jillion.core.datastore.DataStoreFilter;
import org.jcvi.jillion.core.datastore.DataStoreFilters;
import org.jcvi.jillion.core.datastore.DataStoreUtil;
import org.jcvi.jillion.core.util.iter.StreamingIterator;
import org.jcvi.jillion.internal.core.datastore.DataStoreStreamingIterator;
/**
 * {@code DefaultAceFileDataStore} is a AceContigDataStore
 * implementation that stores all the {@link AceContig}s
 * in a Map.  This implementation is not very 
 * memory efficient and therefore should not be used
 * for large ace files.
 * @author dkatzel
 *
 *
 */
final class DefaultAceFileDataStore implements AceFileContigDataStore{

	/**
	 * {@link DataStore} wrapper of our {@link AceContig}s.
	 */
	private final DataStore&lt;AceContig&gt; delegate;
	/**
	 * The total number of reads in our datastore
	 * (sum of all the reads in the contigs).
	 */
    private final long totalNumberOfReads;
    /**
     * List of all the {@link WholeAssemblyAceTag}s
     * in the ace file in the order they are
     * declared in the file.
     */
    private final List&lt;WholeAssemblyAceTag&gt; wholeAssemblyTags;
    /**
     * List of all the {@link ConsensusAceTag}s
     * in the ace file in the order they are
     * declared in the file.
     */
    private final List&lt;ConsensusAceTag&gt; consensusTags;
    /**
     * List of all the {@link ReadAceTag}s
     * in the ace file in the order they are
     * declared in the file.
     */
    private final List&lt;ReadAceTag&gt; readTags;
    
    public static AceFileContigDataStore create(InputStream aceFileStream) throws IOException{
<span class="nc" id="L82">    	return create(aceFileStream, DataStoreFilters.alwaysAccept());</span>
    }
    
    public static AceFileContigDataStore create(InputStream aceFileStream, DataStoreFilter filter) throws IOException{
<span class="nc" id="L86">    	Visitor builder = new Visitor(filter);</span>
<span class="nc" id="L87">    	AceHandler parser = AceFileParser.create(aceFileStream);</span>
<span class="nc" id="L88">    	parser.accept(builder);</span>
<span class="nc" id="L89">    	return new DefaultAceFileDataStore(builder);</span>
    }
    public static AceFileContigDataStore create(File aceFile) throws IOException{
<span class="nc" id="L92">    	return create(aceFile, DataStoreFilters.alwaysAccept());</span>
    }
    public static AceFileContigDataStore create(File aceFile, DataStoreFilter filter) throws IOException{
<span class="nc" id="L95">    	Visitor builder = new Visitor(filter);</span>
<span class="nc" id="L96">    	AceHandler parser = AceFileParser.create(aceFile);</span>
<span class="nc" id="L97">    	parser.accept(builder);</span>
<span class="nc" id="L98">    	return new DefaultAceFileDataStore(builder);</span>
    }
    
<span class="nc" id="L101">	private DefaultAceFileDataStore(Visitor builder) {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">		if(!builder.completed){</span>
<span class="nc" id="L103">			throw new IllegalStateException(&quot;did not completely parse ace file&quot;);</span>
		}
<span class="nc" id="L105">		this.delegate = DataStoreUtil.adapt(builder.map);</span>
<span class="nc" id="L106">		this.totalNumberOfReads = builder.totalNumberOfReads;</span>
<span class="nc" id="L107">		this.wholeAssemblyTags = builder.wholeAssemblyTags;</span>
<span class="nc" id="L108">		this.consensusTags = builder.consensusTags;</span>
<span class="nc" id="L109">		this.readTags = builder.readTags;</span>
<span class="nc" id="L110">	}	</span>
    
	
	@Override
	public StreamingIterator&lt;String&gt; idIterator() throws DataStoreException {
<span class="nc" id="L115">		return delegate.idIterator();</span>
	}


	@Override
	public AceContig get(String id) throws DataStoreException {
<span class="nc" id="L121">		return delegate.get(id);</span>
	}


	@Override
	public boolean contains(String id) throws DataStoreException {
<span class="nc" id="L127">		return delegate.contains(id);</span>
	}


	@Override
	public long getNumberOfRecords() throws DataStoreException {
<span class="nc" id="L133">		return delegate.getNumberOfRecords();</span>
	}


	@Override
	public boolean isClosed() {
<span class="nc" id="L139">		return delegate.isClosed();</span>
	}


	@Override
	public StreamingIterator&lt;AceContig&gt; iterator() throws DataStoreException {
<span class="nc" id="L145">		return delegate.iterator();</span>
	}


	@Override
	public void close() throws IOException {
<span class="nc" id="L151">		delegate.close();</span>
		
<span class="nc" id="L153">	}</span>


	@Override
	public long getNumberOfTotalReads(){
<span class="nc bnc" id="L158" title="All 2 branches missed.">		if(isClosed()){</span>
<span class="nc" id="L159">			throw new DataStoreClosedException(&quot;closed&quot;);</span>
		}
<span class="nc" id="L161">		return totalNumberOfReads;</span>
	}


	@Override
	public StreamingIterator&lt;WholeAssemblyAceTag&gt; getWholeAssemblyTagIterator()
			throws DataStoreException {
<span class="nc" id="L168">		return DataStoreStreamingIterator.create(this, wholeAssemblyTags.iterator());</span>
	}


	@Override
	public StreamingIterator&lt;ReadAceTag&gt; getReadTagIterator()
			throws DataStoreException {
<span class="nc" id="L175">		return DataStoreStreamingIterator.create(this, readTags.iterator());</span>
	}


	@Override
	public StreamingIterator&lt;ConsensusAceTag&gt; getConsensusTagIterator()
			throws DataStoreException {
<span class="nc" id="L182">		return DataStoreStreamingIterator.create(this, consensusTags.iterator());</span>
	}


	private static final class Visitor implements AceFileVisitor{

		private final DataStoreFilter filter;
		
		private Map&lt;String, AceContig&gt; map;
		/**
		 * The total number of reads in our datastore
		 * (sum of all the reads in the contigs).
		 */
	    private long totalNumberOfReads;
	    /**
	     * List of all the {@link WholeAssemblyAceTag}s
	     * in the ace file in the order they are
	     * declared in the file.
	     */
<span class="nc" id="L201">	    private final List&lt;WholeAssemblyAceTag&gt; wholeAssemblyTags = new ArrayList&lt;WholeAssemblyAceTag&gt;();</span>
	    /**
	     * List of all the {@link ConsensusAceTag}s
	     * in the ace file in the order they are
	     * declared in the file.
	     */
<span class="nc" id="L207">	    private final List&lt;ConsensusAceTag&gt; consensusTags = new ArrayList&lt;ConsensusAceTag&gt;();</span>
	    /**
	     * List of all the {@link ReadAceTag}s
	     * in the ace file in the order they are
	     * declared in the file.
	     */
<span class="nc" id="L213">	    private final List&lt;ReadAceTag&gt; readTags = new ArrayList&lt;ReadAceTag&gt;();</span>
	    
<span class="nc" id="L215">	    private boolean completed = false;</span>
	    
<span class="nc" id="L217">		public Visitor(DataStoreFilter filter) {</span>
<span class="nc" id="L218">			this.filter = filter;</span>
<span class="nc" id="L219">		}</span>

		@Override
		public void visitHeader(int numberOfContigs, long totalNumberOfReads) {
<span class="nc" id="L223">			this.map = new LinkedHashMap&lt;String, AceContig&gt;(numberOfContigs);</span>
<span class="nc" id="L224">		}</span>

		@Override
		public AceContigVisitor visitContig(AceFileVisitorCallback callback, final String contigId, int numberOfBases,
				int numberOfReads, int numberOfBaseSegments,
				boolean reverseComplemented) {
<span class="nc bnc" id="L230" title="All 2 branches missed.">			if(filter.accept(contigId)){</span>
<span class="nc" id="L231">				return new AbstractAceContigBuilderVisitor(contigId, numberOfBases, numberOfReads) {</span>
					
					@Override
					protected void visitContig(AceContigBuilder builder) {
<span class="nc" id="L235">						totalNumberOfReads += builder.numberOfReads();</span>
<span class="nc" id="L236">						map.put(contigId, builder.build());</span>
						
<span class="nc" id="L238">					}</span>
				};
			}
			//skip 
<span class="nc" id="L242">			return null;</span>
		}

		@Override
		public void visitReadTag(String id, String type, String creator,
				long gappedStart, long gappedEnd, Date creationDate,
				boolean isTransient) {
<span class="nc" id="L249">			readTags.add(new ReadAceTag(id, type, creator, creationDate, </span>
<span class="nc" id="L250">                    Range.of(gappedStart,gappedEnd), isTransient));</span>
			
<span class="nc" id="L252">		}</span>

		@Override
		public AceConsensusTagVisitor visitConsensusTag(String id, String type,
				String creator, long gappedStart, long gappedEnd,
				Date creationDate, boolean isTransient) {
<span class="nc bnc" id="L258" title="All 2 branches missed.">			if(filter.accept(id)){</span>
<span class="nc" id="L259">				return new AbstractAceConsensusTagVisitor(id, type,creator, </span>
<span class="nc" id="L260">						gappedStart, gappedEnd, creationDate, isTransient) {</span>
					
					@Override
					protected void visitConsensusTag(ConsensusAceTag consensusTag) {
<span class="nc" id="L264">						consensusTags.add(consensusTag);						</span>
<span class="nc" id="L265">					}</span>
				};
			}
			//skip
<span class="nc" id="L269">			return null;</span>
		}

		@Override
		public void visitWholeAssemblyTag(String type, String creator,
				Date creationDate, String data) {
<span class="nc" id="L275">			wholeAssemblyTags.add(new WholeAssemblyAceTag(type, creator, creationDate, data.trim()));</span>
			
<span class="nc" id="L277">		}</span>

		@Override
		public void visitEnd() {
<span class="nc" id="L281">			completed = true;			</span>
<span class="nc" id="L282">		}</span>

		@Override
		public void halted() {
			//no-op			
<span class="nc" id="L287">		}		</span>
	}    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>