<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BasicChromatogramBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">92_jcvi-javacommon</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.internal.trace.chromat</a> &gt; <span class="el_source">BasicChromatogramBuilder.java</span></div><h1>BasicChromatogramBuilder.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2013 J. Craig Venter Institute.
 * 	This file is part of Jillion
 * 
 * 	 Jillion is free software: you can redistribute it and/or modify
 * 	it under the terms of the GNU General Public License as published by
 * 	the Free Software Foundation, either version 3 of the License, or
 * 	(at your option) any later version.
 * 	
 * 	 Jillion is distributed in the hope that it will be useful,
 * 	but WITHOUT ANY WARRANTY; without even the implied warranty of
 * 	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * 	GNU General Public License for more details.
 * 	
 * 	You should have received a copy of the GNU General Public License
 * 	along with  Jillion.  If not, see http://www.gnu.org/licenses
 * 
 * Contributors:
 *     Danny Katzel - initial API and implementation
 ******************************************************************************/
/*
 * Created on Jan 8, 2009
 *
 * @author dkatzel
 */
package org.jcvi.jillion.internal.trace.chromat;

import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.Map.Entry;

import org.jcvi.jillion.core.pos.PositionSequence;
import org.jcvi.jillion.core.qual.PhredQuality;
import org.jcvi.jillion.core.qual.QualitySequence;
import org.jcvi.jillion.core.qual.QualitySequenceBuilder;
import org.jcvi.jillion.core.residue.nt.Nucleotide;
import org.jcvi.jillion.core.residue.nt.NucleotideSequence;
import org.jcvi.jillion.trace.chromat.ChannelGroup;
import org.jcvi.jillion.trace.chromat.Chromatogram;

public final class BasicChromatogramBuilder {
    
<span class="nc" id="L44">    private static final byte[] EMPTY_BYTE_ARRAY = new byte[]{};</span>
        private PositionSequence peaks;
        private NucleotideSequence basecalls;
        //default to empty confidences (which may happen if read is really
        //trashy
<span class="nc" id="L49">        private byte[] aConfidence=EMPTY_BYTE_ARRAY;</span>
<span class="nc" id="L50">        private byte[] cConfidence=EMPTY_BYTE_ARRAY;</span>
<span class="nc" id="L51">        private byte[] gConfidence=EMPTY_BYTE_ARRAY;</span>
<span class="nc" id="L52">        private byte[] tConfidence=EMPTY_BYTE_ARRAY;</span>

        private short[] aPositions;
        private short[] cPositions;
        private short[] gPositions;
        private short[] tPositions;

        private Map&lt;String,String&gt; properties;
        
        private String id;
        /**
         * Set the id of this Builder.
         * @param id the id of this Builder; can not be null.
         * @throws NullPointerException if id is null.
         */
<span class="nc" id="L67">        public BasicChromatogramBuilder(String id){</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        	if(id ==null){</span>
<span class="nc" id="L69">        		throw new NullPointerException(&quot;id can not be null&quot;);</span>
        	}
<span class="nc" id="L71">        	this.id=id;</span>
<span class="nc" id="L72">        }</span>
        /**
         * Builds a builder starting with the following default values.
         * @param basecalls the basecalls may be null.
         * @param peaks the peaks cannot be null.
         * @param channelGroup the channel group containing
         *  position and confidence data on all 4 channels can not be null.
         * @param properties the properties may be null.
         */
        private BasicChromatogramBuilder(String id, NucleotideSequence basecalls,
<span class="nc" id="L82">        		PositionSequence peaks, ChannelGroup channelGroup, Map&lt;String,String&gt; properties){</span>
<span class="nc" id="L83">            id(id);</span>
<span class="nc" id="L84">        	basecalls(basecalls);</span>
<span class="nc" id="L85">            peaks(peaks);</span>
<span class="nc" id="L86">            channelGroup(channelGroup);           </span>
<span class="nc" id="L87">            properties(properties);</span>
<span class="nc" id="L88">        }</span>
        
        private void channelGroup(ChannelGroup channelGroup){
<span class="nc" id="L91">        	 aConfidence =toByteArray(channelGroup.getAChannel().getConfidence());</span>
<span class="nc" id="L92">             aPositions =channelGroup.getAChannel().getPositions().toArray();            </span>
<span class="nc" id="L93">             cConfidence= toByteArray(channelGroup.getCChannel().getConfidence());</span>
<span class="nc" id="L94">             cPositions = channelGroup.getCChannel().getPositions().toArray();</span>
<span class="nc" id="L95">             gConfidence = toByteArray(channelGroup.getGChannel().getConfidence());</span>
<span class="nc" id="L96">             gPositions = channelGroup.getGChannel().getPositions().toArray();</span>
<span class="nc" id="L97">             tConfidence =toByteArray(channelGroup.getTChannel().getConfidence());</span>
<span class="nc" id="L98">             tPositions = channelGroup.getTChannel().getPositions().toArray();</span>
<span class="nc" id="L99">        }</span>
        private byte[] toByteArray(QualitySequence sequence){
<span class="nc" id="L101">        	byte[] array = new byte[(int)sequence.getLength()];</span>
<span class="nc" id="L102">        	int i=0;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">        	for(PhredQuality q : sequence){</span>
<span class="nc" id="L104">        		array[i]=q.getQualityScore();</span>
<span class="nc" id="L105">        		i++;</span>
<span class="nc" id="L106">        	}</span>
<span class="nc" id="L107">        	return array;</span>
        }
        
       
        
        public BasicChromatogramBuilder(Chromatogram copy){
<span class="nc" id="L113">		       this(copy.getId(), copy.getNucleotideSequence(),</span>
<span class="nc" id="L114">		       copy.getPositionSequence(),</span>
<span class="nc" id="L115">		       copy.getChannelGroup(),</span>
<span class="nc" id="L116">		       copy.getComments()</span>
		       );
        
<span class="nc" id="L119">        }</span>
        public final PositionSequence peaks() {
<span class="nc" id="L121">            return peaks;</span>
        }

        public final BasicChromatogramBuilder peaks(PositionSequence peaks) {
<span class="nc" id="L125">            this.peaks = peaks;</span>
<span class="nc" id="L126">            return this;</span>
        }
        public final String id(){
<span class="nc" id="L129">        	return id;</span>
        }
        
        public BasicChromatogramBuilder id(String id){
<span class="nc bnc" id="L133" title="All 2 branches missed.">        	if(id ==null){</span>
<span class="nc" id="L134">        		throw new NullPointerException(&quot;id can not be null&quot;);</span>
        	}
<span class="nc" id="L136">        	this.id = id;</span>
<span class="nc" id="L137">        	return this;</span>
        }
        public NucleotideSequence basecalls() {
<span class="nc" id="L140">            return basecalls;</span>
        }

        public BasicChromatogramBuilder basecalls(NucleotideSequence basecalls) {
<span class="nc" id="L144">            this.basecalls = basecalls;</span>
<span class="nc" id="L145">            return this;</span>
        }

        public byte[] aConfidence() {
<span class="nc" id="L149">            return Arrays.copyOf(aConfidence, aConfidence.length);</span>
        }

        public final BasicChromatogramBuilder aConfidence(byte[] confidence) {
<span class="nc" id="L153">            aConfidence = Arrays.copyOf(confidence, confidence.length);</span>
<span class="nc" id="L154">            return this;</span>
        }

        public byte[] cConfidence() {
<span class="nc" id="L158">            return Arrays.copyOf(cConfidence, cConfidence.length);</span>
        }

        public BasicChromatogramBuilder cConfidence(byte[] confidence) {
<span class="nc" id="L162">            cConfidence = Arrays.copyOf(confidence, confidence.length);</span>
<span class="nc" id="L163">            return this;</span>
        }

        public byte[] gConfidence() {
<span class="nc" id="L167">            return Arrays.copyOf(gConfidence, gConfidence.length);</span>
        }

        public BasicChromatogramBuilder gConfidence(byte[] confidence) {
<span class="nc" id="L171">            gConfidence = Arrays.copyOf(confidence, confidence.length);</span>
<span class="nc" id="L172">            return this;</span>
        }

        public byte[] tConfidence() {
<span class="nc" id="L176">            return Arrays.copyOf(tConfidence, tConfidence.length);</span>
        }

        public BasicChromatogramBuilder tConfidence(byte[] confidence) {
<span class="nc" id="L180">            tConfidence = Arrays.copyOf(confidence, confidence.length);</span>
<span class="nc" id="L181">            return this;</span>
        }

        public short[] aPositions() {
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if(aPositions ==null){</span>
<span class="nc" id="L186">                return new short[]{};</span>
            }
<span class="nc" id="L188">            return Arrays.copyOf(aPositions, aPositions.length);</span>
        }

        public BasicChromatogramBuilder aPositions(short[] positions) {
<span class="nc" id="L192">            aPositions = Arrays.copyOf(positions, positions.length);</span>
<span class="nc" id="L193">            return this;</span>
        }

        public short[] cPositions() {
<span class="nc bnc" id="L197" title="All 2 branches missed.">            if(cPositions ==null){</span>
<span class="nc" id="L198">                return new short[]{};</span>
            }
<span class="nc" id="L200">            return Arrays.copyOf(cPositions, cPositions.length);</span>
        }

        public BasicChromatogramBuilder cPositions(short[] positions) {
<span class="nc" id="L204">            cPositions = Arrays.copyOf(positions, positions.length);</span>
<span class="nc" id="L205">            return this;</span>
        }

        public short[] gPositions() {
<span class="nc bnc" id="L209" title="All 2 branches missed.">            if(gPositions ==null){</span>
<span class="nc" id="L210">                return new short[]{};</span>
            }
<span class="nc" id="L212">            return Arrays.copyOf(gPositions, gPositions.length);</span>
        }

        public BasicChromatogramBuilder gPositions(short[] positions) {
<span class="nc" id="L216">            gPositions = Arrays.copyOf(positions, positions.length);</span>
<span class="nc" id="L217">            return this;</span>
        }

        public short[] tPositions() {
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if(tPositions ==null){</span>
<span class="nc" id="L222">                return new short[]{};</span>
            }
<span class="nc" id="L224">            return Arrays.copyOf(tPositions, tPositions.length);</span>
        }

        public BasicChromatogramBuilder tPositions(short[] positions) {
<span class="nc" id="L228">            tPositions = Arrays.copyOf(positions, positions.length);</span>
<span class="nc" id="L229">            return this;</span>
        }

        public Map&lt;String,String&gt; properties() {
<span class="nc bnc" id="L233" title="All 2 branches missed.">            return properties ==null? null :new HashMap&lt;String, String&gt;(properties);</span>
        }

        public BasicChromatogramBuilder properties(Map&lt;String,String&gt; properties) {
<span class="nc" id="L237">            this.properties = new HashMap&lt;String, String&gt;();</span>
            //need to manually add properties because default implementation
            //is to use input as &quot;default&quot; but will return empty map!!!
<span class="nc bnc" id="L240" title="All 2 branches missed.">            for(Entry&lt;String,String&gt; entry : properties.entrySet()){</span>
<span class="nc" id="L241">                this.properties.put(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L242">            }</span>
<span class="nc" id="L243">            return this;</span>
        }

        private QualitySequence generateQualities(ChannelGroup channelGroup) {
<span class="nc" id="L247">        	int length = (int)basecalls.getLength();</span>
<span class="nc" id="L248">            QualitySequenceBuilder builder = new QualitySequenceBuilder(length);</span>
<span class="nc" id="L249">            int i=0;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            for(Nucleotide base : basecalls){</span>
<span class="nc" id="L251">            	QualitySequence qualitySequence = channelGroup.getChannel(base).getConfidence();</span>
            	//only read as many qualities as we have...
<span class="nc bnc" id="L253" title="All 2 branches missed.">                if(i == qualitySequence.getLength()){</span>
<span class="nc" id="L254">                	break;</span>
                }
<span class="nc" id="L256">                builder.append(qualitySequence.get(i));</span>
<span class="nc" id="L257">                i++;</span>
<span class="nc" id="L258">            }            </span>
<span class="nc" id="L259">            return  builder.build();</span>
        }
        
        public Chromatogram build() {
<span class="nc" id="L263">            final ChannelGroup channelGroup = new DefaultChannelGroup(</span>
<span class="nc" id="L264">                    new DefaultChannel(aConfidence(),aPositions()),</span>
<span class="nc" id="L265">                    new DefaultChannel(cConfidence(),cPositions()),</span>
<span class="nc" id="L266">                    new DefaultChannel(gConfidence(),gPositions()),</span>
<span class="nc" id="L267">                    new DefaultChannel(tConfidence(),tPositions()));</span>
            
<span class="nc" id="L269">            return new BasicChromatogram(id,</span>
<span class="nc" id="L270">                    basecalls(),</span>
<span class="nc" id="L271">                    generateQualities(channelGroup),                        </span>
<span class="nc" id="L272">                        peaks(),</span>
                    channelGroup,
<span class="nc" id="L274">                    properties());</span>
        }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>