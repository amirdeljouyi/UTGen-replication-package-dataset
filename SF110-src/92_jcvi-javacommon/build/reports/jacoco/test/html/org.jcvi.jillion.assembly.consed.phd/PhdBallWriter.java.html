<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PhdBallWriter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">92_jcvi-javacommon</a> &gt; <a href="index.source.html" class="el_package">org.jcvi.jillion.assembly.consed.phd</a> &gt; <span class="el_source">PhdBallWriter.java</span></div><h1>PhdBallWriter.java</h1><pre class="source lang-java linenums">package org.jcvi.jillion.assembly.consed.phd;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.io.Writer;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;
import java.util.Scanner;

import org.jcvi.jillion.core.Range;
import org.jcvi.jillion.core.io.IOUtil;
import org.jcvi.jillion.core.pos.PositionSequence;
import org.jcvi.jillion.core.qual.PhredQuality;
import org.jcvi.jillion.core.residue.nt.Nucleotide;
import org.jcvi.jillion.core.residue.nt.NucleotideSequence;
import org.jcvi.jillion.core.util.JoinedStringBuilder;

public class PhdBallWriter implements PhdWriter{

	 private static final String BEGIN_SEQUENCE = &quot;BEGIN_SEQUENCE&quot;;
	    private static final String BEGIN_COMMENT = &quot;BEGIN_COMMENT&quot;;
	    private static final String END_SEQUENCE = &quot;END_SEQUENCE&quot;;
	    private static final String END_COMMENT = &quot;END_COMMENT&quot;;
	    
	    private static final String BEGIN_DNA = &quot;BEGIN_DNA&quot;;
	    private static final String END_DNA = &quot;END_DNA&quot;;
	    
	    private static final String BEGIN_TAG = &quot;BEGIN_TAG\n&quot;;
	    private static final String END_TAG = &quot;END_TAG\n&quot;;

<span class="nc" id="L37">	    private static final String NEW_LINE = String.format(&quot;%n&quot;);</span>
	
	private final Writer writer;
	/**
	 * Create a new {@link PhdBallWriter} instance
	 * that will write its contents to the given {@link OutputStream}.
	 * @param out the {@link OutputStream} to write to;
	 * can not be null.  
	 * @throws NullPointerException if outputFile is null.
	 */
	public PhdBallWriter(OutputStream out) throws IOException{
<span class="nc" id="L48">		this(out, null);</span>
<span class="nc" id="L49">	}</span>
	/**
	 * Create a new {@link PhdBallWriter} instance
	 * that will write its contents to the given {@link OutputStream}.
	 * @param out the {@link OutputStream} to write to;
	 * can not be null.  
	 * @param fileComment a comment String to be written
	 * at the top of the phdball; Should only be 
	 * one line. The writer will format the comment
	 * so phd's know that it is a comment.  If fileComment
	 * is null, then no comment will be written.
	 * @throws NullPointerException if outputFile is null.
	 * @throws IllegalArgumentException if fileComment is more
	 * than one line.
	 * @throws IOException if there are problems writing
	 * the fileComment to the outputStream.
	 */
<span class="nc" id="L66">	public PhdBallWriter(OutputStream out, String fileComment) throws IOException{</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">		if(out ==null){</span>
<span class="nc" id="L68">			throw new NullPointerException(&quot;output stream can not be null&quot;);</span>
		}
<span class="nc" id="L70">		assertCommentIsOnlyOneLine(fileComment);</span>
<span class="nc" id="L71">		this.writer = new BufferedWriter(new OutputStreamWriter(out, IOUtil.UTF_8));</span>
<span class="nc" id="L72">		writer.write(String.format(&quot;#%s%n&quot;, fileComment));</span>
<span class="nc" id="L73">	}</span>
	/**
	 * Create a new {@link PhdBallWriter} instance
	 * that will write its contents to the given file.
	 * @param outputFile the {@link File} to write to;
	 * can not be null.  If this file already exists,
	 * then it will be overwritten.  If the File does
	 * not exist it will be created along with any non-existent
	 * parent directories.
	 * @param fileComment a comment String to be written
	 * at the top of the phdball; Should only be 
	 * one line. The writer will format the comment
	 * so phd's know that it is a comment.  If fileComment
	 * is null, then no comment will be written.
	 * @throws IOException if there is a problem creating
	 * the file or writing the fileComment (if non-null).
	 * @throws NullPointerException if outputFile is null.
	 * @throws IllegalArgumentException if fileComment is more
	 * than one line.
	 */
<span class="nc" id="L93">	public PhdBallWriter(File outputFile, String fileComment) throws IOException{</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if(outputFile ==null){</span>
<span class="nc" id="L95">			throw new NullPointerException(&quot;output file can not be null&quot;);</span>
		}
<span class="nc" id="L97">		assertCommentIsOnlyOneLine(fileComment);</span>
<span class="nc" id="L98">		IOUtil.mkdirs(outputFile.getParentFile());</span>
<span class="nc" id="L99">		this.writer = new BufferedWriter(</span>
				new OutputStreamWriter(new FileOutputStream(outputFile), IOUtil.UTF_8));
<span class="nc" id="L101">		writer.write(String.format(&quot;#%s%n&quot;, fileComment));</span>
<span class="nc" id="L102">	}</span>
	
	private void assertCommentIsOnlyOneLine(String fileComment){
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if(fileComment !=null){</span>
<span class="nc" id="L106">			Scanner scanner = new Scanner(fileComment);</span>
<span class="nc" id="L107">			scanner.nextLine();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			if(scanner.hasNext()){</span>
<span class="nc" id="L109">				throw new IllegalArgumentException(&quot;fileComment can not be multi-line&quot;);</span>
			}
		}
<span class="nc" id="L112">	}</span>
	/**
	 * Create a new {@link PhdBallWriter} instance
	 * that will write its contents to the given file.
	 * @param outputFile the {@link File} to write to;
	 * can not be null.  If this file already exists,
	 * then it will be overwritten.  If the File does
	 * not exist it will be created along with any non-existent
	 * parent directories.
	 * @throws IOException if there is a problem creating
	 * the file.  
	 * @throws NullPointerException if outputFile is null.
	 */
	public PhdBallWriter(File outputFile) throws IOException{
<span class="nc" id="L126">		this(outputFile, null);</span>
<span class="nc" id="L127">	}</span>

	@Override
	public void close() throws IOException {
<span class="nc" id="L131">		writer.close();</span>
		
<span class="nc" id="L133">	}</span>

	@Override
	public void write(Phd phd) throws IOException {
<span class="nc" id="L137">		write(phd, null);</span>
		
<span class="nc" id="L139">	}</span>

	@Override
	public void write(Phd phd, Integer version) throws IOException {
<span class="nc bnc" id="L143" title="All 2 branches missed.">		if(phd ==null){</span>
<span class="nc" id="L144">			throw new NullPointerException(&quot;phd can not be null&quot;);</span>
		}
<span class="nc bnc" id="L146" title="All 4 branches missed.">		if(version !=null &amp;&amp; version.intValue() &lt;1){</span>
<span class="nc" id="L147">			throw new IllegalArgumentException(&quot;version must be &gt;=1&quot;);</span>
		}
<span class="nc" id="L149">		writePhd(phd, version);</span>
		
<span class="nc" id="L151">	}</span>
	
	
	    private void writePhd(Phd phd, Integer version) throws IOException{
	        try{
<span class="nc" id="L156">	            StringBuilder phdRecord = new StringBuilder();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">	            if(version ==null){</span>
<span class="nc" id="L158">	            	phdRecord.append( String.format(&quot;%s %s%n%n&quot;,BEGIN_SEQUENCE, phd.getId()));</span>
	            }else{
<span class="nc" id="L160">	            	phdRecord.append( String.format(&quot;%s %s %d%n%n&quot;,BEGIN_SEQUENCE, phd.getId(),version));</span>
	            }
<span class="nc" id="L162">	            phdRecord.append(createComments(phd));</span>
<span class="nc" id="L163">	            phdRecord.append(writeDnaSection(phd));</span>
<span class="nc" id="L164">	            phdRecord.append(NEW_LINE);</span>
<span class="nc" id="L165">	            List&lt;PhdReadTag&gt; tags = phd.getReadTags();</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">	            if(!tags.isEmpty()){</span>
<span class="nc" id="L167">	            	 phdRecord.append(writeReadTags(tags));</span>
	            }
<span class="nc" id="L169">	            phdRecord.append(String.format(&quot;%s%n&quot;,END_SEQUENCE));</span>
<span class="nc" id="L170">	            phdRecord.append(createWholeReadItems(phd));</span>
<span class="nc" id="L171">	            writer.write(phdRecord.toString());</span>
<span class="nc" id="L172">	        }catch(Throwable t){</span>
<span class="nc" id="L173">	            throw new IOException(&quot;error writing phd record for &quot;+phd.getId(), t);</span>
<span class="nc" id="L174">	        }</span>
	        
<span class="nc" id="L176">	    }</span>
	    

	    private String writeReadTags(List&lt;PhdReadTag&gt; tags) {
<span class="nc" id="L180">			List&lt;String&gt; printedTags = new ArrayList&lt;String&gt;(tags.size());</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">	    	for(PhdReadTag tag : tags){</span>
<span class="nc" id="L182">				StringBuilder builder = new StringBuilder(500);</span>
<span class="nc" id="L183">				builder.append(BEGIN_TAG)</span>
<span class="nc" id="L184">					.append(String.format(&quot;TYPE:%s%n&quot;,tag.getType()))</span>
<span class="nc" id="L185">					.append(String.format(&quot;SOURCE:%s%n&quot;,tag.getSource()));</span>
<span class="nc" id="L186">				Range range = tag.getUngappedRange();</span>
<span class="nc" id="L187">				builder.append(String.format(&quot;UNGAPPED_READ_POS:%d %d%n&quot;,</span>
<span class="nc" id="L188">						range.getBegin(Range.CoordinateSystem.RESIDUE_BASED),</span>
<span class="nc" id="L189">						range.getEnd(Range.CoordinateSystem.RESIDUE_BASED)));</span>
				
<span class="nc" id="L191">				builder.append(String.format(&quot;DATE: %s%n&quot;, PhdUtil.formatReadTagDate(tag.getDate())));</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">				if(tag.getComment() !=null){</span>
<span class="nc" id="L193">					builder.append(BEGIN_COMMENT).append(NEW_LINE);</span>
<span class="nc" id="L194">					builder.append(tag.getComment());</span>
<span class="nc" id="L195">					builder.append(END_COMMENT).append(NEW_LINE);</span>
				}
<span class="nc bnc" id="L197" title="All 2 branches missed.">				if(tag.getFreeFormData() !=null){</span>
<span class="nc" id="L198">					builder.append(tag.getFreeFormData());</span>
				}
<span class="nc" id="L200">				builder.append(END_TAG);</span>
<span class="nc" id="L201">				printedTags.add(builder.toString());</span>
<span class="nc" id="L202">			}</span>
<span class="nc" id="L203">			return new JoinedStringBuilder(printedTags)</span>
<span class="nc" id="L204">						.glue(NEW_LINE)</span>
<span class="nc" id="L205">						.build();</span>
		}
		private StringBuilder createWholeReadItems(Phd phd) {
<span class="nc" id="L208">	        StringBuilder tags = new StringBuilder();</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">	        for(PhdWholeReadItem tag : phd.getWholeReadItems()){</span>
<span class="nc" id="L210">	        	String lines = new JoinedStringBuilder(tag.getLines())</span>
<span class="nc" id="L211">	        						.glue(NEW_LINE)</span>
<span class="nc" id="L212">	        						.build();</span>
<span class="nc" id="L213">	            tags.append(String.format(&quot;WR{%n%s%n}%n&quot;,lines));</span>
<span class="nc" id="L214">	        }</span>
<span class="nc" id="L215">	        return tags;</span>
	        
	        
	    }

	    private StringBuilder writeDnaSection(Phd phd) {
<span class="nc" id="L221">	        StringBuilder dna = new StringBuilder();</span>
<span class="nc" id="L222">	        dna.append(String.format(&quot;%s%n&quot;,BEGIN_DNA));</span>
<span class="nc" id="L223">	        dna.append(writeCalledInfo(phd));</span>
<span class="nc" id="L224">	        dna.append(String.format(&quot;%s%n&quot;,END_DNA));   </span>
<span class="nc" id="L225">	        return dna;</span>
	    }

	    private StringBuilder writeCalledInfo( Phd phd){
	       
<span class="nc" id="L230">	        NucleotideSequence nucleotideSequence = phd.getNucleotideSequence();</span>
<span class="nc" id="L231">	        int seqLength = (int)nucleotideSequence.getLength();</span>
<span class="nc" id="L232">			Iterator&lt;Nucleotide&gt; basesIter = nucleotideSequence.iterator();</span>
<span class="nc" id="L233">	        Iterator&lt;PhredQuality&gt; qualIter = phd.getQualitySequence().iterator();</span>
	       
<span class="nc" id="L235">	        PositionSequence peaks = phd.getPositionSequence();</span>
<span class="nc" id="L236">	        StringBuilder result = new StringBuilder(seqLength *10);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">	        if(peaks==null){</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">	            while(basesIter.hasNext()){</span>
<span class="nc" id="L239">	            	result.append(String.format(&quot;%s %d%n&quot;,</span>
<span class="nc" id="L240">	            			basesIter.next(), </span>
<span class="nc" id="L241">	                        qualIter.next().getQualityScore()));</span>
	            }
	        }else{
	        	 //optimization to convert to array instead 
	            //of iterating over Position objects
	            //this way we get primitives.
<span class="nc" id="L247">	        	short[] positions = phd.getPositionSequence().toArray();</span>
<span class="nc" id="L248">	        	int i=0;</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">	            while(basesIter.hasNext()){</span>
<span class="nc" id="L250">	            	result.append(String.format(&quot;%s %d %d%n&quot;,</span>
<span class="nc" id="L251">	            			basesIter.next(), </span>
<span class="nc" id="L252">	                        qualIter.next().getQualityScore(),</span>
<span class="nc" id="L253">	                        IOUtil.toUnsignedShort(positions[i])));</span>
<span class="nc" id="L254">	            	i++;</span>
	            }
	        }
	       
<span class="nc" id="L258">	        return result;</span>
	        
	    }

	    private StringBuilder createComments(Phd phd) {
<span class="nc" id="L263">	        StringBuilder comments = new StringBuilder();</span>
	        
<span class="nc" id="L265">	        comments.append(BEGIN_COMMENT);</span>
<span class="nc" id="L266">	        comments.append(NEW_LINE);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">	        for(Entry&lt;String, String&gt; entry :phd.getComments().entrySet()){</span>
<span class="nc" id="L268">	            comments.append(String.format(&quot;%s: %s%n&quot;,entry.getKey(),entry.getValue()));</span>
<span class="nc" id="L269">	        }</span>
<span class="nc" id="L270">	        comments.append(END_COMMENT);</span>
<span class="nc" id="L271">	        comments.append(NEW_LINE);</span>
<span class="nc" id="L272">	        return comments;</span>
	    }
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>