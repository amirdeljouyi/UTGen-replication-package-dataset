<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Run.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">29_apbsmem</a> &gt; <a href="index.source.html" class="el_package">apbs_mem_gui</a> &gt; <span class="el_source">Run.java</span></div><h1>Run.java</h1><pre class="source lang-java linenums">/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

package apbs_mem_gui;

import jahuwaldt.plot.PlotWindow;
import javax.swing.*;
import java.text.NumberFormat;
import java.text.DecimalFormat;

import java.io.File;
import java.io.PrintWriter;
import java.io.FileOutputStream;
import org.jmol.api.JmolViewer;
/**
 *
 * @author Keith Callenberg
 */
public class Run implements Runnable{

<span class="nc" id="L23">    Exec exec = new Exec();</span>
<span class="nc" id="L24">    FileEditor file = new FileEditor();</span>
    InFile in;
    File ofile;
    PrintWriter outFile;
    JmolViewer viewer;
    Main p;
    JProgressBar pb;
    boolean dp, preview;
    String pc;

<span class="nc" id="L34">    public Run(Main parent, InFile i, File of, JmolViewer view, JProgressBar pBar, boolean drawp, String potc, boolean prev) {</span>
<span class="nc" id="L35">        p = parent;</span>
<span class="nc" id="L36">        in = i;</span>
<span class="nc" id="L37">        ofile = of;</span>
<span class="nc" id="L38">        viewer = view;</span>
<span class="nc" id="L39">        pb = pBar;</span>
<span class="nc" id="L40">        dp = drawp;</span>
<span class="nc" id="L41">        pc = potc;</span>
<span class="nc" id="L42">        preview = prev;</span>
<span class="nc" id="L43">    }</span>

    /**
     * Method for running an APBSmem calculation.
     */
    public void run() {
<span class="nc" id="L49">        Double isovalue = Double.valueOf(in.getMdie()) + 0.001;</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        if(preview) {</span>
<span class="nc" id="L51">            pb.setValue(10);</span>

<span class="nc" id="L53">            int ttype = in.getType();</span>
<span class="nc" id="L54">            int tfocus = in.getMaxfocus();</span>

<span class="nc" id="L56">            in.setType(0); // we set all types to prot solv when doing a quick preview</span>
<span class="nc" id="L57">            in.setMaxFocus(0);</span>


<span class="nc" id="L60">            p.SaveToFile(true);</span>

<span class="nc" id="L62">            exec.callAPBS(ofile.getPath() + &quot;.dummy&quot;);</span>
<span class="nc" id="L63">            pb.setValue(50);</span>

<span class="nc" id="L65">            exec.callDrawMem(new String(&quot;dielx_1&quot;), in.getZmem(), in.getLmem(), in.getProteinDi(), in.getSolventDi(), in.getMdie(), in.getIdie(), &quot;0&quot;,</span>
<span class="nc" id="L66">                in.getCountIon1(), in.getGeo1(), in.getGeo2(), in.getGeo3());</span>

<span class="nc" id="L68">            pb.setValue(90);</span>
<span class="nc" id="L69">            viewer.evalString(&quot;isosurface delete&quot;);</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (fileExists(&quot;dielx_1m.dx&quot;))</span>
<span class="nc" id="L71">                viewer.evalString(&quot;isosurface &quot; + p.getIsocontour() + &quot; \&quot;dielx_1m.dx\&quot;; color isoSurface white translucent&quot;);</span>
            else
<span class="nc" id="L73">                JOptionPane.showMessageDialog(null, &quot;Error: an error occurred while writing the modified dielectric maps.&quot;, &quot;Error&quot;, JOptionPane.ERROR_MESSAGE);</span>

            //revert to previous calculation type
<span class="nc" id="L76">            in.setType(ttype);</span>
<span class="nc" id="L77">            in.setMaxFocus(tfocus);</span>
<span class="nc" id="L78">            pb.setValue(0);</span>
<span class="nc" id="L79">        }</span>
        else {
            // A regular calculation -- Not preview mode
<span class="nc" id="L82">            pb.setValue(1);</span>
<span class="nc" id="L83">            int mf = in.getMaxfocus();</span>
<span class="nc" id="L84">            SaveToFile(true);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            if (in.getType() == 2) {</span>
                //GATING CHARGE CALCULATION
<span class="nc" id="L87">                double tempPot = Double.parseDouble(in.getPotential());</span>

<span class="nc" id="L89">                double[] memv = new double[4];</span>
<span class="nc" id="L90">                double[] memvkt = new double[4];</span>
                //double half = Math.floor((tempPot/2)+0.5);
<span class="nc" id="L92">                double half = tempPot/2;</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                if(tempPot &gt; 0) {</span>
<span class="nc" id="L94">                    memv[0] = -(tempPot);</span>
<span class="nc" id="L95">                    memv[1] = -half;</span>
                    //memv[2] = 0;
<span class="nc" id="L97">                    memv[2] = half;</span>
<span class="nc" id="L98">                    memv[3] = tempPot;</span>
                }
                else {
<span class="nc" id="L101">                    memv[0] = tempPot;</span>
<span class="nc" id="L102">                    memv[1] = half;</span>
                    //memv[2] = 0;
<span class="nc" id="L104">                    memv[2] = -half;</span>
<span class="nc" id="L105">                    memv[3] = -(tempPot);</span>
                }
<span class="nc" id="L107">                pb.setValue(5);</span>

<span class="nc" id="L109">                double[] finalenergy = new double[memv.length];</span>
<span class="nc" id="L110">                double[] tempenergies = new double[6];</span>
<span class="nc" id="L111">                Double ktconv = Double.parseDouble(in.getTemp()) * 0.008314472; //conversion from kJ to kBT</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                for(int j=0; j &lt; memv.length; j++) {</span>

<span class="nc" id="L114">                    exec.callAPBS(ofile.getPath() + &quot;.dummy&quot;);		//now run apbs</span>

<span class="nc bnc" id="L116" title="All 2 branches missed.">                    for (int i = 0; i &lt;= (mf+1)*2; i++) {</span>
                        //create dielectric maps
<span class="nc" id="L118">                        exec.callDrawMem(new String(&quot;dielx_&quot; + Integer.toString(i+1)), in.getZmem(), in.getLmem(), in.getProteinDi(), in.getSolventDi(), in.getMdie(), in.getIdie(), Double.toString(memv[j]),</span>
<span class="nc" id="L119">                            in.getCountIon1(), in.getGeo1(), in.getGeo2(), in.getGeo3());</span>
                    }


<span class="nc" id="L123">                    in.setPotential(Double.toString(memv[j]));</span>
                    //save all data to file for second (solv) run
<span class="nc" id="L125">                    SaveToFile(false);</span>
<span class="nc" id="L126">                    exec.callAPBS(ofile.getPath() + &quot;.solv&quot;);	//run apbs again</span>
<span class="nc" id="L127">                    pb.setValue(10+(j*10));</span>
<span class="nc" id="L128">                    exec.callPullcomps(ofile.getPath() + &quot;.solv.out&quot;); //pull the atom component energies and add them together for a total</span>

<span class="nc" id="L130">                    tempenergies = file.getCompEnergy(ofile.getParentFile().getParent() + &quot;/comps_temp&quot;);</span>

<span class="nc" id="L132">                    memvkt[j] = memv[j] * 25.69;</span>
<span class="nc" id="L133">                    p.log(&quot;Memv &quot; + Double.toString(memvkt[j]) + &quot; mV&quot;);</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">                    for(int k=0; k&lt;(mf+1)*2;k++) {</span>
<span class="nc" id="L136">                        p.log(Integer.toString(k) + &quot;: &quot; + tempenergies[k] + &quot; kJ, &quot; + tempenergies[k] / (ktconv) + &quot; kT&quot;);</span>
                    }

                    //we multiply by 2 since APBS divides by 2 to account for double counting for explicit charges
<span class="nc" id="L140">                    finalenergy[j] = 2 * (tempenergies[mf] - tempenergies[((mf+1)*2)-1]);</span>
<span class="nc" id="L141">                    p.log(&quot;Total 2*(file1-file2): &quot; + Double.toString(finalenergy[j]) + &quot; kJ, &quot; + (finalenergy[j] / (ktconv)) + &quot; kT\n&quot;);</span>

                }
<span class="nc" id="L144">                pb.setValue(60);</span>
<span class="nc" id="L145">                PlotWindow pw = new PlotWindow(&quot;Gating Charge Results&quot;);</span>
<span class="nc" id="L146">                pw.setSize(500, 300);</span>
<span class="nc" id="L147">                pw.setLocation(50,50);</span>
<span class="nc" id="L148">                pw.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span>
<span class="nc" id="L149">                pw.setData(memvkt, finalenergy);</span>
<span class="nc" id="L150">                pw.drawPlot(&quot;Gating Charge Results&quot;, &quot;Applied voltage [mV]&quot;, &quot;Energy [kT]&quot;);</span>
<span class="nc" id="L151">                pw.show();</span>
<span class="nc" id="L152">                pw.saveImage(ofile.getParent() + &quot;/gating_charge_plot.jpg&quot;);</span>

<span class="nc" id="L154">                NumberFormat ftr = new DecimalFormat(&quot;0.####E0&quot;);</span>
<span class="nc" id="L155">                double slope = ((finalenergy[memv.length-1] / (ktconv)) - (finalenergy[0] / (ktconv))) / 4;// (memv[3] - memv[0]);</span>
<span class="nc" id="L156">                pb.setValue(70);</span>
<span class="nc" id="L157">                JOptionPane.showMessageDialog(null, &quot;The slope is &quot; + ftr.format(slope) + &quot; e.\n Output has been saved as\n &quot; + ofile.getName() + &quot;/&quot; + ofile.getName() + &quot;.solv.out.&quot;, &quot;Calculation results&quot;, JOptionPane.PLAIN_MESSAGE);</span>
<span class="nc" id="L158">                p.log(&quot;Slope: &quot; + slope + &quot; e&quot;);</span>

<span class="nc" id="L160">                pb.setValue(0);</span>
<span class="nc" id="L161">            }</span>

            else {
<span class="nc" id="L164">                exec.callAPBS(ofile.getPath() + &quot;.dummy&quot;);		//now run apbs</span>
<span class="nc" id="L165">                pb.setValue(6);</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">                if (!fileExists(&quot;dielx_1.dx&quot;)){</span>
<span class="nc" id="L168">                    JOptionPane.showMessageDialog(null, &quot;Error: an error occurred while writing the first dielectric maps.&quot;, &quot;Error&quot;, JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L169">                    return;</span>
                }

                //protein solvation calculation type
<span class="nc bnc" id="L173" title="All 2 branches missed.">                if (in.getType() == 0) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                    for (int i = 0; i &lt;= mf; i++) {</span>
                        //create dielectric maps
<span class="nc" id="L176">                        exec.callDrawMem(new String(&quot;dielx_&quot; + Integer.toString(i+1)), in.getZmem(), in.getLmem(),</span>
<span class="nc" id="L177">                            in.getProteinDi(), in.getSolventDi(), in.getMdie(), in.getIdie(), &quot;0&quot;,</span>
<span class="nc" id="L178">                            in.getCountIon1(), in.getGeo1(), in.getGeo2(), in.getGeo3());</span>
                    }
                }
                //ion solvation calculation
                else {
<span class="nc bnc" id="L183" title="All 2 branches missed.">                    for (int i = 0; i &lt;= (mf+1)*2; i++) {</span>
                        //create dielectric maps
<span class="nc" id="L185">                        exec.callDrawMem(new String(&quot;dielx_&quot; + Integer.toString(i+1)), in.getZmem(), in.getLmem(),</span>
<span class="nc" id="L186">                            in.getProteinDi(), in.getSolventDi(), in.getMdie(), in.getIdie(), &quot;0&quot;,</span>
<span class="nc" id="L187">                            in.getCountIon1(), in.getGeo1(), in.getGeo2(), in.getGeo3());</span>
                    }
                }

<span class="nc bnc" id="L191" title="All 2 branches missed.">                if (!fileExists(&quot;dielx_1m.dx&quot;)){</span>
<span class="nc" id="L192">                    JOptionPane.showMessageDialog(null, &quot;Error: an error occurred while writing the modified dielectric maps.&quot;, &quot;Error&quot;, JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L193">                    return;</span>
                }

<span class="nc" id="L196">                pb.setValue(50);</span>

<span class="nc" id="L198">                SaveToFile(false);			//save all data to file for second run</span>
<span class="nc" id="L199">                exec.callAPBS(ofile.getPath() + &quot;.solv&quot;);	//run apbs again</span>


<span class="nc" id="L202">                pb.setValue(80);</span>
<span class="nc" id="L203">                String[] theEnergy = file.getEnergy(ofile.getPath() + &quot;.solv.out&quot;);</span>


<span class="nc bnc" id="L206" title="All 2 branches missed.">                if (theEnergy[0] != null) {</span>
<span class="nc" id="L207">                    JOptionPane.showMessageDialog(null, &quot;ELEC energy result: \n&quot; + theEnergy[0] + &quot; = &quot; + theEnergy[1] + &quot; = &quot; + theEnergy[2] + &quot;.\n Output has been saved as &quot; + ofile.getName() + &quot;.solv.out.&quot;, &quot;Global net ELEC energy&quot;, JOptionPane.PLAIN_MESSAGE);</span>
                } else {
<span class="nc" id="L209">                    JOptionPane.showMessageDialog(null, &quot;Energy not found!&quot;, &quot;Global net ELEC energy&quot;, JOptionPane.PLAIN_MESSAGE);</span>
                }
<span class="nc" id="L211">                pb.setValue(0);</span>
            }
<span class="nc" id="L213">            viewer.evalString(&quot;isosurface delete;isosurface &quot; + p.getIsocontour() + &quot; \&quot;dielz_&quot; + (mf + 1) + &quot;m.dx\&quot;; color isosurface white translucent&quot;);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            if (dp) {</span>
<span class="nc" id="L215">                 viewer.evalString(&quot;isosurface potpos &quot; + pc + &quot; \&quot;pot_1.dx\&quot;; color isoSurface red translucent&quot;);</span>
<span class="nc" id="L216">                 viewer.evalString(&quot;isosurface potneg -&quot; + pc + &quot; \&quot;pot_1.dx\&quot;; color isoSurface blue translucent&quot;);</span>
            }
            // In the future, an option to save DX files would be great, but for now, let's leave this alone by default since they are so large
            //p.copyFiles(new File(&quot;.&quot;).getPath(), ofile.getParent(), &quot;.dx&quot;);
        }
<span class="nc" id="L221">    }</span>

    /**
     * This function writes the parameters stored in an inFile object to a file.
     * @param firstcall True if the calculation is a first &quot;dummy&quot; calculation for writing the DX files, otherwise false.
     */
    public void SaveToFile(boolean firstcall) //saves to file
    {
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (ofile != null) {</span>
            try {
<span class="nc bnc" id="L231" title="All 2 branches missed.">                if(firstcall) {</span>
<span class="nc" id="L232">                    outFile = new PrintWriter(new FileOutputStream(ofile.getPath() + &quot;.dummy.in&quot;));</span>
                }
		else {
<span class="nc" id="L235">                    outFile = new PrintWriter(new FileOutputStream(ofile.getPath() + &quot;.solv.in&quot;));</span>
                }
<span class="nc" id="L237">            } catch (Exception e1) {</span>
<span class="nc" id="L238">                System.out.print(e1.toString());</span>
<span class="nc" id="L239">            }</span>

<span class="nc" id="L241">            String tempIn = in.toString(firstcall);         //store data in temporary string</span>
<span class="nc" id="L242">            String[] tempInSplit = tempIn.split(&quot;\n&quot;);		//split data by each new line</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            for (int i = 0; i &lt; tempInSplit.length; i++) {</span>
<span class="nc" id="L244">                outFile.println(tempInSplit[i]);		//print data one line at a time</span>
            }
<span class="nc" id="L246">            outFile.close();</span>

        }
<span class="nc" id="L249">    }</span>

    public boolean fileExists(String f) {
<span class="nc" id="L252">            File check = new File(f);</span>
<span class="nc" id="L253">            return check.exists();</span>
    }



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>