<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleCombatant.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">79_twfbplayer</a> &gt; <a href="index.source.html" class="el_package">de.outstare.fortbattleplayer.model.impl</a> &gt; <span class="el_source">SimpleCombatant.java</span></div><h1>SimpleCombatant.java</h1><pre class="source lang-java linenums">package de.outstare.fortbattleplayer.model.impl;

/*
 Copyright (c) 2010 Daniel Raap

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the &quot;Software&quot;), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 */

import java.util.HashSet;
import java.util.Set;
import java.util.logging.Logger;

import de.outstare.fortbattleplayer.model.Area;
import de.outstare.fortbattleplayer.model.CharacterClass;
import de.outstare.fortbattleplayer.model.Combatant;
import de.outstare.fortbattleplayer.model.CombatantObserver;
import de.outstare.fortbattleplayer.model.CombatantSide;
import de.outstare.fortbattleplayer.model.CombatantState;
import de.outstare.fortbattleplayer.model.SectorBonus;
import de.outstare.fortbattleplayer.model.Weapon;
import de.outstare.fortbattleplayer.model.WeaponData;

/**
 * A Combatant with basic attributes (position, health)
 * 
 * @author daniel
 */
public class SimpleCombatant implements Combatant {
<span class="fc" id="L45">	private static final transient Logger LOG = Logger.getLogger(SimpleCombatant.class.getName());</span>
	private final int maxHealth;
	private final CombatantSide side;
	private final String name;
	private final String city;
<span class="nc" id="L50">	private final Set&lt;CombatantObserver&gt; observers = new HashSet&lt;CombatantObserver&gt;();</span>
<span class="nc" id="L51">	private final Object stateChangeLock = new Object();</span>
	private final CharacterClass charClass;
	private final Weapon weapon;
	private CombatantState state;
<span class="nc" id="L55">	private Combatant aimingAt = null;</span>

	/**
	 * Create a new {@link Combatant} at the given position and the given amount
	 * of health.
	 * 
	 * @param side
	 *            not null
	 * @param initialState
	 *            not null
	 * @param maxHealth
	 *            &gt; 0
	 * @param name
	 *            the name of the player of this Combatant
	 * @param characterClass
	 *            maybe null for old logs
	 * @param weapon
	 *            not null
	 * @param city
	 *            not null
	 */
	public SimpleCombatant(final CombatantSide side, final CombatantState initialState, final int maxHealth,
<span class="nc" id="L77">	        final String name, final CharacterClass characterClass, final Weapon weapon, final String city) {</span>
<span class="nc bnc" id="L78" title="All 8 branches missed.">		assert side != null &amp;&amp; initialState != null &amp;&amp; weapon != null &amp;&amp; city != null : &quot;parameters may not be null!&quot;;</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">		assert maxHealth &gt; 0 : &quot;health must be positive!&quot;;</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">		assert maxHealth &gt;= initialState.getHealth() &amp;&amp; initialState.getHealth() &gt; 0 : &quot;currentHealth must be inbetween 1 and max, is &quot;</span>
<span class="nc" id="L81">		        + initialState.getHealth();</span>

<span class="nc" id="L83">		this.side = side;</span>
<span class="nc" id="L84">		this.maxHealth = maxHealth;</span>
<span class="nc" id="L85">		this.name = name;</span>
<span class="nc" id="L86">		this.city = city;</span>
<span class="nc" id="L87">		state = initialState;</span>
<span class="nc" id="L88">		charClass = characterClass;</span>
<span class="nc" id="L89">		this.weapon = weapon;</span>

		// move to current location
<span class="nc" id="L92">		state.getPosition().occupy(this, null);</span>
<span class="nc" id="L93">	}</span>

	/**
	 * @see java.lang.Object#toString()
	 */
	@Override
	public String toString() {
<span class="nc" id="L100">		return getSide() + &quot; &quot; + name;</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#getName()
	 */
	public String getName() {
<span class="nc" id="L107">		return name;</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#getWeapon()
	 */
	public Weapon getWeapon() {
<span class="nc" id="L114">		return weapon;</span>
	}

	/**
	 * internal method for graphical display
	 * 
	 * @return the maximal health
	 */
	public int _getMaxLP() {
<span class="nc" id="L123">		return maxHealth;</span>
	}

	/**
	 * internal method for graphical display
	 * 
	 * @return the current health
	 */
	public int _getCurrentLP() {
<span class="nc" id="L132">		return state.getHealth();</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#move(de.outstare.fortbattleplayer.model.Area)
	 */
	public void move(final Area target) {
<span class="nc" id="L139">		LOG.fine(name + &quot; moving to &quot; + target);</span>
<span class="nc" id="L140">		synchronized (stateChangeLock) {</span>
<span class="nc" id="L141">			final Area oldPosition = state.getPosition();</span>
<span class="nc" id="L142">			moveAway(oldPosition);</span>
<span class="nc" id="L143">			state = state.changePosition(target);</span>
<span class="nc" id="L144">			final Combatant swapped = target.occupy(this, oldPosition);</span>
<span class="nc" id="L145">			fireHasMoved();</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (swapped != null) {</span>
<span class="nc" id="L147">				fireHasSwapped(swapped);</span>
			}
<span class="nc" id="L149">		}</span>
<span class="nc" id="L150">	}</span>

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#shoot(de.outstare.fortbattleplayer.model.Area)
	 */
	public void shoot(final int power) {
<span class="nc" id="L156">		LOG.fine(name + &quot; shooting with &quot; + power);</span>
<span class="nc" id="L157">		aimingAt.hit(power);</span>
<span class="nc" id="L158">		final int sectorBonusDamage = state.getPosition().getSectorBonus(this).additionalDamage;</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">		if (charClass == CharacterClass.DUELANT &amp;&amp; power &gt; weapon.maxDamage() + sectorBonusDamage) {</span>
<span class="nc" id="L160">			final double tenPercent = aimingAt._maxHealth() * 0.1;</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">			if (power &gt; weapon.minDamage() + tenPercent) {</span>
<span class="nc" id="L162">				fireCriticalShot(power);</span>
			} else {
<span class="nc" id="L164">				LOG.fine(&quot;almost crit by &quot; + name + &quot;: &quot; + power);</span>
			}
		}
<span class="nc" id="L167">	}</span>

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#hit(int)
	 */
	public boolean hit(final int damageAmount) {
<span class="nc" id="L173">		LOG.fine(name + &quot; was hit and lost &quot; + damageAmount + &quot; health points&quot;);</span>
<span class="nc" id="L174">		synchronized (stateChangeLock) {</span>
<span class="nc" id="L175">			final int oldHealth = state.getHealth();</span>
<span class="nc" id="L176">			state = state.reduceHealthBy(damageAmount);</span>
<span class="nc" id="L177">			fireWasHit(damageAmount, oldHealth);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">			if (state.getHealth() &lt;= 0) {</span>
<span class="nc" id="L179">				moveAway(state.getPosition());</span>
<span class="nc" id="L180">				fireIsDead();</span>
			}
<span class="nc bnc" id="L182" title="All 2 branches missed.">			return state.getHealth() &gt; 0;</span>
		}
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#aimAt(de.outstare.fortbattleplayer.model.Combatant)
	 */
	public void aimAt(final Combatant target) {
<span class="nc" id="L190">		LOG.fine(name + &quot; aims at &quot; + target);</span>
<span class="nc" id="L191">		aimingAt = target;</span>
<span class="nc" id="L192">		fireAimingAt();</span>
<span class="nc" id="L193">	}</span>

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#setDestination(de.outstare.fortbattleplayer.model.Area)
	 */
	public void setDestination(final Area destination) {
<span class="nc" id="L199">		LOG.fine(name + &quot; wants to move to &quot; + destination);</span>
<span class="nc" id="L200">		synchronized (stateChangeLock) {</span>
<span class="nc" id="L201">			state = state.changeTarget(destination);</span>
<span class="nc" id="L202">			fireNewTarget();</span>
<span class="nc" id="L203">		}</span>
<span class="nc" id="L204">	}</span>

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#addObserver(de.outstare.fortbattleplayer.model.CombatantObserver)
	 */
	public void addObserver(final CombatantObserver observer) {
<span class="nc" id="L210">		observers.add(observer);</span>
		// send current state
<span class="nc" id="L212">		observer.hasMoved(this, state.getPosition());</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		if (aimingAt != null) {</span>
<span class="nc" id="L214">			observer.aimsAt(this, aimingAt);</span>
		}
<span class="nc bnc" id="L216" title="All 2 branches missed.">		if (state.getHealth() &lt;= 0) {</span>
<span class="nc" id="L217">			observer.isDead(this);</span>
		} else {
<span class="nc" id="L219">			observer.isAlive(this);</span>
		}
<span class="nc" id="L221">		observer.isOnline(this, false);</span>
<span class="nc" id="L222">	}</span>

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#removeObserver(de.outstare.fortbattleplayer.model.CombatantObserver)
	 */
	public void removeObserver(final CombatantObserver observer) {
<span class="nc" id="L228">		observers.remove(observer);</span>
<span class="nc" id="L229">	}</span>

	/**
	 * notify all observers about the current position
	 */
	protected void fireHasMoved() {
<span class="nc bnc" id="L235" title="All 2 branches missed.">		for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L236">			observer.hasMoved(this, state.getPosition());</span>
<span class="nc" id="L237">		}</span>
<span class="nc" id="L238">	}</span>

	/**
	 * notify all observers about the current position
	 * 
	 * @param swappedWith
	 */
	protected void fireHasSwapped(final Combatant swappedWith) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">		for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L247">			observer.hasSwappedPosition(this, swappedWith);</span>
<span class="nc" id="L248">		}</span>
<span class="nc" id="L249">	}</span>

	/**
	 * notify all observers about the current position
	 */
	protected void fireNewTarget() {
<span class="nc bnc" id="L255" title="All 2 branches missed.">		for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L256">			observer.newDestination(this, state.getTarget());</span>
<span class="nc" id="L257">		}</span>
<span class="nc" id="L258">	}</span>

	/**
	 * notify all observers that I shot at somebody.
	 */
	protected void fireAimingAt() {
<span class="nc bnc" id="L264" title="All 2 branches missed.">		if (aimingAt != null) {</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">			for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L266">				observer.aimsAt(this, aimingAt);</span>
<span class="nc" id="L267">			}</span>
		}
<span class="nc" id="L269">	}</span>

	/**
	 * notify all observers about a loss of health
	 * 
	 * @param damage
	 *            amount of healthpoints lost
	 * @param healthBefore
	 *            original health amount before it was decreased by
	 *            &lt;code&gt;damage&lt;/code&gt;
	 */
	protected void fireWasHit(final int damage, final int healthBefore) {
<span class="nc bnc" id="L281" title="All 2 branches missed.">		for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L282">			observer.isHit(this, damage, healthBefore);</span>
<span class="nc" id="L283">		}</span>
<span class="nc" id="L284">	}</span>

	/**
	 * notify all observers about our dead
	 */
	protected void fireIsDead() {
<span class="nc bnc" id="L290" title="All 2 branches missed.">		for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L291">			observer.isDead(this);</span>
<span class="nc" id="L292">		}</span>
<span class="nc" id="L293">	}</span>

	/**
	 * notify all observers about our resurrection
	 */
	protected void fireIsAlive() {
<span class="nc bnc" id="L299" title="All 2 branches missed.">		for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L300">			observer.isAlive(this);</span>
<span class="nc" id="L301">		}</span>
<span class="nc" id="L302">	}</span>

	/**
	 * notify all observers about changed online state
	 * 
	 * @param changed
	 *            if the value was changed or only set
	 */
	protected void fireOnlineChange(final boolean changed) {
<span class="nc bnc" id="L311" title="All 2 branches missed.">		for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L312">			observer.isOnline(this, changed);</span>
<span class="nc" id="L313">		}</span>
<span class="nc" id="L314">	}</span>

	/**
	 * notify all observers that i have done a critical shot
	 * 
	 * @param damage
	 *            the actual caused damage
	 */
	protected void fireCriticalShot(final int damage) {
<span class="nc bnc" id="L323" title="All 2 branches missed.">		for (final CombatantObserver observer : observers) {</span>
<span class="nc" id="L324">			observer.criticalShot(this, aimingAt, damage);</span>
<span class="nc" id="L325">		}</span>
<span class="nc" id="L326">	}</span>

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#_getLocation()
	 */
	public Area _getLocation() {
<span class="nc" id="L332">		return state.getPosition();</span>
	}

	/**
	 * @return the side
	 */
	public CombatantSide getSide() {
<span class="nc" id="L339">		return side;</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#_health()
	 */
	public int _health() {
<span class="nc" id="L346">		return state.getHealth();</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#_maxHealth()
	 */
	public int _maxHealth() {
<span class="nc" id="L353">		return maxHealth;</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#_setState(de.outstare.fortbattleplayer.model.CombatantState)
	 */
	public void _setState(final CombatantState newState) {
<span class="nc" id="L360">		final CombatantState oldState = state;</span>
		// TODO maybe a PropertyChangeListener for the state
<span class="nc" id="L362">		synchronized (stateChangeLock) {</span>
<span class="nc" id="L363">			state = newState;</span>
			// new pos has not to be null!
<span class="nc bnc" id="L365" title="All 2 branches missed.">			if (state.getPosition() != null) {</span>
<span class="nc" id="L366">				final Area oldPos = oldState.getPosition();</span>
				// fix for swapping:
				// 1. go away from battlefield
<span class="nc" id="L369">				moveAway(oldPos);</span>
				// 2. come from nowhere to new position (avoids swapping)
<span class="nc" id="L371">				state.getPosition().occupy(this, null);</span>
<span class="nc bnc" id="L372" title="All 4 branches missed.">				if (oldPos == null || !oldPos.equals(state.getPosition())) {</span>
<span class="nc" id="L373">					fireHasMoved();</span>
				}
			}
<span class="nc bnc" id="L376" title="All 2 branches missed.">			if (oldState.getHealth() != state.getHealth()) {</span>
<span class="nc" id="L377">				fireWasHit(oldState.getHealth() - state.getHealth(), oldState.getHealth());</span>
			}
<span class="nc bnc" id="L379" title="All 4 branches missed.">			if (state.getHealth() &gt; 0 &amp;&amp; oldState.getHealth() &lt;= 0) {</span>
<span class="nc" id="L380">				fireIsAlive();</span>
			}
<span class="nc bnc" id="L382" title="All 4 branches missed.">			if (state.getHealth() &lt;= 0 &amp;&amp; oldState.getHealth() &gt; 0) {</span>
<span class="nc" id="L383">				fireIsDead();</span>
			}
<span class="nc bnc" id="L385" title="All 2 branches missed.">			if (oldState.isGamerOnline() != state.isGamerOnline()) {</span>
<span class="nc" id="L386">				fireOnlineChange(true);</span>
			}
<span class="nc bnc" id="L388" title="All 2 branches missed.">			if (!oldState.getTarget().equals(state.getTarget())) {</span>
<span class="nc" id="L389">				fireNewTarget();</span>
			}
<span class="nc" id="L391">		}</span>
<span class="nc" id="L392">	}</span>

	/**
	 * @param position
	 */
	private void moveAway(final Area position) {
<span class="nc bnc" id="L398" title="All 4 branches missed.">		if (position != null &amp;&amp; equals(position.getOccupier())) {</span>
<span class="nc" id="L399">			position.free();</span>
		}
<span class="nc" id="L401">	}</span>

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#_state()
	 */
	public CombatantState _state() {
<span class="nc" id="L407">		return state;</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#isOnline()
	 */
	public boolean isOnline() {
<span class="nc" id="L414">		return state.isGamerOnline();</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#setOnline()
	 */
	public void setOnline(final boolean isOnline) {
<span class="nc" id="L421">		synchronized (stateChangeLock) {</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">			final boolean changed = isOnline() != isOnline;</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">			if (changed) {</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">				LOG.fine(name + &quot; is now &quot; + (isOnline ? &quot;online&quot; : &quot;offline&quot;));</span>
<span class="nc" id="L425">				state = state.setOnline(isOnline);</span>
			}
<span class="nc" id="L427">			fireOnlineChange(changed);</span>
<span class="nc" id="L428">		}</span>
<span class="nc" id="L429">	}</span>

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#getCharacterClass()
	 */
	public CharacterClass getCharacterClass() {
<span class="nc" id="L435">		return charClass;</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#getSectorBonus()
	 */
	public SectorBonus getSectorBonus() {
<span class="nc" id="L442">		return _getLocation().getSectorBonus(this);</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#getCity()
	 */
	public String getCity() {
<span class="nc" id="L449">		return city;</span>
	}

	/**
	 * @see de.outstare.fortbattleplayer.model.Combatant#usesBayonet()
	 */
	public boolean usesBayonet() {
<span class="nc" id="L456">		final WeaponData weaponData = new JSWeaponData();</span>
<span class="nc" id="L457">		return weaponData.hasBayonet(getWeapon());</span>
	}

	/**
	 * @see java.lang.Object#hashCode()
	 */
	@Override
	public int hashCode() {
<span class="nc" id="L465">		final int prime = 13;</span>
<span class="nc" id="L466">		int result = 1;</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">		result = prime * result + ((name == null) ? 0 : name.hashCode());</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">		result = prime * result + ((charClass == null) ? 0 : charClass.hashCode());</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">		result = prime * result + ((city == null) ? 0 : city.hashCode());</span>
<span class="nc" id="L470">		return result;</span>
	}

	/**
	 * @see java.lang.Object#equals(java.lang.Object)
	 */
	@Override
	public boolean equals(final Object obj) {
<span class="nc bnc" id="L478" title="All 2 branches missed.">		if (this == obj) {</span>
<span class="nc" id="L479">			return true;</span>
		}
<span class="nc bnc" id="L481" title="All 2 branches missed.">		if (obj == null) {</span>
<span class="nc" id="L482">			return false;</span>
		}
<span class="nc bnc" id="L484" title="All 2 branches missed.">		if (!(obj instanceof SimpleCombatant)) {</span>
<span class="nc" id="L485">			return false;</span>
		}
<span class="nc" id="L487">		final SimpleCombatant other = (SimpleCombatant) obj;</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">		if (name == null) {</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">			if (other.name != null) {</span>
<span class="nc" id="L490">				return false;</span>
			}
<span class="nc bnc" id="L492" title="All 2 branches missed.">		} else if (!name.equals(other.name)) {</span>
<span class="nc" id="L493">			return false;</span>
		}
<span class="nc bnc" id="L495" title="All 2 branches missed.">		if (charClass != other.charClass) {</span>
<span class="nc" id="L496">			return false;</span>
		}
<span class="nc bnc" id="L498" title="All 2 branches missed.">		if (city == null) {</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">			if (other.city != null) {</span>
<span class="nc" id="L500">				return false;</span>
			}
<span class="nc bnc" id="L502" title="All 2 branches missed.">		} else if (!city.equals(other.city)) {</span>
<span class="nc" id="L503">			return false;</span>
		}
<span class="nc" id="L505">		return true;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>