<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetOfficeAgent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">10_water-simulator</a> &gt; <a href="index.source.html" class="el_package">simulator.MOA</a> &gt; <span class="el_source">MetOfficeAgent.java</span></div><h1>MetOfficeAgent.java</h1><pre class="source lang-java linenums">package simulator.MOA;


import jade.content.ContentElement;
import jade.content.lang.Codec;
import jade.content.lang.Codec.CodecException;
import jade.content.lang.sl.SLCodec;
import jade.content.onto.OntologyException;
import jade.core.Agent;
import jade.domain.FIPAAgentManagement.FailureException;
import jade.domain.FIPAAgentManagement.NotUnderstoodException;
import jade.domain.FIPAAgentManagement.RefuseException;
import jade.lang.acl.ACLMessage;
import jade.lang.acl.MessageTemplate;
import jade.proto.AchieveREResponder;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.Vector;

import org.apache.log4j.Logger;

import simulator.ontology.HasMetData;
import simulator.ontology.MetData;
import simulator.ontology.WDS_Ontology;
import simulator.util.AIDs;

/**
 * Met Office Agent is responsible for met data.When asked by WSA for the met data
 * of a specific time period, sends the right data back. Extends Jade's Agent class&lt;/p&gt;
 * @author Vartalas Panagiotis
 * @author Ioannis N. Athanasiadis
 * @version 1.9
 * @since 2003-2006
 */

<span class="nc" id="L40">public class MetOfficeAgent extends Agent implements AIDs {</span>
	
	private static final long serialVersionUID = 9053161619902067226L;
<span class="nc" id="L43">	private Logger log = Logger.getLogger(MetOfficeAgent.class);</span>
// Ontology
<span class="nc" id="L45">  private Codec codec = new SLCodec();</span>
<span class="nc" id="L46">  private WDS_Ontology ontology = WDS_Ontology.getInstance();</span>

  // Read from arguments
  private File metDataFile;
  private int simulationDuration; // in steps
  private int simulationStep; // in months
  
  //Stores all met data for this simulation as FileData objects. Vector's index indicates the step
<span class="nc" id="L54">  private Vector metData = new Vector(0,1);</span>



  public void setup() {

<span class="nc" id="L60">        unpackArguments();</span>
<span class="nc" id="L61">        readMetDataFromFile();</span>

        //Register language(SL) and ontology
<span class="nc" id="L64">        getContentManager().registerLanguage(codec);</span>
<span class="nc" id="L65">        getContentManager().registerOntology(ontology);</span>

<span class="nc" id="L67">        MessageTemplate mt = MessageTemplate.and(</span>
<span class="nc" id="L68">                    MessageTemplate.MatchPerformative(ACLMessage.QUERY_REF),</span>
<span class="nc" id="L69">                    MessageTemplate.MatchOntology(ontology.getName()));</span>

<span class="nc" id="L71">        addBehaviour(new BehaviourReplyMetDataQuery(this,mt));</span>
<span class="nc" id="L72">  }</span>



  /**
   * &lt;p&gt;Title: BehaviourReplyMetDataQuery (MOA)&lt;/p&gt;
   * &lt;p&gt;Description: MOA replies a query message about met data for a specific step simulation.
   * Communication follows FIPA protocol&lt;/p&gt;
   * &lt;p&gt;Copyright: Copyright (c) 2003&lt;/p&gt;
   * &lt;p&gt;Company: AUTH &lt;/p&gt;
   * @author Vartalas Panagiotis
   * @version 1.0
   */

    class BehaviourReplyMetDataQuery extends AchieveREResponder {

	private static final long serialVersionUID = 409706462182524692L;

		MetOfficeAgent myAgent;

<span class="nc" id="L92">        boolean sentAgree = false;</span>

	//Constructor
<span class="nc" id="L95">        public BehaviourReplyMetDataQuery(MetOfficeAgent a, MessageTemplate mt) {</span>
<span class="nc" id="L96">	    super(a, mt, null);</span>
<span class="nc" id="L97">            myAgent = a;</span>
<span class="nc" id="L98">	}</span>

	protected ACLMessage prepareResponse(ACLMessage query) throws RefuseException, NotUnderstoodException {
<span class="nc" id="L101">	    sentAgree=false;</span>
	    // for future use
            int firstResponse;

<span class="nc bnc" id="L105" title="All 2 branches missed.">           if (query.getLanguage().equals(codec.getName())){</span>
               // I undestood the query
<span class="nc" id="L107">               firstResponse = 0;</span>
           }
           else{
               // I didn't understand !!
<span class="nc" id="L111">               firstResponse = 2;</span>
           }

<span class="nc" id="L114">	    ACLMessage response = query.createReply();</span>

<span class="nc bnc" id="L116" title="All 6 branches missed.">	    switch (firstResponse){</span>
	      case 0 : {//send an AGREE
                         // jump first response and don't sent AGREE message !!!!
                         //response.setPerformative(ACLMessage.AGREE);
<span class="nc" id="L120">                         response = null;</span>
<span class="nc" id="L121">                         sentAgree = true;</span>
<span class="nc" id="L122">                         break;</span>
		       }
              case 1 : { //send a REFUSE
<span class="nc" id="L125">                         response.setPerformative(ACLMessage.REFUSE);</span>
<span class="nc" id="L126">                         break;</span>
                       }
              case 2 : { //send a NOT UNDERSTOOD
<span class="nc" id="L129">                          response.setPerformative(ACLMessage.NOT_UNDERSTOOD);</span>
<span class="nc" id="L130">                          response.setContent(&quot;Wrong Language or Ontology...&quot;);</span>
<span class="nc" id="L131">                          break;</span>
                       }
              case 3 : { //send an out of sequence Message
<span class="nc" id="L134">		         response.setPerformative(ACLMessage.SUBSCRIBE);</span>
<span class="nc" id="L135">                         break;</span>
                       }
              case 4 : { //send an INFORM
<span class="nc" id="L138">		         response.setPerformative(ACLMessage.INFORM);</span>
<span class="nc" id="L139">                         break;</span>
                       }
              default : {//check the time out expiration in initiator.
<span class="nc" id="L142">		          response = null;</span>
                        }

	    }
	    //TEST
            //System.out.println(&quot;MOA  --&gt; is sending &quot;+(response==null?&quot;no&quot;:(response.getPerformative()==ACLMessage.SUBSCRIBE?&quot;an out-of-sequence&quot;:ACLMessage.getPerformative(response.getPerformative())))+ &quot; response to the protocol initiator.&quot; );
<span class="nc" id="L148">	    return response;</span>
	}

	protected ACLMessage prepareResultNotification(ACLMessage query, ACLMessage response) throws FailureException {

            // for future use
<span class="nc" id="L154">	    int secondResponse = 0;</span>
            // Create reply message
<span class="nc" id="L156">            ACLMessage resNot = query.createReply();</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">	    if(sentAgree){</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">		switch (secondResponse){</span>
                  case 0 : { //SENDING INFORM
<span class="nc" id="L161">                             resNot.setPerformative(ACLMessage.INFORM);</span>
                                // Get content
                             try{
<span class="nc" id="L164">                                  ContentElement ce = myAgent.getContentManager().extractContent(query);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                                  if (ce instanceof HasMetData) {</span>

<span class="nc" id="L167">                                        HasMetData hd = (HasMetData) ce;</span>
                                        // get step ID
<span class="nc" id="L169">                                        Integer stepId = hd.getStep1().getId();</span>

                                        // Fill content with meteorological data
<span class="nc" id="L172">                                        MetData data = new MetData();</span>

                                        // meteorological data reading
<span class="nc" id="L175">                                        data.setTemperature(readTemperature(stepId));</span>

<span class="nc" id="L177">                                        data.setRainfall(readRainfall(stepId));</span>

<span class="nc" id="L179">                                        hd.setData(data);</span>

<span class="nc" id="L181">                                        myAgent.getContentManager().fillContent(resNot,hd);</span>
                                 }
                             }
<span class="nc" id="L184">                             catch (CodecException ce){</span>
<span class="nc" id="L185">                               ce.printStackTrace();</span>
                             }
<span class="nc" id="L187">                             catch (OntologyException oe){</span>
<span class="nc" id="L188">                               oe.printStackTrace();</span>
<span class="nc" id="L189">                             }</span>
<span class="nc" id="L190">                             break;</span>
                           }

                  case 1 : {  // sending FAILURE
<span class="nc" id="L194">		              resNot.setPerformative(ACLMessage.FAILURE);</span>
<span class="nc" id="L195">                              break;</span>
                           }
                  case 2 : {  //sending out of sequence message
<span class="nc" id="L198">		              resNot.setPerformative(ACLMessage.SUBSCRIBE);</span>
<span class="nc" id="L199">                              break;</span>
                           }
		  default : { // sending no message checking TIMEOUT of Initiator.
<span class="nc" id="L202">                              resNot = null;</span>
		            }
		}
	    }else {
		// the inform message has been already sent.
<span class="nc" id="L207">		resNot = null;</span>
	    }

            //TEST
            //System.out.println(&quot;MOA --&gt; is sending &quot;+(resNot==null?&quot;no&quot;:(resNot.getPerformative()==ACLMessage.SUBSCRIBE?&quot;an out-of-sequence&quot;:ACLMessage.getPerformative(resNot.getPerformative())))+ &quot; result notification to the protocol initiator.&quot; );
<span class="nc" id="L212">	    return resNot;</span>
	}
    } // End of inner class MyRequestResponder


    /**
     * &quot;Unpack&quot; the arguments MOA receives when is born. The arguments are elements of an object array.
     * The first argument is the simulation duration and the second the file where the met data are
     * stored. Is called first in setup method.
     */
    private void unpackArguments(){
<span class="nc" id="L223">      Object[] arguments = this.getArguments();</span>
<span class="nc" id="L224">      this.simulationDuration = ((Integer)arguments[0]).intValue();</span>
<span class="nc" id="L225">      this.metDataFile = (File)arguments[1];</span>
<span class="nc" id="L226">      this.simulationStep = ((Integer)arguments[2]).intValue();</span>
<span class="nc" id="L227">    }</span>

    /**
     * All met data needed for the simulation, are read from the met file and stored in metData Vector().
     * Met data file is opened only here. After this method is called, MOA accesses met data from the Vector.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
	private void readMetDataFromFile(){
<span class="nc" id="L235">      try{ FileReader source = new FileReader(this.metDataFile);</span>
<span class="nc" id="L236">           BufferedReader reader = new BufferedReader(source);</span>
            String str;
<span class="nc" id="L238">            int readRecords=0;</span>

<span class="nc bnc" id="L240" title="All 4 branches missed.">            while ( ((str = reader.readLine()) != null) &amp;&amp; (readRecords &lt; this.simulationDuration*this.simulationStep)){</span>

<span class="nc" id="L242">                FileData fd = parseString(str);</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">                if (fd != null ){</span>
<span class="nc" id="L245">                    this.metData.addElement(fd);</span>
<span class="nc" id="L246">                    readRecords++;</span>
                }

                
<span class="nc" id="L250">                log.debug(str + &quot;,&quot;);</span>
<span class="nc" id="L251">            }</span>
<span class="nc" id="L252">            reader.close();</span>
      }
<span class="nc" id="L254">      catch(FileNotFoundException fnff){ log.error(&quot;File not found : &quot; + fnff.getMessage());}</span>

<span class="nc" id="L256">      catch(IOException e){log.error(e.getStackTrace());}</span>

<span class="nc" id="L258">    }// END readMetDataFromFile()</span>


    /**
     * Parses the record and &quot;translate&quot; it into a temperature value and a rainfall value. The record
     * follows the specified format : [temperature] [rainfall] \n
     * @param record one line (string) read from met data File
     * @return FileData Object with temperature and rainfall properties filled
     */
    private FileData parseString(String record){

<span class="nc" id="L269">       float temperature = 0;</span>

<span class="nc" id="L271">       String temp=&quot;&quot;;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">       for(int i=0 ; i&lt;record.length() ; i++){</span>
<span class="nc bnc" id="L273" title="All 4 branches missed.">          if( ( ((int)record.charAt(i) &gt;=48) &amp;&amp; ((int)record.charAt(i) &lt;=57) )</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                                                                      || record.charAt(i) == '.'){</span>
<span class="nc" id="L275">              temp+= record.charAt(i);</span>
          }// END-if
<span class="nc bnc" id="L277" title="All 4 branches missed.">          else if (record.charAt(i) == ' ' &amp;&amp; !temp.equals(&quot;&quot;)){</span>
<span class="nc" id="L278">                   temperature = Float.valueOf(temp).floatValue();</span>
<span class="nc" id="L279">                   temp=&quot;&quot;;</span>
               }


       }//END-for

<span class="nc bnc" id="L285" title="All 4 branches missed.">       if (temperature == 0 || temp == &quot;&quot;) return null;</span>

<span class="nc" id="L287">       return (new FileData(temperature,Float.valueOf(temp).floatValue()));</span>

    }// END method parseString()

    /**
     * Returns the temperature as a Float for the specified simulation step
     * @param step the step for which to read the temperature
     * @return the temperature as a Float value
     */
    private Float readTemperature(Integer step){
<span class="nc" id="L297">        FileData fd = (FileData) metData.elementAt((step.intValue()-1)*simulationStep);</span>
        // step checking (maybe)
<span class="nc" id="L299">        return (new Float(fd.getTemperature()));</span>
    }

    /**
     * Returns the rainfall as a Float for the specified simulation step
     * @param step the step for which to read the rainfall
     * @return the rainfall as a Float value
     */
    private Float readRainfall(Integer step){
<span class="nc" id="L308">        FileData fd = (FileData) metData.elementAt((step.intValue()-1)*simulationStep);</span>
<span class="nc" id="L309">        return (new Float(fd.getRainfall()));</span>
    }


    /**
     * &lt;p&gt;Title: FileData&lt;/p&gt;
     * &lt;p&gt;Description: MOA's inner class for storing temperature and rainfall values, read from met data
     * file, per step in metData Vector &lt;/p&gt;
     * &lt;p&gt;Copyright: Copyright (c) 2003&lt;/p&gt;
     * &lt;p&gt;Company: AUTH &lt;/p&gt;
     * @author Vartalas Panagiotis
     * @version 1.0
     */
    private class FileData {

        // step implied by position in Vector
        //private int step;
        private float temperature;
        private float rainfall;

<span class="nc" id="L329">       FileData(/*int step, */float temperature,float rainfall){</span>
          //this.step = step;
<span class="nc" id="L331">          this.temperature = temperature;</span>
<span class="nc" id="L332">          this.rainfall = rainfall;</span>
<span class="nc" id="L333">       }</span>

       //public int getStep(){return this.step;}
<span class="nc" id="L336">       public float getTemperature(){return this.temperature;}</span>
<span class="nc" id="L337">       public float getRainfall(){return this.rainfall;}</span>

    }// END of inner class


} // END of MOA
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>