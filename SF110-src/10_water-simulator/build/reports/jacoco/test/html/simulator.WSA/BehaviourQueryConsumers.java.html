<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BehaviourQueryConsumers.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">10_water-simulator</a> &gt; <a href="index.source.html" class="el_package">simulator.WSA</a> &gt; <span class="el_source">BehaviourQueryConsumers.java</span></div><h1>BehaviourQueryConsumers.java</h1><pre class="source lang-java linenums">package simulator.WSA;



import jade.content.ContentElement;
import jade.content.lang.Codec.CodecException;
import jade.content.onto.OntologyException;
import jade.core.behaviours.DataStore;
import jade.lang.acl.ACLMessage;
import jade.proto.AchieveREInitiator;

import java.util.Vector;

import org.apache.log4j.Logger;

import simulator.ontology.Consumes;
import simulator.ontology.MetData;
import simulator.ontology.PriceBlock;
import simulator.ontology.StepAttr;
import simulator.ontology.StepTotalConsumption;
import simulator.ontology.WaterConsumption;
import simulator.util.AIDs;
import simulator.util.ConsumerAttributes;

/**
 * &lt;p&gt;Title: BehaviourQueryConsumers&lt;/p&gt;
 * &lt;p&gt;Description: WSA behaviour using QUERY-REF protocol to ask all consumers agents their consumption
 * for the given price and met data&lt;/p&gt;
 * @author Panagiotis Vartalas
 * @author Ioannis N. Athanasiadis
 * @version 1.9
 * @since 2003-2006
 */

class BehaviourQueryConsumers extends AchieveREInitiator implements AIDs{

	private static final long serialVersionUID = 3921159876104072024L;
<span class="nc" id="L38">	private Logger log = Logger.getLogger(BehaviourQueryConsumers.class);</span>
	private WaterSupplierAgent myAgent;

    //TEST
    private static int test;

    // All consumers agents
    private ConsumerAttributes[] consumers;


    // All price data from GUI
    @SuppressWarnings(&quot;unused&quot;)
	private Vector priceData;
    private int pricingScenario;
<span class="nc" id="L52">    @SuppressWarnings(&quot;unused&quot;)</span>
	private Vector scenarioVariables = new Vector(0,1);
    private int simulationStep;
    private int reviewPeriod;
    private float CPI;
    private float CPIpercentage;
    // Price Type AP / MP
    @SuppressWarnings(&quot;unused&quot;)
	private String priceType;
    private int numberOfBlocks;
    private int[][] priceBlocksLimits;
    private float[] blocksPrices;

    // Actual water price (sent to CAs)
    private float[] actualPrices;
    // Reviewed water price (sent to SA)
    private float[] currentPrices;



    public BehaviourQueryConsumers(WaterSupplierAgent a, ACLMessage query, ConsumerAttributes[] consumers,
                               Vector priceData,Integer simulationStep,DataStore ds){
<span class="nc" id="L74">      super(a,query);</span>
<span class="nc" id="L75">      this.myAgent = a;</span>
<span class="nc" id="L76">      this.consumers = consumers;</span>
<span class="nc" id="L77">      this.priceData = priceData;</span>
<span class="nc" id="L78">      this.simulationStep = simulationStep.intValue();</span>
<span class="nc" id="L79">      this.setDataStore(ds);</span>

<span class="nc" id="L81">      this.pricingScenario = ((Integer)priceData.elementAt(0)).intValue();</span>
      /////////////////////////////////////
<span class="nc" id="L83">      this.scenarioVariables = (Vector) priceData.elementAt(1);</span>
<span class="nc" id="L84">      this.reviewPeriod = ((Integer)priceData.elementAt(2)).intValue();</span>
<span class="nc" id="L85">      this.CPI = ((Float)priceData.elementAt(3)).floatValue();</span>
<span class="nc" id="L86">      this.CPIpercentage = ((Float)priceData.elementAt(4)).floatValue();</span>
<span class="nc" id="L87">      this.priceType = (String)priceData.elementAt(5);</span>
<span class="nc" id="L88">      this.numberOfBlocks = ((Integer)priceData.elementAt(6)).intValue();</span>
<span class="nc" id="L89">      this.priceBlocksLimits = new int[numberOfBlocks][2];</span>
<span class="nc" id="L90">      this.blocksPrices = new float[numberOfBlocks];</span>
<span class="nc" id="L91">      int j = 7;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">      for(int i = 0; i&lt;this.numberOfBlocks;i++){</span>
<span class="nc" id="L93">        this.priceBlocksLimits[i][0] = ((Integer)priceData.elementAt(j)).intValue();</span>
<span class="nc" id="L94">        j++;</span>
<span class="nc" id="L95">        this.priceBlocksLimits[i][1] = ((Integer)priceData.elementAt(j)).intValue();</span>
<span class="nc" id="L96">        j++;</span>
<span class="nc" id="L97">        this.blocksPrices[i] = ((Float)priceData.elementAt(j)).floatValue();</span>
<span class="nc" id="L98">        j++;</span>
        //TEST
        //System.out.println(priceBlocksLimits[i][0] + &quot;/&quot; + priceBlocksLimits[i][1] + &quot;/&quot; + blocksPrices[i]);
      }

<span class="nc" id="L103">      this.actualPrices = new float[this.numberOfBlocks];</span>
<span class="nc" id="L104">      this.currentPrices = new float[this.numberOfBlocks];</span>
      //TEST
<span class="nc" id="L106">      test = consumers.length;</span>

<span class="nc" id="L108">    }</span>


    @SuppressWarnings(&quot;unchecked&quot;)
	protected Vector prepareRequests(ACLMessage msg){

<span class="nc" id="L114">        Vector v = new Vector();</span>
<span class="nc" id="L115">        ACLMessage msg1 = myAgent.createQueryMsg();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        for (int i=0 ; i&lt;consumers.length ; i++){</span>
<span class="nc" id="L117">            msg1.addReceiver(consumers[i].getAID());</span>
        }


        try{ // Fill message content
<span class="nc" id="L122">              myAgent.getContentManager().fillContent(msg1,prepareQueryMessageForConsumers());</span>
<span class="nc" id="L123">              v.addElement(msg1);</span>
        }
<span class="nc" id="L125">        catch (CodecException ce){ ce.printStackTrace(); }</span>
<span class="nc" id="L126">        catch (OntologyException oe){ oe.printStackTrace(); }</span>
         // TEST
<span class="nc" id="L128">        log.info(&quot;WSA - CA : &quot; + msg1.getContent());</span>
<span class="nc" id="L129">        return v;</span>
    }

<span class="nc" id="L132">    protected void handleAgree(ACLMessage msg) {}</span>

    protected void handleInform(ACLMessage msg) {
      //TEST
<span class="nc bnc" id="L136" title="All 2 branches missed.">      if (test!=0)</span>
<span class="nc" id="L137">          test--;</span>
<span class="nc" id="L138">      else test = consumers.length;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">      if((test%5)==0){</span>
<span class="nc" id="L140">        log.debug(&quot;WSA : waiting  &quot; + test + &quot; more messages&quot;);</span>
        /*ACLMessage fmsg = new ACLMessage(ACLMessage.FAILURE);
        fmsg.setContent(&quot;Waiting &quot; + test + &quot; more messages&quot;);
        myAgent.onFailure(fmsg);*/
      }

<span class="nc" id="L146">    }</span>

<span class="nc" id="L148">    protected void handleFailure(ACLMessage msg) { myAgent.onFailure(msg);}</span>
<span class="nc" id="L149">    protected void handleRefuse(ACLMessage msg) { myAgent.onFailure(msg);}</span>
<span class="nc" id="L150">    protected void handleNotUnderstood(ACLMessage msg) { myAgent.onFailure(msg);}</span>
<span class="nc" id="L151">    protected void handleOutOfSequence(ACLMessage msg) { myAgent.onFailure(msg);}</span>

<span class="nc" id="L153">    protected void handleAllResponses(Vector responses){  }</span>

    @SuppressWarnings(&quot;unused&quot;)
<span class="nc" id="L156">	private void onSuccess(ACLMessage msg){}</span>

    protected void handleAllResultNotifications(Vector resultNotifications){

        // All personal consumptions arrived
<span class="nc" id="L161">        float stepTotal = 0;</span>

        // Calculate step total consumption
<span class="nc bnc" id="L164" title="All 2 branches missed.">        for(int i=0 ; i&lt;resultNotifications.size() ; i++){</span>
<span class="nc" id="L165">            ACLMessage msg = (ACLMessage) resultNotifications.elementAt(i);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            if (msg.getPerformative() == ACLMessage.INFORM){</span>
               try{
<span class="nc" id="L168">                    ContentElement ce = myAgent.getContentManager().extractContent(msg);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                    if (ce instanceof Consumes) {</span>
<span class="nc" id="L170">                        Consumes cs = (Consumes) ce;</span>
<span class="nc" id="L171">                        WaterConsumption wc = (WaterConsumption) cs.getPersonalConsumption();</span>
                        //////******
<span class="nc" id="L173">                        stepTotal += wc.getQuantity().floatValue();</span>
<span class="nc" id="L174">                        this.getDataStore().put(WaterSupplierAgent.STEP_TOTAL_KEY,new Float(stepTotal));</span>
                    }
               }
<span class="nc" id="L177">               catch (CodecException ce){ ce.printStackTrace(); }</span>
<span class="nc" id="L178">               catch (OntologyException oe){ oe.printStackTrace(); }</span>

            }
<span class="nc" id="L181">            else { myAgent.onFailure(msg);}</span>
        }

        // Send Step result
<span class="nc" id="L185">        sendStepResultsToSA(stepTotal);</span>
<span class="nc" id="L186">    }</span>

    /**
     * Prepares query message for consumers. Fills stepID, temperature, rainfall and water price
     * @return A predicate Consumes filled with all appropriate values
     */
    private Consumes prepareQueryMessageForConsumers(){

        // Predicate
<span class="nc" id="L195">        Consumes cs = new Consumes();</span>

        // Prepare content
          // Fill concepts
<span class="nc" id="L199">        StepAttr step = new StepAttr();</span>
<span class="nc" id="L200">        step.setId(((Integer)this.getDataStore().get(WaterSupplierAgent.STEP_ID_KEY)));</span>
        // Fill Predidate
<span class="nc" id="L202">        cs.setStep2(step);</span>

<span class="nc" id="L204">        MetData md = new MetData();</span>
<span class="nc" id="L205">        md.setTemperature(((Float)this.getDataStore().get(WaterSupplierAgent.TEMPERATURE_KEY)));</span>
<span class="nc" id="L206">        md.setRainfall(((Float)this.getDataStore().get(WaterSupplierAgent.RAINFALL_KEY)));</span>

        // Fill Predidate
<span class="nc" id="L209">        cs.setMeteoData(md);</span>

<span class="nc" id="L211">        WaterConsumption wc = new WaterConsumption();</span>
        // Fill Predidate
<span class="nc" id="L213">        cs.setPersonalConsumption(wc);  // empty</span>

        // Fill price policy

        //Check if it's time for policy reviewing
<span class="nc" id="L218">        int currentStep = ((Integer)this.getDataStore().get(WaterSupplierAgent.STEP_ID_KEY)).intValue();</span>
<span class="nc" id="L219">        int currentmonth = currentStep*this.simulationStep;</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (( currentmonth % reviewPeriod) == 1){</span>
          //Review pricing Policy
<span class="nc" id="L222">          reviewPricingPolicy(currentmonth);</span>
        }

<span class="nc" id="L225">        PriceBlock[] blocks = currentPricingPolicy(0);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">        for(int i=0 ; i&lt;this.numberOfBlocks ; i++){</span>
<span class="nc" id="L227">            cs.addPricingScale(blocks[i]);</span>
        }

<span class="nc" id="L230">        return cs;</span>

    }

    private PriceBlock[] currentPricingPolicy(int k){

<span class="nc" id="L236">        PriceBlock[] blocks = new PriceBlock[this.numberOfBlocks];</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">        for(int i=0 ; i&lt;this.numberOfBlocks ; i++){</span>
<span class="nc" id="L239">          blocks[i] = new PriceBlock();</span>
<span class="nc" id="L240">          blocks[i].setNo(new Integer(i+1));</span>
<span class="nc" id="L241">          blocks[i].setLimitDown(new Integer(this.priceBlocksLimits[i][0]));</span>
<span class="nc" id="L242">          blocks[i].setLimitUp(new Integer(this.priceBlocksLimits[i][1]));</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">          if (k == 0)</span>
<span class="nc" id="L244">            blocks[i].setPrice(new Float(this.actualPrices[i]));</span>
          else
<span class="nc" id="L246">            blocks[i].setPrice(new Float(this.currentPrices[i]));</span>
        }

<span class="nc" id="L249">        return blocks;</span>
    }

    private void reviewPricingPolicy(int currentmonth){
    	
      // Calculate CPI
<span class="nc" id="L255">      float currentCPI = (float) (this.CPI*Math.pow((1+this.CPIpercentage/100/12),currentmonth));</span>
<span class="nc" id="L256">      log.debug(&quot;current CPI at month &quot; + currentmonth + &quot; is &quot; + currentCPI);</span>
      
//      int years;
//      int months = currentStep * this.simulationStep;
//      if( (months%12) == 0 )
//          years = (months/12) - 1;
//      else
//          years = months/12;
//
//      for (int i = 0 ; i &lt; years ; i++)
//          currentCPI = currentCPI * (1+(this.CPIpercentage/100));

<span class="nc bnc" id="L268" title="All 3 branches missed.">      switch (this.pricingScenario){</span>
<span class="nc" id="L269">          case 0 :scenario0(currentCPI);</span>
<span class="nc" id="L270">                  break;</span>
<span class="nc" id="L271">          case 1 :scenario1(currentCPI);</span>
                  break;
                  
      }
<span class="nc" id="L275">    }</span>

    // To timologio tou nerou paramenei sta8ero (meiwnetai h pragmatikh timh tou)
    private void scenario0(float currentCPI){
<span class="nc bnc" id="L279" title="All 2 branches missed.">        for(int i=0 ; i &lt; this.numberOfBlocks ; i++){</span>
<span class="nc" id="L280">            this.actualPrices[i] = (this.blocksPrices[i] * 100) / currentCPI;</span>
<span class="nc" id="L281">            this.currentPrices[i] = this.blocksPrices[i];</span>
        }

<span class="nc" id="L284">    }</span>

    // To timologio anaprosarmozetai wste h pragmatikh timh tou neroy na paramenei sta8erh
    private void scenario1(float currentCPI){
<span class="nc bnc" id="L288" title="All 2 branches missed.">        for(int i=0 ; i &lt; this.numberOfBlocks ; i++){</span>
<span class="nc" id="L289">            this.actualPrices[i] = (this.blocksPrices[i] * 100) / this.CPI;</span>
<span class="nc" id="L290">            this.currentPrices[i] = (this.actualPrices[i] * currentCPI) / 100;</span>
        }

<span class="nc" id="L293">    }</span>

    /**
     * Sends the step result to SA
     * @param stepTotal The step's total consumption
     */
    private void sendStepResultsToSA(float stepTotal){

           // Prepare INFORM message to Simulator Agent
<span class="nc" id="L302">            ACLMessage msg = new ACLMessage(ACLMessage.INFORM);</span>
<span class="nc" id="L303">            msg.addReceiver(SIMULATOR);</span>
<span class="nc" id="L304">            msg.setLanguage(myAgent.codec.getName());</span>
<span class="nc" id="L305">            msg.setOntology(myAgent.ontology.getName());</span>

            // Predicate
<span class="nc" id="L308">            StepTotalConsumption tc = new StepTotalConsumption();</span>

            // Prepare content
                // Fill concepts
<span class="nc" id="L312">            StepAttr step = new StepAttr();</span>
<span class="nc" id="L313">            step.setId(((Integer)this.getDataStore().get(WaterSupplierAgent.STEP_ID_KEY)));</span>
            // Fill Predidate
<span class="nc" id="L315">            tc.setStep4(step);</span>

<span class="nc" id="L317">            WaterConsumption wc = new WaterConsumption();</span>
//            stepTotal = (stepTotal);
<span class="nc" id="L319">            wc.setQuantity(new Float(stepTotal));</span>
            // Fill Predidate
<span class="nc" id="L321">            tc.setStepConsumption(wc);</span>

            // Fill Predidate with price policy
<span class="nc" id="L324">            PriceBlock[] blocks = currentPricingPolicy(1);</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            for(int i=0 ; i&lt;blocks.length ; i++){</span>
<span class="nc" id="L326">                tc.addWaterPrice(blocks[i]);</span>
            }

            // Fill message content
            try{
<span class="nc" id="L331">               myAgent.getContentManager().fillContent(msg,tc);</span>
<span class="nc" id="L332">               myAgent.send(msg);</span>
            }
<span class="nc" id="L334">            catch (CodecException ce){</span>
<span class="nc" id="L335">               ce.printStackTrace();</span>
            }
<span class="nc" id="L337">            catch (OntologyException oe){</span>
<span class="nc" id="L338">               oe.printStackTrace();</span>
<span class="nc" id="L339">            }</span>


<span class="nc" id="L342">    }</span>
}// END of behaviour
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>