<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FormElement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">80_wheelwebtool</a> &gt; <a href="index.source.html" class="el_package">wheel.components</a> &gt; <span class="el_source">FormElement.java</span></div><h1>FormElement.java</h1><pre class="source lang-java linenums">/*
Copyright (c) 2007-2008, Henri Frilund

All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

    * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
    * Neither the name of the &lt;ORGANIZATION&gt; nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
&quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
package wheel.components;

import org.mvel.MVEL;
import org.xmlpull.v1.XmlSerializer;
import wheel.WheelException;

import java.io.IOException;
import java.util.*;

/**
 * All components that want to handle form input should extend from this class.
 * Defines a set of operations like validation and binding. &lt;br/&gt;
 * &lt;b&gt;Binding fields to FormElements:&lt;/b&gt;&lt;br/&gt;
 * Binding is done with MVEL-expressions.
 * The only rule is that the target of the binding must be available in the complex component using javabean get/set-methods.
 * &lt;br/&gt;
 * Example:
 * &lt;pre&gt;
 * public class MyComponent extends StandaloneComponent {
 *  private Calendar cal;
 *
 *  public Calendar getCal() {
 *      return cal;
 *  }
 *
 *  public void setCal(Calendar cal) {
 *      this.cal = cal;
 *  }
 * }
 * &lt;/pre&gt;
 * In the above example, the containing complex component has a field declaration like this:
 * &lt;pre&gt;private List&lt;Integer&gt; numbers;&lt;/pre&gt;
 * Note that when using Lists and Maps, they need to be initialized, ie. they can't be empty.
 *
 * &lt;b&gt;Limitations:&lt;/b&gt;&lt;br/&gt;
 * Array types are not supported at the moment. Use Collections-api instead.
 *
 * @author Henri Frilund
 */
public abstract class FormElement extends RenderableComponent {
    private CharSequence binding;
    private List&lt;ValidationRule&gt; validationRules;
    protected String[] value;
    private List&lt;ValidationError&gt; validationErrors;
<span class="nc" id="L68">    protected String genericFieldErrorMessage = &quot;fieldError&quot;;</span>
    private String formElementName;
    private boolean complex;

    protected FormElement(Component parent, String elementName, String componentId) {
<span class="nc" id="L73">        super(parent, componentId);</span>
<span class="nc" id="L74">        this.formElementName = elementName;</span>
<span class="nc" id="L75">    }</span>


    /**
     * Adds a validation rule to this form element. Validation rules are MVEL-expressions that are beefed up with a set of
     * predefined variables and a set of validation methods as a default context.
     * Example: &lt;br/&gt;
     * A validation expression &quot;isInt(value)&quot; is equivalent to Validations.getInstance().isInt(formElement.getValue);&lt;br/&gt;
     * &lt;b&gt;Predefined variables:&lt;/b&gt;&lt;br/&gt;
     * &lt;ol&gt;
     *  &lt;li&gt;value - the submitted form value for this field.&lt;/li&gt;
     *  &lt;li&gt;element - a reference to &lt;i&gt;this&lt;/i&gt;, ie. gives access to the form element itself.&lt;/li&gt;
     *  &lt;li&gt;form - a reference to the Form-component that contains the form element.&lt;/li&gt;
     * &lt;/ol&gt;
     * &lt;br/&gt;
     * Additional variables can be injected using StandaloneComponent.config().useValidationVariable() method.
     * @param elExpression A valid MVEL-expression
     * @param message The message to put in the ValidationError object if the validation fails. Can be an el-expression or a localized message.
     * @return
     * @see Validations Validations for currently avaiable validation methods.
     */
    public FormElement validationRule(String elExpression, String message) {
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (validationRules == null)</span>
<span class="nc" id="L98">            validationRules = new LinkedList&lt;ValidationRule&gt;();</span>

<span class="nc" id="L100">        validationRules.add(new ValidationRule(elExpression, message));</span>

<span class="nc bnc" id="L102" title="All 4 branches missed.">        if (elExpression.contains(&quot;element&quot;) || elExpression.contains(&quot;form&quot;))</span>
<span class="nc" id="L103">            complex = true;</span>

<span class="nc" id="L105">        return this;</span>
    }

    //TODO
    public FormElement validationRule(String elExpression) {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (validationRules == null)</span>
<span class="nc" id="L111">            validationRules = new LinkedList&lt;ValidationRule&gt;();</span>

<span class="nc" id="L113">        validationRules.add(new ValidationRule(elExpression, &quot;&quot;));</span>

<span class="nc bnc" id="L115" title="All 4 branches missed.">        if (elExpression.contains(&quot;element&quot;) || elExpression.contains(&quot;form&quot;))</span>
<span class="nc" id="L116">            complex = true;</span>

<span class="nc" id="L118">        return this;</span>
    }

    /**
     * Returns the binding for this form element.
     * @return
     */
    public CharSequence getBinding() {
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (binding == null)</span>
<span class="nc" id="L127">            return &quot;&quot;;</span>
        //throw new WheelException(&quot;No binding set for form element. Call value() or fieldBinding() on this form element.&quot;, this);

<span class="nc" id="L130">        return binding;</span>
    }

    //TODO
    public FormElement setBinding(CharSequence binding) {
<span class="nc" id="L135">        this.binding = binding;</span>
<span class="nc" id="L136">        return this;</span>
    }

    /**
     * Returns true if no value has been set due to a form submit to this element yet.
     * @return
     */
    public boolean isEmpty() {
<span class="nc bnc" id="L144" title="All 8 branches missed.">        return value == null || value.length == 0 || value[0] == null || value[0].length() == 0;</span>
    }

    /**
     * Causes this element to validate itself against given input value.
     */
    public void validate() {
<span class="nc bnc" id="L151" title="All 4 branches missed.">        if (validationRules == null || validationRules.isEmpty())</span>
<span class="nc" id="L152">            return;</span>

<span class="nc" id="L154">        Map vars = new HashMap();</span>
<span class="nc" id="L155">        vars.put(&quot;value&quot;, value[0]);</span>
<span class="nc" id="L156">        vars.put(&quot;element&quot;, this);</span>
<span class="nc" id="L157">        vars.put(&quot;form&quot;, _getForm(true));</span>

<span class="nc" id="L159">        Map otherVariables = _getTopLevelComponent(true).validationVariables;</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (otherVariables != null)</span>
<span class="nc" id="L162">            vars.putAll(otherVariables);</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">        for (ValidationRule validationRule : validationRules) {</span>

<span class="nc" id="L166">            Boolean valid = null;</span>
            try {
<span class="nc" id="L168">                valid = (Boolean) MVEL.eval(validationRule.getElExpression(), Validations.getInstance(), vars);</span>
<span class="nc" id="L169">            } catch (Throwable e) {</span>
<span class="nc" id="L170">                throw new WheelException(&quot;Validation expression &quot; + validationRule.getElExpression() + &quot; failed.&quot;, e, this);</span>
<span class="nc" id="L171">            }</span>

<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (!valid.booleanValue()) {</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">                if (validationErrors == null)</span>
<span class="nc" id="L175">                    validationErrors = new LinkedList&lt;ValidationError&gt;();</span>

<span class="nc" id="L177">                validationErrors.add(new ValidationError(eval(validationRule.getMessage()), this));</span>
            }
<span class="nc" id="L179">        }</span>

<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (!isValid())</span>
<span class="nc" id="L182">            addInternalRenderHint(&quot;error&quot;);</span>
<span class="nc" id="L183">    }</span>

    /**
     * Sets the value retrieved from a form submit for this element. Calling this method also triggers a call to validate();
     * @param value
     */
    public void _setSubmitValue(String[] value) {
<span class="nc" id="L190">        this.value = value;</span>

<span class="nc" id="L192">        validate();</span>

<span class="nc bnc" id="L194" title="All 4 branches missed.">        if (isValid() &amp;&amp; !isEmpty()) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (binding instanceof ElExpression) {</span>
                try {
<span class="nc" id="L197">                    ((ElExpression)binding).store(_getTopLevelComponent(true), this, value[0]);</span>
<span class="nc" id="L198">                } catch (Exception e) {</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">                    if (validationErrors == null)</span>
<span class="nc" id="L200">                        validationErrors = new LinkedList&lt;ValidationError&gt;();</span>

<span class="nc" id="L202">                    validationErrors.add(new ValidationError(eval(message(genericFieldErrorMessage)), this));</span>
<span class="nc" id="L203">                    addInternalRenderHint(&quot;error&quot;);</span>
<span class="nc" id="L204">                }</span>
            }
        }
<span class="nc" id="L207">    }</span>

    /**
     * Adds a label to this form element. Will create a &amp;lt;label for=&quot;componentId&quot;&amp;gt;label text&amp;lt;/label&amp;gt; tag before the form element.
     * @param label The text to render inside the label-tag.
     * @return
     */
    public FormElement label(String label) {
<span class="nc" id="L215">        RenderableComponent l = (RenderableComponent)getParent().create().label(label).attribute(&quot;for&quot;, getComponentId());</span>

<span class="nc" id="L217">        addRenderBefore(l);</span>

<span class="nc" id="L219">        return this;</span>
    }


    /**
     * Returns all validation errors for this form element.
     * @return
     */
    public List&lt;ValidationError&gt; getErrors() {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (validationErrors == null)</span>
<span class="nc" id="L229">            return Collections.EMPTY_LIST;</span>

<span class="nc" id="L231">        return validationErrors;</span>
    }

    /**
     * Returns true if this form element is valid.
     * @return
     */
    public boolean isValid() {
<span class="nc bnc" id="L239" title="All 6 branches missed.">        if (validationErrors == null || (validationErrors != null &amp;&amp; validationErrors.isEmpty()))</span>
<span class="nc" id="L240">            return true;</span>

<span class="nc" id="L242">        return false;</span>
    }


    /**
     * Returns the value recieved in form submit.
     * @return
     */
    public String[] _getSubmitValues() {
<span class="nc" id="L251">        return value;</span>
    }

    /**
     * Returns the value recieved in form submit.
     * @return
     */
    public String _getSubmitValue() {
<span class="nc" id="L259">        return value[0];</span>
    }


    @Override
    public synchronized void _clear() {
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (_getRenderBeforeMe() != null)</span>
<span class="nc" id="L266">            _getRenderBeforeMe().clear();</span>

<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (_getRenderAfterMe() != null)</span>
<span class="nc" id="L269">            _getRenderAfterMe().clear();</span>

<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (_getActions() != null)</span>
<span class="nc" id="L272">            _getActions().clear();</span>

<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (_getRenderHints() != null)</span>
<span class="nc" id="L275">            _getRenderHints().clear();</span>

<span class="nc" id="L277">    }</span>

    /**
     * A shorthand method to mark this form element as required.
     * @return
     */
    public FormElement required() {
<span class="nc" id="L284">        validationRule(&quot;required(value)&quot;, message(genericFieldErrorMessage));</span>
<span class="nc" id="L285">        return this;</span>
    }

    /**
     * A shorthand method to mark this form element as an integer.
     * @return
     */
    public FormElement isInt() {
<span class="nc" id="L293">        validationRule(&quot;isInt(value)&quot;, message(genericFieldErrorMessage));</span>
<span class="nc" id="L294">        return this;</span>
    }


    protected String defaultDomEvent() {
<span class="nc" id="L299">        return &quot;onchange&quot;;</span>
    }

    public FormElement setFormElementName(String name) {
<span class="nc" id="L303">        this.formElementName = name;</span>
<span class="nc" id="L304">        return this;</span>
    }

    public String getFormElementName() {
<span class="nc" id="L308">        return formElementName;</span>
    }


    @Override
    public void _render(XmlSerializer serializer) throws IOException {
<span class="nc" id="L314">        attribute(&quot;name&quot;, getFormElementName().toString());</span>
<span class="nc" id="L315">        super._render(serializer);</span>
<span class="nc" id="L316">    }</span>

    public FormElement fieldBinding(String binding) {
<span class="nc" id="L319">        this.binding =  el(binding);</span>
<span class="nc" id="L320">        return this;</span>
    }

    public FormElement value(String value) {
<span class="nc" id="L324">        throw new WheelException(&quot;This form element cannot be bound to a literal value.&quot;, this);</span>
    }

    public FormElement initialFieldValue(String value) {
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (!(getBinding() instanceof ElExpression))</span>
<span class="nc" id="L329">            throw new WheelException(&quot;Initial field value can only be set for a bound field element.&quot;, this);</span>

<span class="nc" id="L331">        _getTopLevelComponent(false).config().initialFieldValue(getBinding().toString(), value);</span>
<span class="nc" id="L332">        return this;</span>
    }

    public FormElement initialFieldValue(String value, Object emptyValue) {
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (!(getBinding() instanceof ElExpression))</span>
<span class="nc" id="L337">            throw new WheelException(&quot;Initial field value can only be set for a bound field element.&quot;, this);</span>

<span class="nc" id="L339">        _getTopLevelComponent(false).config().initialFieldValue(getBinding().toString(), value, emptyValue);</span>
<span class="nc" id="L340">        return this;</span>
    }

    public FormElement addValidationError(String message) {
<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (validationErrors == null)</span>
<span class="nc" id="L345">            validationErrors = new LinkedList&lt;ValidationError&gt;();</span>

<span class="nc" id="L347">        validationErrors.add(new ValidationError(message, this));</span>

<span class="nc" id="L349">        return this;</span>
    }

    boolean isComplex() {
<span class="nc" id="L353">        return complex;</span>
    }

    void serialize(StringBuilder sb) {
<span class="nc" id="L357">        sb.append(formElementName).append(&quot;$$&quot;);</span>
<span class="nc" id="L358">        sb.append(getComponentName()).append(&quot;$$&quot;);</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (getBinding() instanceof ElExpression)</span>
<span class="nc" id="L361">            sb.append(&quot;el:&quot;).append(getBinding());</span>
        else
<span class="nc" id="L363">            sb.append(getBinding());</span>

<span class="nc bnc" id="L365" title="All 2 branches missed.">        if (validationRules != null) {</span>
<span class="nc" id="L366">            sb.append(&quot;$$&quot;);</span>

<span class="nc" id="L368">            Iterator&lt;ValidationRule&gt; rulesIterator = validationRules.iterator();</span>

<span class="nc bnc" id="L370" title="All 2 branches missed.">            while(rulesIterator.hasNext()) {</span>
<span class="nc" id="L371">                ValidationRule rule = rulesIterator.next();</span>

<span class="nc" id="L373">                sb.append(rule.getElExpression()).append(&quot;$$&quot;);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">                sb.append(rule.getMessage().length() == 0 ? &quot; &quot; : rule.getMessage()).append(&quot;$$&quot;);</span>
<span class="nc" id="L375">            }</span>
        }
<span class="nc" id="L377">    }</span>

    FormElement deserialize(Form form, String serializedString) {
<span class="nc" id="L380">        String[] split = serializedString.split(&quot;$$&quot;);</span>

<span class="nc" id="L382">        String name = split[0];</span>
<span class="nc" id="L383">        String binding = split[1];</span>
<span class="nc" id="L384">        FormElement element = null;</span>

<span class="nc bnc" id="L386" title="All 2 branches missed.">        if (split[2].equals(&quot;Submit&quot;)) {</span>
<span class="nc" id="L387">            element = create().submit(name);</span>
        }
<span class="nc bnc" id="L389" title="All 2 branches missed.">        else if (split[2].equals(&quot;Hidden&quot;)) {</span>
<span class="nc" id="L390">            element = create().hidden(name);</span>
        }
<span class="nc bnc" id="L392" title="All 2 branches missed.">        else if (split[2].equals(&quot;Checkbox&quot;)) {</span>
<span class="nc" id="L393">            element = create().hidden(name);</span>
        }
<span class="nc bnc" id="L395" title="All 2 branches missed.">        else if (split[2].equals(&quot;TextInput&quot;)) {</span>
<span class="nc" id="L396">            element = create().textInput(name);</span>
        }

<span class="nc bnc" id="L399" title="All 2 branches missed.">        if (binding.startsWith(&quot;el:&quot;))</span>
<span class="nc" id="L400">            element.fieldBinding(binding);</span>
        else
<span class="nc" id="L402">            element.value(binding);</span>


<span class="nc bnc" id="L405" title="All 2 branches missed.">        if (split.length &gt; 3) {</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">            for (int i = 3; i &lt; split.length; i += 2) {</span>
<span class="nc" id="L407">                String rule = split[i];</span>
<span class="nc" id="L408">                String message = split[i+1];</span>

<span class="nc" id="L410">                element.validationRule(rule, message);</span>
            }
        }

<span class="nc" id="L414">        return element;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>