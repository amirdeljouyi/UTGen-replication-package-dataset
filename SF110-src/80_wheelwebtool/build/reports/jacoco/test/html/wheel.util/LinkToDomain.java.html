<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LinkToDomain.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">80_wheelwebtool</a> &gt; <a href="index.source.html" class="el_package">wheel.util</a> &gt; <span class="el_source">LinkToDomain.java</span></div><h1>LinkToDomain.java</h1><pre class="source lang-java linenums">/*
Copyright (c) 2007-2008, Henri Frilund

All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

    * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.
    * Neither the name of the &lt;ORGANIZATION&gt; nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
&quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
package wheel.util;

import wheel.components.ElExpression;
import wheel.components.StandaloneComponent;

import java.io.Serializable;
import java.util.*;

public class LinkToDomain implements Serializable {
    private ElExpression fieldName;
    private ElExpression elExpression;
    private int hashCode;


<span class="nc" id="L38">    public LinkToDomain(ElExpression fieldName, ElExpression elExpression) {</span>
<span class="nc" id="L39">        this.fieldName = fieldName;</span>
<span class="nc" id="L40">        this.elExpression = elExpression;</span>

<span class="nc" id="L42">        this.fieldName.errorMessage(&quot;Could not evaluate expression &quot; + this.fieldName + &quot; to access field.&quot;);</span>
<span class="nc" id="L43">        this.elExpression.errorMessage(&quot;Could not evaluate expression &quot; + this.elExpression + &quot; to access linked domain object.&quot;);</span>
<span class="nc" id="L44">    }</span>

    public ElExpression getFieldName() {
<span class="nc" id="L47">        return fieldName;</span>
    }

    public ElExpression getElExpression() {
<span class="nc" id="L51">        return elExpression;</span>
    }

    public int getHashCode() {
<span class="nc" id="L55">        return hashCode;</span>
    }


    public Object getCopy(StandaloneComponent topLevelComponent) {
<span class="nc" id="L60">        Object domainValue = null;</span>

        try {
<span class="nc" id="L63">            domainValue = elExpression.eval(topLevelComponent, topLevelComponent);</span>
<span class="nc" id="L64">        } catch (Exception e) {}</span>

<span class="nc bnc" id="L66" title="All 2 branches missed.">        if (domainValue != null)</span>
<span class="nc" id="L67">            hashCode = domainValue.hashCode();</span>

<span class="nc bnc" id="L69" title="All 2 branches missed.">        if (domainValue == null)</span>
<span class="nc" id="L70">            return null;</span>

<span class="nc" id="L72">        return copyObject(domainValue);</span>
    }

    public void writeToDomain(StandaloneComponent topLevelComponent) {
<span class="nc" id="L76">        Object fieldValue = fieldName.eval(topLevelComponent, topLevelComponent);</span>
        
<span class="nc" id="L78">        fieldValue = copyObject(fieldValue);</span>
        
        //TODO this might be a bit too optimistic solution
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (fieldValue.hashCode() == hashCode)</span>
<span class="nc" id="L82">            return;</span>

<span class="nc" id="L84">        hashCode = fieldValue.hashCode();</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (fieldValue instanceof Collection) {</span>
<span class="nc" id="L87">            Collection collection = (Collection)fieldValue;</span>
<span class="nc" id="L88">            Object[] asArray = collection.toArray();</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">            for (int i = 0; i &lt; asArray.length; i++) {</span>
<span class="nc" id="L91">                Object o = asArray[i];</span>
<span class="nc" id="L92">                new ElExpression(elExpression.getExpression() + &quot;[&quot; + i + &quot;]&quot;).store(topLevelComponent, topLevelComponent, o);</span>
            }
<span class="nc bnc" id="L94" title="All 2 branches missed.">        } else if (fieldValue instanceof Map) {</span>
<span class="nc" id="L95">            Map map = (Map)fieldValue;</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">            for (Object key : map.keySet()) {</span>
<span class="nc" id="L98">                Object value = map.get(key);</span>
<span class="nc" id="L99">                new ElExpression(elExpression.getExpression() + &quot;[&quot; + key + &quot;]&quot;).store(topLevelComponent, topLevelComponent, value);</span>
<span class="nc" id="L100">            }</span>
<span class="nc" id="L101">        }</span>
        else
<span class="nc" id="L103">            elExpression.store(topLevelComponent, topLevelComponent, fieldValue);</span>
<span class="nc" id="L104">    }</span>

    public void copyFromDomain(StandaloneComponent topLevelComponent) {
<span class="nc" id="L107">        Object domainValue = getCopy(topLevelComponent);</span>


<span class="nc" id="L110">        fieldName.store(topLevelComponent, topLevelComponent, domainValue);</span>
<span class="nc" id="L111">    }</span>

    private Object copyObject(Object obj) {
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (obj instanceof Date)</span>
<span class="nc" id="L115">            return new Date(((Date)obj).getTime());</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        else if (obj instanceof Calendar) {</span>
<span class="nc" id="L117">            Calendar copy = new GregorianCalendar();</span>
<span class="nc" id="L118">            copy.setTimeInMillis(((Calendar)obj).getTimeInMillis());</span>
<span class="nc" id="L119">            return copy;</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        } else if (obj instanceof List) {</span>
<span class="nc" id="L121">            List copy = new LinkedList();</span>

<span class="nc" id="L123">            List original = (List)obj;</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">            for (Object o : original) {</span>
<span class="nc" id="L126">                copy.add(copyObject(o));</span>
<span class="nc" id="L127">            }</span>

<span class="nc" id="L129">            return copy;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        } else if (obj instanceof Set) {</span>
<span class="nc" id="L131">            Set copy = new HashSet();</span>

<span class="nc" id="L133">            Set original = (Set)obj;</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">            for (Object o : original) {</span>
<span class="nc" id="L136">                copy.add(copyObject(o));</span>
<span class="nc" id="L137">            }</span>

<span class="nc" id="L139">            return copy;</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        } else if (obj instanceof Map) {</span>
<span class="nc" id="L141">            Map copy = new HashMap();</span>

<span class="nc" id="L143">            Map original = (Map)obj;</span>

<span class="nc bnc" id="L145" title="All 2 branches missed.">            for (Object key : original.keySet()) {</span>
<span class="nc" id="L146">                copy.put(key, copyObject(original.get(key)));</span>
<span class="nc" id="L147">            }</span>

<span class="nc" id="L149">            return copy;</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        } else if (obj instanceof Integer) {</span>
<span class="nc" id="L151">            return new Integer(((Integer)obj).intValue());</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        } else if (obj instanceof Double) {</span>
<span class="nc" id="L153">            return new Double(((Double)obj).doubleValue());</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">        } else if (obj instanceof Short) {</span>
<span class="nc" id="L155">            return new Short(((Short)obj).shortValue());</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">        } else if (obj instanceof Boolean) {</span>
<span class="nc" id="L157">            return new Boolean(((Boolean)obj).booleanValue());</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        } else if (obj instanceof Float) {</span>
<span class="nc" id="L159">            return new Float(((Float)obj).floatValue());</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        } else if (obj instanceof Long) {</span>
<span class="nc" id="L161">            return new Long(((Long)obj).longValue());</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        } else if (obj instanceof Character) {</span>
<span class="nc" id="L163">            return new Character(((Character)obj).charValue());</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        } else if (obj instanceof Byte) {</span>
<span class="nc" id="L165">            return new Byte(((Byte)obj).byteValue());</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        } else if (obj instanceof String)</span>
<span class="nc" id="L167">            return new String((String)obj);</span>

<span class="nc" id="L169">        return obj;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>