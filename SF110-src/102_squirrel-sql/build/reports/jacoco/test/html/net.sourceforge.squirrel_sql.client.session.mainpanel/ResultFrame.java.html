<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ResultFrame.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.session.mainpanel</a> &gt; <span class="el_source">ResultFrame.java</span></div><h1>ResultFrame.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.session.mainpanel;
/*
 * Copyright (C) 2001-2004 Johan Compagner
 * jcompagner@j-com.nl
 *
 * Modifications Copyright (C) 2003-2004 Jason Height
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */

import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.DialogWidget;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.SessionDialogWidget;
import net.sourceforge.squirrel_sql.client.resources.SquirrelResources;
import net.sourceforge.squirrel_sql.client.session.ISession;
import net.sourceforge.squirrel_sql.client.session.SQLExecutionInfo;
import net.sourceforge.squirrel_sql.client.session.action.ReturnResultTabAction;
import net.sourceforge.squirrel_sql.client.session.event.ISQLExecutionListener;
import net.sourceforge.squirrel_sql.fw.datasetviewer.IDataSetUpdateableTableModel;
import net.sourceforge.squirrel_sql.fw.datasetviewer.ResultSetDataSet;
import net.sourceforge.squirrel_sql.fw.datasetviewer.ResultSetMetaDataDataSet;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;

/**
 * JASON: Rename to ResultInternalFrame
 * Torn off frame that contains SQL results.
 *
 * @author &lt;A HREF=&quot;mailto:jcompagner@j-com.nl&quot;&gt;Johan Compagner&lt;/A&gt;
 */
public class ResultFrame extends SessionDialogWidget
{
	/** Logger for this class. */
<span class="nc" id="L54">	private static ILogger s_log = LoggerController.createLogger(ResultFrame.class);</span>

<span class="nc" id="L56">    private static final StringManager s_stringMgr = StringManagerFactory.getStringManager(ResultFrame.class);</span>

   private ISession _session;
   /** SQL Results. */
	private IResultTab _tab;
   private ResultTabFactory _resultTabFactory;
   private ResultFrameListener _resultFrameListener;
   private JButton _btnReturnToTab;
   private JCheckBox _chkOnTop;
   private JButton _btnReRun;
   private JPanel _centerPanel;

   /**
    * Ctor.
    *
    *
    *
    *
    *
    * @param	session		Current session.
    * @param	tab			SQL results tab.
    *
    * @param resultTabFactory
    * @param resultFrameListener
    *@param isOnRerun  @throws	IllegalArgumentException
    * 			If a &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;ISession&lt;/TT&gt; or
    *			&lt;TT&gt;ResultTab&lt;/TT&gt; passed.
    */
   public ResultFrame(final ISession session, IResultTab tab, ResultTabFactory resultTabFactory, ResultFrameListener resultFrameListener, boolean checkStayOnTop, boolean isOnRerun)
   {
<span class="nc" id="L86">      super(getFrameTitle(session, tab), true, true, true, true, session);</span>
<span class="nc" id="L87">      _session = session;</span>
<span class="nc" id="L88">      _tab = tab;</span>
<span class="nc" id="L89">      _resultTabFactory = resultTabFactory;</span>
<span class="nc" id="L90">      _resultFrameListener = resultFrameListener;</span>

<span class="nc" id="L92">      setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span>

<span class="nc" id="L94">      getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L95">      final IApplication app = session.getApplication();</span>


<span class="nc" id="L98">      getContentPane().add(createButtonPanel(session, app, checkStayOnTop), BorderLayout.NORTH);</span>
<span class="nc" id="L99">      _centerPanel = new JPanel(new GridLayout(1,1));</span>
<span class="nc" id="L100">      getContentPane().add(_centerPanel, BorderLayout.CENTER);</span>
<span class="nc" id="L101">      _centerPanel.add(_tab.getOutputComponent());</span>

<span class="nc" id="L103">      _chkOnTop.addActionListener(new ActionListener()</span>
<span class="nc" id="L104">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L107">            onStayOnTopChanged();</span>
<span class="nc" id="L108">         }</span>
      });

<span class="nc" id="L111">      _btnReRun.addActionListener(new ActionListener()</span>
<span class="nc" id="L112">      {</span>
         @Override
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L116">            onRerun();</span>
<span class="nc" id="L117">         }</span>
      });

<span class="nc bnc" id="L120" title="All 2 branches missed.">      if (false == isOnRerun)</span>
      {
<span class="nc" id="L122">         showFrame(this, false);</span>
      }
<span class="nc" id="L124">   }</span>

   private void onRerun()
   {
<span class="nc" id="L128">      _btnReturnToTab.setEnabled(false);</span>
<span class="nc" id="L129">      _btnReRun.setEnabled(false);</span>
<span class="nc" id="L130">      _centerPanel.removeAll();</span>
<span class="nc" id="L131">      new SQLExecutionHandler(_tab, _session, _tab.getSqlString(), createSQLExecutionHandlerListener(), new ISQLExecutionListener[0]);</span>
<span class="nc" id="L132">   }</span>

   private ISQLExecutionHandlerListener createSQLExecutionHandlerListener()
   {
<span class="nc" id="L136">      return new ISQLExecutionHandlerListener()</span>
<span class="nc" id="L137">      {</span>
         @Override
         public void addResultsTab(SQLExecutionInfo info, ResultSetDataSet rsds, ResultSetMetaDataDataSet rsmdds, IDataSetUpdateableTableModel creator, IResultTab resultTabToReplace)
         {
<span class="nc" id="L141">            onAddResultsTab(info, rsds, rsmdds, creator, resultTabToReplace);</span>
<span class="nc" id="L142">         }</span>

         @Override
         public void removeCancelPanel(CancelPanelCtrl cancelPanelCtrl, IResultTab resultTabToReplace)
         {
<span class="nc" id="L147">            onRemoveCancelPanel(cancelPanelCtrl, resultTabToReplace);</span>
<span class="nc" id="L148">         }</span>

         @Override
         public void setCancelPanel(CancelPanelCtrl cancelPanelCtrl)
         {
<span class="nc" id="L153">            onSetCancelPanel(cancelPanelCtrl);</span>
<span class="nc" id="L154">         }</span>

         @Override
         public void displayErrors(ArrayList&lt;String&gt; sqlExecErrorMsgs, String lastExecutedStatement)
         {
<span class="nc" id="L159">            onDisplayErrors(sqlExecErrorMsgs, lastExecutedStatement);</span>
<span class="nc" id="L160">         }</span>
      };
   }

   private void onDisplayErrors(final ArrayList&lt;String&gt; sqlExecErrorMsgs, final String lastExecutedStatement)
   {
<span class="nc" id="L166">      SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L167">      {</span>
         public void run()
         {
<span class="nc" id="L170">            _centerPanel.removeAll();</span>
<span class="nc" id="L171">            ErrorPanel errorPanel = _resultTabFactory.createErrorPanel(sqlExecErrorMsgs, lastExecutedStatement);</span>
<span class="nc" id="L172">            errorPanel.hideCloseButton();</span>
<span class="nc" id="L173">            _centerPanel.add(errorPanel);</span>
<span class="nc" id="L174">            _btnReRun.setEnabled(true);</span>
<span class="nc" id="L175">         }</span>
      });
<span class="nc" id="L177">   }</span>

   private void onSetCancelPanel(final CancelPanelCtrl cancelPanelCtrl)
   {
<span class="nc" id="L181">      SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L182">      {</span>
         public void run()
         {
<span class="nc" id="L185">            _centerPanel.removeAll();</span>
<span class="nc" id="L186">            _centerPanel.add(cancelPanelCtrl.getPanel(), BorderLayout.CENTER);</span>
<span class="nc" id="L187">         }</span>
      });
<span class="nc" id="L189">   }</span>

   private void onRemoveCancelPanel(CancelPanelCtrl cancelPanelCtrl, IResultTab resultTabToReplace)
   {
<span class="nc" id="L193">      SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L194">      {</span>
         public void run()
         {
<span class="nc" id="L197">            _centerPanel.removeAll();</span>
<span class="nc" id="L198">         }</span>
      });
<span class="nc" id="L200">   }</span>

   private void onAddResultsTab(final SQLExecutionInfo info, final ResultSetDataSet rsds, final ResultSetMetaDataDataSet rsmdds, final IDataSetUpdateableTableModel creator, IResultTab resultTabToReplace)
   {
<span class="nc" id="L204">      SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L205">      {</span>
         public void run()
         {
            try
            {
               // We start a new frame here because reusing the current one for the new result led to repaint problems
<span class="nc" id="L211">               _centerPanel.removeAll();</span>
<span class="nc" id="L212">               ResultTab tab = _resultTabFactory.createResultTab(info, creator, rsds, rsmdds);</span>
<span class="nc" id="L213">               ResultFrame frame = new ResultFrame(_session, tab, _resultTabFactory, _resultFrameListener, _chkOnTop.isSelected(), true);</span>
<span class="nc" id="L214">               showFrame(frame, true);</span>
<span class="nc" id="L215">               setVisible(false);</span>
<span class="nc" id="L216">               dispose();</span>

<span class="nc" id="L218">               _resultFrameListener.frameReplaced(ResultFrame.this, frame);</span>
            }
<span class="nc" id="L220">            catch (Throwable t)</span>
            {
<span class="nc" id="L222">               _session.showErrorMessage(t);</span>
<span class="nc" id="L223">            }</span>
<span class="nc" id="L224">         }</span>
      });
<span class="nc" id="L226">   }</span>

   private void showFrame(ResultFrame frame, boolean isOnRerun)
   {
<span class="nc" id="L230">      _session.getApplication().getMainFrame().addWidget(frame);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">      if (isOnRerun)</span>
      {
<span class="nc" id="L233">         frame.setBounds(getBounds());</span>
      }
      else
      {
<span class="nc" id="L237">         frame.pack();</span>
<span class="nc" id="L238">         DialogWidget.centerWithinDesktop(frame);</span>
      }

<span class="nc" id="L241">      frame.setVisible(true);</span>
<span class="nc" id="L242">      frame.toFront();</span>
<span class="nc" id="L243">      frame.requestFocus();</span>
<span class="nc" id="L244">   }</span>

   private JPanel createButtonPanel(ISession session, IApplication app, boolean checkStayOnTop)
   {
<span class="nc" id="L248">      JPanel pnlButtons = new JPanel(new GridBagLayout());</span>
      GridBagConstraints gbc;

<span class="nc" id="L251">      _btnReturnToTab = new JButton(new ReturnResultTabAction(app, this));</span>
<span class="nc" id="L252">      gbc = new GridBagConstraints(0,0,1,1,0,0,GridBagConstraints.NORTHWEST, GridBagConstraints.NONE, new Insets(0,5,0,5), 0,0);</span>
<span class="nc" id="L253">      pnlButtons.add(_btnReturnToTab, gbc);</span>

      // i18n[resultFrame.stayOnTop=Stay on top]
<span class="nc" id="L256">      _chkOnTop = new JCheckBox(s_stringMgr.getString(&quot;resultFrame.stayOnTop&quot;));</span>
<span class="nc" id="L257">      gbc = new GridBagConstraints(1,0,1,1,0,0,GridBagConstraints.WEST, GridBagConstraints.NONE, new Insets(0,5,0,5), 0,0);</span>
<span class="nc" id="L258">      pnlButtons.add(_chkOnTop, gbc);</span>
<span class="nc" id="L259">      _chkOnTop.setSelected(checkStayOnTop);</span>
<span class="nc" id="L260">      initLayer();</span>

<span class="nc" id="L262">      _chkOnTop.setVisible(session.getApplication().getDesktopStyle().supportsLayers());</span>

<span class="nc" id="L264">      gbc = new GridBagConstraints(2,0,1,1,1,0,GridBagConstraints.WEST, GridBagConstraints.HORIZONTAL, new Insets(0,5,0,5), 0,0);</span>
<span class="nc" id="L265">      pnlButtons.add(new JPanel(), gbc);</span>

<span class="nc" id="L267">      ImageIcon icon = session.getApplication().getResources().getIcon(SquirrelResources.IImageNames.RERUN);</span>
<span class="nc" id="L268">      _btnReRun = new JButton(icon);</span>
<span class="nc" id="L269">      _btnReRun.setToolTipText(s_stringMgr.getString(&quot;ResultFrame.rerun&quot;));</span>
<span class="nc" id="L270">      gbc = new GridBagConstraints(3,0,1,1,0,0,GridBagConstraints.WEST, GridBagConstraints.NONE, new Insets(0,5,0,5), 0,0);</span>
<span class="nc" id="L271">      pnlButtons.add(_btnReRun, gbc);</span>

<span class="nc" id="L273">      return pnlButtons;</span>
   }

   private void onStayOnTopChanged()
   {
<span class="nc" id="L278">      initLayer();</span>
<span class="nc" id="L279">      toFront();</span>
<span class="nc" id="L280">   }</span>

   private void initLayer()
   {
<span class="nc bnc" id="L284" title="All 2 branches missed.">      if(_chkOnTop.isSelected())</span>
      {
<span class="nc" id="L286">         setLayer(JLayeredPane.PALETTE_LAYER.intValue());</span>
      }
      else
      {
<span class="nc" id="L290">         setLayer(JLayeredPane.DEFAULT_LAYER.intValue());</span>
      }
<span class="nc" id="L292">   }</span>

   /**
	 * Close this window.
	 */
	public void dispose()
	{
<span class="nc bnc" id="L299" title="All 2 branches missed.">		if (_tab != null)</span>
		{
<span class="nc" id="L301">			_tab.closeTab();</span>
<span class="nc" id="L302">			_tab = null;</span>
		}
<span class="nc" id="L304">		super.dispose();</span>
<span class="nc" id="L305">	}</span>

	public void returnToTabbedPane()
	{
<span class="nc" id="L309">		s_log.debug(&quot;ResultFrame.returnToTabbedPane()&quot;);</span>
<span class="nc" id="L310">		getContentPane().remove(_tab.getOutputComponent());</span>
<span class="nc" id="L311">		_tab.returnToTabbedPane();</span>
<span class="nc" id="L312">		_tab = null;</span>
<span class="nc" id="L313">		dispose();</span>
<span class="nc" id="L314">	}</span>

	private static String getFrameTitle(ISession session, IResultTab tab)
		throws IllegalArgumentException
	{
<span class="nc bnc" id="L319" title="All 2 branches missed.">		if (tab == null)</span>
		{
<span class="nc" id="L321">			throw new IllegalArgumentException(&quot;Null ResultTab passed&quot;);</span>
		}
<span class="nc bnc" id="L323" title="All 2 branches missed.">		if (session == null)</span>
		{
<span class="nc" id="L325">			throw new IllegalArgumentException(&quot;Null ISession passed&quot;);</span>
		}

<span class="nc" id="L328">		return session.getTitle() + &quot; - &quot; + tab.getViewableSqlString();</span>
	}

   public IResultTab getTab()
   {
<span class="nc" id="L333">      return _tab;</span>
   }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>