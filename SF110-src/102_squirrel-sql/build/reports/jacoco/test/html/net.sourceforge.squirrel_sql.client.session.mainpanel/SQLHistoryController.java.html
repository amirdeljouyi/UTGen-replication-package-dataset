<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLHistoryController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.session.mainpanel</a> &gt; <span class="el_source">SQLHistoryController.java</span></div><h1>SQLHistoryController.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.session.mainpanel;

import net.sourceforge.squirrel_sql.client.session.ISQLPanelAPI;
import net.sourceforge.squirrel_sql.client.session.ISession;
import net.sourceforge.squirrel_sql.fw.gui.GUIUtils;
import net.sourceforge.squirrel_sql.fw.gui.SortableTableModel;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;

import javax.swing.table.*;
import javax.swing.event.ListSelectionListener;
import javax.swing.event.ListSelectionEvent;
import javax.swing.*;
import java.util.ArrayList;
import java.util.prefs.Preferences;
import static java.lang.Math.*;
import java.awt.event.*;
import java.awt.*;


public class SQLHistoryController
{
   private static final String PREF_KEY_SQL_HISTORY_COL_NAME_PREFIX_ = &quot;Squirrel.sqlHistoryColIxPrefix_&quot;;

   @SuppressWarnings(&quot;unused&quot;)
<span class="nc" id="L26">   private static final StringManager s_stringMgr =</span>
<span class="nc" id="L27">       StringManagerFactory.getStringManager(SQLHistoryController.class);</span>


   private SQLHistoryDlg _dlg;
   private ArrayList&lt;SQLHistoryItemWrapper&gt; _sqlHistoryItemWrappers;
   private boolean _dontReactToChkFiltered;
   private ISQLPanelAPI _sqlPanelAPI;

<span class="nc" id="L35">   private JPopupMenu _popUp = new JPopupMenu();</span>


   @SuppressWarnings(&quot;serial&quot;)
   public SQLHistoryController(ISession session, ISQLPanelAPI sqlPanelAPI, ArrayList&lt;SQLHistoryItem&gt; items)
<span class="nc" id="L40">   {</span>
<span class="nc" id="L41">      _sqlPanelAPI = sqlPanelAPI;</span>
<span class="nc" id="L42">      _sqlHistoryItemWrappers = SQLHistoryItemWrapper.wrap(items);</span>
<span class="nc" id="L43">      _dlg = new SQLHistoryDlg(session.getApplication().getMainFrame(), session.getActiveSessionWindow().getTitle());</span>

<span class="nc" id="L45">      GUIUtils.centerWithinParent(_dlg);</span>

<span class="nc" id="L47">      _dlg.setVisible(true);</span>

<span class="nc" id="L49">      _sqlPanelAPI.addSqlPanelListener(new SqlPanelListener()</span>
<span class="nc" id="L50">      {</span>
         public void panelParentWindowClosing()
         {
<span class="nc" id="L53">            _dlg.close();</span>
<span class="nc" id="L54">         }</span>
      });


<span class="nc" id="L58">      _dlg.addWindowListener(new WindowAdapter()</span>
<span class="nc" id="L59">      {</span>
<span class="nc" id="L60">         boolean onWindowClosedCalled = false;</span>

         public void windowClosed(WindowEvent e)
         {
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if(false == onWindowClosedCalled)</span>
            {
<span class="nc" id="L66">               onWindowClosed();</span>
            }
<span class="nc" id="L68">         }</span>

         public void windowClosing(WindowEvent e)
         {
<span class="nc" id="L72">            onWindowClosed();</span>
<span class="nc" id="L73">            onWindowClosedCalled = true;</span>
<span class="nc" id="L74">         }</span>
      });


<span class="nc" id="L78">      SortableTableModel stm = (SortableTableModel) _dlg.tblHistoryItems.getModel();</span>
<span class="nc" id="L79">      ArrayList&lt;SQLHistoryItemWrapper&gt; copy = </span>
          new ArrayList&lt;SQLHistoryItemWrapper&gt;(_sqlHistoryItemWrappers);
<span class="nc" id="L81">      SqlHistoryTableModel dtm = new SqlHistoryTableModel(copy, stm);</span>
<span class="nc" id="L82">      stm.setActualModel(dtm);</span>

<span class="nc" id="L84">      final TableColumnModel tcm = new DefaultTableColumnModel();</span>
<span class="nc" id="L85">      _dlg.tblHistoryItems.setColumnModel(tcm);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">      for (int i = 0; i &lt; SQLHistoryItemWrapper.getColumns().length; ++i)</span>
      {
<span class="nc" id="L88">         final TableColumn col = new TableColumn(i);</span>
<span class="nc" id="L89">         tcm.addColumn(col);</span>
<span class="nc" id="L90">         String header = SQLHistoryItemWrapper.getColumns()[i];</span>
<span class="nc" id="L91">         col.setHeaderValue(header);</span>
<span class="nc" id="L92">         col.setPreferredWidth(Preferences.userRoot().getInt(PREF_KEY_SQL_HISTORY_COL_NAME_PREFIX_ + header, 50));</span>
      }


      // i18n[SQLHistoryController.mnuAppendSelectionToEditor=Append selected statements to SQL editor]
<span class="nc" id="L97">      JMenuItem mnuAppendSelectionToEditor = new JMenuItem(s_stringMgr.getString(&quot;SQLHistoryController.mnuAppendSelectionToEditor&quot;));</span>
<span class="nc" id="L98">      mnuAppendSelectionToEditor.addActionListener(new ActionListener()</span>
<span class="nc" id="L99">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L102">            onAppendSelectionToEditor();</span>
<span class="nc" id="L103">         }</span>
      });
<span class="nc" id="L105">      _popUp.add(mnuAppendSelectionToEditor);</span>


<span class="nc" id="L108">      _dlg.tblHistoryItems.getSelectionModel().addListSelectionListener(new ListSelectionListener()</span>
<span class="nc" id="L109">      {</span>
         public void valueChanged(ListSelectionEvent e)
         {
<span class="nc" id="L112">            onTblSelectionChanged(e);</span>
<span class="nc" id="L113">         }</span>
      });

<span class="nc" id="L116">      _dlg.tblHistoryItems.addMouseListener(new MouseAdapter()</span>
<span class="nc" id="L117">      {</span>
         public void mousePressed(MouseEvent evt)
         {
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (evt.getClickCount() == 2)</span>
            {
<span class="nc" id="L122">               onSQLSelected();</span>
            }
<span class="nc" id="L124">         }</span>
      });

<span class="nc" id="L127">      _dlg.tblHistoryItems.addMouseListener(new MouseAdapter()</span>
<span class="nc" id="L128">      {</span>
         public void mousePressed(MouseEvent evt)
         {
<span class="nc" id="L131">            maybeShowPopup(evt);</span>
<span class="nc" id="L132">         }</span>

         public void mouseReleased(MouseEvent e)
         {
<span class="nc" id="L136">            maybeShowPopup(e);</span>
<span class="nc" id="L137">         }</span>

      });




<span class="nc" id="L144">      _dlg.btnApplyFilter.addActionListener(new ActionListener()</span>
<span class="nc" id="L145">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L148">            onApplyFilter();</span>
<span class="nc" id="L149">         }</span>
      });

<span class="nc" id="L152">      _dlg.chkFiltered.addActionListener(new ActionListener()</span>
<span class="nc" id="L153">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L156">            onChckFiltered();</span>
<span class="nc" id="L157">         }</span>
      });

<span class="nc" id="L160">      _dlg.btnClose.addActionListener(new ActionListener()</span>
<span class="nc" id="L161">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L164">            closeAndSetFocus();</span>
<span class="nc" id="L165">         }</span>
      });

      
<span class="nc" id="L169">      AbstractAction closeAction = new AbstractAction()</span>
<span class="nc" id="L170">      {</span>
         public void actionPerformed(ActionEvent actionEvent)
         {
<span class="nc" id="L173">            closeAndSetFocus();</span>
<span class="nc" id="L174">         }</span>
      };

<span class="nc" id="L177">      KeyStroke escapeStroke = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</span>
<span class="nc" id="L178">      _dlg.getRootPane().getInputMap(JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L179">      _dlg.getRootPane().getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L180">      _dlg.getRootPane().getInputMap(JComponent.WHEN_FOCUSED).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L181">      _dlg.getRootPane().getActionMap().put(&quot;CloseAction&quot;, closeAction);</span>



<span class="nc" id="L185">   }</span>

   private void maybeShowPopup(MouseEvent evt)
   {
<span class="nc bnc" id="L189" title="All 2 branches missed.">      if (evt.isPopupTrigger())</span>
      {
<span class="nc" id="L191">         _popUp.show(evt.getComponent(), evt.getX(), evt.getY());</span>
      }
<span class="nc" id="L193">   }</span>

   private void closeAndSetFocus()
   {
<span class="nc" id="L197">      _dlg.close();</span>
<span class="nc" id="L198">      _sqlPanelAPI.getSQLEntryPanel().requestFocus();</span>
<span class="nc" id="L199">   }</span>

   private void onAppendSelectionToEditor()
   {
<span class="nc" id="L203">      int[] selRows = _dlg.tblHistoryItems.getSelectedRows();</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">      if (0 &lt; selRows.length)</span>
      {
<span class="nc bnc" id="L207" title="All 2 branches missed.">         for (int i = 0; i &lt; selRows.length; i++)</span>
         {
<span class="nc" id="L209">            _sqlPanelAPI.getSQLEntryPanel().appendText(&quot;\n&quot; + getSQLFromRow(selRows[i]) + &quot;\n&quot;);</span>
         }
      }
<span class="nc" id="L212">   }</span>

   private void onSQLSelected()
   {
<span class="nc" id="L216">      int[] selRows = _dlg.tblHistoryItems.getSelectedRows();</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">      if (1 == selRows.length)</span>
      {
<span class="nc" id="L220">         _sqlPanelAPI.getSQLEntryPanel().appendText(&quot;\n&quot; + getSQLFromRow(selRows[0]));</span>
<span class="nc" id="L221">         closeAndSetFocus();</span>
      }
<span class="nc" id="L223">   }</span>

   private void onChckFiltered()
   {
<span class="nc bnc" id="L227" title="All 2 branches missed.">      if(_dontReactToChkFiltered)</span>
      {
<span class="nc" id="L229">         return;</span>
      }


<span class="nc bnc" id="L233" title="All 2 branches missed.">      if(_dlg.chkFiltered.isSelected())</span>
      {
<span class="nc" id="L235">         onApplyFilter();</span>
      }
      else
      {
<span class="nc" id="L239">         SortableTableModel stm = (SortableTableModel) _dlg.tblHistoryItems.getModel();</span>
<span class="nc" id="L240">         SqlHistoryTableModel tm = (SqlHistoryTableModel) stm.getActualModel();</span>
         
<span class="nc" id="L242">         ArrayList&lt;SQLHistoryItemWrapper&gt; clone = </span>
             new ArrayList&lt;SQLHistoryItemWrapper&gt;(_sqlHistoryItemWrappers);
<span class="nc" id="L244">        tm.setData(clone);</span>
      }
<span class="nc" id="L246">   }</span>


   private void onApplyFilter()
   {
<span class="nc" id="L251">      SortableTableModel stm = (SortableTableModel) _dlg.tblHistoryItems.getModel();</span>
<span class="nc" id="L252">      SqlHistoryTableModel tm = (SqlHistoryTableModel) stm.getActualModel();</span>

<span class="nc bnc" id="L254" title="All 2 branches missed.">      if(_dlg.chkFiltered.isSelected())</span>
      {
<span class="nc" id="L256">          ArrayList&lt;SQLHistoryItemWrapper&gt; clone = </span>
              new ArrayList&lt;SQLHistoryItemWrapper&gt;(_sqlHistoryItemWrappers);
<span class="nc" id="L258">         tm.setData(clone);</span>
      }


<span class="nc" id="L262">      ArrayList&lt;SQLHistoryItemWrapper&gt; toRemove = new ArrayList&lt;SQLHistoryItemWrapper&gt;();</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">      for (SQLHistoryItemWrapper itemWrapper : tm.getData())</span>
      {
<span class="nc bnc" id="L265" title="All 2 branches missed.">         if(false == matchesFilter(itemWrapper))</span>
         {
<span class="nc" id="L267">            toRemove.add(itemWrapper);</span>
         }
<span class="nc" id="L269">      }</span>


      boolean filtered;
<span class="nc bnc" id="L273" title="All 2 branches missed.">      if(0 &lt; toRemove.size())</span>
      {
<span class="nc" id="L275">         tm.removeData(toRemove);</span>
<span class="nc" id="L276">         filtered = true;</span>
      }
      else
      {
<span class="nc" id="L280">         filtered = false;</span>
      }

      try
      {
<span class="nc" id="L285">         _dontReactToChkFiltered = true;</span>
<span class="nc" id="L286">         _dlg.chkFiltered.setSelected(filtered);</span>
      }
      finally
      {
<span class="nc" id="L290">         _dontReactToChkFiltered = false;</span>
      }
<span class="nc" id="L292">   }</span>

   private boolean matchesFilter(SQLHistoryItemWrapper itemWrapper)
   {
<span class="nc" id="L296">      String filter = _dlg.txtFilter.getText();</span>

<span class="nc bnc" id="L298" title="All 4 branches missed.">      if(null == filter || 0 == filter.length())</span>
      {
<span class="nc" id="L300">         return true;</span>
      }

      String ucfilter;

<span class="nc" id="L305">      SQLHistoryDlg.FilterCboItems sel = (SQLHistoryDlg.FilterCboItems) _dlg.cboFilterItems.getSelectedItem();</span>
<span class="nc bnc" id="L306" title="All 5 branches missed.">      switch (sel)</span>
      {
         case CONTAINS:
<span class="nc" id="L309">            ucfilter = filter.toUpperCase();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">            return -1 &lt; itemWrapper.getUpperCaseSQL().indexOf(ucfilter);</span>
         case STARTS_WITH:
<span class="nc" id="L312">            ucfilter = filter.toUpperCase();</span>
<span class="nc" id="L313">            return itemWrapper.getUpperCaseSQL().startsWith(ucfilter);</span>
         case ENDS_WITH:
<span class="nc" id="L315">            ucfilter = filter.toUpperCase();</span>
<span class="nc" id="L316">            return itemWrapper.getUpperCaseSQL().endsWith(ucfilter);</span>
         case REG_EX:
<span class="nc" id="L318">            return itemWrapper.getUpperCaseSQL().matches(filter);</span>
      }

<span class="nc" id="L321">      throw new IllegalArgumentException(&quot;How can I ever get here?????&quot;);</span>
   }

   private void onTblSelectionChanged(ListSelectionEvent e)
   {
<span class="nc bnc" id="L326" title="All 2 branches missed.">      if (e.getValueIsAdjusting())</span>
      {
<span class="nc" id="L328">         return;</span>
      }

<span class="nc" id="L331">      int[] selRows = _dlg.tblHistoryItems.getSelectedRows();</span>

<span class="nc bnc" id="L333" title="All 2 branches missed.">      if (1 == selRows.length)</span>
      {
<span class="nc" id="L335">         _dlg.txtSQL.setText(getSQLFromRow(selRows[0]));</span>

<span class="nc" id="L337">         SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L338">         {</span>
            public void run()
            {
<span class="nc" id="L341">               _dlg.txtSQL.scrollRectToVisible(new Rectangle(0,0,1,1));</span>
<span class="nc" id="L342">            }</span>
         });

      }
      else
      {
<span class="nc" id="L348">         _dlg.txtSQL.setText(null);</span>
      }
<span class="nc" id="L350">   }</span>

   private String getSQLFromRow(int row)
   {
<span class="nc" id="L354">      TableModel tm = _dlg.tblHistoryItems.getModel();</span>

<span class="nc" id="L356">      return</span>
<span class="nc" id="L357">         (String) tm.getValueAt(row, SQLHistoryItemWrapper.getSQLColIx());</span>

   }

   private void onWindowClosed()
   {
<span class="nc" id="L363">      TableColumnModel tcm = _dlg.tblHistoryItems.getColumnModel();</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">      for (int i = 0; i &lt; tcm.getColumnCount(); i++)</span>
      {
<span class="nc" id="L366">         TableColumn col = tcm.getColumn(i);</span>
<span class="nc" id="L367">         Preferences.userRoot().putInt(PREF_KEY_SQL_HISTORY_COL_NAME_PREFIX_ + col.getHeaderValue(), max(col.getWidth(), 10));</span>
      }
<span class="nc" id="L369">   }</span>

   @SuppressWarnings(&quot;serial&quot;)
   private static class SqlHistoryTableModel extends DefaultTableModel
   {
      private ArrayList&lt;SQLHistoryItemWrapper&gt; _tempSqlHistoryItemWrappers;
      private SortableTableModel _parent;

      public SqlHistoryTableModel(ArrayList&lt;SQLHistoryItemWrapper&gt; tempsqlHistoryItemWrappers, SortableTableModel parent)
<span class="nc" id="L378">      {</span>
<span class="nc" id="L379">         _tempSqlHistoryItemWrappers = tempsqlHistoryItemWrappers;</span>
<span class="nc" id="L380">         _parent = parent;</span>
<span class="nc" id="L381">      }</span>


      public boolean isCellEditable(int row, int column)
      {
<span class="nc" id="L386">         return false;</span>
      }

      public Object getValueAt(int row, int column)
      {
<span class="nc" id="L391">         return _tempSqlHistoryItemWrappers.get(row).getColum(column);</span>
      }


      public String getColumnName(int column)
      {
<span class="nc" id="L397">         return SQLHistoryItemWrapper.getColumns()[column];</span>
      }

      public int getRowCount()
      {
<span class="nc bnc" id="L402" title="All 2 branches missed.">         if (null == _tempSqlHistoryItemWrappers)</span>
         {
            // I have seen the reference to the outer class being null
            // when this method is called.
            // I have seen it only with the runtime jars
            // and on Linux.
            // I could not reproduce in my IDE.
<span class="nc" id="L409">            return 0;</span>
         }
         else
         {
<span class="nc" id="L413">            return _tempSqlHistoryItemWrappers.size();</span>
         }
      }

      public int getColumnCount()
      {
<span class="nc" id="L419">         return SQLHistoryItemWrapper.getColumns().length;</span>
      }

      ArrayList&lt;SQLHistoryItemWrapper&gt; getData()
      {
<span class="nc" id="L424">         return _tempSqlHistoryItemWrappers;</span>
      }

      public void setData(ArrayList&lt;SQLHistoryItemWrapper&gt; sqlHistoryItemWrappers)
      {
<span class="nc" id="L429">         _tempSqlHistoryItemWrappers = sqlHistoryItemWrappers;</span>
<span class="nc" id="L430">         _parent.tableChanged();</span>
<span class="nc" id="L431">      }</span>

      public void removeData(ArrayList&lt;SQLHistoryItemWrapper&gt; toRemove)
      {
<span class="nc" id="L435">         _tempSqlHistoryItemWrappers.removeAll(toRemove);</span>
<span class="nc" id="L436">         _parent.tableChanged();</span>
<span class="nc" id="L437">      }</span>
   }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>