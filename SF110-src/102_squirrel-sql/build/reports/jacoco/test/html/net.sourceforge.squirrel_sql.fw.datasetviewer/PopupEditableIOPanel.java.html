<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PopupEditableIOPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.fw.datasetviewer</a> &gt; <span class="el_source">PopupEditableIOPanel.java</span></div><h1>PopupEditableIOPanel.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.fw.datasetviewer;
/*
 * Copyright (C) 2001 Colin Bell
 * colbell@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
 import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;

import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JFileChooser;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.JTextField;

import net.sourceforge.squirrel_sql.fw.datasetviewer.cellcomponent.BinaryDisplayConverter;
import net.sourceforge.squirrel_sql.fw.datasetviewer.cellcomponent.CellComponentFactory;
import net.sourceforge.squirrel_sql.fw.datasetviewer.cellcomponent.RestorableJTextArea;
import net.sourceforge.squirrel_sql.fw.gui.TextPopupMenu;
import net.sourceforge.squirrel_sql.fw.gui.action.BaseAction;
import net.sourceforge.squirrel_sql.fw.util.IOUtilities;
import net.sourceforge.squirrel_sql.fw.util.IOUtilitiesImpl;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;

/**
 * @author gwg
 *
 * Class to handle IO between user and editable text, text and object,
 * and text/object to/from file.
 */
public class PopupEditableIOPanel extends JPanel implements ActionListener {

    private static final long serialVersionUID = 1L;

<span class="nc" id="L68">    private static final StringManager s_stringMgr =</span>
<span class="nc" id="L69">		StringManagerFactory.getStringManager(PopupEditableIOPanel.class);</span>

	// The text area displaying the object contents
	private final JTextArea _ta;

	// the scroll pane that holds the text area
	private final JScrollPane scrollPane;

	// Description needed to handle conversion of data to/from Object
	transient private final ColumnDisplayDefinition _colDef;

	transient private MouseAdapter _lis;

	private final TextPopupMenu _popupMenu;

	// name of file to do export/import/process on
	private JTextField fileNameField;

	// command to use when processing data with an external program
	private JComboBox externalCommandCombo;

	// save the original value for re-use by CLOB/BLOB types in conversion
	private Object originalValue;

	// Binary data viewing option: which radix to use
	// This object is only non-null when the data is binary data
<span class="nc" id="L95">	private JComboBox radixList = null;</span>
<span class="nc" id="L96">	private String previousRadixListItem = null;</span>
	// Binary data viewing option: view ascii as char rather than as numeric value
<span class="nc" id="L98">	private JCheckBox showAscii = null;</span>
	private boolean previousShowAscii;

<span class="nc" id="L101">	private IOUtilities _iou = new IOUtilitiesImpl();	</span>
	
<span class="nc" id="L103">	class BinaryOptionActionListener implements ActionListener {</span>
		public void actionPerformed(ActionEvent e) {

			// user asked to see binary data in a different format
<span class="nc" id="L107">			int base = 16;	// default to hex</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			if (previousRadixListItem.equals(&quot;Decimal&quot;)) base = 10;</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">			else if (previousRadixListItem.equals(&quot;Octal&quot;)) base = 8;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">			else if (previousRadixListItem.equals(&quot;Binary&quot;)) base = 2;</span>

<span class="nc" id="L112">			Byte[] bytes = BinaryDisplayConverter.convertToBytes(_ta.getText(),</span>
<span class="nc" id="L113">				base, previousShowAscii);</span>

			// return the expected format for this data
<span class="nc" id="L116">			base = 16;	// default to hex</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">			if (radixList.getSelectedItem().equals(&quot;Decimal&quot;)) base = 10;</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">			else if (radixList.getSelectedItem().equals(&quot;Octal&quot;)) base = 8;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">			else if (radixList.getSelectedItem().equals(&quot;Binary&quot;)) base = 2;</span>

<span class="nc" id="L121">			((RestorableJTextArea)_ta).updateText(</span>
<span class="nc" id="L122">				BinaryDisplayConverter.convertToString(bytes,</span>
<span class="nc" id="L123">				base, showAscii.isSelected()));</span>

<span class="nc" id="L125">			previousRadixListItem = (String)radixList.getSelectedItem();</span>
<span class="nc" id="L126">			previousShowAscii = showAscii.isSelected();</span>

<span class="nc" id="L128">			return;</span>
		}
	}
<span class="nc" id="L131">	transient private BinaryOptionActionListener optionActionListener =</span>
		new BinaryOptionActionListener();

	// text put in file name field to indicate that we should
	// create a temp file for export
<span class="nc" id="L136">	private final String TEMP_FILE_FLAG = &quot;&lt;temp file&gt;&quot;;</span>

	// Symbol used by user in Command field to indicate
	// &quot;Put the file name here&quot; when the command is executed.
<span class="nc" id="L140">	private final String FILE_REPLACE_FLAG = &quot;%f&quot;;</span>

	/**
	 * Constructor
	 */
	public PopupEditableIOPanel(ColumnDisplayDefinition colDef,
<span class="nc" id="L146">										 Object value, boolean isEditable) {</span>

<span class="nc" id="L148">		originalValue = value;	// save for possible future use</span>

<span class="nc" id="L150">		_popupMenu = new TextPopupMenu();</span>

<span class="nc" id="L152">		_colDef = colDef;</span>
<span class="nc" id="L153">		_ta = CellComponentFactory.getJTextArea(colDef, value);</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">		if (isEditable) {</span>
<span class="nc" id="L156">			_ta.setEditable(true);</span>
<span class="nc" id="L157">			_ta.setBackground(Color.yellow);	// tell user it is editable</span>
		}
		else {
<span class="nc" id="L160">			_ta.setEditable(false);</span>
		}


<span class="nc" id="L164">		_ta.setLineWrap(true);</span>
<span class="nc" id="L165">		_ta.setWrapStyleWord(true);</span>

<span class="nc" id="L167">		setLayout(new BorderLayout());</span>

		// add a panel containing binary data editing options, if needed
<span class="nc" id="L170">		JPanel displayPanel = new JPanel();</span>
<span class="nc" id="L171">		displayPanel.setLayout(new BorderLayout());</span>
<span class="nc" id="L172">		scrollPane = new JScrollPane(_ta);</span>
		/*
		 * TODO: When 1.4 is the earliest version supported, include
		 * the following line here:
		 * 	scrollPane.setWheelScrollingEnabled(true);
		 * The scroll-wheel function is important for ease of use, but the
		 * setWheelScrollingEnabled function is not available in java 1.3.
		 */

<span class="nc" id="L181">		displayPanel.add(scrollPane, BorderLayout.CENTER);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (CellComponentFactory.useBinaryEditingPanel(colDef)) {</span>
			// this is a binary field, so allow for multiple viewing options

<span class="nc" id="L185">			String[] radixListData = { &quot;Hex&quot;, &quot;Decimal&quot;, &quot;Octal&quot;, &quot;Binary&quot; };</span>
<span class="nc" id="L186">			radixList = new JComboBox(radixListData);</span>
<span class="nc" id="L187">			radixList.addActionListener(optionActionListener);</span>
<span class="nc" id="L188">			previousRadixListItem = &quot;Hex&quot;;</span>

<span class="nc" id="L190">			showAscii = new JCheckBox();</span>
<span class="nc" id="L191">			previousShowAscii = false;</span>
<span class="nc" id="L192">			showAscii.addActionListener(optionActionListener);</span>

<span class="nc" id="L194">			JPanel displayControlsPanel = new JPanel();</span>
			// use default sequential layout

			// i18n[popupeditableIoPanel.numberBase=Number Base:]
<span class="nc" id="L198">			displayControlsPanel.add(new JLabel(s_stringMgr.getString(&quot;popupeditableIoPanel.numberBase&quot;)));</span>
<span class="nc" id="L199">			displayControlsPanel.add(radixList);</span>
<span class="nc" id="L200">			displayControlsPanel.add(new JLabel(&quot;    &quot;));	// add some space</span>
<span class="nc" id="L201">			displayControlsPanel.add(showAscii);</span>
			// i18n[popupeditableIoPanel.showAscii=Show ASCII as chars]
<span class="nc" id="L203">			displayControlsPanel.add(new JLabel(s_stringMgr.getString(&quot;popupeditableIoPanel.showAscii&quot;)));</span>
<span class="nc" id="L204">			displayPanel.add(displayControlsPanel, BorderLayout.SOUTH);</span>
		}
<span class="nc" id="L206">		add(displayPanel, BorderLayout.CENTER);</span>

		// add controls for file handling, but only if DataType
		// can do File operations
<span class="nc bnc" id="L210" title="All 2 branches missed.">		if (CellComponentFactory.canDoFileIO(colDef)) {</span>
			// yes it can, so add controls
<span class="nc" id="L212">			add(exportImportPanel(isEditable), BorderLayout.SOUTH);</span>
		}

<span class="nc" id="L215">		_popupMenu.add(new LineWrapAction());</span>
<span class="nc" id="L216">		_popupMenu.add(new WordWrapAction());</span>
<span class="nc" id="L217">		_popupMenu.add(new XMLReformatAction());</span>
<span class="nc" id="L218">		_popupMenu.setTextComponent(_ta);</span>
<span class="nc" id="L219">	}</span>

	/**
	 * build the user interface for export/import operations
	 */
	private JPanel exportImportPanel(boolean isEditable) {
<span class="nc" id="L225">		JPanel eiPanel = new JPanel();</span>
<span class="nc" id="L226">		eiPanel.setLayout(new GridBagLayout());</span>

<span class="nc" id="L228">		final GridBagConstraints gbc = new GridBagConstraints();</span>

<span class="nc" id="L230">		gbc.insets = new Insets(4,4,4,4);</span>
<span class="nc" id="L231">		gbc.gridx = 0;</span>
<span class="nc" id="L232">		gbc.gridy = 0;</span>

		// File handling controls
		// i18n[popupeditableIoPanel.useFile=Use File: ]
<span class="nc" id="L236">		eiPanel.add(new JLabel(s_stringMgr.getString(&quot;popupeditableIoPanel.useFile&quot;)), gbc);</span>

		// ensure, that the text field can use the extra space if the user resize the dialog.
<span class="nc" id="L239">		gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L240">		gbc.weightx=0.5;</span>
<span class="nc" id="L241">		fileNameField = new JTextField(TEMP_FILE_FLAG, 17);</span>
<span class="nc" id="L242">		Dimension preferredSize = fileNameField.getPreferredSize();</span>
		// ensure, that the text field has a suitable size, even the panel is too small.
<span class="nc" id="L244">		fileNameField.setMinimumSize(new Dimension(preferredSize.width/2, preferredSize.height));</span>
<span class="nc" id="L245">		gbc.gridx++;</span>
		
<span class="nc" id="L247">		eiPanel.add(fileNameField, gbc);</span>
<span class="nc" id="L248">		gbc.fill = GridBagConstraints.NONE;;</span>
<span class="nc" id="L249">		gbc.weightx=0.0;</span>

		// add button for Brows
		// i18n[popupeditableIoPanel.browse=Browse]
<span class="nc" id="L253">		JButton browseButton = new JButton(s_stringMgr.getString(&quot;popupeditableIoPanel.browse&quot;));</span>
<span class="nc" id="L254">		browseButton.setActionCommand(&quot;browse&quot;);</span>
<span class="nc" id="L255">		browseButton.addActionListener(this);</span>


<span class="nc" id="L258">		gbc.gridx++;</span>
<span class="nc" id="L259">		eiPanel.add(browseButton, gbc);</span>


		// i18n[popupeditableIoPanel.export44=Export]
<span class="nc" id="L263">		JButton exportButton = new JButton(s_stringMgr.getString(&quot;popupeditableIoPanel.export44&quot;));</span>
<span class="nc" id="L264">		exportButton.setActionCommand(&quot;export&quot;);</span>
<span class="nc" id="L265">		exportButton.addActionListener(this);</span>

<span class="nc" id="L267">		gbc.gridx++;</span>
<span class="nc" id="L268">		eiPanel.add(exportButton, gbc);</span>

		// import and external processing can only be done if
		// panel is editable
<span class="nc bnc" id="L272" title="All 2 branches missed.">		if ( isEditable == false)</span>
<span class="nc" id="L273">			return eiPanel;</span>

		// Add import control
		// i18n[popupeditableIoPanel.import44=Import]
<span class="nc" id="L277">		JButton importButton = new JButton(s_stringMgr.getString(&quot;popupeditableIoPanel.import44&quot;));</span>
<span class="nc" id="L278">		importButton.setActionCommand(&quot;import&quot;);</span>
<span class="nc" id="L279">		importButton.addActionListener(this);</span>

<span class="nc" id="L281">		gbc.gridx++;</span>
<span class="nc" id="L282">		eiPanel.add(importButton, gbc);</span>

		// add external processing command field and button
<span class="nc" id="L285">		gbc.gridy++;</span>
<span class="nc" id="L286">		gbc.gridx = 0;</span>
		// i18n[popupeditableIoPanel.withCommand=With command:]
<span class="nc" id="L288">		eiPanel.add(new JLabel(s_stringMgr.getString(&quot;popupeditableIoPanel.withCommand&quot;)), gbc);</span>

		// add combo box for command to execute
<span class="nc" id="L291">		gbc.gridx++;</span>
<span class="nc" id="L292">		externalCommandCombo = new JComboBox(</span>
<span class="nc" id="L293">			CellImportExportInfoSaver.getInstance().getCmdList());</span>
<span class="nc" id="L294">		externalCommandCombo.setSelectedIndex(-1);	// no entry selected</span>
<span class="nc" id="L295">		externalCommandCombo.setEditable(true);</span>

		// make this the same size as the fileNameField
<span class="nc" id="L298">		externalCommandCombo.setPreferredSize(fileNameField.getPreferredSize());</span>
<span class="nc" id="L299">		externalCommandCombo.setMinimumSize(fileNameField.getMinimumSize());</span>
		
		// ensure, that the text field can use the extra space if the user resize the dialog.
<span class="nc" id="L302">		gbc.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L303">		gbc.weightx=0.5;</span>
<span class="nc" id="L304">		eiPanel.add(externalCommandCombo, gbc);</span>
<span class="nc" id="L305">		gbc.fill = GridBagConstraints.NONE;;</span>
<span class="nc" id="L306">		gbc.weightx=0.0;</span>
		
		
		// add button to execute external command
		// i18n[popupeditableIoPanel.execute34=Execute]
<span class="nc" id="L311">		JButton externalCommandButton = new JButton(s_stringMgr.getString(&quot;popupeditableIoPanel.execute34&quot;));</span>
<span class="nc" id="L312">		externalCommandButton.setActionCommand(&quot;execute&quot;);</span>
<span class="nc" id="L313">		externalCommandButton.addActionListener(this);</span>

<span class="nc" id="L315">		gbc.gridx++;</span>
<span class="nc" id="L316">		eiPanel.add(externalCommandButton, gbc);</span>

		// add button for applying file &amp; cmd info without doing anything else
		// i18n[popupeditableIoPanel.applyFile=Apply File &amp; Cmd]
<span class="nc" id="L320">		JButton applyButton = new JButton(s_stringMgr.getString(&quot;popupeditableIoPanel.applyFile&quot;));</span>
<span class="nc" id="L321">		applyButton.setActionCommand(&quot;apply&quot;);</span>
<span class="nc" id="L322">		applyButton.addActionListener(this);</span>

<span class="nc" id="L324">		gbc.gridx++;</span>
<span class="nc" id="L325">		gbc.gridwidth = 2;</span>
<span class="nc" id="L326">		eiPanel.add(applyButton, gbc);</span>
<span class="nc" id="L327">		gbc.gridwidth = 1;	// reset width to normal	</span>

		// add note to user about including file name in command
<span class="nc" id="L330">		gbc.gridy++;</span>
<span class="nc" id="L331">		gbc.gridx = 0;</span>
<span class="nc" id="L332">		gbc.gridwidth = GridBagConstraints.REMAINDER;</span>


		// i18n[popupeditableIoPanel.replaceFile=(In command, the string {0} is replaced by the file name when Executed.)]
<span class="nc" id="L336">		eiPanel.add(new JLabel(s_stringMgr.getString(&quot;popupeditableIoPanel.replaceFile&quot;, FILE_REPLACE_FLAG)), gbc);</span>

		// load filename and command with previously entered info
		// if not the default
		CellImportExportInfo info =
<span class="nc" id="L341">			CellImportExportInfoSaver.getInstance().get(_colDef.getFullTableColumnName());</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">		if (info != null) {</span>
			// load the info into the text fields
<span class="nc" id="L344">			fileNameField.setText(info.getFileName());</span>
<span class="nc" id="L345">			externalCommandCombo.getEditor().setItem(info.getCommand());</span>
		}

<span class="nc" id="L348">		return eiPanel;</span>
	}


	/**
	 * Return the contents of the editable text area as an Object
	 * converted by the correct DataType function.  Errors in converting
	 * from the text form into the Object are reported
	 * through the messageBuffer.
	 */
	public Object getObject(StringBuffer messageBuffer) {
<span class="nc" id="L359">		String text = null;</span>
		try {
<span class="nc" id="L361">			text = getTextAreaCannonicalForm();</span>
		}
<span class="nc" id="L363">		catch (Exception e) {</span>
<span class="nc" id="L364">			messageBuffer.append(</span>
<span class="nc" id="L365">				&quot;Failed to convert binary text; error was:\n&quot;+e.getMessage());</span>
<span class="nc" id="L366">			return null;</span>
<span class="nc" id="L367">		}</span>
<span class="nc" id="L368">		return CellComponentFactory.validateAndConvertInPopup(_colDef,</span>
					originalValue, text, messageBuffer);
	}

	/**
	 * When focus is passed to this panel, automatically pass it
	 * on to the text area.
	 */
	public void requestFocus() {
<span class="nc" id="L377">		_ta.requestFocus();</span>
<span class="nc" id="L378">	}</span>

	/**
	 * Handle actions on the buttons in the file operations panel
	 */
	public void actionPerformed(ActionEvent e) {

		//File object for doing IO
		File file;

<span class="nc bnc" id="L388" title="All 2 branches missed.">		if (e.getActionCommand().equals(&quot;browse&quot;)) {</span>
<span class="nc" id="L389">			JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L390">			String filename = fileNameField.getText();</span>
<span class="nc bnc" id="L391" title="All 4 branches missed.">            if (filename != null &amp;&amp; !&quot;&quot;.equals(filename)) {</span>
<span class="nc" id="L392">                File f = new File(filename);</span>
<span class="nc" id="L393">                String path = f.getAbsolutePath();</span>
<span class="nc bnc" id="L394" title="All 4 branches missed.">                if (path != null &amp;&amp; !&quot;&quot;.equals(path)) {</span>
<span class="nc" id="L395">                    chooser.setCurrentDirectory(new File(path));</span>
                }
            }
<span class="nc" id="L398">			int returnVal = chooser.showOpenDialog(this);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">			if(returnVal == JFileChooser.APPROVE_OPTION) {</span>
				//	System.out.println(&quot;You chose to open this file: &quot; +
				//		chooser.getSelectedFile().getName());
				try {
<span class="nc" id="L403">					fileNameField.setText(chooser.getSelectedFile().getCanonicalPath());</span>
				}
<span class="nc" id="L405">				catch (Exception ex) {</span>
					// should not happen since the file that was selected was
					// just being shown in the Chooser dialog, but just to be safe...
<span class="nc" id="L408">					JOptionPane.showMessageDialog(this,</span>
						// i18n[popupeditableIoPanel.errorGettingPath=Error getting full path name for selected file]
<span class="nc" id="L410">						s_stringMgr.getString(&quot;popupeditableIoPanel.errorGettingPath&quot;),</span>
						// i18n[popupeditableIoPanel.fileChooserError=File Chooser Error]
<span class="nc" id="L412">						s_stringMgr.getString(&quot;popupeditableIoPanel.fileChooserError&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L413">				}</span>
			}
<span class="nc" id="L415">		}</span>

<span class="nc bnc" id="L417" title="All 2 branches missed.">		else if (e.getActionCommand().equals(&quot;apply&quot;)) {</span>
			// If file name default and cmd is null or empty,
			// make sure this entry is not being held in CellImportExportInfoSaver
<span class="nc bnc" id="L420" title="All 2 branches missed.">			if ( (fileNameField.getText() != null &amp;&amp;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">					fileNameField.getText().equals(TEMP_FILE_FLAG)) &amp;&amp;</span>
<span class="nc bnc" id="L422" title="All 2 branches missed.">				(externalCommandCombo.getEditor().getItem() == null ||</span>
<span class="nc bnc" id="L423" title="All 2 branches missed.">					((String)externalCommandCombo.getEditor().getItem()).length() == 0)) {</span>
				// user has not entered anything or has reset to defaults,
				// so make sure there is no entry for this column in the
				// saved info
<span class="nc" id="L427">				CellImportExportInfoSaver.remove(_colDef.getFullTableColumnName());</span>
			}
			else {
				// user has entered some non-default info, so save it
<span class="nc" id="L431">				CellImportExportInfoSaver.getInstance().save(</span>
<span class="nc" id="L432">					_colDef.getFullTableColumnName(),fileNameField.getText(),</span>
<span class="nc" id="L433">					((String)externalCommandCombo.getEditor().getItem()));</span>
			}

		}

<span class="nc bnc" id="L438" title="All 2 branches missed.">		 else if (e.getActionCommand().equals(&quot;import&quot;)) {</span>

			 // IMPORT OBJECT FROM OSX_FILE

<span class="nc bnc" id="L442" title="All 2 branches missed.">			 if (fileNameField.getText() == null ||</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">				 fileNameField.getText().equals(TEMP_FILE_FLAG)) {</span>
				 // not allowed - must have existing file for import
<span class="nc" id="L445">				 JOptionPane.showMessageDialog(this,</span>
					 // i18n[popupeditableIoPanel.selectImportDataFile=You must select an existing file to import data from.]
<span class="nc" id="L447">						s_stringMgr.getString(&quot;popupeditableIoPanel.selectImportDataFile&quot;),</span>
					 // i18n[popupeditableIoPanel.noFile=No File Selected]
<span class="nc" id="L449">						s_stringMgr.getString(&quot;popupeditableIoPanel.noFile&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L450">				return;	// do not do import</span>
			 }

			 // get name of file, which must exist
<span class="nc bnc" id="L454" title="All 2 branches missed.">			if (fileNameField.getText() == null)</span>
<span class="nc" id="L455">				fileNameField.setText(&quot;&quot;);	// guard against something really stupid</span>
<span class="nc" id="L456">			file = new File(fileNameField.getText());</span>
<span class="nc bnc" id="L457" title="All 6 branches missed.">			if ( ! file.exists() || ! file.isFile() || ! file.canRead()) {</span>
				// not something we can read

				// i18n[popupeditableIoPanel.fileDoesNotExist=File {0} does not exist,\nor is not a readable, normal file.\nPlease enter a valid file name or use Browse to select a file.]
<span class="nc" id="L461">				String msg = s_stringMgr.getString(&quot;popupeditableIoPanel.fileDoesNotExist&quot;, fileNameField.getText());</span>

<span class="nc" id="L463">			   JOptionPane.showMessageDialog(this, msg,</span>

						// i18n[popupeditableIoPanel.fileError=File Name Error]
<span class="nc" id="L466">						s_stringMgr.getString(&quot;popupeditableIoPanel.fileError&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L467">				return;	// do not do import</span>
			}

			// Now that we have the file, do the import.
			//
			// Note: the sequence of operations is divided into two sections
			// at this point.  The preceeding code ensures that we have
			// a readable file, and the code in the following method call
			// does the import.  The reason for splitting at this point is
			// that the Execute operation needs to do an import, and it will
			// already have the file to do the import from (which is the same
			// as the file it exported into).
<span class="nc" id="L479">			importData(file);</span>

			// save the user options - we know that it is not the default
			// because we do not allow importing from &quot;temp file&quot;
<span class="nc" id="L483">			CellImportExportInfoSaver.getInstance().save(</span>
<span class="nc" id="L484">				_colDef.getFullTableColumnName(), fileNameField.getText(),</span>
<span class="nc" id="L485">				((String)externalCommandCombo.getEditor().getItem()));</span>

		 }

		else {

			// GET OSX_FILE FOR EXPORT &amp; EXTERNAL PROCESSING

<span class="nc" id="L493">			String canonicalFilePathName = fileNameField.getText();</span>

			// file name verification operations are the same for both
			// export and execute, so do that work here for both.
			//
			// If file name is null or empty, do not proceed
<span class="nc bnc" id="L499" title="All 2 branches missed.">			if (fileNameField.getText() == null ||</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">				fileNameField.getText().equals(&quot;&quot;)) {</span>

<span class="nc" id="L502">				JOptionPane.showMessageDialog(this,</span>

					// i18n[popupeditableIoPanel.noExportFile=No file name given for export.\nPlease enter a file name  or use Browse before clicking Export.]
<span class="nc" id="L505">					s_stringMgr.getString(&quot;popupeditableIoPanel.noExportFile&quot;),</span>
					// i18n[popupeditableIoPanel.exportError=Export Error]
<span class="nc" id="L507">					s_stringMgr.getString(&quot;popupeditableIoPanel.exportError&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L508">				return;</span>
			}

			// create the file to open
<span class="nc bnc" id="L512" title="All 2 branches missed.">			if (fileNameField.getText().equals(TEMP_FILE_FLAG)) {</span>
				// user wants us to create a temp file
				try {
<span class="nc" id="L515">					file = File.createTempFile(&quot;squirrel&quot;, &quot;.tmp&quot;);</span>

					// get the real name for use later
<span class="nc" id="L518">					canonicalFilePathName = file.getCanonicalPath();</span>
				}
<span class="nc" id="L520">				catch (Exception ex) {</span>
<span class="nc" id="L521">					JOptionPane.showMessageDialog(this,</span>
						// i18n[popupeditableIoPanel.cannotCreateTempFile=Cannot create temp file..\nError was:\n{0}]
<span class="nc" id="L523">						s_stringMgr.getString(&quot;popupeditableIoPanel.cannotCreateTempFile&quot;, ex.getMessage()),</span>
						// i18n[popupeditableIoPanel.exportError2=Export Error]
<span class="nc" id="L525">						s_stringMgr.getString(&quot;popupeditableIoPanel.exportError2&quot;),</span>
						JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L527">					return;</span>
<span class="nc" id="L528">				}</span>
			}
			else {
				//user must have supplied a file name.
<span class="nc" id="L532">				file = new File(fileNameField.getText());</span>

				try {
<span class="nc" id="L535">					canonicalFilePathName = file.getCanonicalPath();</span>
				}
<span class="nc" id="L537">				catch (Exception ex) {</span>
					// an error here may mean that the file cannot be
					// reached or has moved or some such.  In any case,
					// the file cannot be used for export.
<span class="nc" id="L541">					JOptionPane.showMessageDialog(this,</span>
						// i18n[popupeditableIoPanel.cannotAccessFile=Cannot access file name {0}\nAborting export.]
<span class="nc" id="L543">						s_stringMgr.getString(&quot;popupeditableIoPanel.cannotAccessFile&quot;, fileNameField.getText()),</span>

						// i18n[popupeditableIoPanel.exportError3=Export Error]
<span class="nc" id="L546">						s_stringMgr.getString(&quot;popupeditableIoPanel.exportError3&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L547">						return;</span>
<span class="nc" id="L548">				}</span>

				// see if file exists
<span class="nc bnc" id="L551" title="All 2 branches missed.">				if (file.exists()) {</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">					if ( ! file.isFile()) {</span>
<span class="nc" id="L553">						JOptionPane.showMessageDialog(this,</span>
							// i18n[popupeditableIoPanel.notANormalFile=File is not a normal file.\n Cannot do export to a directory or system file.]
<span class="nc" id="L555">							s_stringMgr.getString(&quot;popupeditableIoPanel.notANormalFile&quot;),</span>
							// i18n[popupeditableIoPanel.exportError4=Export Error]
<span class="nc" id="L557">							s_stringMgr.getString(&quot;popupeditableIoPanel.exportError4&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L558">						return;</span>
					}
<span class="nc bnc" id="L560" title="All 2 branches missed.">					if ( ! file.canWrite()) {</span>
<span class="nc" id="L561">						JOptionPane.showMessageDialog(this,</span>
							// i18n[popupeditableIoPanel.notWriteable=File is not writeable.\nChange file permissions or select a differnt file for export.]
<span class="nc" id="L563">							s_stringMgr.getString(&quot;popupeditableIoPanel.notWriteable&quot;),</span>
							// i18n[popupeditableIoPanel.exportError5=Export Error]
<span class="nc" id="L565">							s_stringMgr.getString(&quot;popupeditableIoPanel.exportError5&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L566">						return;</span>
					}
					// file exists, is normal and is writable, so see if user
					// wants to overwrite contents of file
<span class="nc" id="L570">					int option = JOptionPane.showConfirmDialog(this,</span>
						// i18n[popupeditableIoPanel.fileOverwrite=File {0} already exists.\n\nDo you wish to overwrite this file?]
<span class="nc" id="L572">						s_stringMgr.getString(&quot;popupeditableIoPanel.fileOverwrite&quot;, canonicalFilePathName),</span>
						// i18n[popupeditableIoPanel.overwriteWarning=File Overwrite Warning]
<span class="nc" id="L574">							s_stringMgr.getString(&quot;popupeditableIoPanel.overwriteWarning&quot;), JOptionPane.YES_NO_OPTION);</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">					if (option != JOptionPane.YES_OPTION) {</span>
						// user does not want to overwrite the file

						// we could tell user here that export was canceled,
						// but I don't think its necessary, and that avoids
						// forcing user to do yet another annoying mouse click.
<span class="nc" id="L581">						return;</span>
					}
					// user is ok with overwriting file
					// We do not need to do anything special to overwrite
					// (as opposed to appending) since the OutputString
					// starts at the beginning of the file by default.
<span class="nc" id="L587">				}</span>
				else {
					// file does not already exist, so try to create it
					try {
<span class="nc bnc" id="L591" title="All 2 branches missed.">						if ( ! file.createNewFile()) {</span>
<span class="nc" id="L592">							JOptionPane.showMessageDialog(this,</span>
								// i18n[popupeditableIoPanel.createFileError=Failed to create file {0}.\nChange file name or select a differnt file for export.]
<span class="nc" id="L594">								s_stringMgr.getString(&quot;popupeditableIoPanel.createFileError&quot;, canonicalFilePathName),</span>
								// i18n[popupeditableIoPanel.exportError6=Export Error]
<span class="nc" id="L596">								s_stringMgr.getString(&quot;popupeditableIoPanel.exportError6&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L597">							return;</span>
						}
					}
<span class="nc" id="L600">					catch (Exception ex) {</span>

<span class="nc" id="L602">						Object[] args = new Object[]{canonicalFilePathName, ex.getMessage()};</span>
<span class="nc" id="L603">						JOptionPane.showMessageDialog(this,</span>
							// i18n[popupeditableIoPanel.cannotOpenFile=Cannot open file {0}.\nError was:{1}]
<span class="nc" id="L605">							s_stringMgr.getString(&quot;popupeditableIoPanel.cannotOpenFile&quot;, args),</span>
							// i18n[popupeditableIoPanel.exportError7=Export Error]
<span class="nc" id="L607">							s_stringMgr.getString(&quot;popupeditableIoPanel.exportError7&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L608">						return;</span>
<span class="nc" id="L609">					}</span>
				}
			}

			// at this point we have an actual file that we can output to,
			// so create the output stream
			// (so that data type objects do not have to).

			// We have done everything we can prior to this point
			// to ensure that the the file is accessible, but it is
			// still possible that an existing file was removed
			// at a bad moment.  Also, the compiler insists that we
			// put this in a try statement
			FileOutputStream outStream;
			try {
<span class="nc" id="L624">				outStream = new FileOutputStream(file);</span>
			}
<span class="nc" id="L626">			catch (Exception ex) {</span>
<span class="nc" id="L627">				JOptionPane.showMessageDialog(this,</span>
					// i18n[popupeditableIoPanel.cannotFindFile=Cannot find file {0}\nCheck file name and re-try export.]
<span class="nc" id="L629">					s_stringMgr.getString(&quot;popupeditableIoPanel.cannotFindFile&quot;, canonicalFilePathName),</span>
					// i18n[popupeditableIoPanel.exportError8=Export Error]
<span class="nc" id="L631">					s_stringMgr.getString(&quot;popupeditableIoPanel.exportError8&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L632">				return;</span>
<span class="nc" id="L633">			}</span>

<span class="nc" id="L635">            String extCmdComboItemStr = null;</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">            if (externalCommandCombo != null</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                    &amp;&amp; externalCommandCombo.getEditor() != null) </span>
            {
<span class="nc" id="L639">                extCmdComboItemStr = </span>
<span class="nc" id="L640">                    (String)externalCommandCombo.getEditor().getItem();</span>
            }
            
			// if user did anything other than default, then save
			// their options
<span class="nc bnc" id="L645" title="All 4 branches missed.">			if ( ! TEMP_FILE_FLAG.equals(fileNameField.getText()) </span>
                    || (extCmdComboItemStr != null 
<span class="nc bnc" id="L647" title="All 2 branches missed.">                            &amp;&amp; extCmdComboItemStr.length() &gt; 0)) {</span>

				// This may be called either when the table is editable or when it is
				// read-only.  When it is read-only, there is no command to be saved,
				// but when it is editable, there may be a command.
<span class="nc" id="L652">				String commandString = extCmdComboItemStr;</span>

<span class="nc" id="L654">				CellImportExportInfoSaver.getInstance().save(</span>
<span class="nc" id="L655">					_colDef.getFullTableColumnName(), fileNameField.getText(),</span>
					commandString);
			}

<span class="nc bnc" id="L659" title="All 2 branches missed.">			if (e.getActionCommand().equals(&quot;export&quot;)) {</span>

				// EXPORT OBJECT TO OSX_FILE

<span class="nc bnc" id="L663" title="All 2 branches missed.">				if (exportData(outStream, canonicalFilePathName) == true) {</span>

					// if we get here, then everything worked correctly, so
					// tell user that data was put into file.
					// This is different from the Import strategy
					// because the user may not know the name of the file
					// that was used if they selected the automatic temp file
					// operation, or they may not know what directory the file
					// was actually put into, so this tells them the full file path.
<span class="nc" id="L672">					JOptionPane.showMessageDialog(this,</span>
						// i18n[popupeditableIoPanel.exportedToFile=Data Successfully exported to file {0}]
<span class="nc" id="L674">						s_stringMgr.getString(&quot;popupeditableIoPanel.exportedToFile&quot;, canonicalFilePathName),</span>
						// i18n[popupeditableIoPanel.exportSuccess=Export Success]
<span class="nc" id="L676">						s_stringMgr.getString(&quot;popupeditableIoPanel.exportSuccess&quot;),JOptionPane.INFORMATION_MESSAGE);</span>
				}
			}

<span class="nc bnc" id="L680" title="All 2 branches missed.">			else if (e.getActionCommand().equals(&quot;execute&quot;)) {</span>

				// EXPORT OBJECT TO OSX_FILE, EXECUTE PROGRAM ON IT, IMPORT IT BACK

<span class="nc bnc" id="L684" title="All 2 branches missed.">				if (((String)externalCommandCombo.getEditor().getItem()) == null ||</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">					((String)externalCommandCombo.getEditor().getItem()).length() == 0) {</span>
					// cannot execute a null command
<span class="nc" id="L687">					JOptionPane.showMessageDialog(this,</span>
						// i18n[popupeditableIoPanel.cannotExec=Cannot execute a null command.\nPlease enter a command in the Command field before clicking on Execute.]
<span class="nc" id="L689">						s_stringMgr.getString(&quot;popupeditableIoPanel.cannotExec&quot;),</span>
						// i18n[popupeditableIoPanel.executeError=Execute Error]
<span class="nc" id="L691">						s_stringMgr.getString(&quot;popupeditableIoPanel.executeError&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L692">					return;</span>
				}

				// replace any instance of flag in command with file name
<span class="nc" id="L696">				String command = ((String)externalCommandCombo.getEditor().getItem());</span>

				int index;
<span class="nc bnc" id="L699" title="All 2 branches missed.">				while ((index = command.indexOf(FILE_REPLACE_FLAG)) &gt;= 0) {</span>
<span class="nc" id="L700">					command = command.substring(0, index) +</span>
						canonicalFilePathName +
<span class="nc" id="L702">						command.substring(index + FILE_REPLACE_FLAG.length());</span>
				}

				// export data to file
<span class="nc bnc" id="L706" title="All 2 branches missed.">				if (exportData(outStream, canonicalFilePathName) == false) {</span>
					// bad export - do not proceed with command
					// The exportData() method has already put up a message
					// to the user saying the export failed.
<span class="nc" id="L710">					return;</span>
				}

				int commandResult;
<span class="nc" id="L714">				BufferedReader err = null;</span>
				try {
					// execute command
<span class="nc" id="L717">					Process cmdProcess = Runtime.getRuntime().exec(command);</span>

					// wait for command to complete
<span class="nc" id="L720">					commandResult = cmdProcess.waitFor();</span>

					// check the error stream for a problem
					//
					// This is a bit questionable since it is possible
					// for processes to output something on stderr
					// but continue processing.  But without this, some
					// problems are not seen (e.g. &quot;bad argument&quot; type
					// messages from the process).
<span class="nc" id="L729">					err = new BufferedReader(</span>
<span class="nc" id="L730">						new InputStreamReader(cmdProcess.getErrorStream()));</span>

<span class="nc" id="L732">					String errMsg = err.readLine();</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">					if (errMsg != null)</span>
<span class="nc" id="L734">						throw new IOException(</span>
							&quot;text on error stream from command starting with:\n&quot;+errMsg);
				}
<span class="nc" id="L737">				catch (Exception ex) {</span>

<span class="nc" id="L739">					Object[] args = new Object[]{command, ex.getMessage()};</span>
<span class="nc" id="L740">					JOptionPane.showMessageDialog(this,</span>
						// i18n[popupeditableIoPanel.errWhileExecutin=Error while executing command.\nThe command was:\n {0}\nThe error was:\n{1}]
<span class="nc" id="L742">						s_stringMgr.getString(&quot;popupeditableIoPanel.errWhileExecutin&quot;, args),</span>
						// i18n[popupeditableIoPanel.executeError2=Execute Error]
<span class="nc" id="L744">						s_stringMgr.getString(&quot;popupeditableIoPanel.executeError2&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L745">					return;</span>
				} finally {
<span class="nc" id="L747">				    _iou.closeReader(err);</span>
				}

				// check for possibly bad return from child
<span class="nc bnc" id="L751" title="All 2 branches missed.">				if (commandResult != 0) {</span>
					// command returned non-standard value.
					// ask user before proceeding.
<span class="nc" id="L754">					int option = JOptionPane.showConfirmDialog(this,</span>
							// i18n[popupeditableIoPanel.commandReturnNot0=The convention for command returns is that 0 means success, but this command returned {0}.\nDo you wish to import the file contents anyway?]
<span class="nc" id="L756">							s_stringMgr.getString(&quot;popupeditableIoPanel.commandReturnNot0&quot;, Integer.valueOf(commandResult)),</span>

							// i18n[popupeditableIoPanel.importWarning=Import Warning]
<span class="nc" id="L759">							s_stringMgr.getString(&quot;popupeditableIoPanel.importWarning&quot;), JOptionPane.YES_NO_OPTION);</span>
<span class="nc bnc" id="L760" title="All 2 branches missed.">					if (option != JOptionPane.YES_OPTION) {</span>
<span class="nc" id="L761">						return;</span>
					}
				}

				//import the data back from the same file
<span class="nc" id="L766">				importData(file);</span>

				// If the file was a temp file, delete it now.
				// We assume that Export-only operations want to leave the
				// file in place, but Execute operations just want a temp
				// space to work with and do not want it lying around afterwards.
<span class="nc" id="L772">				file.delete();</span>
			}
		} // end of combined export and execute operations
<span class="nc" id="L775">	}</span>

	/**
	 * Function to import data from a file.
	 * This is a separate function because it is called from two places.
	 * One is when the user asks to do an import, and the other is when they
	 * ask to run an external command, which involves importing from the file
	 * after the command is completed.
	 */
	private void importData(File file) {
		// create the imput stream
		// (so that DataType objects don't have to)
		FileInputStream inStream;
<span class="nc" id="L788">		String canonicalFilePathName = fileNameField.getText();</span>
		try {
<span class="nc" id="L790">			inStream = new FileInputStream(file);</span>

			// it is handy to have the cannonical path name
			// to show user in error messages.  Since getting
			// that name might involve an IOException, we need
			// to put it inside a try statement.  However,
			// since the file does exist there is no good reason
			// for getting an IOException at this point, but
			// if we get one there is something seriously wrong
			// and we want to abort.  Therefore it make sense
			// to get that name here and save it for later use.
<span class="nc" id="L801">			canonicalFilePathName = file.getCanonicalPath();</span>
		}
<span class="nc" id="L803">		catch (Exception ex) {</span>

<span class="nc" id="L805">			Object[] args = new Object[]{canonicalFilePathName, ex.getMessage()};</span>

<span class="nc" id="L807">			JOptionPane.showMessageDialog(this,</span>
				// i18n[popupeditableIoPanel.fileOpenError=There was an error opening file {0}.\nThe error was:\n{1}]
<span class="nc" id="L809">				s_stringMgr.getString(&quot;popupeditableIoPanel.fileOpenError&quot;, args),</span>
				// i18n[popupeditableIoPanel.fileOpenErrorHeader=File Open Error]
<span class="nc" id="L811">				s_stringMgr.getString(&quot;popupeditableIoPanel.fileOpenErrorHeader&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L812">			return;</span>
<span class="nc" id="L813">		}</span>

		// hand file input stream to DataType object for import
		// Also, handle File IO errors here so that DataType objects
		// do not have to.
		try {

			// The DataObject returns a string to put into the
			// popup which can later be converted to the appropriate
			// object type.
<span class="nc" id="L823">			String replacementText =</span>
<span class="nc" id="L824">				CellComponentFactory.importObject(_colDef, inStream);</span>

			// since the above did not throw an exception,
			// we now have a good new data object, so
			// change the text area to reflect that new object.
			//

			// If the user has selected a non-cannonical Binary format, we need
			// to convert the text appropriately
<span class="nc bnc" id="L833" title="All 2 branches missed.">			if (radixList != null &amp;&amp;</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">				! (radixList.getSelectedItem().equals(&quot;Hex&quot;) &amp;&amp;</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">					showAscii.isSelected() == false) ) {</span>
				// we need to convert to a different format
<span class="nc" id="L837">				int base = 16;	// default to hex</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">				if (radixList.getSelectedItem().equals(&quot;Decimal&quot;)) base = 10;</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">				else if (radixList.getSelectedItem().equals(&quot;Octal&quot;)) base = 8;</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">				else if (radixList.getSelectedItem().equals(&quot;Binary&quot;)) base = 2;</span>

<span class="nc" id="L842">				Byte[] bytes = BinaryDisplayConverter.convertToBytes(replacementText,</span>
					16, false);

				// return the expected format for this data
<span class="nc" id="L846">				replacementText = BinaryDisplayConverter.convertToString(bytes,</span>
<span class="nc" id="L847">					base, showAscii.isSelected());</span>
			}

<span class="nc" id="L850">			((RestorableJTextArea)_ta).updateText(replacementText);</span>
		}
<span class="nc" id="L852">		catch (Exception ex) {</span>

<span class="nc" id="L854">			Object[] args = new Object[]{canonicalFilePathName, ex.getMessage()};</span>
<span class="nc" id="L855">			JOptionPane.showMessageDialog(this,</span>
				// i18n[popupeditableIoPanel.errorReadingFile=There was an error while reading file {0}.\nThe error was:\n{1}]
<span class="nc" id="L857">				s_stringMgr.getString(&quot;popupeditableIoPanel.errorReadingFile&quot;, args),</span>
				// i18n[popupeditableIoPanel.importError2=Import Error]
<span class="nc" id="L859">				s_stringMgr.getString(&quot;popupeditableIoPanel.importError2&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L860">			return;</span>
<span class="nc" id="L861">		}</span>

		// cleanup resources used
		try {
<span class="nc" id="L865">			inStream.close();</span>
		}
<span class="nc" id="L867">		catch (Exception ex) {</span>
			// I cannot think of any reason for doing anything
			// at all here
<span class="nc" id="L870">		}</span>

		/*
				 * Issue: After importing the data, we could tell the user that
				 * it has been successfully imported.  This would give good
				 * positive feedback.  However, it would mean that they need
				 * to click on yet another button to dismiss that message.
				 * On the other hand, since the operation is synchronous,
				 * the user cannot proceed to do anything until it is done.
				 * If we assume that import usually works correctly unless
				 * they are shown an error message, then we do not need to
				 * display anything here.
				 */
<span class="nc" id="L883">	}</span>


	/**
	 * Function to export data to a file.
	 * This is a separate function because it is called from two places.
	 * One is when the user asks to export, and the other is when they
	 * as to run an external command, which involves exporting to file first.
	 */
	private boolean exportData(FileOutputStream outStream,
	                           String canonicalFilePathName){

		// hand file output stream to DataType object for export
		// Also, handle File IO errors here so that DataType objects
		// do not have to.
		try {

			// Hand the current text to the DataType object.
			// DataType object is responsible for validating
			// that the text makes sense for this type of object
			// and converting it to the proper form for output.
			// All errors are handled as IOExceptions
<span class="nc" id="L905">			CellComponentFactory.exportObject(_colDef, outStream,</span>
<span class="nc" id="L906">				getTextAreaCannonicalForm());</span>

		}
<span class="nc" id="L909">		catch (Exception ex) {</span>

<span class="nc" id="L911">			Object[] args = new Object[]{canonicalFilePathName, ex.getMessage()};</span>

<span class="nc" id="L913">			JOptionPane.showMessageDialog(this,</span>
				// i18n[popupeditableIoPanel.errorWritingFile=There was an error while writing file {0}.\nThe error was:\n{1}]
<span class="nc" id="L915">				s_stringMgr.getString(&quot;popupeditableIoPanel.errorWritingFile&quot;, args),</span>
				// i18n[popupeditableIoPanel.exportError100=Export Error]
<span class="nc" id="L917">				s_stringMgr.getString(&quot;popupeditableIoPanel.exportError100&quot;),JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L918">			return false;</span>
<span class="nc" id="L919">		}</span>

<span class="nc" id="L921">		return true;</span>
	}

	/**
	 * catch and handle mouse events to put up a menu
	 */
	public void addNotify()
	{
<span class="nc" id="L929">		super.addNotify();</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">		if (_lis == null)</span>
		{
<span class="nc" id="L932">			_lis = new MouseAdapter()</span>
<span class="nc" id="L933">			{</span>
				public void mousePressed(MouseEvent evt)
				{
<span class="nc bnc" id="L936" title="All 2 branches missed.">					if (evt.isPopupTrigger())</span>
					{
<span class="nc" id="L938">						_popupMenu.show(evt);</span>
					}
<span class="nc" id="L940">				}</span>
				public void mouseReleased(MouseEvent evt)
				{
<span class="nc bnc" id="L943" title="All 2 branches missed.">						if (evt.isPopupTrigger())</span>
					{
<span class="nc" id="L945">						_popupMenu.show(evt);</span>
					}
<span class="nc" id="L947">				}</span>
			};
<span class="nc" id="L949">			_ta.addMouseListener(_lis);</span>
		}
<span class="nc" id="L951">	}</span>

	public void removeNotify()
	{
<span class="nc" id="L955">		super.removeNotify();</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">		if (_lis != null)</span>
		{
<span class="nc" id="L958">			_ta.removeMouseListener(_lis);</span>
<span class="nc" id="L959">			_lis = null;</span>
		}
<span class="nc" id="L961">	}</span>

	@SuppressWarnings(&quot;serial&quot;)
	private class LineWrapAction extends BaseAction
	{
		LineWrapAction()
<span class="nc" id="L967">		{</span>
			// i18n[popupEditableIoPanel.wrapLines=Wrap Lines on/off]
<span class="nc" id="L969">			super(s_stringMgr.getString(&quot;popupEditableIoPanel.wrapLines&quot;));</span>
<span class="nc" id="L970">		}</span>

		public void actionPerformed(ActionEvent evt)
		{
<span class="nc bnc" id="L974" title="All 2 branches missed.">			if (_ta != null)</span>
			{
<span class="nc bnc" id="L976" title="All 2 branches missed.">				_ta.setLineWrap(!_ta.getLineWrap());</span>
			}
<span class="nc" id="L978">		}</span>
	}

	private class WordWrapAction extends BaseAction
	{
        private static final long serialVersionUID = 1L;

        WordWrapAction()
<span class="nc" id="L986">		{</span>
			// i18n[popupEditableIoPanel.wrapWord=Wrap on Word on/off]
<span class="nc" id="L988">			super(s_stringMgr.getString(&quot;popupEditableIoPanel.wrapWord&quot;));</span>
<span class="nc" id="L989">		}</span>

		public void actionPerformed(ActionEvent evt)
		{
<span class="nc bnc" id="L993" title="All 2 branches missed.">			if (_ta != null)</span>
			{
<span class="nc bnc" id="L995" title="All 2 branches missed.">				_ta.setWrapStyleWord(!_ta.getWrapStyleWord());</span>
			}
<span class="nc" id="L997">		}</span>
	}

	private class XMLReformatAction extends BaseAction
	{
        private static final long serialVersionUID = 1L;

        XMLReformatAction()
<span class="nc" id="L1005">		{</span>
			// i18n[popupEditableIoPanel.reformatXml=Reformat XML]
<span class="nc" id="L1007">			super(s_stringMgr.getString(&quot;popupEditableIoPanel.reformatXml&quot;));</span>
<span class="nc" id="L1008">		}</span>

		public void actionPerformed(ActionEvent evt)
		{
<span class="nc bnc" id="L1012" title="All 2 branches missed.">			if (_ta != null)</span>
			{
<span class="nc" id="L1014">				_ta.setText(XmlRefomatter.reformatXml(_ta.getText()));</span>
			}
<span class="nc" id="L1016">		}</span>
	}

	/**
	 * Helper function that ensures that the data is acceptable to the DataType
	 * object. The issue addressed here is that Binary data can be represented
	 * in multiple formats (Hex, Octal, etc), and to keep the DataTypes simple
	 * we assume that they get only Hex data with ASCII chars shown as their
	 * numeric value. This makes sense from the point of view that the different
	 * formats are temporary views handled by this class rather than permanent
	 * settings applied to either the column or the DataType. Therefore, when we
	 * pass the data from the TextArea into the DataType, we may need to do a
	 * conversion on the way.
	 */
	private String getTextAreaCannonicalForm() {
		// handle null
<span class="nc bnc" id="L1032" title="All 2 branches missed.">		if (_ta.getText() == null ||</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">			_ta.getText().equals(&quot;&lt;null&gt;&quot;) ||</span>
<span class="nc bnc" id="L1034" title="All 2 branches missed.">			_ta.getText().length() == 0)</span>
<span class="nc" id="L1035">			return _ta.getText();</span>

		// if the data is not binary, then there is no need for conversion.
		// if the data is Hex with ASCII not shown as chars, then no conversion needed.
<span class="nc bnc" id="L1039" title="All 2 branches missed.">		if (radixList == null ||</span>
<span class="nc bnc" id="L1040" title="All 4 branches missed.">			(radixList.getSelectedItem().equals(&quot;Hex&quot;) &amp;&amp; ! showAscii.isSelected()) ) {</span>
			// no need for conversion
<span class="nc" id="L1042">			return _ta.getText();</span>
		}

		// The field is binary and not in the format expected by the DataType
<span class="nc" id="L1046">		int base = 16;	// default to hex</span>
<span class="nc bnc" id="L1047" title="All 2 branches missed.">		if (radixList.getSelectedItem().equals(&quot;Decimal&quot;)) base = 10;</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">		else if (radixList.getSelectedItem().equals(&quot;Octal&quot;)) base = 8;</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">		else if (radixList.getSelectedItem().equals(&quot;Binary&quot;)) base = 2;</span>

		// the following can cause and exception if the text is not formatted correctly
<span class="nc" id="L1052">		Byte[] bytes = BinaryDisplayConverter.convertToBytes(_ta.getText(),</span>
<span class="nc" id="L1053">			base, showAscii.isSelected());</span>

		// return the expected format for this data
<span class="nc" id="L1056">		return BinaryDisplayConverter.convertToString(bytes, 16, false);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>