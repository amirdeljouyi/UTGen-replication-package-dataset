<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CodeReformator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.util.codereformat</a> &gt; <span class="el_source">CodeReformator.java</span></div><h1>CodeReformator.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.util.codereformat;

/*
 * Copyright (C) 2003 Gerd Wagner
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Iterator;
import java.util.List;

import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.StringUtilities;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

public class CodeReformator implements ICodeReformator
{
<span class="nc" id="L34">   private static final StringManager s_stringMgr = StringManagerFactory</span>
<span class="nc" id="L35">         .getStringManager(CodeReformator.class);</span>


   /**
    * Platform-specific line separator string
    */
<span class="nc" id="L41">   private String _lineSep = StringUtilities.getEolStr();</span>

<span class="nc" id="L43">   private static ILogger s_log = LoggerController.createLogger(CodeReformator.class);</span>
   private CodeReformatorConfig _codeReformatorConfig;

   public CodeReformator(CodeReformatorConfig codeReformatorConfig)
<span class="nc" id="L47">   {</span>
<span class="nc" id="L48">      _codeReformatorConfig = codeReformatorConfig;</span>
<span class="nc" id="L49">   }</span>

   /**
    * @see ICodeReformator#reformat(java.lang.String)
    */
   public String reformat(String in)
   {
<span class="nc" id="L56">      in = flatenWhiteSpaces(in, false);</span>

<span class="nc" id="L58">      PieceMarkerSpec[] markerExcludeComma = createPieceMarkerSpecExcludeColon();</span>
<span class="nc" id="L59">      String[] pieces =</span>
<span class="nc" id="L60">            getReformatedPieces(in, markerExcludeComma).toArray(new String[0]);</span>

<span class="nc bnc" id="L62" title="All 2 branches missed.">      if (_codeReformatorConfig.isDoInsertValuesAlign())</span>
      {
<span class="nc" id="L64">         pieces = doInsertSpecial(pieces);</span>
      }

<span class="nc" id="L67">      StringBuffer ret = new StringBuffer();</span>
<span class="nc" id="L68">      int braketCount = 0;</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">      for (int i = 0; i &lt; pieces.length; ++i)</span>
      {
<span class="nc bnc" id="L71" title="All 2 branches missed.">         if (&quot;)&quot;.equals(pieces[i]))</span>
         {
<span class="nc" id="L73">            --braketCount;</span>
         }
<span class="nc" id="L75">         ret.append(indent(pieces[i], braketCount));</span>
<span class="nc" id="L76">         ret.append(_lineSep);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">         if (&quot;(&quot;.equals(pieces[i]))</span>
         {
<span class="nc" id="L79">            ++braketCount;</span>
         }
      }

<span class="nc" id="L83">      validate(in, ret.toString());</span>

<span class="nc" id="L85">      return ret.toString();</span>
   }

   private void validate(String beforeReformat, String afterReformat)
   {
<span class="nc" id="L90">      String normalizedBefore = getNormalized(beforeReformat);</span>
<span class="nc" id="L91">      String normalizedAfter = getNormalized(afterReformat);</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">      if (!normalizedBefore.equalsIgnoreCase(normalizedAfter))</span>
      {
<span class="nc" id="L95">         int minLen = Math.min(normalizedAfter.length(), normalizedBefore</span>
<span class="nc" id="L96">               .length());</span>
<span class="nc" id="L97">         StringBuffer diffPos = new StringBuffer();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">         for (int i = 0; i &lt; minLen; ++i)</span>
         {
<span class="nc" id="L100">            if (Character.toUpperCase(normalizedBefore.charAt(i)) != Character</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                  .toUpperCase(normalizedAfter.charAt(i)))</span>
            {
<span class="nc" id="L103">               break;</span>
            }
<span class="nc" id="L105">            diffPos.append('-');</span>
         }
<span class="nc" id="L107">         diffPos.append('^');</span>

         // i18n[editextras.reformatFailed=Reformat failed, normalized
         // Strings differ]
<span class="nc" id="L111">         StringBuilder msg = new StringBuilder(s_stringMgr.getString(&quot;codereformat.reformatFailed&quot;));</span>
<span class="nc" id="L112">         msg.append(_lineSep);</span>
<span class="nc" id="L113">         msg.append(normalizedBefore);</span>
<span class="nc" id="L114">         msg.append(_lineSep);</span>
<span class="nc" id="L115">         msg.append(normalizedAfter);</span>
<span class="nc" id="L116">         msg.append(_lineSep);</span>
<span class="nc" id="L117">         msg.append(diffPos.toString());</span>
<span class="nc" id="L118">         msg.append(_lineSep);</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">         if (s_log.isInfoEnabled())</span>
         {
<span class="nc" id="L122">            s_log.info(msg.toString());</span>
         }

<span class="nc" id="L125">         throw new IllegalStateException(msg.toString());</span>
      }
<span class="nc" id="L127">   }</span>

   /**
    * Returns a normalized version of a SQL string. Normalized strings before
    * and after reformatting should be the same. So normalized Strings may be
    * used for validation of the reformating process.
    */
   private String getNormalized(String s)
   {
<span class="nc" id="L136">      String ret = s.replaceAll(&quot;\\(&quot;, &quot; ( &quot;);</span>
<span class="nc" id="L137">      ret = ret.replaceAll(&quot;\\)&quot;, &quot; ) &quot;);</span>
<span class="nc" id="L138">      ret = ret.replaceAll(&quot;,&quot;, &quot; , &quot;);</span>
<span class="nc" id="L139">      String sep = _codeReformatorConfig.getStatementSeparator();</span>

      // If our separator is the regular expression special char '|', then
      // quote it before formatting.
<span class="nc bnc" id="L143" title="All 2 branches missed.">      if (sep.equals(&quot;|&quot;))</span>
      {
<span class="nc" id="L145">         sep = &quot;\\|&quot;;</span>
      }
<span class="nc" id="L147">      ret = ret.replaceAll(sep, concat(&quot; &quot;, sep, &quot; &quot;));</span>
<span class="nc" id="L148">      return flatenWhiteSpaces(ret, true).trim();</span>
   }

   /**
    * Concatenates the specified strings and returns the result.
    *
    * @param strings the strings in array form to concatenate.
    * @return the concatenated result.
    */
   private String concat(String... strings)
   {
<span class="nc" id="L159">      StringBuilder result = new StringBuilder();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">      for (String string : strings)</span>
      {
<span class="nc" id="L162">         result.append(string);</span>
      }
<span class="nc" id="L164">      return result.toString();</span>
   }

   private List&lt;String&gt; getReformatedPieces(String in, PieceMarkerSpec[] markers)
   {
<span class="nc" id="L169">      CodeReformatorKernel kernel = new CodeReformatorKernel(</span>
<span class="nc" id="L170">            _codeReformatorConfig.getStatementSeparator(), markers, _codeReformatorConfig.getCommentSpecs());</span>
<span class="nc" id="L171">      String[] pieces = kernel.toPieces(in);</span>
<span class="nc" id="L172">      ArrayList&lt;String&gt; piecesBuf = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L174" title="All 2 branches missed.">      for (int i = 0; i &lt; pieces.length; ++i)</span>
      {
<span class="nc bnc" id="L176" title="All 2 branches missed.">         if (_codeReformatorConfig.getTrySplitLineLen() &lt; pieces[i].length())</span>
         {
<span class="nc" id="L178">            String[] splitPieces = trySplit(pieces[i], 0,</span>
<span class="nc" id="L179">                  _codeReformatorConfig.getTrySplitLineLen());</span>
<span class="nc" id="L180">            piecesBuf.addAll(Arrays.asList(splitPieces));</span>
<span class="nc" id="L181">         }</span>
         else
         {
<span class="nc" id="L184">            piecesBuf.add(pieces[i]);</span>
         }
      }
<span class="nc" id="L187">      return piecesBuf;</span>
   }

   private String[] doInsertSpecial(String[] pieces)
   {
<span class="nc" id="L192">      int insertBegin = -1;</span>
<span class="nc" id="L193">      boolean hasValues = false;</span>

<span class="nc" id="L195">      ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L196">      ArrayList&lt;String&gt; insertPieces = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L198" title="All 2 branches missed.">      for (int i = 0; i &lt; pieces.length; ++i)</span>
      {
<span class="nc bnc" id="L200" title="All 4 branches missed.">         if (&quot;INSERT &quot;.length() &lt;= pieces[i].length() &amp;&amp; pieces[i].substring(0, &quot;INSERT &quot;.length()).equalsIgnoreCase(&quot;INSERT &quot;))</span>
         {
<span class="nc bnc" id="L202" title="All 2 branches missed.">            if (-1 != insertBegin)</span>
            {
               // Inserts are not properly separated. We give up.
<span class="nc" id="L205">               return pieces;</span>
            }
<span class="nc" id="L207">            insertBegin = i;</span>
         }

<span class="nc bnc" id="L210" title="All 2 branches missed.">         if (-1 == insertBegin)</span>
         {
<span class="nc" id="L212">            ret.add(pieces[i]);</span>
         }
         else
         {
<span class="nc" id="L216">            insertPieces.add(pieces[i]);</span>
         }

<span class="nc bnc" id="L219" title="All 2 branches missed.">         if (-1 &lt; insertBegin</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">               &amp;&amp; -1 != pieces[i].toUpperCase().indexOf(&quot;VALUES&quot;))</span>
         {
<span class="nc" id="L222">            hasValues = true;</span>
         }

<span class="nc bnc" id="L225" title="All 2 branches missed.">         if (-1 &lt; insertBegin</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">               &amp;&amp; _codeReformatorConfig.getStatementSeparator().equalsIgnoreCase(pieces[i]))</span>
         {
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if (hasValues)</span>
            {
<span class="nc" id="L230">               ret.addAll(reformatInsert(insertPieces));</span>
            }
            else
            {
               // No special treatment
<span class="nc" id="L235">               ret.addAll(insertPieces);</span>
            }

<span class="nc" id="L238">            insertBegin = -1;</span>
<span class="nc" id="L239">            hasValues = false;</span>
<span class="nc" id="L240">            insertPieces = new ArrayList&lt;String&gt;();</span>
         }
      }

<span class="nc bnc" id="L244" title="All 2 branches missed.">      if (-1 &lt; insertBegin)</span>
      {
<span class="nc bnc" id="L246" title="All 2 branches missed.">         if (hasValues)</span>
         {
<span class="nc" id="L248">            ret.addAll(reformatInsert(insertPieces));</span>
         }
         else
         {
            // No special treatment
<span class="nc" id="L253">            ret.addAll(insertPieces);</span>
         }
      }

<span class="nc" id="L257">      return ret.toArray(new String[0]);</span>
   }

   private ArrayList&lt;String&gt; reformatInsert(ArrayList&lt;String&gt; piecesIn)
   {
<span class="nc" id="L262">      String[] pieces =</span>
<span class="nc" id="L263">            splitAsFarAsPossible(piecesIn.toArray(new String[piecesIn.size()]));</span>

<span class="nc" id="L265">      ArrayList&lt;String&gt; insertList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L266">      ArrayList&lt;String&gt; valuesList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L267">      ArrayList&lt;String&gt; behindInsert = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L269">      StringBuffer statementBegin = new StringBuffer();</span>
<span class="nc" id="L270">      int braketCountAbsolute = 0;</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">      for (int i = 0; i &lt; pieces.length; ++i)</span>
      {
<span class="nc bnc" id="L273" title="All 2 branches missed.">         if (3 &lt; braketCountAbsolute)</span>
         {
<span class="nc" id="L275">            behindInsert.add(pieces[i]);</span>
         }
<span class="nc bnc" id="L277" title="All 4 branches missed.">         if (&quot;(&quot;.equals(pieces[i]) || &quot;)&quot;.equals(pieces[i]))</span>
         {
<span class="nc" id="L279">            ++braketCountAbsolute;</span>
         }

<span class="nc bnc" id="L282" title="All 2 branches missed.">         if (0 == braketCountAbsolute)</span>
         {
<span class="nc" id="L284">            statementBegin.append(pieces[i]).append(' ');</span>
         }
<span class="nc bnc" id="L286" title="All 4 branches missed.">         if (1 == braketCountAbsolute &amp;&amp; !&quot;(&quot;.equals(pieces[i])</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">               &amp;&amp; !&quot;)&quot;.equals(pieces[i]))</span>
         {
<span class="nc" id="L289">            String buf = pieces[i].trim();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">            if (buf.endsWith(&quot;,&quot;))</span>
            {
<span class="nc" id="L292">               buf = buf.substring(0, buf.length() - 1);</span>
            }
<span class="nc" id="L294">            insertList.add(buf);</span>
         }
<span class="nc bnc" id="L296" title="All 4 branches missed.">         if (3 == braketCountAbsolute &amp;&amp; !&quot;(&quot;.equals(pieces[i])</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">               &amp;&amp; !&quot;)&quot;.equals(pieces[i]))</span>
         {
<span class="nc" id="L299">            String buf = pieces[i].trim();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">            if (buf.endsWith(&quot;,&quot;))</span>
            {
<span class="nc" id="L302">               buf = buf.substring(0, buf.length() - 1);</span>
            }
<span class="nc" id="L304">            valuesList.add(buf);</span>
         }
      }

<span class="nc" id="L308">      ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L310" title="All 2 branches missed.">      if (0 == insertList.size())</span>
      {
         // Not successful
<span class="nc" id="L313">         ret.addAll(piecesIn);</span>
<span class="nc" id="L314">         return ret;</span>
      }

<span class="nc bnc" id="L317" title="All 2 branches missed.">      if (insertList.size() == valuesList.size())</span>
      {
<span class="nc" id="L319">         ret.add(statementBegin.toString());</span>
<span class="nc" id="L320">         StringBuffer insert = new StringBuffer();</span>
<span class="nc" id="L321">         StringBuffer values = new StringBuffer();</span>

<span class="nc" id="L323">         String insBuf = insertList.get(0);</span>
<span class="nc" id="L324">         String valsBuf = valuesList.get(0);</span>

<span class="nc" id="L326">         insert.append('(').append(adjustLength(insBuf, valsBuf));</span>
<span class="nc" id="L327">         values.append('(').append(adjustLength(valsBuf, insBuf));</span>

<span class="nc bnc" id="L329" title="All 2 branches missed.">         for (int i = 1; i &lt; insertList.size(); ++i)</span>
         {
<span class="nc" id="L331">            insBuf = insertList.get(i);</span>
<span class="nc" id="L332">            valsBuf = valuesList.get(i);</span>

<span class="nc" id="L334">            insert.append(',').append(adjustLength(insBuf, valsBuf));</span>
<span class="nc" id="L335">            values.append(',').append(adjustLength(valsBuf, insBuf));</span>
         }
<span class="nc" id="L337">         insert.append(&quot;) VALUES&quot;);</span>
<span class="nc" id="L338">         values.append(')');</span>
<span class="nc" id="L339">         ret.add(insert.toString());</span>
<span class="nc" id="L340">         ret.add(values.toString());</span>
<span class="nc" id="L341">         ret.addAll(behindInsert);</span>
<span class="nc" id="L342">         return ret;</span>
      }
      else
      {
         // Not successful
<span class="nc" id="L347">         ret.addAll(piecesIn);</span>
<span class="nc" id="L348">         return ret;</span>
      }
   }

   private String[] splitAsFarAsPossible(String[] pieces)
   {
<span class="nc" id="L354">      ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">      for (int i = 0; i &lt; pieces.length; i++)</span>
      {
<span class="nc" id="L357">         ret.addAll(Arrays.asList(trySplit(pieces[i], 0, 1)));</span>
      }
<span class="nc" id="L359">      return ret.toArray(new String[ret.size()]);</span>
   }

   private String adjustLength(String s1, String s2)
   {
<span class="nc" id="L364">      int max = Math.max(s1.length(), s2.length());</span>

<span class="nc bnc" id="L366" title="All 2 branches missed.">      if (s1.length() == max)</span>
      {
<span class="nc" id="L368">         return s1;</span>
      }
      else
      {
<span class="nc" id="L372">         StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L373">         sb.append(s1);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">         while (sb.length() &lt; max)</span>
         {
<span class="nc" id="L376">            sb.append(' ');</span>
         }
<span class="nc" id="L378">         return sb.toString();</span>
      }
   }

   private String[] trySplit(String piece, int braketDepth, int trySplitLineLen)
   {
<span class="nc" id="L384">      String trimmedPiece = piece.trim();</span>
<span class="nc" id="L385">      CodeReformatorKernel dum = new CodeReformatorKernel(</span>
<span class="nc" id="L386">            _codeReformatorConfig.getStatementSeparator(), new PieceMarkerSpec[0], _codeReformatorConfig.getCommentSpecs());</span>

<span class="nc bnc" id="L388" title="All 2 branches missed.">      if (hasTopLevelColon(trimmedPiece, dum))</span>
      {
<span class="nc" id="L390">         PieceMarkerSpec[] pms = createPieceMarkerSpecIncludeColon();</span>
<span class="nc" id="L391">         CodeReformatorKernel crk = new CodeReformatorKernel(</span>
<span class="nc" id="L392">               _codeReformatorConfig.getStatementSeparator(), pms, _codeReformatorConfig.getCommentSpecs());</span>
<span class="nc" id="L393">         String[] splitPieces1 = crk.toPieces(trimmedPiece);</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">         if (1 == splitPieces1.length)</span>
         {
<span class="nc" id="L396">            return splitPieces1;</span>
         }

<span class="nc" id="L399">         ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">         for (int i = 0; i &lt; splitPieces1.length; ++i)</span>
         {
<span class="nc" id="L403">            if (trySplitLineLen &lt; splitPieces1[i].length() + braketDepth</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">                  * _codeReformatorConfig.getIndent().length())</span>
            {
<span class="nc" id="L406">               String[] splitPieces2 = trySplit(splitPieces1[i],</span>
                     braketDepth, trySplitLineLen);
<span class="nc bnc" id="L408" title="All 2 branches missed.">               for (int j = 0; j &lt; splitPieces2.length; ++j)</span>
               {
<span class="nc" id="L410">                  ret.add(splitPieces2[j].trim());</span>
               }
<span class="nc" id="L412">            }</span>
            else
            {
<span class="nc" id="L415">               ret.add(splitPieces1[i].trim());</span>
            }
         }
<span class="nc" id="L418">         return (purgeEmptyStrings(ret)).toArray(new String[0]);</span>
      }
      else
      {
<span class="nc" id="L422">         int[] tlbi = getTopLevelBraketIndexes(trimmedPiece, dum);</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">         if (-1 != tlbi[0] &amp;&amp; tlbi[0] &lt; tlbi[1])</span>
         {
            // ////////////////////////////////////////////////////////////////////////
            // Split the first two matching toplevel brakets here
<span class="nc" id="L427">            PieceMarkerSpec[] pms = createPieceMarkerSpecExcludeColon();</span>
<span class="nc" id="L428">            CodeReformatorKernel crk = new CodeReformatorKernel(</span>
<span class="nc" id="L429">                  _codeReformatorConfig.getStatementSeparator(), pms, _codeReformatorConfig.getCommentSpecs());</span>
<span class="nc" id="L430">            String[] splitPieces1 = crk.toPieces(trimmedPiece.substring(</span>
                  tlbi[0] + 1, tlbi[1]));

<span class="nc" id="L433">            ArrayList&lt;String&gt; buf = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L434">            buf.add(trimmedPiece.substring(0, tlbi[0]).trim());</span>
<span class="nc" id="L435">            buf.add(&quot;(&quot;);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">            for (int i = 0; i &lt; splitPieces1.length; ++i)</span>
            {
<span class="nc" id="L438">               buf.add(splitPieces1[i]);</span>
            }
<span class="nc" id="L440">            buf.add(&quot;)&quot;);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">            if (tlbi[1] + 1 &lt; trimmedPiece.length())</span>
            {
<span class="nc" id="L443">               buf.add(trimmedPiece.substring(tlbi[1] + 1,</span>
<span class="nc" id="L444">                     trimmedPiece.length()).trim());</span>
            }
<span class="nc" id="L446">            splitPieces1 = buf.toArray(new String[0]);</span>
            //
            // ////////////////////////////////////////////////////////////////////

            // ///////////////////////////////////////////////////////////////////
            // Now check length of Strings in splitPieces1 again
<span class="nc" id="L452">            ArrayList&lt;String&gt; ret = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">            for (int i = 0; i &lt; splitPieces1.length; ++i)</span>
            {
<span class="nc" id="L455">               if (trySplitLineLen &lt; splitPieces1[i].length()</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                     + braketDepth * _codeReformatorConfig.getIndent().length())</span>
               {
<span class="nc" id="L458">                  String[] splitPieces2 = trySplit(splitPieces1[i],</span>
                        braketDepth + 1, trySplitLineLen);
<span class="nc bnc" id="L460" title="All 2 branches missed.">                  for (int j = 0; j &lt; splitPieces2.length; ++j)</span>
                  {
<span class="nc" id="L462">                     ret.add(splitPieces2[j]);</span>
                  }
<span class="nc" id="L464">               }</span>
               else
               {
<span class="nc" id="L467">                  ret.add(splitPieces1[i]);</span>
               }
            }
            //
            // ///////////////////////////////////////////////////////////////////

<span class="nc" id="L473">            return (purgeEmptyStrings(ret)).toArray(new String[0]);</span>
         }
         else
         {
<span class="nc" id="L477">            return new String[]{piece};</span>
         }
      }
   }

   /**
    * Takes the given list of string and removes elements that are either
    * null or empty strings
    *
    * @param items
    * @return
    */
   private List&lt;String&gt; purgeEmptyStrings(List&lt;String&gt; items)
   {
<span class="nc bnc" id="L491" title="All 2 branches missed.">      for (Iterator&lt;String&gt; iter = items.iterator(); iter.hasNext(); )</span>
      {
<span class="nc" id="L493">         String item = iter.next();</span>
<span class="nc bnc" id="L494" title="All 4 branches missed.">         if (item == null || &quot;&quot;.equals(item))</span>
         {
<span class="nc" id="L496">            iter.remove();</span>
         }
<span class="nc" id="L498">      }</span>
<span class="nc" id="L499">      return items;</span>
   }

   private boolean hasTopLevelColon(String piece, CodeReformatorKernel crk)
   {
<span class="nc" id="L504">      int ix = piece.indexOf(&quot;,&quot;);</span>
<span class="nc" id="L505">      StateOfPosition[] stateOfPositions = crk.getStatesOfPosition(piece);</span>

<span class="nc bnc" id="L507" title="All 2 branches missed.">      while (-1 != ix)</span>
      {
<span class="nc bnc" id="L509" title="All 2 branches missed.">         if (stateOfPositions[ix].isTopLevel)</span>
         {
<span class="nc" id="L511">            return true;</span>
         }
<span class="nc bnc" id="L513" title="All 2 branches missed.">         if (ix &lt; piece.length() - 1)</span>
         {
<span class="nc" id="L515">            ix = piece.indexOf(&quot;,&quot;, ix + 1);</span>
         }
         else
         {
            break;
         }
      }

<span class="nc" id="L523">      return false;</span>

   }

   private int[] getTopLevelBraketIndexes(String piece,
                                          CodeReformatorKernel crk)
   {
<span class="nc" id="L530">      int[] ret = new int[2];</span>
<span class="nc" id="L531">      ret[0] = -1;</span>
<span class="nc" id="L532">      ret[1] = -1;</span>

<span class="nc" id="L534">      StateOfPosition[] stateOfPositions = crk.getStatesOfPosition(piece);</span>

<span class="nc" id="L536">      int bra = piece.indexOf(&quot;(&quot;);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">      while (-1 != bra)</span>
      {
<span class="nc" id="L539">         crk.getStatesOfPosition(piece);</span>

<span class="nc bnc" id="L541" title="All 4 branches missed.">         if (0 == bra || stateOfPositions[bra - 1].isTopLevel)</span>
         {
<span class="nc" id="L543">            ret[0] = bra;</span>
<span class="nc" id="L544">            break; // break when first braket found</span>
         }
<span class="nc bnc" id="L546" title="All 2 branches missed.">         if (bra &lt; piece.length() - 1)</span>
         {
<span class="nc" id="L548">            bra = piece.indexOf(&quot;(&quot;, bra + 1);</span>
         }
         else
         {
            break;
         }
      }

<span class="nc bnc" id="L556" title="All 2 branches missed.">      if (-1 == ret[0])</span>
      {
<span class="nc" id="L558">         return ret;</span>
      }

<span class="nc" id="L561">      int ket = piece.indexOf(&quot;)&quot;, bra);</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">      while (-1 != ket)</span>
      {
<span class="nc bnc" id="L564" title="All 4 branches missed.">         if (ket == piece.length() - 1 || stateOfPositions[ket].isTopLevel)</span>
         {
            // the next top level ket is the counterpart to bra
<span class="nc" id="L567">            ret[1] = ket;</span>
<span class="nc" id="L568">            break;</span>
         }
<span class="nc bnc" id="L570" title="All 2 branches missed.">         if (ket &lt; piece.length() - 1)</span>
         {
<span class="nc" id="L572">            ket = piece.indexOf(&quot;)&quot;, ket + 1);</span>
         }
         else
         {
            break;
         }
      }
<span class="nc" id="L579">      return ret;</span>
   }

   private String indent(String piece, int callDepth)
   {
<span class="nc" id="L584">      StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">      for (int i = 0; i &lt; callDepth; ++i)</span>
      {
<span class="nc" id="L587">         sb.append(_codeReformatorConfig.getIndent());</span>
      }
<span class="nc" id="L589">      sb.append(piece);</span>

<span class="nc" id="L591">      return sb.toString();</span>
   }

   private String flatenWhiteSpaces(String in, boolean force)
   {

<span class="nc bnc" id="L597" title="All 4 branches missed.">      if (hasCommentEndingWithLineFeed(in) &amp;&amp; !force)</span>
      {
         // No flaten. We would turn statement parts to comment
<span class="nc" id="L600">         return in;</span>
      }

<span class="nc" id="L603">      StringBuffer ret = new StringBuffer();</span>
<span class="nc" id="L604">      int aposCount = 0;</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">      for (int i = 0; i &lt; in.length(); ++i)</span>
      {

<span class="nc bnc" id="L608" title="All 2 branches missed.">         if ('\'' == in.charAt(i))</span>
         {
<span class="nc" id="L610">            ++aposCount;</span>
         }

<span class="nc" id="L613">         boolean dontAppend = false;</span>

<span class="nc bnc" id="L615" title="All 2 branches missed.">         if (0 != aposCount % 2)</span>
         {

         }
         else
         {
<span class="nc bnc" id="L621" title="All 4 branches missed.">            if (Character.isWhitespace(in.charAt(i)) &amp;&amp; i + 1 &lt; in.length()</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">                  &amp;&amp; Character.isWhitespace(in.charAt(i + 1)))</span>
            {
<span class="nc" id="L624">               dontAppend = true;</span>
            }
         }

<span class="nc bnc" id="L628" title="All 2 branches missed.">         if (false == dontAppend)</span>
         {
            char toAppend;
<span class="nc bnc" id="L631" title="All 4 branches missed.">            if (Character.isWhitespace(in.charAt(i)) &amp;&amp; 0 == aposCount % 2)</span>
            {
<span class="nc" id="L633">               toAppend = ' ';</span>
            }
            else
            {
<span class="nc" id="L637">               toAppend = in.charAt(i);</span>
            }
<span class="nc" id="L639">            ret.append(toAppend);</span>
         }
      }

<span class="nc" id="L643">      return ret.toString();</span>

   }

   boolean hasCommentEndingWithLineFeed(String in)
   {
<span class="nc" id="L649">      CodeReformatorKernel dum = new CodeReformatorKernel(</span>
<span class="nc" id="L650">            _codeReformatorConfig.getStatementSeparator(), new PieceMarkerSpec[0], _codeReformatorConfig.getCommentSpecs());</span>
<span class="nc" id="L651">      StateOfPosition[] sops = dum.getStatesOfPosition(in);</span>

<span class="nc" id="L653">      boolean inComment = false;</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">      for (int i = 0; i &lt; sops.length; ++i)</span>
      {
<span class="nc bnc" id="L656" title="All 4 branches missed.">         if (!inComment &amp;&amp; -1 &lt; sops[i].commentIndex)</span>
         {
<span class="nc" id="L658">            if (-1 &lt; _codeReformatorConfig.getCommentSpecs()[sops[i].commentIndex].commentEnd</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">                  .indexOf('\n'))</span>
            {
<span class="nc" id="L661">               return true;</span>
            }
<span class="nc" id="L663">            inComment = true;</span>
         }
<span class="nc bnc" id="L665" title="All 2 branches missed.">         if (-1 == sops[i].commentIndex)</span>
         {
<span class="nc" id="L667">            inComment = false;</span>
         }
      }
<span class="nc" id="L670">      return false;</span>
   }

   private PieceMarkerSpec[] createPieceMarkerSpecIncludeColon()
   {
<span class="nc" id="L675">      PieceMarkerSpec[] buf = createPieceMarkerSpecExcludeColon();</span>
<span class="nc" id="L676">      ArrayList&lt;PieceMarkerSpec&gt; ret = new ArrayList&lt;PieceMarkerSpec&gt;();</span>
<span class="nc" id="L677">      ret.addAll(Arrays.asList(buf));</span>
<span class="nc" id="L678">      ret.add(new PieceMarkerSpec(&quot;,&quot;,</span>
            PieceMarkerSpec.TYPE_PIECE_MARKER_AT_END));

<span class="nc" id="L681">      return ret.toArray(new PieceMarkerSpec[0]);</span>
   }

   private PieceMarkerSpec[] createPieceMarkerSpecExcludeColon()
   {
<span class="nc" id="L686">      ArrayList&lt;PieceMarkerSpec&gt; ret = new ArrayList&lt;PieceMarkerSpec&gt;();</span>
<span class="nc" id="L687">      ret.addAll(Arrays.asList(_codeReformatorConfig.getKeywordPieceMarkerSpecs()));</span>
<span class="nc" id="L688">      ret.add(new PieceMarkerSpec(_codeReformatorConfig.getStatementSeparator(), PieceMarkerSpec.TYPE_PIECE_MARKER_IN_OWN_PIECE));</span>

<span class="nc" id="L690">      return ret.toArray(new PieceMarkerSpec[ret.size()]);</span>
   }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>