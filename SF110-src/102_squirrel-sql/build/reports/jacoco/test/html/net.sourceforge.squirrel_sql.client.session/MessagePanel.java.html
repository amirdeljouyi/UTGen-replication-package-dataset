<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessagePanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.session</a> &gt; <span class="el_source">MessagePanel.java</span></div><h1>MessagePanel.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.session;
/*
 * Copyright (C) 2001-2004 Colin Bell
 * colbell@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.awt.Color;
import java.awt.event.ActionEvent;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.util.HashMap;

import javax.swing.Action;
import javax.swing.JTextPane;
import javax.swing.SwingUtilities;
import javax.swing.text.BadLocationException;
import javax.swing.text.Document;
import javax.swing.text.SimpleAttributeSet;
import javax.swing.text.StyleConstants;

import net.sourceforge.squirrel_sql.fw.gui.TextPopupMenu;
import net.sourceforge.squirrel_sql.fw.gui.action.BaseAction;
import net.sourceforge.squirrel_sql.fw.util.DefaultExceptionFormatter;
import net.sourceforge.squirrel_sql.fw.util.ExceptionFormatter;
import net.sourceforge.squirrel_sql.fw.util.IMessageHandler;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;
/**
 * This is the message panel at the bottom of the session sheet.
 *
 * @author &lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 */
public class MessagePanel extends JTextPane implements IMessageHandler
{
	/** Logger for this class. */
<span class="nc" id="L51">	private static final ILogger s_log =</span>
<span class="nc" id="L52">		LoggerController.createLogger(MessagePanel.class);</span>

    /** Internationalized strings for this class. */
<span class="nc" id="L55">    private static final StringManager s_stringMgr =</span>
<span class="nc" id="L56">        StringManagerFactory.getStringManager(MessagePanel.class);</span>

   /** Popup menu for this component. */
<span class="nc" id="L59">	private final TextPopupMenu _popupMenu = new MessagePanelPopupMenu();</span>

	/**
	 * Attribute sets for error and last message.
	 */
	private SimpleAttributeSet _saSetMessage;
//	private SimpleAttributeSet _saSetErrorHistory;
	private SimpleAttributeSet _saSetError;
	private SimpleAttributeSet _saSetWarning;

	/**
	 * Save into these attributes the parameters of the last message being output.
	 * @todo In the near future: if more than one message shall be remembered, then these variables
	 * need to be replaced with a dynamic storage (ArrayList or similar).
	 */
	private int _lastLength;
	private String _lastMessage;
	private SimpleAttributeSet _lastSASet;

<span class="nc" id="L78">   private HashMap&lt;SimpleAttributeSet, SimpleAttributeSet&gt; _saSetHistoryBySaSet </span>
       = new HashMap&lt;SimpleAttributeSet, SimpleAttributeSet&gt;();

   private static interface I18N {
       //i18n[MessagePanel.clearLabel=Clear]
<span class="nc" id="L83">       String CLEAR_LABEL = s_stringMgr.getString(&quot;MessagePanel.clearLabel&quot;);</span>
   }
   
<span class="nc" id="L86">   private DefaultExceptionFormatter defaultExceptionFormatter = </span>
       new DefaultExceptionFormatter();
   
   /**
    * Default ctor.
    */
   public MessagePanel()
   {
<span class="nc" id="L94">      super();</span>

<span class="nc" id="L96">      _popupMenu.setTextComponent(this);</span>

      // Add mouse listener for displaying popup menu.
<span class="nc" id="L99">      addMouseListener(new MouseAdapter()</span>
<span class="nc" id="L100">      {</span>
         public void mousePressed(MouseEvent evt)
         {
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (evt.isPopupTrigger())</span>
            {
<span class="nc" id="L105">               _popupMenu.show(evt);</span>
            }
<span class="nc" id="L107">         }</span>
         public void mouseReleased(MouseEvent evt)
         {
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (evt.isPopupTrigger())</span>
            {
<span class="nc" id="L112">               _popupMenu.show(evt);</span>
            }
<span class="nc" id="L114">         }</span>
      });

      ///////////////////////////////////////////////////////////////////
      // Message
<span class="nc" id="L119">      _saSetMessage = new SimpleAttributeSet();</span>
<span class="nc" id="L120">      StyleConstants.setBackground(_saSetMessage, Color.green);</span>

<span class="nc" id="L122">      SimpleAttributeSet saSetMessageHistory = new SimpleAttributeSet();</span>
<span class="nc" id="L123">      StyleConstants.setBackground(saSetMessageHistory, getBackground());</span>
<span class="nc" id="L124">      _saSetHistoryBySaSet.put(_saSetMessage, saSetMessageHistory);</span>
      //
      ////////////////////////////////////////////////////////////////


      ///////////////////////////////////////////////////////////////////
      // Warning
<span class="nc" id="L131">      _saSetWarning = new SimpleAttributeSet();</span>
<span class="nc" id="L132">      StyleConstants.setBackground(_saSetWarning, Color.yellow);</span>

<span class="nc" id="L134">      SimpleAttributeSet saSetWarningHistory = new SimpleAttributeSet();</span>
<span class="nc" id="L135">      StyleConstants.setBackground(saSetWarningHistory, new Color(255,255,210)); // a light yellow</span>
<span class="nc" id="L136">      _saSetHistoryBySaSet.put(_saSetWarning, saSetWarningHistory);</span>
      //
      ////////////////////////////////////////////////////////////////


      /////////////////////////////////////////////////////////////////
      // Error
      // Attention: Do not use background colors here.
      // Color blind people cannot read black writing on red background.
<span class="nc" id="L145">      _saSetError = new SimpleAttributeSet();</span>
      //StyleConstants.setBackground(_saSetError, Color.red);
<span class="nc" id="L147">      StyleConstants.setForeground(_saSetError, Color.red);</span>

<span class="nc" id="L149">      SimpleAttributeSet saSetErrorHistory = new SimpleAttributeSet();</span>
      //StyleConstants.setBackground(saSetErrorHistory, Color.pink);
<span class="nc" id="L151">      StyleConstants.setForeground(saSetErrorHistory, new Color(255,102,102));</span>
<span class="nc" id="L152">      _saSetHistoryBySaSet.put(_saSetError, saSetErrorHistory);</span>
      //
      //////////////////////////////////////////////////////////////////


<span class="nc" id="L157">   }</span>


   public void addToMessagePanelPopup(Action action)
   {
<span class="nc bnc" id="L162" title="All 2 branches missed.">       if (action == null) {</span>
<span class="nc" id="L163">           throw new IllegalArgumentException(&quot;action cannot be null&quot;);</span>
       }
<span class="nc" id="L165">      _popupMenu.add(action);   </span>
<span class="nc" id="L166">   }</span>


   /**
    * Show a message describing the passed throwable object.
    *
    * @param th	The throwable object.
    * @param session the session that generated the exception.
    */
   public synchronized void showMessage(final Throwable th, 
                                        final ExceptionFormatter formatter)
   {
<span class="nc bnc" id="L178" title="All 2 branches missed.">      if (th == null)</span>
      {
<span class="nc" id="L180">          throw new IllegalArgumentException(&quot;th cannot be null&quot;);</span>
      }
<span class="nc" id="L182">      privateShowMessage(th, formatter, _saSetMessage);</span>
<span class="nc" id="L183">   }</span>
   

   /**
	 * Show an error message describing the passed exception. The controls
	 * background color will be changed to show it is an error msg.
	 *
	 * @param	th		Exception.
     * @param session the session that generated the exception. 
	 */
	public synchronized void showErrorMessage(final Throwable th, 
                                              ExceptionFormatter formatter)
	{
<span class="nc bnc" id="L196" title="All 2 branches missed.">		if (th == null)</span>
		{
<span class="nc" id="L198">            throw new IllegalArgumentException(&quot;th cannot be null&quot;);</span>
		}
<span class="nc" id="L200">        privateShowMessage(th, formatter, _saSetError);</span>
<span class="nc" id="L201">	}</span>


   /**
    * Show a message.
    *
    * @param msg	The message to be shown.
    */
   public synchronized void showMessage(final String msg)
   {
<span class="nc bnc" id="L211" title="All 2 branches missed.">      if (msg == null)</span>
      {
<span class="nc" id="L213">          throw new IllegalArgumentException(&quot;msg cannot be null&quot;);</span>
      }
<span class="nc" id="L215">      privateShowMessage(msg, _saSetMessage);</span>
<span class="nc" id="L216">   }</span>

   public void showWarningMessage(String msg)
   {
<span class="nc bnc" id="L220" title="All 2 branches missed.">      if (msg == null)</span>
      {
<span class="nc" id="L222">          throw new IllegalArgumentException(&quot;msg cannot be null&quot;);</span>
         
      }
<span class="nc" id="L225">      privateShowMessage(msg, _saSetWarning);</span>
<span class="nc" id="L226">   }</span>
   
   /**
	 * Show an error message. The controls
	 * background color will be changed to show it is an error msg.
 * @param	th		Exception.
	 */
	public synchronized void showErrorMessage(final String msg)
	{
<span class="nc bnc" id="L235" title="All 2 branches missed.">		if (msg == null)</span>
		{
<span class="nc" id="L237">			throw new IllegalArgumentException(&quot;msg cannot be null&quot;);</span>
		}
<span class="nc" id="L239">        privateShowMessage(msg, _saSetError);</span>
<span class="nc" id="L240">	}</span>


   /**
    * Private method, the real implementation of the corresponding show*Message methods.
    *
    * @param th	The throwable whose details shall be displayed.
    * @param saSet The SimpleAttributeSet to be used for message output.
    */
   private void privateShowMessage(final Throwable th, 
                                   final ExceptionFormatter formatter, 
                                   final SimpleAttributeSet saSet)
   {
<span class="nc bnc" id="L253" title="All 2 branches missed.">      if (th != null) {</span>
          
<span class="nc" id="L255">          String message = &quot;&quot;;</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">          if (formatter == null) {</span>
<span class="nc" id="L257">              message = defaultExceptionFormatter.format(th);</span>
          } else {
              try {
<span class="nc" id="L260">                  message = formatter.format(th);</span>
<span class="nc" id="L261">              } catch (Exception e) {</span>
<span class="nc" id="L262">                  s_log.error(&quot;Unable to format message: &quot;+e.getMessage(), e);</span>
<span class="nc" id="L263">              }</span>
          }
<span class="nc" id="L265">          privateShowMessage(message, saSet);</span>
<span class="nc" id="L266">          s_log.error(&quot;privateShowMessage: Exception was &quot;+th.getMessage(), th);</span>
      }
<span class="nc" id="L268">   }</span>
   
	/**
	 * Private method, the real implementation of the corresponding show*Message methods.
	 *
	 * @param msg	The message to be displayed.
	 * @param saSet	The SimpleAttributeSet to be used for message output.
	 */
	private void privateShowMessage(final String msg, final SimpleAttributeSet saSet)
	{
<span class="nc bnc" id="L278" title="All 2 branches missed.">		if (msg == null)</span>
		{
<span class="nc" id="L280">			throw new IllegalArgumentException(&quot;null Message&quot;);</span>
		}

		// Thread safe support for every call to this method:
<span class="nc" id="L284">		SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L285">		{</span>
			public void run()
			{
<span class="nc" id="L288">				addLine(msg, saSet);</span>
<span class="nc" id="L289">			}</span>
		});
<span class="nc" id="L291">	}</span>

	/**
	 * Do the real appending of text to the message panel. The last message is always highlighted.
	 * @todo Highlight not only the last message, but all messages from SQL statements which were run together.
	 *
	 * @param string	The String to be appended.
	 * @param saSet		The SimpleAttributeSet to be used for for the string.
	 */
	private void append(String string, SimpleAttributeSet saSet)
	{
<span class="nc" id="L302">		Document document = getStyledDocument();</span>
		try
		{
         /////////////////////////////////////////////////////////////////////////////////
         // Checks if the former message should be highlighted in a 'history' color.
<span class="nc bnc" id="L307" title="All 4 branches missed.">         if (document.getLength() &gt;= _lastLength &amp;&amp; null != _lastMessage)</span>
			{
<span class="nc" id="L309">            SimpleAttributeSet historySaSet = _saSetHistoryBySaSet.get(_lastSASet);</span>
<span class="nc" id="L310">            document.remove(_lastLength, _lastMessage.length());</span>
<span class="nc" id="L311">            document.insertString(document.getLength(), _lastMessage, historySaSet);</span>
			}
         //
         ///////////////////////////////////////////////////////////////////////////////////

<span class="nc" id="L316">         _lastLength = document.getLength();</span>
<span class="nc" id="L317">			_lastMessage = string;</span>
<span class="nc" id="L318">			_lastSASet = saSet;</span>

<span class="nc" id="L320">			document.insertString(document.getLength(), string, saSet);</span>
		}
<span class="nc" id="L322">		catch (BadLocationException ble)</span>
		{
<span class="nc" id="L324">			s_log.error(&quot;Error appending text to MessagePanel document.&quot;, ble);</span>
<span class="nc" id="L325">		}</span>
<span class="nc" id="L326">	}</span>

	/**
	 * Add the passed line to the end of the messages display. Position
	 * display so the the newly added line will be displayed.
	 *
	 * @param line		The line to be added.
	 * @param saSet		The SimpleAttributeSet to be used for for the string.
	 */
	private void addLine(String line, SimpleAttributeSet saSet)
	{
<span class="nc bnc" id="L337" title="All 2 branches missed.">		if (getDocument().getLength() &gt; 0)</span>
		{
<span class="nc" id="L339">			append(&quot;\n&quot;, saSet);</span>
		}
<span class="nc" id="L341">		append(line, saSet);</span>
<span class="nc" id="L342">		final int len = getDocument().getLength();</span>
<span class="nc" id="L343">		select(len, len);</span>
<span class="nc" id="L344">	}</span>

	/**
	 * Popup menu for this message panel.
	 */
	private class MessagePanelPopupMenu extends TextPopupMenu
	{
        static final long serialVersionUID = -425002646648750251L;
        
		public MessagePanelPopupMenu()
<span class="nc" id="L354">		{</span>
<span class="nc" id="L355">			super();</span>
<span class="nc" id="L356">			add(new ClearAction());</span>
<span class="nc" id="L357">		}</span>

		/**
		 * Class handles clearing the message area. Resets the background
		 * colour (to get rid of error msg colour) as well as clearing
		 * the text.
		 */
		private class ClearAction extends BaseAction
		{
            static final long serialVersionUID = 2124058843445088350L;
			protected ClearAction()
<span class="nc" id="L368">			{</span>
<span class="nc" id="L369">				super(I18N.CLEAR_LABEL);</span>
<span class="nc" id="L370">			}</span>

			public void actionPerformed(ActionEvent evt)
			{
				try
				{
<span class="nc" id="L376">				    Document doc = MessagePanel.this.getDocument();</span>
<span class="nc" id="L377">				    doc.remove(0, doc.getLength());</span>
<span class="nc" id="L378">				    _lastMessage = null;</span>
				}
<span class="nc" id="L380">				catch (BadLocationException ex)</span>
				{
<span class="nc" id="L382">					s_log.error(&quot;Error clearing document&quot;, ex);</span>
<span class="nc" id="L383">				}</span>
<span class="nc" id="L384">			}</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>