<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainFrameToolBar.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.gui.mainframe</a> &gt; <span class="el_source">MainFrameToolBar.java</span></div><h1>MainFrameToolBar.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.gui.mainframe;
/*
 * Copyright (C) 2001-2004 Colin Bell
 * colbell@users.sourceforge.net
 *
 * Modifications Copyright (C) 2003-2004 Jason Height
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.Iterator;

import javax.swing.JComboBox;
import javax.swing.JLabel;

import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.action.ActionCollection;
import net.sourceforge.squirrel_sql.client.gui.db.SQLAlias;
import net.sourceforge.squirrel_sql.client.mainframe.action.CascadeAction;
import net.sourceforge.squirrel_sql.client.mainframe.action.ConnectToAliasCommand;
import net.sourceforge.squirrel_sql.client.mainframe.action.GlobalPreferencesAction;
import net.sourceforge.squirrel_sql.client.mainframe.action.MaximizeAction;
import net.sourceforge.squirrel_sql.client.mainframe.action.NewSessionPropertiesAction;
import net.sourceforge.squirrel_sql.client.mainframe.action.TileAction;
import net.sourceforge.squirrel_sql.client.mainframe.action.TileHorizontalAction;
import net.sourceforge.squirrel_sql.client.mainframe.action.TileVerticalAction;
import net.sourceforge.squirrel_sql.client.session.ISession;
import net.sourceforge.squirrel_sql.client.session.SessionManager;
import net.sourceforge.squirrel_sql.client.session.action.CommitAction;
import net.sourceforge.squirrel_sql.client.session.action.NewObjectTreeAction;
import net.sourceforge.squirrel_sql.client.session.action.NewSQLWorksheetAction;
import net.sourceforge.squirrel_sql.client.session.action.RollbackAction;
import net.sourceforge.squirrel_sql.client.session.action.ToggleAutoCommitAction;
import net.sourceforge.squirrel_sql.client.session.event.SessionAdapter;
import net.sourceforge.squirrel_sql.client.session.event.SessionEvent;
import net.sourceforge.squirrel_sql.fw.gui.GUIUtils;
import net.sourceforge.squirrel_sql.fw.gui.IToggleAction;
import net.sourceforge.squirrel_sql.fw.gui.SortedComboBoxModel;
import net.sourceforge.squirrel_sql.fw.gui.ToolBar;
import net.sourceforge.squirrel_sql.fw.sql.ISQLAlias;
import net.sourceforge.squirrel_sql.fw.util.IObjectCacheChangeListener;
import net.sourceforge.squirrel_sql.fw.util.ObjectCacheChangeEvent;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
/**
 * Toolbar for &lt;CODE&gt;MainFrame&lt;/CODE&gt;.
 *
 * @author	&lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 */
class MainFrameToolBar extends ToolBar
{
    private static final long serialVersionUID = 1L;

    /** Internationalized strings for this class. */
<span class="nc" id="L69">	private static final StringManager s_stringMgr =</span>
<span class="nc" id="L70">		StringManagerFactory.getStringManager(MainFrameToolBar.class);</span>

	/** Application API. */
	transient private IApplication _app;

<span class="nc" id="L75">	private boolean _dontReactToSessionDropDownAction = false;</span>
   
   /**
    * ctor.
    *
    * @param	app		Application API
    *
    * @throws	IllegalArgumentException
    *			&lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;IApplication&lt;/TT&gt; or &lt;TT&gt;MainFrame&lt;/TT&gt;
    *			passed.
    */
   MainFrameToolBar(IApplication app)
   {
<span class="nc" id="L88">      super();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">      if (app == null)</span>
      {
<span class="nc" id="L91">         throw new IllegalArgumentException(&quot;IApplication == null&quot;);</span>
      }
<span class="nc" id="L93">      _app = app;</span>
<span class="nc" id="L94">      setUseRolloverButtons(true);</span>
<span class="nc" id="L95">      setFloatable(true);</span>

<span class="nc" id="L97">      ActionCollection actions = _app.getActionCollection();</span>
<span class="nc" id="L98">      JLabel lbl = new JLabel(s_stringMgr.getString(&quot;MainFrameToolBar.connectTo&quot;));</span>
<span class="nc" id="L99">      lbl.setAlignmentY(0.5f);</span>
<span class="nc" id="L100">      add(lbl);</span>
<span class="nc" id="L101">      AliasesDropDown drop = new AliasesDropDown(app);</span>
<span class="nc" id="L102">      drop.setAlignmentY(0.5f);</span>
<span class="nc" id="L103">      add(drop);</span>
<span class="nc" id="L104">      addSeparator();</span>
<span class="nc" id="L105">      add(actions.get(GlobalPreferencesAction.class));</span>
<span class="nc" id="L106">      add(actions.get(NewSessionPropertiesAction.class));</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">      if (_app.getDesktopStyle().isInternalFrameStyle())</span>
      {
<span class="nc" id="L109">         addSeparator();</span>
<span class="nc" id="L110">         add(actions.get(TileAction.class));</span>
<span class="nc" id="L111">         add(actions.get(TileHorizontalAction.class));</span>
<span class="nc" id="L112">         add(actions.get(TileVerticalAction.class));</span>
<span class="nc" id="L113">         add(actions.get(CascadeAction.class));</span>
<span class="nc" id="L114">         add(actions.get(MaximizeAction.class));</span>
<span class="nc" id="L115">         addSeparator();</span>
      }
<span class="nc" id="L117">      JLabel lbl2 = new JLabel(&quot; &quot; + s_stringMgr.getString(&quot;MainFrameToolBar.activeSession&quot;) + &quot; &quot;);</span>
<span class="nc" id="L118">      lbl.setAlignmentY(0.5f);</span>
<span class="nc" id="L119">      add(lbl2);</span>
<span class="nc" id="L120">      SessionDropDown sessionDropDown = new SessionDropDown(app);</span>
<span class="nc" id="L121">      sessionDropDown.setAlignmentY(0.5f);</span>
<span class="nc" id="L122">      add(sessionDropDown);</span>

<span class="nc" id="L124">      addToggleAction((IToggleAction) actions.get(ToggleAutoCommitAction.class));</span>
<span class="nc" id="L125">      add(actions.get(CommitAction.class));</span>
<span class="nc" id="L126">      add(actions.get(RollbackAction.class));</span>

<span class="nc" id="L128">      addSeparator();</span>

<span class="nc" id="L130">      add(actions.get(NewSQLWorksheetAction.class));</span>
<span class="nc" id="L131">      add(actions.get(NewObjectTreeAction.class));</span>
<span class="nc" id="L132">   }</span>


   /**
	 * Dropdown holding all the current &lt;TT&gt;ISQLAlias&lt;/TT&gt; objects. When one is
	 * selected the user will be prompted to connect to it.
	 */
	private static class AliasesDropDown extends JComboBox
											implements ActionListener
	{
	    private static final long serialVersionUID = 1L;
        
        transient final private IApplication _myApp;

		AliasesDropDown(IApplication app)
		{
<span class="nc" id="L148">			super();</span>
<span class="nc" id="L149">			_myApp = app;</span>
<span class="nc" id="L150">			final AliasesDropDownModel model = new AliasesDropDownModel(app, this);</span>
<span class="nc" id="L151">			setModel(model);</span>

			// Under JDK1.4 the first item in a JComboBox
			// is no longer automatically selected.
<span class="nc bnc" id="L155" title="All 2 branches missed.">			if (getModel().getSize() &gt; 0)</span>
			{
<span class="nc" id="L157">				setSelectedIndex(0);</span>
			}

			// Under JDK1.4 an empty JComboBox has an almost zero width.
			else
			{
<span class="nc" id="L163">				final Dimension dm = getPreferredSize();</span>
<span class="nc" id="L164">				dm.width = 100;</span>
<span class="nc" id="L165">				setPreferredSize(dm);</span>
			}
<span class="nc" id="L167">			addActionListener(this);</span>
<span class="nc" id="L168">			setMaximumSize(getPreferredSize());</span>

<span class="nc" id="L170">			app.getDataCache().addAliasesListener(new MyAliasesListener(model, this));</span>
			
<span class="nc" id="L172">			this.setName(this.getClass().getCanonicalName());</span>
<span class="nc" id="L173">		}</span>

		/**
		 * An alias has been selected in the list so attempt to connect to it.
		 *
		 * @param	evt	 Describes the event that has just occured.
		 */
		public void actionPerformed(ActionEvent evt)
		{
			try
			{
<span class="nc" id="L184">				Object obj = getSelectedItem();</span>
<span class="nc bnc" id="L185" title="All 4 branches missed.">				if (obj instanceof SQLAlias &amp;&amp; this.isEnabled())</span>
				{
<span class="nc" id="L187">					new ConnectToAliasCommand(_myApp, (SQLAlias)obj).execute();</span>
				}
			}
			finally
			{
<span class="nc bnc" id="L192" title="All 2 branches missed.">				if (getModel().getSize() &gt; 0)</span>
				{
<span class="nc" id="L194">					setSelectedIndex(0);</span>
				}
			}
<span class="nc" id="L197">		}</span>
	}

	/**
	 * Data model for AliasesDropDown.
	 */
	private static class AliasesDropDownModel extends SortedComboBoxModel
	{
        private static final long serialVersionUID = 1L;

        transient private IApplication _myApp;
        private AliasesDropDown _aliasDropDown;
		/**
		 * Default ctor. Listen to the &lt;TT&gt;DataCache&lt;/TT&gt; object for additions
		 * and removals of aliases from the cache.
		 */
		public AliasesDropDownModel(IApplication app, AliasesDropDown drop)
		{
<span class="nc" id="L215">			super();</span>
<span class="nc" id="L216">			_myApp = app;</span>
<span class="nc" id="L217">            _aliasDropDown = drop;</span>
<span class="nc" id="L218">			load();</span>
			//_app.getDataCache().addAliasesListener(new MyAliasesListener(this));
<span class="nc" id="L220">		}</span>

		/**
		 * Load from &lt;TT&gt;DataCache&lt;/TT&gt;.
		 */
		private void load()
		{
<span class="nc" id="L227">			Iterator&lt;ISQLAlias&gt; it = _myApp.getDataCache().aliases();</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">			while (it.hasNext())</span>
			{
<span class="nc" id="L230">				addAlias(it.next());</span>
			}
<span class="nc" id="L232">		}</span>

		/**
		 * Add an &lt;TT&gt;ISQLAlias&lt;/TT&gt; to this model.
		 *
		 * @param	alias	&lt;TT&gt;ISQLAlias&lt;/TT&gt; to be added.
		 */
		private void addAlias(ISQLAlias alias)
		{
<span class="nc" id="L241">            _aliasDropDown.setEnabled(false);</span>
<span class="nc" id="L242">			addElement(alias);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">            if (_aliasDropDown.getModel().getSize() &gt; 0) {</span>
<span class="nc" id="L244">                _aliasDropDown.setSelectedIndex(0);</span>
            }
<span class="nc" id="L246">            _aliasDropDown.setEnabled(true);            </span>
<span class="nc" id="L247">		}</span>

		/**
		 * Remove an &lt;TT&gt;ISQLAlias&lt;/TT&gt; from this model.
		 *
		 * @param	alias	&lt;TT&gt;ISQLAlias&lt;/TT&gt; to be removed.
		 */
		private void removeAlias(ISQLAlias alias)
		{
<span class="nc" id="L256">            _aliasDropDown.setEnabled(false);</span>
<span class="nc" id="L257">			removeElement(alias);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (_aliasDropDown.getModel().getSize() &gt; 0) {</span>
<span class="nc" id="L259">                _aliasDropDown.setSelectedIndex(0);</span>
            }
<span class="nc" id="L261">            _aliasDropDown.setEnabled(true);</span>
<span class="nc" id="L262">		}</span>
	}

	/**
	 * Listener to changes in &lt;TT&gt;ObjectCache&lt;/TT&gt;. As aliases are
	 * added to/removed from &lt;TT&gt;DataCache&lt;/TT&gt; this model is updated.
	 */
	private static class MyAliasesListener implements IObjectCacheChangeListener
	{
		/** Model that is listening. */
		private AliasesDropDownModel _model;

		/** Control for _model. */
		private AliasesDropDown _control;

		/**
		 * Ctor specifying the model and control that is listening.
		 */
		MyAliasesListener(AliasesDropDownModel model, AliasesDropDown control)
		{
<span class="nc" id="L282">			super();</span>
<span class="nc" id="L283">			_model = model;</span>
<span class="nc" id="L284">			_control = control;</span>
<span class="nc" id="L285">		}</span>

		/**
		 * An alias has been added to the cache.
		 *
		 * @param	evt	Describes the event in the cache.
		 */
		public void objectAdded(ObjectCacheChangeEvent evt)
		{
<span class="nc" id="L294">			Object obj = evt.getObject();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">			if (obj instanceof ISQLAlias)</span>
			{
<span class="nc" id="L297">				_model.addAlias((ISQLAlias) obj);</span>
			}
<span class="nc bnc" id="L299" title="All 2 branches missed.">			if (_control.getItemCount() == 1)</span>
			{
<span class="nc" id="L301">				_control.setSelectedIndex(0);</span>
			}
<span class="nc" id="L303">		}</span>

		/**
		 * An alias has been removed from the cache.
		 *
		 * @param	evt	Describes the event in the cache.
		 */
		public void objectRemoved(ObjectCacheChangeEvent evt)
		{
<span class="nc" id="L312">			Object obj = evt.getObject();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">			if (obj instanceof ISQLAlias)</span>
			{
<span class="nc" id="L315">				_model.removeAlias((ISQLAlias)obj);</span>
			}
<span class="nc" id="L317">		}</span>
	}

	/**
	 * Dropdown holding all the current active &lt;TT&gt;ISession&lt;/TT&gt; objects.
	 */
	private class SessionDropDown extends JComboBox
										implements ActionListener
	{
        private static final long serialVersionUID = 1L;
        private IApplication _app;
<span class="nc" id="L328">		private boolean _closing = false;</span>

		SessionDropDown(IApplication app)
<span class="nc" id="L331">		{</span>
<span class="nc" id="L332">			super();</span>
<span class="nc" id="L333">			_app = app;</span>
<span class="nc" id="L334">			final SessionManager sessionManager = _app.getSessionManager();</span>
<span class="nc" id="L335">			final SessionDropDownModel model = new SessionDropDownModel(</span>
															sessionManager);
<span class="nc" id="L337">			setModel(model);</span>

			// Under JDK1.4 the first item in a JComboBox
			// is no longer automatically selected.
<span class="nc bnc" id="L341" title="All 2 branches missed.">			if (getModel().getSize() &gt; 0)</span>
			{
<span class="nc" id="L343">				setSelectedIndex(0);</span>
			}
			else
			{
				// Under JDK1.4 an empty JComboBox has an almost zero width.
<span class="nc" id="L348">				Dimension dm = getPreferredSize();</span>
<span class="nc" id="L349">				dm.width = 200;</span>
<span class="nc" id="L350">				setPreferredSize(dm);</span>
				// Dont enable the session drop down if it is empty
<span class="nc" id="L352">				setEnabled(false);</span>
			}
<span class="nc" id="L354">			addActionListener(this);</span>
<span class="nc" id="L355">			setMaximumSize(getPreferredSize());</span>

<span class="nc" id="L357">			sessionManager.addSessionListener(new MySessionListener(model, this));</span>
<span class="nc" id="L358">		}</span>

		/**
		 * An session has been selected in the list so set it as the active session.
		 *
		 * @param	evt	 Describes the event that has just occured.
		 */
		public void actionPerformed(ActionEvent evt)
		{
<span class="nc bnc" id="L367" title="All 4 branches missed.">			if (!_closing &amp;&amp; !_dontReactToSessionDropDownAction)</span>
			{
<span class="nc" id="L369">				final Object obj = getSelectedItem();</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">				if (obj instanceof ISession)</span>
				{
<span class="nc" id="L372">					_app.getSessionManager().setActiveSession((ISession)obj, false);</span>
				}
			}
<span class="nc" id="L375">		}</span>
	}

	/**
	 * Data model for SessionDropDownModel.
	 */
	private static class SessionDropDownModel extends SortedComboBoxModel
	{
        private static final long serialVersionUID = 1L;
        transient private SessionManager _sessionManager;

		/**
		 * Default ctor. Listen to the &lt;TT&gt;ISessioManager&lt;/TT&gt; object for additions
		 * and removals of aliases from the cache.
		 */
		public SessionDropDownModel(SessionManager sessionManager)
		{
<span class="nc" id="L392">			super();</span>
<span class="nc" id="L393">			_sessionManager = sessionManager;</span>
<span class="nc" id="L394">			load();</span>
<span class="nc" id="L395">		}</span>

		/**
		 * Load from &lt;TT&gt;DataCache&lt;/TT&gt;.
		 */
		private void load()
		{
<span class="nc" id="L402">			final ISession[] s = _sessionManager.getConnectedSessions();</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">			if (s != null)</span>
			{
<span class="nc bnc" id="L405" title="All 2 branches missed.">				for (int i = 0; i &lt; s.length; i++)</span>
				{
<span class="nc" id="L407">					addSession(s[i]);</span>
				}
			}
<span class="nc" id="L410">		}</span>

		/**
		 * Add an &lt;TT&gt;ISession&lt;/TT&gt; to this model.
		 *
		 * @param	session	&lt;TT&gt;ISession&lt;/TT&gt; to be added.
		 */
		private void addSession(ISession session)
		{
<span class="nc" id="L419">			addElement(session);</span>
<span class="nc" id="L420">		}</span>

		/**
		 * Remove an &lt;TT&gt;ISession&lt;/TT&gt; from this model.
		 *
		 * @param	session &lt;TT&gt;ISession&lt;/TT&gt; to be removed.
		 */
		private void removeSession(ISession session)
		{
<span class="nc" id="L429">			removeElement(session);</span>
<span class="nc" id="L430">		}</span>
	}

	/**
	 * Listener to changes in &lt;TT&gt;SessionManager&lt;/TT&gt;. As sessions are
	 * added to/removed from &lt;TT&gt;SessionManager&lt;/TT&gt; this model is updated.
	 */
	private class MySessionListener extends SessionAdapter
	{
		/** Model that is listening. */
		private final SessionDropDownModel _model;

		/** Control for _model. */
		private final SessionDropDown _sessionDropDown;

      /**
		 * Ctor specifying the model and control that is listening.
		 */
		MySessionListener(SessionDropDownModel model, SessionDropDown control)
<span class="nc" id="L449">		{</span>
<span class="nc" id="L450">			super();</span>
<span class="nc" id="L451">			_model = model;</span>
<span class="nc" id="L452">			_sessionDropDown = control;</span>
<span class="nc" id="L453">		}</span>

		public void sessionConnected(SessionEvent evt)
		{
<span class="nc" id="L457">			final ISession session = evt.getSession();</span>
         // Needes to be done via event queque because method is not called from the event disptach thread.
<span class="nc" id="L459">			GUIUtils.processOnSwingEventThread(new Runnable()</span>
<span class="nc" id="L460">			{</span>
				public void run()
				{
<span class="nc" id="L463">					_model.addSession(session);</span>
<span class="nc" id="L464">					_sessionDropDown.setEnabled(true);</span>
<span class="nc" id="L465">				}</span>
			});
<span class="nc" id="L467">		}</span>

		public void sessionClosing(SessionEvent evt)
		{
<span class="nc" id="L471">			final ISession session = evt.getSession();</span>
<span class="nc" id="L472">			GUIUtils.processOnSwingEventThread(new Runnable()</span>
<span class="nc" id="L473">			{</span>
				public void run()
				{
<span class="nc" id="L476">					_sessionDropDown._closing = true;</span>
<span class="nc" id="L477">					_model.removeSession(session);</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">					if (_model.getSize() == 0)</span>
					{
<span class="nc" id="L480">						_sessionDropDown.setEnabled(false);</span>
					}
<span class="nc" id="L482">					_sessionDropDown._closing = false;</span>
<span class="nc" id="L483">				}</span>
			});

<span class="nc" id="L486">		}</span>

      public void sessionActivated(SessionEvent evt)
      {
<span class="nc" id="L490">         final ISession session = evt.getSession();</span>

         // Needes to be done via event queque because adding the session to the
         // drop down happens via the event queue too.
<span class="nc" id="L494">         GUIUtils.processOnSwingEventThread(new Runnable()</span>
<span class="nc" id="L495">         {</span>
            public void run()
            {
               try
               {
<span class="nc" id="L500">                  _dontReactToSessionDropDownAction = true;</span>
<span class="nc" id="L501">                  _sessionDropDown.setSelectedItem(session);</span>
               }
               finally
               {
<span class="nc" id="L505">                  _dontReactToSessionDropDownAction = false;</span>
               }
<span class="nc" id="L507">            }</span>
         });
<span class="nc" id="L509">      }</span>

   }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>