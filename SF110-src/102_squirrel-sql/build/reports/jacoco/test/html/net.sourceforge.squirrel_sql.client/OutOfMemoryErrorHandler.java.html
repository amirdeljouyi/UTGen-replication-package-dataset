<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OutOfMemoryErrorHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client</a> &gt; <span class="el_source">OutOfMemoryErrorHandler.java</span></div><h1>OutOfMemoryErrorHandler.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011 Stefan Willinger
 * wis775@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
package net.sourceforge.squirrel_sql.client;

import net.sourceforge.squirrel_sql.client.session.ISession;
import net.sourceforge.squirrel_sql.client.session.SessionManager;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

/**
 * Handler, that tries to free some memory. Mostly, if a
 * {@link OutOfMemoryError} occurs,the user not be able to save his work,
 * because the GUI is no longer responsible. To avoid this, we try to free some
 * memory by closing all SQL result tabs. Under normal conditions, the SQL
 * result tabs are components, which uses the most memory. So we have a high
 * chance to free enough memory to keep the GUI responsible, that the user can
 * save his work and restart SQuirrel. The scope is not, to protect the user
 * from getting a {@link OutOfMemoryError}.
 * 
 * @author Stefan Willinger
 * 
 */
public class OutOfMemoryErrorHandler implements IOutOfMemoryErrorHandler{

<span class="nc" id="L43">	private static final ILogger log = LoggerController.createLogger(OutOfMemoryErrorHandler.class);</span>

<span class="nc" id="L45">	private static final StringManager stringMgr = StringManagerFactory</span>
<span class="nc" id="L46">			.getStringManager(OutOfMemoryErrorHandler.class);</span>

	interface i18n {
<span class="nc" id="L49">		String message = stringMgr.getString(&quot;OutOfMemoryErrorHandler.message&quot;);</span>
	}


	/**
	 * The application
	 */
	private IApplication application;

	/**
	 * Default Constructor. You have to set {@link #application} manually.
	 */
	public OutOfMemoryErrorHandler() {
<span class="nc" id="L62">		super();</span>
<span class="nc" id="L63">	}</span>

	/**
	 * Constructor setting the {@link #application}
	 * 
	 * @param application
	 */
	public OutOfMemoryErrorHandler(IApplication application) {
<span class="nc" id="L71">		super();</span>
<span class="nc" id="L72">		setApplication(application);</span>
<span class="nc" id="L73">	}</span>

	
	/**
	 * Gets the application
	 * 
	 * @return the application
	 */
	public IApplication getApplication() {
<span class="nc" id="L82">		return application;</span>
	}

	/**
	 * Sets the application.
	 * 
	 * @param application
	 *            the application to set
	 * @throws IllegalArgumentException
	 *             if application is null;
	 */
	public void setApplication(IApplication application) {
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (application == null) {</span>
<span class="nc" id="L95">			throw new IllegalArgumentException(&quot;application must not be null&quot;);</span>
		}
<span class="nc" id="L97">		this.application = application;</span>
<span class="nc" id="L98">	}</span>

	/**
	 * To free some memory, close all SQL result-tabs of all current sessions.
	 * This may free some memory.
	 * @see net.sourceforge.squirrel_sql.client.IOutOfMemoryErrorHandler#handleOutOfMemoryError()
	 */
	public synchronized void handleOutOfMemoryError() {

<span class="nc" id="L107">		SessionManager sessionManager = application.getSessionManager();</span>

		// All sessions, the user has opened
<span class="nc" id="L110">		ISession[] sessions = sessionManager.getConnectedSessions();</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (sessions.length != 0) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">			for (ISession session : sessions) {</span>
<span class="nc" id="L114">				closeResultTabs(session);</span>
			}
<span class="nc" id="L116">			showMessage(sessionManager);</span>
		} else {
<span class="nc" id="L118">			log.info(&quot;A OutOfMemoryError occured, but there are no sessions connected - so we cann't free memory.&quot;);</span>
		}

<span class="nc" id="L121">	}</span>

	/**
	 * Inform the user, that a {@link OutOfMemoryError} had occurred.
	 * 
	 * @param sessionManager
	 *            the sessionManager
	 */
	private void showMessage(SessionManager sessionManager) {
<span class="nc" id="L130">		ISession activeSession = sessionManager.getActiveSession();</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">		if (activeSession != null) {</span>
<span class="nc" id="L132">			log.info(i18n.message);</span>
<span class="nc" id="L133">			activeSession.showErrorMessage(i18n.message);</span>
<span class="nc" id="L134">			application.showErrorDialog(i18n.message);</span>
		} else {
<span class="nc" id="L136">			log.info(&quot;A OutOfMemoryError occured, but there are no active session!&quot;);</span>
		}
<span class="nc" id="L138">	}</span>

	/**
	 * Close all result tabs of the session.
	 * 
	 * @param session
	 *            the session, where to close the result tabs.
	 */
	private void closeResultTabs(ISession session) {
<span class="nc" id="L147">		session.getSessionInternalFrame().getSQLPanelAPI().closeAllSQLResultTabs();</span>
<span class="nc" id="L148">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>