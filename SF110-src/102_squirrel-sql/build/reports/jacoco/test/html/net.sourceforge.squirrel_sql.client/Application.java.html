<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Application.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client</a> &gt; <span class="el_source">Application.java</span></div><h1>Application.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client;

/*
 * TODO: finish i18n
 */

/*
 * Copyright (C) 2001-2006 Colin Bell
 * colbell@users.sourceforge.net
 *
 * Modifications Copyright (C) 2003-2004 Jason Height
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.io.*;
import java.sql.DriverManager;
import java.util.*;

import javax.swing.Action;
import javax.swing.JComponent;
import javax.swing.JMenu;
import javax.swing.JOptionPane;
import javax.swing.PopupFactory;
import javax.swing.ToolTipManager;
import javax.swing.UIManager;
import javax.swing.plaf.metal.MetalLookAndFeel;

import org.apache.commons.lang.StringUtils;

import net.sourceforge.squirrel_sql.client.action.ActionCollection;
import net.sourceforge.squirrel_sql.client.gui.FileViewerFactory;
import net.sourceforge.squirrel_sql.client.gui.SquirrelSplashScreen;
import net.sourceforge.squirrel_sql.client.gui.WindowManager;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.DesktopStyle;
import net.sourceforge.squirrel_sql.client.gui.builders.UIFactory;
import net.sourceforge.squirrel_sql.client.gui.db.DataCache;
import net.sourceforge.squirrel_sql.client.gui.laf.AllBluesBoldMetalTheme;
import net.sourceforge.squirrel_sql.client.gui.mainframe.MainFrame;
import net.sourceforge.squirrel_sql.client.mainframe.action.ConnectToStartupAliasesCommand;
import net.sourceforge.squirrel_sql.client.mainframe.action.ViewHelpCommand;
import net.sourceforge.squirrel_sql.client.plugin.IPlugin;
import net.sourceforge.squirrel_sql.client.plugin.IPluginManager;
import net.sourceforge.squirrel_sql.client.plugin.PluginLoadInfo;
import net.sourceforge.squirrel_sql.client.plugin.PluginManager;
import net.sourceforge.squirrel_sql.client.preferences.PreferenceType;
import net.sourceforge.squirrel_sql.client.preferences.SquirrelPreferences;
import net.sourceforge.squirrel_sql.client.resources.SquirrelResources;
import net.sourceforge.squirrel_sql.client.session.DefaultSQLEntryPanelFactory;
import net.sourceforge.squirrel_sql.client.session.ISQLEntryPanelFactory;
import net.sourceforge.squirrel_sql.client.session.SessionManager;
import net.sourceforge.squirrel_sql.client.session.mainpanel.SQLHistory;
import net.sourceforge.squirrel_sql.client.session.mainpanel.SQLHistoryItem;
import net.sourceforge.squirrel_sql.client.session.properties.EditWhereCols;
import net.sourceforge.squirrel_sql.client.session.schemainfo.SchemaInfoCacheSerializer;
import net.sourceforge.squirrel_sql.client.update.autocheck.UpdateCheckTimer;
import net.sourceforge.squirrel_sql.client.update.autocheck.UpdateCheckTimerImpl;
import net.sourceforge.squirrel_sql.client.update.gui.installer.PreLaunchHelper;
import net.sourceforge.squirrel_sql.client.update.gui.installer.PreLaunchHelperFactory;
import net.sourceforge.squirrel_sql.client.update.gui.installer.PreLaunchHelperFactoryImpl;
import net.sourceforge.squirrel_sql.client.util.ApplicationFiles;
import net.sourceforge.squirrel_sql.fw.datasetviewer.CellImportExportInfoSaver;
import net.sourceforge.squirrel_sql.fw.datasetviewer.cellcomponent.DTProperties;
import net.sourceforge.squirrel_sql.fw.gui.ErrorDialog;
import net.sourceforge.squirrel_sql.fw.gui.action.wikiTable.IWikiTableConfigurationFactory;
import net.sourceforge.squirrel_sql.fw.gui.action.wikiTable.WikiTableConfigurationFactory;
import net.sourceforge.squirrel_sql.fw.gui.action.wikiTable.WikiTableConfigurationStorage;
import net.sourceforge.squirrel_sql.fw.sql.SQLDriverManager;
import net.sourceforge.squirrel_sql.fw.util.BareBonesBrowserLaunch;
import net.sourceforge.squirrel_sql.fw.util.BaseException;
import net.sourceforge.squirrel_sql.fw.util.ClassLoaderListener;
import net.sourceforge.squirrel_sql.fw.util.IMessageHandler;
import net.sourceforge.squirrel_sql.fw.util.ProxyHandler;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.TaskThreadPool;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;
import net.sourceforge.squirrel_sql.fw.xml.XMLBeanReader;
import net.sourceforge.squirrel_sql.fw.xml.XMLBeanWriter;

/**
 * Defines the API to do callbacks on the application.
 * 
 * @author &lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 * @author Lynn Pye
 */
class Application implements IApplication
{	

	/** Logger for this class. */
<span class="nc" id="L105">	private static ILogger s_log = LoggerController.createLogger(Application.class);</span>

	/** Internationalized strings for this class. */
<span class="nc" id="L108">	private static final StringManager s_stringMgr = StringManagerFactory.getStringManager(Application.class);</span>

	private SquirrelPreferences _prefs;

   private DesktopStyle _desktopStyle;

	private SQLDriverManager _driverMgr;

	private DataCache _cache;

	private ActionCollection _actions;

	/** Applications main frame. */
	// private MainFrame _mainFrame;
	/** Object to manage plugins. */
	private IPluginManager _pluginManager;

<span class="nc" id="L125">	private final DummyAppPlugin _dummyPlugin = new DummyAppPlugin();</span>

	private SquirrelResources _resources;

	/** Thread pool for long running tasks. */
<span class="nc" id="L130">	private final TaskThreadPool _threadPool = new TaskThreadPool();</span>

	/** This object manages the open sessions. */
	private SessionManager _sessionManager;

	/** This object manages the windows for this application. */
	private WindowManager _windowManager;

	private LoggerController _loggerFactory;

	/** Factory used to create SQL entry panels. */
<span class="nc" id="L141">	private ISQLEntryPanelFactory _sqlEntryFactory = new DefaultSQLEntryPanelFactory();</span>

	/** Output stream for JDBC debug logging. */
	private PrintStream _jdbcDebugOutputStream;

	/** Output writer for JDBC debug logging. */
	private PrintWriter _jdbcDebugOutputWriter;

	/** Contains info about fonts for squirrel. */
<span class="nc" id="L150">	private final FontInfoStore _fontInfoStore = new FontInfoStore();</span>

	/** Application level SQL History. */
	private SQLHistory _sqlHistory;
	
	/**
	 * Configuration factory for WIKI tables.
	 */
<span class="nc" id="L158">	private IWikiTableConfigurationFactory wikiTableConfigFactory = WikiTableConfigurationFactory.getInstance();</span>

	/** Current type of JDBC debug logging that we are doing. */
<span class="nc" id="L161">	private int _jdbcDebugType = SquirrelPreferences.IJdbcDebugTypes.NONE;</span>

	/**
	 * contains info about files and directories used by the application.
	 */
<span class="nc" id="L166">	private ApplicationFiles _appFiles = null;</span>

<span class="nc" id="L168">	private EditWhereCols editWhereCols = new EditWhereCols();</span>

<span class="nc" id="L170">	private List&lt;ApplicationListener&gt; _listeners = new ArrayList&lt;ApplicationListener&gt;();</span>

<span class="nc" id="L172">	private UpdateCheckTimer updateCheckTimer = null; </span>
	
<span class="nc" id="L174">	private PreLaunchHelperFactory preLaunchHelperFactory = new PreLaunchHelperFactoryImpl();</span>
	
<span class="nc" id="L176">	private IShutdownTimer _shutdownTimer = new ShutdownTimer();</span>

<span class="nc" id="L178">   private MultipleWindowsHandler _multipleWindowsHandler = new MultipleWindowsHandler();</span>

   /**
	 * Default ctor.
	 */
	Application()
	{
<span class="nc" id="L185">		super();</span>
<span class="nc" id="L186">	}</span>

	/**
	 * Application is starting up.
	 */
	public void startup()
	{

<span class="nc" id="L194">		final ApplicationArguments args = ApplicationArguments.getInstance();</span>

		// Setup the applications Look and Feel.
<span class="nc" id="L197">		setupLookAndFeel(args);</span>

<span class="nc" id="L199">		editWhereCols.setApplication(this);</span>

		// TODO: Make properties file Application.properties so we can use class
		// name to generate properties file name.
<span class="nc" id="L203">		_resources = new SquirrelResources(SquirrelResources.BUNDLE_BASE_NAME);</span>
<span class="nc" id="L204">		_prefs = SquirrelPreferences.load();</span>
<span class="nc" id="L205">      _desktopStyle = new DesktopStyle(_prefs);</span>
<span class="nc" id="L206">		Locale.setDefault(constructPreferredLocale(_prefs));</span>
<span class="nc" id="L207">		preferencesHaveChanged(null);</span>
<span class="nc" id="L208">		_prefs.addPropertyChangeListener(new PropertyChangeListener()</span>
<span class="nc" id="L209">		{</span>
			public void propertyChange(PropertyChangeEvent evt)
			{
<span class="nc" id="L212">				preferencesHaveChanged(evt);</span>
<span class="nc" id="L213">			}</span>
		});

<span class="nc" id="L216">		SquirrelSplashScreen splash = null;</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">		if (args.getShowSplashScreen())</span>
		{
<span class="nc" id="L219">			splash = new SquirrelSplashScreen(_prefs, 17);</span>
		}

<span class="nc" id="L222">      executeStartupTasks(splash, args);</span>
<span class="nc" id="L223">	}</span>

	/**
	 * Application is shutting down.
	 */
	public boolean shutdown(boolean updateLaunchScript)
	{
<span class="nc" id="L230">		s_log.info(s_stringMgr.getString(&quot;Application.shutdown&quot;, Calendar.getInstance().getTime()));</span>

<span class="nc" id="L232">		updateCheckTimer.stop();</span>
		
<span class="nc" id="L234">		saveApplicationState();</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (!closeAllSessions()) { return false; }</span>
<span class="nc" id="L237">		_pluginManager.unloadPlugins();</span>

<span class="nc" id="L239">		closeAllViewers();</span>

<span class="nc" id="L241">		closeOutputStreams();</span>

<span class="nc" id="L243">		SchemaInfoCacheSerializer.waitTillStoringIsDone();</span>
		
<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (updateLaunchScript) {</span>
<span class="nc" id="L246">			updateLaunchScript();</span>
		}

<span class="nc" id="L249">		String msg = s_stringMgr.getString(&quot;Application.shutdowncomplete&quot;, Calendar.getInstance().getTime());</span>
<span class="nc" id="L250">		s_log.info(msg);</span>
<span class="nc" id="L251">		LoggerController.shutdown();</span>

<span class="nc" id="L253">		return true;</span>
	}

	/**
	 * Saves off preferences and all state present in the application.
	 */
	public void saveApplicationState()
	{

<span class="nc" id="L262">		_prefs.setFirstRun(false);</span>

<span class="nc bnc" id="L264" title="All 2 branches missed.">		for (ApplicationListener l : _listeners.toArray(new ApplicationListener[0]))</span>
		{
<span class="nc" id="L266">			l.saveApplicationState();</span>
		}

<span class="nc" id="L269">		saveDrivers();</span>

<span class="nc" id="L271">		saveAliases();</span>

		// Save Application level SQL history.
<span class="nc" id="L274">		saveSQLHistory();</span>

		// Save options selected for Cell Import Export operations
<span class="nc" id="L277">		saveCellImportExportInfo();</span>

		// Save options selected for Edit Where Columns
<span class="nc" id="L280">		saveEditWhereColsInfo();</span>

		// Save options selected for DataType-specific properties
<span class="nc" id="L283">		saveDataTypePreferences();</span>
		
		// Save user specific WIKI configurations
<span class="nc" id="L286">		saveUserSpecificWikiConfigurations();</span>

<span class="nc" id="L288">		_prefs.save();</span>
<span class="nc" id="L289">	}</span>

	/**
	 * Builds a Locale from the user's preferred locale preference.
	 * 
	 * @param prefs
	 *           the user's preferences
	 * @return a local object. If no preference is found then US English is the default.
	 */
	private Locale constructPreferredLocale(SquirrelPreferences prefs)
	{
<span class="nc" id="L300">		String langCountryPair = prefs.getPreferredLocale();</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">		if (StringUtils.isEmpty(langCountryPair))</span>
		{
<span class="nc" id="L303">			langCountryPair = &quot;en_US&quot;;</span>
		}
<span class="nc" id="L305">		String[] parts = langCountryPair.split(&quot;_&quot;);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (parts.length == 2) { return new Locale(parts[0], parts[1]); }</span>
<span class="nc" id="L307">		return new Locale(parts[0]);</span>
	}

	/**
     * 
     */
	private void closeOutputStreams()
	{
<span class="nc bnc" id="L315" title="All 2 branches missed.">		if (_jdbcDebugOutputStream != null)</span>
		{
<span class="nc" id="L317">			_jdbcDebugOutputStream.close();</span>
<span class="nc" id="L318">			_jdbcDebugOutputStream = null;</span>
		}

<span class="nc bnc" id="L321" title="All 2 branches missed.">		if (_jdbcDebugOutputWriter != null)</span>
		{
<span class="nc" id="L323">			_jdbcDebugOutputWriter.close();</span>
<span class="nc" id="L324">			_jdbcDebugOutputWriter = null;</span>
		}
<span class="nc" id="L326">	}</span>

	/**
	 * Saves alias definitions that are in memory to the aliases file.
	 */
	private void saveAliases()
	{
		try
		{
<span class="nc" id="L335">			final File file = _appFiles.getDatabaseAliasesFile();</span>
<span class="nc" id="L336">			_cache.saveAliases(file);</span>
		}
<span class="nc" id="L338">		catch (Throwable th)</span>
		{
<span class="nc" id="L340">			String thMsg = th.getMessage();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">			if (thMsg == null)</span>
			{
<span class="nc" id="L343">				thMsg = &quot;&quot;;</span>
			}
<span class="nc" id="L345">			String msg = s_stringMgr.getString(&quot;Application.error.aliassave&quot;, th.getMessage());</span>
<span class="nc" id="L346">			showErrorDialog(msg, th);</span>
<span class="nc" id="L347">			s_log.error(msg, th);</span>
<span class="nc" id="L348">		}</span>
<span class="nc" id="L349">	}</span>

	/**
	 * Saves the driver definitions that are in memory to the drivers file.
	 */
	private void saveDrivers()
	{
		try
		{
<span class="nc" id="L358">			final File file = _appFiles.getDatabaseDriversFile();</span>
<span class="nc" id="L359">			_cache.saveDrivers(file);</span>
		}
<span class="nc" id="L361">		catch (Throwable th)</span>
		{
<span class="nc" id="L363">			String msg = s_stringMgr.getString(&quot;Application.error.driversave&quot;, th.getMessage());</span>
<span class="nc" id="L364">			showErrorDialog(msg, th);</span>
<span class="nc" id="L365">			s_log.error(msg, th);</span>
<span class="nc" id="L366">		}</span>
<span class="nc" id="L367">	}</span>

	/**
     * 
     */
	private void closeAllViewers()
	{
		try
		{
<span class="nc" id="L376">			FileViewerFactory.getInstance().closeAllViewers();</span>
		}
<span class="nc" id="L378">		catch (Throwable t)</span>
		{
			// i18n[Application.error.closeFileViewers=Unable to close all file viewers]
<span class="nc" id="L381">			s_log.error(s_stringMgr.getString(&quot;Application.error.closeFileViewers&quot;), t);</span>
<span class="nc" id="L382">		}</span>
<span class="nc" id="L383">	}</span>

	/**
	 * Returns true is closing all sessions was successful.
	 * 
	 * @return
	 */
	private boolean closeAllSessions()
	{
<span class="nc" id="L392">		boolean result = false;</span>
		try
		{
<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (!_sessionManager.closeAllSessions())</span>
			{
<span class="nc" id="L397">				s_log.info(s_stringMgr.getString(&quot;Application.shutdownCancelled&quot;, Calendar.getInstance()</span>
<span class="nc" id="L398">					.getTime()));</span>
			}
			else
			{
<span class="nc" id="L402">				result = true;</span>
			}
		}
<span class="nc" id="L405">		catch (Throwable t)</span>
		{
<span class="nc" id="L407">			String msg = s_stringMgr.getString(&quot;Application.error.closeAllSessions&quot;, t.getMessage());</span>
<span class="nc" id="L408">			s_log.error(msg, t);</span>
<span class="nc" id="L409">		}</span>
<span class="nc" id="L410">		return result;</span>
	}

	/**
	 * Ideally, it would be unnecessary to update the launch script here.  Unfortunately, in squirrel-sql.sh
	 * due to a bug in how the updater's CLASSPATH is being built, the update application uses the old 
	 * application and library jars instead of the ones in the downloads section.  So, the new code that 
	 * fixes the launch scripts doesn't get executed until the second update.  Once that code is out there,
	 * ( that is, the 3.2 version has been released for a while, and we are pretty sure there are no older 
	 * 3.x installations that still need to be upgraded), then it would be safe to remove this code.
	 */
	private void updateLaunchScript() {
		try
		{
<span class="nc" id="L424">			PreLaunchHelper helper = preLaunchHelperFactory.createPreLaunchHelper();</span>
<span class="nc" id="L425">			helper.updateLaunchScript();</span>
<span class="nc" id="L426">			helper.copySplashImage();</span>
		}
<span class="nc" id="L428">		catch (Exception e)</span>
		{
<span class="nc" id="L430">			s_log.error(&quot;Unexpected exception while attempting to update the launch script: &quot;+e.getMessage(), e);</span>
<span class="nc" id="L431">		}		</span>
<span class="nc" id="L432">	}</span>
	
	public IPluginManager getPluginManager()
	{
<span class="nc" id="L436">		return _pluginManager;</span>
	}

	/**
	 * Return the manager responsible for windows.
	 * 
	 * @return the manager responsible for windows.
	 */
	public WindowManager getWindowManager()
	{
<span class="nc" id="L446">		return _windowManager;</span>
	}

	public ActionCollection getActionCollection()
	{
<span class="nc" id="L451">		return _actions;</span>
	}

	public SQLDriverManager getSQLDriverManager()
	{
<span class="nc" id="L456">		return _driverMgr;</span>
	}

	public DataCache getDataCache()
	{
<span class="nc" id="L461">		return _cache;</span>
	}

	public IPlugin getDummyAppPlugin()
	{
<span class="nc" id="L466">		return _dummyPlugin;</span>
	}

	public SquirrelResources getResources()
	{
<span class="nc" id="L471">		return _resources;</span>
	}

	public IMessageHandler getMessageHandler()
	{
<span class="nc" id="L476">		return getMainFrame().getMessagePanel();</span>
	}

	public SquirrelPreferences getSquirrelPreferences()
	{
<span class="nc" id="L481">		return _prefs;</span>
	}

   public DesktopStyle getDesktopStyle()
   {
<span class="nc" id="L486">      return _desktopStyle;</span>
   }

   public MainFrame getMainFrame()
	{
		// return _mainFrame;
<span class="nc" id="L492">		return _windowManager.getMainFrame();</span>
	}

	/**
	 * Retrieve the object that manages sessions.
	 * 
	 * @return &lt;TT&gt;SessionManager&lt;/TT&gt;.
	 */
	public SessionManager getSessionManager()
	{
<span class="nc" id="L502">		return _sessionManager;</span>
	}

	/**
	 * Display an error message dialog.
	 * 
	 * @param msg
	 *           The error msg.
	 */
	public void showErrorDialog(String msg)
	{
<span class="nc" id="L513">		s_log.error(msg);</span>
<span class="nc" id="L514">		new ErrorDialog(getMainFrame(), msg).setVisible(true);</span>
<span class="nc" id="L515">	}</span>

	/**
	 * Display an error message dialog.
	 * 
	 * @param th
	 *           The Throwable that caused the error
	 */
	public void showErrorDialog(Throwable th)
	{
<span class="nc" id="L525">		s_log.error(th);</span>
<span class="nc" id="L526">		new ErrorDialog(getMainFrame(), th).setVisible(true);</span>
<span class="nc" id="L527">	}</span>

	/**
	 * Display an error message dialog.
	 * 
	 * @param msg
	 *           The error msg.
	 * @param th
	 *           The Throwable that caused the error
	 */
	public void showErrorDialog(String msg, Throwable th)
	{
<span class="nc" id="L539">		s_log.error(msg, th);</span>
<span class="nc" id="L540">		new ErrorDialog(getMainFrame(), msg, th).setVisible(true);</span>
<span class="nc" id="L541">	}</span>

	/**
	 * Return the collection of &lt;TT&gt;FontInfo &lt;/TT&gt; objects for this app.
	 * 
	 * @return the collection of &lt;TT&gt;FontInfo &lt;/TT&gt; objects for this app.
	 */
	public FontInfoStore getFontInfoStore()
	{
<span class="nc" id="L550">		return _fontInfoStore;</span>
	}

	/**
	 * Return the thread pool for this app.
	 * 
	 * @return the thread pool for this app.
	 */
	public TaskThreadPool getThreadPool()
	{
<span class="nc" id="L560">		return _threadPool;</span>
	}

	public LoggerController getLoggerFactory()
	{
<span class="nc" id="L565">		return _loggerFactory;</span>
	}

	/**
	 * Return the factory object used to create the SQL entry panel.
	 * 
	 * @return the factory object used to create the SQL entry panel.
	 */
	public ISQLEntryPanelFactory getSQLEntryPanelFactory()
	{
<span class="nc" id="L575">		return _sqlEntryFactory;</span>
	}

	/**
	 * Set the factory object used to create the SQL entry panel.
	 * 
	 * @param factory
	 *           the factory object used to create the SQL entry panel.
	 */
	public void setSQLEntryPanelFactory(ISQLEntryPanelFactory factory)
	{
<span class="nc bnc" id="L586" title="All 2 branches missed.">		_sqlEntryFactory = factory != null ? factory : new DefaultSQLEntryPanelFactory();</span>
<span class="nc" id="L587">	}</span>

	/**
	 * Retrieve the application level SQL History object.
	 * 
	 * @return the application level SQL History object.
	 */
	public SQLHistory getSQLHistory()
	{
<span class="nc" id="L596">		return _sqlHistory;</span>
	}

	public synchronized void addToMenu(int menuId, JMenu menu)
	{
<span class="nc" id="L601">		final MainFrame mf = getMainFrame();</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">		if (mf != null)</span>
		{
<span class="nc" id="L604">			mf.addToMenu(menuId, menu);</span>
		}
		else
		{
<span class="nc" id="L608">			throw new IllegalStateException(s_stringMgr.getString(&quot;Application.error.menuadding&quot;));</span>
		}
<span class="nc" id="L610">	}</span>

	public synchronized void addToMenu(int menuId, Action action)
	{
<span class="nc" id="L614">		final MainFrame mf = getMainFrame();</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">		if (mf != null)</span>
		{
<span class="nc" id="L617">			mf.addToMenu(menuId, action);</span>
		}
		else
		{
<span class="nc" id="L621">			throw new IllegalStateException(s_stringMgr.getString(&quot;Application.error.menuadding&quot;));</span>
		}
<span class="nc" id="L623">	}</span>

	/**
	 * Add component to the main frames status bar.
	 * 
	 * @param comp
	 *           Component to add.
	 */
	public void addToStatusBar(JComponent comp)
	{
<span class="nc" id="L633">		final MainFrame mf = getMainFrame();</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">		if (mf != null)</span>
		{
<span class="nc" id="L636">			mf.addToStatusBar(comp);</span>
		}
		else
		{
<span class="nc" id="L640">			throw new IllegalStateException(s_stringMgr.getString(&quot;Application.error.compadding&quot;));</span>
		}
<span class="nc" id="L642">	}</span>

	/**
	 * Remove component to the main frames status bar.
	 * 
	 * @param comp
	 *           Component to remove.
	 */
	public void removeFromStatusBar(JComponent comp)
	{
<span class="nc" id="L652">		final MainFrame mf = getMainFrame();</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">		if (mf != null)</span>
		{
<span class="nc" id="L655">			mf.removeFromStatusBar(comp);</span>
		}
		else
		{
<span class="nc" id="L659">			throw new IllegalStateException(s_stringMgr.getString(&quot;Application.error.compremoving&quot;));</span>
		}
<span class="nc" id="L661">	}</span>

	/**
	 * Launches the specified url in the system default web-browser
	 * 
	 * @param url
	 *           the URL of the web page to display.
	 */
	public void openURL(String url)
	{
<span class="nc" id="L671">		BareBonesBrowserLaunch.openURL(url);</span>
<span class="nc" id="L672">	}</span>

	/**
	 * Execute the taks required to start SQuirreL. Each of these is displayed as a message on the splash
	 * screen (if one is being used) in order to let the user know what is happening.
	 * 
	 * @param splash
	 *           The splash screen (can be null).
	 * @param args
	 *           Application arguments.
	 * @throws IllegalArgumentException
	 *            Thrown if &lt;TT&gt;ApplicationArguments&lt;.TT&gt; is null.
	 */
	private void executeStartupTasks(SquirrelSplashScreen splash, ApplicationArguments args)
	{
<span class="nc bnc" id="L687" title="All 2 branches missed.">		if (args == null) { throw new IllegalArgumentException(&quot;ApplicationArguments == null&quot;); }</span>

<span class="nc" id="L689">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.createSessionManager&quot;));</span>
		// AliasMaintSheetFactory.initialize(this);
		// DriverMaintSheetFactory.initialize(this);
<span class="nc" id="L692">		_sessionManager = new SessionManager(this);</span>

<span class="nc" id="L694">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadingprefs&quot;));</span>

<span class="nc" id="L696">		final boolean loadPlugins = args.getLoadPlugins();</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">		if (loadPlugins)</span>
		{
<span class="nc" id="L699">			indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadingplugins&quot;));</span>
		}
		else
		{
<span class="nc" id="L703">			indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.notloadingplugins&quot;));</span>
		}

<span class="nc" id="L706">		UIFactory.initialize(_prefs, this);</span>
<span class="nc" id="L707">		_pluginManager = new PluginManager(this);</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">		if (args.getLoadPlugins())</span>
		{
<span class="nc bnc" id="L710" title="All 4 branches missed.">			if (null != splash &amp;&amp; _prefs.getShowPluginFilesInSplashScreen())</span>
			{
<span class="nc" id="L712">				ClassLoaderListener listener = splash.getClassLoaderListener();</span>
<span class="nc" id="L713">				_pluginManager.setClassLoaderListener(listener);</span>
			}
			
<span class="nc bnc" id="L716" title="All 2 branches missed.">			if (args.getPluginList() != null) {</span>
<span class="nc" id="L717">				_pluginManager.loadPluginsFromList(args.getPluginList());</span>
			} else {
<span class="nc" id="L719">				_pluginManager.loadPlugins();</span>
			}
		}

<span class="nc" id="L723">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadingactions&quot;));</span>
<span class="nc" id="L724">		_actions = new ActionCollection(this);</span>

<span class="nc" id="L726">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadinguseracc&quot;));</span>
<span class="nc" id="L727">		_actions.loadActionKeys(_prefs.getActionKeys());</span>

<span class="nc" id="L729">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.createjdbcmgr&quot;));</span>
<span class="nc" id="L730">		_driverMgr = new SQLDriverManager();</span>

		// TODO: pass in a message handler so user gets error msgs.
<span class="nc" id="L733">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadingjdbc&quot;));</span>
<span class="nc" id="L734">		_appFiles = new ApplicationFiles();</span>

<span class="nc" id="L736">		String errMsg = FileTransformer.transform(_appFiles);</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">		if (null != errMsg)</span>
		{
<span class="nc" id="L739">			System.err.println(errMsg);</span>
<span class="nc" id="L740">			JOptionPane.showMessageDialog(null, errMsg, &quot;SQuirreL failed to start&quot;, JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L741">			System.exit(-1);</span>
		}

<span class="nc" id="L744">		_cache =</span>
<span class="nc" id="L745">			new DataCache(_driverMgr, _appFiles.getDatabaseDriversFile(), _appFiles.getDatabaseAliasesFile(),</span>
<span class="nc" id="L746">				_resources.getDefaultDriversUrl(), this);</span>

<span class="nc" id="L748">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.createWindowManager&quot;));</span>
<span class="nc" id="L749">		_windowManager = new WindowManager(this, args.getUserInterfaceDebugEnabled());</span>

		// _mainFrame = new MainFrame(this);

<span class="nc" id="L753">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.uifactoryinit&quot;));</span>
		// AliasMaintSheetFactory.initialize(this);
		// DriverMaintSheetFactory.initialize(this);

<span class="nc" id="L757">		String initializingPlugins = s_stringMgr.getString(&quot;Application.splash.initializingplugins&quot;);</span>
<span class="nc" id="L758">		String notloadingplugins = s_stringMgr.getString(&quot;Application.splash.notloadingplugins&quot;);</span>
<span class="nc bnc" id="L759" title="All 2 branches missed.">		String task = (loadPlugins ? initializingPlugins : notloadingplugins);</span>
<span class="nc" id="L760">		indicateNewStartupTask(splash, task);</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">		if (loadPlugins)</span>
		{
<span class="nc" id="L763">			_pluginManager.initializePlugins();</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">			for (Iterator&lt;PluginLoadInfo&gt; it = _pluginManager.getPluginLoadInfoIterator(); it.hasNext();)</span>
			{
<span class="nc" id="L766">				PluginLoadInfo pli = it.next();</span>
<span class="nc" id="L767">				long created = pli.getCreationTime();</span>
<span class="nc" id="L768">				long load = pli.getLoadTime();</span>
<span class="nc" id="L769">				long init = pli.getInitializeTime();</span>
<span class="nc" id="L770">				Object[] params =</span>
<span class="nc" id="L771">					new Object[] { pli.getInternalName(), Long.valueOf(created), Long.valueOf(load),</span>
<span class="nc" id="L772">							Long.valueOf(init), Long.valueOf(created + load + init) };</span>
<span class="nc" id="L773">				String pluginLoadMsg = s_stringMgr.getString(&quot;Application.splash.loadplugintime&quot;, params);</span>
<span class="nc" id="L774">				s_log.info(pluginLoadMsg);</span>
<span class="nc" id="L775">			}</span>
		}

		// i18n[Application.splash.loadsqlhistory=Loading SQL history...]
<span class="nc" id="L779">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadsqlhistory&quot;));</span>
<span class="nc" id="L780">		loadSQLHistory();</span>

		// i18n[Application.splash.loadcellselections=Loading Cell Import/Export selections...]
<span class="nc" id="L783">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadcellselections&quot;));</span>
<span class="nc" id="L784">		loadCellImportExportInfo();</span>

		// i18n[Application.splash.loadeditselections=Loading Edit 'Where' Columns selections...]
<span class="nc" id="L787">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadeditselections&quot;));</span>
<span class="nc" id="L788">		loadEditWhereColsInfo();</span>

		// i18n[Application.splash.loaddatatypeprops=Loading Data Type Properties...]
<span class="nc" id="L791">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loaddatatypeprops&quot;));</span>
<span class="nc" id="L792">		loadDTProperties();</span>
		
		// i18n[Application.splash.loadsqlhistory=Loading user specific WIKI configurations...]
<span class="nc" id="L795">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.loadUserSpecificWikiConfiguration&quot;));</span>
<span class="nc" id="L796">		loadUserSpecificWikiTableConfigurations();</span>

		// i18n[Application.splash.showmainwindow=Showing main window...]
<span class="nc" id="L799">		indicateNewStartupTask(splash, s_stringMgr.getString(&quot;Application.splash.showmainwindow&quot;));</span>
<span class="nc" id="L800">		_windowManager.moveToFront(_windowManager.getMainFrame());</span>
<span class="nc" id="L801">		_threadPool.setParentForMessages(_windowManager.getMainFrame());</span>

		// _mainFrame.setVisible(true);
		// _mainFrame.toFront(); // Required on Linux

<span class="nc" id="L806">		new ConnectToStartupAliasesCommand(this).execute();</span>

<span class="nc bnc" id="L808" title="All 2 branches missed.">		if (_prefs.isFirstRun())</span>
		{
			try
			{
<span class="nc" id="L812">				new ViewHelpCommand(this).execute();</span>
			}
<span class="nc" id="L814">			catch (BaseException ex)</span>
			{
				// i18n[Application.error.showhelpwindow=Error showing help window]
<span class="nc" id="L817">				s_log.error(s_stringMgr.getString(&quot;Application.error.showhelpwindow&quot;), ex);</span>
<span class="nc" id="L818">			}</span>
		}
		
<span class="nc" id="L821">		updateCheckTimer = new UpdateCheckTimerImpl(this);</span>
<span class="nc" id="L822">		updateCheckTimer.start();</span>
		
<span class="nc bnc" id="L824" title="All 2 branches missed.">		if (args.getShutdownTimerSeconds() != null) {</span>
<span class="nc" id="L825">			_shutdownTimer.setShutdownSeconds(args.getShutdownTimerSeconds());</span>
<span class="nc" id="L826">			_shutdownTimer.setApplication(this);</span>
<span class="nc" id="L827">			_shutdownTimer.start();</span>
		}
<span class="nc" id="L829">	}</span>

	/**
	 * If we are running with a splash screen then indicate in the splash screen that a new task has commenced.
	 * 
	 * @param splash
	 *           Splash screen.
	 * @param taskDescription
	 *           Description of new task.
	 */
	private void indicateNewStartupTask(SquirrelSplashScreen splash, String taskDescription)
	{
<span class="nc bnc" id="L841" title="All 2 branches missed.">		if (splash != null)</span>
		{
<span class="nc" id="L843">			splash.indicateNewTask(taskDescription);</span>
		}
<span class="nc" id="L845">	}</span>

	private void preferencesHaveChanged(PropertyChangeEvent evt)
	{
<span class="nc bnc" id="L849" title="All 2 branches missed.">		final String propName = evt != null ? evt.getPropertyName() : null;</span>

<span class="nc bnc" id="L851" title="All 4 branches missed.">		if (propName == null || propName.equals(SquirrelPreferences.IPropertyNames.SHOW_TOOLTIPS))</span>
		{
<span class="nc" id="L853">			ToolTipManager.sharedInstance().setEnabled(_prefs.getShowToolTips());</span>
		}

<span class="nc bnc" id="L856" title="All 4 branches missed.">		if (propName == null || propName.equals(SquirrelPreferences.IPropertyNames.JDBC_DEBUG_TYPE))</span>
		{
<span class="nc" id="L858">			setupJDBCLogging();</span>
		}

<span class="nc bnc" id="L861" title="All 4 branches missed.">		if (propName == null || propName.equals(SquirrelPreferences.IPropertyNames.LOGIN_TIMEOUT))</span>
		{
<span class="nc" id="L863">			DriverManager.setLoginTimeout(_prefs.getLoginTimeout());</span>
		}

<span class="nc bnc" id="L866" title="All 4 branches missed.">		if (propName == null || propName == SquirrelPreferences.IPropertyNames.PROXY)</span>
		{
<span class="nc" id="L868">			new ProxyHandler().apply(_prefs.getProxySettings());</span>
		}
<span class="nc" id="L870">	}</span>

	/**
	 * Load application level SQL History for the current user.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	private void loadSQLHistory()
	{
		try
		{
<span class="nc" id="L880">			XMLBeanReader doc = new XMLBeanReader();</span>
<span class="nc" id="L881">			doc.load(new ApplicationFiles().getUserSQLHistoryFile());</span>
<span class="nc" id="L882">			Iterator it = doc.iterator();</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">			if (it.hasNext())</span>
			{
<span class="nc" id="L885">				_sqlHistory = (SQLHistory) it.next();</span>
			}
		}
<span class="nc" id="L888">		catch (FileNotFoundException ignore)</span>
		{
			// History file not found for user - first time user ran pgm.
		}
<span class="nc" id="L892">		catch (Exception ex)</span>
		{
			// i18n[Application.error.loadsqlhistory=Unable to load SQL history from persistant storage.]
<span class="nc" id="L895">			s_log.error(s_stringMgr.getString(&quot;Application.error.loadsqlhistory&quot;), ex);</span>
		}
		finally
		{
<span class="nc bnc" id="L899" title="All 2 branches missed.">			if (_sqlHistory == null)</span>
			{
<span class="nc" id="L901">				_sqlHistory = new SQLHistory();</span>
			}
		}
<span class="nc" id="L904">	}</span>
	
	/**
	 * Load the configurations for WIKI tables.
	 * @see WikiTableConfigurationStorage
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	private void loadUserSpecificWikiTableConfigurations()
	{
		try
		{
			WikiTableConfigurationStorage data;
			
<span class="nc" id="L917">			XMLBeanReader doc = new XMLBeanReader();</span>
<span class="nc" id="L918">			doc.load(new ApplicationFiles().getUserSpecificWikiConfigurationsFile());</span>
<span class="nc" id="L919">			Iterator it = doc.iterator();</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">			if (it.hasNext()){</span>
<span class="nc" id="L921">				data =   (WikiTableConfigurationStorage) it.next();</span>
<span class="nc" id="L922">				wikiTableConfigFactory.replaceUserSpecificConfigurations(data.configurationsAsList());</span>
			}
		}
<span class="nc" id="L925">		catch (FileNotFoundException ignore)</span>
		{
			// History file not found for user - first time user ran pgm.
		}
<span class="nc" id="L929">		catch (Exception ex)</span>
		{
			// i18n[Application.error.loadsqlhistory=Unable to load SQL history from persistant storage.]
<span class="nc" id="L932">			s_log.error(s_stringMgr.getString(&quot;Application.error.loadUserSpecificWikiConfiguration&quot;), ex);</span>
		}
		finally
		{
<span class="nc bnc" id="L936" title="All 2 branches missed.">			if (_sqlHistory == null)</span>
			{
<span class="nc" id="L938">				_sqlHistory = new SQLHistory();</span>
			}
		}
<span class="nc" id="L941">	}</span>

	/**
	 * Save application level SQL history for current user.
	 */
	private void saveSQLHistory()
	{
		// Get the history into an array.
		try
		{
<span class="nc bnc" id="L951" title="All 2 branches missed.">			if (_prefs.getSessionProperties().getLimitSQLEntryHistorySize())</span>
			{
<span class="nc" id="L953">				SQLHistoryItem[] data = _sqlHistory.getData();</span>

<span class="nc" id="L955">				int maxSize = _prefs.getSessionProperties().getSQLEntryHistorySize();</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">				if (data.length &gt; maxSize)</span>
				{
<span class="nc" id="L958">					SQLHistoryItem[] reducedData = new SQLHistoryItem[maxSize];</span>
<span class="nc" id="L959">					System.arraycopy(data, data.length - maxSize, reducedData, 0, maxSize);</span>
<span class="nc" id="L960">					_sqlHistory.setData(reducedData);</span>
				}
			}

<span class="nc" id="L964">			XMLBeanWriter wtr = new XMLBeanWriter(_sqlHistory);</span>
<span class="nc" id="L965">			wtr.save(new ApplicationFiles().getUserSQLHistoryFile());</span>
		}
<span class="nc" id="L967">		catch (Exception ex)</span>
		{
			// i18n[Application.error.savesqlhistory=Unable to write SQL queries to persistant storage.]
<span class="nc" id="L970">			s_log.error(s_stringMgr.getString(&quot;Application.error.savesqlhistory&quot;), ex);</span>
<span class="nc" id="L971">		}</span>
<span class="nc" id="L972">	}</span>
	
	/**
	 * Save user specific configurations for WIKI tables
	 */
	private void saveUserSpecificWikiConfigurations()
	{
		// Get the history into an array.
		try
		{
<span class="nc" id="L982">			WikiTableConfigurationStorage data = new WikiTableConfigurationStorage(wikiTableConfigFactory.getUserSpecificConfigurations());</span>
			
<span class="nc" id="L984">			XMLBeanWriter wtr = new XMLBeanWriter(data);</span>
<span class="nc" id="L985">			wtr.save(new ApplicationFiles().getUserSpecificWikiConfigurationsFile());</span>
		}
<span class="nc" id="L987">		catch (Exception ex)</span>
		{
<span class="nc" id="L989">			s_log.error(s_stringMgr.getString(&quot;Application.error.saveUserSpecificWikiConfiguration&quot;), ex);</span>
<span class="nc" id="L990">		}</span>
<span class="nc" id="L991">	}</span>

	/**
	 * Load the options previously selected by user for import/export of data in various Cells.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	private void loadCellImportExportInfo()
	{
<span class="nc" id="L999">		CellImportExportInfoSaver saverInstance = null;</span>
		try
		{
<span class="nc" id="L1002">			XMLBeanReader doc = new XMLBeanReader();</span>
<span class="nc" id="L1003">			doc.load(new ApplicationFiles().getCellImportExportSelectionsFile());</span>
<span class="nc" id="L1004">			Iterator it = doc.iterator();</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">			if (it.hasNext())</span>
			{
<span class="nc" id="L1007">				saverInstance = (CellImportExportInfoSaver) it.next();</span>
			}
		}
<span class="nc" id="L1010">		catch (FileNotFoundException ignore)</span>
		{
			// Cell Import/Export file not found for user - first time user ran pgm.
		}
<span class="nc" id="L1014">		catch (Exception ex)</span>
		{
			// i18n[Application.error.loadcellselections=Unable to load Cell Import/Export selections from
			// persistant storage.]
<span class="nc" id="L1018">			s_log.error(s_stringMgr.getString(&quot;Application.error.loadcellselections&quot;), ex);</span>
		}
		finally
		{
			// set the singleton instance of the Saver class to be the
			// instance just created by the XMLBeanReader
<span class="nc" id="L1024">			CellImportExportInfoSaver.setInstance(saverInstance);</span>
		}
<span class="nc" id="L1026">	}</span>

	/**
	 * Save the options selected by user for Cell Import Export.
	 */
	private void saveCellImportExportInfo()
	{
		try
		{
<span class="nc" id="L1035">			XMLBeanWriter wtr = new XMLBeanWriter(CellImportExportInfoSaver.getInstance());</span>
<span class="nc" id="L1036">			wtr.save(new ApplicationFiles().getCellImportExportSelectionsFile());</span>
		}
<span class="nc" id="L1038">		catch (Exception ex)</span>
		{
			// i18n[Application.error.writecellselections=Unable to write Cell Import/Export options to
			// persistant storage.]
<span class="nc" id="L1042">			s_log.error(s_stringMgr.getString(&quot;Application.error.writecellselections&quot;), ex);</span>
<span class="nc" id="L1043">		}</span>
<span class="nc" id="L1044">	}</span>

	/**
	 * Load the options previously selected by user for specific cols to use in WHERE clause when editing
	 * cells.
	 */
	@SuppressWarnings(&quot;all&quot;)
	private void loadEditWhereColsInfo()
	{

		try
		{
<span class="nc" id="L1056">			XMLBeanReader doc = new XMLBeanReader();</span>
<span class="nc" id="L1057">			doc.load(new ApplicationFiles().getEditWhereColsFile());</span>
<span class="nc" id="L1058">			Iterator it = doc.iterator();</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">			if (it.hasNext())</span>
			{
<span class="nc" id="L1061">				editWhereCols = (EditWhereCols) it.next();</span>
<span class="nc" id="L1062">				editWhereCols.setApplication(this);</span>
			}
		}
<span class="nc" id="L1065">		catch (FileNotFoundException ignore)</span>
		{
			// Cell Import/Export file not found for user - first time user ran pgm.
		}
<span class="nc" id="L1069">		catch (Exception ex)</span>
		{
			// i18n[Application.error.loadcolsinfo=Unable to load Edit 'Where' Columns selections.]
<span class="nc" id="L1072">			s_log.error(s_stringMgr.getString(&quot;Application.error.loadcolsinfo&quot;), ex);</span>
		}
		finally
<span class="nc" id="L1075">		{</span>
			// nothing needed here??
<span class="nc" id="L1077">		}</span>
<span class="nc" id="L1078">	}</span>

	/**
	 * Save the options selected by user for Cell Import Export.
	 */
	private void saveEditWhereColsInfo()
	{
		try
		{
<span class="nc" id="L1087">			XMLBeanWriter wtr = new XMLBeanWriter(editWhereCols);</span>
<span class="nc" id="L1088">			wtr.save(new ApplicationFiles().getEditWhereColsFile());</span>
		}
<span class="nc" id="L1090">		catch (Exception ex)</span>
		{
			// i18n[Application.error.savecolsinfo=Unable to write Edit Where Cols options to persistant
			// storage.]
<span class="nc" id="L1094">			s_log.error(s_stringMgr.getString(&quot;Application.error.savecolsinfo&quot;), ex);</span>
<span class="nc" id="L1095">		}</span>
<span class="nc" id="L1096">	}</span>

	/**
	 * Load the options previously selected by user for specific cols to use in WHERE clause when editing
	 * cells.
	 */
	@SuppressWarnings(&quot;all&quot;)
	private void loadDTProperties()
	{
<span class="nc" id="L1105">		DTProperties saverInstance = null;</span>
		try
		{
<span class="nc" id="L1108">			XMLBeanReader doc = new XMLBeanReader();</span>
<span class="nc" id="L1109">			doc.load(new ApplicationFiles().getDTPropertiesFile());</span>
<span class="nc" id="L1110">			Iterator&lt;Object&gt; it = doc.iterator();</span>
<span class="nc bnc" id="L1111" title="All 2 branches missed.">			if (it.hasNext())</span>
			{
<span class="nc" id="L1113">				saverInstance = (DTProperties) it.next();</span>
<span class="nc" id="L1114">				DTProperties x = saverInstance;</span>
			}
		}
<span class="nc" id="L1117">		catch (FileNotFoundException ignore)</span>
		{
			// Cell Import/Export file not found for user - first time user ran pgm.
		}
<span class="nc" id="L1121">		catch (Exception ex)</span>
		{
			// i18n[Application.error.loaddatatypeprops=Unable to load DataType Properties selections from
			// persistant storage.]
<span class="nc" id="L1125">			s_log.error(s_stringMgr.getString(&quot;Application.error.loaddatatypeprops&quot;), ex);</span>
		}
		finally
<span class="nc" id="L1128">		{</span>
			// nothing needed here??
<span class="nc" id="L1130">		}</span>
<span class="nc" id="L1131">	}</span>

	/**
	 * Save the options selected by user for Cell Import Export.
	 */
	private void saveDataTypePreferences()
	{
		try
		{
<span class="nc" id="L1140">			XMLBeanWriter wtr = new XMLBeanWriter(new DTProperties());</span>
<span class="nc" id="L1141">			wtr.save(new ApplicationFiles().getDTPropertiesFile());</span>
		}
<span class="nc" id="L1143">		catch (Exception ex)</span>
		{
			// i18n[Application.error.savedatatypeprops=Unable to write DataType properties to persistant
			// storage.]
<span class="nc" id="L1147">			s_log.error(s_stringMgr.getString(&quot;Application.error.savedatatypeprops&quot;), ex);</span>
<span class="nc" id="L1148">		}</span>
<span class="nc" id="L1149">	}</span>

	/**
	 * Persists the specified category of preferences to file if the user has the
	 * &quot;always save preferences immediately&quot; preference checked.
	 * 
	 * @param preferenceType
	 *           the enumerated type that indicates what category of preferences to be persisted.
	 */
	public void savePreferences(PreferenceType preferenceType)
	{
<span class="nc bnc" id="L1160" title="All 2 branches missed.">		if (!_prefs.getSavePreferencesImmediately()) { return; }</span>
<span class="nc bnc" id="L1161" title="All 8 branches missed.">		switch (preferenceType)</span>
		{
		case ALIAS_DEFINITIONS:
<span class="nc" id="L1164">			saveAliases();</span>
<span class="nc" id="L1165">			break;</span>
		case DRIVER_DEFINITIONS:
<span class="nc" id="L1167">			saveDrivers();</span>
<span class="nc" id="L1168">			break;</span>
		case DATATYPE_PREFERENCES:
<span class="nc" id="L1170">			saveDataTypePreferences();</span>
<span class="nc" id="L1171">			break;</span>
		case CELLIMPORTEXPORT_PREFERENCES:
<span class="nc" id="L1173">			saveCellImportExportInfo();</span>
<span class="nc" id="L1174">			break;</span>
		case SQLHISTORY:
<span class="nc" id="L1176">			saveSQLHistory();</span>
<span class="nc" id="L1177">			break;</span>
		case EDITWHERECOL_PREFERENCES:
<span class="nc" id="L1179">			saveEditWhereColsInfo();</span>
<span class="nc" id="L1180">			break;</span>
		case WIKI_CONFIGURATION:
<span class="nc" id="L1182">			saveUserSpecificWikiConfigurations();</span>
<span class="nc" id="L1183">			break;</span>
		default:
<span class="nc" id="L1185">			s_log.error(&quot;Unknown preference type: &quot; + preferenceType);</span>
		}
<span class="nc" id="L1187">	}</span>

	public void addApplicationListener(ApplicationListener l)
	{
<span class="nc" id="L1191">		_listeners.add(l);</span>
<span class="nc" id="L1192">	}</span>

	public void removeApplicationListener(ApplicationListener l)
	{
<span class="nc" id="L1196">		_listeners.remove(l);</span>
<span class="nc" id="L1197">	}</span>

	/**
	 * Setup applications Look and Feel.
	 */
	private void setupLookAndFeel(ApplicationArguments args)
	{
		/* 
		 * Don't prevent the user from overriding the laf is they choose to use 
		 * Swing's default laf prop 
		 */
<span class="nc" id="L1208">		String userSpecifiedOverride = System.getProperty(&quot;swing.defaultlaf&quot;);</span>
<span class="nc bnc" id="L1209" title="All 4 branches missed.">		if (userSpecifiedOverride != null &amp;&amp; !&quot;&quot;.equals(userSpecifiedOverride)) { return; }</span>

<span class="nc" id="L1211">		String lafClassName =</span>
<span class="nc bnc" id="L1212" title="All 2 branches missed.">			args.useNativeLAF() ? UIManager.getSystemLookAndFeelClassName() : MetalLookAndFeel.class.getName();</span>

<span class="nc bnc" id="L1214" title="All 2 branches missed.">		if (!args.useDefaultMetalTheme())</span>
		{
<span class="nc" id="L1216">			MetalLookAndFeel.setCurrentTheme(new AllBluesBoldMetalTheme());</span>
		}

		try
		{
			// The following is a work-around for the problem on Mac OS X where
			// the Apple LAF delegates to the Swing Popup factory but then
			// tries to set a 90% alpha on the underlying Cocoa window, which
			// will always be null if you're using JGoodies L&amp;F
			// see http://www.caimito.net/pebble/2005/07/26/1122392314480.html#comment1127522262179
			// This has no effect on Linux/Windows
<span class="nc" id="L1227">			PopupFactory.setSharedInstance(new PopupFactory());</span>

<span class="nc" id="L1229">			UIManager.setLookAndFeel(lafClassName);</span>
		}
<span class="nc" id="L1231">		catch (Exception ex)</span>
		{
			// i18n[Application.error.setlaf=Error setting LAF]
<span class="nc" id="L1234">			s_log.error(s_stringMgr.getString(&quot;Application.error.setlaf&quot;), ex);</span>
<span class="nc" id="L1235">		}</span>
<span class="nc" id="L1236">	}</span>

	@SuppressWarnings(&quot;deprecation&quot;)
	private void setupJDBCLogging()
	{
		// If logging has changed.
<span class="nc bnc" id="L1242" title="All 2 branches missed.">		if (_jdbcDebugType != _prefs.getJdbcDebugType())</span>
		{
<span class="nc" id="L1244">			final ApplicationFiles appFiles = new ApplicationFiles();</span>
<span class="nc" id="L1245">			final File outFile = appFiles.getJDBCDebugLogFile();</span>

			// Close any previous logging.
<span class="nc" id="L1248">			DriverManager.setLogStream(null);</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">			if (_jdbcDebugOutputStream != null)</span>
			{
<span class="nc" id="L1251">				_jdbcDebugOutputStream.close();</span>
<span class="nc" id="L1252">				_jdbcDebugOutputStream = null;</span>
			}
<span class="nc" id="L1254">			DriverManager.setLogWriter(null);</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">			if (_jdbcDebugOutputWriter != null)</span>
			{
<span class="nc" id="L1257">				_jdbcDebugOutputWriter.close();</span>
<span class="nc" id="L1258">				_jdbcDebugOutputWriter = null;</span>
			}

<span class="nc bnc" id="L1261" title="All 2 branches missed.">			if (_prefs.isJdbcDebugToStream())</span>
			{
				try
				{
					// i18n[Application.info.setjdbcdebuglog=Attempting to set JDBC debug log to output stream]
<span class="nc" id="L1266">					s_log.debug(s_stringMgr.getString(&quot;Application.info.setjdbcdebuglog&quot;));</span>
<span class="nc" id="L1267">					_jdbcDebugOutputStream = new PrintStream(new FileOutputStream(outFile));</span>
<span class="nc" id="L1268">					DriverManager.setLogStream(_jdbcDebugOutputStream);</span>
					// i18n[Application.info.setjdbcdebuglogsuccess=JDBC debug log set to output stream
					// successfully]
<span class="nc" id="L1271">					s_log.debug(s_stringMgr.getString(&quot;Application.info.setjdbcdebuglogsuccess&quot;));</span>
				}
<span class="nc" id="L1273">				catch (IOException ex)</span>
				{
<span class="nc" id="L1275">					final String msg = s_stringMgr.getString(&quot;Application.error.jdbcstream&quot;);</span>
<span class="nc" id="L1276">					s_log.error(msg, ex);</span>
<span class="nc" id="L1277">					showErrorDialog(msg, ex);</span>
<span class="nc" id="L1278">					DriverManager.setLogStream(System.out);</span>
<span class="nc" id="L1279">				}</span>
			}

<span class="nc bnc" id="L1282" title="All 2 branches missed.">			if (_prefs.isJdbcDebugToWriter())</span>
			{
				try
				{
					// i18n[Application.info.jdbcwriter=Attempting to set JDBC debug log to writer]
<span class="nc" id="L1287">					s_log.debug(s_stringMgr.getString(&quot;Application.info.jdbcwriter&quot;));</span>
<span class="nc" id="L1288">					_jdbcDebugOutputWriter = new PrintWriter(new FileWriter(outFile));</span>
<span class="nc" id="L1289">					DriverManager.setLogWriter(_jdbcDebugOutputWriter);</span>
					// i18n[Application.info.jdbcwritersuccess=JDBC debug log set to writer successfully]
<span class="nc" id="L1291">					s_log.debug(s_stringMgr.getString(&quot;Application.info.jdbcwritersuccess&quot;));</span>
				}
<span class="nc" id="L1293">				catch (IOException ex)</span>
				{
<span class="nc" id="L1295">					final String msg = s_stringMgr.getString(&quot;Application.error.jdbcwriter&quot;);</span>
<span class="nc" id="L1296">					s_log.error(msg, ex);</span>
<span class="nc" id="L1297">					showErrorDialog(msg, ex);</span>
<span class="nc" id="L1298">					DriverManager.setLogWriter(new PrintWriter(System.out));</span>
<span class="nc" id="L1299">				}</span>
			}

<span class="nc" id="L1302">			_jdbcDebugType = _prefs.getJdbcDebugType();</span>
		}
<span class="nc" id="L1304">	}</span>
	
	public void setUpdateCheckTimer(UpdateCheckTimer timer) {
<span class="nc" id="L1307">		this.updateCheckTimer = timer;</span>
<span class="nc" id="L1308">	}</span>
	
	public void setPreLaunchHelperFactory(PreLaunchHelperFactory preLaunchHelperFactory)
	{
<span class="nc" id="L1312">		this.preLaunchHelperFactory = preLaunchHelperFactory;</span>
<span class="nc" id="L1313">	}</span>

	/**
	 * @param shutdownTimer the _shutdownTimer to set
	 */
	public void setShutdownTimer(IShutdownTimer shutdownTimer)
	{
<span class="nc" id="L1320">		_shutdownTimer = shutdownTimer;</span>
<span class="nc" id="L1321">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.client.IApplication#getWikiTableConfigFactory()
	 */
	@Override
	public IWikiTableConfigurationFactory getWikiTableConfigFactory() {
<span class="nc" id="L1328">		return wikiTableConfigFactory;</span>
	}


   public void setWikiTableConfigFactory(IWikiTableConfigurationFactory wikiTableConfigFactory) {
<span class="nc" id="L1333">		this.wikiTableConfigFactory = wikiTableConfigFactory;</span>
<span class="nc" id="L1334">	}</span>

   @Override
   public MultipleWindowsHandler getMultipleWindowsHandler()
   {
<span class="nc" id="L1339">      return _multipleWindowsHandler;</span>
   }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>