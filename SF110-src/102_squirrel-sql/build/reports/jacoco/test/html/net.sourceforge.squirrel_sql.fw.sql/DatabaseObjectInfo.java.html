<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseObjectInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.fw.sql</a> &gt; <span class="el_source">DatabaseObjectInfo.java</span></div><h1>DatabaseObjectInfo.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.fw.sql;
/*
 * Copyright (C) 2001-2004 Colin Bell
 * colbell@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.io.Serializable;
import java.sql.SQLException;

import net.sourceforge.squirrel_sql.fw.dialects.DialectFactory;

import org.apache.commons.lang.StringUtils;

public class DatabaseObjectInfo implements IDatabaseObjectInfo, Serializable
{
   /** Property names for this bean. */
   public interface IPropertyNames
   {
      /** Catalog name. */
      String CATALOG_NAME = &quot;catalogName&quot;;

      /** Schema name. */
      String SCHEMA_NAME = &quot;schemaName&quot;;

      /** Simple name. */
      String SIMPLE_NAME = &quot;simpleName&quot;;

      /** Qualified name. */
      String QUALIFIED_NAME = &quot;qualifiedName&quot;;
   }


/** Catalog name. Can be &lt;CODE&gt;null&lt;/CODE&gt; */
   private final String _catalog;

   /** Schema name. Can be &lt;CODE&gt;null&lt;/CODE&gt; */
   private final String _schema;

   /** Simple object name. */
   private final String _simpleName;

   /** Fully qualified name for this object. */
   private final String _qualifiedName;

   /** Object type. @see DatabaseObjectType.*/
<span class="nc" id="L59">   private DatabaseObjectType _dboType = DatabaseObjectType.OTHER;</span>

   public DatabaseObjectInfo(String catalog, String schema, String simpleName,
                             DatabaseObjectType dboType, ISQLDatabaseMetaData md)
   {
<span class="nc" id="L64">      super();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">      if (dboType == null)</span>
      {
<span class="nc" id="L67">         throw new IllegalArgumentException(&quot;DatabaseObjectType == null&quot;);</span>
      }
<span class="nc bnc" id="L69" title="All 2 branches missed.">      if (md == null)</span>
      {
<span class="nc" id="L71">         throw new IllegalArgumentException(&quot;SQLDatabaseMetaData == null&quot;);</span>
      }

<span class="nc" id="L74">      _catalog = catalog;</span>
<span class="nc" id="L75">      _schema = schema;</span>
<span class="nc" id="L76">      _simpleName = simpleName;</span>
<span class="nc" id="L77">      _qualifiedName = generateQualifiedName(md);</span>
<span class="nc" id="L78">      _dboType = dboType;</span>
<span class="nc" id="L79">   }</span>

   /**
    * Default constructor for using instances of this class to contain 
    * information about new objects that will be created soon.
    */
<span class="nc" id="L85">   public DatabaseObjectInfo(String catalog, String schema, String simpleName) {</span>
<span class="nc" id="L86">       _catalog = catalog;</span>
<span class="nc" id="L87">       _schema = schema;</span>
<span class="nc" id="L88">       _simpleName = simpleName;</span>
<span class="nc" id="L89">       _qualifiedName = simpleName;</span>
<span class="nc" id="L90">   }</span>
   
   public String toString()
   {
<span class="nc" id="L94">      return getSimpleName();</span>
   }

   public String getCatalogName()
   {
<span class="nc" id="L99">      return _catalog;</span>
   }


   public String getSchemaName()
   {
<span class="nc" id="L105">      return _schema;</span>
   }

   public String getSimpleName()
   {
<span class="nc" id="L110">      return _simpleName;</span>
   }

   public String getQualifiedName()
   {
<span class="nc" id="L115">      return _qualifiedName;</span>
   }

   public DatabaseObjectType getDatabaseObjectType()
   {
<span class="nc" id="L120">      return _dboType;</span>
   }

   protected String generateQualifiedName(ISQLConnection conn)
   {
<span class="nc" id="L125">      return generateQualifiedName(conn.getSQLMetaData());</span>
   }
   
   /**
    * Informix represents database objects in catalogs *and* schemas.  So a table
    * called &lt;table&gt; might be found in the &lt;databasename&gt; catalog, which lives in 
    * the &lt;schemaname&gt; schema and is addressed as:
    * 
    * &lt;databasename&gt;:&quot;&lt;schemaname&gt;&quot;.&lt;table&gt;
    * 
    * It may also be referred to as simply &lt;table&gt;
    * 
    * This method returns a qualifed name that meets this criteria. 
    * 
    * @return a valid Informix qualified name - if catalog *and* schema are not
    *         null/empty, this returns the database object name such as
    *         catalog:schema.simpleName.  However, if either catalog or schema
    *         (or both) are null, this simply returns the simpleName
    */
   private String getInformixQualifiedName() {
<span class="nc" id="L145">       StringBuilder result = new StringBuilder();</span>
<span class="nc bnc" id="L146" title="All 4 branches missed.">       if (_catalog != null &amp;&amp; _schema != null) {</span>
<span class="nc" id="L147">           result.append(_catalog);</span>
<span class="nc" id="L148">           result.append(&quot;:&quot;);</span>
<span class="nc" id="L149">           result.append(&quot;\&quot;&quot;);</span>
<span class="nc" id="L150">           result.append(_schema);</span>
<span class="nc" id="L151">           result.append(&quot;\&quot;&quot;);</span>
<span class="nc" id="L152">           result.append(&quot;.&quot;);</span>
       }
<span class="nc" id="L154">       result.append(_simpleName);</span>
<span class="nc" id="L155">       return result.toString();</span>
   }
   
   private String getProgressQualifiedName() {
<span class="nc" id="L159">   	StringBuilder result = new StringBuilder();</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">   	if (_schema != null) {</span>
<span class="nc" id="L161">   		result.append(_schema);</span>
<span class="nc" id="L162">   		result.append(&quot;.&quot;);</span>
   	}
<span class="nc" id="L164">   	result.append(_simpleName);</span>
<span class="nc" id="L165">   	return result.toString();</span>
   }
   
   /**
    * Generates the qualified name (for example, &quot;SCHEMA.SIMPLENAME&quot;).  This is highly database specific and
    * should probably be moved into the dialects.
    *   
    * @TODO Break out the dialect-specific logic into the dialects.  Allow for the default parts of the 
    * algorithm below to be used when a dialect is unavailable.  
    *   
    * @param md
    * @return
    */
   protected String generateQualifiedName(final ISQLDatabaseMetaData md)
   {   	
<span class="nc" id="L180">      String catSep = null;</span>
<span class="nc" id="L181">      String identifierQuoteString = null;</span>
<span class="nc" id="L182">      boolean supportsSchemasInDataManipulation = false;</span>
<span class="nc" id="L183">      boolean supportsCatalogsInDataManipulation = false;</span>
<span class="nc" id="L184">      boolean supportsSchemasInTableDefinitions = false;</span>

      // check for Informix - it has very &quot;special&quot; qualified names
<span class="nc bnc" id="L187" title="All 2 branches missed.">      if (DialectFactory.isInformix(md)) {</span>
<span class="nc" id="L188">          return getInformixQualifiedName();</span>
      }
      // Progress claims to support catalogs in data manip - but it actually doesn't honor that claim. 
<span class="nc bnc" id="L191" title="All 2 branches missed.">      if (DialectFactory.isProgress(md)) {</span>
<span class="nc" id="L192">      	return getProgressQualifiedName();</span>
      }
      
      try
      {
<span class="nc" id="L197">         supportsSchemasInDataManipulation = md.supportsSchemasInDataManipulation();</span>
      }
<span class="nc" id="L199">      catch (SQLException ignore)</span>
      {
         // Ignore.
<span class="nc" id="L202">      }</span>
      try
      {
<span class="nc" id="L205">          supportsCatalogsInDataManipulation = md.supportsCatalogsInDataManipulation();</span>
      }
<span class="nc" id="L207">      catch (SQLException ignore)</span>
      {
         // Ignore.
<span class="nc" id="L210">      }</span>
      
      try
		{
<span class="nc" id="L214">			supportsSchemasInTableDefinitions = md.supportsSchemasInTableDefinitions();</span>
<span class="nc" id="L215">		} catch (SQLException ignore)</span>
		{
			// Ignore.
<span class="nc" id="L218">		}</span>
      
      try
      {
<span class="nc" id="L222">      	catSep = md.getCatalogSeparator();</span>
      }
<span class="nc" id="L224">      catch (SQLException ignore)</span>
      {
         // Ignore.
<span class="nc" id="L227">      }</span>
      
      
<span class="nc bnc" id="L230" title="All 2 branches missed.">      if (StringUtils.isEmpty(catSep))</span>
      {
<span class="nc" id="L232">          catSep = &quot;.&quot;;</span>
      }
    		  
      try
      {
<span class="nc" id="L237">         identifierQuoteString = md.getIdentifierQuoteString();</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">         if (identifierQuoteString != null</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">            &amp;&amp; identifierQuoteString.equals(&quot; &quot;))</span>
         {
<span class="nc" id="L241">            identifierQuoteString = null;</span>
         }
      }
<span class="nc" id="L244">      catch (SQLException ignore)</span>
      {
         // Ignore.
<span class="nc" id="L247">      }</span>

<span class="nc bnc" id="L249" title="All 2 branches missed.">      if (DialectFactory.isSyBase(md)) {</span>
<span class="nc" id="L250">         identifierQuoteString = </span>
<span class="nc" id="L251">            checkSybaseIdentifierQuoteString(md, identifierQuoteString);         </span>
      }
                  
<span class="nc" id="L254">      StringBuilder buf = new StringBuilder();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">      if (supportsCatalogsInDataManipulation</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            &amp;&amp; !StringUtils.isEmpty(_catalog))	  </span>
      {
<span class="nc bnc" id="L258" title="All 2 branches missed.">         if (identifierQuoteString != null)</span>
         {
<span class="nc" id="L260">            buf.append(identifierQuoteString);</span>
         }
<span class="nc" id="L262">         buf.append(_catalog);</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">         if (identifierQuoteString != null)</span>
         {
<span class="nc" id="L265">            buf.append(identifierQuoteString);</span>
         }
<span class="nc" id="L267">         buf.append(catSep);</span>
      }

<span class="nc bnc" id="L270" title="All 2 branches missed.">      if (shouldQualifyWithSchema(supportsSchemasInDataManipulation, supportsSchemasInTableDefinitions, md))</span>
		{
<span class="nc bnc" id="L272" title="All 2 branches missed.">         if (identifierQuoteString != null)</span>
         {
<span class="nc" id="L274">            buf.append(identifierQuoteString);</span>
         }
<span class="nc" id="L276">         buf.append(_schema);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">         if (identifierQuoteString != null)</span>
         {
<span class="nc" id="L279">            buf.append(identifierQuoteString);</span>
         }
         
<span class="nc" id="L282">         buf.append(catSep);</span>
      }

<span class="nc bnc" id="L285" title="All 2 branches missed.">      if (identifierQuoteString != null)</span>
      {
<span class="nc" id="L287">         buf.append(identifierQuoteString);</span>
      }
<span class="nc" id="L289">      String quoteExpandedName = SQLUtilities.quoteIdentifier(_simpleName);</span>
<span class="nc" id="L290">      buf.append(quoteExpandedName);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">      if (identifierQuoteString != null)</span>
      {
<span class="nc" id="L293">         buf.append(identifierQuoteString);</span>
      }
<span class="nc" id="L295">      return buf.toString();</span>
   }

   private boolean shouldQualifyWithSchema(final boolean supportsSchemasInDataManipulation, final boolean supportsSchemasInTableDefinitions,
   	final ISQLDatabaseMetaData md) {
   	
<span class="nc bnc" id="L301" title="All 4 branches missed.">   	if (_schema == null || _schema.length() == 0) {</span>
<span class="nc" id="L302">   		return false;</span>
   	}
<span class="nc bnc" id="L304" title="All 2 branches missed.">   	if (supportsSchemasInDataManipulation) {</span>
<span class="nc" id="L305">   		return true;</span>
   	}
<span class="nc bnc" id="L307" title="All 2 branches missed.">   	if (this._dboType == DatabaseObjectType.TABLE) {</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">	   	if (supportsSchemasInTableDefinitions) {</span>
<span class="nc" id="L309">	   		return true;</span>
	   	}
   	}
   	// Always qualify table name for HSQL - Bug 1596240 HSQLDB-&gt;Objects-&gt;Content.  Cannot detect if table
   	// like above, since objects in HSQLDB's INFORMATION_SCHEMA under &quot;SYSTEM TABLE&quot; node have a database 
   	// object type of &quot;OTHER&quot;, instead of &quot;TABLE&quot;.
   	//
<span class="nc bnc" id="L316" title="All 2 branches missed.">   	if (DialectFactory.isHSQL(md)) {</span>
<span class="nc" id="L317">   		return true;</span>
   	}
<span class="nc" id="L319">   	return false;</span>
   }
   
   /**
    * Checks for the presence of Sybase 12.x and if found, sets the identifier
    * quote string to empty string.  See bug:
    * 
    * [ 1848924 ] Sybase object browser contents not displayed
    * 
    * for more details.
    * 
    * @param md the database metadata
    * @param quoteString the identifer quote string that the driver reported.
    * @return the same identifier quote string specified if not 12.x; otherwise
    *         empty string is returned.
    */
   private String checkSybaseIdentifierQuoteString(
         final ISQLDatabaseMetaData md, final String quoteString) 
   {
<span class="nc" id="L338">      String result = quoteString;</span>
<span class="nc" id="L339">      String productName = null;</span>
<span class="nc" id="L340">      CharSequence sybaseTwelveVersionId = &quot;12.&quot;;</span>
      try {
<span class="nc" id="L342">         productName = md.getDatabaseProductVersion();</span>
<span class="nc" id="L343">      } catch (SQLException e) {</span>
         // ignore
<span class="nc" id="L345">      }</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">      if (productName != null) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">         if (productName.contains(sybaseTwelveVersionId)) {</span>
<span class="nc" id="L348">            result = &quot;&quot;;</span>
         }
      }
<span class="nc" id="L351">      return result;</span>
   }
   
   public boolean equals(Object obj)
   {
<span class="nc bnc" id="L356" title="All 2 branches missed.">      if (obj == null) {</span>
<span class="nc" id="L357">          return false;</span>
      }
<span class="nc bnc" id="L359" title="All 2 branches missed.">      if (obj.getClass() == this.getClass())</span>
      {
<span class="nc" id="L361">         DatabaseObjectInfo info = (DatabaseObjectInfo) obj;</span>
<span class="nc bnc" id="L362" title="All 8 branches missed.">         if ((info._catalog == null &amp;&amp; _catalog == null)</span>
            || ((info._catalog != null &amp;&amp; _catalog != null)
<span class="nc bnc" id="L364" title="All 2 branches missed.">               &amp;&amp; info._catalog.equals(_catalog)))</span>
         {
<span class="nc bnc" id="L366" title="All 8 branches missed.">            if ((info._qualifiedName == null &amp;&amp; _qualifiedName == null)</span>
               || ((info._qualifiedName != null &amp;&amp; _qualifiedName != null)
<span class="nc bnc" id="L368" title="All 2 branches missed.">                  &amp;&amp; info._qualifiedName.equals(_qualifiedName)))</span>
            {
<span class="nc bnc" id="L370" title="All 8 branches missed.">               if ((info._schema == null &amp;&amp; _schema == null)</span>
                  || ((info._schema != null &amp;&amp; _schema != null)
<span class="nc bnc" id="L372" title="All 2 branches missed.">                     &amp;&amp; info._schema.equals(_schema)))</span>
               {
<span class="nc bnc" id="L374" title="All 8 branches missed.">                  return (</span>
                     (info._simpleName == null &amp;&amp; _simpleName == null)
                        || ((info._simpleName != null
                           &amp;&amp; _simpleName != null)
<span class="nc bnc" id="L378" title="All 2 branches missed.">                           &amp;&amp; info._simpleName.equals(_simpleName)));</span>
               }

            }
         }
      }
<span class="nc" id="L384">      return false;</span>
   }

   public int hashCode()
   {
<span class="nc" id="L389">      return _qualifiedName.hashCode();</span>
   }

   public int compareTo(IDatabaseObjectInfo o)
   {
<span class="nc" id="L394">      return _qualifiedName.compareTo(o.getQualifiedName());</span>
   }

   public void replaceDatabaseObjectTypeConstantObjectsByConstantObjectsOfThisVM(DatabaseObjectType type)
   {
<span class="nc" id="L399">      _dboType = type;</span>
<span class="nc" id="L400">   }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>