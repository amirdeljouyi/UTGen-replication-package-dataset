<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConnectionInternalFrame.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.gui.db</a> &gt; <span class="el_source">ConnectionInternalFrame.java</span></div><h1>ConnectionInternalFrame.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.gui.db;
/*
 * Copyright (C) 2001-2004 Colin Bell and Johan Compagner
 * colbell@users.sourceforge.net
 * jcompagner@j-com.nl
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import com.jgoodies.forms.builder.PanelBuilder;
import com.jgoodies.forms.layout.CellConstraints;
import com.jgoodies.forms.layout.FormLayout;
import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.resources.SquirrelResources;
import net.sourceforge.squirrel_sql.client.gui.IOkClosePanelListener;
import net.sourceforge.squirrel_sql.client.gui.OkClosePanel;
import net.sourceforge.squirrel_sql.client.gui.OkClosePanelEvent;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.DialogWidget;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.WidgetListener;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.WidgetAdapter;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.WidgetEvent;
import net.sourceforge.squirrel_sql.client.mainframe.action.AliasPropertiesCommand;
import net.sourceforge.squirrel_sql.fw.gui.GUIUtils;
import net.sourceforge.squirrel_sql.fw.gui.StatusBar;
import net.sourceforge.squirrel_sql.fw.sql.ISQLAlias;
import net.sourceforge.squirrel_sql.fw.sql.ISQLDriver;
import net.sourceforge.squirrel_sql.fw.sql.SQLDriverPropertyCollection;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

import javax.swing.*;
import javax.swing.event.InternalFrameAdapter;
import javax.swing.event.InternalFrameEvent;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
/**
 * This internal frame allows the user to connect to an alias.
 *
 * @author &lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 */
public class ConnectionInternalFrame extends DialogWidget
{
	/** Handler called for internal frame actions. */
	public interface IHandler
	{
		/**
		 * User has clicked the OK button to connect to the alias.
		 *
		 * @param	connSheet	The connection internal frame.
		 * @param	user		The user name entered.
		 * @param	password	The password entered.
		 * @param	props		SQLDriverPropertyCollection to connect with.
		 */
		public void performOK(ConnectionInternalFrame connSheet, String user,
								String password, SQLDriverPropertyCollection props);

		/**
		 * User has clicked the Close button. They don't want to
		 * connect to the alias.
		 *
		 * @param	connSheet	The connection internal frame.
		 */
		public void performClose(ConnectionInternalFrame connSheet);

		/**
		 * User has clicked the Cancel button. They want to cancel
		 * the curently active attempt to connect to the database.
		 *
		 * @param	connSheet	The connection internal frame.
		 */
		public void performCancelConnect(ConnectionInternalFrame connSheet);
	}

	/** Internationalized strings for this class. */
<span class="nc" id="L90">	private static final StringManager s_stringMgr =</span>
<span class="nc" id="L91">		StringManagerFactory.getStringManager(ConnectionInternalFrame.class);</span>

	/** Logger for this class. */
<span class="nc" id="L94">	private static final ILogger s_log =</span>
<span class="nc" id="L95">		LoggerController.createLogger(ConnectionInternalFrame.class);</span>

	/** Application API. */
	private IApplication _app;

	/** Alias we are going to connect to. */
	private ISQLAlias _alias;

	/** JDBC driver for &lt;TT&gt;_alias&lt;/TT&gt;. */
	private ISQLDriver _sqlDriver;

	/** &lt;TT&gt;true&lt;/TT&gt; means that an attempt is being made to connect to the alias.*/
	private boolean _connecting;

//	private SQLDriverPropertyCollection _props = new SQLDriverPropertyCollection();

	private IHandler _handler;

<span class="nc" id="L113">	private JLabel _aliasName = new JLabel();</span>
<span class="nc" id="L114">	private JLabel _driverName = new JLabel();</span>
<span class="nc" id="L115">	private JLabel _url = new JLabel();</span>
<span class="nc" id="L116">	private JTextField _user = new JTextField();</span>
<span class="nc" id="L117">	private JTextField _password = new JPasswordField();</span>
<span class="nc" id="L118">	private OkClosePanel _btnsPnl = new OkClosePanel(s_stringMgr.getString(&quot;ConnectionInternalFrame.connect&quot;));</span>

<span class="nc" id="L120">	private boolean _driverPropertiesLoaded = false;</span>

//	/** If checked use the extended driver properties. */
//	private final JCheckBox _useDriverPropsChk = new JCheckBox(s_stringMgr.getString(&quot;ConnectionInternalFrame.userdriverprops&quot;));

	/** Button that brings up the driver properties dialog. */
<span class="nc" id="L126">	private final JButton _driverPropsBtn = new JButton(s_stringMgr.getString(&quot;ConnectionInternalFrame.props&quot;));</span>

<span class="nc" id="L128">	private StatusBar _statusBar = new StatusBar();</span>

	/**
	 * Ctor.
	 *
	 * @param	app		Application API.
	 * @param	alias	&lt;TT&gt;SQLAlias&lt;/TT&gt; that we are going to connect to.
	 * @param	handler	Handler for internal frame actions.
	 *
	 * @throws	IllegalArgumentException
	 * 			If &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;IApplication&lt;/TT&gt;, &lt;TT&gt;ISQLAlias&lt;/TT&gt;,
	 * 			or &lt;TT&gt;IConnectionInternalFrameHandler&lt;/TT&gt; passed.
	 */
	public ConnectionInternalFrame(IApplication app, ISQLAlias alias,
									IHandler handler)
	{
<span class="nc" id="L144">		super(&quot;&quot;, true, app);</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		if (app == null)</span>
		{
<span class="nc" id="L147">			throw new IllegalArgumentException(&quot;Null IApplication passed&quot;);</span>
		}
<span class="nc bnc" id="L149" title="All 2 branches missed.">		if (alias == null)</span>
		{
<span class="nc" id="L151">			throw new IllegalArgumentException(&quot;Null ISQLAlias passed&quot;);</span>
		}
<span class="nc bnc" id="L153" title="All 2 branches missed.">		if (handler == null)</span>
		{
<span class="nc" id="L155">			throw new IllegalArgumentException(&quot;Null IConnectionInternalFrameHandler passed&quot;);</span>
		}

<span class="nc" id="L158">		_app = app;</span>
<span class="nc" id="L159">		_alias = alias;</span>
<span class="nc" id="L160">		_handler = handler;</span>

<span class="nc" id="L162">		_sqlDriver = _app.getDataCache().getDriver(_alias.getDriverIdentifier());</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">		if (_sqlDriver == null)</span>
		{
<span class="nc" id="L165">			throw new IllegalStateException(s_stringMgr.getString(&quot;ConnectionInternalFrame.error.nodriver&quot;,</span>
<span class="nc" id="L166">												_alias.getName()));</span>
		}

<span class="nc" id="L169">		createGUI();</span>
<span class="nc" id="L170">		loadData();</span>
<span class="nc" id="L171">		pack();</span>
<span class="nc" id="L172">	}</span>

	public void executed(final boolean connected)
	{
<span class="nc" id="L176">        _connecting = false;</span>
<span class="nc" id="L177">        GUIUtils.processOnSwingEventThread(new Runnable() {</span>
            public void run() {
<span class="nc bnc" id="L179" title="All 2 branches missed.">                if (connected)</span>
                {
<span class="nc" id="L181">                    dispose();</span>
                }
                else
                {
<span class="nc" id="L185">                    setStatusText(null);</span>
<span class="nc" id="L186">                    _user.setEnabled(true);</span>
<span class="nc" id="L187">                    _password.setEnabled(true);</span>
<span class="nc" id="L188">                    _btnsPnl.setExecuting(false);</span>
                }                
<span class="nc" id="L190">            }</span>
        });
<span class="nc" id="L192">	}</span>

	/**
	 * If the alias specifies autologon then connect after the Dialog is visible.
	 *
	 * @param	visible		If &lt;TT&gt;true&lt;/TT&gt; dialog is to be made visible.
	 */
	public void setVisible(boolean visible)
	{
<span class="nc" id="L201">		super.setVisible(visible);</span>

<span class="nc bnc" id="L203" title="All 4 branches missed.">		if (visible &amp;&amp; _alias.isAutoLogon())</span>
		{
<span class="nc" id="L205">			SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L206">			{</span>
				public void run()
				{
<span class="nc" id="L209">					connect();</span>
<span class="nc" id="L210">				}</span>
			});
		}
<span class="nc" id="L213">	}</span>

	/**
	 * Set the text in the status bar.
	 *
	 * @param	text	The text to place in the status bar.
	 */
	public void setStatusText(String text)
	{
<span class="nc" id="L222">		_statusBar.setText(text);</span>
<span class="nc" id="L223">	}</span>

	/**
	 * Allow base class to create rootpane and add a couple
	 * of listeners for ENTER and ESCAPE to it.
	 */
	private void initKeyListeners()
	{
<span class="nc" id="L231">		ActionListener escapeListener = new ActionListener()</span>
<span class="nc" id="L232">		{</span>
			public void actionPerformed(ActionEvent actionEvent)
			{
<span class="nc" id="L235">				ConnectionInternalFrame.this.dispose();</span>
<span class="nc" id="L236">			}</span>
		};

<span class="nc" id="L239">		ActionListener enterListener = new ActionListener()</span>
<span class="nc" id="L240">		{</span>
			public void actionPerformed(ActionEvent actionEvent)
			{
<span class="nc" id="L243">				ConnectionInternalFrame.this.connect();</span>
<span class="nc" id="L244">			}</span>
		};

<span class="nc" id="L247">		final JRootPane pane = getRootPane();</span>

<span class="nc" id="L249">		KeyStroke ks = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</span>
<span class="nc" id="L250">		pane.registerKeyboardAction(escapeListener, ks, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>
<span class="nc" id="L251">		ks = KeyStroke.getKeyStroke(KeyEvent.VK_ENTER, 0);</span>
<span class="nc" id="L252">		pane.registerKeyboardAction(enterListener, ks, JComponent.WHEN_IN_FOCUSED_WINDOW);</span>
<span class="nc" id="L253">	}</span>

   /**
    * Load data about selected alias into the UI.
    */
   private void loadData()
   {
<span class="nc bnc" id="L260" title="All 2 branches missed.">      if (SwingUtilities.isEventDispatchThread())</span>
      {
<span class="nc" id="L262">         _loadData();</span>
      }
      else
      {
<span class="nc" id="L266">         SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L267">         {</span>
            public void run()
            {
<span class="nc" id="L270">               _loadData();</span>
<span class="nc" id="L271">            }</span>
         });
      }
      //loadDriverProperties();

<span class="nc" id="L276">   }</span>

   private void _loadData()
   {
<span class="nc" id="L280">      String userName = _alias.getUserName();</span>
<span class="nc" id="L281">      String password = _alias.getPassword();</span>
<span class="nc" id="L282">      _aliasName.setText(_alias.getName());</span>
<span class="nc" id="L283">      _driverName.setText(_sqlDriver.getName());</span>
<span class="nc" id="L284">      _url.setText(_alias.getUrl());</span>
<span class="nc" id="L285">      _user.setText(userName);</span>
<span class="nc" id="L286">      _password.setText(password);</span>
//      _useDriverPropsChk.setSelected(_alias.getUseDriverProperties());
//      _driverPropsBtn.setEnabled(_useDriverPropsChk.isSelected());
      // This is mainly for long URLs that cannot be fully
      // displayed in the label.
<span class="nc" id="L291">      _aliasName.setToolTipText(_aliasName.getText());</span>
<span class="nc" id="L292">      _driverName.setToolTipText(_driverName.getText());</span>
<span class="nc" id="L293">      _url.setToolTipText(_url.getText());</span>
<span class="nc" id="L294">   }</span>

   private void connect()
	{
<span class="nc bnc" id="L298" title="All 2 branches missed.">		if (!_connecting)</span>
		{
<span class="nc" id="L300">			_connecting = true;</span>
<span class="nc" id="L301">			_btnsPnl.setExecuting(true);</span>
<span class="nc" id="L302">			setStatusText(s_stringMgr.getString(&quot;ConnectionInternalFrame.connecting&quot;));</span>
<span class="nc" id="L303">			_user.setEnabled(false);</span>
<span class="nc" id="L304">			_password.setEnabled(false);</span>

<span class="nc" id="L306">         SQLDriverPropertyCollection driverProperties = _alias.getDriverPropertiesClone();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">         if (!_alias.getUseDriverProperties())</span>
         {
<span class="nc" id="L309">            driverProperties.clear();</span>
         }
<span class="nc" id="L311">			_handler.performOK(this, _user.getText(), _password.getText(), driverProperties);</span>
		}
<span class="nc" id="L313">	}</span>

	private void cancelConnect()
	{
<span class="nc bnc" id="L317" title="All 2 branches missed.">		if (_connecting)</span>
		{
			// abort first..
<span class="nc" id="L320">			setStatusText(s_stringMgr.getString(&quot;ConnectionInternalFrame.cancelling&quot;));</span>
<span class="nc" id="L321">			_btnsPnl.enableCloseButton(false);</span>
<span class="nc" id="L322">			_handler.performCancelConnect(this);</span>
<span class="nc" id="L323">			_connecting = false;</span>
<span class="nc" id="L324">			dispose();</span>
		}
<span class="nc" id="L326">	}</span>

	private void createGUI()
	{
<span class="nc" id="L330">      setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span>
<span class="nc" id="L331">      makeToolWindow(true);</span>

<span class="nc" id="L333">      final String winTitle =</span>
<span class="nc" id="L334">         s_stringMgr.getString(&quot;ConnectionInternalFrame.title&quot;, _alias.getName());</span>
<span class="nc" id="L335">      setTitle(winTitle);</span>

<span class="nc" id="L337">      final JPanel content = new JPanel(new BorderLayout());</span>
<span class="nc" id="L338">      content.add(createMainPanel(), BorderLayout.CENTER);</span>
<span class="nc" id="L339">      content.add(_statusBar, BorderLayout.SOUTH);</span>
<span class="nc" id="L340">      setContentPane(content);</span>

<span class="nc" id="L342">      initKeyListeners();</span>

<span class="nc" id="L344">   }</span>

	/**
	 * Create the main panel
	 *
	 * @return	main panel.
	 */
	private Component createMainPanel()
	{
<span class="nc" id="L353">		_user.setColumns(20);</span>
<span class="nc" id="L354">		_password.setColumns(20);</span>

<span class="nc" id="L356">		_driverPropsBtn.addActionListener(new ActionListener()</span>
<span class="nc" id="L357">		{</span>
			public void actionPerformed(ActionEvent evt)
			{
<span class="nc" id="L360">				showDriverPropertiesDialog();</span>
<span class="nc" id="L361">			}</span>
		});

<span class="nc" id="L364">		_btnsPnl.addListener(new MyOkClosePanelListener());</span>

<span class="nc" id="L366">		final FormLayout layout = new FormLayout(</span>
			// Columns
			&quot;right:pref, 8dlu, left:min(100dlu;pref):grow&quot;,
			// Rows
			&quot;pref, 6dlu, pref, 6dlu, pref, 6dlu, pref, 6dlu, pref, 6dlu, &quot;
		+	&quot;pref, 6dlu, pref, 6dlu, pref, 3dlu, pref, 3dlu, pref&quot;);

<span class="nc" id="L373">		PanelBuilder builder = new PanelBuilder(layout);</span>
<span class="nc" id="L374">		CellConstraints cc = new CellConstraints();</span>
<span class="nc" id="L375">		builder.setDefaultDialogBorder();</span>

<span class="nc" id="L377">		int y = 1;</span>
<span class="nc" id="L378">		builder.addSeparator(getTitle(), cc.xywh(1, y, 3, 1));</span>

<span class="nc" id="L380">		y += 2;</span>
<span class="nc" id="L381">		builder.addLabel(s_stringMgr.getString(&quot;ConnectionInternalFrame.alias&quot;), cc.xy(1, y));</span>
<span class="nc" id="L382">		builder.add(_aliasName, cc.xywh(3, y, 1, 1));</span>

<span class="nc" id="L384">		y += 2;</span>
<span class="nc" id="L385">		builder.addLabel(s_stringMgr.getString(&quot;ConnectionInternalFrame.driver&quot;), cc.xy(1, y));</span>
<span class="nc" id="L386">		builder.add(_driverName, cc.xywh(3, y, 1, 1));</span>

<span class="nc" id="L388">		y += 2;</span>
<span class="nc" id="L389">		builder.addLabel(s_stringMgr.getString(&quot;ConnectionInternalFrame.url&quot;), cc.xy(1, y));</span>
<span class="nc" id="L390">		builder.add(_url, cc.xywh(3, y, 1, 1));</span>

<span class="nc" id="L392">		y += 2;</span>
<span class="nc" id="L393">		builder.addLabel(s_stringMgr.getString(&quot;ConnectionInternalFrame.user&quot;), cc.xy(1, y));</span>
<span class="nc" id="L394">		builder.add(_user, cc.xywh(3, y, 1, 1));</span>

<span class="nc" id="L396">		y += 2;</span>
<span class="nc" id="L397">		builder.addLabel(s_stringMgr.getString(&quot;ConnectionInternalFrame.password&quot;), cc.xy(1, y));</span>
<span class="nc" id="L398">		builder.add(_password, cc.xywh(3, y, 1, 1));</span>

<span class="nc" id="L400">		y += 2;</span>
<span class="nc" id="L401">      _driverPropsBtn.setIcon(_app.getResources().getIcon(SquirrelResources.IImageNames.ALIAS_PROPERTIES));</span>
<span class="nc" id="L402">      builder.add(_driverPropsBtn, cc.xywh(3, y, 1, 1));</span>

<span class="nc" id="L404">		y += 2;</span>
<span class="nc" id="L405">		builder.addLabel(s_stringMgr.getString(&quot;ConnectionInternalFrame.warningcapslock&quot;),</span>
<span class="nc" id="L406">							cc.xywh(1, y, 3, 1));</span>

<span class="nc" id="L408">		y += 2;</span>
<span class="nc" id="L409">		builder.addSeparator(&quot;&quot;, cc.xywh(1, y, 3, 1));</span>

<span class="nc" id="L411">		y += 2;</span>
<span class="nc" id="L412">		builder.add(_btnsPnl, cc.xywh(1, y, 3, 1));</span>


		// Set focus to password control if default user name has been setup.
<span class="nc" id="L416">		addWidgetListener(new WidgetAdapter()</span>
<span class="nc" id="L417">		{</span>
			private WidgetAdapter _this;
			public void widgetActivated(WidgetEvent evt)
			{
<span class="nc" id="L421">				_this = this;</span>
<span class="nc" id="L422">				final String userName = _user.getText();</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">				if (userName != null &amp;&amp; userName.length() &gt; 0)</span>
				{
<span class="nc" id="L425">					SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L426">					{</span>
						public void run()
						{
<span class="nc" id="L429">							final String pw = _password.getText();</span>
<span class="nc bnc" id="L430" title="All 4 branches missed.">							if (pw != null &amp;&amp; pw.length() &gt; 0)</span>
							{
<span class="nc" id="L432">								_btnsPnl.getOKButton().requestFocus();</span>
							}
							else
							{
<span class="nc" id="L436">								_password.requestFocus();</span>
							}
<span class="nc" id="L438">							ConnectionInternalFrame.this.removeWidgetListener(_this);</span>
<span class="nc" id="L439">						}</span>
					});
				}
<span class="nc" id="L442">			}</span>
		});

<span class="nc" id="L445">		return builder.getPanel();</span>
	}

	private void showDriverPropertiesDialog()
	{
<span class="nc" id="L450">      new AliasPropertiesCommand(_alias, _app).execute();</span>
<span class="nc" id="L451">	}</span>


	/**
	 * Listener to handle button events in OK/Close panel.
	 */
<span class="nc" id="L457">	private final class MyOkClosePanelListener implements IOkClosePanelListener</span>
	{
		public void okPressed(OkClosePanelEvent evt)
		{
<span class="nc" id="L461">			ConnectionInternalFrame.this.connect();</span>
<span class="nc" id="L462">		}</span>

		public void closePressed(OkClosePanelEvent evt)
		{
<span class="nc" id="L466">			ConnectionInternalFrame.this.dispose();</span>
<span class="nc" id="L467">		}</span>

		public void cancelPressed(OkClosePanelEvent evt)
		{
<span class="nc" id="L471">			ConnectionInternalFrame.this.cancelConnect();</span>
<span class="nc" id="L472">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>