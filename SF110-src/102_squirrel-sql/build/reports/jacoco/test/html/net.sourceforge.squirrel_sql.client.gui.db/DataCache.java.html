<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataCache.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.gui.db</a> &gt; <span class="el_source">DataCache.java</span></div><h1>DataCache.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.gui.db;
/*
 * Copyright (C) 2001-2003 Colin Bell
 * colbell@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;

import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.session.schemainfo.SchemaInfoCacheSerializer;
import net.sourceforge.squirrel_sql.fw.id.IHasIdentifier;
import net.sourceforge.squirrel_sql.fw.id.IIdentifier;
import net.sourceforge.squirrel_sql.fw.persist.ValidationException;
import net.sourceforge.squirrel_sql.fw.sql.ISQLAlias;
import net.sourceforge.squirrel_sql.fw.sql.ISQLDriver;
import net.sourceforge.squirrel_sql.fw.sql.SQLDriver;
import net.sourceforge.squirrel_sql.fw.sql.SQLDriverManager;
import net.sourceforge.squirrel_sql.fw.util.DuplicateObjectException;
import net.sourceforge.squirrel_sql.fw.util.IMessageHandler;
import net.sourceforge.squirrel_sql.fw.util.IObjectCacheChangeListener;
import net.sourceforge.squirrel_sql.fw.util.NullMessageHandler;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;
import net.sourceforge.squirrel_sql.fw.xml.XMLException;
import net.sourceforge.squirrel_sql.fw.xml.XMLObjectCache;

/**
 * XML cache of JDBC drivers and aliases.
 *
 * @author &lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 */
public class DataCache
{
   /** Internationalized strings for this class. */
<span class="nc" id="L58">   private final static StringManager s_stringMgr =</span>
<span class="nc" id="L59">      StringManagerFactory.getStringManager(DataCache.class);</span>

   /** Class for objects that define aliases to JDBC data sources. */
<span class="nc" id="L62">   private final static Class&lt;SQLAlias&gt; SQL_ALIAS_IMPL = SQLAlias.class;</span>

   /** Class for objects that define JDBC drivers. */
<span class="nc" id="L65">   private final static Class&lt;SQLDriver&gt; SQL_DRIVER_IMPL = SQLDriver.class;</span>

   /** Logger for this class. */
<span class="nc" id="L68">   private final static ILogger s_log =</span>
<span class="nc" id="L69">               LoggerController.createLogger(DataCache.class);</span>

   /** Driver manager. */
   private final SQLDriverManager _driverMgr;

   /** Cache that contains data. */
<span class="nc" id="L75">   private final XMLObjectCache _cache = new XMLObjectCache();</span>

   private IApplication _app;

   /**
    * Ctor. Loads drivers and aliases from the XML document.
    *
    * @param	driverMgr		Manages JDBC drivers.
    * @param	driversFile		&lt;TT&gt;File&lt;/TT&gt; to load drivers from.
    * @param	aliasesFile		&lt;TT&gt;File&lt;/TT&gt; to load aliases from.
    * @param	dftDriversURL	URL that the default rivers can be loaded from.
    * @param	msgHandler		Message handler to report on errors in this object.
    *
    * @throws	IllegalArgumentException
    *			Thrown if null &lt;TT&gt;SQLDriverManager&lt;/TT&gt;, &lt;TT&gt;driversFile&lt;/TT&gt;,
    *			&lt;TT&gt;aliasesFile&lt;/TT&gt; or &lt;TT&gt;dftDriversURL&lt;/TT&gt; passed.
    */
   public DataCache(SQLDriverManager driverMgr,
                    File driversFile,
                    File aliasesFile,
                    URL dftDriversURL,
                    IApplication app)
   {
<span class="nc" id="L98">      super();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">      if (driverMgr == null)</span>
      {
<span class="nc" id="L101">         throw new IllegalArgumentException(&quot;SQLDriverManager == null&quot;);</span>
      }
<span class="nc bnc" id="L103" title="All 2 branches missed.">      if (driversFile == null)</span>
      {
<span class="nc" id="L105">         throw new IllegalArgumentException(&quot;driversFile == null&quot;);</span>
      }
<span class="nc bnc" id="L107" title="All 2 branches missed.">      if (aliasesFile == null)</span>
      {
<span class="nc" id="L109">         throw new IllegalArgumentException(&quot;aliasesFile == null&quot;);</span>
      }
<span class="nc bnc" id="L111" title="All 2 branches missed.">      if (dftDriversURL == null)</span>
      {
<span class="nc" id="L113">         throw new IllegalArgumentException(&quot;dftDriversURL == null&quot;);</span>
      }

<span class="nc" id="L116">      _driverMgr = driverMgr;</span>

<span class="nc" id="L118">      _app = app;</span>

<span class="nc" id="L120">      loadDrivers(driversFile, dftDriversURL, NullMessageHandler.getInstance());</span>
<span class="nc" id="L121">      loadAliases(aliasesFile, NullMessageHandler.getInstance());</span>
<span class="nc" id="L122">   }</span>

   /**
    * Save JDBC drivers to the passed file as XML.
    *
    * @param	file	File to save drivers to.
    *
    * @throws	IllegalArgumentException
    * 			Thrown if &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;File&lt;/TT&gt; passed.
    * @throws	IOException
    * 			Thrown if an I/O error occurs saving.
    * @throws	XMLException
    * 			Thrown if an error occurs translating drivers to XML.
    */
   public void saveDrivers(File file) throws IOException, XMLException
   {
<span class="nc bnc" id="L138" title="All 2 branches missed.">      if (file == null)</span>
      {
<span class="nc" id="L140">         throw new IllegalArgumentException(&quot;File == null&quot;);</span>
      }

<span class="nc" id="L143">        saveSecure(file, SQL_DRIVER_IMPL);</span>
<span class="nc" id="L144">   }</span>

   /**
    * Save aliases to the passed file as XML.
    *
    * @param	file	File to save aliases to.
    *
    * @throws	IllegalArgumentException
    * 			Thrown if &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;File&lt;/TT&gt; passed.
    * @throws	IOException
    * 			Thrown if an I/O error occurs saving.
    * @throws	XMLException
    * 			Thrown if an error occurs translating aliases to XML.
    */
   public void saveAliases(File file) throws IOException, XMLException
   {
<span class="nc bnc" id="L160" title="All 2 branches missed.">      if (file == null)</span>
      {
<span class="nc" id="L162">         throw new IllegalArgumentException(&quot;File == null&quot;);</span>
      }
<span class="nc" id="L164">        saveSecure(file, SQL_ALIAS_IMPL);</span>
<span class="nc" id="L165">    }</span>

   private void saveSecure(File file, Class&lt;? extends IHasIdentifier&gt; forClass) throws IOException, XMLException
   {
<span class="nc" id="L169">      File tempFile = new File(file.getPath() + &quot;~&quot;);</span>
      try
      {
<span class="nc" id="L172">         tempFile.delete();</span>
      }
<span class="nc" id="L174">      catch (Exception e)</span>
      {
<span class="nc" id="L176">      }</span>


<span class="nc" id="L179">      _cache.saveAllForClass(tempFile.getPath(), forClass);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">      if (false == tempFile.renameTo(file))</span>
      {
<span class="nc" id="L182">         File doubleTemp = new File(file.getPath() + &quot;~~&quot;);</span>
         try
         {
<span class="nc" id="L185">            doubleTemp.delete();</span>
         }
<span class="nc" id="L187">         catch (Exception e)</span>
         {
<span class="nc" id="L189">         }</span>
<span class="nc" id="L190">         File buf = new File(file.getPath());</span>


<span class="nc bnc" id="L193" title="All 2 branches missed.">         if (false == buf.renameTo(doubleTemp))</span>
         {
<span class="nc" id="L195">            throw new IllegalStateException(&quot;Cannot rename file &quot; + buf.getPath() + &quot; to &quot; + doubleTemp.getPath() + &quot;. New File will not be saved.&quot;);</span>
         }

         try
         {
<span class="nc" id="L200">            tempFile.renameTo(file);</span>
<span class="nc" id="L201">            doubleTemp.delete();</span>
         }
<span class="nc" id="L203">         catch (Exception e)</span>
         {
<span class="nc" id="L205">            doubleTemp.renameTo(file);</span>
<span class="nc" id="L206">         }</span>
      }
<span class="nc" id="L208">   }</span>

   /**
     * Retrieve the &lt;TT&gt;ISQLDriver&lt;/TT&gt; for the passed identifier.
     *
     * @param	id	Identifier to retrieve driver for.
     *
     * @return	the &lt;TT&gt;ISQLDriver&lt;/TT&gt; for the passed identifier.
     *
     * @throws	IllegalArgumentException
     * 			Thrown if &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;ISQLDriver&lt;/TT&gt; passed.
     */
    public ISQLDriver getDriver(IIdentifier id)
    {
<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (id == null)</span>
        {
<span class="nc" id="L224">            throw new IllegalArgumentException(&quot;ISQLDriver == null&quot;);</span>
        }

<span class="nc" id="L227">        return (ISQLDriver)_cache.get(SQL_DRIVER_IMPL, id);</span>
    }

   /**
    * Add a driver to the cache.
    *
    * @param	sqlDriver	The driver to add.
    *
    * @param messageHandler
    * @throws	IllegalArgumentException
    * 			Thrown if &lt;TT&gt;ISQLDriver&lt;/TT&gt; is null.
    */
   public void addDriver(ISQLDriver sqlDriver, IMessageHandler messageHandler)
      throws ClassNotFoundException, IllegalAccessException,
            InstantiationException, DuplicateObjectException,
            MalformedURLException
   {
<span class="nc bnc" id="L244" title="All 2 branches missed.">      if (sqlDriver == null)</span>
      {
<span class="nc" id="L246">         throw new IllegalArgumentException(&quot;ISQLDriver == null&quot;);</span>
      }
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (messageHandler != null) {</span>
<span class="nc" id="L249">            registerDriver(sqlDriver, messageHandler, true);</span>
        }
<span class="nc" id="L251">      _cache.add(sqlDriver);</span>
<span class="nc" id="L252">   }</span>

   public void removeDriver(ISQLDriver sqlDriver)
   {
<span class="nc" id="L256">      _cache.remove(SQL_DRIVER_IMPL, sqlDriver.getIdentifier());</span>
<span class="nc" id="L257">      _driverMgr.unregisterSQLDriver(sqlDriver);</span>
<span class="nc" id="L258">   }</span>

   public Iterator&lt;ISQLDriver&gt; drivers()
   {
<span class="nc" id="L262">      return _cache.getAllForClass(SQL_DRIVER_IMPL);</span>
   }

   public void addDriversListener(IObjectCacheChangeListener lis)
   {
<span class="nc" id="L267">      _cache.addChangesListener(lis, SQL_DRIVER_IMPL);</span>
<span class="nc" id="L268">   }</span>

   public void removeDriversListener(IObjectCacheChangeListener lis)
   {
<span class="nc" id="L272">      _cache.removeChangesListener(lis, SQL_DRIVER_IMPL);</span>
<span class="nc" id="L273">   }</span>

   public ISQLAlias getAlias(IIdentifier id)
   {
<span class="nc" id="L277">      return (ISQLAlias) _cache.get(SQL_ALIAS_IMPL, id);</span>
   }

   public Iterator&lt;ISQLAlias&gt; aliases()
   {
<span class="nc" id="L282">      return _cache.getAllForClass(SQL_ALIAS_IMPL);</span>
   }

   public HashMap&lt;String, ArrayList&lt;ISQLAlias&gt;&gt; aliasesByUrl()
   {
<span class="nc" id="L287">      Iterator&lt;ISQLAlias&gt; aliases = aliases();</span>

<span class="nc" id="L289">      HashMap&lt;String, ArrayList&lt;ISQLAlias&gt;&gt; ret = new HashMap&lt;String, ArrayList&lt;ISQLAlias&gt;&gt;();</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">      while(aliases.hasNext())</span>
      {
<span class="nc" id="L293">         ISQLAlias alias = aliases.next();</span>

<span class="nc" id="L295">         ArrayList&lt;ISQLAlias&gt; buf = ret.get(alias.getUrl());</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">         if(null == buf)</span>
         {
<span class="nc" id="L298">            buf = new ArrayList&lt;ISQLAlias&gt;();</span>
<span class="nc" id="L299">            buf.add(alias);</span>
<span class="nc" id="L300">            ret.put(alias.getUrl(), buf);</span>
         }
<span class="nc" id="L302">      }</span>

<span class="nc" id="L304">      return ret;</span>

   }


   public void addAlias(ISQLAlias alias) throws DuplicateObjectException
   {
<span class="nc" id="L311">      _cache.add(alias);</span>
<span class="nc" id="L312">   }</span>

   public void removeAlias(SQLAlias alias)
   {
<span class="nc" id="L316">      SchemaInfoCacheSerializer.aliasRemoved(alias);</span>
<span class="nc" id="L317">      _app.getPluginManager().aliasRemoved(alias);</span>
<span class="nc" id="L318">      _cache.remove(SQL_ALIAS_IMPL, alias.getIdentifier());</span>
<span class="nc" id="L319">   }</span>

   public Iterator&lt;ISQLAlias&gt; getAliasesForDriver(ISQLDriver driver)
   {
<span class="nc" id="L323">      ArrayList&lt;ISQLAlias&gt; data = new ArrayList&lt;ISQLAlias&gt;();</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">      for (Iterator&lt;ISQLAlias&gt; it = aliases(); it.hasNext();)</span>
      {
<span class="nc" id="L326">         ISQLAlias alias = it.next();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">         if (driver.equals(getDriver(alias.getDriverIdentifier())))</span>
         {
<span class="nc" id="L329">            data.add(alias);</span>
         }
<span class="nc" id="L331">      }</span>
<span class="nc" id="L332">      return data.iterator();</span>
   }

   public void addAliasesListener(IObjectCacheChangeListener lis)
   {
<span class="nc" id="L337">      _cache.addChangesListener(lis, SQL_ALIAS_IMPL);</span>
<span class="nc" id="L338">   }</span>

   public void removeAliasesListener(IObjectCacheChangeListener lis)
   {
<span class="nc" id="L342">      _cache.removeChangesListener(lis, SQL_ALIAS_IMPL);</span>
<span class="nc" id="L343">   }</span>

   /**
    * Load &lt;TT&gt;IISqlDriver&lt;/TT&gt; objects from the XML file &lt;TT&gt;driversFile&lt;/TT&gt;.
    * If file not found then load from the default drivers.
    *
    * @param	driversFile		&lt;TT&gt;File&lt;/TT&gt; to load drivers from.
    * @param	dftDriversURL	&lt;TT&gt;URL&lt;/TT&gt; to load default drivers from.
    * @param	msgHandler		Message handler to write any errors to.
    *
    *@throws	IllegalArgumentException
    *			Thrown if &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;driversFile&lt;/TT&gt;,
    *			&lt;TT&gt;dftDriversURL&lt;/TT&gt;, or &lt;TT&gt;msgHandler&lt;/TT&gt; passed.
    */
   private void loadDrivers(File driversFile, URL dftDriversURL,
                            IMessageHandler msgHandler)
   {
<span class="nc bnc" id="L360" title="All 2 branches missed.">      if (driversFile == null)</span>
      {
<span class="nc" id="L362">         throw new IllegalArgumentException(&quot;driversFile == null&quot;);</span>
      }
<span class="nc bnc" id="L364" title="All 2 branches missed.">      if (dftDriversURL == null)</span>
      {
<span class="nc" id="L366">         throw new IllegalArgumentException(&quot;dftDriversURL == null&quot;);</span>
      }
<span class="nc bnc" id="L368" title="All 2 branches missed.">      if (msgHandler == null)</span>
      {
<span class="nc" id="L370">         throw new IllegalArgumentException(&quot;msgHandler == null&quot;);</span>
      }

      try
      {
         try
         {
<span class="nc" id="L377">            _cache.load(driversFile.getPath());</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            if (!drivers().hasNext())</span>
            {
<span class="nc" id="L380">               loadDefaultDrivers(dftDriversURL);</span>
            }
            else
            {
<span class="nc" id="L384">               fixupDrivers();</span>
<span class="nc" id="L385">                    mergeDefaultWebsites(dftDriversURL);</span>
            }
         }
<span class="nc" id="L388">         catch (FileNotFoundException ex)</span>
         {
<span class="nc" id="L390">            loadDefaultDrivers(dftDriversURL); // first time user has run pgm.</span>
         }
<span class="nc" id="L392">         catch (Exception ex)</span>
         {
<span class="nc" id="L394">            String msg = s_stringMgr.getString(&quot;DataCache.error.loadingdrivers&quot;,</span>
<span class="nc" id="L395">                                       driversFile.getPath());</span>
<span class="nc" id="L396">            s_log.error(msg, ex);</span>
<span class="nc" id="L397">            msgHandler.showErrorMessage(msg);</span>
<span class="nc" id="L398">            msgHandler.showErrorMessage(ex, null);</span>
<span class="nc" id="L399">            loadDefaultDrivers(dftDriversURL);</span>
<span class="nc" id="L400">         }</span>
      }
<span class="nc" id="L402">      catch (XMLException ex)</span>
      {
<span class="nc" id="L404">         s_log.error(&quot;Error loading drivers&quot;, ex);</span>
      }
<span class="nc" id="L406">      catch (IOException ex)</span>
      {
<span class="nc" id="L408">         s_log.error(&quot;Error loading drivers&quot;, ex);</span>
<span class="nc" id="L409">      }</span>

<span class="nc bnc" id="L411" title="All 2 branches missed.">      for (Iterator&lt;ISQLDriver&gt; it = drivers(); it.hasNext();)</span>
      {
<span class="nc" id="L413">         registerDriver(it.next(), msgHandler, false);</span>
      }
<span class="nc" id="L415">   }</span>

   public SQLAlias createAlias(IIdentifier id)
   {
<span class="nc" id="L419">      return new SQLAlias(id);</span>
   }

   public ISQLDriver createDriver(IIdentifier id)
   {
<span class="nc" id="L424">      return new SQLDriver(id);</span>
   }

    /**
     * Tests the currently cached driver definitions to see if any default 
     * drivers are missing and returns an array of ISQLDrivers that represent
     * default drivers that were not found.
     * 
     * @param url the url of the file containing the default driver definitions.
     * @return a list of default ISQLDriver instances if any or found; null is
     *         returned otherwise.
     *         
     * @throws IOException
     * @throws XMLException
     */
    public ISQLDriver[] findMissingDefaultDrivers(URL url)
        throws IOException, XMLException
    {
<span class="nc" id="L442">        ISQLDriver[] result = null;</span>
<span class="nc" id="L443">        InputStreamReader isr = new InputStreamReader(url.openStream());</span>
<span class="nc" id="L444">        ArrayList&lt;ISQLDriver&gt; missingDrivers = new ArrayList&lt;ISQLDriver&gt;();</span>
        try
        {
<span class="nc" id="L447">            XMLObjectCache tmp = new XMLObjectCache();</span>
<span class="nc" id="L448">            tmp.load(isr, null, true);</span>

<span class="nc bnc" id="L450" title="All 2 branches missed.">            for (Iterator&lt;ISQLDriver&gt; iter = tmp.getAllForClass(SQL_DRIVER_IMPL); iter.hasNext();) {</span>
<span class="nc" id="L451">                ISQLDriver defaultDriver = iter.next();</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                if (!containsDriver(defaultDriver)) {</span>
<span class="nc" id="L453">                    missingDrivers.add(defaultDriver);</span>
                }
<span class="nc" id="L455">            }</span>
        }
<span class="nc" id="L457">        catch (DuplicateObjectException ex)</span>
        {
            // If this happens then this is a programming error as we said
            // in the above call to ingore these errors.
<span class="nc" id="L461">            s_log.error(&quot;Received an unexpected DuplicateObjectException&quot;, ex);</span>
        }
        finally
        {
<span class="nc" id="L465">            isr.close();</span>
        }
<span class="nc bnc" id="L467" title="All 2 branches missed.">        if (missingDrivers.size() &gt; 0) {</span>
<span class="nc" id="L468">            result = missingDrivers.toArray(new ISQLDriver[missingDrivers.size()]);</span>
        }
<span class="nc" id="L470">        return result;</span>
    }

    /**
     * Returns a boolean value indicating whether or not the specified driver
     * is contained in the cache.
     * 
     * @param driver the ISQLDriver to search for.
     * @return true if the specified driver was found; false otherwise.
     */
    public boolean containsDriver(ISQLDriver driver) {
<span class="nc" id="L481">        boolean result = false;</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">        for (Iterator&lt;ISQLDriver&gt; iter = _cache.getAllForClass(SQL_DRIVER_IMPL); iter.hasNext();) {</span>
<span class="nc" id="L483">            ISQLDriver cachedDriver = iter.next();</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">            if (cachedDriver.equals(driver)) {</span>
<span class="nc" id="L485">                result = true;</span>
<span class="nc" id="L486">                break;</span>
            }
<span class="nc" id="L488">        }</span>
<span class="nc" id="L489">        return result;</span>
    }

   public void loadDefaultDrivers(URL url) throws IOException, XMLException
   {
<span class="nc" id="L494">      InputStreamReader isr = new InputStreamReader(url.openStream());</span>
      try
      {
<span class="nc" id="L497">         _cache.load(isr, null, true);</span>
      }
<span class="nc" id="L499">      catch (DuplicateObjectException ex)</span>
      {
         // If this happens then this is a programming error as we said
         // in the above call to ingore these errors.
<span class="nc" id="L503">         s_log.error(&quot;Received an unexpected DuplicateObjectException&quot;, ex);</span>
      }
      finally
      {
<span class="nc" id="L507">         isr.close();</span>
      }
<span class="nc" id="L509">   }</span>

   private void registerDriver(ISQLDriver sqlDriver, IMessageHandler msgHandler, boolean extendedMessaging)
   {
<span class="nc" id="L513">      boolean registrationSucessfully = false;</span>
      try
      {
<span class="nc" id="L516">         _driverMgr.registerSQLDriver(sqlDriver);</span>
<span class="nc" id="L517">         registrationSucessfully = true;</span>
      }
<span class="nc" id="L519">      catch (ClassNotFoundException cnfe)</span>
      {
<span class="nc bnc" id="L521" title="All 2 branches missed.">         if(extendedMessaging)</span>
         {
<span class="nc" id="L523">            Object[] params  = new Object[]</span>
               {
<span class="nc" id="L525">                  sqlDriver.getDriverClassName(),</span>
<span class="nc" id="L526">                  sqlDriver.getName(),</span>
                  cnfe
               };

<span class="nc" id="L530">            String msg = s_stringMgr.getString(&quot;DataCache.error.driverClassNotFound&quot;, params);</span>
            // i18n[DataCache.msg.driverClassNotFound=Could not find class {0} in neither
            // the Java class path nor the Extra class path of the {1} driver definition:\n{2}]

<span class="nc" id="L534">            s_log.error(msg, cnfe);</span>
<span class="nc" id="L535">            msgHandler.showErrorMessage(msg);</span>
         }
      }
<span class="nc" id="L538">      catch (Throwable th)</span>
      {
<span class="nc" id="L540">         String msg = s_stringMgr.getString(&quot;DataCache.error.registerdriver&quot;,</span>
<span class="nc" id="L541">                                    sqlDriver.getName());</span>
<span class="nc" id="L542">         s_log.error(msg, th);</span>
<span class="nc" id="L543">         msgHandler.showErrorMessage(msg);</span>
<span class="nc" id="L544">         msgHandler.showErrorMessage(th, null);</span>
<span class="nc" id="L545">      }</span>

<span class="nc bnc" id="L547" title="All 4 branches missed.">      if(extendedMessaging &amp;&amp; registrationSucessfully)</span>
      {
<span class="nc" id="L549">         Object[] params  = new Object[]</span>
            {
<span class="nc" id="L551">               sqlDriver.getDriverClassName(),</span>
<span class="nc" id="L552">               sqlDriver.getName(),</span>
            };


<span class="nc" id="L556">         String msg = s_stringMgr.getString(&quot;DataCache.msg.driverRegisteredSucessfully&quot;, params);</span>
         // i18n[DataCache.msg.driverRegisteredSucessfully=Driver class {0} sucessfully registered
         // for driver definition: {1}]
<span class="nc" id="L559">         msgHandler.showMessage(msg);</span>
      }
<span class="nc" id="L561">   }</span>

   private void loadAliases(File aliasesFile, IMessageHandler msgHandler)
   {
      try
      {
<span class="nc" id="L567">         _cache.load(aliasesFile.getPath());</span>
      }
<span class="nc" id="L569">      catch (FileNotFoundException ignore)</span>
      {
         // first time user has run pgm.
      }
<span class="nc" id="L573">      catch (Exception ex)</span>
      {
<span class="nc" id="L575">         String msg = s_stringMgr.getString(&quot;DataCache.error.loadingaliases&quot;,</span>
<span class="nc" id="L576">                                    aliasesFile.getPath());</span>
<span class="nc" id="L577">         s_log.error(msg, ex);</span>
<span class="nc" id="L578">         msgHandler.showErrorMessage(msg);</span>
<span class="nc" id="L579">         msgHandler.showErrorMessage(ex, null);</span>
<span class="nc" id="L580">      }</span>
<span class="nc" id="L581">   }</span>

   /**
    * In 1.1beta? the jar file for a driver was changed from only one allowed
    * to multiple ones allowed. This method changes the driver from the old
    * version to the new one to allow for loading old versions of the
    * SQLDrivers.xml file.
    */
   @SuppressWarnings(&quot;deprecation&quot;)
   private void fixupDrivers()
   {
<span class="nc bnc" id="L592" title="All 2 branches missed.">      for (Iterator&lt;ISQLDriver&gt; it = drivers(); it.hasNext();)</span>
      {
<span class="nc" id="L594">         ISQLDriver driver = it.next();</span>
<span class="nc" id="L595">         String[] fileNames = driver.getJarFileNames();</span>
<span class="nc bnc" id="L596" title="All 4 branches missed.">         if (fileNames == null || fileNames.length == 0)</span>
         {
<span class="nc" id="L598">            String fileName = driver.getJarFileName();</span>
<span class="nc bnc" id="L599" title="All 4 branches missed.">            if (fileName != null &amp;&amp; fileName.length() &gt; 0)</span>
            {
<span class="nc" id="L601">               driver.setJarFileNames(new String[] {fileName});</span>
               try
               {
<span class="nc" id="L604">                  driver.setJarFileName(null);</span>
               }
<span class="nc" id="L606">               catch (ValidationException ignore)</span>
               {
                  // Ignore
<span class="nc" id="L609">               }</span>
            }
         }
<span class="nc" id="L612">      }</span>
<span class="nc" id="L613">   }</span>

    /**
     * In 2.1 final(+), we introduced a new property for drivers which is the 
     * website that hosts the driver and/or the relational database associated
     * with a driver.  To populate existing driver definitions in SQLDrivers.xml
     * with this value, it is necessary to read in the default defs, then scan 
     * the currently loaded drivers and set the website url.  That is what this 
     * method does.
     */
    private void mergeDefaultWebsites(URL defaultDriversUrl)
    {
<span class="nc" id="L625">        InputStreamReader isr = null;</span>
        try
        {
<span class="nc" id="L628">            isr = new InputStreamReader(defaultDriversUrl.openStream());</span>
<span class="nc" id="L629">            XMLObjectCache tmp = new XMLObjectCache();</span>
<span class="nc" id="L630">            tmp.load(isr, null, true);</span>

<span class="nc bnc" id="L632" title="All 2 branches missed.">            for (Iterator&lt;ISQLDriver&gt; iter = tmp.getAllForClass(SQL_DRIVER_IMPL); iter.hasNext();) {</span>

<span class="nc" id="L634">                ISQLDriver defaultDriver = iter.next();</span>
<span class="nc" id="L635">                ISQLDriver cachedDriver = getDriver(defaultDriver.getIdentifier());</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                if (cachedDriver != null) {</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                    if (cachedDriver.getWebSiteUrl() == null</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">                            || &quot;&quot;.equals(cachedDriver.getWebSiteUrl()))</span>
                    {
<span class="nc bnc" id="L640" title="All 2 branches missed.">                        if (defaultDriver.getWebSiteUrl() != null) {</span>
<span class="nc" id="L641">                            cachedDriver.setWebSiteUrl(defaultDriver.getWebSiteUrl());</span>
                        }
                    }
                }
<span class="nc" id="L645">            }</span>
<span class="nc" id="L646">        } catch (Exception ex) {</span>
<span class="nc" id="L647">            s_log.error(&quot;Received an unexpected Exception&quot;, ex);</span>
        } finally {
<span class="nc bnc" id="L649" title="All 2 branches missed.">            if (isr != null) {</span>
<span class="nc" id="L650">                try { isr.close(); } catch (Exception e) {/* Do Nothing */}</span>
            }
        }
<span class="nc" id="L653">    }</span>

   public void refreshDriver(ISQLDriver driver, IMessageHandler messageHandler)
   {
<span class="nc" id="L657">      registerDriver(driver, messageHandler, true);</span>
<span class="nc" id="L658">   }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>