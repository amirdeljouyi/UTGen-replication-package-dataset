<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TableExportCsvController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.fw.gui.action</a> &gt; <span class="el_source">TableExportCsvController.java</span></div><h1>TableExportCsvController.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.fw.gui.action;

import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import java.io.File;
import java.nio.charset.Charset;
import java.nio.charset.IllegalCharsetNameException;
import java.util.prefs.Preferences;

import javax.swing.AbstractAction;
import javax.swing.JComponent;
import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import javax.swing.KeyStroke;
import javax.swing.SwingUtilities;

import net.sourceforge.squirrel_sql.fw.gui.GUIUtils;
import net.sourceforge.squirrel_sql.fw.gui.action.TableExportCsvDlg.LineSeparator;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;

public class TableExportCsvController
{
   private static final String PREF_KEY_CSV_FILE = &quot;SquirrelSQL.csvexport.csvfile&quot;;
   private static final String PREF_KEY_CSV_ENCODING = &quot;SquirrelSQL.csvexport.csvencoding&quot;;
   private static final String PREF_KEY_WITH_HEADERS = &quot;SquirrelSQL.csvexport.withColumnHeaders&quot;;
   private static final String PREF_KEY_SEPERATOR_TAB = &quot;SquirrelSQL.csvexport.sepearatorTab&quot;;
   private static final String PREF_KEY_SEPERATOR_CHAR = &quot;SquirrelSQL.csvexport.sepearatorChar&quot;;
   private static final String PREF_KEY_LINE_SEPERATOR = &quot;SquirrelSQL.csvexport.lineSeparator&quot;;
   private static final String PREF_KEY_EXPORT_COMPLETE = &quot;SquirrelSQL.csvexport.exportcomplete&quot;;
   private static final String PREF_KEY_USE_GLOBAL_PREFS_FORMATING = &quot;SquirrelSQL.csvexport.useGlobalPrefsFomating&quot;;
   private static final String PREF_KEY_EXECUTE_COMMAND = &quot;SquirrelSQL.csvexport.executeCommand&quot;;
   private static final String PREF_KEY_COMMAND = &quot;SquirrelSQL.csvexport.commandString&quot;;
   private static final String PREF_KEY_FORMAT_CSV = &quot;SquirrelSQL.csvexport.formatCSV&quot;;
   private static final String PREF_KEY_FORMAT_XLS = &quot;SquirrelSQL.csvexport.formatXLS&quot;;
   private static final String PREF_KEY_FORMAT_XML = &quot;SquirrelSQL.csvexport.formatXML&quot;;

<span class="nc" id="L41">   private static final StringManager s_stringMgr =</span>
<span class="nc" id="L42">      StringManagerFactory.getStringManager(TableExportCsvController.class);</span>



   private TableExportCsvDlg _dlg;
<span class="nc" id="L47">   private boolean _ok = false;</span>
   public static final int EXPORT_FORMAT_CSV = 0;
   public static final int EXPORT_FORMAT_XLS = 1;
   public static final int EXPORT_FORMAT_XML = 2;

   TableExportCsvController()
<span class="nc" id="L53">   {</span>
<span class="nc" id="L54">      _dlg = createDialog();</span>

<span class="nc" id="L56">      initDlg();</span>

<span class="nc" id="L58">      initListeners();</span>

<span class="nc" id="L60">      _dlg.txtSeparatorChar.addKeyListener(new KeyAdapter()</span>
<span class="nc" id="L61">      {</span>
         public void keyTyped(KeyEvent e)
         {
<span class="nc" id="L64">            onSeparatorCharChanged(e);</span>
<span class="nc" id="L65">         }</span>
      });

<span class="nc" id="L68">      _dlg.getRootPane().setDefaultButton(_dlg.btnOk);</span>
<span class="nc" id="L69">      installEscapeClose();</span>

<span class="nc" id="L71">      _dlg.pack();</span>

<span class="nc" id="L73">      GUIUtils.centerWithinParent(_dlg);</span>

<span class="nc" id="L75">      _dlg.setVisible(true);</span>

<span class="nc" id="L77">   }</span>

   protected TableExportCsvDlg createDialog() {
<span class="nc" id="L80">	   return new TableExportCsvDlg();</span>
   }

   private void onSeparatorCharChanged(KeyEvent e)
   {
<span class="nc" id="L85">      SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L86">      {</span>
         public void run()
         {
<span class="nc" id="L89">            String text = _dlg.txtSeparatorChar.getText();</span>
<span class="nc bnc" id="L90" title="All 4 branches missed.">            if(null != text &amp;&amp; 1 &lt; text.length())</span>
            {
<span class="nc" id="L92">               _dlg.txtSeparatorChar.setText(text.substring(0,1));</span>
<span class="nc" id="L93">               Toolkit.getDefaultToolkit().beep();</span>
            }
<span class="nc" id="L95">         }</span>
      });

<span class="nc" id="L98">   }</span>

   private void initListeners()
   {
<span class="nc" id="L102">      _dlg.btnOk.addActionListener(new ActionListener()</span>
<span class="nc" id="L103">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L106">            onOK();</span>
<span class="nc" id="L107">         }</span>
      });

<span class="nc" id="L110">      _dlg.btnCancel.addActionListener(new ActionListener()</span>
<span class="nc" id="L111">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L114">            closeDlg();</span>
<span class="nc" id="L115">         }</span>
      });

<span class="nc" id="L118">      _dlg.radFormatCSV.addActionListener(new ActionListener()</span>
<span class="nc" id="L119">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L122">            onFormat(true);</span>
<span class="nc" id="L123">         }</span>
      });

<span class="nc" id="L126">      _dlg.radFormatXLS.addActionListener(new ActionListener()</span>
<span class="nc" id="L127">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L130">            onFormat(true);</span>
<span class="nc" id="L131">         }</span>
      });
      
<span class="nc" id="L134">      _dlg.radFormatXML.addActionListener(new ActionListener()</span>
<span class="nc" id="L135">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L138">            onFormat(true);</span>
<span class="nc" id="L139">         }</span>
      });


<span class="nc" id="L143">      _dlg.chkSeparatorTab.addActionListener(new ActionListener()</span>
<span class="nc" id="L144">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L147">            onFormat(false);</span>
<span class="nc" id="L148">         }</span>
      });


<span class="nc" id="L152">      _dlg.chkExecCommand.addActionListener(new ActionListener()</span>
<span class="nc" id="L153">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L156">            onChkExecCommand();</span>
<span class="nc" id="L157">         }</span>
      });

<span class="nc" id="L160">      _dlg.btnFile.addActionListener(new ActionListener()</span>
<span class="nc" id="L161">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L164">            onFile();</span>
<span class="nc" id="L165">         }</span>

      });

<span class="nc" id="L169">      _dlg.btnCommandFile.addActionListener(new ActionListener()</span>
<span class="nc" id="L170">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L173">            onCommandFile();</span>
<span class="nc" id="L174">         }</span>
      });
<span class="nc" id="L176">   }</span>

   private void onFormat(boolean replaceEnding)
   {

<span class="nc bnc" id="L181" title="All 2 branches missed.">      if (_dlg.radFormatCSV.isSelected())</span>
      {
<span class="nc" id="L183">         _dlg.lblSeparator.setEnabled(true);</span>
<span class="nc" id="L184">         _dlg.chkSeparatorTab.setEnabled(true);</span>
<span class="nc" id="L185">         _dlg.txtSeparatorChar.setEnabled(true);</span>
<span class="nc" id="L186">         _dlg.lblCharset.setEnabled(true);</span>
<span class="nc" id="L187">         _dlg.charsets.setEnabled(true);</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">         if(_dlg.chkSeparatorTab.isSelected())</span>
         {
<span class="nc" id="L191">            _dlg.txtSeparatorChar.setText(null);</span>
<span class="nc" id="L192">            _dlg.txtSeparatorChar.setEnabled(false);</span>
<span class="nc" id="L193">            _dlg.lblSeparator.setEnabled(false);</span>
         }
         else
         {
<span class="nc" id="L197">            _dlg.txtSeparatorChar.setEnabled(true);</span>
<span class="nc" id="L198">            _dlg.lblSeparator.setEnabled(true);</span>
         }

<span class="nc bnc" id="L201" title="All 2 branches missed.">         if(replaceEnding)</span>
         {
<span class="nc" id="L203">            replaceFileEnding();</span>
         }
      }
<span class="nc bnc" id="L206" title="All 2 branches missed.">      else if (_dlg.radFormatXLS.isSelected())</span>
      {
<span class="nc" id="L208">         _dlg.lblSeparator.setEnabled(false);</span>
<span class="nc" id="L209">         _dlg.lblCharset.setEnabled(false);</span>
<span class="nc" id="L210">         _dlg.chkSeparatorTab.setEnabled(false);</span>
<span class="nc" id="L211">         _dlg.txtSeparatorChar.setEnabled(false);</span>
<span class="nc" id="L212">         _dlg.charsets.setEnabled(false);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">         if(replaceEnding)</span>
         {
<span class="nc" id="L215">            replaceFileEnding();</span>
         }
      }
<span class="nc bnc" id="L218" title="All 2 branches missed.">      else if (_dlg.radFormatXML.isSelected())</span>
      {
<span class="nc" id="L220">         _dlg.lblSeparator.setEnabled(false);</span>
<span class="nc" id="L221">         _dlg.lblCharset.setEnabled(false);</span>
<span class="nc" id="L222">         _dlg.chkSeparatorTab.setEnabled(false);</span>
<span class="nc" id="L223">         _dlg.txtSeparatorChar.setEnabled(false);</span>
<span class="nc" id="L224">         _dlg.charsets.setEnabled(false);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">         if(replaceEnding)</span>
         {
<span class="nc" id="L227">            replaceFileEnding();</span>
         }
      }
      else
      {
<span class="nc" id="L232">         throw new IllegalStateException(&quot;No valid output format&quot;);</span>
      }
<span class="nc" id="L234">   }</span>

   private void replaceFileEnding()
   {
      String newEnding;

<span class="nc bnc" id="L240" title="All 2 branches missed.">      if (_dlg.radFormatCSV.isSelected())</span>
      {
<span class="nc" id="L242">         newEnding = &quot;csv&quot;;</span>
      }
<span class="nc bnc" id="L244" title="All 2 branches missed.">      else if (_dlg.radFormatXLS.isSelected())</span>
      {
<span class="nc" id="L246">         newEnding = &quot;xls&quot;;</span>
      }
<span class="nc bnc" id="L248" title="All 2 branches missed.">      else if (_dlg.radFormatXML.isSelected())</span>
      {
<span class="nc" id="L250">         newEnding = &quot;xml&quot;;</span>
      }
      else
      {
<span class="nc" id="L254">         throw new IllegalStateException(&quot;No valid output format&quot;);</span>
      }

<span class="nc" id="L257">      String file = _dlg.txtFile.getText();</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">      if(null == file ||</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">         0 == file.trim().length() ||</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">         file.toUpperCase().endsWith(&quot;.&quot; + newEnding.toUpperCase()))</span>
      {
<span class="nc" id="L262">         return;</span>
      }

<span class="nc" id="L265">      file = file.trim();</span>

      String newFile;

<span class="nc bnc" id="L269" title="All 4 branches missed.">      if(-1 == file.lastIndexOf(&quot;.&quot;) || file.lastIndexOf(&quot;.&quot;) &lt; file.lastIndexOf(File.separator))</span>
      {
<span class="nc" id="L271">         newFile = file + &quot;.&quot; + newEnding;</span>
      }
<span class="nc bnc" id="L273" title="All 2 branches missed.">      else if(file.lastIndexOf(&quot;.&quot;) &gt; file.lastIndexOf(File.separator))</span>
      {
<span class="nc" id="L275">         newFile = file.substring(0, file.lastIndexOf(&quot;.&quot;)) + &quot;.&quot; + newEnding;</span>
      }
      else
      {
<span class="nc" id="L279">         newFile = file;</span>
      }
      
<span class="nc" id="L282">      _dlg.txtFile.setText(newFile);</span>
<span class="nc" id="L283">   }</span>

   private void onCommandFile()
   {
<span class="nc" id="L287">      JFileChooser chooser = new JFileChooser(System.getProperties().getProperty(&quot;user.home&quot;));</span>
<span class="nc" id="L288">      chooser.setFileSelectionMode(JFileChooser.FILES_AND_DIRECTORIES);</span>

      // i18n[TableExportCsvController.commandChooserTitel=Choose command executable]
<span class="nc" id="L291">      chooser.setDialogTitle(s_stringMgr.getString(&quot;TableExportCsvController.commandChooserTitel&quot;));</span>

      // i18n[TableExportCsvController.commandChooserButton=Choose]
<span class="nc bnc" id="L294" title="All 2 branches missed.">      if(JFileChooser.APPROVE_OPTION != chooser.showDialog(_dlg, s_stringMgr.getString(&quot;TableExportCsvController.commandChooserButton&quot;)))</span>
      {
<span class="nc" id="L296">         return;</span>
      }

<span class="nc bnc" id="L299" title="All 2 branches missed.">      if(null != chooser.getSelectedFile())</span>
      {
<span class="nc" id="L301">         _dlg.txtCommand.setText(chooser.getSelectedFile().getPath() + &quot; %file&quot;);</span>
      }
<span class="nc" id="L303">   }</span>


   private void onFile()
   {
<span class="nc" id="L308">      JFileChooser chooser = null;</span>

<span class="nc" id="L310">      String csvFileName = _dlg.txtFile.getText();</span>
<span class="nc bnc" id="L311" title="All 4 branches missed.">      if(null != csvFileName &amp;&amp; 0 &lt; csvFileName.trim().length())</span>
      {
<span class="nc" id="L313">         File csvFile = new File(csvFileName);</span>

<span class="nc" id="L315">         File parentFile = csvFile.getParentFile();</span>
<span class="nc bnc" id="L316" title="All 4 branches missed.">         if(null != parentFile &amp;&amp; parentFile.exists())</span>
         {
<span class="nc" id="L318">            chooser = new JFileChooser(parentFile);</span>
         }
      }

<span class="nc bnc" id="L322" title="All 2 branches missed.">      if(null == chooser)</span>
      {
<span class="nc" id="L324">         chooser = new JFileChooser(System.getProperties().getProperty(&quot;user.home&quot;));</span>
      }


<span class="nc" id="L328">      chooser.setFileSelectionMode(JFileChooser.FILES_ONLY);</span>

      // i18n[TableExportCsvController.fileChooserTitel=Choose export file]
<span class="nc" id="L331">      chooser.setDialogTitle(s_stringMgr.getString(&quot;TableExportCsvController.fileChooserTitel&quot;));</span>

      // i18n[TableExportCsvController.fileChooserButton=Choose]
<span class="nc bnc" id="L334" title="All 2 branches missed.">      if(JFileChooser.APPROVE_OPTION != chooser.showDialog(_dlg, s_stringMgr.getString(&quot;TableExportCsvController.fileChooserButton&quot;)))</span>
      {
<span class="nc" id="L336">         return;</span>
      }


<span class="nc bnc" id="L340" title="All 2 branches missed.">      if(null != chooser.getSelectedFile())</span>
      {
<span class="nc" id="L342">         _dlg.txtFile.setText(chooser.getSelectedFile().getPath());</span>
      }

<span class="nc" id="L345">   }</span>


   private void onOK()
   {
<span class="nc bnc" id="L350" title="All 2 branches missed.">	  if(warnIfExcel() == false){</span>
<span class="nc" id="L351">		  return;</span>
	  }
	   
<span class="nc" id="L354">      String csvFileName = _dlg.txtFile.getText();</span>
<span class="nc bnc" id="L355" title="All 4 branches missed.">      if(null == csvFileName || 0 == csvFileName.trim().length())</span>
      {
         // i18n[TableExportCsvController.noFile=You must provide a export file name.]
<span class="nc" id="L358">         String msg = s_stringMgr.getString(&quot;TableExportCsvController.noFile&quot;);</span>
<span class="nc" id="L359">         JOptionPane.showMessageDialog(_dlg, msg);</span>
<span class="nc" id="L360">         return;</span>
      }

<span class="nc bnc" id="L363" title="All 2 branches missed.">      if(false == _dlg.chkSeparatorTab.isSelected())</span>
      {
<span class="nc" id="L365">         String sepChar = _dlg.txtSeparatorChar.getText();</span>
<span class="nc bnc" id="L366" title="All 4 branches missed.">         if(null == sepChar || 1 != sepChar.trim().length())</span>
         {
            // i18n[TableExportCsvController.invalidSeparator=You must provide a single separator character or check &quot;Use tab&quot; to use the tab character.]
<span class="nc" id="L369">            String msg = s_stringMgr.getString(&quot;TableExportCsvController.invalidSeparator&quot;);</span>
<span class="nc" id="L370">            JOptionPane.showMessageDialog(_dlg, msg);</span>
<span class="nc" id="L371">            return;</span>
         }
      }


<span class="nc bnc" id="L376" title="All 2 branches missed.">      if(_dlg.chkExecCommand.isSelected())</span>
      {
<span class="nc" id="L378">         String command = _dlg.txtCommand.getText();</span>
<span class="nc bnc" id="L379" title="All 4 branches missed.">         if(null == command || 0 == command.trim().length())</span>
         {
            // i18n[TableExportCsvController.noCommand=You must provide a command string or uncheck &quot;Execute command&quot;.]
<span class="nc" id="L382">            String msg = s_stringMgr.getString(&quot;TableExportCsvController.noCommand&quot;);</span>
<span class="nc" id="L383">            JOptionPane.showMessageDialog(_dlg, msg);</span>
<span class="nc" id="L384">            return;</span>
         }
      }

<span class="nc bnc" id="L388" title="All 2 branches missed.">      if(new File(csvFileName).exists())</span>
      {
         // i18n[TableExportCsvController.replaceFile=The export file already exisits. Would you like to replace it?]
<span class="nc" id="L391">         String msg = s_stringMgr.getString(&quot;TableExportCsvController.replaceFile&quot;);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">         if(JOptionPane.OK_OPTION != JOptionPane.showConfirmDialog(_dlg, msg))</span>
         {
<span class="nc" id="L394">            return;</span>
         }
      }

<span class="nc" id="L398">      writePrefs();</span>
<span class="nc" id="L399">      _ok = true;</span>
<span class="nc" id="L400">      closeDlg();</span>
<span class="nc" id="L401">   }</span>




   /**
    * Warn the user if we should export the data into a Excel file.
    * Exporting a excel file may use a huge amount of memory and can cause some problems within MS Excel.
    * @return true, if the user wishes to continue.
    */
   private boolean warnIfExcel() {
<span class="nc bnc" id="L412" title="All 4 branches missed.">	   if(this._dlg.radFormatXLS.isSelected() &amp;&amp; shouldWarnIfExcel()){</span>
		   // i18n[TableExportCsvController.warnIfExcel=Exporting a huge data set for MS Excel maybe use huge memory.]
<span class="nc" id="L414">		   String msg = s_stringMgr.getString(&quot;TableExportCsvController.warnIfExcel&quot;);</span>
<span class="nc" id="L415">		   int option = JOptionPane.showConfirmDialog(_dlg, msg, null, JOptionPane.OK_CANCEL_OPTION);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">		   if(option != JOptionPane.OK_OPTION){</span>
<span class="nc" id="L417">			   return false;</span>
		   }		
	   }
<span class="nc" id="L420">	   return true;</span>
   }
   /**
    * Decide, if we want warn the user, if the choose the Excel export.
    * This default implementation returns always false.
    * @return true, if we should warn.
    */
   protected boolean shouldWarnIfExcel(){
<span class="nc" id="L428">	   return false;</span>
   }

protected void writePrefs()
   {
<span class="nc" id="L433">      Preferences.userRoot().put(PREF_KEY_CSV_FILE, _dlg.txtFile.getText());</span>
<span class="nc" id="L434">      Preferences.userRoot().put(PREF_KEY_CSV_ENCODING, _dlg.charsets.getSelectedItem().toString());</span>
<span class="nc" id="L435">      Preferences.userRoot().putBoolean(PREF_KEY_WITH_HEADERS, _dlg.chkWithHeaders.isSelected());</span>
<span class="nc" id="L436">      Preferences.userRoot().putBoolean(PREF_KEY_FORMAT_CSV, _dlg.radFormatCSV.isSelected());</span>
<span class="nc" id="L437">      Preferences.userRoot().putBoolean(PREF_KEY_FORMAT_XLS, _dlg.radFormatXLS.isSelected());</span>
<span class="nc" id="L438">      Preferences.userRoot().putBoolean(PREF_KEY_FORMAT_XML, _dlg.radFormatXML.isSelected());</span>
<span class="nc" id="L439">      Preferences.userRoot().putBoolean(PREF_KEY_SEPERATOR_TAB, _dlg.chkSeparatorTab.isSelected());</span>
<span class="nc" id="L440">      Preferences.userRoot().put(PREF_KEY_SEPERATOR_CHAR, _dlg.txtSeparatorChar.getText());</span>
<span class="nc" id="L441">      Preferences.userRoot().put(PREF_KEY_LINE_SEPERATOR, ((LineSeparator)_dlg._lineSeparators.getSelectedItem()).name());</span>
<span class="nc" id="L442">      Preferences.userRoot().putBoolean(PREF_KEY_EXPORT_COMPLETE, _dlg.radComplete.isSelected());</span>
<span class="nc" id="L443">      Preferences.userRoot().putBoolean(PREF_KEY_USE_GLOBAL_PREFS_FORMATING, _dlg.radUseGlobalPrefsFormating.isSelected());</span>
<span class="nc" id="L444">      Preferences.userRoot().putBoolean(PREF_KEY_EXECUTE_COMMAND, _dlg.chkExecCommand.isSelected());</span>
<span class="nc" id="L445">      Preferences.userRoot().put(PREF_KEY_COMMAND, _dlg.txtCommand.getText());</span>
<span class="nc" id="L446">   }</span>

	
   private void initDlg()
   {
<span class="nc" id="L451">      Preferences userRoot = Preferences.userRoot();</span>
<span class="nc" id="L452">		_dlg.txtFile.setText(userRoot.get(PREF_KEY_CSV_FILE, null));</span>
<span class="nc" id="L453">      _dlg.charsets.setSelectedItem(userRoot.get(PREF_KEY_CSV_ENCODING, Charset.defaultCharset().name()));</span>
<span class="nc" id="L454">      _dlg.chkWithHeaders.setSelected(userRoot.getBoolean(PREF_KEY_WITH_HEADERS, true));</span>


<span class="nc" id="L457">      _dlg.chkSeparatorTab.setSelected(userRoot.getBoolean(PREF_KEY_SEPERATOR_TAB, false));</span>

<span class="nc bnc" id="L459" title="All 2 branches missed.">      if(false == _dlg.chkSeparatorTab.isSelected())</span>
      {
<span class="nc" id="L461">         _dlg.txtSeparatorChar.setText(userRoot.get(PREF_KEY_SEPERATOR_CHAR, &quot;,&quot;));</span>
      }

<span class="nc bnc" id="L464" title="All 2 branches missed.">      if(userRoot.getBoolean(PREF_KEY_FORMAT_CSV, true))</span>
      {
<span class="nc" id="L466">         _dlg.radFormatCSV.setSelected(true);</span>
      }
<span class="nc bnc" id="L468" title="All 2 branches missed.">      else if(userRoot.getBoolean(PREF_KEY_FORMAT_XLS, false))</span>
      {
<span class="nc" id="L470">         _dlg.radFormatXLS.setSelected(true);</span>
      }
<span class="nc bnc" id="L472" title="All 2 branches missed.">      else if(userRoot.getBoolean(PREF_KEY_FORMAT_XML, false))</span>
      {
<span class="nc" id="L474">         _dlg.radFormatXML.setSelected(true);</span>
      }
      else
      {
<span class="nc" id="L478">         _dlg.radFormatCSV.setSelected(true);</span>
      }


<span class="nc" id="L482">      onFormat(false);</span>



<span class="nc" id="L486">      initSelectionPanel(userRoot);</span>

<span class="nc bnc" id="L488" title="All 2 branches missed.">      if(userRoot.getBoolean(PREF_KEY_USE_GLOBAL_PREFS_FORMATING, true))</span>
      {
<span class="nc" id="L490">         _dlg.radUseGlobalPrefsFormating.setSelected(true);</span>
      }
      else
      {
<span class="nc" id="L494">         _dlg.radUseDefaultFormating.setSelected(true);</span>
      }


<span class="nc" id="L498">      _dlg.chkExecCommand.setSelected(userRoot.getBoolean(PREF_KEY_EXECUTE_COMMAND, false));</span>
<span class="nc" id="L499">      onChkExecCommand();</span>

<span class="nc" id="L501">      _dlg.txtCommand.setText(userRoot.get(PREF_KEY_COMMAND, &quot;openoffice.org-2.0 -calc %file&quot;));</span>
      
<span class="nc" id="L503">      LineSeparator preferredLineSeparator = </span>
<span class="nc" id="L504">      	LineSeparator.valueOf(userRoot.get(PREF_KEY_LINE_SEPERATOR, LineSeparator.DEFAULT.name()));</span>
      
<span class="nc" id="L506">      _dlg._lineSeparators.setSelectedItem(preferredLineSeparator);</span>
<span class="nc" id="L507">   }</span>

   /**
    * Initialize the values for the selection panel from the saved properties.
    * @param userRoot the saved properties.
    */
   protected void initSelectionPanel(Preferences userRoot) {
<span class="nc bnc" id="L514" title="All 2 branches missed.">	   if(userRoot.getBoolean(PREF_KEY_EXPORT_COMPLETE, true))</span>
	   {
<span class="nc" id="L516">		   _dlg.radComplete.setSelected(true);</span>
	   }
	   else
	   {
<span class="nc" id="L520">		   _dlg.radSelection.setSelected(true);</span>
	   }
<span class="nc" id="L522">   }</span>

   private void onChkExecCommand()
   {
<span class="nc" id="L526">      _dlg.txtCommand.setEnabled(_dlg.chkExecCommand.isSelected());</span>
<span class="nc" id="L527">      _dlg.btnCommandFile.setEnabled(_dlg.chkExecCommand.isSelected());</span>
<span class="nc" id="L528">   }</span>


   private void installEscapeClose()
   {
<span class="nc" id="L533">      AbstractAction closeAction = new AbstractAction()</span>
<span class="nc" id="L534">      {</span>
			private static final long serialVersionUID = 1L;

			public void actionPerformed(ActionEvent actionEvent)
         {
<span class="nc" id="L539">            closeDlg();</span>
<span class="nc" id="L540">         }</span>
      };
<span class="nc" id="L542">      KeyStroke escapeStroke = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</span>
<span class="nc" id="L543">      _dlg.getRootPane().getInputMap(JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L544">      _dlg.getRootPane().getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L545">      _dlg.getRootPane().getInputMap(JComponent.WHEN_FOCUSED).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L546">      _dlg.getRootPane().getActionMap().put(&quot;CloseAction&quot;, closeAction);</span>
<span class="nc" id="L547">   }</span>

   private void closeDlg()
   {
<span class="nc" id="L551">      _dlg.setVisible(false);</span>
<span class="nc" id="L552">      _dlg.dispose();</span>
<span class="nc" id="L553">   }</span>

   boolean isOK()
   {
<span class="nc" id="L557">      return _ok;</span>
   }

   File getFile()
   {
<span class="nc" id="L562">      return new File(_dlg.txtFile.getText());</span>
   }

   public String getSeparatorChar()
   {
<span class="nc bnc" id="L567" title="All 2 branches missed.">      if(_dlg.chkSeparatorTab.isSelected())</span>
      {
<span class="nc" id="L569">         return &quot;\t&quot;;</span>
      }
      else
      {
<span class="nc" id="L573">         return _dlg.txtSeparatorChar.getText();</span>
      }
   }
   
   public String getLineSeparator() {
<span class="nc" id="L578">   	LineSeparator lineSepChoice = (LineSeparator)_dlg._lineSeparators.getSelectedItem();</span>
<span class="nc" id="L579">   	String result = null;</span>
<span class="nc bnc" id="L580" title="All 4 branches missed.">   	switch (lineSepChoice) {</span>
   	case DEFAULT:
<span class="nc" id="L582">   		result = System.getProperty(&quot;line.separator&quot;);</span>
<span class="nc" id="L583">   		break;</span>
   	case LF:
<span class="nc" id="L585">   		result = &quot;\n&quot;;</span>
<span class="nc" id="L586">   		break;</span>
   	case CRLF:
<span class="nc" id="L588">   		result = &quot;\r\n&quot;;</span>
   		break;
   	}
<span class="nc" id="L591">   	return result;</span>
   }
   
   public Charset getCSVCharset() {
	   try {
<span class="nc" id="L596">		   return Charset.forName(_dlg.charsets.getSelectedItem().toString());</span>
<span class="nc" id="L597">	   } catch (IllegalCharsetNameException icne) {</span>
<span class="nc" id="L598">		   return Charset.defaultCharset();</span>
	   }
   }

   boolean includeHeaders()
   {
<span class="nc" id="L604">      return _dlg.chkWithHeaders.isSelected();</span>
   }

   boolean exportComplete()
   {
<span class="nc" id="L609">      return _dlg.radComplete.isSelected();</span>
   }

   public boolean useGloablPrefsFormatting()
   {
<span class="nc" id="L614">      return _dlg.radUseGlobalPrefsFormating.isSelected();</span>
   }

   String getCommand()
   {
<span class="nc bnc" id="L619" title="All 2 branches missed.">      if(_dlg.chkExecCommand.isSelected())</span>
      {
         // Copied from Java Doc Matcher.replaceAll:
         //
         // Note that backslashes (\) and dollar signs ($) in the replacement string
         // may cause the results to be different than if it
         // were being treated as a literal replacement string.
         // Dollar signs may be treated as references to
         // captured subsequences as described above, and
         // backslashes are used to escape literal characters in the replacement string.
<span class="nc" id="L629">         return _dlg.txtCommand.getText().replaceAll(&quot;%file&quot;, _dlg.txtFile.getText().replaceAll(&quot;\\\\&quot;,&quot;\\\\\\\\&quot;));</span>
      }
      else
      {
<span class="nc" id="L633">         return null;</span>
      }
   }

   public int getExportFormat()
   {
<span class="nc bnc" id="L639" title="All 2 branches missed.">      if(_dlg.radFormatCSV.isSelected())</span>
      {
<span class="nc" id="L641">         return EXPORT_FORMAT_CSV;</span>
      }
<span class="nc bnc" id="L643" title="All 2 branches missed.">      else if(_dlg.radFormatXLS.isSelected())</span>
      {
<span class="nc" id="L645">         return EXPORT_FORMAT_XLS;</span>
      }
<span class="nc bnc" id="L647" title="All 2 branches missed.">      else if(_dlg.radFormatXML.isSelected())</span>
      {
<span class="nc" id="L649">         return EXPORT_FORMAT_XML;</span>
      }
      else
      {
<span class="nc" id="L653">         throw new IllegalStateException(&quot;No valid output format&quot;);</span>
      }

   }
   
   protected TableExportCsvDlg getDialog() {
<span class="nc" id="L659">	   return this._dlg;</span>
   }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>