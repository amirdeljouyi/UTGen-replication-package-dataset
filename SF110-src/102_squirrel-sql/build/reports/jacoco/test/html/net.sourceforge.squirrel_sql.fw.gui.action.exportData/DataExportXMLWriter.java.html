<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataExportXMLWriter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.fw.gui.action.exportData</a> &gt; <span class="el_source">DataExportXMLWriter.java</span></div><h1>DataExportXMLWriter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011 Stefan Willinger
 * wis775@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
package net.sourceforge.squirrel_sql.fw.gui.action.exportData;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.PrintStream;
import java.util.Iterator;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import net.sourceforge.squirrel_sql.fw.datasetviewer.cellcomponent.CellComponentFactory;
import net.sourceforge.squirrel_sql.fw.gui.action.TableExportCsvController;
import net.sourceforge.squirrel_sql.fw.sql.ProgressAbortCallback;

import org.w3c.dom.Document;
import org.w3c.dom.Element;


/**
 * Exports {@link IExportData} into a XML File.
 * &lt;p&gt;
 * Uses DOM for output
 * &lt;/p&gt;
 * &lt;b&gt;Note:&lt;/b&gt; This class is the result of a refactoring task. The code was taken from TableExportCsvCommand.
 * @author Stefan Willinger
 *
 */
public class DataExportXMLWriter extends AbstractDataExportFileWriter {
	
	private DocumentBuilderFactory factory;
	private DocumentBuilder builder;
	private Document testDoc;
	private Element columns;
	private Element root;
	private Element rows;
	private Element row;

	
	

	/**
	 * @param file
	 * @param ctrl
	 * @param includeHeaders
	 * @param progressController 
	 */
	public DataExportXMLWriter(File file, TableExportCsvController ctrl, boolean includeHeaders, ProgressAbortCallback progressController) {
<span class="nc" id="L73">		super(file, ctrl, includeHeaders, progressController);</span>
<span class="nc" id="L74">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#afterWorking()
	 */
	@Override
	protected void afterWorking() throws Exception {
		
		// The XML document we created above is still in memory
		// so we have to output it to a real file.
		// In order to do it we first have to create
		// an instance of DOMSource
<span class="nc" id="L86">		DOMSource source = new DOMSource(testDoc);</span>

		// PrintStream will be responsible for writing
		// the text data to the file
<span class="nc" id="L90">		PrintStream ps = new PrintStream(getFile());</span>
<span class="nc" id="L91">		StreamResult result = new StreamResult(ps);</span>

		// Once again we are using a factory of some sort,
		// this time for getting a Transformer instance,
		// which we use to output the XML
<span class="nc" id="L96">		TransformerFactory transformerFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L97">		Transformer transformer = transformerFactory.newTransformer();</span>

		// Indenting the XML
<span class="nc" id="L100">		transformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>

		// The actual output to a file goes here
<span class="nc" id="L103">		transformer.transform(source, result);</span>
<span class="nc" id="L104">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#addCell(int, int, net.sourceforge.squirrel_sql.fw.gui.action.exportData.IExportDataCell)
	 */
	@Override
	protected void addCell(IExportDataCell cell) throws Exception {
<span class="nc" id="L111">		String strCellValue = &quot;&quot;;</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">		if(cell.getObject() != null){</span>
<span class="nc bnc" id="L113" title="All 4 branches missed.">			if (getCtrl().useGloablPrefsFormatting() &amp;&amp; cell.getColumnDisplayDefinition() != null){</span>
<span class="nc" id="L114">				strCellValue = CellComponentFactory.renderObject(cell.getObject(), cell.getColumnDisplayDefinition());</span>
			} else {
<span class="nc" id="L116">				strCellValue = cell.getObject().toString();</span>
			}
		}
		
<span class="nc" id="L120">		Element value = testDoc.createElement(&quot;value&quot;);</span>
<span class="nc" id="L121">		value.setAttribute(&quot;columnNumber&quot;, String.valueOf(cell.getColumnIndex()));</span>
<span class="nc" id="L122">		value.setTextContent(strCellValue);</span>
<span class="nc" id="L123">		row.appendChild(value);		</span>
<span class="nc" id="L124">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#addHeaderCell(int, int, java.lang.String)
	 */
	@Override
	protected void addHeaderCell(int colIdx, String columnName) throws Exception {
<span class="nc" id="L131">		Element columnEl = testDoc.createElement(&quot;column&quot;);</span>
<span class="nc" id="L132">		columnEl.setAttribute(&quot;number&quot;, String.valueOf(colIdx));</span>
<span class="nc" id="L133">		columns.appendChild(columnEl);</span>

<span class="nc" id="L135">		Element columnNameEl = testDoc.createElement(&quot;name&quot;);</span>
<span class="nc" id="L136">		columnNameEl.setTextContent(columnName);</span>
<span class="nc" id="L137">		columnEl.appendChild(columnNameEl);</span>
		
<span class="nc" id="L139">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#beforeWorking(java.io.File)
	 */
	@Override
	protected void beforeWorking(File file) throws Exception {
		// Using a factory to get DocumentBuilder for creating XML's
<span class="nc" id="L147">		factory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L148">		builder = factory.newDocumentBuilder();</span>

		// Here instead of parsing an existing document we want to
		// create a new one.
<span class="nc" id="L152">		testDoc = builder.newDocument();</span>

		// 'table' is the main tag in the XML.
<span class="nc" id="L155">		root = testDoc.createElement(&quot;table&quot;);</span>
<span class="nc" id="L156">		testDoc.appendChild(root);</span>

		// 'columns' tag will contain informations about columns
<span class="nc" id="L159">		columns = testDoc.createElement(&quot;columns&quot;);</span>
<span class="nc" id="L160">		root.appendChild(columns);</span>
<span class="nc" id="L161">		int curRow = 0;		</span>
<span class="nc" id="L162">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#beforeRow()
	 */
	@Override
	public void beforeRow(int rowIdx) throws Exception {
<span class="nc" id="L169">		super.beforeRow(rowIdx);</span>
<span class="nc" id="L170">		row = testDoc.createElement(&quot;row&quot;);</span>
<span class="nc" id="L171">		row.setAttribute(&quot;rowNumber&quot;, String.valueOf(rowIdx));</span>
<span class="nc" id="L172">		rows.appendChild(row);</span>
<span class="nc" id="L173">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#beforeRows()
	 */
	@Override
	public void beforeRows() {
<span class="nc" id="L180">		super.beforeRows();</span>
		// 'rows' tag contains the data extracted from the table
<span class="nc" id="L182">		rows = testDoc.createElement(&quot;rows&quot;);</span>
<span class="nc" id="L183">		root.appendChild(rows);</span>
<span class="nc" id="L184">	}</span>
	
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>