<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataExportExcelWriter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.fw.gui.action.exportData</a> &gt; <span class="el_source">DataExportExcelWriter.java</span></div><h1>DataExportExcelWriter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2011 Stefan Willinger
 * wis775@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
package net.sourceforge.squirrel_sql.fw.gui.action.exportData;

import java.io.File;
import java.io.IOException;
import java.sql.Types;
import java.util.Calendar;

import jxl.Workbook;
import jxl.write.WritableCell;
import jxl.write.WritableSheet;
import jxl.write.WritableWorkbook;
import net.sourceforge.squirrel_sql.fw.datasetviewer.ColumnDisplayDefinition;
import net.sourceforge.squirrel_sql.fw.datasetviewer.cellcomponent.CellComponentFactory;
import net.sourceforge.squirrel_sql.fw.gui.action.TableExportCsvController;
import net.sourceforge.squirrel_sql.fw.sql.ProgressAbortCallback;

/**
 * Exports {@link IExportData} to a Excel file.
 * &lt;b&gt;Note:&lt;/b&gt; This class is the result of a refactoring task. The code was taken from TableExportCsvCommand.
 * @author Stefan Willinger
 *
 */
public class DataExportExcelWriter extends AbstractDataExportFileWriter {
	private WritableWorkbook workbook;
	private WritableSheet sheet;
<span class="nc" id="L44">	private boolean withHeader = false;</span>
	
	

	/**
	 * @param file
	 * @param ctrl
	 * @param includeHeaders
	 * @param progressController 
	 */
	public DataExportExcelWriter(File file, TableExportCsvController ctrl, boolean includeHeaders, ProgressAbortCallback progressController) {
<span class="nc" id="L55">		super(file, ctrl, includeHeaders, progressController);</span>
<span class="nc" id="L56">	}</span>

	private WritableCell getXlsCell(ColumnDisplayDefinition colDef, int colIdx, int curRow, Object cellObj) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">		if (null == cellObj) {</span>
<span class="nc" id="L60">			return new jxl.write.Label(colIdx, curRow, getDataXLSAsString(cellObj));</span>
		}

<span class="nc bnc" id="L63" title="All 2 branches missed.">		if (null == colDef) {</span>
<span class="nc" id="L64">			return new jxl.write.Label(colIdx, curRow, getDataXLSAsString(cellObj));</span>
		}

		WritableCell ret;
<span class="nc" id="L68">		int colType = colDef.getSqlType();</span>
<span class="nc bnc" id="L69" title="All 12 branches missed.">		switch (colType) {</span>
		case Types.BIT:
		case Types.BOOLEAN:
<span class="nc" id="L72">			ret = new jxl.write.Boolean(colIdx, curRow, (Boolean) cellObj);</span>
<span class="nc" id="L73">			break;</span>
		case Types.INTEGER:
<span class="nc" id="L75">			ret = new jxl.write.Number(colIdx, curRow, ((Number) cellObj).doubleValue());</span>
<span class="nc" id="L76">			break;</span>
		case Types.SMALLINT:
		case Types.TINYINT:
<span class="nc" id="L79">			ret = new jxl.write.Number(colIdx, curRow, ((Number) cellObj).doubleValue());</span>
<span class="nc" id="L80">			break;</span>
		case Types.DECIMAL:
<span class="nc" id="L82">			ret = new jxl.write.Number(colIdx, curRow, ((Number) cellObj).doubleValue());</span>
<span class="nc" id="L83">			break;</span>
		case Types.NUMERIC:
<span class="nc" id="L85">			ret = new jxl.write.Number(colIdx, curRow, ((Number) cellObj).doubleValue());</span>
<span class="nc" id="L86">			break;</span>
		case Types.FLOAT:
<span class="nc" id="L88">			ret = new jxl.write.Number(colIdx, curRow, ((Number) cellObj).doubleValue());</span>
<span class="nc" id="L89">			break;</span>
		case Types.DOUBLE:
<span class="nc" id="L91">			ret = new jxl.write.Number(colIdx, curRow, ((Number) cellObj).doubleValue());</span>
<span class="nc" id="L92">			break;</span>
		case Types.REAL:
<span class="nc" id="L94">			ret = new jxl.write.Number(colIdx, curRow, ((Number) cellObj).doubleValue());</span>
<span class="nc" id="L95">			break;</span>
		case Types.BIGINT:
<span class="nc" id="L97">			ret = new jxl.write.Number(colIdx, curRow, Long.parseLong(cellObj.toString()));</span>
<span class="nc" id="L98">			break;</span>
		case Types.DATE:
		case Types.TIMESTAMP:
		case Types.TIME:
			/* Work around some UTC and Daylight saving offsets */
<span class="nc" id="L103">			long time = (((java.util.Date) cellObj).getTime());</span>

<span class="nc" id="L105">			Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L106">			cal.setTime((java.util.Date) cellObj);</span>

<span class="nc" id="L108">			int offset = (cal.get(Calendar.ZONE_OFFSET) + cal.get(Calendar.DST_OFFSET));</span>

<span class="nc" id="L110">			long utcTime = time + offset;</span>
			/*
			 * Work around Excel's problem with dates before 1900-03-01
			 * http://support.microsoft.com/kb/214058 -2203891200000l is
			 * 1900-03-01 UTC time 8640000 means 24 hours
			 */
<span class="nc bnc" id="L116" title="All 2 branches missed.">			if (utcTime &lt; -2203891200000l) {</span>
<span class="nc" id="L117">				utcTime += 86400000;</span>
			}

<span class="nc" id="L120">			java.util.Date xlsUTCDate = new java.util.Date(utcTime);</span>
<span class="nc" id="L121">			ret = new jxl.write.DateTime(colIdx, curRow, xlsUTCDate, jxl.write.DateTime.GMT);</span>
<span class="nc" id="L122">			break;</span>
		case Types.CHAR:
		case Types.VARCHAR:
		case Types.LONGVARCHAR:
<span class="nc" id="L126">			cellObj = CellComponentFactory.renderObject(cellObj, colDef);</span>
<span class="nc" id="L127">			ret = new jxl.write.Label(colIdx, curRow, getDataXLSAsString(cellObj));</span>
<span class="nc" id="L128">			break;</span>
		default:
<span class="nc" id="L130">			cellObj = CellComponentFactory.renderObject(cellObj, colDef);</span>
<span class="nc" id="L131">			ret = new jxl.write.Label(colIdx, curRow, getDataXLSAsString(cellObj));</span>
		}
<span class="nc" id="L133">		return ret;</span>
	}
	
	private String getDataXLSAsString(Object cellObj) {
<span class="nc bnc" id="L137" title="All 2 branches missed.">		if (cellObj == null) {</span>
<span class="nc" id="L138">			return &quot;&quot;;</span>
		} else {
<span class="nc" id="L140">			return cellObj.toString().trim();</span>
		}
	}

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#beforeWorking()
	 */
	@Override
	protected void beforeWorking(File file) throws IOException{
<span class="nc" id="L149">		this.workbook = Workbook.createWorkbook(file);</span>
<span class="nc" id="L150">		this.sheet = workbook.createSheet(&quot;Squirrel SQL Export&quot;, 0);</span>
<span class="nc" id="L151">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#addHeaderCell(int, java.lang.String)
	 */
	@Override
	protected void addHeaderCell(int colIdx, String columnName) throws Exception {
<span class="nc" id="L158">		this.withHeader = true;</span>
<span class="nc" id="L159">		jxl.write.Label label = new jxl.write.Label(colIdx, 0, columnName);</span>
<span class="nc" id="L160">		sheet.addCell(label);		</span>
<span class="nc" id="L161">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#addCell(net.sourceforge.squirrel_sql.fw.gui.action.TableExportCsvController, int, int, net.sourceforge.squirrel_sql.fw.gui.action.exportData.IExportDataCell)
	 */
	@Override
	protected void addCell(IExportDataCell cell) throws Exception{
		WritableCell xlsCell;
<span class="nc bnc" id="L169" title="All 2 branches missed.">		if (getCtrl().useGloablPrefsFormatting()) {</span>
<span class="nc" id="L170">			xlsCell = getXlsCell(cell.getColumnDisplayDefinition(), cell.getColumnIndex(),</span>
<span class="nc" id="L171">					calculateRowIdx(cell), cell.getObject());</span>
		} else {
<span class="nc" id="L173">			xlsCell = getXlsCell(null, cell.getColumnIndex(), calculateRowIdx(cell), cell.getObject());</span>
		}
<span class="nc" id="L175">		sheet.addCell(xlsCell);		</span>
<span class="nc" id="L176">	}</span>


	/**
	 * @param cell
	 * @return
	 */
	private int calculateRowIdx(IExportDataCell cell) {
<span class="nc bnc" id="L184" title="All 2 branches missed.">		if(this.withHeader ){</span>
<span class="nc" id="L185">			return cell.getRowIndex()+1;</span>
		}else{
<span class="nc" id="L187">			return cell.getRowIndex();</span>
		}
	}

	/**
	 * @see net.sourceforge.squirrel_sql.fw.gui.action.exportData.AbstractDataExportFileWriter#afterWorking()
	 */
	@Override
	protected void afterWorking() throws Exception{
<span class="nc" id="L196">		workbook.write();</span>
<span class="nc" id="L197">		workbook.close();		</span>
<span class="nc" id="L198">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>