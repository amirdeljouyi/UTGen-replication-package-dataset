<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArtifactInstallerImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.update.gui.installer</a> &gt; <span class="el_source">ArtifactInstallerImpl.java</span></div><h1>ArtifactInstallerImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2007 Rob Manning
 * manningr@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
package net.sourceforge.squirrel_sql.client.update.gui.installer;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import javax.swing.SwingUtilities;

import net.sourceforge.squirrel_sql.client.update.UpdateUtil;
import net.sourceforge.squirrel_sql.client.update.gui.ArtifactAction;
import net.sourceforge.squirrel_sql.client.update.gui.ArtifactStatus;
import net.sourceforge.squirrel_sql.client.update.gui.installer.event.InstallEventType;
import net.sourceforge.squirrel_sql.client.update.gui.installer.event.InstallStatusEvent;
import net.sourceforge.squirrel_sql.client.update.gui.installer.event.InstallStatusEventFactory;
import net.sourceforge.squirrel_sql.client.update.gui.installer.event.InstallStatusListener;
import net.sourceforge.squirrel_sql.client.update.gui.installer.util.InstallFileOperationInfo;
import net.sourceforge.squirrel_sql.client.update.gui.installer.util.InstallFileOperationInfoFactory;
import net.sourceforge.squirrel_sql.client.update.xmlbeans.ChangeListXmlBean;
import net.sourceforge.squirrel_sql.fw.util.FileWrapper;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

/**
 * This class is used by the PreLaunchUpdateApplication to install artifact files that belong to a particular
 * change list.
 * 
 * @author manningr
 */
<span class="nc" id="L48">public class ArtifactInstallerImpl implements ArtifactInstaller</span>
{

	/** Logger for this class. */
<span class="nc" id="L52">	private static ILogger s_log = LoggerController.createLogger(ArtifactInstallerImpl.class);</span>

	/**
	 * this list is derived from the changelist xmlbean. It will only contain the artifacts that need to be
	 * change (installed, removed).
	 */
<span class="nc" id="L58">	private List&lt;ArtifactStatus&gt; _changeList = null;</span>

	/** listeners to notify of important install events */
<span class="nc" id="L61">	private List&lt;InstallStatusListener&gt; _listeners = new ArrayList&lt;InstallStatusListener&gt;();</span>

	/**
	 * the top-level directory beneath which reside all files needed for updating the application (e.g.
	 * /opt/squirrel/update)
	 */
<span class="nc" id="L67">	private FileWrapper updateDir = null;</span>

	// Download directories

	/** the downlaods root directory (e.g. /opt/squirrel/update/downloads) */
<span class="nc" id="L72">	private FileWrapper downloadsRootDir = null;</span>

	/** the core sub-directory of the backup directory (e.g. /opt/squirrel/update/downloads/core) */
<span class="nc" id="L75">	private FileWrapper coreDownloadsDir = null;</span>

	/** the plugin sub-directory of the backup directory (e.g. /opt/squirrel/update/downloads/plugin) */
<span class="nc" id="L78">	private FileWrapper pluginDownloadsDir = null;</span>

	/** the i18n sub-directory of the backup directory (e.g. /opt/squirrel/update/downloads/i18n) */
<span class="nc" id="L81">	private FileWrapper i18nDownloadsDir = null;</span>

	// Backup directories

	/** the backup directory (e.g. /opt/squirrel/update/backup) */
<span class="nc" id="L86">	private FileWrapper backupRootDir = null;</span>

	/** the core sub-directory of the backup directory (e.g. /opt/squirrel/update/backup/core) */
<span class="nc" id="L89">	private FileWrapper coreBackupDir = null;</span>

	/** the plugin sub-directory of the backup directory (e.g. /opt/squirrel/update/backup/plugin) */
<span class="nc" id="L92">	private FileWrapper pluginBackupDir = null;</span>

	/** the i18n sub-directory of the backup directory (e.g. /opt/squirrel/update/backup/i18n) */
<span class="nc" id="L95">	private FileWrapper translationBackupDir = null;</span>

	// Install directories

	/** the top-level SQuirreL installation direction where launch scripts are (e.g. /opt/squirrel) */
<span class="nc" id="L100">	private FileWrapper installRootDir = null;</span>

	/** the lib directory where most core jars are (e.g. /opt/squirrel/lib) */
<span class="nc" id="L103">	private FileWrapper coreInstallDir = null;</span>

	/** the plugins directory where all of the plugin files are (e.g. /opt/squirrel/plugins) */
<span class="nc" id="L106">	private FileWrapper pluginInstallDir = null;</span>

	/** the lib directory where translation jars are (e.g. /opt/squirrel/lib) */
<span class="nc" id="L109">	private FileWrapper i18nInstallDir = null;</span>

	/**
	 * the file that was used to build a ChangeListXmlBean that we are using to determine which files need to
	 * be installed/removed
	 */
<span class="nc" id="L115">	private FileWrapper changeListFile = null;</span>

	/* Spring-injected dependencies */

	/** Spring-injected factory for creating install events */
<span class="nc" id="L120">	private InstallStatusEventFactory installStatusEventFactory = null;</span>

	public void setInstallStatusEventFactory(InstallStatusEventFactory installStatusEventFactory)
	{
<span class="nc" id="L124">		this.installStatusEventFactory = installStatusEventFactory;</span>
<span class="nc" id="L125">	}</span>

	/** Spring-injected factory for creating file operation infos */
<span class="nc" id="L128">	private InstallFileOperationInfoFactory installFileOperationInfoFactory = null;</span>

	public void setInstallFileOperationInfoFactory(
		InstallFileOperationInfoFactory installFileOperationInfoFactory)
	{
<span class="nc" id="L133">		this.installFileOperationInfoFactory = installFileOperationInfoFactory;</span>
<span class="nc" id="L134">	}</span>

	/** Utility which provides path information and abstraction to file operations */
<span class="nc" id="L137">	private UpdateUtil _util = null;</span>

	public void setUpdateUtil(UpdateUtil util)
	{
<span class="nc" id="L141">		this._util = util;</span>
<span class="nc" id="L142">		updateDir = _util.getSquirrelUpdateDir();</span>
<span class="nc" id="L143">		backupRootDir = _util.checkDir(updateDir, UpdateUtil.BACKUP_ROOT_DIR_NAME);</span>
<span class="nc" id="L144">		downloadsRootDir = _util.checkDir(updateDir, UpdateUtil.DOWNLOADS_DIR_NAME);</span>

<span class="nc" id="L146">		coreBackupDir = _util.checkDir(backupRootDir, UpdateUtil.CORE_ARTIFACT_ID);</span>
<span class="nc" id="L147">		pluginBackupDir = _util.checkDir(backupRootDir, UpdateUtil.PLUGIN_ARTIFACT_ID);</span>
<span class="nc" id="L148">		translationBackupDir = _util.checkDir(backupRootDir, UpdateUtil.TRANSLATION_ARTIFACT_ID);</span>

<span class="nc" id="L150">		installRootDir = _util.getSquirrelHomeDir();</span>

<span class="nc" id="L152">		coreInstallDir = _util.getSquirrelLibraryDir();</span>
<span class="nc" id="L153">		pluginInstallDir = _util.getSquirrelPluginsDir();</span>
<span class="nc" id="L154">		i18nInstallDir = _util.getSquirrelLibraryDir();</span>

<span class="nc" id="L156">		coreDownloadsDir = _util.getCoreDownloadsDir();</span>
<span class="nc" id="L157">		pluginDownloadsDir = _util.getPluginDownloadsDir();</span>
<span class="nc" id="L158">		i18nDownloadsDir = _util.getI18nDownloadsDir();</span>
<span class="nc" id="L159">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.client.update.gui.installer.ArtifactInstaller#setChangeList(net.sourceforge.squirrel_sql.client.update.xmlbeans.ChangeListXmlBean)
	 */
	public void setChangeList(ChangeListXmlBean changeList) throws FileNotFoundException
	{
<span class="nc" id="L166">		_changeList = initializeChangeList(changeList);</span>
<span class="nc" id="L167">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.client.update.gui.installer.ArtifactInstaller#getChangeListFile()
	 */
	public FileWrapper getChangeListFile()
	{
<span class="nc" id="L174">		return changeListFile;</span>
	}

	/**
	 * @see net.sourceforge.squirrel_sql.client.update.gui.installer.ArtifactInstaller#
	 *      setChangeListFile(java.io.File)
	 */
	public void setChangeListFile(FileWrapper changeListFile)
	{
<span class="nc" id="L183">		this.changeListFile = changeListFile;</span>
<span class="nc" id="L184">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.client.update.gui.installer.ArtifactInstaller#
	 *      addListener(net.sourceforge.squirrel_sql.client.update.gui.installer.event.InstallStatusListener)
	 */
	public void addListener(InstallStatusListener listener)
	{
<span class="nc" id="L192">		_listeners.add(listener);</span>
<span class="nc" id="L193">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.client.update.gui.installer.ArtifactInstaller#backupFiles()
	 */
	public boolean backupFiles() throws FileNotFoundException, IOException
	{
<span class="nc" id="L200">		boolean result = true;</span>
<span class="nc" id="L201">		sendBackupStarted(_changeList.size());</span>

<span class="nc" id="L203">		FileWrapper localReleaseFile = _util.getLocalReleaseFile();</span>
<span class="nc" id="L204">		_util.copyFile(localReleaseFile, _util.getBackupDir());</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">		for (ArtifactStatus status : _changeList)</span>
		{
<span class="nc" id="L208">			String artifactName = status.getName();</span>
<span class="nc" id="L209">			sendFileBackupStarted(artifactName);</span>
			// Skip files that are not installed - new files
<span class="nc bnc" id="L211" title="All 2 branches missed.">			if (!status.isInstalled())</span>
			{
<span class="nc bnc" id="L213" title="All 2 branches missed.">				if (s_log.isInfoEnabled())</span>
				{
<span class="nc" id="L215">					s_log.info(&quot;Skipping backup of artifact (&quot; + status + &quot;) which isn't installed.&quot;);</span>
				}
<span class="nc" id="L217">				sendFileBackupComplete(artifactName);</span>
<span class="nc" id="L218">				continue;</span>
			}
<span class="nc bnc" id="L220" title="All 2 branches missed.">			if (status.isCoreArtifact())</span>
			{
<span class="nc" id="L222">				FileWrapper installDir = getCoreArtifactLocation(artifactName, installRootDir, coreInstallDir);</span>
<span class="nc" id="L223">				FileWrapper coreFile = _util.getFile(installDir, artifactName);</span>
<span class="nc" id="L224">				FileWrapper backupFile = _util.getFile(coreBackupDir, artifactName);</span>
<span class="nc" id="L225">				_util.copyFile(coreFile, backupFile);</span>
			}
<span class="nc bnc" id="L227" title="All 2 branches missed.">			if (status.isPluginArtifact())</span>
			{
				// artifact name for plugins is &lt;plugin internal name&gt;.zip
<span class="nc" id="L230">				FileWrapper pluginBackupFile = _util.getFile(pluginBackupDir, artifactName);</span>
<span class="nc" id="L231">				String pluginDirectory = artifactName.replace(&quot;.zip&quot;, &quot;&quot;);</span>
<span class="nc" id="L232">				String pluginJarFilename = artifactName.replace(&quot;.zip&quot;, &quot;.jar&quot;);</span>

<span class="nc" id="L234">				ArrayList&lt;FileWrapper&gt; filesToZip = new ArrayList&lt;FileWrapper&gt;();</span>
<span class="nc" id="L235">				FileWrapper pluginDirectoryFile = _util.getFile(pluginInstallDir, pluginDirectory);</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">				if (pluginDirectoryFile.exists())</span>
				{
<span class="nc" id="L238">					filesToZip.add(pluginDirectoryFile);</span>
				}
<span class="nc" id="L240">				FileWrapper pluginJarFile = _util.getFile(pluginInstallDir, pluginJarFilename);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">				if (pluginJarFile.exists())</span>
				{
<span class="nc" id="L243">					filesToZip.add(pluginJarFile);</span>
				}
<span class="nc bnc" id="L245" title="All 2 branches missed.">				if (filesToZip.size() &gt; 0)</span>
				{
<span class="nc" id="L247">					_util.createZipFile(pluginBackupFile, filesToZip.toArray(new FileWrapper[filesToZip.size()]));</span>
				}
				else
				{
<span class="nc" id="L251">					s_log.error(&quot;Plugin (&quot; + status.getName() + &quot;) was listed as already installed, but it's &quot;</span>
						+ &quot;files didn't exist and couldn't be backed up: pluginDirectoryFile=&quot;
<span class="nc" id="L253">						+ pluginDirectoryFile.getAbsolutePath() + &quot; pluginJarFile=&quot;</span>
<span class="nc" id="L254">						+ pluginJarFile.getAbsolutePath());</span>
				}
			}
<span class="nc bnc" id="L257" title="All 2 branches missed.">			if (status.isTranslationArtifact())</span>
			{
<span class="nc" id="L259">				FileWrapper translationFile = _util.getFile(i18nInstallDir, artifactName);</span>
<span class="nc" id="L260">				FileWrapper backupFile = _util.getFile(translationBackupDir, artifactName);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">				if (translationFile.exists())</span>
				{
<span class="nc" id="L263">					_util.copyFile(translationFile, backupFile);</span>
				}
			}
<span class="nc" id="L266">			breathing();</span>
<span class="nc" id="L267">			sendFileBackupComplete(artifactName);</span>
<span class="nc" id="L268">		}</span>

<span class="nc" id="L270">		sendBackupComplete();</span>
<span class="nc" id="L271">		return result;</span>
	}

	/**
	 * @see net.sourceforge.squirrel_sql.client.update.gui.installer.ArtifactInstaller#installFiles()
	 */
	public void installFiles() throws IOException
	{		
<span class="nc" id="L279">		List&lt;FileWrapper&gt; filesToRemove = new ArrayList&lt;FileWrapper&gt;();</span>
<span class="nc" id="L280">		List&lt;InstallFileOperationInfo&gt; filesToInstall = new ArrayList&lt;InstallFileOperationInfo&gt;();</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">		for (ArtifactStatus status : _changeList)</span>
		{
<span class="nc" id="L284">			ArtifactAction action = status.getArtifactAction();</span>
<span class="nc" id="L285">			FileWrapper installDir = null;</span>
<span class="nc" id="L286">			FileWrapper fileToCopy = null;</span>
<span class="nc" id="L287">			FileWrapper fileToRemove = null;</span>
<span class="nc" id="L288">			String artifactName = status.getName();</span>
<span class="nc" id="L289">			boolean isPlugin = false;</span>

<span class="nc bnc" id="L291" title="All 2 branches missed.">			if (status.isCoreArtifact())</span>
			{
<span class="nc bnc" id="L293" title="All 2 branches missed.">				if (action == ArtifactAction.REMOVE)</span>
				{
<span class="nc" id="L295">					s_log.error(&quot;Skipping core artifact (&quot; + status.getName() + &quot;) that was marked for removal&quot;);</span>
<span class="nc" id="L296">					continue;</span>
				}
<span class="nc" id="L298">				installDir = getCoreArtifactLocation(status.getName(), installRootDir, coreInstallDir);</span>
<span class="nc" id="L299">				fileToCopy = _util.getFile(coreDownloadsDir, artifactName);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">				if (UpdateUtil.DOCS_ARCHIVE_FILENAME.equals(status.getName()))</span>
				{
<span class="nc" id="L302">					fileToRemove = _util.getFile(installDir, artifactName.replace(&quot;.zip&quot;, &quot;&quot;));</span>
				}
				else
				{
<span class="nc" id="L306">					fileToRemove = _util.getFile(installDir, artifactName);</span>
				}

<span class="nc" id="L309">				filesToRemove.add(fileToRemove);</span>
			}
<span class="nc bnc" id="L311" title="All 2 branches missed.">			if (status.isPluginArtifact())</span>
			{
<span class="nc" id="L313">				isPlugin = true;</span>
<span class="nc" id="L314">				installDir = pluginInstallDir;</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">				if (action != ArtifactAction.REMOVE)</span>
				{
<span class="nc" id="L317">					fileToCopy = _util.getFile(pluginDownloadsDir, artifactName);</span>
				}

				// Need to remove the existing jar in the plugins directory and all of the files beneath the
				// plugin-named directory.
<span class="nc" id="L322">				String jarFileToRemove = artifactName.replace(&quot;.zip&quot;, &quot;.jar&quot;);</span>
<span class="nc" id="L323">				String pluginDirectoryToRemove = artifactName.replace(&quot;.zip&quot;, &quot;&quot;);</span>

<span class="nc" id="L325">				filesToRemove.add(_util.getFile(installDir, jarFileToRemove));</span>
<span class="nc" id="L326">				filesToRemove.add(_util.getFile(installDir, pluginDirectoryToRemove));</span>
			}
<span class="nc bnc" id="L328" title="All 2 branches missed.">			if (status.isTranslationArtifact())</span>
			{
<span class="nc" id="L330">				installDir = i18nInstallDir;</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">				if (action != ArtifactAction.REMOVE)</span>
				{
<span class="nc" id="L333">					fileToCopy = _util.getFile(i18nDownloadsDir, artifactName);</span>
				}
<span class="nc" id="L335">				fileToRemove = _util.getFile(installDir, artifactName);</span>
<span class="nc" id="L336">				filesToRemove.add(fileToRemove);</span>
			}
<span class="nc bnc" id="L338" title="All 2 branches missed.">			if (fileToCopy != null)</span>
			{
<span class="nc" id="L340">				InstallFileOperationInfo info = installFileOperationInfoFactory.create(fileToCopy, installDir);</span>
<span class="nc" id="L341">				info.setPlugin(isPlugin);</span>
<span class="nc" id="L342">				info.setArtifactName(artifactName);</span>
<span class="nc" id="L343">				filesToInstall.add(info);</span>
			}

<span class="nc" id="L346">		}</span>
<span class="nc" id="L347">		boolean success = removeOldFiles(filesToRemove);</span>
<span class="nc bnc" id="L348" title="All 4 branches missed.">		success = success &amp;&amp; installFiles(filesToInstall);</span>
<span class="nc bnc" id="L349" title="All 4 branches missed.">		success = success &amp;&amp; backupAndDeleteChangeListFile();</span>
<span class="nc bnc" id="L350" title="All 4 branches missed.">		success = success &amp;&amp; installNewReleaseXmlFile();</span>

<span class="nc bnc" id="L352" title="All 2 branches missed.">		if (!success)</span>
		{
<span class="nc" id="L354">			restoreFilesFromBackup(filesToInstall);</span>
		}

<span class="nc" id="L357">		sendInstallComplete();</span>
<span class="nc" id="L358">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.client.update.gui.installer.ArtifactInstaller#restoreBackupFiles(net.sourceforge.squirrel_sql.client.update.xmlbeans.ChangeListXmlBean)
	 */
	public boolean restoreBackupFiles() throws FileNotFoundException, IOException
	{
<span class="nc bnc" id="L365" title="All 2 branches missed.">		for (ArtifactStatus status : _changeList)</span>
		{
<span class="nc" id="L367">			String name = status.getName();</span>
<span class="nc" id="L368">			FileWrapper backupDir = null;</span>
<span class="nc" id="L369">			FileWrapper installDir = null;</span>

<span class="nc bnc" id="L371" title="All 2 branches missed.">			if (status.isCoreArtifact())</span>
			{
<span class="nc" id="L373">				backupDir = coreBackupDir;</span>
<span class="nc" id="L374">				installDir = getCoreArtifactLocation(name, installRootDir, coreInstallDir);</span>
			}
<span class="nc bnc" id="L376" title="All 2 branches missed.">			if (status.isPluginArtifact())</span>
			{
<span class="nc" id="L378">				backupDir = pluginBackupDir;</span>
<span class="nc" id="L379">				installDir = pluginInstallDir;</span>
			}
<span class="nc bnc" id="L381" title="All 2 branches missed.">			if (status.isTranslationArtifact())</span>
			{
<span class="nc" id="L383">				backupDir = translationBackupDir;</span>
<span class="nc" id="L384">				installDir = coreInstallDir; // translations are most likely to be found in core lib dir.</span>
			}
<span class="nc" id="L386">			FileWrapper backupJarPath = _util.getFile(backupDir, name);</span>
<span class="nc" id="L387">			FileWrapper installJarPath = _util.getFile(installDir, name);</span>

<span class="nc bnc" id="L389" title="All 2 branches missed.">			if (!_util.deleteFile(installJarPath))</span>
			{
<span class="nc" id="L391">				return false;</span>
			}
			else
			{
<span class="nc" id="L395">				_util.copyFile(backupJarPath, installJarPath);</span>
			}
<span class="nc" id="L397">		}</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">		if (!_util.deleteFile(_util.getLocalReleaseFile()))</span>
		{
<span class="nc" id="L400">			return false;</span>
		}
		else
		{
<span class="nc" id="L404">			FileWrapper backupReleaseFile = _util.getFile(_util.getBackupDir(), UpdateUtil.RELEASE_XML_FILENAME);</span>
<span class="nc" id="L405">			_util.copyFile(backupReleaseFile, updateDir);</span>
		}

<span class="nc" id="L408">		return true;</span>
	}

	// Helper methods

	private void breathing()
	{
		// In case this is called by the AWT thread, log a message - this is most likey a bug
<span class="nc bnc" id="L416" title="All 2 branches missed.">		if (SwingUtilities.isEventDispatchThread())</span>
		{
<span class="nc bnc" id="L418" title="All 2 branches missed.">			if (s_log.isDebugEnabled())</span>
			{
<span class="nc" id="L420">				s_log.debug(&quot;breathing: ignoring request to sleep the event dispatch thread&quot;);</span>
			}
<span class="nc" id="L422">			return;</span>
		}
<span class="nc" id="L424">		synchronized (this)</span>
		{
			try
			{
<span class="nc" id="L428">				wait(50);</span>
			}
<span class="nc" id="L430">			catch (InterruptedException e)</span>
			{
<span class="nc bnc" id="L432" title="All 2 branches missed.">				if (s_log.isInfoEnabled())</span>
				{
<span class="nc" id="L434">					s_log.info(&quot;breathing: Interrupted&quot;, e);</span>
				}
<span class="nc" id="L436">			}</span>
<span class="nc" id="L437">		}</span>
<span class="nc" id="L438">	}</span>

	/**
	 * Since it possible that some artifacts haven't changed between releases, and it is time-consuming to read
	 * the contents of the installed file to compute it's checksum, we do that here just once and boil the
	 * change list down to just those files that have physically changed, by comparing byte-size and checksum.
	 */
	private List&lt;ArtifactStatus&gt; initializeChangeList(ChangeListXmlBean changeListBean)
	{
<span class="nc" id="L447">		sendInitChangelistStarted(changeListBean.getChanges().size());</span>
<span class="nc" id="L448">		ArrayList&lt;ArtifactStatus&gt; result = new ArrayList&lt;ArtifactStatus&gt;();</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">		for (ArtifactStatus status : changeListBean.getChanges())</span>
		{
<span class="nc" id="L451">			String artifactName = status.getName();</span>
<span class="nc" id="L452">			sendFileInitChangelistStarted(artifactName);</span>
			
			// Always add plugins - there is not a good way to compare plugin zips and their extracted contents
			// at the moment.
			// TODO: Determine the best way to derive the filesize and checksum of the plugin zip that was last
			// extracted. Should we keep it around? How about using the current release.xml file ? Come to
			// think of it, perhaps we shouldn't be computing the checksum of *any* existing files, why don't
			// we just get it from the current release.xml file?
<span class="nc bnc" id="L460" title="All 2 branches missed.">			if (status.isPluginArtifact())</span>
			{
<span class="nc" id="L462">				result.add(status);</span>
<span class="nc" id="L463">				sendFileInitChangelistComplete(artifactName);</span>
<span class="nc" id="L464">				continue;</span>
			}

<span class="nc bnc" id="L467" title="All 2 branches missed.">			if (status.getArtifactAction() == ArtifactAction.INSTALL)</span>
			{
<span class="nc" id="L469">				FileWrapper installedFileLocation = null;</span>
				// Skip the artifact if it is identical to the one that is already installed
<span class="nc bnc" id="L471" title="All 2 branches missed.">				if (status.isCoreArtifact())</span>
				{
<span class="nc" id="L473">					installedFileLocation =</span>
<span class="nc" id="L474">						_util.getFile(getCoreArtifactLocation(status.getName(), installRootDir, coreInstallDir),</span>
<span class="nc" id="L475">							status.getName());</span>
				}
<span class="nc bnc" id="L477" title="All 2 branches missed.">				if (status.isTranslationArtifact())</span>
				{
<span class="nc" id="L479">					installedFileLocation = _util.getFile(coreInstallDir, status.getName());</span>
				}

<span class="nc" id="L482">				long installedSize = installedFileLocation.length();</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">				if (installedSize == status.getSize())</span>
				{
<span class="nc" id="L485">					long installedCheckSum = _util.getCheckSum(installedFileLocation);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">					if (installedCheckSum == status.getChecksum())</span>
					{
<span class="nc bnc" id="L488" title="All 2 branches missed.">						if (s_log.isDebugEnabled())</span>
						{
<span class="nc" id="L490">							s_log.debug(&quot;initializeChangeList: found a core/translation artifact that is not &quot;</span>
								+ &quot;installed: installedSize= &quot; + installedSize + &quot; installedCheckSum=&quot;
<span class="nc" id="L492">								+ installedCheckSum + &quot; statusSize=&quot; + status.getSize() + &quot; statusChecksum=&quot;</span>
<span class="nc" id="L493">								+ status.getChecksum());</span>
						}
<span class="nc" id="L495">						sendFileInitChangelistComplete(artifactName);</span>
<span class="nc" id="L496">						continue;</span>
					}
				}
			}

			// We have a core or translation file that is not already installed - add it
<span class="nc" id="L502">			result.add(status);</span>
<span class="nc" id="L503">			sendFileInitChangelistComplete(artifactName);</span>
<span class="nc" id="L504">		}</span>
<span class="nc" id="L505">		sendInitChangelistComplete();</span>
<span class="nc" id="L506">		return result;</span>
	}

	/* Handle squirrel-sql.jar and documentation archive carefully - they live at the top */
	private FileWrapper getCoreArtifactLocation(String artifactName, FileWrapper rootDir, FileWrapper coreDir)
	{
<span class="nc bnc" id="L512" title="All 2 branches missed.">		if (UpdateUtil.SQUIRREL_SQL_JAR_FILENAME.equals(artifactName)</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">			|| UpdateUtil.DOCS_ARCHIVE_FILENAME.equals(artifactName))</span>
		{
<span class="nc" id="L515">			return rootDir;</span>
		}
		else
		{
<span class="nc" id="L519">			return coreDir;</span>
		}
	}

	private void restoreFilesFromBackup(List&lt;InstallFileOperationInfo&gt; filesToInstall)
	{
		// TODO Auto-generated method stub
<span class="nc" id="L526">	}</span>

	private boolean backupAndDeleteChangeListFile()
	{
<span class="nc" id="L530">		boolean result = true;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">		if (changeListFile != null)</span>
		{
			try
			{
<span class="nc" id="L535">				_util.copyFile(changeListFile, backupRootDir);</span>
<span class="nc" id="L536">				result = _util.deleteFile(changeListFile);</span>
			}
<span class="nc" id="L538">			catch (IOException e)</span>
			{
<span class="nc" id="L540">				result = false;</span>
<span class="nc" id="L541">				s_log.error(&quot;Unexpected exception: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L542">			}</span>
		}
		else
		{
<span class="nc bnc" id="L546" title="All 2 branches missed.">			if (s_log.isInfoEnabled())</span>
			{
<span class="nc" id="L548">				s_log.info(&quot;moveChangeListFile: Changelist file was null.  Skipping move&quot;);</span>
			}
		}
<span class="nc" id="L551">		return result;</span>
	}

	/**
	 * Install the downloaded release.xml file into the updates root directory so that the update knows the
	 * current release has changed.
	 * 
	 * @return true if install was successful; false otherwise.
	 */
	private boolean installNewReleaseXmlFile()
	{
<span class="nc" id="L562">		boolean result = true;</span>

		try
		{
<span class="nc" id="L566">			_util.deleteFile(_util.getLocalReleaseFile());</span>
		}
<span class="nc" id="L568">		catch (FileNotFoundException e)</span>
		{
			// strange that release xml file wasn't found; but not a problem at this point - just log it.
<span class="nc bnc" id="L571" title="All 2 branches missed.">			if (s_log.isInfoEnabled())</span>
			{
<span class="nc" id="L573">				s_log.info(&quot;installNewReleaseXmlFile: release file to be replaced was missing.&quot;);</span>
			}
<span class="nc" id="L575">		}</span>
<span class="nc" id="L576">		FileWrapper downloadReleaseFile = _util.getFile(downloadsRootDir, UpdateUtil.RELEASE_XML_FILENAME);</span>
		try
		{
<span class="nc" id="L579">			_util.copyFile(downloadReleaseFile, updateDir);</span>
		}
<span class="nc" id="L581">		catch (FileNotFoundException e)</span>
		{
<span class="nc" id="L583">			result = false;</span>
<span class="nc" id="L584">			s_log.error(&quot;installNewReleaseXmlFile: unexpected exception - &quot; + e.getMessage(), e);</span>
		}
<span class="nc" id="L586">		catch (IOException e)</span>
		{
<span class="nc" id="L588">			result = false;</span>
<span class="nc" id="L589">			s_log.error(&quot;installNewReleaseXmlFile: unexpected exception - &quot; + e.getMessage(), e);</span>
<span class="nc" id="L590">		}</span>
<span class="nc" id="L591">		return result;</span>
	}

	/**
	 * Removes the specified list of File objects (can represent either a file or directory)
	 * 
	 * @param filesToRemove
	 *           the files to be removed.
	 * @return true if the remove operation was successful and false otherwise.
	 */
	private boolean removeOldFiles(List&lt;FileWrapper&gt; filesToRemove)
	{
<span class="nc" id="L603">		boolean result = true;</span>
<span class="nc" id="L604">		sendRemoveStarted(filesToRemove.size());</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">		for (FileWrapper fileToRemove : filesToRemove)</span>
		{
<span class="nc" id="L607">			sendFileRemoveStarted(fileToRemove.getName());</span>
<span class="nc" id="L608">			result = removeOldFile(fileToRemove);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">			if (!result)</span>
			{
<span class="nc" id="L611">				break;</span>
			}
<span class="nc" id="L613">			breathing();</span>
<span class="nc" id="L614">			sendFileRemoveComplete(fileToRemove.getName());</span>
<span class="nc" id="L615">		}</span>
<span class="nc" id="L616">		sendRemoveComplete();</span>
<span class="nc" id="L617">		return result;</span>
	}

	/**
	 * Removes the old file that will be replaced by the new.
	 * 
	 * @param fileToRemove
	 *           the File that represents the file to be removed
	 * @return true if the remove operation was successful and false otherwise.
	 */
	private boolean removeOldFile(FileWrapper fileToRemove)
	{
<span class="nc" id="L629">		boolean result = true;</span>
<span class="nc" id="L630">		String absolutePath = fileToRemove.getAbsolutePath();</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">		if (s_log.isDebugEnabled())</span>
		{
<span class="nc" id="L633">			s_log.debug(&quot;Examining file to remove: &quot; + absolutePath);</span>
		}
<span class="nc bnc" id="L635" title="All 2 branches missed.">		if (fileToRemove.exists())</span>
		{
			try
			{
<span class="nc bnc" id="L639" title="All 2 branches missed.">				if (s_log.isDebugEnabled())</span>
				{
<span class="nc" id="L641">					s_log.debug(&quot;Attempting to delete file: &quot; + absolutePath);</span>
				}
<span class="nc" id="L643">				result = _util.deleteFile(fileToRemove);</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">				if (!result)</span>
				{
<span class="nc" id="L646">					s_log.error(&quot;Delete operation failed for file/directory: &quot; + absolutePath);</span>
				}
			}
<span class="nc" id="L649">			catch (SecurityException e)</span>
			{
<span class="nc" id="L651">				result = false;</span>
<span class="nc" id="L652">				s_log.error(&quot;Unexpected security exception: &quot; + e.getMessage());</span>
<span class="nc" id="L653">			}</span>
		}
		else
		{
<span class="nc bnc" id="L657" title="All 2 branches missed.">			if (s_log.isInfoEnabled())</span>
			{
<span class="nc" id="L659">				s_log.info(&quot;Skipping delete of file doesn't appear to exist: &quot; + absolutePath);</span>
			}
		}
<span class="nc" id="L662">		return result;</span>
	}

	private boolean installFiles(List&lt;InstallFileOperationInfo&gt; filesToInstall) throws IOException
	{
<span class="nc" id="L667">		sendInstallStarted(_changeList.size());</span>
<span class="nc" id="L668">		breathing();</span>

<span class="nc" id="L670">		boolean result = true;</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">		for (InstallFileOperationInfo info : filesToInstall)</span>
		{
			try
			{
<span class="nc" id="L675">				sendFileInstallStarted(info.getArtifactName());</span>
<span class="nc" id="L676">				installFile(info);</span>
<span class="nc" id="L677">				sendFileInstallComplete(info.getArtifactName());</span>
			}
<span class="nc" id="L679">			catch (Exception e)</span>
			{
<span class="nc" id="L681">				s_log.error(&quot;installFiles: unexpected exception: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L682">				result = false;</span>
<span class="nc" id="L683">				break;</span>
<span class="nc" id="L684">			}</span>
<span class="nc" id="L685">			breathing();</span>
<span class="nc" id="L686">		}</span>
<span class="nc" id="L687">		return result;</span>
	}

	private void installFile(InstallFileOperationInfo info) throws IOException
	{
<span class="nc" id="L692">		FileWrapper installDir = info.getInstallDir();</span>
<span class="nc" id="L693">		FileWrapper fileToCopy = info.getFileToInstall();</span>

<span class="nc bnc" id="L695" title="All 2 branches missed.">		if (fileToCopy.getAbsolutePath().endsWith(&quot;.zip&quot;))</span>
		{
			// This file is a zip; it needs to be extracted into the install directory. All zips are packaged
			// in such a way that the extraction beneath install directory is all that is required.
<span class="nc" id="L699">			_util.extractZipFile(fileToCopy, installDir);</span>
		}
		else
		{
<span class="nc" id="L703">			_util.copyFile(fileToCopy, installDir);</span>
		}

<span class="nc" id="L706">	}</span>

	private void sendInitChangelistStarted(int numFilesToBackup)
	{
<span class="nc" id="L710">		logInfo(&quot;Changelist initialization started&quot;);</span>
<span class="nc" id="L711">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.INIT_CHANGELIST_STARTED);</span>
<span class="nc" id="L712">		evt.setNumFilesToUpdate(numFilesToBackup);</span>
<span class="nc" id="L713">		sendEvent(evt);</span>
<span class="nc" id="L714">	}</span>

	private void sendFileInitChangelistStarted(String artifactName)
	{
<span class="nc" id="L718">		logInfo(&quot;Changelist init started for file: &quot; + artifactName);</span>
<span class="nc" id="L719">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.FILE_INIT_CHANGELIST_STARTED);</span>
<span class="nc" id="L720">		evt.setArtifactName(artifactName);</span>
<span class="nc" id="L721">		sendEvent(evt);</span>
<span class="nc" id="L722">	}</span>

	private void sendFileInitChangelistComplete(String artifactName)
	{
<span class="nc" id="L726">		logInfo(&quot;Changelist init complete for file: &quot; + artifactName);</span>
<span class="nc" id="L727">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.FILE_INIT_CHANGELIST_COMPLETE);</span>
<span class="nc" id="L728">		evt.setArtifactName(artifactName);</span>
<span class="nc" id="L729">		sendEvent(evt);</span>
<span class="nc" id="L730">	}</span>

	private void sendInitChangelistComplete()
	{
<span class="nc" id="L734">		logInfo(&quot;Changelist initialization complete&quot;);</span>
<span class="nc" id="L735">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.INIT_CHANGELIST_COMPLETE);</span>
<span class="nc" id="L736">		sendEvent(evt);</span>
<span class="nc" id="L737">	}	</span>
	
	private void sendBackupStarted(int numFilesToBackup)
	{
<span class="nc" id="L741">		logInfo(&quot;Backup started&quot;);</span>
<span class="nc" id="L742">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.BACKUP_STARTED);</span>
<span class="nc" id="L743">		evt.setNumFilesToUpdate(numFilesToBackup);</span>
<span class="nc" id="L744">		sendEvent(evt);</span>
<span class="nc" id="L745">	}</span>

	private void sendFileBackupStarted(String artifactName)
	{
<span class="nc" id="L749">		logInfo(&quot;Backup started for file: &quot; + artifactName);</span>
<span class="nc" id="L750">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.FILE_BACKUP_STARTED);</span>
<span class="nc" id="L751">		evt.setArtifactName(artifactName);</span>
<span class="nc" id="L752">		sendEvent(evt);</span>
<span class="nc" id="L753">	}</span>

	private void sendFileBackupComplete(String artifactName)
	{
<span class="nc" id="L757">		logInfo(&quot;Backup complete for file: &quot; + artifactName);</span>
<span class="nc" id="L758">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.FILE_BACKUP_COMPLETE);</span>
<span class="nc" id="L759">		evt.setArtifactName(artifactName);</span>
<span class="nc" id="L760">		sendEvent(evt);</span>
<span class="nc" id="L761">	}</span>

	private void sendBackupComplete()
	{
<span class="nc" id="L765">		logInfo(&quot;Backup complete&quot;);</span>
<span class="nc" id="L766">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.BACKUP_COMPLETE);</span>
<span class="nc" id="L767">		sendEvent(evt);</span>
<span class="nc" id="L768">	}</span>

	
	private void sendRemoveStarted(int numFilesToRemove)
	{
<span class="nc" id="L773">		logInfo(&quot;Remove started&quot;);</span>
<span class="nc" id="L774">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.REMOVE_STARTED);</span>
<span class="nc" id="L775">		evt.setNumFilesToUpdate(numFilesToRemove);</span>
<span class="nc" id="L776">		sendEvent(evt);</span>
<span class="nc" id="L777">	}</span>

	private void sendFileRemoveStarted(String artifactName)
	{
<span class="nc" id="L781">		logInfo(&quot;Remove started for file: &quot; + artifactName);</span>
<span class="nc" id="L782">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.FILE_REMOVE_STARTED);</span>
<span class="nc" id="L783">		evt.setArtifactName(artifactName);</span>
<span class="nc" id="L784">		sendEvent(evt);</span>
<span class="nc" id="L785">	}</span>

	private void sendFileRemoveComplete(String artifactName)
	{
<span class="nc" id="L789">		logInfo(&quot;Remove complete for file: &quot; + artifactName);</span>
<span class="nc" id="L790">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.FILE_REMOVE_COMPLETE);</span>
<span class="nc" id="L791">		evt.setArtifactName(artifactName);</span>
<span class="nc" id="L792">		sendEvent(evt);</span>
<span class="nc" id="L793">	}</span>

	private void sendRemoveComplete()
	{
<span class="nc" id="L797">		logInfo(&quot;Remove complete&quot;);</span>
<span class="nc" id="L798">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.REMOVE_COMPLETE);</span>
<span class="nc" id="L799">		sendEvent(evt);</span>
<span class="nc" id="L800">	}</span>
	
	private void sendInstallStarted(int numFilesToUpdate)
	{
<span class="nc" id="L804">		logInfo(&quot;Install started&quot;);</span>
<span class="nc" id="L805">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.INSTALL_STARTED);</span>
<span class="nc" id="L806">		evt.setNumFilesToUpdate(numFilesToUpdate);</span>
<span class="nc" id="L807">		sendEvent(evt);</span>
<span class="nc" id="L808">	}</span>

	private void sendFileInstallStarted(String artifactName)
	{
<span class="nc" id="L812">		logInfo(&quot;Install started for file: &quot; + artifactName);</span>
<span class="nc" id="L813">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.FILE_INSTALL_STARTED);</span>
<span class="nc" id="L814">		evt.setArtifactName(artifactName);</span>
<span class="nc" id="L815">		sendEvent(evt);</span>
<span class="nc" id="L816">	}</span>

	private void sendFileInstallComplete(String artifactName)
	{
<span class="nc" id="L820">		logInfo(&quot;Install complete for file: &quot; + artifactName);</span>
<span class="nc" id="L821">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.FILE_INSTALL_COMPLETE);</span>
<span class="nc" id="L822">		evt.setArtifactName(artifactName);</span>
<span class="nc" id="L823">		sendEvent(evt);</span>
<span class="nc" id="L824">	}</span>

	private void sendInstallComplete()
	{
<span class="nc" id="L828">		logInfo(&quot;Install completed&quot;);</span>
<span class="nc" id="L829">		InstallStatusEvent evt = installStatusEventFactory.create(InstallEventType.INSTALL_COMPLETE);</span>
<span class="nc" id="L830">		sendEvent(evt);</span>
<span class="nc" id="L831">	}</span>

	private void sendEvent(InstallStatusEvent evt)
	{
<span class="nc bnc" id="L835" title="All 2 branches missed.">		for (InstallStatusListener listener : _listeners)</span>
		{
<span class="nc" id="L837">			listener.handleInstallStatusEvent(evt);</span>
<span class="nc" id="L838">		}</span>
<span class="nc" id="L839">	}</span>

	private void logInfo(String message)
	{
<span class="nc bnc" id="L843" title="All 2 branches missed.">		if (s_log.isInfoEnabled())</span>
		{
<span class="nc" id="L845">			s_log.info(message);</span>
		}
<span class="nc" id="L847">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>