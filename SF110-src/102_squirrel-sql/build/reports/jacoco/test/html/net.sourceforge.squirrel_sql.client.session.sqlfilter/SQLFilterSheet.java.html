<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SQLFilterSheet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.session.sqlfilter</a> &gt; <span class="el_source">SQLFilterSheet.java</span></div><h1>SQLFilterSheet.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.session.sqlfilter;
/*
 * Copyright (C) 2003-2004 Maury Hammel
 * mjhammel@users.sourceforge.net
 *
 * Modifications Copyright (C) 2003-2004 Jason Height
 *
 * Adapted from SessionPropertiesSheet.java by Colin Bell.
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */

import net.sourceforge.squirrel_sql.client.gui.builders.UIFactory;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.DialogWidget;
import net.sourceforge.squirrel_sql.client.gui.desktopcontainer.SessionDialogWidget;
import net.sourceforge.squirrel_sql.client.session.IObjectTreeAPI;
import net.sourceforge.squirrel_sql.client.session.mainpanel.objecttree.tabs.table.ContentsTab;
import net.sourceforge.squirrel_sql.fw.datasetviewer.DataSetException;
import net.sourceforge.squirrel_sql.fw.gui.GUIUtils;
import net.sourceforge.squirrel_sql.fw.sql.*;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

import javax.swing.*;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.sql.SQLException;
import java.sql.Types;
import java.util.*;
import java.util.List;
/**
 * SQLFilter dialog gui.
 * JASON: Rename to SQLFilterInternalFrame
 *
 * @author &lt;A HREF=&quot;mailto:mjhammel@users.sourceforge.net&quot;&gt;Maury Hammel&lt;/A&gt;
 */
public class SQLFilterSheet extends SessionDialogWidget
{
    private static final long serialVersionUID = 1L;

    /** Logger for this class. */
<span class="nc" id="L60">	private static final ILogger s_log =</span>
<span class="nc" id="L61">		LoggerController.createLogger(SQLFilterSheet.class);</span>

    /** Internationalized strings for this class. */
<span class="nc" id="L64">    private static final StringManager s_stringMgr =</span>
<span class="nc" id="L65">        StringManagerFactory.getStringManager(SQLFilterSheet.class);</span>
    
<span class="nc" id="L67">    private static final String TITLE = </span>
<span class="nc" id="L68">        s_stringMgr.getString(&quot;SQLFilterSheet.title&quot;);</span>
    
	/** The object tree we are filtering. */
	private final IObjectTreeAPI _objectTree;

	/** A reference to a class containing information about the database metadata. */
	transient private final IDatabaseObjectInfo _objectInfo;

	/** A list of panels that make up this sheet. */
<span class="nc" id="L77">	private List&lt;ISQLFilterPanel&gt; _panels = new ArrayList&lt;ISQLFilterPanel&gt;();</span>

	/** A variable that contains a value that indicates which tab currently has focus. */
	private int _tabSelected;

	/** Frame title. */
<span class="nc" id="L83">	private JLabel _titleLbl = new JLabel();</span>

	/** A button used to trigger the clearing of SQL Filter information. */
<span class="nc" id="L86">	private JButton _clearFilter = new JButton();</span>

	/** A reference to a panel for the SQL Where Clause. */
<span class="nc" id="L89">	transient private WhereClausePanel _whereClausePanel = null;</span>

	/** A reference to a panel for the SQL Order By Clause. */
<span class="nc" id="L92">	transient private OrderByClausePanel _orderByClausePanel = null;</span>

	/**
	 * Creates a new instance of SQLFilterSheet
	 *
	 * @param	objectTree
	 * @param	objectInfo	The object we are filtering within the object
	 *						tree.
	 */
	public SQLFilterSheet(IObjectTreeAPI objectTree,
							IDatabaseObjectInfo objectInfo)
	{
<span class="nc" id="L104">		super(TITLE, true, objectTree.getSession());</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if (objectInfo == null)</span>
		{
<span class="nc" id="L107">			throw new IllegalArgumentException(&quot;IDatabaseObjectInfo == null&quot;);</span>
		}
<span class="nc" id="L109">		_objectTree = objectTree;</span>
<span class="nc" id="L110">		_objectInfo = objectInfo;</span>

<span class="nc" id="L112">		createGUI();</span>
<span class="nc" id="L113">	}</span>

	/**
	 * Position and display the sheet.
	 *
	 * @param	show	A boolean that determines whether the sheet is shown
	 * 					or hidden.
	 */
	public synchronized void setVisible(boolean show)
	{
<span class="nc" id="L123">		boolean reallyShow = true;</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">		if (show)</span>
		{
<span class="nc bnc" id="L127" title="All 2 branches missed.">			if (!isVisible())</span>
			{
<span class="nc" id="L129">				ContentsTab tab =</span>
<span class="nc" id="L130">					(ContentsTab)_objectTree.getTabbedPaneIfSelected(</span>
<span class="nc" id="L131">											_objectInfo.getDatabaseObjectType(),</span>
<span class="nc" id="L132">											ContentsTab.getContentsTabTitle());</span>

<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (tab == null)</span>
				{
<span class="nc" id="L136">					reallyShow = false;</span>
                    // i18n[SQLFilterSheet.contentsMsg=You must have the Contents Tab selected to activate the SQL Filter]
<span class="nc" id="L138">                    String msg =</span>
<span class="nc" id="L139">                        s_stringMgr.getString(&quot;SQLFilterSheet.contentsMsg&quot;);</span>
<span class="nc" id="L140">					_objectTree.getSession().showMessage(msg);</span>
<span class="nc" id="L141">				}</span>
				else
				{
<span class="nc" id="L144">					final boolean isDebug = s_log.isDebugEnabled();</span>
<span class="nc" id="L145">					long start = 0;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">					for (Iterator&lt;ISQLFilterPanel&gt; it = _panels.iterator(); it.hasNext();)</span>
					{
<span class="nc" id="L148">						ISQLFilterPanel pnl = it.next();</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">						if (isDebug)</span>
						{
<span class="nc" id="L151">							start = System.currentTimeMillis();</span>
						}

<span class="nc" id="L154">						pnl.initialize(tab.getSQLFilterClauses());</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">						if (isDebug)</span>
						{
<span class="nc" id="L157">							s_log.debug(&quot;Panel &quot; + pnl.getTitle()</span>
									+ &quot; initialized in &quot;
<span class="nc" id="L159">									+ (System.currentTimeMillis() - start) + &quot;ms&quot;);</span>
						}
<span class="nc" id="L161">					}</span>
<span class="nc" id="L162">					pack();</span>
					/*
					 * TODO: Find out why
					 * KLUDGE: For some reason, I am not able to get the sheet to
					 * size correctly. It always displays with a size that causes
					 * the sub-panels to have their scrollbars showing. Add a bit
					 * of an increase in the size of the panel so the scrollbars
					 * are not displayed.
					 */
<span class="nc" id="L171">					Dimension d = getSize();</span>
<span class="nc" id="L172">					d.width += 5;</span>
<span class="nc" id="L173">					d.height += 5;</span>
<span class="nc" id="L174">					setSize(d);</span>
					/*
					 * END-KLUDGE
					 */
<span class="nc" id="L178">					DialogWidget.centerWithinDesktop(this);</span>
<span class="nc" id="L179">					moveToFront();</span>
				}
			}
		}

<span class="nc bnc" id="L184" title="All 4 branches missed.">		if (!show || reallyShow)</span>
		{
<span class="nc" id="L186">			super.setVisible(show);</span>
		}
<span class="nc" id="L188">	}</span>

	/**
	 * Set title of this frame. Ensure that the title label matches the frame title.
	 *
	 * @param	title	New title text.
	 */
	public void setTitle(String title)
	{
<span class="nc bnc" id="L197" title="All 2 branches missed.">      if(null != _titleLbl)</span>
      {
         // this method is called from the super class's constructor
         // therfore _titleLbl is null for that call. 
<span class="nc" id="L201">		   _titleLbl.setText(title + &quot;: &quot; + _objectInfo.getSimpleName());</span>
      }
<span class="nc" id="L203">	}</span>

	/**
	 * Dispose of the sheet.
	 */
	private void performClose()
	{
<span class="nc" id="L210">		dispose();</span>
<span class="nc" id="L211">	}</span>

	public IDatabaseObjectInfo getDatabaseObjectInfo()
	{
<span class="nc" id="L215">		return _objectInfo;</span>
	}

	public IObjectTreeAPI getObjectTree()
	{
<span class="nc" id="L220">		return _objectTree;</span>
	}

	/**
	 * OK button pressed. Edit data and if ok save to aliases model and
	 * then close dialog.
	 */
	private void performOk()
	{
<span class="nc" id="L229">		final boolean isDebug = s_log.isDebugEnabled();</span>
<span class="nc" id="L230">		long start = 0;</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">		for (Iterator&lt;ISQLFilterPanel&gt; it = _panels.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L233">			ISQLFilterPanel pnl = it.next();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">			if (isDebug)</span>
			{
<span class="nc" id="L236">				start = System.currentTimeMillis();</span>
			}
<span class="nc" id="L238">			pnl.applyChanges();</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">			if (isDebug)</span>
			{
<span class="nc" id="L241">				s_log.debug(&quot;Panel &quot; + pnl.getTitle() + &quot; applied changes in &quot;</span>
<span class="nc" id="L242">						+ (System.currentTimeMillis() - start) + &quot;ms&quot;);</span>
			}
<span class="nc" id="L244">		}</span>
		try
		{
<span class="nc" id="L247">			ContentsTab cTab =</span>
<span class="nc" id="L248">				(ContentsTab)_objectTree.getTabbedPaneIfSelected(</span>
<span class="nc" id="L249">											_objectInfo.getDatabaseObjectType(),</span>
<span class="nc" id="L250">											 ContentsTab.getContentsTabTitle());</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">         if (cTab != null)</span>
			{
<span class="nc" id="L253">				cTab.refreshComponent();</span>
			}
		}
<span class="nc" id="L256">		catch (DataSetException ex)</span>
		{
<span class="nc" id="L258">			getSession().showErrorMessage(ex);</span>
<span class="nc" id="L259">		}</span>

<span class="nc" id="L261">		dispose();</span>
<span class="nc" id="L262">	}</span>

	/**
	 * Create the GUI elements for the sheet.
	 */
	private void createGUI()
	{
<span class="nc" id="L269">		SortedSet&lt;String&gt; columnNames = new TreeSet&lt;String&gt;();</span>
<span class="nc" id="L270">		Map&lt;String, Boolean&gt; textColumns = new TreeMap&lt;String, Boolean&gt;();</span>

<span class="nc" id="L272">		setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span>
<span class="nc" id="L273">		setTitle(getTitle());</span>

		// This is a tool window.
<span class="nc" id="L276">		makeToolWindow(true);</span>

		try
		{
<span class="nc" id="L280">			ISQLConnection sqlConnection = getSession().getSQLConnection();</span>
<span class="nc" id="L281">            SQLDatabaseMetaData md = sqlConnection.getSQLMetaData();</span>
<span class="nc" id="L282">            TableColumnInfo[] infos = md.getColumnInfo((ITableInfo)_objectInfo);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">            for (int i = 0; i &lt; infos.length; i++) {</span>
<span class="nc" id="L284">                String columnName = infos[i].getColumnName();</span>
<span class="nc" id="L285">                int dataType = infos[i].getDataType();</span>
<span class="nc" id="L286">                columnNames.add(columnName);</span>
<span class="nc bnc" id="L287" title="All 8 branches missed.">                if ((dataType == Types.CHAR)</span>
                        || (dataType == Types.CLOB)
                        || (dataType == Types.LONGVARCHAR)
                        || (dataType == Types.VARCHAR))
                {
<span class="nc" id="L292">                    textColumns.put(columnName, Boolean.TRUE);</span>
                }
                
            }
		}
<span class="nc" id="L297">		catch (SQLException ex)</span>
		{
            // i18n[SQLFilterSheet.error.columnList=Unable to get list of columns {0}]
<span class="nc" id="L300">            String msg = </span>
<span class="nc" id="L301">                s_stringMgr.getString(&quot;SQLFilterSheet.error.columnList&quot;,</span>
                                      ex);
<span class="nc" id="L303">			getSession().getApplication().showErrorDialog(msg);</span>
<span class="nc" id="L304">		}</span>

<span class="nc" id="L306">		_whereClausePanel =</span>
<span class="nc" id="L307">		    new WhereClausePanel(columnNames, textColumns, _objectInfo.getQualifiedName());</span>
<span class="nc" id="L308">		_orderByClausePanel =</span>
<span class="nc" id="L309">			new OrderByClausePanel(columnNames, _objectInfo.getQualifiedName());</span>
<span class="nc" id="L310">		_panels.add(_whereClausePanel);</span>
<span class="nc" id="L311">		_panels.add(_orderByClausePanel);</span>

<span class="nc" id="L313">		JTabbedPane tabPane = UIFactory.getInstance().createTabbedPane();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">		for (Iterator&lt;ISQLFilterPanel&gt; it = _panels.iterator(); it.hasNext();)</span>
		{
<span class="nc" id="L316">			ISQLFilterPanel pnl = it.next();</span>
<span class="nc" id="L317">			String pnlTitle = pnl.getTitle();</span>
<span class="nc" id="L318">			String hint = pnl.getHint();</span>
<span class="nc" id="L319">			tabPane.addTab(pnlTitle, null, pnl.getPanelComponent(), hint);</span>
<span class="nc" id="L320">		}</span>

<span class="nc" id="L322">		tabPane.addChangeListener(new ChangeListener()</span>
<span class="nc" id="L323">		{</span>
			public void stateChanged(ChangeEvent event)
			{
<span class="nc" id="L326">				setButtonLabel(</span>
<span class="nc" id="L327">					((JTabbedPane)event.getSource()).getSelectedIndex());</span>
<span class="nc" id="L328">			}</span>
		});

<span class="nc" id="L331">		final JPanel contentPane = new JPanel(new GridBagLayout());</span>
<span class="nc" id="L332">		contentPane.setBorder(BorderFactory.createEmptyBorder(5, 10, 5, 10));</span>
<span class="nc" id="L333">		setContentPane(contentPane);</span>

<span class="nc" id="L335">		GridBagConstraints gbc = new GridBagConstraints();</span>

<span class="nc" id="L337">		gbc.gridwidth = 1;</span>

<span class="nc" id="L339">		gbc.gridx = 0;</span>
<span class="nc" id="L340">		gbc.gridy = 0;</span>

<span class="nc" id="L342">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L343">		gbc.weightx = 1;</span>
<span class="nc" id="L344">		contentPane.add(_titleLbl, gbc);</span>

<span class="nc" id="L346">		gbc.fill = GridBagConstraints.NONE;</span>
<span class="nc" id="L347">		gbc.gridx = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L348">		setButtonLabel(0);</span>
<span class="nc" id="L349">		_tabSelected = 0;</span>
<span class="nc" id="L350">		_clearFilter.addActionListener(new ActionListener()</span>
<span class="nc" id="L351">		{</span>
			public void actionPerformed(ActionEvent evt)
			{
<span class="nc" id="L354">				clearFilter();</span>
<span class="nc" id="L355">			}</span>
		});
<span class="nc" id="L357">		contentPane.add(_clearFilter);</span>

<span class="nc" id="L359">		gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L360">		gbc.gridwidth = 2;</span>
<span class="nc" id="L361">		gbc.gridx = 0;</span>
<span class="nc" id="L362">		++gbc.gridy;</span>
<span class="nc" id="L363">		gbc.weighty = 1;</span>
<span class="nc" id="L364">		contentPane.add(tabPane, gbc);</span>

<span class="nc" id="L366">		++gbc.gridy;</span>
<span class="nc" id="L367">		gbc.gridwidth = 2;</span>
<span class="nc" id="L368">		gbc.weighty = 0;</span>
<span class="nc" id="L369">		contentPane.add(createButtonsPanel(), gbc);</span>


<span class="nc" id="L372">      AbstractAction closeAction = new AbstractAction()</span>
<span class="nc" id="L373">      {</span>
         public void actionPerformed(ActionEvent actionEvent)
         {
<span class="nc" id="L376">            performClose();</span>
<span class="nc" id="L377">         }</span>
      };
<span class="nc" id="L379">      KeyStroke escapeStroke = KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0);</span>
<span class="nc" id="L380">      getRootPane().getInputMap(JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L381">      getRootPane().getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L382">      getRootPane().getInputMap(JComponent.WHEN_FOCUSED).put(escapeStroke, &quot;CloseAction&quot;);</span>
<span class="nc" id="L383">      getRootPane().getActionMap().put(&quot;CloseAction&quot;, closeAction);</span>
      
<span class="nc" id="L385">	}</span>

	/**
	 * Clear out the SQL Filter information for the appropriate tab.
	 */
	private void clearFilter()
	{
<span class="nc bnc" id="L392" title="All 2 branches missed.">		if (_tabSelected == 0)</span>
		{
<span class="nc" id="L394">			_whereClausePanel.clearFilter();</span>
		}
		else
		{
<span class="nc" id="L398">			_orderByClausePanel.clearFilter();</span>
		}
<span class="nc" id="L400">	}</span>

	/**
	 * Create a panel that contains the buttons that control the closing
	 * of the sheet.
	 *
	 * @return An instance of a JPanel.
	 */
	private JPanel createButtonsPanel()
	{
<span class="nc" id="L410">		JPanel pnl = new JPanel();</span>
        // i18n[SQLFilterSheet.okButtonLabel=OK]
<span class="nc" id="L412">		String okLabel = s_stringMgr.getString(&quot;SQLFilterSheet.okButtonLabel&quot;);</span>
<span class="nc" id="L413">		JButton okBtn = new JButton(okLabel);</span>
<span class="nc" id="L414">		okBtn.addActionListener(new ActionListener()</span>
<span class="nc" id="L415">		{</span>
			public void actionPerformed(ActionEvent evt)
			{
<span class="nc" id="L418">				performOk();</span>
<span class="nc" id="L419">			}</span>
		});
        // i18n[SQLFilterSheet.closeButtonLabel=Close]
<span class="nc" id="L422">        String closeLabel = </span>
<span class="nc" id="L423">            s_stringMgr.getString(&quot;SQLFilterSheet.closeButtonLabel&quot;);</span>
<span class="nc" id="L424">		JButton closeBtn = new JButton(closeLabel);</span>
<span class="nc" id="L425">		closeBtn.addActionListener(new ActionListener()</span>
<span class="nc" id="L426">		{</span>
			public void actionPerformed(ActionEvent evt)
			{
<span class="nc" id="L429">				performClose();</span>
<span class="nc" id="L430">			}</span>
		});

<span class="nc" id="L433">		pnl.add(okBtn);</span>
<span class="nc" id="L434">		pnl.add(closeBtn);</span>

<span class="nc" id="L436">		GUIUtils.setJButtonSizesTheSame(new JButton[] { okBtn, closeBtn });</span>
<span class="nc" id="L437">		getRootPane().setDefaultButton(okBtn);</span>

<span class="nc" id="L439">		return pnl;</span>
	}

	/**
	 * Change the text of the 'clear' button depending on which
	 * clause panel has focus.
	 *
	 * @param	tabSelected	An integer indicating which panel has focus
	 */
	private void setButtonLabel(int tabSelected)
	{
<span class="nc" id="L450">        String title = null;</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (tabSelected == 0) {</span>
<span class="nc" id="L452">            title = _whereClausePanel.getTitle();</span>
        } else {
<span class="nc" id="L454">            title = _orderByClausePanel.getTitle();</span>
        }
        // i18n[SQLFilterSheet.clearButtonLabel=Clear {0}]
<span class="nc" id="L457">        String label = </span>
<span class="nc" id="L458">            s_stringMgr.getString(&quot;SQLFilterSheet.clearButtonLabel&quot;, title);</span>
<span class="nc" id="L459">        _clearFilter.setText(label);</span>
<span class="nc" id="L460">        _tabSelected = tabSelected;</span>
<span class="nc" id="L461">	}</span>

   public static SQLFilterSheet createSheet(IObjectTreeAPI objectTree, IDatabaseObjectInfo objectInfo)
   {
<span class="nc" id="L465">      return null;  //To change body of created methods use File | Settings | File Templates.</span>
   }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>