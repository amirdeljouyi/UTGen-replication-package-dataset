<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IOUtilitiesImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.fw.util</a> &gt; <span class="el_source">IOUtilitiesImpl.java</span></div><h1>IOUtilitiesImpl.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2007 Rob Manning
 * manningr@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
package net.sourceforge.squirrel_sql.fw.util;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.io.Reader;
import java.io.Writer;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.List;
import java.util.zip.CRC32;
import java.util.zip.ZipEntry;
import java.util.zip.ZipException;
import java.util.zip.ZipFile;

import org.apache.commons.httpclient.Credentials;
import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.HttpMethod;
import org.apache.commons.httpclient.UsernamePasswordCredentials;
import org.apache.commons.httpclient.auth.AuthScope;
import org.apache.commons.httpclient.methods.GetMethod;

import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

<span class="nc" id="L55">public class IOUtilitiesImpl implements IOUtilities</span>
{

	/** The size of the byte array which is used to fetch data from disk to do various I/O operations */
	public static final int DISK_DATA_BUFFER_SIZE = 8192;

	/** Logger for this class. */
<span class="nc" id="L62">	private final ILogger s_log = LoggerController.createLogger(IOUtilitiesImpl.class);</span>

	/* Spring-Injected */
	
	private FileWrapperFactory fileWrapperFactory;
	/**
	 * @param fileWrapperFactory the fileWrapperFactory to set
	 */
	public void setFileWrapperFactory(FileWrapperFactory fileWrapperFactory)
	{
<span class="nc" id="L72">		this.fileWrapperFactory = fileWrapperFactory;</span>
<span class="nc" id="L73">	}</span>
	
	
	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#closeInputStream(java.io.InputStream)
	 */
	public void closeInputStream(InputStream is)
	{
<span class="nc bnc" id="L81" title="All 2 branches missed.">		if (is != null)</span>
		{
			try
			{
<span class="nc" id="L85">				is.close();</span>
			}
<span class="nc" id="L87">			catch (Exception e)</span>
			{
<span class="nc" id="L89">				s_log.error(&quot;closeInputStream: Unable to close InputStream - &quot; + e.getMessage(), e);</span>
<span class="nc" id="L90">			}</span>
		}
<span class="nc" id="L92">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#closeOutputStream(java.io.OutputStream)
	 */
	public void closeOutputStream(OutputStream os)
	{
<span class="nc bnc" id="L99" title="All 2 branches missed.">		if (os != null)</span>
		{
			try
			{
<span class="nc" id="L103">				os.close();</span>
			}
<span class="nc" id="L105">			catch (Exception e)</span>
			{
<span class="nc" id="L107">				s_log.error(&quot;closeOutpuStream: Unable to close OutputStream - &quot; + e.getMessage(), e);</span>
<span class="nc" id="L108">			}</span>
		}
<span class="nc" id="L110">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#closeReader(java.io.Reader)
	 */
	public void closeReader(Reader reader)
	{
<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (reader != null)</span>
		{
			try
			{
<span class="nc" id="L121">				reader.close();</span>
			}
<span class="nc" id="L123">			catch (Exception e)</span>
			{
<span class="nc" id="L125">				s_log.error(&quot;closeReader: Unable to close Reader - &quot; + e.getMessage(), e);</span>
<span class="nc" id="L126">			}</span>
		}
<span class="nc" id="L128">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#closeWriter(java.io.Writer)
	 */
	public void closeWriter(Writer writer)
	{
<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (writer != null)</span>
		{
			try
			{
<span class="nc" id="L139">				writer.close();</span>
			}
<span class="nc" id="L141">			catch (Exception e)</span>
			{
<span class="nc" id="L143">				s_log.error(&quot;closeReader: Unable to close Writer - &quot; + e.getMessage(), e);</span>
<span class="nc" id="L144">			}</span>
		}
<span class="nc" id="L146">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#flushWriter(java.io.Writer)
	 */
	@Override
	public void flushWriter(Writer writer)
	{
<span class="nc bnc" id="L154" title="All 2 branches missed.">		if (writer != null)</span>
		{
			try
			{
<span class="nc" id="L158">				writer.flush();</span>
			}
<span class="nc" id="L160">			catch (Exception e)</span>
			{
<span class="nc" id="L162">				s_log.error(&quot;flushReader: Unable to flush Writer - &quot; + e.getMessage(), e);</span>
<span class="nc" id="L163">			}</span>
		}
<span class="nc" id="L165">	}</span>
	
	
	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities# copyBytes(java.io.InputStream,
	 *      java.io.OutputStream)
	 */
	public void copyBytes(InputStream is, OutputStream os) throws IOException
	{
<span class="nc" id="L174">		byte[] buffer = new byte[DISK_DATA_BUFFER_SIZE];</span>
		int length;
<span class="nc bnc" id="L176" title="All 2 branches missed.">		while ((length = is.read(buffer)) &gt; 0)</span>
		{
<span class="nc" id="L178">			os.write(buffer, 0, length);</span>
		}
<span class="nc" id="L180">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities# copyBytesToFile(java.io.InputStream,
	 *      net.sourceforge.squirrel_sql.fw.util.FileWrapper)
	 */
	public int copyBytesToFile(InputStream is, FileWrapper outputFile) throws IOException
	{
<span class="nc" id="L188">		BufferedOutputStream outputFileStream = null;</span>
<span class="nc" id="L189">		int totalLength = 0;</span>
		try
		{
<span class="nc bnc" id="L192" title="All 2 branches missed.">			if (!outputFile.exists())</span>
			{
<span class="nc" id="L194">				outputFile.createNewFile();</span>
			}
<span class="nc" id="L196">			outputFileStream = new BufferedOutputStream(new FileOutputStream(outputFile.getAbsolutePath()));</span>
<span class="nc" id="L197">			byte[] buffer = new byte[DISK_DATA_BUFFER_SIZE];</span>
<span class="nc" id="L198">			int length = 0;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">			while ((length = is.read(buffer)) != -1)</span>
			{
<span class="nc" id="L201">				totalLength += length;</span>
<span class="nc" id="L202">				outputFileStream.write(buffer, 0, length);</span>
			}

		}
		finally
		{
<span class="nc" id="L208">			closeOutputStream(outputFileStream);</span>
		}
<span class="nc" id="L210">		return totalLength;</span>
	}

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#getCheckSum(java.io.File)
	 */
	public long getCheckSum(File f) throws IOException
	{
<span class="nc" id="L218">		CRC32 result = new CRC32();</span>
<span class="nc" id="L219">		FileInputStream fis = null;</span>
		try
		{
<span class="nc" id="L222">			fis = new FileInputStream(f);</span>
<span class="nc" id="L223">			int len = 0;</span>
<span class="nc" id="L224">			byte[] buffer = new byte[DISK_DATA_BUFFER_SIZE];</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">			while ((len = fis.read(buffer)) != -1)</span>
			{
<span class="nc" id="L227">				result.update(buffer, 0, len);</span>
			}
		}
		finally
		{
<span class="nc" id="L232">			closeInputStream(fis);</span>
		}
<span class="nc" id="L234">		return result.getValue();</span>
	}

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#
	 *      getCheckSum(net.sourceforge.squirrel_sql.fw.util.FileWrapper)
	 */
	public long getCheckSum(FileWrapper f) throws IOException
	{
<span class="nc" id="L243">		return getCheckSum(new File(f.getAbsolutePath()));</span>
	}

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#
	 *      copyFile(net.sourceforge.squirrel_sql.fw.util.FileWrapper,
	 *      net.sourceforge.squirrel_sql.fw.util.FileWrapper)
	 */
	public void copyFile(FileWrapper from, FileWrapper to) throws IOException
	{
<span class="nc" id="L253">		FileInputStream in = null;</span>
<span class="nc" id="L254">		FileOutputStream out = null;</span>
		try
		{
<span class="nc" id="L257">			in = new FileInputStream(from.getAbsolutePath());</span>
<span class="nc" id="L258">			out = new FileOutputStream(to.getAbsolutePath());</span>
<span class="nc" id="L259">			byte[] buffer = new byte[8192];</span>
			int len;
<span class="nc bnc" id="L261" title="All 2 branches missed.">			while ((len = in.read(buffer)) != -1)</span>
			{
<span class="nc" id="L263">				out.write(buffer, 0, len);</span>
			}
		}
		finally
		{
<span class="nc" id="L268">			closeInputStream(in);</span>
<span class="nc" id="L269">			closeOutputStream(out);</span>
		}
<span class="nc" id="L271">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities# constructHttpUrl(java.lang.String, int,
	 *      java.lang.String)
	 */
	public URL constructHttpUrl(final String host, final int port, final String fileToGet)
		throws MalformedURLException
	{
<span class="nc" id="L280">		URL url = null;</span>
<span class="nc" id="L281">		String server = host;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">		if (server.startsWith(HTTP_PROTOCOL_PREFIX))</span>
		{
<span class="nc" id="L284">			int beginIdx = server.indexOf(&quot;://&quot;) + 3;</span>
<span class="nc" id="L285">			server = server.substring(beginIdx, host.length());</span>
		}
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if (port == 80)</span>
		{
<span class="nc" id="L289">			url = new URL(HTTP_PROTOCOL_PREFIX, server, fileToGet);</span>
		}
		else
		{
<span class="nc" id="L293">			url = new URL(HTTP_PROTOCOL_PREFIX, server, port, fileToGet);</span>
		}
<span class="nc" id="L295">		return url;</span>
	}

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities# downloadHttpFile(java.lang.String, int,
	 *      java.lang.String, net.sourceforge.squirrel_sql.fw.util.FileWrapper)
	 */
	public int downloadHttpFile(URL url, FileWrapper destFile, IProxySettings proxySettings)
		throws IOException
	{
<span class="nc" id="L305">		BufferedInputStream is = null;</span>
<span class="nc" id="L306">		HttpMethod method = null;</span>
<span class="nc" id="L307">		int resultCode = -1;</span>
<span class="nc" id="L308">		int result = -1;</span>
		try
		{
<span class="nc bnc" id="L311" title="All 2 branches missed.">			if (s_log.isDebugEnabled())</span>
			{
<span class="nc" id="L313">				s_log.debug(&quot;downloadHttpFile: downloading file (&quot; + destFile.getName() + &quot;) from url: &quot; + url);</span>
			}
<span class="nc" id="L315">			HttpClient client = new HttpClient();</span>
<span class="nc" id="L316">			setupProxy(proxySettings, client, url);</span>

<span class="nc" id="L318">			method = new GetMethod(url.toString());</span>
<span class="nc" id="L319">			method.setFollowRedirects(true);</span>

<span class="nc" id="L321">			resultCode = client.executeMethod(method);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">			if (s_log.isDebugEnabled())</span>
			{
<span class="nc" id="L324">				s_log.debug(&quot;downloadHttpFile: response code was: &quot; + resultCode);</span>
			}

<span class="nc bnc" id="L327" title="All 2 branches missed.">			if (resultCode != 200) { throw new FileNotFoundException(&quot;Failed to download file from url (&quot; + url</span>
				+ &quot;): HTTP Response Code=&quot; + resultCode); }
<span class="nc" id="L329">			InputStream mis = method.getResponseBodyAsStream();</span>

<span class="nc" id="L331">			is = new BufferedInputStream(mis);</span>

<span class="nc bnc" id="L333" title="All 2 branches missed.">			if (s_log.isDebugEnabled())</span>
			{
<span class="nc" id="L335">				s_log.debug(&quot;downloadHttpFile: writing http response body to file: &quot; + destFile.getAbsolutePath());</span>
			}

<span class="nc" id="L338">			result = copyBytesToFile(mis, destFile);</span>
		}
<span class="nc" id="L340">		catch (IOException e)</span>
		{
<span class="nc" id="L342">			s_log.error(&quot;downloadHttpFile: Unexpected exception while &quot;</span>
				+ &quot;attempting to open an HTTP connection to url (&quot; + url + &quot;) to download a file (&quot;
<span class="nc" id="L344">				+ destFile.getAbsolutePath() + &quot;): &quot; + e.getMessage(), e);</span>
<span class="nc" id="L345">			throw e;</span>
		}
		finally
		{
<span class="nc" id="L349">			closeInputStream(is);</span>
<span class="nc" id="L350">			method.releaseConnection();</span>
		}
<span class="nc" id="L352">		return result;</span>
	}

	/**
	 * Setup proxy configuration specified in proxySettings. This setup is skipped if: 1) proxySettings is
	 * null. 2) proxySettings.getHttpUseProxy() is false (HttpClient doesn't support SOCKS proxy) 3) The url's
	 * host component is in the &quot;non-proxy&quot; host list
	 * 
	 * @param proxySettings
	 *           the ProxySettings to use
	 * @param client
	 *           the instance of HttpClient to configure
	 * @param url
	 *           the URL of the file to be retrieved
	 */
	private void setupProxy(IProxySettings proxySettings, HttpClient client, URL url)
	{
<span class="nc bnc" id="L369" title="All 2 branches missed.">		if (proxySettings == null) { return; }</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">		if (!proxySettings.getHttpUseProxy()) { return; }</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">		if (proxySettings.getHttpNonProxyHosts() != null</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">			&amp;&amp; proxySettings.getHttpNonProxyHosts().contains(url.getHost())) { return; }</span>

<span class="nc" id="L374">		String proxyHost = proxySettings.getHttpProxyServer();</span>
<span class="nc" id="L375">		int proxyPort = Integer.parseInt(proxySettings.getHttpProxyPort());</span>
<span class="nc" id="L376">		String proxyUsername = proxySettings.getHttpProxyUser();</span>
<span class="nc" id="L377">		String proxyPassword = proxySettings.getHttpProxyPassword();</span>

<span class="nc" id="L379">		client.getHostConfiguration().setProxy(proxyHost, proxyPort);</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">		if (proxyUsername != null &amp;&amp; !&quot;&quot;.equals(proxyUsername))</span>
		{
<span class="nc" id="L382">			Credentials credentials = new UsernamePasswordCredentials(proxyUsername, proxyPassword);</span>
<span class="nc" id="L383">			client.getState().setProxyCredentials(AuthScope.ANY, credentials);</span>
		}
<span class="nc" id="L385">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#getLinesFromFile(java.lang.String, java.util.List)
	 */
	@Override
	public List&lt;String&gt; getLinesFromFile(String filename, List&lt;ScriptLineFixer&gt; lineFixers) throws IOException
	{
<span class="nc" id="L393">		ArrayList&lt;String&gt; lines = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L395">		BufferedReader reader = new BufferedReader(new FileReader(filename));</span>
<span class="nc" id="L396">		String line = null;</span>

<span class="nc bnc" id="L398" title="All 2 branches missed.">		while ((line = reader.readLine()) != null)</span>
		{
<span class="nc bnc" id="L400" title="All 2 branches missed.">			if (lineFixers != null)</span>
			{
<span class="nc bnc" id="L402" title="All 2 branches missed.">				for (ScriptLineFixer fixer : lineFixers)</span>
				{
<span class="nc" id="L404">					line = fixer.fixLine(filename, line);</span>
<span class="nc" id="L405">				}</span>
			}
<span class="nc" id="L407">			lines.add(line);</span>
		}
<span class="nc" id="L409">		reader.close();</span>
<span class="nc" id="L410">		return lines;</span>
	}

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities#writeLinesToFile(java.lang.String, java.util.List)
	 */
	@Override
	public void writeLinesToFile(String filename, List&lt;String&gt; lines) throws FileNotFoundException
	{
<span class="nc" id="L419">		PrintWriter out = new PrintWriter(new File(filename));</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">		for (String outline : lines)</span>
		{
<span class="nc" id="L422">			out.write(outline);</span>
<span class="nc" id="L423">			out.write(NEW_LINE);</span>
<span class="nc" id="L424">		}</span>
<span class="nc" id="L425">		out.close();</span>
<span class="nc" id="L426">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.fw.util.IOUtilities# copyResourceFromJarFile(java.lang.String,
	 *      java.lang.String, java.lang.String)
	 */
	@Override
	public void copyResourceFromJarFile(String jarFilename, String resourceName, String destinationFile)
		throws ZipException, IOException
	{
<span class="nc" id="L436">		ZipFile appJar = new ZipFile(new File(jarFilename));</span>
<span class="nc" id="L437">		Enumeration&lt;? extends ZipEntry&gt; entries = appJar.entries();</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">		while (entries.hasMoreElements())</span>
		{
<span class="nc" id="L440">			ZipEntry entry = entries.nextElement();</span>
<span class="nc" id="L441">			String entryName = entry.getName();</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">			if (entryName.endsWith(resourceName))</span>
			{
<span class="nc" id="L444">				InputStream is = null;</span>
				try {
<span class="nc" id="L446">					FileWrapper destinationFileWrapper = fileWrapperFactory.create(destinationFile); </span>
<span class="nc" id="L447">					is = appJar.getInputStream(entry);</span>
<span class="nc" id="L448">					copyBytesToFile(is, destinationFileWrapper);</span>
				} finally {
<span class="nc" id="L450">					closeInputStream(is);</span>
				}
<span class="nc" id="L452">				break;</span>
			}
<span class="nc" id="L454">		}</span>

<span class="nc" id="L456">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>