<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PopupManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.fw.completion</a> &gt; <span class="el_source">PopupManager.java</span></div><h1>PopupManager.java</h1><pre class="source lang-java linenums">/*
 *                 Sun Public License Notice
 *
 * The contents of this file are subject to the Sun Public License
 * Version 1.0 (the &quot;License&quot;). You may not use this file except in
 * compliance with the License. A copy of the License is available at
 * http://www.sun.com/
 *
 * The Original Code is NetBeans. The Initial Developer of the Original
 * Code is Sun Microsystems, Inc. Portions Copyright 1997-2000 Sun
 * Microsystems, Inc. All Rights Reserved.
 *
 * This is a slightly modified version of PopupManager from the Netbeans project.
 */

package net.sourceforge.squirrel_sql.fw.completion;

import java.awt.Rectangle;

import javax.swing.JComponent;
import javax.swing.JLayeredPane;
import javax.swing.JRootPane;

import javax.swing.SwingUtilities;
import java.awt.Component;
import javax.swing.JViewport;


/**
 *  Popup manager allows to display an arbitrary popup component
 *  over the underlying text component.
 *
 *  @author  Martin Roskanin, Miloslav Metelka
 *  @since   03/2002
 */
public class PopupManager
{
<span class="nc" id="L38">   private JComponent _popupParent = null;</span>


	/** Place popup always above cursor */
<span class="nc" id="L42">	public static final Placement Above = new Placement(&quot;Above&quot;); //NOI18N</span>

	/** Place popup always below cursor */
<span class="nc" id="L45">	public static final Placement Below = new Placement(&quot;Below&quot;); //NOI18N</span>

	/** Place popup to larger area. i.e. if place below cursor is
	 larger than place above, then popup will be placed below cursor. */
<span class="nc" id="L49">	public static final Placement Largest = new Placement(&quot;Largest&quot;); //NOI18N</span>

	/** Place popup above cursor. If a place above cursor is insufficient,
	 then popup will be placed below cursor. */
<span class="nc" id="L53">	public static final Placement AbovePreferred = new Placement(&quot;AbovePreferred&quot;); //NOI18N</span>

	/** Place popup below cursor. If a place below cursor is insufficient,
	 then popup will be placed above cursor. */
<span class="nc" id="L57">	public static final Placement BelowPreferred = new Placement(&quot;BelowPreferred&quot;); //NOI18N</span>

   public PopupManager(JComponent popupParent)
<span class="nc" id="L60">   {</span>
<span class="nc" id="L61">      _popupParent = popupParent;</span>
<span class="nc" id="L62">   }</span>

   public void install(
		JComponent popup, Rectangle cursorBounds, Placement placement)
	{

		// Update the bounds of the popup
<span class="nc" id="L69">		Rectangle bounds = computeBounds(popup, _popupParent,</span>
			cursorBounds, placement);

<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (bounds != null)</span>
		{
			// Convert to layered pane's coordinates
<span class="nc" id="L75">			bounds = SwingUtilities.convertRectangle(_popupParent, bounds,</span>
<span class="nc" id="L76">				_popupParent.getRootPane().getLayeredPane());</span>
<span class="nc" id="L77">			popup.setBounds(bounds);</span>

		}
		else
		{ // can't fit -&gt; hide
<span class="nc" id="L82">			popup.setVisible(false);</span>
		}

		/*
		 * CSE: moved this code down here to fix repaint problems on first
		 * display - bounds should be set before install
		 *
		 * Uninstall the old popup from root pane
		 * and install the new one. Even in case
		 * they are the same objects it's necessary
		 * to cover the workspace switches etc.
		 */
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (popup != null)</span>
		{
<span class="nc" id="L96">			removeFromRootPane(popup);</span>
		}
<span class="nc bnc" id="L98" title="All 2 branches missed.">		if (popup != null)</span>
		{
<span class="nc" id="L100">			installToRootPane(popup);</span>
		}
<span class="nc" id="L102">	}</span>


   /** Install popup panel to current textComponent root pane */
	private void installToRootPane(JComponent c)
	{
<span class="nc" id="L108">		JRootPane rp = _popupParent.getRootPane();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">		if (rp != null)</span>
		{
<span class="nc" id="L111">			rp.getLayeredPane().add(c, JLayeredPane.POPUP_LAYER, 0);</span>
		}
<span class="nc" id="L113">	}</span>

	/** Remove popup panel from previous textComponent root pane */
   public void removeFromRootPane(JComponent c)
	{
<span class="nc" id="L118">		JRootPane rp = c.getRootPane();</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (rp != null)</span>
		{
<span class="nc" id="L121">			rp.getLayeredPane().remove(c);</span>
		}
<span class="nc" id="L123">	}</span>

	/** Variation of the method for computing the bounds
	 * for the concrete view component. As the component can possibly
	 * be placed in a scroll pane it's first necessary
	 * to translate the cursor bounds and also translate
	 * back the resulting popup bounds.
	 * @param popup  popup panel to be displayed
	 * @param view component over which the popup is displayed.
	 * @param cursorBounds the bounds of the caret or mouse cursor
	 *    relative to the upper-left corner of the visible view.
	 * @param placement where to place the popup panel according to
	 *    the cursor position.
	 * @return bounds of popup panel relative to the upper-left corner
	 *    of the underlying view component.
	 *    &lt;CODE&gt;null&lt;/CODE&gt; if there is no place to display popup.
	 */
	protected static Rectangle computeBounds(JComponent popup,
														  JComponent view, Rectangle cursorBounds, Placement placement)
	{

		Rectangle ret;
<span class="nc" id="L145">		Component viewParent = view.getParent();</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">		if (viewParent instanceof JViewport)</span>
		{
<span class="nc" id="L148">			Rectangle viewBounds = ((JViewport) viewParent).getViewRect();</span>
<span class="nc" id="L149">			Rectangle translatedCursorBounds = (Rectangle) cursorBounds.clone();</span>
<span class="nc" id="L150">			translatedCursorBounds.translate(-viewBounds.x, -viewBounds.y);</span>

<span class="nc" id="L152">			ret = computeBounds(popup, viewBounds.width, viewBounds.height,</span>
				translatedCursorBounds, placement);

<span class="nc bnc" id="L155" title="All 2 branches missed.">			if (ret != null)</span>
			{ // valid bounds
<span class="nc" id="L157">				ret.translate(viewBounds.x, viewBounds.y);</span>
			}

<span class="nc" id="L160">		}</span>
		else
		{ // not in scroll pane
<span class="nc" id="L163">			ret = computeBounds(popup, view.getWidth(), view.getHeight(),</span>
				cursorBounds, placement);
		}

<span class="nc" id="L167">		return ret;</span>
	}

	/** Computes a best-fit bounds of popup panel
	 *  according to available space in the underlying view
	 *  (visible part of the pane).
	 *  The placement is first evaluated and put into the popup's client property
	 *  by &lt;CODE&gt;popup.putClientProperty(Placement.class, actual-placement)&lt;/CODE&gt;.
	 *  The actual placement is &lt;UL&gt;
	 *  &lt;LI&gt; &lt;CODE&gt;Above&lt;/CODE&gt; if the original placement was &lt;CODE&gt;Above&lt;/CODE&gt;.
	 *  Or if the original placement was &lt;CODE&gt;AbovePreferred&lt;/CODE&gt;
	 *  or &lt;CODE&gt;Largest&lt;/CODE&gt;
	 *  and there is more space above the cursor than below it.
	 *  &lt;LI&gt; &lt;CODE&gt;Below&lt;/CODE&gt; if the original placement was &lt;CODE&gt;Below&lt;/CODE&gt;.
	 *  Or if the original placement was &lt;CODE&gt;BelowPreferred&lt;/CODE&gt;
	 *  or &lt;CODE&gt;Largest&lt;/CODE&gt;
	 *  and there is more space below the cursor than above it.
	 *  &lt;LI&gt; &lt;CODE&gt;AbovePreferred&lt;/CODE&gt; if the original placement
	 *  was &lt;CODE&gt;AbovePreferred&lt;/CODE&gt;
	 *  and there is less space above the cursor than below it.
	 *  &lt;LI&gt; &lt;CODE&gt;BelowPreferred&lt;/CODE&gt; if the original placement
	 *  was &lt;CODE&gt;BelowPreferred&lt;/CODE&gt;
	 *  and there is less space below the cursor than above it.
	 *  &lt;P&gt;Once the placement client property is set
	 *  the &lt;CODE&gt;popup.setSize()&lt;/CODE&gt; is called with the size of the area
	 *  above/below the cursor (indicated by the placement).
	 *  The popup responds by updating its size to the equal or smaller
	 *  size. If it cannot physically fit into the requested area
	 *  it can call
	 *  &lt;CODE&gt;putClientProperty(Placement.class, null)&lt;/CODE&gt;
	 *  on itself to indicate that it cannot fit. The method scans
	 *  the content of the client property upon return from
	 *  &lt;CODE&gt;popup.setSize()&lt;/CODE&gt; and if it finds null there it returns
	 *  null bounds in that case. The only exception is
	 *  if the placement was either &lt;CODE&gt;AbovePreferred&lt;/CODE&gt;
	 *  or &lt;CODE&gt;BelowPreferred&lt;/CODE&gt;. In that case the method
	 *  gives it one more try
	 *  by attempting to fit the popup into (bigger) complementary
	 *  &lt;CODE&gt;Below&lt;/CODE&gt; and &lt;CODE&gt;Above&lt;/CODE&gt; areas (respectively).
	 *  The popup either fits into these (bigger) areas or it again responds
	 *  by returning &lt;CODE&gt;null&lt;/CODE&gt; in the client property in which case
	 *  the method finally gives up and returns null bounds.
	 *
	 *  @param popup popup panel to be displayed
	 *  @param viewWidth width of the visible view area.
	 *  @param viewHeight height of the visible view area.
	 *  @param cursorBounds the bounds of the caret or mouse cursor
	 *    relative to the upper-left corner of the visible view
	 *  @param placement where to place the popup panel according to
	 *    the cursor position
	 *  @return bounds of popup panel relative to the upper-left corner
	 *    of the underlying view.
	 *    &lt;CODE&gt;null&lt;/CODE&gt; if there is no place to display popup.
	 */
	protected static Rectangle computeBounds(JComponent popup,
														  int viewWidth, int viewHeight, Rectangle cursorBounds, Placement placement)
	{

<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (placement == null)</span>
		{
<span class="nc" id="L227">			throw new NullPointerException(&quot;placement cannot be null&quot;); // NOI18N</span>
		}

		// Compute available height above the cursor
<span class="nc" id="L231">		int aboveCursorHeight = cursorBounds.y;</span>
<span class="nc" id="L232">		int belowCursorY = cursorBounds.y + cursorBounds.height;</span>
<span class="nc" id="L233">		int belowCursorHeight = viewHeight - belowCursorY;</span>

		// resolve Largest and *Preferred placements if possible
<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (placement == Largest)</span>
		{
<span class="nc bnc" id="L238" title="All 2 branches missed.">			placement = (aboveCursorHeight &lt; belowCursorHeight)</span>
				? Below
				: Above;

		}
<span class="nc bnc" id="L243" title="All 4 branches missed.">		else if (placement == AbovePreferred</span>
			&amp;&amp; aboveCursorHeight &gt; belowCursorHeight // more space above
		)
		{
<span class="nc" id="L247">			placement = Above;</span>

		}
<span class="nc bnc" id="L250" title="All 4 branches missed.">		else if (placement == BelowPreferred</span>
			&amp;&amp; belowCursorHeight &gt; aboveCursorHeight // more space below
		)
		{
<span class="nc" id="L254">			placement = Below;</span>
		}

<span class="nc" id="L257">		Rectangle popupBounds = null;</span>

		while (true)
		{ // do one or two passes
<span class="nc" id="L261">			popup.putClientProperty(Placement.class, placement);</span>

<span class="nc bnc" id="L263" title="All 4 branches missed.">			int height = (placement == Above || placement == AbovePreferred)</span>
				? aboveCursorHeight
				: belowCursorHeight;

<span class="nc" id="L267">			popup.setSize(viewWidth, height);</span>
<span class="nc" id="L268">			popupBounds = popup.getBounds();</span>

<span class="nc" id="L270">			Placement updatedPlacement = (Placement) popup.getClientProperty(Placement.class);</span>

<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (updatedPlacement != placement)</span>
			{ // popup does not fit with the orig placement
<span class="nc bnc" id="L274" title="All 4 branches missed.">				if (placement == AbovePreferred &amp;&amp; updatedPlacement == null)</span>
				{
<span class="nc" id="L276">					placement = Below;</span>
<span class="nc" id="L277">					continue;</span>

				}
<span class="nc bnc" id="L280" title="All 4 branches missed.">				else if (placement == BelowPreferred &amp;&amp; updatedPlacement == null)</span>
				{
<span class="nc" id="L282">					placement = Above;</span>
<span class="nc" id="L283">					continue;</span>
				}
			}

<span class="nc bnc" id="L287" title="All 2 branches missed.">			if (updatedPlacement == null)</span>
			{
<span class="nc" id="L289">				popupBounds = null;</span>
			}

			break;
		}

<span class="nc bnc" id="L295" title="All 2 branches missed.">		if (popupBounds != null)</span>
		{
			//place popup according to caret position and Placement
<span class="nc" id="L298">			popupBounds.x = Math.min(cursorBounds.x, viewWidth - popupBounds.width);</span>

<span class="nc bnc" id="L300" title="All 4 branches missed.">			popupBounds.y = (placement == Above || placement == AbovePreferred)</span>
				? (aboveCursorHeight - popupBounds.height)
				: belowCursorY;
		}

<span class="nc" id="L305">		return popupBounds;</span>
	}


   /** Placement of popup panel specification */
	public static final class Placement
	{

		private final String representation;

		private Placement(String representation)
<span class="nc" id="L316">		{</span>
<span class="nc" id="L317">			this.representation = representation;</span>
<span class="nc" id="L318">		}</span>

		public String toString()
		{
<span class="nc" id="L322">			return representation;</span>
		}

	}
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>