<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChartHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.session.mainpanel.overview</a> &gt; <span class="el_source">ChartHandler.java</span></div><h1>ChartHandler.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.session.mainpanel.overview;

import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.resources.SquirrelResources;
import net.sourceforge.squirrel_sql.client.session.mainpanel.overview.datascale.DataScale;
import net.sourceforge.squirrel_sql.client.session.mainpanel.overview.datascale.DataScaleListener;
import net.sourceforge.squirrel_sql.client.session.mainpanel.overview.datascale.Interval;
import net.sourceforge.squirrel_sql.client.session.mainpanel.overview.datascale.ScaleFactory;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import org.jfree.chart.*;
import org.jfree.chart.block.*;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.title.LegendTitle;
import org.jfree.data.category.DefaultCategoryDataset;
import org.jfree.ui.HorizontalAlignment;
import org.jfree.ui.RectangleEdge;

import javax.swing.*;
import java.awt.*;
import java.util.ArrayList;
import java.util.HashSet;

<span class="nc" id="L24">public class ChartHandler</span>
{
<span class="nc" id="L26">   private static final StringManager s_stringMgr = StringManagerFactory.getStringManager(ChartHandler.class);</span>


   public static final int MAX_LEGEND_ENTRIES = 10;

   public static void doChart(DataScale xAxisDataScale, DataScale yAxisDataScale, int callDepth, IApplication app, ChartConfigMode mode)
   {
      try
      {
<span class="nc" id="L35">         ArrayList&lt;Object[]&gt; rows = new ArrayList&lt;Object[]&gt;();</span>

<span class="nc bnc" id="L37" title="All 2 branches missed.">         for (Interval xAxisInterval : xAxisDataScale.getIntervals())</span>
         {
<span class="nc" id="L39">            rows.addAll(xAxisInterval.getResultRows());</span>
<span class="nc" id="L40">         }</span>


<span class="nc" id="L43">         ScaleFactory scaleFactory = new ScaleFactory(rows, xAxisDataScale.getColumnIx(), xAxisDataScale.getColumnDisplayDefinition(), callDepth);</span>

<span class="nc" id="L45">         DataScaleListener dumDataScaleListener = new DataScaleListener()</span>
<span class="nc" id="L46">         {</span>
            @Override
            public void intervalSelected(Interval interval, JButton intervalButtonClicked)
            {
<span class="nc" id="L50">            }</span>

            @Override
            public void showInTableWin(Interval interval)
            {
<span class="nc" id="L55">            }</span>

            @Override
            public void showInTable(Interval interval)
            {
<span class="nc" id="L60">            }</span>
         };

<span class="nc" id="L63">         DataScale newScale = scaleFactory.createScale(dumDataScaleListener);</span>


<span class="nc" id="L66">         DefaultCategoryDataset categoryDataset = new DefaultCategoryDataset();</span>

<span class="nc" id="L68">         String category = xAxisDataScale.getColumnDisplayDefinition().getColumnName();</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">         for (Interval interval : newScale.getIntervals())</span>
         {
<span class="nc" id="L72">            categoryDataset.addValue(calculateValue(interval, mode, yAxisDataScale), interval.getLabel(), category);</span>
<span class="nc" id="L73">         }</span>

<span class="nc" id="L75">         String title = &quot;Chart for column: &quot; + xAxisDataScale.getColumnDisplayDefinition().getColumnName();</span>

<span class="nc" id="L77">         JFreeChart chart = ChartFactory.createBarChart(</span>
               title,   // chart title
               category,               // domain axis label
<span class="nc" id="L80">               mode.getYAxisLabel(yAxisDataScale),  // range axis label</span>
               categoryDataset,                  // data
               PlotOrientation.VERTICAL,
               false,                     // include legend
               true,                     // tooltips?
               false                     // URLs?
         );

<span class="nc" id="L88">         JFrame f = new JFrame(title);</span>

<span class="nc" id="L90">         final ImageIcon icon = app.getResources().getIcon(SquirrelResources.IImageNames.APPLICATION_ICON);</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">         if (icon != null)</span>
         {
<span class="nc" id="L93">            f.setIconImage(icon.getImage());</span>
         }


<span class="nc" id="L97">         LegendTitle legendtitle = new LegendTitle(createLegendItemSource(chart));</span>
<span class="nc" id="L98">         BlockContainer blockcontainer = new BlockContainer(new BorderArrangement());</span>
         //blockcontainer.setBorder(new BlockBorder(1.0D, 1.0D, 1.0D, 1.0D));
<span class="nc" id="L100">         LabelBlock labelblock = new LabelBlock(createLabel(newScale, rows), new Font(&quot;SansSerif&quot;, 1, 12));</span>
         //labelblock.setTextAnchor(RectangleAnchor.TOP_LEFT);
<span class="nc" id="L102">         labelblock.setPadding(5D, 5D, 5D, 5D);</span>
<span class="nc" id="L103">         blockcontainer.add(labelblock, RectangleEdge.TOP);</span>
         //LabelBlock labelblock1 = new LabelBlock(createLabel(newScale, rows));
         //labelblock1.setPadding(8D, 20D, 2D, 5D);
         //blockcontainer.add(labelblock1, RectangleEdge.BOTTOM);
<span class="nc" id="L107">         BlockContainer blockcontainer1 = legendtitle.getItemContainer();</span>
<span class="nc" id="L108">         blockcontainer1.setPadding(2D, 10D, 5D, 2D);</span>
<span class="nc" id="L109">         blockcontainer.add(blockcontainer1);</span>
<span class="nc" id="L110">         legendtitle.setWrapper(blockcontainer);</span>
<span class="nc" id="L111">         legendtitle.setPosition(RectangleEdge.BOTTOM);</span>
<span class="nc" id="L112">         legendtitle.setHorizontalAlignment(HorizontalAlignment.LEFT);</span>
<span class="nc" id="L113">         chart.addSubtitle(legendtitle);</span>


<span class="nc" id="L116">         ChartPanel chartPanel = new ChartPanel(chart);</span>
<span class="nc" id="L117">         f.getContentPane().add(chartPanel);</span>


<span class="nc" id="L120">         f.setLocation(app.getMainFrame().getLocationOnScreen());</span>
<span class="nc" id="L121">         f.setSize(app.getMainFrame().getSize());</span>

<span class="nc" id="L123">         f.setVisible(true);</span>
      }
<span class="nc" id="L125">      catch (Exception e)</span>
      {
<span class="nc" id="L127">         throw new RuntimeException(e);</span>
<span class="nc" id="L128">      }</span>

<span class="nc" id="L130">   }</span>

   private static double calculateValue(Interval interval, ChartConfigMode mode, DataScale yAxisDataScale)
   {
<span class="nc bnc" id="L134" title="All 5 branches missed.">      switch(mode)</span>
      {
         case COUNT:
<span class="nc" id="L137">            return interval.getLen();</span>
         case SUM:

<span class="nc" id="L140">            double retSum = 0;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">            for (int i = 0; i &lt; interval.getLen(); i++)</span>
            {
<span class="nc" id="L143">               Object o = interval.get(i);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">               if (null != o)</span>
               {
<span class="nc" id="L146">                  retSum += ((Number) o).doubleValue();</span>
               }
            }
<span class="nc" id="L149">            return retSum;</span>
         case XY_COUNT_DISTINCT:
<span class="nc" id="L151">            HashSet distinctSet = new HashSet();</span>

<span class="nc bnc" id="L153" title="All 2 branches missed.">            for (int i = 0; i &lt; interval.getLen(); i++)</span>
            {
<span class="nc" id="L155">               int dataSetRowIndex = interval.getDataSetRowIndex(i);</span>
<span class="nc" id="L156">               Object obj = yAxisDataScale.getIndexedColumn().getRow(dataSetRowIndex);</span>
<span class="nc" id="L157">               distinctSet.add(obj);</span>
            }

<span class="nc" id="L160">            return distinctSet.size();</span>
         case XY_SUM_COL:
<span class="nc" id="L162">            double retXYSumCol = 0;</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">            for (int i = 0; i &lt; interval.getLen(); i++)</span>
            {
<span class="nc" id="L166">               int dataSetRowIndex = interval.getDataSetRowIndex(i);</span>
<span class="nc" id="L167">               Object obj = yAxisDataScale.getIndexedColumn().getRow(dataSetRowIndex);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">               if (null != obj)</span>
               {
<span class="nc" id="L170">                  retXYSumCol += ((Number) obj).doubleValue();</span>
               }
            }

<span class="nc" id="L174">            return retXYSumCol;</span>

         default:
<span class="nc" id="L177">            throw new IllegalStateException(&quot;Dont know how to handle mode: &quot; + mode);</span>



      }
   }

   private static String createLabel(DataScale dataScale, ArrayList&lt;Object[]&gt; rows)
   {
<span class="nc" id="L186">      String ret = &quot;Contains &quot; + rows.size() + &quot; query result values in &quot; + dataScale.getIntervals().size() + &quot; intervals&quot;;</span>

<span class="nc" id="L188">      String intervalWidth = dataScale.getIntervalWidth();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">      if(null != intervalWidth)</span>
      {
<span class="nc" id="L191">         ret += &quot; of width &quot; + intervalWidth;</span>
      }

<span class="nc" id="L194">      ret += &quot;.\nLegend shows the first and the last query result value of intervals. Intervals that contain no values are omitted.&quot;;</span>


<span class="nc" id="L197">      return ret;</span>
   }

   private static LegendItemSource createLegendItemSource(final JFreeChart chart)
   {
<span class="nc" id="L202">      return new LegendItemSource()</span>
<span class="nc" id="L203">      {</span>
         @Override
         public LegendItemCollection getLegendItems()
         {
<span class="nc" id="L207">            return reduceLegendItems(chart);</span>
         }
      };
   }

   private static LegendItemCollection reduceLegendItems(JFreeChart chart)
   {
<span class="nc" id="L214">      LegendItemCollection legendItems = chart.getPlot().getLegendItems();</span>

<span class="nc" id="L216">      LegendItemCollection ret = new LegendItemCollection();</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">      for (int i = 0; i &lt; legendItems.getItemCount(); i++)</span>
      {
<span class="nc bnc" id="L220" title="All 4 branches missed.">         if(MAX_LEGEND_ENTRIES &lt; i &amp;&amp; MAX_LEGEND_ENTRIES &lt; legendItems.getItemCount())</span>
         {
<span class="nc" id="L222">            ret.add(new LegendItem(&quot;...&quot;));</span>
<span class="nc" id="L223">            ret.add(legendItems.get(legendItems.getItemCount() - 1));</span>
<span class="nc" id="L224">            break;</span>
         }

<span class="nc" id="L227">         ret.add(legendItems.get(i));</span>
      }

<span class="nc" id="L230">      return ret;</span>
   }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>