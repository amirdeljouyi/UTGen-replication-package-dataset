<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DownloadStatusEventHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.update</a> &gt; <span class="el_source">DownloadStatusEventHandler.java</span></div><h1>DownloadStatusEventHandler.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.update;

import javax.swing.JFrame;
import javax.swing.ProgressMonitor;

import net.sourceforge.squirrel_sql.client.update.downloader.ArtifactDownloader;
import net.sourceforge.squirrel_sql.client.update.downloader.event.DownloadEventType;
import net.sourceforge.squirrel_sql.client.update.downloader.event.DownloadStatusEvent;
import net.sourceforge.squirrel_sql.client.update.downloader.event.DownloadStatusListener;
import net.sourceforge.squirrel_sql.fw.gui.GUIUtils;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

/**
 * Listener for download events and handle them appropriately.  Specifically, this controls a ProgressMonitor
 * showing progress to the user as the artifact downloader reports it.  Also, a check is made each time that
 * the downloader sends an event to see if the user canceled the download using the ProgressMonitor's cancel
 * button.  In that case, the downloader is notified that it should stop and will do so the next opportunity
 * it gets.
 * 
 * @author manningr
 */
public class DownloadStatusEventHandler implements DownloadStatusListener
{

	/** I18n strings for this class */
<span class="nc" id="L29">	private static final StringManager s_stringMgr =</span>
<span class="nc" id="L30">		StringManagerFactory.getStringManager(DownloadStatusEventHandler.class);</span>
	
	/** Logger for this class. */
<span class="nc" id="L33">	private final static ILogger s_log = LoggerController.createLogger(DownloadStatusEventHandler.class);</span>

	private static interface i18n
	{
		// i18n[DownloadStatusEventHandler.downloadingUpdatesMsg=Downloading Files]
<span class="nc" id="L38">		String DOWNLOADING_UPDATES_MSG = s_stringMgr.getString(&quot;DownloadStatusEventHandler.downloadingUpdatesMsg&quot;);</span>

		// i18n[DownloadStatusEventHandler.changesRecordedTitle=Changes Recorded]
<span class="nc" id="L41">		String CHANGES_RECORDED_TITLE = s_stringMgr.getString(&quot;DownloadStatusEventHandler.changesRecordedTitle&quot;);</span>

		// i18n[DownloadStatusEventHandler.changesRecordedMsg=Requested changes will be made when
		// SQuirreL is restarted]
<span class="nc" id="L45">		String CHANGES_RECORDED_MSG = s_stringMgr.getString(&quot;DownloadStatusEventHandler.changesRecordedMsg&quot;);</span>

		// i18n[DownloadStatusEventHandler.updateDownloadFailedTitle=Update Download Failed]
		String UPDATE_DOWNLOAD_FAILED_TITLE =
<span class="nc" id="L49">			s_stringMgr.getString(&quot;DownloadStatusEventHandler.updateDownloadFailedTitle&quot;);</span>

		// i18n[DownloadStatusEventHandler.updateDownloadFailedMsg=Please consult the log for details]
		String UPDATE_DOWNLOAD_FAILED_MSG =
<span class="nc" id="L53">			s_stringMgr.getString(&quot;DownloadStatusEventHandler.updateDownloadFailedMsg&quot;);</span>

	   // i18n[DownloadStatusEventHandler.fileLabel=File]
<span class="nc" id="L56">		String FILE_LABEL = </span>
<span class="nc" id="L57">			s_stringMgr.getString(&quot;DownloadStatusEventHandler.fileLabel&quot;);</span>
	}

<span class="nc" id="L60">	ProgressMonitor progressMonitor = null;</span>

<span class="nc" id="L62">	int currentFile = 0;</span>

<span class="nc" id="L64">	int totalFiles = 0;</span>

<span class="nc" id="L66">	private ArtifactDownloader downloader = null;</span>

<span class="nc" id="L68">	private UpdateController controller = null;</span>

	public DownloadStatusEventHandler(UpdateController controller)
<span class="nc" id="L71">	{</span>
<span class="nc" id="L72">		this.controller = controller;</span>
<span class="nc" id="L73">	}</span>

	/**
	 * @param downloader the artifact downloader that will be sending events
	 */
	public void setDownloader(ArtifactDownloader downloader)
	{
<span class="nc" id="L80">		this.downloader = downloader;</span>
<span class="nc" id="L81">	}</span>

	/**
	 * @see net.sourceforge.squirrel_sql.client.update.downloader.event.DownloadStatusListener#
	 *     
	 *     
	 *      handleDownloadStatusEvent(net.sourceforge.squirrel_sql.client.update.downloader.event.DownloadStatusEvent)
	 */
	public void handleDownloadStatusEvent(DownloadStatusEvent evt)
	{
<span class="nc" id="L91">		logDebug(&quot;handleDownloadStatusEvent: processing event: &quot;+evt);</span>
		
<span class="nc bnc" id="L93" title="All 4 branches missed.">		if (progressMonitor != null &amp;&amp; progressMonitor.isCanceled())</span>
		{
<span class="nc" id="L95">			downloader.stopDownload();</span>
<span class="nc" id="L96">			return;</span>
		}
<span class="nc bnc" id="L98" title="All 2 branches missed.">		if (evt.getType() == DownloadEventType.DOWNLOAD_STARTED)</span>
		{
<span class="nc" id="L100">			totalFiles = evt.getFileCountTotal();</span>
<span class="nc" id="L101">			currentFile = 0;</span>
<span class="nc" id="L102">			handleDownloadStarted();</span>
		}
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (evt.getType() == DownloadEventType.DOWNLOAD_FILE_STARTED)</span>
		{
<span class="nc" id="L106">			setNote(i18n.FILE_LABEL + &quot;: &quot; + evt.getFilename());</span>
		}

<span class="nc bnc" id="L109" title="All 2 branches missed.">		if (evt.getType() == DownloadEventType.DOWNLOAD_FILE_COMPLETED)</span>
		{
<span class="nc" id="L111">			setProgress(++currentFile);</span>
		}

<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (evt.getType() == DownloadEventType.DOWNLOAD_STOPPED)</span>
		{
<span class="nc" id="L116">			setProgress(totalFiles);</span>
		}

		// When all updates are retrieved, tell the user that the updates will be installed upon the
		// next startup.
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if (evt.getType() == DownloadEventType.DOWNLOAD_COMPLETED)</span>
		{
<span class="nc" id="L123">			controller.showMessage(i18n.CHANGES_RECORDED_TITLE, i18n.CHANGES_RECORDED_MSG);</span>
<span class="nc" id="L124">			setProgress(totalFiles);</span>
		}
<span class="nc bnc" id="L126" title="All 2 branches missed.">		if (evt.getType() == DownloadEventType.DOWNLOAD_FAILED)</span>
		{
<span class="nc" id="L128">			controller.showErrorMessage(i18n.UPDATE_DOWNLOAD_FAILED_TITLE, i18n.UPDATE_DOWNLOAD_FAILED_MSG);</span>
<span class="nc" id="L129">			setProgress(totalFiles);</span>
		}
<span class="nc" id="L131">	}</span>

	private void setProgress(final int value)
	{
<span class="nc" id="L135">		logDebug(&quot;setProgress: value=&quot;, value);</span>
<span class="nc" id="L136">		GUIUtils.processOnSwingEventThread(new Runnable()</span>
<span class="nc" id="L137">		{</span>
			public void run()
			{
<span class="nc" id="L140">				progressMonitor.setProgress(value);</span>
<span class="nc" id="L141">			}</span>
		});
<span class="nc" id="L143">	}</span>

	private void setNote(final String note)
	{
<span class="nc" id="L147">		logDebug(&quot;setNote: value=&quot;, note);</span>
<span class="nc" id="L148">		GUIUtils.processOnSwingEventThread(new Runnable()</span>
<span class="nc" id="L149">		{</span>
			public void run()
			{
<span class="nc" id="L152">				progressMonitor.setNote(note);</span>
<span class="nc" id="L153">			}</span>
		});
<span class="nc" id="L155">	}</span>

	private void handleDownloadStarted()
	{
<span class="nc" id="L159">		logDebug(&quot;handleDownloadStarted: launching progress monitor&quot;);</span>
<span class="nc" id="L160">		GUIUtils.processOnSwingEventThread(new Runnable()</span>
<span class="nc" id="L161">		{</span>
			public void run()
			{
<span class="nc" id="L164">				final JFrame frame = controller.getMainFrame();</span>
<span class="nc" id="L165">				progressMonitor =</span>
					new ProgressMonitor(frame, i18n.DOWNLOADING_UPDATES_MSG, i18n.DOWNLOADING_UPDATES_MSG, 0,
						totalFiles);
<span class="nc" id="L168">				setProgress(0);</span>
<span class="nc" id="L169">			}</span>
		});
<span class="nc" id="L171">	}</span>

	private void logDebug(Object ... msgs) {
<span class="nc" id="L174">		StringBuilder tmp = new StringBuilder();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">		for (Object msg : msgs) {</span>
<span class="nc" id="L176">			tmp.append(msg.toString());</span>
		}
<span class="nc bnc" id="L178" title="All 2 branches missed.">		if (s_log.isDebugEnabled()) {</span>
<span class="nc" id="L179">			s_log.debug(tmp.toString());</span>
		}
<span class="nc" id="L181">	}</span>
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>