<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HelpViewerWindow.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.gui</a> &gt; <span class="el_source">HelpViewerWindow.java</span></div><h1>HelpViewerWindow.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.gui;

/*
 * Copyright (C) 2003-2004 Colin Bell
 * colbell@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.awt.BorderLayout;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.Font;
import java.io.IOException;
import java.io.PrintWriter;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.swing.BorderFactory;
import javax.swing.ImageIcon;
import javax.swing.JFrame;
import javax.swing.JScrollPane;
import javax.swing.JSplitPane;
import javax.swing.JTree;
import javax.swing.SwingUtilities;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.event.TreeSelectionListener;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeCellRenderer;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.MutableTreeNode;
import javax.swing.tree.TreePath;

import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.plugin.PluginInfo;
import net.sourceforge.squirrel_sql.client.resources.SquirrelResources;
import net.sourceforge.squirrel_sql.client.util.ApplicationFileWrappers;
import net.sourceforge.squirrel_sql.client.util.ApplicationFileWrappersImpl;
import net.sourceforge.squirrel_sql.fw.gui.StatusBar;
import net.sourceforge.squirrel_sql.fw.util.BaseException;
import net.sourceforge.squirrel_sql.fw.util.FileWrapper;
import net.sourceforge.squirrel_sql.fw.util.FileWrapperFactory;
import net.sourceforge.squirrel_sql.fw.util.FileWrapperFactoryImpl;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.Utilities;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;

import org.apache.commons.lang.StringUtils;

/**
 * This window shows the SQuirreL Help files.
 * 
 * @author &lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 */
public class HelpViewerWindow extends JFrame
{
	private static final long serialVersionUID = 1L;

	/** Logger for this class. */
<span class="nc" id="L77">	private final static ILogger s_log = LoggerController.createLogger(HelpViewerWindow.class);</span>

	/** Internationalized strings for this class. */
<span class="nc" id="L80">	private static final StringManager s_stringMgr =</span>
<span class="nc" id="L81">		StringManagerFactory.getStringManager(HelpViewerWindow.class);</span>

	/** Application API. */
	private final IApplication _app;

	/** Tree containing a node for each help document. */
	private JTree _tree;

	/** Panel that displays the help document. */
	private HtmlViewerPanel _detailPnl;

	/** Statusbar at bottom of window. */
<span class="nc" id="L93">	private StatusBar _statusBar = new StatusBar();</span>

	/** Home URL. */
	private URL _homeURL;

	/** Collection of the nodes in the tree keyed by the URL.toString(). */
<span class="nc" id="L99">	private final Map&lt;String, DefaultMutableTreeNode&gt; _nodes = new HashMap&lt;String, DefaultMutableTreeNode&gt;();</span>

	/** factory for creating FileWrappers which insulate the application from direct reference to File */
<span class="nc" id="L102">	private FileWrapperFactory fileWrapperFactory = new FileWrapperFactoryImpl();</span>

	/** A FileWrapper-enhanced version of ApplicationFiles that removes direct references to File */
<span class="nc" id="L105">	private ApplicationFileWrappers applicationFiles = new ApplicationFileWrappersImpl();</span>

	/**
	 * Ctor.
	 * 
	 * @param app
	 *           Application API.
	 * @throws IllegalArgumentException
	 *            Thrown if &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;IApplication&lt;/TT&gt; passed.
	 */
	public HelpViewerWindow(IApplication app) throws IllegalArgumentException, BaseException
	{
		// i18n[HelpViewerWindow.title=SQuirreL SQL Client Help]
<span class="nc" id="L118">		super(s_stringMgr.getString(&quot;HelpViewerWindow.title&quot;));</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (app == null)</span>
		{
<span class="nc" id="L121">			throw new IllegalArgumentException(&quot;IApplication == null&quot;);</span>
		}
<span class="nc" id="L123">		_app = app;</span>
		try
		{
<span class="nc" id="L126">			createGUI();</span>
		}
<span class="nc" id="L128">		catch (IOException ex)</span>
		{
<span class="nc" id="L130">			throw new BaseException(ex);</span>
<span class="nc" id="L131">		}</span>
<span class="nc" id="L132">	}</span>

	/**
	 * @param fileWrapperFactory
	 *           the fileWrapperFactory to set
	 */
	public void setFileWrapperFactory(FileWrapperFactory fileWrapperFactory)
	{
<span class="nc" id="L140">		Utilities.checkNull(&quot;setFileWrapperFactory&quot;, &quot;fileWrapperFactory&quot;, fileWrapperFactory);</span>
<span class="nc" id="L141">		this.fileWrapperFactory = fileWrapperFactory;</span>
<span class="nc" id="L142">	}</span>

	/**
	 * @param applicationFiles the applicationFiles to set
	 */
	public void setApplicationFiles(ApplicationFileWrappers applicationFiles)
	{
<span class="nc" id="L149">		Utilities.checkNull(&quot;setApplicationFiles&quot;, &quot;applicationFiles&quot;, applicationFiles);</span>
<span class="nc" id="L150">		this.applicationFiles = applicationFiles;</span>
<span class="nc" id="L151">	}</span>
	
	
	/**
	 * Set the Document displayed to that defined by the passed URL.
	 * 
	 * @param url
	 *           URL of document to be displayed.
	 */
	private void setSelectedDocument(URL url)
	{
		try
		{
<span class="nc" id="L164">			_detailPnl.gotoURL(url);</span>
			// i18n[HelpViewerWindow.pageloaded=Page loaded.]
<span class="nc" id="L166">			_statusBar.setText(s_stringMgr.getString(&quot;HelpViewerWindow.pageloaded&quot;));</span>
		}
<span class="nc" id="L168">		catch (IOException ex)</span>
		{
			// i18n[HelpViewerWindow.error.displaydocument=Error displaying document]
<span class="nc" id="L171">			s_log.error(s_stringMgr.getString(&quot;HelpViewerWindow.error.displaydocument&quot;), ex);</span>
<span class="nc" id="L172">			_statusBar.setText(ex.toString());</span>
<span class="nc" id="L173">		}</span>
<span class="nc" id="L174">	}</span>

	private void selectTreeNodeForURL(URL url)
	{
		// Strip local part of URL.
<span class="nc" id="L179">		String key = url.toString();</span>
<span class="nc" id="L180">		final int idx = key.lastIndexOf('#');</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if (idx &gt; -1)</span>
		{
<span class="nc" id="L183">			key = key.substring(0, idx);</span>
		}
<span class="nc" id="L185">		DefaultMutableTreeNode node = _nodes.get(key);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">		if (node != null) // &amp;&amp; node != _tree.getLastSelectedPathComponent())</span>
		{
<span class="nc" id="L188">			DefaultTreeModel model = (DefaultTreeModel) _tree.getModel();</span>
<span class="nc" id="L189">			TreePath path = new TreePath(model.getPathToRoot(node));</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">			if (path != null)</span>
			{
<span class="nc" id="L192">				_tree.expandPath(path);</span>
<span class="nc" id="L193">				_tree.scrollPathToVisible(path);</span>
<span class="nc" id="L194">				_tree.setSelectionPath(path);</span>
			}
		}
<span class="nc" id="L197">	}</span>

	/**
	 * Create user interface.
	 */
	private void createGUI() throws IOException
	{
<span class="nc" id="L204">		setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);</span>
<span class="nc" id="L205">		final SquirrelResources rsrc = _app.getResources();</span>
<span class="nc" id="L206">		final ImageIcon icon = rsrc.getIcon(SquirrelResources.IImageNames.VIEW);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">		if (icon != null)</span>
		{
<span class="nc" id="L209">			setIconImage(icon.getImage());</span>
		}

<span class="nc" id="L212">		Container contentPane = getContentPane();</span>
<span class="nc" id="L213">		contentPane.setLayout(new BorderLayout());</span>

<span class="nc" id="L215">		JSplitPane splitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT);</span>
<span class="nc" id="L216">		splitPane.setBorder(BorderFactory.createEmptyBorder());</span>
<span class="nc" id="L217">		splitPane.setOneTouchExpandable(true);</span>
<span class="nc" id="L218">		splitPane.setContinuousLayout(true);</span>
<span class="nc" id="L219">		splitPane.add(createContentsTree(), JSplitPane.LEFT);</span>
<span class="nc" id="L220">		splitPane.add(createDetailsPanel(), JSplitPane.RIGHT);</span>
<span class="nc" id="L221">		contentPane.add(splitPane, BorderLayout.CENTER);</span>
<span class="nc" id="L222">		splitPane.setDividerLocation(200);</span>

<span class="nc" id="L224">		contentPane.add(new HtmlViewerPanelToolBar(_app, _detailPnl), BorderLayout.NORTH);</span>

<span class="nc" id="L226">		Font fn = _app.getFontInfoStore().getStatusBarFontInfo().createFont();</span>
<span class="nc" id="L227">		_statusBar.setFont(fn);</span>
<span class="nc" id="L228">		contentPane.add(_statusBar, BorderLayout.SOUTH);</span>

<span class="nc" id="L230">		pack();</span>

<span class="nc" id="L232">		SwingUtilities.invokeLater(new Runnable()</span>
<span class="nc" id="L233">		{</span>
			public void run()
			{
<span class="nc" id="L236">				_detailPnl.setHomeURL(_homeURL);</span>
<span class="nc" id="L237">				_tree.expandRow(0);</span>
<span class="nc" id="L238">				_tree.expandRow(2);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">				if (_app.getSquirrelPreferences().isFirstRun())</span>
				{
<span class="nc" id="L241">					_tree.setSelectionRow(1);</span>
				}
				else
				{
<span class="nc" id="L245">					_tree.setSelectionRow(3);</span>
				}
<span class="nc" id="L247">				_tree.setRootVisible(false);</span>
<span class="nc" id="L248">			}</span>
		});

<span class="nc" id="L251">		_detailPnl.addListener(new IHtmlViewerPanelListener()</span>
<span class="nc" id="L252">		{</span>
			public void currentURLHasChanged(HtmlViewerPanelListenerEvent evt)
			{
<span class="nc" id="L255">				selectTreeNodeForURL(evt.getHtmlViewerPanel().getURL());</span>
<span class="nc" id="L256">			}</span>

			public void homeURLHasChanged(HtmlViewerPanelListenerEvent evt)
			{
				// Nothing to do.
<span class="nc" id="L261">			}</span>
		});
<span class="nc" id="L263">	}</span>

	/**
	 * Create a tree each node being a link to a document.
	 * 
	 * @return The contents tree.
	 */
	private JScrollPane createContentsTree() throws IOException
	{
		
		// i18n[HelpViewerWindow.help=Help]
<span class="nc" id="L274">		final FolderNode root = new FolderNode(s_stringMgr.getString(&quot;HelpViewerWindow.help&quot;));</span>
<span class="nc" id="L275">		_tree = new JTree(new DefaultTreeModel(root));</span>
<span class="nc" id="L276">		_tree.setShowsRootHandles(true);</span>
<span class="nc" id="L277">		_tree.addTreeSelectionListener(new ObjectTreeSelectionListener());</span>

		// Renderer for tree.
<span class="nc" id="L280">		DefaultTreeCellRenderer renderer = new DefaultTreeCellRenderer();</span>
<span class="nc" id="L281">		SquirrelResources rsrc = _app.getResources();</span>
<span class="nc" id="L282">		renderer.setLeafIcon(rsrc.getIcon(SquirrelResources.IImageNames.HELP_TOPIC));</span>
<span class="nc" id="L283">		renderer.setOpenIcon(rsrc.getIcon(SquirrelResources.IImageNames.HELP_TOC_OPEN));</span>
<span class="nc" id="L284">		renderer.setClosedIcon(rsrc.getIcon(SquirrelResources.IImageNames.HELP_TOC_CLOSED));</span>
<span class="nc" id="L285">		_tree.setCellRenderer(renderer);</span>

		// First put the Welcome to SQuirreL node.
<span class="nc" id="L288">		FileWrapper file = applicationFiles.getWelcomeFile();</span>
		try
		{
			// i18n[HelpViewerWindow.welcome=Welcome]
<span class="nc" id="L292">			DocumentNode dn = new DocumentNode(s_stringMgr.getString(&quot;HelpViewerWindow.welcome&quot;), file);</span>
<span class="nc" id="L293">			root.add(dn);</span>
<span class="nc" id="L294">			_nodes.put(dn.getURL().toString(), dn);</span>
		}
<span class="nc" id="L296">		catch (MalformedURLException ex)</span>
		{
			// i18n[HelpViewerWindow.error.loadwelcomefile=Error retrieving Welcome file URL for {0}]
<span class="nc" id="L299">			String msg = s_stringMgr.getString(&quot;HelpViewerWindow.error.loadwelcomefile&quot;, file.getAbsolutePath());</span>
<span class="nc" id="L300">			s_log.error(msg, ex);</span>
<span class="nc" id="L301">		}</span>

		// Add Help, Licence and Change Log nodes to the tree.
		// i18n[HelpViewerWindow.help=Help]
<span class="nc" id="L305">		final FolderNode helpRoot = new FolderNode(s_stringMgr.getString(&quot;HelpViewerWindow.help&quot;));</span>
<span class="nc" id="L306">		root.add(helpRoot);</span>
<span class="nc" id="L307">		_nodes.put(helpRoot.getURL().toString(), helpRoot);</span>
		// i18n[HelpViewerWindow.licences=Licences]
<span class="nc" id="L309">		final FolderNode licenceRoot = new FolderNode(s_stringMgr.getString(&quot;HelpViewerWindow.licences&quot;));</span>
<span class="nc" id="L310">		root.add(licenceRoot);</span>
<span class="nc" id="L311">		_nodes.put(licenceRoot.getURL().toString(), licenceRoot);</span>
		// i18n[HelpViewerWindow.changelogs=Change Logs]
<span class="nc" id="L313">		final FolderNode changeLogRoot = new FolderNode(s_stringMgr.getString(&quot;HelpViewerWindow.changelogs&quot;));</span>
<span class="nc" id="L314">		root.add(changeLogRoot);</span>
<span class="nc" id="L315">		_nodes.put(changeLogRoot.getURL().toString(), changeLogRoot);</span>

		// Add SQuirreL help to the Help node.
<span class="nc" id="L318">		file = applicationFiles.getQuickStartGuideFile();</span>
		try
		{
			// i18n[HelpViewerWindow.squirrel=SQuirreL]
<span class="nc" id="L322">			DocumentNode dn = new DocumentNode(s_stringMgr.getString(&quot;HelpViewerWindow.squirrel&quot;), file);</span>
<span class="nc" id="L323">			helpRoot.add(dn);</span>
<span class="nc" id="L324">			_homeURL = dn.getURL();</span>
<span class="nc" id="L325">			_nodes.put(_homeURL.toString(), dn);</span>
		}
<span class="nc" id="L327">		catch (MalformedURLException ex)</span>
		{
			// i18n[HelpViewerWindow.error.loadwelcomefile=Error retrieving Help file URL for {0}]
<span class="nc" id="L330">			String msg = s_stringMgr.getString(&quot;HelpViewerWindow.error.loadhelpfile&quot;, file.getAbsolutePath());</span>
<span class="nc" id="L331">			s_log.error(msg, ex);</span>
<span class="nc" id="L332">		}</span>

		// Add SQuirreL Licence to the Licence node.
<span class="nc" id="L335">		file = applicationFiles.getLicenceFile();</span>
		try
		{
			// i18n[HelpViewerWindow.squirrel=SQuirreL]
<span class="nc" id="L339">			DocumentNode dn = new DocumentNode(s_stringMgr.getString(&quot;HelpViewerWindow.squirrel&quot;), file);</span>
<span class="nc" id="L340">			licenceRoot.add(dn);</span>
<span class="nc" id="L341">			_nodes.put(dn.getURL().toString(), dn);</span>
		}
<span class="nc" id="L343">		catch (MalformedURLException ex)</span>
		{
			// i18n[HelpViewerWindow.error.loadlicencefile=Error retrieving Licence file URL for {0}]
<span class="nc" id="L346">			String msg = s_stringMgr.getString(&quot;HelpViewerWindow.error.loadlicencefile&quot;, file.getAbsolutePath());</span>
<span class="nc" id="L347">			s_log.error(msg, ex);</span>
<span class="nc" id="L348">		}</span>

		// Add SQuirreL Change Log to the Licence node.
<span class="nc" id="L351">		file = applicationFiles.getChangeLogFile();</span>
		try
		{
			// i18n[HelpViewerWindow.squirrel=SQuirreL]
<span class="nc" id="L355">			DocumentNode dn = new DocumentNode(s_stringMgr.getString(&quot;HelpViewerWindow.squirrel&quot;), file);</span>
<span class="nc" id="L356">			changeLogRoot.add(dn);</span>
<span class="nc" id="L357">			_nodes.put(dn.getURL().toString(), dn);</span>
		}
<span class="nc" id="L359">		catch (MalformedURLException ex)</span>
		{
			// i18n[HelpViewerWindow.error.loadchangelogfile=Error retrieving Change Log file URL for {0}]
<span class="nc" id="L362">			String msg =</span>
<span class="nc" id="L363">				s_stringMgr.getString(&quot;HelpViewerWindow.error.loadchangelogfile&quot;, file.getAbsolutePath());</span>
<span class="nc" id="L364">			s_log.error(msg, ex);</span>
<span class="nc" id="L365">		}</span>

		// Add plugin help, licence and change log documents to the tree.
<span class="nc" id="L368">		PluginInfo[] pi = _app.getPluginManager().getPluginInformation();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">		for (int i = 0; i &lt; pi.length; ++i)</span>
		{
			try
			{
<span class="nc" id="L373">				final FileWrapper dir = pi[i].getPlugin().getPluginAppSettingsFolder();</span>
<span class="nc" id="L374">				final String title = pi[i].getDescriptiveName();</span>

				// Help document.
				try
				{
<span class="nc" id="L379">					final String fn = pi[i].getHelpFileName();</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">					if (fn != null &amp;&amp; fn.length() &gt; 0)</span>
					{
<span class="nc" id="L382">						DocumentNode dn = new DocumentNode(title, fileWrapperFactory.create(dir, fn));</span>
<span class="nc" id="L383">						helpRoot.add(dn);</span>
<span class="nc" id="L384">						_nodes.put(dn.getURL().toString(), dn);</span>
					}
				}
<span class="nc" id="L387">				catch (IOException ex)</span>
				{
					// i18n[HelpViewerWindow.error.loadpluginhelp=Error generating Help entry for plugin {0}]
<span class="nc" id="L390">					String msg =</span>
<span class="nc" id="L391">						s_stringMgr.getString(&quot;HelpViewerWindow.error.loadpluginhelp&quot;, pi[i].getDescriptiveName());</span>
<span class="nc" id="L392">					s_log.error(msg, ex);</span>
<span class="nc" id="L393">				}</span>

				// Licence document.
				try
				{
<span class="nc" id="L398">					final String fn = pi[i].getLicenceFileName();</span>
<span class="nc bnc" id="L399" title="All 4 branches missed.">					if (fn != null &amp;&amp; fn.length() &gt; 0)</span>
					{
<span class="nc" id="L401">						DocumentNode dn = new DocumentNode(title, fileWrapperFactory.create(dir, fn));</span>
<span class="nc" id="L402">						licenceRoot.add(dn);</span>
<span class="nc" id="L403">						_nodes.put(dn.getURL().toString(), dn);</span>
					}
				}
<span class="nc" id="L406">				catch (IOException ex)</span>
				{
					// i18n[HelpViewerWindow.error.loadpluginlicence=Error generating Licence entry for plugin {0}]
<span class="nc" id="L409">					String msg =</span>
<span class="nc" id="L410">						s_stringMgr.getString(&quot;HelpViewerWindow.error.loadpluginlicence&quot;,</span>
<span class="nc" id="L411">							pi[i].getDescriptiveName());</span>
<span class="nc" id="L412">					s_log.error(msg, ex);</span>
<span class="nc" id="L413">				}</span>

				try
				{
					// Change log.
<span class="nc" id="L418">					final String fn = pi[i].getChangeLogFileName();</span>
<span class="nc bnc" id="L419" title="All 4 branches missed.">					if (fn != null &amp;&amp; fn.length() &gt; 0)</span>
					{
<span class="nc" id="L421">						DocumentNode dn = new DocumentNode(title, fileWrapperFactory.create(dir, fn));</span>
<span class="nc" id="L422">						changeLogRoot.add(dn);</span>
<span class="nc" id="L423">						_nodes.put(dn.getURL().toString(), dn);</span>
					}
				}
<span class="nc" id="L426">				catch (IOException ex)</span>
				{
					// i18n[HelpViewerWindow.error.loadchangelog=Error generating Change Log entry for plugin {0}]
<span class="nc" id="L429">					String msg =</span>
<span class="nc" id="L430">						s_stringMgr.getString(&quot;HelpViewerWindow.error.loadchangelog&quot;, pi[i].getDescriptiveName());</span>
<span class="nc" id="L431">					s_log.error(msg, ex);</span>
<span class="nc" id="L432">				}</span>
			}
<span class="nc" id="L434">			catch (IOException ex)</span>
			{
				// i18n[HelpViewerWindow.error.loadpluginsettings=Error retrieving app settings folder for plugin
				// {0}]
<span class="nc" id="L438">				String msg =</span>
<span class="nc" id="L439">					s_stringMgr.getString(&quot;HelpViewerWindow.error.loadpluginsettings&quot;, pi[i].getDescriptiveName());</span>
<span class="nc" id="L440">				s_log.error(msg, ex);</span>
<span class="nc" id="L441">			}</span>
		}

		// FAQ.
<span class="nc" id="L445">		file = applicationFiles.getFAQFile();</span>
		try
		{
			// i18n[HelpViewerWindow.faq=FAQ]
<span class="nc" id="L449">			DocumentNode dn = new DocumentNode(s_stringMgr.getString(&quot;HelpViewerWindow.faq&quot;), file);</span>
<span class="nc" id="L450">			root.add(dn);</span>
<span class="nc" id="L451">			_nodes.put(dn.getURL().toString(), dn);</span>
		}
<span class="nc" id="L453">		catch (MalformedURLException ex)</span>
		{
			// i18n[HelpViewerWindow.error.loadfaqfile=Error retrieving FAQ from URL = {0}]
<span class="nc" id="L456">			String msg = s_stringMgr.getString(&quot;HelpViewerWindow.error.loadfaqfile&quot;, file.getAbsolutePath());</span>
<span class="nc" id="L457">			s_log.error(msg, ex);</span>
<span class="nc" id="L458">		}</span>

		// generate contents file.
<span class="nc" id="L461">		helpRoot.generateContentsFile();</span>
<span class="nc" id="L462">		licenceRoot.generateContentsFile();</span>
<span class="nc" id="L463">		changeLogRoot.generateContentsFile();</span>

<span class="nc" id="L465">		JScrollPane sp = new JScrollPane(_tree);</span>
<span class="nc" id="L466">		sp.setPreferredSize(new Dimension(200, 200));</span>

<span class="nc" id="L468">		return sp;</span>
	}

	HtmlViewerPanel createDetailsPanel()
	{
<span class="nc" id="L473">		_detailPnl = new HtmlViewerPanel(null);</span>
<span class="nc" id="L474">		return _detailPnl;</span>
	}

	private class DocumentNode extends DefaultMutableTreeNode
	{
		private static final long serialVersionUID = 1L;

		private URL _url;

		DocumentNode(String title, FileWrapper file) throws MalformedURLException
<span class="nc" id="L484">		{</span>
<span class="nc" id="L485">			super(title, false);</span>
<span class="nc" id="L486">			setFile(file);</span>
<span class="nc" id="L487">		}</span>

		DocumentNode(String title, boolean allowsChildren)
<span class="nc" id="L490">		{</span>
<span class="nc" id="L491">			super(title, allowsChildren);</span>
<span class="nc" id="L492">		}</span>

		URL getURL()
		{
<span class="nc" id="L496">			return _url;</span>
		}

		void setFile(FileWrapper file) throws MalformedURLException
		{
<span class="nc" id="L501">			_url = file.toURI().toURL();</span>
<span class="nc" id="L502">		}</span>
	}

	private class FolderNode extends DocumentNode
	{
		private static final long serialVersionUID = 1L;

<span class="nc" id="L509">		private final List&lt;String&gt; _docTitles = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L511">		private final List&lt;URL&gt; _docURLs = new ArrayList&lt;URL&gt;();</span>

		private final FileWrapper _contentsFile;

		FolderNode(String title) throws IOException
<span class="nc" id="L516">		{</span>
<span class="nc" id="L517">			super(title, true);</span>
<span class="nc" id="L518">			_contentsFile = fileWrapperFactory.createTempFile(&quot;sqschelp&quot;, &quot;html&quot;);</span>
<span class="nc" id="L519">			_contentsFile.deleteOnExit();</span>
<span class="nc" id="L520">			setFile(_contentsFile);</span>
<span class="nc" id="L521">		}</span>

		public void add(MutableTreeNode node)
		{
<span class="nc" id="L525">			super.add(node);</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">			if (node instanceof DocumentNode)</span>
			{
<span class="nc" id="L528">				final DocumentNode dn = (DocumentNode) node;</span>
<span class="nc" id="L529">				final URL docURL = dn.getURL();</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">				if (docURL != null)</span>
				{
<span class="nc" id="L532">					String docTitle = dn.toString();</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">					if (StringUtils.isEmpty(docTitle))</span>
					{
<span class="nc" id="L535">						docTitle = docURL.toExternalForm();</span>
					}
<span class="nc" id="L537">					_docTitles.add(docTitle);</span>
<span class="nc" id="L538">					_docURLs.add(docURL);</span>
				}
			}
<span class="nc" id="L541">		}</span>

		synchronized void generateContentsFile()
		{
			try
			{
<span class="nc" id="L547">				final PrintWriter pw = new PrintWriter(_contentsFile.getFileWriter());</span>
				try
				{
<span class="nc" id="L550">					StringBuffer buf = new StringBuffer(50);</span>
<span class="nc" id="L551">					buf.append(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;H1&gt;&quot;).append(toString()).append(&quot;&lt;/H1&gt;&quot;);</span>
<span class="nc" id="L552">					pw.println(buf.toString());</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">					for (int i = 0, limit = _docTitles.size(); i &lt; limit; ++i)</span>
					{
						// final String docTitle = (String)_docTitles.get(i);
<span class="nc" id="L556">						final URL docUrl = _docURLs.get(i);</span>
<span class="nc" id="L557">						buf = new StringBuffer(50);</span>
<span class="nc" id="L558">						buf.append(&quot;&lt;A HREF=\&quot;&quot;).append(docUrl).append(&quot;\&quot;&gt;&quot;).append(_docTitles.get(i)).append(</span>
							&quot;&lt;/A&gt;&lt;BR&gt;&quot;);
<span class="nc" id="L560">						pw.println(buf.toString());</span>
					}
<span class="nc" id="L562">					pw.println(&quot;&lt;/BODY&gt;&lt;/HTML&quot;);</span>
				}
				finally
				{
<span class="nc" id="L566">					pw.close();</span>
				}
			}
<span class="nc" id="L569">			catch (IOException ex)</span>
			{
				// i18n[HelpViewerWindow.error.congen=Error generating Contents file]
<span class="nc" id="L572">				String msg = s_stringMgr.getString(&quot;HelpViewerWindow.error.congen&quot;);</span>
<span class="nc" id="L573">				s_log.error(msg, ex);</span>
<span class="nc" id="L574">				_statusBar.setText(msg);</span>
<span class="nc" id="L575">			}</span>
<span class="nc" id="L576">		}</span>
	}

	/**
	 * This class listens for changes in the node selected in the tree and displays the appropriate help
	 * document for the node.
	 */
<span class="nc" id="L583">	private final class ObjectTreeSelectionListener implements TreeSelectionListener</span>
	{
		public void valueChanged(TreeSelectionEvent evt)
		{
<span class="nc" id="L587">			final TreePath path = evt.getNewLeadSelectionPath();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">			if (path != null)</span>
			{
<span class="nc" id="L590">				Object lastComp = path.getLastPathComponent();</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">				if (lastComp instanceof DocumentNode)</span>
				{
<span class="nc" id="L593">					setSelectedDocument(((DocumentNode) lastComp).getURL());</span>
				}
			}
<span class="nc" id="L596">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>