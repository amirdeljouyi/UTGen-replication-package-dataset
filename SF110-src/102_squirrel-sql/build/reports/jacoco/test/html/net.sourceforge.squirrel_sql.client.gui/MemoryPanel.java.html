<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MemoryPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.gui</a> &gt; <span class="el_source">MemoryPanel.java</span></div><h1>MemoryPanel.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.gui;
/*
 * Copyright (C) 2001-2003 Gerd Wagner
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import net.sourceforge.squirrel_sql.fw.id.IIdentifier;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.Utilities;
import net.sourceforge.squirrel_sql.fw.gui.ErrorDialog;
import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.session.event.SessionEvent;
import net.sourceforge.squirrel_sql.client.session.event.SessionAdapter;
import net.sourceforge.squirrel_sql.client.resources.SquirrelResources;

import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.*;
import java.text.DateFormat;

import javax.swing.*;
import javax.swing.Timer;

public class MemoryPanel extends JPanel
{
    /** Internationalized strings for this class. */
<span class="nc" id="L41">	private static final StringManager s_stringMgr =</span>
<span class="nc" id="L42">		StringManagerFactory.getStringManager(MemoryPanel.class);</span>


	private JProgressBar _bar;
	private JButton _btnGarbage;
	private JButton _btnSessionGCStatus;
	transient private IApplication _app;
<span class="nc" id="L49">	private HashMap&lt;IIdentifier, MemorySessionInfo&gt; _sessionInfosBySessionIDs = </span>
        new HashMap&lt;IIdentifier, MemorySessionInfo&gt;();

	public MemoryPanel(IApplication app)
<span class="nc" id="L53">	{</span>
<span class="nc" id="L54">		_app = app;</span>

<span class="nc" id="L56">		_bar = new JProgressBar();</span>

<span class="nc" id="L58">		_bar.setStringPainted(true);</span>

<span class="nc" id="L60">		_btnGarbage = new JButton();</span>
		// i18n[MemoryPanel.runGC=Run garbage collection]
<span class="nc" id="L62">		_btnGarbage.setToolTipText(s_stringMgr.getString(&quot;MemoryPanel.runGC&quot;));</span>
<span class="nc" id="L63">		_btnGarbage.setBorder(null);</span>

<span class="nc" id="L65">		ImageIcon trashIcon = _app.getResources().getIcon(SquirrelResources.IImageNames.TRASH);</span>
<span class="nc" id="L66">		_btnGarbage.setIcon(trashIcon);</span>

<span class="nc" id="L68">		Dimension prefButtonSize = new Dimension(3 * trashIcon.getIconWidth() / 2, trashIcon.getIconHeight());</span>

<span class="nc" id="L70">		_btnGarbage.setPreferredSize(prefButtonSize);</span>

<span class="nc" id="L72">		_btnGarbage.addActionListener(new ActionListener()</span>
<span class="nc" id="L73">		{</span>
			public void actionPerformed(ActionEvent e)
			{
<span class="nc" id="L76">				Utilities.garbageCollect();</span>
<span class="nc" id="L77">			}</span>
		});

<span class="nc" id="L80">		_btnSessionGCStatus = new JButton()</span>
<span class="nc" id="L81">		{</span>
         public void paint(Graphics g)
			{
<span class="nc" id="L84">				super.paint(g);</span>
//				paintNumWaitingGC(g);
<span class="nc" id="L86">			}</span>
		};

<span class="nc" id="L89">		_btnSessionGCStatus.setBorder(null);</span>

<span class="nc" id="L91">		updateGcStatus();</span>

<span class="nc" id="L93">		_btnSessionGCStatus.setBorder(null);</span>
<span class="nc" id="L94">		_btnSessionGCStatus.setPreferredSize(prefButtonSize);</span>


<span class="nc" id="L97">		_btnSessionGCStatus.addActionListener(new ActionListener()</span>
<span class="nc" id="L98">		{</span>
			public void actionPerformed(ActionEvent e)
			{
<span class="nc" id="L101">				showSessionGCStatus();</span>
<span class="nc" id="L102">			}</span>
		});


<span class="nc" id="L106">		JPanel pnlButtons = new JPanel(new GridLayout(1,2,3,0));</span>
<span class="nc" id="L107">		pnlButtons.add(_btnSessionGCStatus);</span>
<span class="nc" id="L108">		pnlButtons.add(_btnGarbage);</span>


<span class="nc" id="L111">		this.setLayout(new BorderLayout(5,0));</span>
<span class="nc" id="L112">		this.add(pnlButtons, BorderLayout.EAST);</span>
<span class="nc" id="L113">		this.add(_bar, BorderLayout.CENTER);</span>

<span class="nc" id="L115">		this.setBorder(null);</span>

<span class="nc" id="L117">		_app.getSessionManager().addSessionListener(new SessionAdapter()</span>
<span class="nc" id="L118">		{</span>
			public void sessionClosed(SessionEvent evt)
			{
<span class="nc" id="L121">				IIdentifier id = evt.getSession().getIdentifier();</span>
<span class="nc" id="L122">				MemorySessionInfo msi = _sessionInfosBySessionIDs.get(id);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">				if(null == msi)</span>
				{
<span class="nc" id="L125">					throw new IllegalStateException(&quot;A session with ID &quot; + id + &quot; has not been created&quot;);</span>
				}
<span class="nc" id="L127">				msi.closed = new Date();</span>
<span class="nc" id="L128">				updateGcStatus();</span>
<span class="nc" id="L129">			}</span>

			public void sessionConnected(SessionEvent evt)
			{
<span class="nc" id="L133">				IIdentifier id = evt.getSession().getIdentifier();</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">				if(null != _sessionInfosBySessionIDs.get(id))</span>
				{
<span class="nc" id="L136">					throw new IllegalStateException(&quot;A session with ID &quot; + id + &quot; has already been created&quot;);</span>
				}
<span class="nc" id="L138">				MemorySessionInfo msi = new MemorySessionInfo(id, evt.getSession().getAlias().getName());</span>
<span class="nc" id="L139">				_sessionInfosBySessionIDs.put(id, msi);</span>

<span class="nc" id="L141">			}</span>

			public void sessionFinalized(IIdentifier sessionId)
			{
<span class="nc" id="L145">				MemorySessionInfo msi = _sessionInfosBySessionIDs.get(sessionId);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">				if(null == msi)</span>
				{
<span class="nc" id="L148">					throw new IllegalStateException(&quot;A session with ID &quot; + sessionId + &quot; has not been created&quot;);</span>
				}
<span class="nc" id="L150">				msi.finalized = new Date();</span>
<span class="nc" id="L151">				updateGcStatus();</span>
<span class="nc" id="L152">			}</span>
		});

<span class="nc" id="L155">		Timer t = new Timer(500, new ActionListener()</span>
<span class="nc" id="L156">		{</span>
			public void actionPerformed(ActionEvent e)
			{
<span class="nc" id="L159">				updateLabel();</span>
<span class="nc" id="L160">			}</span>
		});
<span class="nc" id="L162">		t.start();</span>
<span class="nc" id="L163">	}</span>

	private void updateGcStatus()
	{
<span class="nc" id="L167">		SessionGCStatus gcStat = getSessionGCStatus();</span>
<span class="nc" id="L168">		_btnSessionGCStatus.setToolTipText(gcStat.tooltip);</span>
<span class="nc" id="L169">		_btnSessionGCStatus.setBackground(gcStat.color);</span>
<span class="nc" id="L170">		_btnSessionGCStatus.setText(gcStat.numSessAwaitingGC);</span>
<span class="nc" id="L171">	}</span>



	private SessionGCStatus getSessionGCStatus()
	{
<span class="nc" id="L177">		SessionGCStatus ret = new SessionGCStatus();</span>

<span class="nc" id="L179">		int numSessAwaitingGC = 0;</span>
<span class="nc" id="L180">		for(Iterator&lt;MemorySessionInfo&gt; i = </span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">            _sessionInfosBySessionIDs.values().iterator(); i.hasNext();)</span>
		{
<span class="nc" id="L183">			MemorySessionInfo msi =  i.next();</span>
<span class="nc bnc" id="L184" title="All 4 branches missed.">			if(null != msi.closed &amp;&amp; null == msi.finalized)</span>
			{
<span class="nc" id="L186">				++numSessAwaitingGC;</span>
			}
<span class="nc" id="L188">		}</span>

<span class="nc" id="L190">		ret.numSessAwaitingGC = &quot;&quot; + numSessAwaitingGC;</span>

		// i18n [MemoryPanel.gcStatusToolTip={0} Sessions waiting for garbage collection]
<span class="nc" id="L193">		ret.tooltip = s_stringMgr.getString(&quot;MemoryPanel.gcStatusToolTip&quot;, new Integer(ret.numSessAwaitingGC));</span>

<span class="nc" id="L195">		ret.color = Color.yellow;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">		if(numSessAwaitingGC &lt; 2)</span>
		{
<span class="nc" id="L198">			ret.color = Color.green;</span>
		}
<span class="nc bnc" id="L200" title="All 2 branches missed.">		else if(numSessAwaitingGC &gt; 4)</span>
		{
<span class="nc" id="L202">			ret.color = Color.red;</span>
		}

<span class="nc" id="L205">		return ret;</span>


	}

	private void updateLabel()
	{
<span class="nc" id="L212">		long total = Runtime.getRuntime().totalMemory() &gt;&gt; 10 &gt;&gt; 10;</span>
<span class="nc" id="L213">		long free = Runtime.getRuntime().freeMemory() &gt;&gt; 10 &gt;&gt; 10;</span>
<span class="nc" id="L214">		long just = total-free;</span>

<span class="nc" id="L216">		_bar.setMinimum(0);</span>
<span class="nc" id="L217">		_bar.setMaximum((int)total);</span>
<span class="nc" id="L218">		_bar.setValue((int)just);</span>

<span class="nc" id="L220">		Object[] params = new Long[]</span>
			{
<span class="nc" id="L222">				Long.valueOf(just),</span>
<span class="nc" id="L223">				Long.valueOf(total)</span>
			};

		// i18n[MemoryPanel.memSize={0} of {1} MB];
<span class="nc" id="L227">		String msg = s_stringMgr.getString(&quot;MemoryPanel.memSize&quot;, params);</span>
<span class="nc" id="L228">		_bar.setString(msg);</span>
<span class="nc" id="L229">	}</span>

	private void showSessionGCStatus()
	{
<span class="nc" id="L233">		StringBuffer[] params = new StringBuffer[]</span>
			{
<span class="nc" id="L235">				new StringBuffer(getSessionGCStatus().tooltip),</span>
				new StringBuffer(),
				new StringBuffer(),
				new StringBuffer()
			};


<span class="nc" id="L242">		MemorySessionInfo[] msis = </span>
<span class="nc" id="L243">            _sessionInfosBySessionIDs.values().toArray(new MemorySessionInfo[0]);</span>

<span class="nc" id="L245">		Arrays.sort(msis);</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">		for (int i = 0; i &lt; msis.length; i++)</span>
		{
<span class="nc bnc" id="L249" title="All 4 branches missed.">			if(null != msis[i].closed &amp;&amp; null == msis[i].finalized)</span>
			{
<span class="nc" id="L251">				params[1].append(msis[i].toString()).append('\n');</span>
			}
<span class="nc bnc" id="L253" title="All 2 branches missed.">			else if(null == msis[i].closed)</span>
			{
<span class="nc" id="L255">				params[2].append(msis[i].toString()).append('\n');</span>
			}
<span class="nc bnc" id="L257" title="All 2 branches missed.">			else if(null != msis[i].finalized)</span>
			{
<span class="nc" id="L259">				params[3].append(msis[i].toString()).append('\n');</span>
			}
		}


		// i18n [MemoryPanel.gcStatus={0}\n\n
		//Sessions waiting for garbage collection:\n
		//==================================================\n
		//{1}\n
		//Sessions open:\n
		//==================================================\n
		//{2}\n
		//Sessions garbage collected:\n
		//==================================================\n
		//{3}\n]
<span class="nc" id="L274">		String msg = s_stringMgr.getString(&quot;MemoryPanel.gcStatus&quot;, (Object[])params);</span>
<span class="nc" id="L275">		ErrorDialog errorDialog = new ErrorDialog(_app.getMainFrame(), msg);</span>


		// i18n[MemoryPanel.statusDialogTitle=Session garbage collection status]
<span class="nc" id="L279">		errorDialog.setTitle(s_stringMgr.getString(&quot;MemoryPanel.statusDialogTitle&quot;));</span>
<span class="nc" id="L280">		errorDialog.setVisible(true);</span>
<span class="nc" id="L281">	}</span>

	private static class MemorySessionInfo implements Comparable&lt;MemorySessionInfo&gt;
	{
		MemorySessionInfo(IIdentifier sessionId, String aliasName)
<span class="nc" id="L286">		{</span>
<span class="nc" id="L287">			this.sessionId = sessionId;</span>
<span class="nc" id="L288">			this.aliasName = aliasName;</span>
<span class="nc" id="L289">		}</span>

		IIdentifier sessionId;
		String aliasName;
<span class="nc" id="L293">		java.util.Date created = new Date();</span>
		java.util.Date closed;
		java.util.Date finalized;

		public String toString()
		{
<span class="nc" id="L299">			DateFormat df = DateFormat.getInstance();</span>

<span class="nc" id="L301">			Object[] params = new Object[]</span>
				{
					sessionId,
					aliasName,
<span class="nc bnc" id="L305" title="All 2 branches missed.">					df.format(created),</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">					null == closed ? &quot;&quot; : df.format(closed),</span>
<span class="nc" id="L307">					null == finalized ? &quot;&quot; :df.format(finalized)</span>
				};

<span class="nc bnc" id="L310" title="All 4 branches missed.">			if(null != closed &amp;&amp; null == finalized)</span>
			{
				// i18n[MemoryPanel.sessionInfo.toString1=Session: ID={0}, Alias={1}: created at {2}, closed at {3}]
<span class="nc" id="L313">				return s_stringMgr.getString(&quot;MemoryPanel.sessionInfo.toString1&quot;, params);</span>
			}
<span class="nc bnc" id="L315" title="All 2 branches missed.">			else if(null == closed)</span>
			{
				// i18n[MemoryPanel.sessionInfo.toString2=Session: ID={0}, Alias={1}: created at {2}]
<span class="nc" id="L318">				return s_stringMgr.getString(&quot;MemoryPanel.sessionInfo.toString2&quot;, params);</span>
			}
<span class="nc bnc" id="L320" title="All 2 branches missed.">			else if(null != finalized)</span>
			{
				// i18n[MemoryPanel.sessionInfo.toString3=Session: ID={0}, Alias={1}: created at {2}, closed at {3}, finalized at {4}]
<span class="nc" id="L323">				return s_stringMgr.getString(&quot;MemoryPanel.sessionInfo.toString3&quot;, params);</span>
			}
			else
			{
<span class="nc" id="L327">				throw new IllegalStateException(&quot;Unknown Session state&quot;);</span>
			}
		}

		public int compareTo(MemorySessionInfo other)
		{
<span class="nc" id="L333">			return Integer.valueOf(sessionId.toString()).compareTo(Integer.valueOf(other.sessionId.toString()));</span>
		}

        /**
         * @see java.lang.Object#hashCode()
         */
        @Override
        public int hashCode() {
<span class="nc" id="L341">            final int prime = 31;</span>
<span class="nc" id="L342">            int result = 1;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            result = prime * result</span>
<span class="nc" id="L344">                    + ((sessionId == null) ? 0 : sessionId.hashCode());</span>
<span class="nc" id="L345">            return result;</span>
        }

        /**
         * @see java.lang.Object#equals(java.lang.Object)
         */
        @Override
        public boolean equals(Object obj) {
<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (this == obj)</span>
<span class="nc" id="L354">                return true;</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (obj == null)</span>
<span class="nc" id="L356">                return false;</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">            if (getClass() != obj.getClass())</span>
<span class="nc" id="L358">                return false;</span>
<span class="nc" id="L359">            final MemorySessionInfo other = (MemorySessionInfo) obj;</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (sessionId == null) {</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                if (other.sessionId != null)</span>
<span class="nc" id="L362">                    return false;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">            } else if (!sessionId.equals(other.sessionId))</span>
<span class="nc" id="L364">                return false;</span>
<span class="nc" id="L365">            return true;</span>
        }
		
		
	}



	private static class SessionGCStatus
	{
		String tooltip;
		Color color;
		String numSessAwaitingGC;
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>