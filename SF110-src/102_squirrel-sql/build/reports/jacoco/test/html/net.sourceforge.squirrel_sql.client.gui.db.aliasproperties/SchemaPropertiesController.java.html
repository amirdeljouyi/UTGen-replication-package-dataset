<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SchemaPropertiesController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.gui.db.aliasproperties</a> &gt; <span class="el_source">SchemaPropertiesController.java</span></div><h1>SchemaPropertiesController.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.gui.db.aliasproperties;

import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.session.schemainfo.SchemaInfoCacheSerializer;
import net.sourceforge.squirrel_sql.client.mainframe.action.ConnectToAliasCommand;
import net.sourceforge.squirrel_sql.client.gui.db.SQLAlias;
import net.sourceforge.squirrel_sql.client.gui.db.SQLAliasSchemaProperties;
import net.sourceforge.squirrel_sql.client.gui.db.ConnectToAliasCallBack;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;
import net.sourceforge.squirrel_sql.fw.sql.ISQLConnection;

import javax.swing.*;
import javax.swing.table.TableColumn;
import javax.swing.table.TableColumnModel;
import javax.swing.table.TableCellEditor;
import javax.swing.table.DefaultTableColumnModel;
import java.awt.*;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;
import java.io.File;

public class SchemaPropertiesController implements IAliasPropertiesPanelController
{
<span class="nc" id="L27">   private static final StringManager s_stringMgr =</span>
<span class="nc" id="L28">      StringManagerFactory.getStringManager(SchemaPropertiesController.class);</span>

<span class="nc" id="L30">   private static final ILogger s_log =</span>
<span class="nc" id="L31">      LoggerController.createLogger(SchemaPropertiesController.class);</span>



   private SchemaPropertiesPanel _pnl;

<span class="nc" id="L37">   private JComboBox _cboTables = new JComboBox();</span>
<span class="nc" id="L38">   private JComboBox _cboView = new JComboBox();</span>
<span class="nc" id="L39">   private JComboBox _cboFunction = new JComboBox();</span>
   private Color _origTblColor;
   private SQLAlias _alias;
   private IApplication _app;
   private SchemaTableModel _schemaTableModel;


   public SchemaPropertiesController(SQLAlias alias, IApplication app)
<span class="nc" id="L47">   {</span>
<span class="nc" id="L48">      _alias = alias;</span>
<span class="nc" id="L49">      _app = app;</span>
<span class="nc" id="L50">      _pnl = new SchemaPropertiesPanel();</span>

<span class="nc" id="L52">      _schemaTableModel = new SchemaTableModel(alias.getSchemaProperties().getSchemaDetails());</span>
<span class="nc" id="L53">      _pnl.tblSchemas.setModel(_schemaTableModel);</span>

<span class="nc" id="L55">      TableColumnModel cm = new DefaultTableColumnModel();</span>

      TableColumn tc;
<span class="nc" id="L58">      tc = new TableColumn(SchemaTableModel.IX_SCHEMA_NAME);</span>
      // i18n[SchemaPropertiesController.tableHeader.schema=Schema]
<span class="nc" id="L60">      tc.setHeaderValue(s_stringMgr.getString(&quot;SchemaPropertiesController.tableHeader.schema&quot;));</span>
<span class="nc" id="L61">      cm.addColumn(tc);</span>

<span class="nc" id="L63">      tc = new TableColumn(SchemaTableModel.IX_TABLE);</span>
      // i18n[SchemaPropertiesController.tableHeader.tables=Tables]
<span class="nc" id="L65">      tc.setHeaderValue(s_stringMgr.getString(&quot;SchemaPropertiesController.tableHeader.tables&quot;));</span>
<span class="nc" id="L66">      tc.setCellEditor(new DefaultCellEditor(initCbo(_cboTables)));</span>
<span class="nc" id="L67">      cm.addColumn(tc);</span>

<span class="nc" id="L69">      tc = new TableColumn(SchemaTableModel.IX_VIEW);</span>
      // i18n[SchemaPropertiesController.tableHeader.views=Views]
<span class="nc" id="L71">      tc.setHeaderValue(s_stringMgr.getString(&quot;SchemaPropertiesController.tableHeader.views&quot;));</span>
<span class="nc" id="L72">      tc.setCellEditor(new DefaultCellEditor(initCbo(_cboView)));</span>
<span class="nc" id="L73">      cm.addColumn(tc);</span>

<span class="nc" id="L75">      tc = new TableColumn(SchemaTableModel.IX_PROCEDURE);</span>
      // i18n[SchemaPropertiesController.tableHeader.procedures=Procedures]
<span class="nc" id="L77">      tc.setHeaderValue(s_stringMgr.getString(&quot;SchemaPropertiesController.tableHeader.procedures&quot;));</span>
<span class="nc" id="L78">      tc.setCellEditor(new DefaultCellEditor(initCbo(_cboFunction)));</span>
<span class="nc" id="L79">      cm.addColumn(tc);</span>

<span class="nc" id="L81">      _pnl.tblSchemas.setColumnModel(cm);</span>

<span class="nc bnc" id="L83" title="All 2 branches missed.">      _pnl.radLoadAllAndCacheNone.setSelected(alias.getSchemaProperties().getGlobalState() == SQLAliasSchemaProperties.GLOBAL_STATE_LOAD_ALL_CACHE_NONE);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">      _pnl.radLoadAndCacheAll.setSelected(alias.getSchemaProperties().getGlobalState() == SQLAliasSchemaProperties.GLOBAL_STATE_LOAD_AND_CACHE_ALL);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">      _pnl.radSpecifySchemas.setSelected(alias.getSchemaProperties().getGlobalState() == SQLAliasSchemaProperties.GLOBAL_STATE_SPECIFY_SCHEMAS);</span>

<span class="nc" id="L87">      _pnl.chkCacheSchemaIndepndentMetaData.setSelected(alias.getSchemaProperties().isCacheSchemaIndependentMetaData());</span>

<span class="nc" id="L89">      _pnl.cboSchemaTableUpdateWhat.addItem(SchemaTableUpdateWhatItem.ALL);</span>
<span class="nc" id="L90">      _pnl.cboSchemaTableUpdateWhat.addItem(SchemaTableUpdateWhatItem.TABLES);</span>
<span class="nc" id="L91">      _pnl.cboSchemaTableUpdateWhat.addItem(SchemaTableUpdateWhatItem.VIEWS);</span>
<span class="nc" id="L92">      _pnl.cboSchemaTableUpdateWhat.addItem(SchemaTableUpdateWhatItem.PROCEDURES);</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">      for (int i = 0; i &lt; SchemaTableCboItem.items.length; i++)</span>
      {
<span class="nc" id="L96">         _pnl.cboSchemaTableUpdateTo.addItem(SchemaTableCboItem.items[i]);</span>
      }


<span class="nc" id="L100">      _pnl.btnSchemaTableUpdateApply.addActionListener(new ActionListener()</span>
<span class="nc" id="L101">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L104">            onSchemaTableUpdateApply();</span>
<span class="nc" id="L105">         }</span>
      });

<span class="nc" id="L108">      updateEnabled();</span>

<span class="nc" id="L110">      _pnl.radLoadAllAndCacheNone.addActionListener(new ActionListener()</span>
<span class="nc" id="L111">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L114">            updateEnabled();</span>
<span class="nc" id="L115">         }</span>
      });
<span class="nc" id="L117">      _pnl.radLoadAndCacheAll.addActionListener(new ActionListener()</span>
<span class="nc" id="L118">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L121">            updateEnabled();</span>
<span class="nc" id="L122">         }</span>
      });
<span class="nc" id="L124">      _pnl.radSpecifySchemas.addActionListener(new ActionListener()</span>
<span class="nc" id="L125">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L128">            updateEnabled();</span>
<span class="nc" id="L129">         }</span>
      });

<span class="nc" id="L132">      _pnl.btnUpdateSchemas.addActionListener(new ActionListener()</span>
<span class="nc" id="L133">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L136">            onRefreshSchemaTable();</span>
<span class="nc" id="L137">         }</span>
      });

<span class="nc" id="L140">      _pnl.btnPrintCacheFileLocation.addActionListener(new ActionListener()</span>
<span class="nc" id="L141">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L144">            onPrintCacheFileLocation();</span>
<span class="nc" id="L145">         }</span>
      });

<span class="nc" id="L148">      _pnl.btnDeleteCache.addActionListener(new ActionListener()</span>
<span class="nc" id="L149">      {</span>
         public void actionPerformed(ActionEvent e)
         {
<span class="nc" id="L152">            onDeleteCache();</span>
<span class="nc" id="L153">         }</span>
      });

<span class="nc" id="L156">   }</span>

   private void onDeleteCache()
   {
<span class="nc" id="L160">      SchemaInfoCacheSerializer.deleteCacheFile(_app, _alias, true);</span>
<span class="nc" id="L161">   }</span>

   private void onPrintCacheFileLocation()
   {
<span class="nc" id="L165">      File schemaCacheFile = SchemaInfoCacheSerializer.getSchemaCacheFile(_alias);</span>

<span class="nc bnc" id="L167" title="All 4 branches missed.">      String aliasName = null == _alias.getName() || 0 == _alias.getName().trim().length() ? &quot;&lt;unnamed&gt;&quot; : _alias.getName();</span>
<span class="nc" id="L168">      String[] params = new String[]{aliasName, schemaCacheFile.getPath()};</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">      if(schemaCacheFile.exists())</span>
      {
         // i18n[SchemaPropertiesController.cacheFilePath=Cache file path for Alias &quot;{0}&quot;: {1}]
<span class="nc" id="L173">         _app.getMessageHandler().showMessage(s_stringMgr.getString(&quot;SchemaPropertiesController.cacheFilePath&quot;, params));</span>
      }
      else
      {
         // i18n[SchemaPropertiesController.cacheFilePathNotExists=Cache file for Alias &quot;{0}&quot; does not exist. If it existed the path would be: {1}]
<span class="nc" id="L178">         _app.getMessageHandler().showMessage(s_stringMgr.getString(&quot;SchemaPropertiesController.cacheFilePathNotExists&quot;, params));</span>
      }
<span class="nc" id="L180">   }</span>

   private void onRefreshSchemaTable()
   {
<span class="nc" id="L184">      ConnectToAliasCallBack cb = new ConnectToAliasCallBack(_app, _alias)</span>
<span class="nc" id="L185">      {</span>
         public void connected(ISQLConnection conn)
         {
<span class="nc" id="L188">            onConnected(conn);</span>
<span class="nc" id="L189">         }</span>
      };

<span class="nc" id="L192">      ConnectToAliasCommand cmd = new ConnectToAliasCommand(_app, _alias, false, cb);</span>
<span class="nc" id="L193">      cmd.execute();</span>
<span class="nc" id="L194">   }</span>

   private void onSchemaTableUpdateApply()
   {
<span class="nc" id="L198">      TableCellEditor cellEditor = _pnl.tblSchemas.getCellEditor();</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">      if(null != cellEditor)</span>
      {
<span class="nc" id="L201">         cellEditor.stopCellEditing();</span>
      }


<span class="nc" id="L205">      SchemaTableUpdateWhatItem selWhatItem = (SchemaTableUpdateWhatItem) _pnl.cboSchemaTableUpdateWhat.getSelectedItem();</span>

<span class="nc" id="L207">      SchemaTableCboItem selToItem = (SchemaTableCboItem) _pnl.cboSchemaTableUpdateTo.getSelectedItem();</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">      if(SchemaTableUpdateWhatItem.TABLES == selWhatItem)</span>
      {
<span class="nc" id="L211">         _schemaTableModel.setColumnTo(SchemaTableModel.IX_TABLE, selToItem);</span>
      }
<span class="nc bnc" id="L213" title="All 2 branches missed.">      else if(SchemaTableUpdateWhatItem.VIEWS == selWhatItem)</span>
      {
<span class="nc" id="L215">         _schemaTableModel.setColumnTo(SchemaTableModel.IX_VIEW, selToItem);</span>
      }
<span class="nc bnc" id="L217" title="All 2 branches missed.">      else if(SchemaTableUpdateWhatItem.PROCEDURES == selWhatItem)</span>
      {
<span class="nc" id="L219">         _schemaTableModel.setColumnTo(SchemaTableModel.IX_PROCEDURE, selToItem);</span>
      } else {
<span class="nc" id="L221">          _schemaTableModel.setColumnTo(SchemaTableModel.IX_TABLE, selToItem);</span>
<span class="nc" id="L222">          _schemaTableModel.setColumnTo(SchemaTableModel.IX_VIEW, selToItem);</span>
<span class="nc" id="L223">          _schemaTableModel.setColumnTo(SchemaTableModel.IX_PROCEDURE, selToItem);</span>
      }
<span class="nc" id="L225">   }</span>



   /**
    * synchronized because the user may connect twice from within the Schema Properties Panel.
    * @param conn
    */
   private synchronized void onConnected(ISQLConnection conn)
   {
      try
      {
<span class="nc" id="L237">         String[] schemas = _app.getSessionManager().getAllowedSchemas(conn, _alias);</span>

<span class="nc" id="L239">         _schemaTableModel.updateSchemas(schemas);</span>

<span class="nc" id="L241">         updateEnabled();</span>
      }
<span class="nc" id="L243">      catch (Exception e)</span>
      {
<span class="nc" id="L245">         s_log.error(&quot;Failed to load Schemas&quot;, e);</span>
<span class="nc" id="L246">      }</span>
<span class="nc" id="L247">   }</span>


   private void updateEnabled()
   {
<span class="nc bnc" id="L252" title="All 2 branches missed.">      if(null == _origTblColor)</span>
      {
<span class="nc" id="L254">         _origTblColor = _pnl.tblSchemas.getForeground();</span>
      }


<span class="nc" id="L258">      _pnl.btnUpdateSchemas.setEnabled(_pnl.radSpecifySchemas.isSelected());</span>

<span class="nc" id="L260">      _pnl.tblSchemas.setEnabled(_pnl.radSpecifySchemas.isSelected());</span>

<span class="nc" id="L262">      _pnl.cboSchemaTableUpdateWhat.setEnabled(_pnl.radSpecifySchemas.isSelected());</span>
<span class="nc" id="L263">      _pnl.cboSchemaTableUpdateTo.setEnabled(_pnl.radSpecifySchemas.isSelected());</span>
<span class="nc" id="L264">      _pnl.btnSchemaTableUpdateApply.setEnabled(_pnl.radSpecifySchemas.isSelected());</span>

<span class="nc bnc" id="L266" title="All 2 branches missed.">      if(_pnl.radSpecifySchemas.isSelected())</span>
      {
<span class="nc" id="L268">         _pnl.tblSchemas.setForeground(_origTblColor);</span>
      }
      else
      {
<span class="nc" id="L272">         _pnl.tblSchemas.setForeground(Color.lightGray);</span>
      }
<span class="nc" id="L274">   }</span>


   private JComboBox initCbo(JComboBox cbo)
   {
<span class="nc" id="L279">      cbo.setEditable(false);</span>

<span class="nc bnc" id="L281" title="All 2 branches missed.">      for (int i = 0; i &lt; SchemaTableCboItem.items.length; i++)</span>
      {
<span class="nc" id="L283">         cbo.addItem(SchemaTableCboItem.items[i]);</span>
      }
<span class="nc" id="L285">      cbo.setSelectedIndex(0);</span>
<span class="nc" id="L286">      return cbo;</span>
   }




   public void applyChanges()
   {

<span class="nc" id="L295">      TableCellEditor cellEditor = _pnl.tblSchemas.getCellEditor();</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">      if(null != cellEditor)</span>
      {
<span class="nc" id="L298">         cellEditor.stopCellEditing();</span>
      }


<span class="nc bnc" id="L302" title="All 2 branches missed.">      if(_pnl.radLoadAllAndCacheNone.isSelected())</span>
      {
<span class="nc" id="L304">         _alias.getSchemaProperties().setGlobalState(SQLAliasSchemaProperties.GLOBAL_STATE_LOAD_ALL_CACHE_NONE);</span>
      }
<span class="nc bnc" id="L306" title="All 2 branches missed.">      else if(_pnl.radLoadAndCacheAll.isSelected())</span>
      {
<span class="nc" id="L308">         _alias.getSchemaProperties().setGlobalState(SQLAliasSchemaProperties.GLOBAL_STATE_LOAD_AND_CACHE_ALL);</span>
      }
<span class="nc bnc" id="L310" title="All 2 branches missed.">      else if(_pnl.radSpecifySchemas.isSelected())</span>
      {
<span class="nc" id="L312">         _alias.getSchemaProperties().setGlobalState(SQLAliasSchemaProperties.GLOBAL_STATE_SPECIFY_SCHEMAS);</span>
      }

<span class="nc" id="L315">      _alias.getSchemaProperties().setSchemaDetails(_schemaTableModel.getData());</span>

<span class="nc" id="L317">      _alias.getSchemaProperties().setCacheSchemaIndependentMetaData(_pnl.chkCacheSchemaIndepndentMetaData.isSelected());</span>

<span class="nc" id="L319">   }</span>

   public String getTitle()
   {
      // i18n[SchemaPropertiesController.title=Schemas]
<span class="nc" id="L324">      return s_stringMgr.getString(&quot;SchemaPropertiesController.title&quot;);</span>
   }

   public String getHint()
   {
      // i18n[SchemaPropertiesController.hint=Schemas (loading and caching)]
<span class="nc" id="L330">      return s_stringMgr.getString(&quot;SchemaPropertiesController.hint&quot;);</span>
   }

   public Component getPanelComponent()
   {
<span class="nc" id="L335">      return _pnl;</span>
   }

   private static class SchemaTableUpdateWhatItem
   {
      // i18n[SchemaTableUpdateWhatItem.tables=Tables]
<span class="nc" id="L341">      public static final SchemaTableUpdateWhatItem TABLES = new SchemaTableUpdateWhatItem(s_stringMgr.getString(&quot;SchemaTableUpdateWhatItem.tables&quot;));</span>
      // i18n[SchemaTableUpdateWhatItem.views=Views]
<span class="nc" id="L343">      public static final SchemaTableUpdateWhatItem VIEWS = new SchemaTableUpdateWhatItem(s_stringMgr.getString(&quot;SchemaTableUpdateWhatItem.views&quot;));</span>
      // i18n[SchemaTableUpdateWhatItem.procedures=Procedures]
<span class="nc" id="L345">      public static final SchemaTableUpdateWhatItem PROCEDURES = new SchemaTableUpdateWhatItem(s_stringMgr.getString(&quot;SchemaTableUpdateWhatItem.procedures&quot;));</span>
      // i18n[SchemaTableUpdateWhatItem.allObjects=All Objects]
<span class="nc" id="L347">      public static final SchemaTableUpdateWhatItem ALL = new SchemaTableUpdateWhatItem(s_stringMgr.getString(&quot;SchemaTableUpdateWhatItem.allObjects&quot;));</span>
      
      private String _name;

      private SchemaTableUpdateWhatItem(String name)
<span class="nc" id="L352">      {</span>
<span class="nc" id="L353">         _name = name;</span>
<span class="nc" id="L354">      }</span>

      public String toString()
      {
<span class="nc" id="L358">         return _name;</span>
      }
   }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>