<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DumpApplicationCommand.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.mainframe.action</a> &gt; <span class="el_source">DumpApplicationCommand.java</span></div><h1>DumpApplicationCommand.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.mainframe.action;
/*
 * Copyright (C) 2002-2004 Colin Bell
 * colbell@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.net.URL;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;

import net.sourceforge.squirrel_sql.fw.datasetviewer.DataSetViewerTextFileDestination;
import net.sourceforge.squirrel_sql.fw.datasetviewer.HashtableDataSet;
import net.sourceforge.squirrel_sql.fw.datasetviewer.IDataSetViewer;
import net.sourceforge.squirrel_sql.fw.util.ICommand;
import net.sourceforge.squirrel_sql.fw.util.IMessageHandler;
import net.sourceforge.squirrel_sql.fw.util.NullMessageHandler;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.beanwrapper.URLWrapper;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;
import net.sourceforge.squirrel_sql.fw.xml.XMLBeanWriter;
import net.sourceforge.squirrel_sql.fw.xml.XMLException;

import net.sourceforge.squirrel_sql.client.ApplicationArguments;
import net.sourceforge.squirrel_sql.client.IApplication;
import net.sourceforge.squirrel_sql.client.Version;
import net.sourceforge.squirrel_sql.client.plugin.PluginInfo;
import net.sourceforge.squirrel_sql.client.preferences.SquirrelPreferences;
import net.sourceforge.squirrel_sql.client.session.ISession;
import net.sourceforge.squirrel_sql.client.session.action.DumpSessionCommand;
import net.sourceforge.squirrel_sql.client.util.ApplicationFiles;
/**
 * This &lt;CODE&gt;ICommand&lt;/CODE&gt; will dump the status of the application.
 *
 * @author &lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 */
public class DumpApplicationCommand implements ICommand
{
	/** Logger for this class. */
<span class="nc" id="L61">	private final ILogger s_log =</span>
<span class="nc" id="L62">		LoggerController.createLogger(DumpApplicationCommand.class);</span>

	/** Prefix for temp file names. */
	private static final String PREFIX = &quot;dump&quot;;

	/** Suffix for temp file names. */
	private static final String SUFFIX = &quot;tmp&quot;;

	/** Used to separate lines of data in the dump file. */
<span class="nc" id="L71">	private static String SEP = &quot;===================================================&quot;;</span>

	/** Application. */
	private IApplication _app;

	/** File to dump application to. */
	private File _outFile;

	/** Message handler to write status/error info to. */
	private IMessageHandler _msgHandler;
    
    /** Internationalized strings for this class. */
<span class="nc" id="L83">    private static final StringManager s_stringMgr =</span>
<span class="nc" id="L84">        StringManagerFactory.getStringManager(DumpApplicationCommand.class);</span>

	/**
	 * Ctor.
	 *
	 * @param	app			Application
	 * @param	outFile		File to dump session to.
	 *
	 * @throws	IllegalArgumentException
	 *			Thrown if a &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;IApplication&lt;/TT&gt; or &lt;TT&gt;File&lt;/TT&gt; passed.
	 */
	public DumpApplicationCommand(IApplication app, File outFile,
									IMessageHandler msgHandler)
	{
<span class="nc" id="L98">		super();</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">		if (app == null)</span>
		{
<span class="nc" id="L101">			throw new IllegalArgumentException(&quot;Null IApplication passed&quot;);</span>
		}
<span class="nc bnc" id="L103" title="All 2 branches missed.">		if (outFile == null)</span>
		{
<span class="nc" id="L105">			throw new IllegalArgumentException(&quot;Null File passed&quot;);</span>
		}
<span class="nc" id="L107">		_app = app;</span>
<span class="nc" id="L108">		_outFile = outFile;</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">		_msgHandler = msgHandler != null ? msgHandler : NullMessageHandler.getInstance();</span>
<span class="nc" id="L111">	}</span>

	/**
	 * Dump the application.
	 */
	public void execute()
	{
<span class="nc" id="L118">		List&lt;File&gt;   files  = new ArrayList&lt;File&gt;();</span>
<span class="nc" id="L119">		List&lt;String&gt; titles = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L120">		synchronized(_app)</span>
		{
<span class="nc" id="L122">			ApplicationStatusBean bean = new ApplicationStatusBean();</span>
<span class="nc" id="L123">			bean.load(_app);</span>
			try
			{
<span class="nc" id="L126">				files.add(createJavaBeanDumpFile(bean));</span>
                //i18n[DumpApplicationCommand.title.status=Application Status Bean]
<span class="nc" id="L128">				titles.add(s_stringMgr.getString(&quot;DumpApplicationCommand.title.status&quot;));</span>
			}
<span class="nc" id="L130">			catch (Throwable th)</span>
			{
                //i18n[DumpApplicationCommand.error.dumpingstatus=Error dumping Application Status bean]
<span class="nc" id="L133">				final String msg = s_stringMgr.getString(&quot;DumpApplicationCommand.error.dumpingstatus&quot;);</span>
<span class="nc" id="L134">				_msgHandler.showMessage(msg);</span>
<span class="nc" id="L135">				_msgHandler.showMessage(th, null);</span>
<span class="nc" id="L136">				s_log.error(msg, th);</span>
<span class="nc" id="L137">			}</span>

			// Dump System Properties.
			try
			{
<span class="nc" id="L142">				File tempFile = File.createTempFile(PREFIX, SUFFIX);</span>
<span class="nc" id="L143">				IDataSetViewer dest = new DataSetViewerTextFileDestination(tempFile);</span>
<span class="nc" id="L144">				dest.show(new HashtableDataSet(System.getProperties()));</span>
<span class="nc" id="L145">				files.add(tempFile);</span>
				//i18n[DumpApplicationCommand.title.systemprops=System Properties]
<span class="nc" id="L147">				titles.add(s_stringMgr.getString(&quot;DumpApplicationCommand.title.systemprops&quot;));</span>
			}
<span class="nc" id="L149">			catch (Throwable th)</span>
			{
                //i18n[DumpApplicationCommand.error.dumpingsystemprops=Error dumping metadata]
<span class="nc" id="L152">				final String msg = s_stringMgr.getString(&quot;DumpApplicationCommand.error.dumpingsystemprops&quot;);</span>
<span class="nc" id="L153">				_msgHandler.showMessage(msg);</span>
<span class="nc" id="L154">				_msgHandler.showMessage(th, null);</span>
<span class="nc" id="L155">				s_log.error(msg, th);</span>
<span class="nc" id="L156">			}</span>

			// Dump drivers
			try
			{
<span class="nc" id="L161">				File tempFile = File.createTempFile(PREFIX, SUFFIX);</span>
<span class="nc" id="L162">				_app.getDataCache().saveDrivers(tempFile);</span>
<span class="nc" id="L163">				files.add(tempFile);</span>
                //i18n[DumpApplicationCommand.title.drivers=Drivers]
<span class="nc" id="L165">				titles.add(s_stringMgr.getString(&quot;DumpApplicationCommand.title.drivers&quot;));</span>
			}
<span class="nc" id="L167">			catch (Throwable th)</span>
			{
                //i18n[DumpApplicationCommand.error.dumpingdrivers=Error dumping drivers]
<span class="nc" id="L170">				final String msg = s_stringMgr.getString(&quot;DumpApplicationCommand.error.dumpingdrivers&quot;);</span>
<span class="nc" id="L171">				_msgHandler.showMessage(msg);</span>
<span class="nc" id="L172">				_msgHandler.showMessage(th, null);</span>
<span class="nc" id="L173">				s_log.error(msg, th);</span>
<span class="nc" id="L174">			}</span>

			// Dump aliases.
			try
			{
<span class="nc" id="L179">				File tempFile = File.createTempFile(PREFIX, SUFFIX);</span>
<span class="nc" id="L180">				_app.getDataCache().saveAliases(tempFile);</span>
<span class="nc" id="L181">				files.add(tempFile);</span>
                //i18n[DumpApplicationCommand.title.aliases=Aliases]
<span class="nc" id="L183">				titles.add(s_stringMgr.getString(&quot;DumpApplicationCommand.title.aliases&quot;));</span>
			}
<span class="nc" id="L185">			catch (Throwable th)</span>
			{
                //i18n[DumpApplicationCommand.error.dumpingaliases=Error dumping aliases]
<span class="nc" id="L188">				final String msg = s_stringMgr.getString(&quot;DumpApplicationCommand.error.dumpingaliases&quot;);</span>
<span class="nc" id="L189">				_msgHandler.showMessage(msg);</span>
<span class="nc" id="L190">				_msgHandler.showMessage(th, null);</span>
<span class="nc" id="L191">				s_log.error(msg, th);</span>
<span class="nc" id="L192">			}</span>

			// Dump sessions.
<span class="nc" id="L195">			final ISession[] sessions = _app.getSessionManager().getConnectedSessions();</span>
<span class="nc" id="L196">			final DumpSessionCommand sessionCmd = new DumpSessionCommand();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">			for (int i = 0; i &lt; sessions.length; ++i)</span>
			{
				try
				{
<span class="nc" id="L201">					File tempFile = File.createTempFile(PREFIX, SUFFIX);</span>
<span class="nc" id="L202">					sessionCmd.setSession(sessions[i]);</span>
<span class="nc" id="L203">					sessionCmd.setDumpFile(tempFile);</span>
<span class="nc" id="L204">					sessionCmd.execute();</span>
<span class="nc" id="L205">					files.add(tempFile);</span>
                    //i18n[DumpApplicationCommand.title.sessiondump=Session Dump: {0}]
<span class="nc" id="L207">                    String title = </span>
<span class="nc" id="L208">                        s_stringMgr.getString(&quot;DumpApplicationCommand.title.sessiondump&quot;,</span>
<span class="nc" id="L209">                                              sessions[i].getIdentifier());</span>
<span class="nc" id="L210">					titles.add(title);</span>
				}
<span class="nc" id="L212">				catch (Throwable th)</span>
				{
                    //i18n[DumpApplicationCommand.error.sessiondump=Error dumping sessions]
<span class="nc" id="L215">					final String msg = s_stringMgr.getString(&quot;DumpApplicationCommand.error.sessiondump&quot;);</span>
<span class="nc" id="L216">					_msgHandler.showMessage(msg);</span>
<span class="nc" id="L217">					_msgHandler.showMessage(th, null);</span>
<span class="nc" id="L218">					s_log.error(msg, th);</span>
<span class="nc" id="L219">				}</span>
			}
<span class="nc" id="L221">		}</span>

<span class="nc" id="L223">		combineTempFiles(titles, files);</span>
<span class="nc" id="L224">		deleteTempFiles(files);</span>
<span class="nc" id="L225">	}</span>

	private void combineTempFiles(List&lt;String&gt; titles, List&lt;File&gt; files)
	{
		try
		{
<span class="nc" id="L231">			PrintWriter wtr = new PrintWriter(new FileWriter(_outFile));</span>
			try
			{
                //i18n[DumpApplicationCommand.header=SQuirreL SQL Client Application Dump {0}]
<span class="nc" id="L235">                String header = s_stringMgr.getString(&quot;DumpApplicationCommand.header&quot;,</span>
<span class="nc" id="L236">                                                      Calendar.getInstance().getTime());</span>
<span class="nc" id="L237">				wtr.println(header);</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">				for (int i = 0, limit = files.size(); i &lt; limit; ++i)</span>
				{
<span class="nc" id="L240">					wtr.println();</span>
<span class="nc" id="L241">					wtr.println();</span>
<span class="nc" id="L242">					wtr.println(SEP);</span>
<span class="nc" id="L243">					wtr.println(titles.get(i));</span>
<span class="nc" id="L244">					wtr.println(SEP);</span>
<span class="nc" id="L245">					BufferedReader rdr = new BufferedReader(new FileReader(files.get(i)));</span>
					try
					{
<span class="nc" id="L248">						String line = null;</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">						while((line = rdr.readLine()) != null)</span>
						{
<span class="nc" id="L251">							wtr.println(line);</span>
						}
					}
					finally
					{
<span class="nc" id="L256">						rdr.close();</span>
					}
				}
			}
			finally
			{
<span class="nc" id="L262">				wtr.close();</span>
			}
		}
<span class="nc" id="L265">		catch (IOException ex)</span>
		{
            //i18n[DumpApplicationCommand.error.combiningtempfiles=Error combining temp files into dump file]
<span class="nc" id="L268">			final String msg = s_stringMgr.getString(&quot;DumpApplicationCommand.error.combiningtempfiles&quot;);</span>
<span class="nc" id="L269">			_msgHandler.showMessage(msg);</span>
<span class="nc" id="L270">			_msgHandler.showMessage(ex.toString());</span>
<span class="nc" id="L271">			s_log.error(msg, ex);</span>
<span class="nc" id="L272">		}</span>
<span class="nc" id="L273">	}</span>

	private void deleteTempFiles(List&lt;File&gt; files)
	{
<span class="nc bnc" id="L277" title="All 2 branches missed.">		for (int i = 0, limit = files.size(); i &lt; limit; ++i)</span>
		{
<span class="nc bnc" id="L279" title="All 2 branches missed.">			if (!(files.get(i)).delete())</span>
			{
                //i18n[DumpApplicationCommand.error.deletetempfile=Couldn't delete temporary DumpSession file]
<span class="nc" id="L282">				s_log.error(s_stringMgr.getString(&quot;DumpApplicationCommand.error.deletetempfile&quot;));</span>
			}
		}
<span class="nc" id="L285">	}</span>

	private File createJavaBeanDumpFile(Object obj)
		throws IOException, XMLException
	{
<span class="nc" id="L290">		File tempFile = File.createTempFile(PREFIX, SUFFIX);</span>
<span class="nc" id="L291">		XMLBeanWriter wtr = new XMLBeanWriter(obj);</span>
<span class="nc" id="L292">		wtr.save(tempFile);</span>

<span class="nc" id="L294">		return tempFile;</span>
	}

	public final static class ApplicationStatusBean
	{
		private SquirrelPreferences _prefs;
		private PluginInfo[] _plugins;
		private String[] _appArgs;
		private String _version;
		private String _pluginLoc;
		private URLWrapper[] _pluginURLs;

		public ApplicationStatusBean()
		{
<span class="nc" id="L308">			super();</span>
<span class="nc" id="L309">		}</span>

		void load(IApplication app)
		{
<span class="nc" id="L313">			_prefs = app.getSquirrelPreferences();</span>
<span class="nc" id="L314">			_plugins = app.getPluginManager().getPluginInformation();</span>
<span class="nc" id="L315">			_appArgs = ApplicationArguments.getInstance().getRawArguments();</span>
<span class="nc" id="L316">			_version = Version.getVersion();</span>
<span class="nc" id="L317">			_pluginLoc = new ApplicationFiles().getPluginsDirectory().getAbsolutePath();</span>
<span class="nc" id="L318">			URL[] urls = app.getPluginManager().getPluginURLs();</span>
<span class="nc" id="L319">			_pluginURLs = new URLWrapper[urls.length];</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">			for (int i = 0; i &lt; urls.length; ++i)</span>
			{
<span class="nc" id="L322">				_pluginURLs[i] = new URLWrapper(urls[i]);</span>
			}
<span class="nc" id="L324">		}</span>

		public String getVersion()
		{
<span class="nc" id="L328">			return _version;</span>
		}

		public SquirrelPreferences getPreferences()
		{
<span class="nc" id="L333">			return _prefs;</span>
		}

		public String getPluginLocation()
		{
<span class="nc" id="L338">			return _pluginLoc;</span>
		}

		public PluginInfo[] getPluginInfo()
		{
<span class="nc" id="L343">			return _plugins;</span>
		}

		public URLWrapper[] getPluginURLs()
		{
<span class="nc" id="L348">			return _pluginURLs;</span>
		}

		public PluginInfo getPluginInfo(int idx)
			throws ArrayIndexOutOfBoundsException
		{
<span class="nc" id="L354">			return _plugins[idx];</span>
		}

		public String[] getApplicationArgument()
		{
<span class="nc" id="L359">			return _appArgs;</span>
		}

		public String getApplicationArgument(int idx)
			throws ArrayIndexOutOfBoundsException
		{
<span class="nc" id="L365">			return _appArgs[idx];</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>