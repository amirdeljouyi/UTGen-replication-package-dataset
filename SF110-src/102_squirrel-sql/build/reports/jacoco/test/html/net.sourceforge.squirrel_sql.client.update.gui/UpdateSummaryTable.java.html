<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UpdateSummaryTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.update.gui</a> &gt; <span class="el_source">UpdateSummaryTable.java</span></div><h1>UpdateSummaryTable.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.update.gui;

/*
 * Copyright (C) 2007 Rob Manning
 * manningr@users.sourceforge.net
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import static net.sourceforge.squirrel_sql.client.update.gui.ArtifactAction.INSTALL;
import static net.sourceforge.squirrel_sql.client.update.gui.ArtifactAction.NONE;
import static net.sourceforge.squirrel_sql.client.update.gui.ArtifactAction.REMOVE;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import javax.swing.ComboBoxModel;
import javax.swing.DefaultCellEditor;
import javax.swing.DefaultComboBoxModel;
import javax.swing.JComboBox;
import javax.swing.JMenuItem;
import javax.swing.JPopupMenu;
import javax.swing.ListSelectionModel;
import javax.swing.event.PopupMenuEvent;
import javax.swing.event.PopupMenuListener;
import javax.swing.table.DefaultTableColumnModel;
import javax.swing.table.TableColumn;
import javax.swing.table.TableColumnModel;

import net.sourceforge.squirrel_sql.fw.gui.SortableTable;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;

/**
 * Implements the table summary of updates which includes artifacts in each of
 * the core, plugins and translations modules.
 * 
 * @author manningr
 */
public class UpdateSummaryTable extends SortableTable {

	private static final long serialVersionUID = 1L;

   /** Internationalized strings for this class. */
<span class="nc" id="L61">   private static final StringManager s_stringMgr = </span>
<span class="nc" id="L62">   	StringManagerFactory.getStringManager(UpdateSummaryTable.class);</span>
   
   private interface i18n {
   	//i18n[UpdateSummaryTable.allTranslationsLabel=All translations]
<span class="nc" id="L66">   	String ALL_TRANSLATIONS_LABEL = s_stringMgr.getString(&quot;UpdateSummaryTable.allTranslationsLabel&quot;);</span>
   	
   	//i18n[UpdateSummaryTable.allPluginsLabel=All plugins]
<span class="nc" id="L69">   	String ALL_PLUGINS_LABEL = s_stringMgr.getString(&quot;UpdateSummaryTable.allPluginsLabel&quot;);</span>
   	
   	//i18n[UpdateSummaryTable.installOptionsLabel=Install Options]
<span class="nc" id="L72">   	String INSTALL_OPTIONS_LABEL = s_stringMgr.getString(&quot;UpdateSummaryTable.installOptionsLabel&quot;);</span>
   }

<span class="nc" id="L75">   private List&lt;ArtifactStatus&gt; _artifacts = null;</span>
<span class="nc" id="L76">   private boolean _releaseVersionWillChange = false;</span>
<span class="nc" id="L77">   private UpdateSummaryTableModel _model = null;</span>
   
   public UpdateSummaryTable(List&lt;ArtifactStatus&gt; artifactStatus, 
                             UpdateSummaryTableModel model) {
<span class="nc" id="L81">      super(model);</span>
<span class="nc" id="L82">      _model = model;</span>
<span class="nc" id="L83">      _artifacts = artifactStatus;</span>
<span class="nc" id="L84">      setSelectionMode(ListSelectionModel.SINGLE_INTERVAL_SELECTION);</span>
<span class="nc" id="L85">      getTableHeader().setResizingAllowed(true);</span>
<span class="nc" id="L86">      getTableHeader().setReorderingAllowed(true);</span>
<span class="nc" id="L87">      setAutoCreateColumnsFromModel(false);</span>
<span class="nc" id="L88">      setAutoResizeMode(AUTO_RESIZE_LAST_COLUMN);</span>

<span class="nc" id="L90">      final TableColumnModel tcm = new DefaultTableColumnModel();</span>
<span class="nc" id="L91">      JComboBox _actionComboBox = new JComboBox();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		for (int i = 0; i &lt; model.getColumnCount(); ++i) {</span>
<span class="nc" id="L93">         final TableColumn col = new TableColumn(i, model.getColumnWidth(i));</span>
<span class="nc" id="L94">         col.setHeaderValue(model.getColumnName(i));</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">         if (i == 3) {</span>
<span class="nc" id="L96">            col.setCellEditor(new DefaultCellEditor(initCbo(_actionComboBox)));</span>
         }
<span class="nc" id="L98">         tcm.addColumn(col);</span>
      }
<span class="nc" id="L100">      setColumnModel(tcm);</span>
<span class="nc" id="L101">      initPopup();</span>
<span class="nc" id="L102">   }</span>

   /**
    * Gets the list of changes requested by the user.
    */
   public List&lt;ArtifactStatus&gt; getUserRequestedChanges() {
<span class="nc" id="L108">      List&lt;ArtifactStatus&gt; changes = new ArrayList&lt;ArtifactStatus&gt;();</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">      for (ArtifactStatus artifactStatus : _artifacts) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">         if (artifactStatus.getArtifactAction() != ArtifactAction.NONE) {</span>
<span class="nc" id="L111">            changes.add(artifactStatus);</span>
         }
<span class="nc" id="L113">      }</span>
<span class="nc" id="L114">      return changes;</span>
   }

	/**
	 * This will adjust the list of artifacts presented to the user based on whether or not the release version
	 * will change.
	 * 
	 * @param releaseVersionWillChange
	 *           a boolean value indicating whether or not the release version will change - that is, whether
	 *           or not new core artifacts will be downloaded.
	 */
	public void setReleaseVersionWillChange(boolean releaseVersionWillChange)
	{
<span class="nc" id="L127">		Iterator&lt;ArtifactStatus&gt; i = _artifacts.iterator();</span>
<span class="nc" id="L128">		_releaseVersionWillChange = releaseVersionWillChange;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">		if (releaseVersionWillChange) {</span>
			// All currently installed artifacts will be marked with INSTALL action. 
<span class="nc bnc" id="L131" title="All 2 branches missed.">			while (i.hasNext()) {</span>
<span class="nc" id="L132">				ArtifactStatus status = i.next();</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">				if (status.isInstalled()) {</span>
<span class="nc" id="L134">					status.setArtifactAction(ArtifactAction.INSTALL);</span>
				}
<span class="nc" id="L136">			}</span>
			
		} else {
			// Remove the core items since they are the most recent, and the user is not allowed to remove them
<span class="nc bnc" id="L140" title="All 2 branches missed.">			while (i.hasNext()) {</span>
<span class="nc" id="L141">				ArtifactStatus status = i.next();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">				if (status.isCoreArtifact()) {</span>
<span class="nc" id="L143">					i.remove();</span>
				}
<span class="nc" id="L145">			}</span>
			
		}
<span class="nc" id="L148">	}</span>
	
	/**
	 * @return a boolean value indicating whether or not the release version will change with this update.
	 */
	public boolean getReleaseVersionWillChange() {
<span class="nc" id="L154">		return _releaseVersionWillChange;</span>
	}
   
   
   private void initPopup() {
<span class="nc" id="L159">      final JPopupMenu popup = new JPopupMenu(i18n.INSTALL_OPTIONS_LABEL);</span>
      
<span class="nc" id="L161">      JMenuItem pluginItem = new JMenuItem(i18n.ALL_PLUGINS_LABEL);</span>
<span class="nc" id="L162">      pluginItem.addActionListener(new ActionListener() {</span>
         public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L164" title="All 2 branches missed.">            for (ArtifactStatus status : _artifacts) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">               if (status.isPluginArtifact()) {</span>
<span class="nc" id="L166">                  status.setArtifactAction(ArtifactAction.INSTALL);</span>
               }
<span class="nc" id="L168">            }</span>
<span class="nc" id="L169">            _model.fireTableDataChanged();</span>
<span class="nc" id="L170">         }</span>
      });
<span class="nc" id="L172">      JMenuItem translationItem = new JMenuItem(i18n.ALL_TRANSLATIONS_LABEL);</span>
<span class="nc" id="L173">      translationItem.addActionListener(new ActionListener() {</span>
         public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L175" title="All 2 branches missed.">            for (ArtifactStatus status : _artifacts) {</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">               if (status.isTranslationArtifact()) {</span>
<span class="nc" id="L177">                  status.setArtifactAction(ArtifactAction.INSTALL);</span>
               }
<span class="nc" id="L179">            }</span>
<span class="nc" id="L180">            _model.fireTableDataChanged();</span>
<span class="nc" id="L181">         }</span>
      });
                  
<span class="nc" id="L184">      popup.add(pluginItem);</span>
<span class="nc" id="L185">      popup.add(translationItem);</span>
      
<span class="nc" id="L187">      addMouseListener(new MouseAdapter() {</span>
         public void mousePressed(MouseEvent event){
<span class="nc bnc" id="L189" title="All 2 branches missed.">          if(popup.isPopupTrigger(event)){</span>
<span class="nc" id="L190">           popup.show(event.getComponent(), event.getX(),event.getY());</span>
          }
<span class="nc" id="L192">         }</span>
         public void mouseReleased(MouseEvent event){
<span class="nc bnc" id="L194" title="All 2 branches missed.">          if(popup.isPopupTrigger(event)){</span>
<span class="nc" id="L195">           popup.show(event.getComponent(), event.getX(),event.getY());</span>
          }
<span class="nc" id="L197">         }</span>
        });            
<span class="nc" id="L199">   }</span>
      
   private JComboBox initCbo(final JComboBox cbo) {
<span class="nc" id="L202">      cbo.setEditable(false);</span>
<span class="nc" id="L203">      setModel(cbo, NONE, INSTALL, REMOVE);</span>
      
<span class="nc" id="L205">      cbo.addPopupMenuListener(new PopupMenuListener() {</span>
<span class="nc" id="L206">			public void popupMenuCanceled(PopupMenuEvent e) {}</span>
<span class="nc" id="L207">			public void popupMenuWillBecomeInvisible(PopupMenuEvent e){}</span>
			public void popupMenuWillBecomeVisible(PopupMenuEvent e)
			{
<span class="nc" id="L210">				JComboBox source =(JComboBox) e.getSource();</span>
<span class="nc" id="L211">				updateDataModel(source);</span>
<span class="nc" id="L212">			}</span>
      });
      
<span class="nc" id="L215">      return cbo;</span>
   }
   
   /**
    *  We want to adjust the items in the popup menu that are available to the user to select
    *  based on 1) whether or not the release version will change, and 2) what type of artifact the row 
    *  is dealing with and 3) whether or not the artifact is already installed   
    * @param e
    * @param source
    */
   private void updateDataModel(JComboBox source) {
<span class="nc" id="L226">		final int row = UpdateSummaryTable.this.getEditingRow();</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		if (row == -1) {</span>
<span class="nc" id="L228">			return;</span>
		}
<span class="nc" id="L230">		final ArtifactStatus as = UpdateSummaryTable.this._artifacts.get(row);</span>
		
		// is it installed?
<span class="nc" id="L233">		boolean installed = as.isInstalled();</span>

		// get the type of artifact
<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (as.isCoreArtifact()) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">			if (_releaseVersionWillChange) {</span>
<span class="nc" id="L238">				source.setModel(getComboBoxModel(INSTALL));</span>
			} else {
				// core artifacts are not displayed
			}
		} else {
<span class="nc bnc" id="L243" title="All 2 branches missed.">			if (_releaseVersionWillChange) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">				if (installed) {</span>
<span class="nc" id="L245">					setModel(source, INSTALL, REMOVE);</span>
				} else {
<span class="nc" id="L247">					setModel(source, NONE, INSTALL);</span>
				}
			} else {
<span class="nc bnc" id="L250" title="All 2 branches missed.">				if (installed) {</span>
<span class="nc" id="L251">					setModel(source, NONE, REMOVE);</span>
				} else {
<span class="nc" id="L253">					setModel(source, NONE, INSTALL);</span>
				}
			}
		}   
<span class="nc" id="L257">   }</span>
   
   private void setModel(JComboBox box, ArtifactAction... actions) {
<span class="nc" id="L260">   	ComboBoxModel oldModel = box.getModel();</span>
<span class="nc" id="L261">   	box.setModel(getComboBoxModel(actions));</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">   	if (oldModel.getSize() != actions.length) {</span>
<span class="nc" id="L263">   		box.firePropertyChange(&quot;itemCount&quot;, oldModel.getSize(), actions.length);</span>
   	}
<span class="nc" id="L265">   }</span>
   
   private ComboBoxModel getComboBoxModel(ArtifactAction... actions) {
<span class="nc" id="L268">   	ComboBoxModel result = new DefaultComboBoxModel(actions);</span>
<span class="nc" id="L269">   	result.setSelectedItem(actions[0]);</span>
<span class="nc" id="L270">   	return result;</span>
   }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>