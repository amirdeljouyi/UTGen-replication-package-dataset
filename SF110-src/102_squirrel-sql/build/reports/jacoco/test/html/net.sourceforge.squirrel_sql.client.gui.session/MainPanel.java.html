<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.gui.session</a> &gt; <span class="el_source">MainPanel.java</span></div><h1>MainPanel.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.gui.session;
/*
 * Copyright (C) 2001-2004 Colin Bell
 * colbell@users.sourceforge.net
 *
 * Modifications Copyright (C) 2003-2004 Jason Height
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
* License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.awt.*;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.prefs.Preferences;

import javax.swing.JPanel;
import javax.swing.JTabbedPane;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;

import net.sourceforge.squirrel_sql.client.gui.builders.UIFactory;
import net.sourceforge.squirrel_sql.client.session.ISession;
import net.sourceforge.squirrel_sql.client.session.mainpanel.IMainPanelTab;
import net.sourceforge.squirrel_sql.client.session.mainpanel.ObjectTreeTab;
import net.sourceforge.squirrel_sql.client.session.mainpanel.SQLPanel;
import net.sourceforge.squirrel_sql.client.session.mainpanel.SQLTab;
import net.sourceforge.squirrel_sql.client.session.mainpanel.objecttree.ObjectTreePanel;
import net.sourceforge.squirrel_sql.client.session.properties.SessionProperties;
import net.sourceforge.squirrel_sql.fw.util.StringManager;
import net.sourceforge.squirrel_sql.fw.util.StringManagerFactory;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;
/**
 * This tabbed panel is the main panel within the session window.
 *
 * @author &lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 */
public class MainPanel extends JPanel
{
   /**
	 * IDs of tabs.
	 */
	public interface ITabIndexes
	{
		int OBJECT_TREE_TAB = 0;
		int SQL_TAB = 1;
	}

	/** Internationalized strings for this class. */
<span class="nc" id="L64">	private static final StringManager s_stringMgr =</span>
<span class="nc" id="L65">		StringManagerFactory.getStringManager(MainPanel.class);</span>

	/** Logger for this class. */
<span class="nc" id="L68">	private static final ILogger s_log = LoggerController.createLogger(MainPanel.class);</span>

	/** Current session. */
	transient private ISession _session;

	/** The tabbed pane. */
<span class="nc" id="L74">	private final JTabbedPane _tabPnl = UIFactory.getInstance().createTabbedPane();</span>

	/** Listener to the sessions properties. */
	transient private PropertyChangeListener _propsListener;

	/** Listener for changes to the tabbed panel. */
	transient private ChangeListener _tabPnlListener;

	/**
	 * Collection of &lt;TT&gt;IMainPanelTab&lt;/TT&gt; objects displayed in
	 * this tabbed panel.
	 */
<span class="nc" id="L86">	private List&lt;IMainPanelTab&gt; _tabs = new ArrayList&lt;IMainPanelTab&gt;();</span>

   private static final String PREFS_KEY_SELECTED_TAB_IX = &quot;squirrelSql_mainPanel_sel_tab_ix&quot;;

	/**
	 * ctor specifying the current session.
	 *
	 * @param	session		Current session.
	 *
	 * @throws	IllegalArgumentException
	 *			If a &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;ISession&lt;/TT&gt; passed.
	 */
	MainPanel(ISession session)
	{
<span class="nc" id="L100">		super(new BorderLayout());</span>

<span class="nc bnc" id="L102" title="All 2 branches missed.">		if (session == null)</span>
		{
<span class="nc" id="L104">			throw new IllegalArgumentException(&quot;ISession == null&quot;);</span>
		}

<span class="nc" id="L107">		_session = session;</span>

<span class="nc" id="L109">		addMainPanelTab(new ObjectTreeTab(), Integer.valueOf('O'));</span>
<span class="nc" id="L110">		addMainPanelTab(new SQLTab(_session), Integer.valueOf('Q'));</span>

<span class="nc" id="L112">		add(_tabPnl, BorderLayout.CENTER);</span>

<span class="nc" id="L114">		propertiesHaveChanged(null);</span>

		// Refresh the currently selected tab.
<span class="nc" id="L117">		(_tabs.get(getTabbedPane().getSelectedIndex())).select();</span>
<span class="nc" id="L118">	}</span>

	public void addNotify()
	{
<span class="nc" id="L122">		super.addNotify();</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">		if (_propsListener == null)</span>
		{
<span class="nc" id="L126">			_propsListener = new PropertyChangeListener()</span>
<span class="nc" id="L127">			{</span>
				public void propertyChange(PropertyChangeEvent evt)
				{
<span class="nc" id="L130">					propertiesHaveChanged(evt.getPropertyName());</span>
<span class="nc" id="L131">				}</span>
			};
<span class="nc" id="L133">			_session.getProperties().addPropertyChangeListener(_propsListener);</span>
		}

<span class="nc" id="L136">		_tabPnlListener = new ChangeListener()</span>
<span class="nc" id="L137">		{</span>
			public void stateChanged(ChangeEvent evt)
			{
<span class="nc" id="L140">				performStateChanged();</span>
<span class="nc" id="L141">			}</span>
		};
<span class="nc" id="L143">		_tabPnl.addChangeListener(_tabPnlListener);</span>
<span class="nc" id="L144">	}</span>

	public void removeNotify()
	{
<span class="nc" id="L148">		super.removeNotify();</span>

<span class="nc bnc" id="L150" title="All 2 branches missed.">		if (_propsListener != null)</span>
		{
<span class="nc" id="L152">			_session.getProperties().removePropertyChangeListener(_propsListener);</span>
<span class="nc" id="L153">			_propsListener = null;</span>
		}

<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (_tabPnlListener != null)</span>
		{
<span class="nc" id="L158">			_tabPnl.removeChangeListener(_tabPnlListener);</span>
<span class="nc" id="L159">			_tabPnlListener = null;</span>
		}
<span class="nc" id="L161">	}</span>

	/**
	 * Add a tab to this panel. If a tab with this title already exists it is
	 * removed from the tabbed pane and the passed tab inserted in its
	 * place. New tabs are inserted at the end.
	 *
	 * @param	tab	 The tab to be added.
    *
    * @return The index of th added tab
	 *
	 * @throws	IllegalArgumentException
	 *			Thrown if a &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;ITablePanelTab&lt;/TT&gt; passed.
	 */
   public int addMainPanelTab(IMainPanelTab tab)
   {
<span class="nc" id="L177">      return addMainPanelTab(tab, null);</span>
   }

	public int addMainPanelTab(IMainPanelTab tab, Integer mnemonic)
	{
<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (tab == null)</span>
		{
<span class="nc" id="L184">			throw new IllegalArgumentException(&quot;Null IMainPanelTab passed&quot;);</span>
		}
<span class="nc" id="L186">		tab.setSession(_session);</span>

<span class="nc" id="L188">      int idx = getTabIndex(tab);</span>


<span class="nc bnc" id="L191" title="All 2 branches missed.">      if (idx != -1)</span>
		{
<span class="nc" id="L193">			_tabPnl.removeTabAt(idx);</span>
<span class="nc" id="L194">			_tabs.set(idx, tab);</span>
		}
		else
		{
<span class="nc" id="L198">			idx = _tabPnl.getTabCount();</span>
<span class="nc" id="L199">			_tabs.add(tab);</span>
		}

<span class="nc" id="L202">      _tabPnl.insertTab(tab.getTitle(), null, tab.getComponent(), tab.getHint(), idx);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">      if(null != tab.getTabComponent())</span>
      {
<span class="nc" id="L205">         _tabPnl.setTabComponentAt(idx, tab.getTabComponent());</span>
      }


<span class="nc" id="L209">      int prefIx = Preferences.userRoot().getInt(PREFS_KEY_SELECTED_TAB_IX, ITabIndexes.OBJECT_TREE_TAB);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">      if(idx == prefIx)</span>
      {
<span class="nc" id="L212">         _tabPnl.setSelectedIndex(prefIx);</span>
      }

<span class="nc bnc" id="L215" title="All 2 branches missed.">      if(null != mnemonic)</span>
      {
<span class="nc" id="L217">         _tabPnl.setMnemonicAt(idx, mnemonic.intValue());</span>

      }

<span class="nc" id="L221">      return idx;</span>
	}

	/**
	 * Add a tab to this panel at the specified index.
	 *
	 * @param	tab		The tab to be added.
	 * @param	idx		The index to add the tab at.
	 *
	 * @param selectInsertedTab
    * @throws	IllegalArgumentException
	 *			Thrown if a &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;ITablePanelTab&lt;/TT&gt; passed.
	 *
	 * @throws	IllegalArgumentException
	 *			Thrown if a tab already exists with the same title as the one
	 *			passed in.
	 */
	public void insertMainPanelTab(IMainPanelTab tab, int idx, boolean selectInsertedTab)
	{
<span class="nc bnc" id="L240" title="All 2 branches missed.">		if (tab == null)</span>
		{
<span class="nc" id="L242">			throw new IllegalArgumentException(&quot;Null IMainPanelTab passed&quot;);</span>
		}

<span class="nc" id="L245">		tab.setSession(_session);</span>

<span class="nc" id="L247">      int checkIdx = getTabIndex(tab);</span>


<span class="nc bnc" id="L250" title="All 2 branches missed.">      if (checkIdx != -1)</span>
		{
<span class="nc" id="L252">			throw new IllegalArgumentException(&quot;A tab with the same title already exists at index &quot; + checkIdx);</span>
		}

<span class="nc" id="L255">		_tabs.add(idx, tab);</span>
<span class="nc" id="L256">		_tabPnl.insertTab(tab.getTitle(), null, tab.getComponent(), tab.getHint(), idx);</span>

<span class="nc bnc" id="L258" title="All 2 branches missed.">      if(null != tab.getTabComponent())</span>
      {
<span class="nc" id="L260">         _tabPnl.setTabComponentAt(idx, tab.getTabComponent());</span>
      }

<span class="nc bnc" id="L263" title="All 2 branches missed.">      if(selectInsertedTab)</span>
      {
<span class="nc" id="L265">         _tabPnl.setSelectedIndex(idx);</span>
      }
<span class="nc" id="L267">   }</span>

   public int getTabIndex(IMainPanelTab tab)
   {
      int checkIdx;
<span class="nc bnc" id="L272" title="All 2 branches missed.">      if(null == tab.getTabComponent())</span>
      {
<span class="nc" id="L274">         checkIdx = _tabPnl.indexOfTab(tab.getTitle());</span>
      }
      else
      {
<span class="nc" id="L278">         checkIdx = _tabPnl.indexOfTabComponent(tab.getTabComponent());</span>
      }
<span class="nc" id="L280">      return checkIdx;</span>
   }

   public int removeMainPanelTab(IMainPanelTab tab)
	{
<span class="nc bnc" id="L285" title="All 2 branches missed.">		if (tab == null)</span>
		{
<span class="nc" id="L287">			throw new IllegalArgumentException(&quot;Null IMainPanelTab passed&quot;);</span>
		}

<span class="nc" id="L290">		int idx = getTabIndex(tab);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">		if (idx == -1)</span>
		{
<span class="nc" id="L293">			return idx;</span>
		}

<span class="nc" id="L296">      _tabs.remove(idx);</span>
<span class="nc" id="L297">		_tabPnl.removeTabAt(idx);</span>

<span class="nc" id="L299">		return idx;</span>
	}



	private void updateState()
	{
<span class="nc" id="L306">      int idx = _tabPnl.getSelectedIndex();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">      if (idx != -1)</span>
      {
<span class="nc" id="L309">         (_tabs.get(idx)).select();</span>
      }
<span class="nc" id="L311">		_session.getApplication().getActionCollection().activationChanged(_session.getSessionInternalFrame());</span>
<span class="nc" id="L312">	}</span>

   public IMainPanelTab getSelectedMainTab()
   {
<span class="nc" id="L316">      int idx = _tabPnl.getSelectedIndex();</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">      if (idx == -1)</span>
      {
<span class="nc" id="L319">         return null;</span>
      }

<span class="nc" id="L322">      return _tabs.get(idx);</span>
   }


	/**
	 * The passed session is closing so tell each tab.
	 *
	 * @param	session		Session being closed.
	 */
	void sessionClosing(ISession session)
	{
<span class="nc bnc" id="L333" title="All 2 branches missed.">		for (Iterator&lt;IMainPanelTab&gt; it = _tabs.iterator(); it.hasNext();)</span>
		{
			try
			{
<span class="nc" id="L337">				(it.next()).sessionClosing(session);</span>
			}
<span class="nc" id="L339">			catch (Throwable th)</span>
			{
<span class="nc" id="L341">				String msg = s_stringMgr.getString(&quot;MainPanel.error.sessionclose&quot;);</span>
<span class="nc" id="L342">				_session.getApplication().showErrorDialog(msg, th);</span>
<span class="nc" id="L343">				s_log.error(msg, th);</span>
<span class="nc" id="L344">			}</span>
		}
<span class="nc" id="L346">	}</span>


   public void sessionWindowClosing()
   {
<span class="nc" id="L351">      getSQLPanel().sessionWindowClosing();</span>
<span class="nc" id="L352">		getObjectTreePanel().sessionWindowClosing();</span>
<span class="nc" id="L353">		int selIx = _tabPnl.getSelectedIndex();</span>

<span class="nc bnc" id="L355" title="All 4 branches missed.">      if(selIx == ITabIndexes.OBJECT_TREE_TAB || selIx == ITabIndexes.SQL_TAB)</span>
      {
<span class="nc" id="L357">         Preferences.userRoot().putInt(PREFS_KEY_SELECTED_TAB_IX, selIx);</span>
      }
<span class="nc" id="L359">   }</span>


	/**
	 * Session properties have changed so update GUI if required.
	 *
	 * @param	propertyName	Name of property that has changed.
	 */
	private void propertiesHaveChanged(String propertyName)
	{
<span class="nc" id="L369">		SessionProperties props = _session.getProperties();</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">		if (propertyName == null</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">			|| propertyName.equals(SessionProperties.IPropertyNames.MAIN_TAB_PLACEMENT))</span>
		{
<span class="nc" id="L373">			_tabPnl.setTabPlacement(props.getMainTabPlacement());</span>
		}
<span class="nc" id="L375">	}</span>

	private void performStateChanged()
	{
		// Needed to guarantee other components a focus lost
		// and to allow to enter the tabs components via tab
		// key in a well defined way (the user can see where the focus is).
<span class="nc" id="L382">		_tabPnl.requestFocusInWindow();</span>

<span class="nc" id="L384">		updateState();</span>
<span class="nc" id="L385">	}</span>

	ObjectTreePanel getObjectTreePanel()
	{
<span class="nc" id="L389">		ObjectTreeTab tab = (ObjectTreeTab)_tabs.get(ITabIndexes.OBJECT_TREE_TAB);</span>
<span class="nc" id="L390">		return (ObjectTreePanel)tab.getComponent();</span>
	}

	SQLPanel getSQLPanel()
	{
<span class="nc" id="L395">		return ((SQLTab)_tabs.get(ITabIndexes.SQL_TAB)).getSQLPanel();</span>
	}

	/**
	 * Retrieve the tabbed pane for this component.
	 *
	 * @return	The tabbed pane.
	 */
	JTabbedPane getTabbedPane()
	{
<span class="nc" id="L405">		return _tabPnl;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>