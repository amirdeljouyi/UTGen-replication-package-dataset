<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseExpander.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">102_squirrel-sql</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.squirrel_sql.client.session.mainpanel.objecttree.expanders</a> &gt; <span class="el_source">DatabaseExpander.java</span></div><h1>DatabaseExpander.java</h1><pre class="source lang-java linenums">package net.sourceforge.squirrel_sql.client.session.mainpanel.objecttree.expanders;
/*
 * Copyright (C) 2002-2003 Colin Bell and Johan Compagner
 * colbell@users.sourceforge.net
 * jcompagner@j-com.nl
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import javax.swing.SwingUtilities;

import net.sourceforge.squirrel_sql.client.session.ISession;
import net.sourceforge.squirrel_sql.client.session.schemainfo.ObjFilterMatcher;
import net.sourceforge.squirrel_sql.client.session.schemainfo.SchemaFilterMatcher;
import net.sourceforge.squirrel_sql.client.session.schemainfo.CatalogFilterMatcher;
import net.sourceforge.squirrel_sql.client.session.mainpanel.objecttree.INodeExpander;
import net.sourceforge.squirrel_sql.client.session.mainpanel.objecttree.ObjectTreeNode;
import net.sourceforge.squirrel_sql.fw.sql.DatabaseObjectInfo;
import net.sourceforge.squirrel_sql.fw.sql.DatabaseObjectType;
import net.sourceforge.squirrel_sql.fw.sql.IDatabaseObjectInfo;
import net.sourceforge.squirrel_sql.fw.sql.ISQLConnection;
import net.sourceforge.squirrel_sql.fw.sql.SQLDatabaseMetaData;
import net.sourceforge.squirrel_sql.fw.util.log.ILogger;
import net.sourceforge.squirrel_sql.fw.util.log.LoggerController;
/**
 * This class handles the expanding of database, catalog and schema nodes
 * in the object tree.
 *
 * @author &lt;A HREF=&quot;mailto:colbell@users.sourceforge.net&quot;&gt;Colin Bell&lt;/A&gt;
 */
public class DatabaseExpander implements INodeExpander
{
	/** Logger for this class. */
<span class="nc" id="L49">	private static ILogger s_log =</span>
<span class="nc" id="L50">		LoggerController.createLogger(DatabaseExpander.class);</span>

	/** Array of the different types of tables in this database. */
<span class="nc" id="L53">	private String[] _tableTypes = new String[] {};</span>

	/**
	 * Ctor.
	 *
	 * @param	session	Current session.
	 *
	 * @throws	IllegalArgumentException
	 * 			Thrown if &lt;TT&gt;null&lt;/TT&gt; &lt;TT&gt;ISession&lt;/TT&gt; passed.
	 */
	public DatabaseExpander(ISession session)
	{
<span class="nc" id="L65">		super();</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">		if (session == null)</span>
		{
<span class="nc" id="L68">			throw new IllegalArgumentException(&quot;ISession == null&quot;);</span>
		}
<span class="nc" id="L70">        GetTableTypes task = new GetTableTypes(session);</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">		if (SwingUtilities.isEventDispatchThread()) {</span>
<span class="nc" id="L72">		    session.getApplication().getThreadPool().addTask(task);</span>
        } else {
<span class="nc" id="L74">            task.run();</span>
        }
<span class="nc" id="L76">    }</span>

    private class GetTableTypes implements Runnable {
        
<span class="nc" id="L80">        ISession _session = null;</span>
        
<span class="nc" id="L82">        public GetTableTypes(ISession session) {</span>
<span class="nc" id="L83">            _session = session;</span>
<span class="nc" id="L84">        }</span>
        
        public void run() {
            try
            {
<span class="nc" id="L89">                _tableTypes = _session.getSQLConnection().getSQLMetaData().getTableTypes();</span>
            }
<span class="nc" id="L91">            catch (SQLException ex)</span>
            {
<span class="nc" id="L93">                s_log.debug(&quot;DBMS doesn't support 'getTableTypes()&quot;, ex);</span>
<span class="nc" id="L94">            }</span>
<span class="nc" id="L95">        }</span>
        
    }
    
	/**
	 * Create the child nodes for the passed parent node and return them. Note
	 * that this method should &lt;B&gt;not&lt;/B&gt; actually add the child nodes to the
	 * parent node as this is taken care of in the caller.
	 *
	 * @param	session	Current session.
	 * @param	node	Node to be expanded.
	 *
	 * @return	A list of &lt;TT&gt;ObjectTreeNode&lt;/TT&gt; objects representing the child
	 *			nodes for the passed node.
	 */
	public List&lt;ObjectTreeNode&gt; createChildren(ISession session, ObjectTreeNode parentNode)
		throws SQLException
	{
<span class="nc" id="L113">		final IDatabaseObjectInfo parentDbinfo = parentNode.getDatabaseObjectInfo();</span>
<span class="nc" id="L114">		final ISQLConnection conn = session.getSQLConnection();</span>
<span class="nc" id="L115">		final SQLDatabaseMetaData md = conn.getSQLMetaData();</span>

<span class="nc" id="L117">		boolean supportsCatalogs = false;</span>
		try
		{
<span class="nc" id="L120">			supportsCatalogs = md.supportsCatalogs();</span>
		}
<span class="nc" id="L122">		catch (SQLException ex)</span>
		{
<span class="nc" id="L124">			s_log.debug(&quot;DBMS doesn't support 'supportsCatalogs()&quot;, ex);</span>
<span class="nc" id="L125">		}</span>

<span class="nc" id="L127">		boolean supportsSchemas = false;</span>
		try
		{
<span class="nc" id="L130">			supportsSchemas = md.supportsSchemas();</span>
		}
<span class="nc" id="L132">		catch (SQLException ex)</span>
		{
<span class="nc" id="L134">			s_log.debug(&quot;DBMS doesn't support 'supportsSchemas()&quot;, ex);</span>
<span class="nc" id="L135">		}</span>

<span class="nc" id="L137">		List&lt;ObjectTreeNode&gt; childNodes = new ArrayList&lt;ObjectTreeNode&gt;();</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (parentDbinfo.getDatabaseObjectType() == DatabaseObjectType.SESSION)</span>
		{
			// If a driver says it supports schemas/catalogs but doesn't
			// provide schema/catalog nodes, try to get other nodes.
<span class="nc" id="L143">			List&lt;ObjectTreeNode&gt; addedChildren = new ArrayList&lt;ObjectTreeNode&gt;();</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">			if (supportsCatalogs)</span>
			{
<span class="nc" id="L146">				addedChildren = createCatalogNodes(session, md);</span>
<span class="nc" id="L147">				childNodes.addAll(addedChildren);</span>
			}
//			else if (supportsSchemas)
<span class="nc bnc" id="L150" title="All 4 branches missed.">			if (addedChildren.size() == 0 &amp;&amp; supportsSchemas)</span>
			{
<span class="nc" id="L152">				addedChildren = createSchemaNodes(session, md, null);</span>
<span class="nc" id="L153">				childNodes.addAll(addedChildren);</span>
			}
//			else
<span class="nc bnc" id="L156" title="All 2 branches missed.">			if (addedChildren.size() == 0)</span>
			{
<span class="nc" id="L158">				childNodes.addAll(createObjectTypeNodes(session, null, null));</span>
			}
<span class="nc" id="L160">		}</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">		else if (parentDbinfo.getDatabaseObjectType() == DatabaseObjectType.CATALOG)</span>
		{
			// If a driver says it supports schemas but doesn't
			// provide schema nodes, try to get other nodes.
<span class="nc" id="L165">			final String catalogName = parentDbinfo.getSimpleName();</span>
<span class="nc" id="L166">			List&lt;ObjectTreeNode&gt; addedChildren = new ArrayList&lt;ObjectTreeNode&gt;();</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">			if (supportsSchemas)</span>
			{
<span class="nc" id="L169">				addedChildren = createSchemaNodes(session, md, catalogName);</span>
<span class="nc" id="L170">				childNodes.addAll(addedChildren);</span>
			}
			//else
<span class="nc bnc" id="L173" title="All 2 branches missed.">			if (addedChildren.size() == 0)</span>
			{
<span class="nc" id="L175">				childNodes.addAll(createObjectTypeNodes(session, catalogName, null));</span>
			}
<span class="nc" id="L177">		}</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">		else if (parentDbinfo.getDatabaseObjectType() == DatabaseObjectType.SCHEMA)</span>
		{
<span class="nc" id="L180">			final String catalogName = parentDbinfo.getCatalogName();</span>
<span class="nc" id="L181">			final String schemaName = parentDbinfo.getSimpleName();</span>
<span class="nc" id="L182">			childNodes.addAll(createObjectTypeNodes(session, catalogName, schemaName));</span>
		}

<span class="nc" id="L185">		return childNodes;</span>
	}

	private List&lt;ObjectTreeNode&gt; createCatalogNodes(ISession session, SQLDatabaseMetaData md)
		throws SQLException
	{
<span class="nc" id="L191">		final List&lt;ObjectTreeNode&gt; childNodes = new ArrayList&lt;ObjectTreeNode&gt;();</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">		if (session.getProperties().getLoadSchemasCatalogs())</span>
		{
<span class="nc" id="L194">			final String[] catalogs = md.getCatalogs();</span>

<span class="nc" id="L196">         CatalogFilterMatcher filterMatcher = new CatalogFilterMatcher(session.getProperties());</span>

<span class="nc bnc" id="L198" title="All 2 branches missed.">			for (int i = 0; i &lt; catalogs.length; ++i)</span>
			{
<span class="nc" id="L200">            IDatabaseObjectInfo dbo = new DatabaseObjectInfo(null, null,</span>
                                 catalogs[i],
                                 DatabaseObjectType.CATALOG,
                                 md);
<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (filterMatcher.matches(dbo.getSimpleName()))</span>
            {
<span class="nc" id="L206">					childNodes.add(new ObjectTreeNode(session, dbo));</span>
				}
			}
		}
<span class="nc" id="L210">		return childNodes;</span>
	}

	protected List&lt;ObjectTreeNode&gt; createSchemaNodes(ISession session, 
                                     SQLDatabaseMetaData md,
								     String catalogName)
		throws SQLException
	{
<span class="nc" id="L218">		final List&lt;ObjectTreeNode&gt; childNodes = new ArrayList&lt;ObjectTreeNode&gt;();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">		if (session.getProperties().getLoadSchemasCatalogs())</span>
		{
<span class="nc" id="L221">         session.getSchemaInfo().waitTillSchemasAndCatalogsLoaded();</span>
<span class="nc" id="L222">         final String[] schemas = session.getSchemaInfo().getSchemas();</span>

<span class="nc" id="L224">         SchemaFilterMatcher filterMatcher = new SchemaFilterMatcher(session.getProperties());</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">			for (int i = 0; i &lt; schemas.length; ++i)</span>
			{
<span class="nc" id="L228">            IDatabaseObjectInfo dbo = new DatabaseObjectInfo(catalogName, null,</span>
                                    schemas[i],
                                    DatabaseObjectType.SCHEMA, md);
<span class="nc bnc" id="L231" title="All 2 branches missed.">            if(filterMatcher.matches(dbo.getSimpleName()))</span>
            {
<span class="nc" id="L233">               childNodes.add(new ObjectTreeNode(session, dbo));</span>
				}
			}
		}
<span class="nc" id="L237">		return childNodes;</span>
	}

	private List&lt;ObjectTreeNode&gt; createObjectTypeNodes(ISession session, String catalogName,
											String schemaName)
	{
<span class="nc" id="L243">		final List&lt;ObjectTreeNode&gt; list = new ArrayList&lt;ObjectTreeNode&gt;();</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (session.getProperties().getLoadSchemasCatalogs())</span>
		{
<span class="nc" id="L247">			final ISQLConnection conn = session.getSQLConnection();</span>
<span class="nc" id="L248">			final SQLDatabaseMetaData md = conn.getSQLMetaData();</span>

			// Add table types to list.
<span class="nc bnc" id="L251" title="All 2 branches missed.">			if (_tableTypes.length &gt; 0)</span>
			{
<span class="nc bnc" id="L253" title="All 2 branches missed.">				for (int i = 0; i &lt; _tableTypes.length; ++i)</span>
				{
<span class="nc" id="L255">					IDatabaseObjectInfo dbo = new DatabaseObjectInfo(catalogName,</span>
													schemaName, _tableTypes[i],
													DatabaseObjectType.TABLE_TYPE_DBO, md);
<span class="nc" id="L258">					ObjectTreeNode child = new ObjectTreeNode(session, dbo);</span>
<span class="nc" id="L259">					list.add(child);</span>
				}
			}
			else
			{
<span class="nc" id="L264">				s_log.debug(&quot;List of table types is empty so trying null table type to load all tables&quot;);</span>
<span class="nc" id="L265">				IDatabaseObjectInfo dbo = new DatabaseObjectInfo(catalogName,</span>
												schemaName, null,
												DatabaseObjectType.TABLE_TYPE_DBO, md);
<span class="nc" id="L268">				ObjectTreeNode child = new ObjectTreeNode(session, dbo);</span>
<span class="nc" id="L269">				child.setUserObject(&quot;TABLE&quot;);</span>
<span class="nc" id="L270">				list.add(child);</span>
			}

			// Add stored proc parent node.
<span class="nc" id="L274">			boolean supportsStoredProcs = false;</span>
			try
			{
<span class="nc" id="L277">				supportsStoredProcs = md.supportsStoredProcedures();</span>
			}
<span class="nc" id="L279">			catch (SQLException ex)</span>
			{
<span class="nc" id="L281">				s_log.debug(&quot;DBMS doesn't support 'supportsStoredProcedures()'&quot;, ex);</span>
<span class="nc" id="L282">			}</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">			if (supportsStoredProcs)</span>
			{
<span class="nc" id="L285">				IDatabaseObjectInfo dbo = new DatabaseObjectInfo(catalogName,</span>
													schemaName, &quot;PROCEDURE&quot;,
													DatabaseObjectType.PROC_TYPE_DBO, md);
<span class="nc" id="L288">				ObjectTreeNode child = new ObjectTreeNode(session, dbo);</span>
<span class="nc" id="L289">				list.add(child);</span>
			}

			// Add UDT parent node.
			{
<span class="nc" id="L294">				IDatabaseObjectInfo dbo = new DatabaseObjectInfo(catalogName,</span>
											schemaName, &quot;UDT&quot;,
											DatabaseObjectType.UDT_TYPE_DBO, md);
<span class="nc" id="L297">				ObjectTreeNode child = new ObjectTreeNode(session, dbo);</span>
<span class="nc" id="L298">				list.add(child);</span>
			}
		}

<span class="nc" id="L302">		return list;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>