<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Entity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">95_celwars2009</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">Entity.java</span></div><h1>Entity.java</h1><pre class="source lang-java linenums">import java.awt.Color;
import java.awt.Point;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Random;

public class Entity 
{
	private double x, y, vx,vy,fx,fy, vs;
	private double size;
<span class="nc" id="L13">	private int team = -1;</span>
	private HashMap&lt;String, Double&gt; properties;
	//private ArrayList&lt;FOGSystem&gt; systems;
<span class="nc" id="L16">	private Random gen = new Random();</span>
<span class="nc" id="L17">	private ArrayList&lt;Entity&gt; nearby = new ArrayList&lt;Entity&gt;();</span>
<span class="nc" id="L18">	private int livingNearby = 0;</span>
	
	public Entity(double x, double y, int team )
<span class="nc" id="L21">	{</span>
<span class="nc" id="L22">		this.properties = new HashMap&lt;String, Double&gt;();</span>
<span class="nc" id="L23">		this.properties.put(&quot;age&quot;,1.0); </span>
<span class="nc bnc" id="L24" title="All 2 branches missed.">		if(team &gt;=0)</span>
<span class="nc" id="L25">			this.properties.put(&quot;id&quot;, new Double(gen.nextInt(99999999)));</span>
		else
<span class="nc" id="L27">			this.properties.put(&quot;id&quot;, new Double(-gen.nextInt(99999999)));</span>
<span class="nc" id="L28">		this.x = x;</span>
<span class="nc" id="L29">		this.y = y;</span>
<span class="nc" id="L30">		vx = 0;</span>
<span class="nc" id="L31">		vy = 0;</span>
<span class="nc" id="L32">		vs = 0;</span>
<span class="nc" id="L33">		this.size = 15;</span>
<span class="nc" id="L34">		this.team = team;</span>
//		this.properties.put(&quot;team&quot;,team); // -1 == food -2 == obstacle

<span class="nc" id="L37">	}</span>
	public Entity(double x, double y, int team, Entity parent )
<span class="nc" id="L39">	{</span>
<span class="nc" id="L40">		this.properties = new HashMap&lt;String, Double&gt;();</span>
<span class="nc" id="L41">		this.properties.putAll(parent.properties);</span>
<span class="nc" id="L42">		this.properties.put(&quot;age&quot;,1.0); </span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">		if(team &gt;=0)</span>
<span class="nc" id="L44">			this.properties.put(&quot;id&quot;, new Double(gen.nextInt(99999999)));</span>
		else
<span class="nc" id="L46">			this.properties.put(&quot;id&quot;, new Double(-gen.nextInt(99999999)));</span>
<span class="nc" id="L47">		this.x = x;</span>
<span class="nc" id="L48">		this.y = y;</span>
<span class="nc" id="L49">		vx = 0;</span>
<span class="nc" id="L50">		vy = 0;</span>
<span class="nc" id="L51">		vs = 0;</span>
<span class="nc" id="L52">		this.size = 15;</span>
<span class="nc" id="L53">		this.team = team;</span>
//		this.properties.put(&quot;team&quot;,team); // -1 == food -2 == obstacle

<span class="nc" id="L56">	}</span>


	public double getSize() {
<span class="nc" id="L60">		return size;</span>
	}

	public void setSize(double size) {
<span class="nc" id="L64">		this.size = size;</span>
<span class="nc" id="L65">	}</span>

	public int getTeam() {
<span class="nc" id="L68">		return team;</span>
	}


	public double getVx() {
<span class="nc" id="L73">		return vx;</span>
	}

	public void setVx(double vx) {
<span class="nc" id="L77">		this.vx = vx;</span>
<span class="nc" id="L78">	}</span>

	public double getVy() {
<span class="nc" id="L81">		return vy;</span>
	}

	public void setVy(double vy) {
<span class="nc" id="L85">		this.vy = vy;</span>
<span class="nc" id="L86">	}</span>

	public double getX() {
<span class="nc" id="L89">		return x;</span>
	}

	public void setX(double x) {
<span class="nc" id="L93">		this.x = x;</span>
<span class="nc" id="L94">	}</span>

	public double getY() {
<span class="nc" id="L97">		return y;</span>
	}

	public void setY(double y) {
<span class="nc" id="L101">		this.y = y;</span>
<span class="nc" id="L102">	}</span>

	public Random getGen() {
<span class="nc" id="L105">		return gen;</span>
	}

	public HashMap&lt;String, Double&gt; getProperties() {
<span class="nc" id="L109">		return properties;</span>
	}

	double dist(double x1, double y1, double x2, double y2)
	{
<span class="nc" id="L114">		return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));</span>
	}
	/*
	 * 		r(t + ?t) = r(t) + v(t) ?t+ (1/2)a(t) ?t2			Position update
	 		v(t +?t/2) = v(t) + (1/2)a(t)?t						Half Velocity update
	 		a(t + ?t) = -(1/m)    V(r(t + ?t))					Force update
	 		v(t + ?t) = v(t + ?t/2) + (1/2)a(t + ?t) ?t		Full velocity update

	 * 
	 */
	public void integrate(Server s) 
	{
<span class="nc bnc" id="L126" title="All 10 branches missed.">		if(team &gt; -1 &amp;&amp; s.getPlayers().size() &gt; team &amp;&amp; s.getPlayers().get(team) != null &amp;&amp; s.getPlayers().get(team).clientSocket != null &amp;&amp; !s.getPlayers().get(team).clientSocket.isConnected())</span>
		{
<span class="nc" id="L128">			s.getPlayers().get(team).getP().setNumCells(s.getPlayers().get(team).getP().getNumCells()-1);</span>
<span class="nc" id="L129">			System.err.println(&quot;removed a left-over entity&quot;);</span>
<span class="nc" id="L130">			s.getEntities().remove(this);</span>
<span class="nc" id="L131">			return;</span>
		}
		
<span class="nc bnc" id="L134" title="All 4 branches missed.">		if(gen.nextInt(10000) == 0 &amp;&amp; team &gt; -1)</span>
		{
			//random evolution
<span class="nc" id="L137">			String[] list = {&quot;Simple Flagella&quot;,&quot;Senescence Seggregation&quot;,&quot;Toxic Apoptosis&quot;,&quot;Antibiotic Receptors&quot;,&quot;Group Growth&quot;,&quot;Aggression&quot;,&quot;Cellular Walls&quot;,&quot;Lysozymes&quot;,&quot;Antibiotic Resistance&quot;,&quot;Telomerase&quot;,&quot;Group Attraction&quot;,&quot;Complex Flagella&quot;,&quot;Photosynthesis&quot;};</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">			if(gen.nextBoolean())</span>
			{
<span class="nc" id="L140">				String adding = list[gen.nextInt(list.length)];</span>
<span class="nc" id="L141">				properties.put(adding,1.0);</span>
<span class="nc" id="L142">				s.sendMessage(&quot;Message 255 One of your cells has aquired &quot;+adding+&quot; by random mutation!&quot;,team);</span>
<span class="nc" id="L143">			}</span>
			else
			{
<span class="nc" id="L146">				String adding = list[gen.nextInt(list.length)];</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">				if(properties.get(adding) != null)</span>
				{
<span class="nc" id="L149">					properties.remove(adding);</span>
<span class="nc" id="L150">					s.sendMessage(&quot;Message 16581375 One of your cells has lost &quot;+adding+&quot; by random mutation!&quot;,team);</span>
				}

			}
		}
		//position update
<span class="nc" id="L156">		double oldx = x;</span>
<span class="nc" id="L157">		double oldy = y;</span>
<span class="nc" id="L158">		double olds = size;</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">		if(team &gt; -1 || team == -5)</span>
		{
<span class="nc bnc" id="L161" title="All 4 branches missed.">			if(x+vx+((1.0/2.0)*fx)/size &lt; 0 || x+vx+((1.0/2.0)*fx)/size &gt; s.getWorldSize())</span>
			{
				
<span class="nc" id="L164">				vx += (s.getWorldSize()/2-x)/s.getWorldSize();</span>
			}
<span class="nc bnc" id="L166" title="All 4 branches missed.">			if(y+vy+((1.0/2.0)*fy)/size &lt; 0 || y+vy+((1.0/2.0)*fy)/size &gt; s.getWorldSize())</span>
			{
				
<span class="nc" id="L169">				vy += (s.getWorldSize()/2-y)/s.getWorldSize();</span>
			}
		}

<span class="nc" id="L173">		x+= vx+((1.0/2.0)*fx)/(size*size);</span>
<span class="nc" id="L174">		y+= vy+((1.0/2.0)*fy)/(size*size);		</span>
<span class="nc" id="L175">		size += vs; </span>
		//half velocity update
<span class="nc" id="L177">		vx +=((1.0/2.0)*fx)/(size*size) ;</span>
<span class="nc" id="L178">		vy += ((1.0/2.0)*fy)/(size*size);</span>

<span class="nc bnc" id="L180" title="All 2 branches missed.">		if(getTeam() &gt; -1)</span>
		{
			//x += gen.nextDouble()*0.8 - gen.nextDouble()*0.8 ;
			//y += gen.nextDouble()*0.8 - gen.nextDouble()*0.8 ;
<span class="nc bnc" id="L184" title="All 6 branches missed.">			if(properties.get(&quot;Simple Flagella&quot;) != null|| properties.get(&quot;Complex Flagella&quot;) != null &amp;&amp; gen.nextInt(100) &lt; 4)</span>
			{
<span class="nc" id="L186">				vx += gen.nextDouble()*0.3 - gen.nextDouble()*0.3 ;</span>
<span class="nc" id="L187">				vy += gen.nextDouble()*0.3 - gen.nextDouble()*0.3 ;</span>
			}
			
<span class="nc bnc" id="L190" title="All 2 branches missed.">			if(properties.get(&quot;Group Growth&quot;) != null)</span>
<span class="nc" id="L191">				size += livingNearby*0.0003;</span>
<span class="nc" id="L192">				size += livingNearby*0.0001;</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">			if(properties.get(&quot;Photosynthesis&quot;) != null)</span>
<span class="nc" id="L194">				vs+= 0.004;</span>
<span class="nc" id="L195">			vs += -(1.0/3.0)*(vs-(-0.0003-s.getPlayers().get(team).getP().getScore()*s.getPlayers().get(team).getP().getScore()*0.0000001));</span>
		}

<span class="nc bnc" id="L198" title="All 2 branches missed.">		if(getTeam() ==  -1)</span>
		{
<span class="nc" id="L200">			vs += (-1.0/4.0)*(vs-0.005);</span>
		}
<span class="nc bnc" id="L202" title="All 2 branches missed.">		if(getTeam() ==  -3) //poison</span>
		{
<span class="nc" id="L204">			vs += -(1.0/2.0)*(vs+0.01);</span>
		}
<span class="nc bnc" id="L206" title="All 2 branches missed.">		if(getTeam() ==  -4) //pheremone</span>
		{
<span class="nc" id="L208">			vs += -(1.0/2.0)*(vs+0.03);</span>
		}
		
		
		//force update
<span class="nc bnc" id="L213" title="All 2 branches missed.">		if(team != -3)</span>
		{
<span class="nc" id="L215">			fx = 0;</span>
<span class="nc" id="L216">			fy = 0;</span>
		}
		else
		{
<span class="nc" id="L220">			fx = fx*0.9;</span>
<span class="nc" id="L221">			fy = fy*0.9;			</span>
		}

		{
<span class="nc bnc" id="L225" title="All 2 branches missed.">			if(s.getTime() % 10 == 0)</span>
			{
<span class="nc" id="L227">				nearby.clear();</span>
<span class="nc" id="L228">				livingNearby =0;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">				for(int i = 0; i &lt; s.getEntities().size(); i++)</span>
				{
<span class="nc" id="L231">					Entity e = s.getEntities().get(i);</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">					if(e.team &gt; -1)</span>
					{
<span class="nc bnc" id="L234" title="All 8 branches missed.">						if(nearby.size() &lt; 20 &amp;&amp;e.x != x &amp;&amp; e.y != y &amp;&amp; dist(x,y, e.x, e.y) &lt; 200);</span>
						{
<span class="nc" id="L236">							nearby.add(e);</span>
<span class="nc" id="L237">							livingNearby++;</span>
						}
					}
					else
					{
<span class="nc bnc" id="L242" title="All 6 branches missed.">						if(nearby.size() &lt; 20 &amp;&amp; !e.equals(this) &amp;&amp; dist(x,y, e.x, e.y) &lt; 50);</span>
						{
<span class="nc" id="L244">							nearby.add(e);</span>
						}
		
					}
				}
			}
<span class="nc bnc" id="L250" title="All 2 branches missed.">			for(int i = 0; i &lt; nearby.size(); i++)</span>
			{
<span class="nc" id="L252">				double dx = nearby.get(i).getX()-x;</span>
<span class="nc" id="L253">				double dy = nearby.get(i).getY()-y;</span>
<span class="nc" id="L254">				double mag = Math.sqrt(dx*dx+dy*dy);</span>
<span class="nc" id="L255">				double distance2 = (dx*dx)+(dy*dy);</span>
<span class="nc" id="L256">				double distance1 = Math.sqrt(distance2);</span>
	//			double kenergy = (vx*vx+vy*vy)*size;
<span class="nc bnc" id="L258" title="All 2 branches missed.">				if(distance1 &gt; (nearby.get(i).getSize()/4+getSize()/4))</span>
				{
<span class="nc" id="L260">					double two = ((nearby.get(i).getSize()/2+size/2)*(nearby.get(i).getSize()/2+size/2))/distance2;</span>
	
					//attracted to food
					//attracted to others of same team
					//repelled by obstacles
					//repelled by poison
					//attracted to pheremones
<span class="nc bnc" id="L267" title="All 10 branches missed.">					if(nearby.get(i).getTeam() == -4 &amp;&amp; (getTeam() &gt; -1)&amp;&amp; (properties.get(&quot;Simple Flagella&quot;) != null || properties.get(&quot;Complex Flagella&quot;) != null)&amp;&amp; distance1 &lt; 100)</span>
					{
						//pheremone
<span class="nc" id="L270">						double ex = ((nearby.get(i).size)*1.6)/(distance1/(size/2+nearby.get(i).size/2));</span>
<span class="nc" id="L271">						fx += ex*dx;</span>
<span class="nc" id="L272">						fy += ex*dy;</span>
					}
					
<span class="nc bnc" id="L275" title="All 4 branches missed.">					if(nearby.get(i).getTeam() == -1 &amp;&amp; getTeam() &gt; -1)</span>
					{
						//food
						//double six= (two*two*two);
<span class="nc bnc" id="L279" title="All 8 branches missed.">						if(properties.get(&quot;Food Receptors&quot;) != null&amp;&amp; (properties.get(&quot;Simple Flagella&quot;) != null || properties.get(&quot;Complex Flagella&quot;) != null) &amp;&amp; distance1 &gt; 0.8*(size/2+nearby.get(i).getSize()/2))</span>
						{
<span class="nc" id="L281">							double ex =  (nearby.get(i).size*10)* ((2*two)/distance1);</span>
<span class="nc" id="L282">							fx += ex*dx;</span>
<span class="nc" id="L283">							fy += ex*dy;</span>
						}
<span class="nc bnc" id="L285" title="All 2 branches missed.">						if(dist(x,y,nearby.get(i).x, nearby.get(i).y)*0.9 &lt;= size/2 + nearby.get(i).size/2 )</span>
						{
<span class="nc" id="L287">							vx -= dx/10;</span>
<span class="nc" id="L288">							vy -= dy/10;</span>
<span class="nc" id="L289">							fx += dx/4;</span>
<span class="nc" id="L290">							fy += dy/4;</span>
							//System.err.println(&quot;Cell hit food: vx &quot;+vx+&quot; vy &quot;+vy+&quot; fx &quot;+fx+&quot; fy &quot;+fy);
						}
						
					}
<span class="nc bnc" id="L295" title="All 4 branches missed.">					if(nearby.get(i).getTeam() == -3 &amp;&amp; getTeam() &gt; -1)</span>
					{
						//poison
<span class="nc bnc" id="L298" title="All 8 branches missed.">						if(properties.get(&quot;Antibiotic Receptors&quot;) != null&amp;&amp; (properties.get(&quot;Simple Flagella&quot;) != null || properties.get(&quot;Complex Flagella&quot;) != null)&amp;&amp; distance1 &gt; 0.8*(size/2+nearby.get(i).getSize()/2))</span>
						{
<span class="nc" id="L300">							double ex =  -(nearby.get(i).size*10)* ((2*two)/distance1);</span>
<span class="nc" id="L301">							fx += ex*dx;</span>
<span class="nc" id="L302">							fy += ex*dy;</span>
						}
<span class="nc bnc" id="L304" title="All 2 branches missed.">						if(dist(x,y,nearby.get(i).x, nearby.get(i).y)*0.9 &lt;= (size/2 + nearby.get(i).size/2) )</span>
						{
<span class="nc" id="L306">							vx = -(dx)/9;</span>
<span class="nc" id="L307">							vy = -dy/9;</span>
						}
						
					}
<span class="nc bnc" id="L311" title="All 6 branches missed.">					if(team &gt; -1 &amp;&amp; nearby.get(i).getTeam() == getTeam() &amp;&amp; !nearby.get(i).equals(this) )</span>
					{
						//other team members
<span class="nc bnc" id="L314" title="All 8 branches missed.">						if(properties.get(&quot;Group Attraction&quot;) != null&amp;&amp; (properties.get(&quot;Simple Flagella&quot;) != null || properties.get(&quot;Complex Flagella&quot;) != null)&amp;&amp; distance1 &gt; 0.8*(size/2+nearby.get(i).getSize()/2))</span>
						{

<span class="nc" id="L317">							double ex = 0; </span>

<span class="nc bnc" id="L319" title="All 4 branches missed.">							if(properties.get(&quot;age&quot;) &gt; 104 &amp;&amp; properties.get(&quot;Senescence segregation&quot;) != null)</span>
							{
<span class="nc" id="L321">								ex = -(nearby.get(i).size*10)* ((2*two)/distance1);</span>
							}
							else
							{
<span class="nc" id="L325">								ex = (nearby.get(i).size*10)* ((2*two)/distance1);</span>
							}
<span class="nc" id="L327">							fx += ex*dx;</span>
<span class="nc" id="L328">							fy += ex*dy;</span>
						}
<span class="nc bnc" id="L330" title="All 2 branches missed.">						if(dist(x,y,nearby.get(i).x, nearby.get(i).y)*0.9 &lt;= (size/2 + nearby.get(i).size/2) )</span>
						{
<span class="nc" id="L332">							double eight= (two*two*two*two);</span>
<span class="nc" id="L333">							double ex = -(0.1)*(8*eight)/distance1;</span>
<span class="nc" id="L334">							vx += ex*dx;</span>
<span class="nc" id="L335">							vy += ex*dy;</span>
						}
						
<span class="nc bnc" id="L338" title="All 2 branches missed.">						if(gen.nextInt(1000) == 0)</span>
						{
<span class="nc" id="L340">							Iterator&lt;String&gt; itr = nearby.get(i).properties.keySet().iterator();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">							while(itr.hasNext())</span>
							{
<span class="nc" id="L343">								String next = itr.next();</span>
<span class="nc bnc" id="L344" title="All 4 branches missed.">								if(properties.get(next) == null &amp;&amp; gen.nextBoolean())</span>
								{
<span class="nc" id="L346">									properties.put(next, 1.0);</span>
<span class="nc" id="L347">									s.sendMessage(&quot;Message 255 One of your cells has aquired &quot;+next+&quot; from a nearby cell!&quot;,team);</span>
								}
<span class="nc" id="L349">							}</span>
						}
					}
<span class="nc bnc" id="L352" title="All 12 branches missed.">					if((team &gt; -1||   team == -5) &amp;&amp; nearby.get(i).getTeam() &gt; -1 &amp;&amp; nearby.get(i).getTeam() != getTeam() &amp;&amp; !(nearby.get(i).properties.get(&quot;id&quot;) == properties.get(&quot;id&quot;)) &amp;&amp; distance1 &lt; 100  )</span>
					{
						//rival blobs
<span class="nc bnc" id="L355" title="All 6 branches missed.">						if((properties.get(&quot;Release Antibiotic&quot;) != null &amp;&amp; gen.nextDouble()*size &gt; 20) || team == -5)</span>
						{
<span class="nc bnc" id="L357" title="All 2 branches missed.">							if(gen.nextInt(25)==0)</span>
							{
<span class="nc" id="L359">								Entity poison = new Entity(x+dx/mag*size/2,y+dy/mag*size/2, -3);</span>
<span class="nc" id="L360">								poison.setSize(gen.nextDouble()*3+8);</span>
<span class="nc" id="L361">								poison.fx = -(dx)*2;</span>
<span class="nc" id="L362">								poison.fy = -(dy)*2;</span>
<span class="nc" id="L363">								poison.vx = dx/mag*size/2;</span>
<span class="nc" id="L364">								poison.vy = dy/mag*size/2;</span>
<span class="nc" id="L365">								s.getEntities().add(poison);</span>
<span class="nc" id="L366">								doSend(poison,s);</span>
<span class="nc" id="L367">								nearby.add(poison);</span>
<span class="nc" id="L368">								s.addSound(&quot;plop3.wav &quot;+(int)x+&quot; &quot;+(int)y+&quot;;&quot;);</span>
							}
						}
<span class="nc bnc" id="L371" title="All 10 branches missed.">						if(nearby.get(i).team &gt; -1 &amp;&amp; ((properties.get(&quot;Aggression&quot;) != null&amp;&amp; (properties.get(&quot;Simple Flagella&quot;) != null || properties.get(&quot;Complex Flagella&quot;) != null)&amp;&amp; distance1 &gt; 0.8*(size/2+nearby.get(i).getSize()/2))))</span>
						{
<span class="nc" id="L373">							double ex =  0.013*(size-nearby.get(i).size)* (distance1/(size/2+nearby.get(i).size/2));</span>
<span class="nc" id="L374">							fx += ex*dx;</span>
<span class="nc" id="L375">							fy += ex*dy;</span>
						}
<span class="nc bnc" id="L377" title="All 6 branches missed.">						if(nearby.get(i).team &gt; -1 &amp;&amp; (team == -5 &amp;&amp; distance1 &gt; 0.8*(size/2+nearby.get(i).getSize()/2)))</span>
						{
<span class="nc" id="L379">							double ex =  0.005*(nearby.get(i).size)* (distance1/(size/2+nearby.get(i).size/2));</span>
<span class="nc" id="L380">							fx += ex*dx;</span>
<span class="nc" id="L381">							fy += ex*dy;</span>
						}
						
<span class="nc bnc" id="L384" title="All 2 branches missed.">						if(dist(x,y,nearby.get(i).x, nearby.get(i).y)*0.9 &lt;= (size/2 + nearby.get(i).size/2) )</span>
						{
<span class="nc" id="L386">							vx = -(dx)/9;</span>
<span class="nc" id="L387">							vy = -dy/9;</span>
						}
						//System.err.println(&quot;team interaction &quot;+ex+&quot; dx &quot;+dx+&quot; dy &quot;+dy);
					}
<span class="nc bnc" id="L391" title="All 4 branches missed.">					if(nearby.get(i).getTeam() == -2 &amp;&amp; getTeam() &gt; -1)</span>
					{
						//obstacle
<span class="nc bnc" id="L394" title="All 2 branches missed.">						if(dist(x,y,nearby.get(i).x, nearby.get(i).y)*0.95 &lt;= (size/2 + nearby.get(i).size/2) )</span>
						{
<span class="nc" id="L396">							vx = -(dx)/8;</span>
<span class="nc" id="L397">							vy = -dy/8;</span>
						}
<span class="nc bnc" id="L399" title="All 2 branches missed.">						if(properties.get(&quot;Enzymatic Revolution&quot;) != null)</span>
						{
<span class="nc" id="L401">							nearby.get(i).vs -= size*0.0004;</span>
<span class="nc" id="L402">							this.vs += nearby.get(i).size*0.0003;</span>
						}
						//System.err.println(&quot;obstabce interaction &quot;+ex+&quot; dx &quot;+dx+&quot; dy &quot;+dy);
					}
	
				}
			}
		}
		//full velocity update
<span class="nc" id="L411">		vx += ((1.0/2.0)*fx)/(size*size);</span>
<span class="nc" id="L412">		vy += + ((1.0/2.0)*fy)/(size*size);</span>
<span class="nc" id="L413">		double fmag = Math.sqrt(fx*fx+fy*fy);</span>
<span class="nc" id="L414">		double vmag = Math.sqrt(vx*vx+vy*vy);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">		if(fmag &gt; 2)</span>
		{
<span class="nc" id="L417">			fx = (fx/fmag)*2;</span>
<span class="nc" id="L418">			fy = (fy/fmag)*2;</span>
		}
<span class="nc bnc" id="L420" title="All 2 branches missed.">		if(vmag &gt; 5)</span>
		{
<span class="nc" id="L422">			vx = (vx/vmag)*5;</span>
<span class="nc" id="L423">			vy = (vy/vmag)*5;</span>
		}
		//also fix velocity based on temperature
<span class="nc bnc" id="L426" title="All 2 branches missed.">		if(vx*vy != 0)</span>
		{
<span class="nc" id="L428">			double Ct = Math.sqrt(1-(1.0/10.0)*(1-20.0/(size*size*vx*vx+size*size*vy*vy)));</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">			if(properties.get(&quot;Complex Flagella&quot;) != null)</span>
			{
<span class="nc" id="L431">				Ct = Math.sqrt(1-(1.0/20.0)*(1-110.0/(size*size*vx*vx+size*size*vy*vy)));</span>
			}
<span class="nc bnc" id="L433" title="All 2 branches missed.">			else if(properties.get(&quot;Simple Flagella&quot;) != null)</span>
			{
<span class="nc" id="L435">				Ct = Math.sqrt(1-(1.0/20.0)*(1-70.0/(size*size*vx*vx+size*size*vy*vy)));</span>
			}

<span class="nc" id="L438">			vx = vx*Ct;</span>
<span class="nc" id="L439">			vy = vy*Ct;</span>
		}
		//also go through nearby and update things based on current conditions.
<span class="nc bnc" id="L442" title="All 2 branches missed.">		if(team &gt; -1)</span>
		{
<span class="nc bnc" id="L444" title="All 2 branches missed.">			for(int i = 0; i &lt; nearby.size(); i++)</span>
			{
<span class="nc" id="L446">				Entity e = nearby.get(i);</span>
<span class="nc" id="L447">				double d = dist(x,y, e.x, e.y);</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">				if(d &lt; (size/1.5+ e.getSize()/1.5 + 4) )</span>
				{
<span class="nc bnc" id="L450" title="All 2 branches missed.">					if(e.getTeam() == -1)</span>
					{
						//food
<span class="nc bnc" id="L453" title="All 2 branches missed.">						if(properties.get(&quot;Enzymatic Revolution&quot;) != null)</span>
<span class="nc" id="L454">							vs += 0.0009*e.size;</span>
						else
<span class="nc" id="L456">							vs +=0.0003*e.size;</span>
<span class="nc" id="L457">						e.vs -= 0.0004*size;</span>
<span class="nc" id="L458">						e.integrate(s);</span>
					}
<span class="nc bnc" id="L460" title="All 2 branches missed.">					if(e.getTeam() == -3)</span>
					{
						//poison
<span class="nc bnc" id="L463" title="All 2 branches missed.">						if(properties.get(&quot;Antibiotic Resistance&quot;) != null)</span>
<span class="nc" id="L464">							vs -= 0.003*e.size;</span>
						else
<span class="nc" id="L466">							vs -= 0.01*e.size;</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">						if(properties.get(&quot;Enzymatic Revolution&quot;) != null)</span>
						{
<span class="nc" id="L469">							nearby.get(i).vs -= size*0.0004;</span>
<span class="nc" id="L470">							this.vs += nearby.get(i).size*0.003;</span>
						}
						
					}
<span class="nc bnc" id="L474" title="All 4 branches missed.">					if((e.getTeam() &gt; -1) &amp;&amp; e.getTeam() != getTeam())</span>
					{
						//next to an opponent cell
<span class="nc" id="L477">						double factor = 0.01;</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">						if(e.getProperties().get(&quot;Cell Wall&quot;) != null)</span>
<span class="nc" id="L479">							factor-= 0.03;</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">						if(this.getProperties().get(&quot;Lysozymes&quot;) != null)</span>
<span class="nc" id="L481">							factor+= 0.028;</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">						if(team == -5) factor+=0.05;</span>
<span class="nc" id="L483">						e.vs -= size*factor;</span>
<span class="nc bnc" id="L484" title="All 2 branches missed.">						if(properties.get(&quot;Enzymatic Revolution&quot;) != null)</span>
						{
<span class="nc" id="L486">							this.vs += nearby.get(i).size*0.0004;</span>
						}
					}
<span class="nc bnc" id="L489" title="All 4 branches missed.">					if(properties.get(&quot;Enzymatic Revolution&quot;) != null &amp;&amp; e.getTeam() == -5)</span>
					{
<span class="nc" id="L491">						e.vs -= size*0.0005; //die terminator bitch!</span>
					}
				}
			}
			
<span class="nc bnc" id="L496" title="All 4 branches missed.">			if(this.properties.get(&quot;Telomerase&quot;) == null|| team == -5)</span>
<span class="nc" id="L497">				properties.put(&quot;age&quot;, properties.get(&quot;age&quot;)+0.03);</span>
			else
<span class="nc" id="L499">				properties.put(&quot;age&quot;, properties.get(&quot;age&quot;)+0.012);</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">			if(gen.nextDouble()*getProperties().get(&quot;age&quot;) &gt; 100)</span>
			{
				//death
<span class="nc" id="L503">				vs -= 1;</span>

			}
			//System.err.println(&quot;Entity at &quot;+x+&quot; &quot;+y+&quot; size &quot;+size+&quot; vx &quot;+vx+&quot; vy &quot;+vy+&quot; vs &quot;+vs+&quot; fx &quot;+fx+&quot; fy &quot;+fy );

		}
<span class="nc bnc" id="L509" title="All 4 branches missed.">		if(team &gt; -1 &amp;&amp; gen.nextInt((int)size + 1) &gt; 25)</span>
		{
			//split!!!
<span class="nc" id="L512">			double x1 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + x;</span>
<span class="nc" id="L513">			double x2 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + x;</span>
<span class="nc" id="L514">			double y1 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + y;</span>
<span class="nc" id="L515">			double y2 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + y;</span>
<span class="nc" id="L516">			this.x = x1;</span>
<span class="nc" id="L517">			this.y = y1;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">			if(properties.get(&quot;Triplication&quot;)!= null)</span>
			{
<span class="nc" id="L520">				double x3 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + x;</span>
<span class="nc" id="L521">				double y3 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + y;</span>
<span class="nc" id="L522">				Entity daughter2 = new Entity(x3,y3, this.getTeam(),this);</span>
<span class="nc" id="L523">				daughter2.setSize(this.size/2);</span>
<span class="nc" id="L524">				s.getEntities().add(daughter2);</span>
<span class="nc" id="L525">				doSend(daughter2,s);</span>
<span class="nc" id="L526">				s.getPlayers().get(team).getP().setPower(s.getPlayers().get(team).getP().getPower()+5);</span>
<span class="nc" id="L527">				s.getPlayers().get(team).getP().setNumCells(s.getPlayers().get(team).getP().getNumCells()+1);</span>
			}
<span class="nc" id="L529">			Entity daughter = new Entity(x2,y2, this.getTeam(),this);</span>
<span class="nc" id="L530">			daughter.setSize(this.size/2);</span>
<span class="nc" id="L531">			s.getEntities().add(daughter);</span>
<span class="nc" id="L532">			doSend(daughter,s);</span>
<span class="nc" id="L533">			this.size = size/2;</span>
<span class="nc" id="L534">			s.getPlayers().get(team).getP().setPower(s.getPlayers().get(team).getP().getPower()+10);</span>
<span class="nc" id="L535">			s.addSound(&quot;split.wav &quot;+(int)x+&quot; &quot;+(int)y+&quot;;&quot;);</span>
<span class="nc" id="L536">			s.getPlayers().get(team).getP().setNumCells(s.getPlayers().get(team).getP().getNumCells()+1);</span>
		}
<span class="nc bnc" id="L538" title="All 4 branches missed.">		if(team == -1 &amp;&amp; gen.nextInt((int)size + 1) &gt; 50)</span>
		{
			//split!!!
<span class="nc" id="L541">			double x1 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + x;</span>
<span class="nc" id="L542">			double x2 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + x;</span>
<span class="nc" id="L543">			double y1 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + y;</span>
<span class="nc" id="L544">			double y2 = gen.nextDouble()*(size/2) -gen.nextDouble()*(size/2)   + y;</span>
<span class="nc" id="L545">			this.x = x1;</span>
<span class="nc" id="L546">			this.y = y1;</span>
<span class="nc" id="L547">			Entity daughter = new Entity(x2,y2, this.getTeam());</span>
<span class="nc" id="L548">			daughter.nearby.addAll(this.nearby);</span>
<span class="nc" id="L549">			daughter.setSize(this.size/2);</span>
<span class="nc" id="L550">			s.getEntities().add(daughter);</span>
<span class="nc" id="L551">			doSend(daughter,s);</span>
<span class="nc" id="L552">			this.size = size/2;</span>
		}
<span class="nc bnc" id="L554" title="All 2 branches missed.">		if(this.size &lt;= 8)</span>
		{
<span class="nc" id="L556">			doSend(this, s);</span>
<span class="nc" id="L557">			s.addSound(&quot;death.wav &quot;+(int)x+&quot; &quot;+(int)y+&quot;;&quot;);</span>
<span class="nc bnc" id="L558" title="All 4 branches missed.">			if(properties.get(&quot;Toxic Apoptosis&quot;) != null || gen.nextInt(100) &lt; 8)</span>
			{
<span class="nc" id="L560">				Entity poison = new Entity(x,y, -3);</span>
<span class="nc" id="L561">				poison.setSize(gen.nextDouble()*10+10);</span>
<span class="nc" id="L562">				s.getEntities().add(poison);</span>
<span class="nc" id="L563">				doSend(poison,s);</span>
			}
<span class="nc bnc" id="L565" title="All 2 branches missed.">			if(team &gt; -1)</span>
			{
<span class="nc" id="L567">				s.getPlayers().get(team).getP().setNumCells(s.getPlayers().get(team).getP().getNumCells()-1);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">				if(s.getPlayers().get(team).getP().getNumCells() == 0)</span>
				{
<span class="nc" id="L570">					s.sendMessage(&quot;Message2 255 All of your cells have died. You lost!&quot;,team);</span>
<span class="nc" id="L571">					s.sendMessage(&quot;MP3 lose.mp3&quot;,team);</span>
<span class="nc" id="L572">					s.sendMessage(&quot;Sound lose.wav &quot;+(int)x+&quot; &quot;+(int)y,team);</span>
<span class="nc" id="L573">					System.err.println(&quot;Player &quot;+team+&quot; died with score of &quot;+s.getPlayers().get(team).getP().getScore());</span>
					//s.getPlayers().remove(team);
<span class="nc" id="L575">					s.sendToAll(&quot;Message 2555 Player &quot;+team+&quot; has lost!&quot;);</span>
<span class="nc" id="L576">					s.getPlayers().get(team).disconnect();</span>
				}
			}
<span class="nc" id="L579">			s.getEntities().remove(this);</span>
<span class="nc" id="L580">			return;</span>
		}
<span class="nc bnc" id="L582" title="All 6 branches missed.">		if(Math.abs((int)oldx - (int)x) &gt; 0 || Math.abs((int)oldy - (int)y) &gt; 0 || Math.abs((int)olds - (int)size) &gt; 0 )</span>
		{
<span class="nc" id="L584">			doSend(this,s);</span>
		}
		else
<span class="nc" id="L587">			dontSend(this,s);</span>
<span class="nc" id="L588">	}</span>

	private void doSend(Entity e, Server s)
	{
<span class="nc bnc" id="L592" title="All 2 branches missed.">		if(!s.getSend().contains(e))</span>
<span class="nc" id="L593">			s.getSend().add(e);</span>
<span class="nc" id="L594">	}</span>
	private void dontSend(Entity e, Server s)
	{
<span class="nc bnc" id="L597" title="All 2 branches missed.">		if(s.getSend().contains(e))</span>
<span class="nc" id="L598">			s.getSend().remove(e);</span>
<span class="nc" id="L599">	}</span>


	public void setProperties(HashMap&lt;String, Double&gt; properties) {
<span class="nc" id="L603">		this.properties = properties;</span>
<span class="nc" id="L604">	}</span>

	
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>