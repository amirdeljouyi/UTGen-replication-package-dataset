<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Main.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">86_at-robots2-j</a> &gt; <a href="index.source.html" class="el_package">net.virtualinfinity.atrobots.gui</a> &gt; <span class="el_source">Main.java</span></div><h1>Main.java</h1><pre class="source lang-java linenums">package net.virtualinfinity.atrobots.gui;

import net.virtualinfinity.atrobots.compiler.AtRobotCompiler;
import net.virtualinfinity.atrobots.compiler.AtRobotCompilerOutput;
import net.virtualinfinity.atrobots.compiler.Errors;
import net.virtualinfinity.atrobots.compiler.RobotFactory;
import net.virtualinfinity.atrobots.game.Game;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.io.File;
import java.io.FilenameFilter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.concurrent.ExecutionException;

/**
 * This is the main GUI class.
 *
 * @author Daniel Pitts
 */
public class Main extends ArenaWindowBuilder implements Runnable {
    private volatile Game game;
<span class="nc" id="L28">    private boolean paused = true;</span>

    private final Object gameLock;
<span class="nc" id="L31">    private volatile int frameDelay = 25;</span>
<span class="nc" id="L32">    private volatile boolean useDelay = true;</span>
<span class="nc" id="L33">    private Thread gameThread = new GameThread();</span>

    private volatile boolean closed;
    private boolean debugMode;
    private java.util.List&lt;String&gt; initialRobots;
<span class="nc" id="L38">    private final AbstractAction runAction = new AbstractAction(&quot;Run&quot;) {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L40" title="All 2 branches missed.">            setPaused(!paused);</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">            this.putValue(Action.NAME, paused ? &quot;Run&quot; : &quot;Pause&quot;);</span>
<span class="nc" id="L42">        }</span>
    };

    public boolean isPaused() {
<span class="nc" id="L46">        synchronized (gameLock) {</span>
<span class="nc" id="L47">            return paused;</span>
        }
    }

    public void setPaused(boolean paused) {
<span class="nc" id="L52">        synchronized (gameLock) {</span>
<span class="nc" id="L53">            this.paused = paused;</span>
<span class="nc" id="L54">            gameLock.notifyAll();</span>
<span class="nc" id="L55">        }</span>
<span class="nc" id="L56">    }</span>

<span class="nc" id="L58">    private final AbstractAction speedToggleAction = new AbstractAction(&quot;Full Speed&quot;) {</span>
        public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L60" title="All 2 branches missed.">            useDelay = !useDelay;</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            this.putValue(Action.NAME, useDelay ? &quot;Full Speed&quot; : &quot;Slower&quot;);</span>
<span class="nc" id="L62">        }</span>
    };

<span class="nc" id="L65">    public Main() {</span>
<span class="nc" id="L66">        gameLock = new Object();</span>
<span class="nc" id="L67">    }</span>

    public void run() {
<span class="nc" id="L70">        initializeWindow();</span>

<span class="nc" id="L72">        startGame();</span>
<span class="nc" id="L73">    }</span>

    private void startGame() {
<span class="nc" id="L76">        setGame(new Game(1000));</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (!initialRobots.isEmpty()) {</span>
<span class="nc" id="L78">            new EntrantLoader(initialRobots).execute();</span>
        }

<span class="nc" id="L81">        gameThread.setDaemon(true);</span>
<span class="nc" id="L82">        gameThread.start();</span>
<span class="nc" id="L83">    }</span>

    @Override
    protected void buildMenuBar() {
<span class="nc" id="L87">        menubar.add(createFileMenu());</span>
<span class="nc" id="L88">        menubar.add(createViewMenu());</span>
<span class="nc" id="L89">        menubar.add(new JButton(runAction));</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (isDebugMode()) {</span>
<span class="nc" id="L91">            addDebugMenuItems();</span>
        }
<span class="nc" id="L93">    }</span>

    private JMenu createFileMenu() {
<span class="nc" id="L96">        final JMenu menu = new JMenu(&quot;Game&quot;);</span>
<span class="nc" id="L97">        menu.add(new AbstractAction(&quot;New Game&quot;) {</span>
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L99">                final NewGameDialog dialog = new NewGameDialog();</span>
<span class="nc" id="L100">                dialog.setModal(true);</span>
<span class="nc" id="L101">                dialog.pack();</span>
<span class="nc" id="L102">                dialog.setVisible(true);</span>
<span class="nc" id="L103">                final Game newGame = dialog.getGame();</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">                if (newGame != null) {</span>
//                    if (game != null) {
//                        game.dispose();
//                    }
<span class="nc" id="L108">                    setGame(newGame);</span>
                }
<span class="nc" id="L110">                game.nextRound();</span>
<span class="nc" id="L111">            }</span>
        });
<span class="nc" id="L113">        menu.add(new AbstractAction(&quot;Add Entrant&quot;) {</span>
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L115">                final JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L116">                chooser.setFileFilter(RobotFileUtils.getAtRobotsFileNameFilter());</span>
<span class="nc" id="L117">                chooser.setMultiSelectionEnabled(true);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">                if (chooser.showOpenDialog(mainFrame) == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L119">                    new EntrantLoader(chooser.getSelectedFiles()).execute();</span>
                }
<span class="nc" id="L121">            }</span>
        });
<span class="nc" id="L123">        return menu;</span>
    }

    private void setGame(Game newGame) {
<span class="nc" id="L127">        setPaused(true);</span>
<span class="nc" id="L128">        arenaPane.reset();</span>
<span class="nc" id="L129">        robotStatusPane.reset();</span>
<span class="nc" id="L130">        game = newGame;</span>
<span class="nc" id="L131">        game.addSimulationObserver(arenaPane);</span>
<span class="nc" id="L132">        game.addSimulationObserver(robotStatusPane);</span>
<span class="nc" id="L133">    }</span>

    private void addDebugMenuItems() {
<span class="nc" id="L136">        menubar.add(new JButton(new AbstractAction(&quot;Add all original&quot;) {</span>
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L138">                new EntrantLoader(new File(&quot;original&quot;).listFiles(new FilenameFilter() {</span>
                    public boolean accept(File dir, String name) {
<span class="nc" id="L140">                        return name.toLowerCase().endsWith(&quot;.at2&quot;);</span>
                    }
<span class="nc" id="L142">                })).execute();</span>

<span class="nc" id="L144">            }</span>
        }));
<span class="nc" id="L146">        menubar.add(new JButton(new AbstractAction(&quot;Add single&quot;) {</span>
            public void actionPerformed(ActionEvent e) {
<span class="nc bnc" id="L148" title="All 2 branches missed.">                for (final File parent : new File[]{new File(&quot;.&quot;), new File(&quot;original&quot;)})</span>
<span class="nc" id="L149">                    new EntrantLoader(parent.listFiles(new FilenameFilter() {</span>
                        public boolean accept(File dir, String name) {
<span class="nc bnc" id="L151" title="All 2 branches missed.">                            return name.toLowerCase().matches(&quot;zitgun.at2&quot;) ||</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                                    name.toLowerCase().endsWith(&quot;sniper2.at2&quot;);</span>
                        }
<span class="nc" id="L154">                    })).execute();</span>

<span class="nc" id="L156">            }</span>
        }));
<span class="nc" id="L158">        menubar.add(new JButton(speedToggleAction));</span>
<span class="nc" id="L159">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L162">        final Main main = new Main();</span>
<span class="nc" id="L163">        java.util.List&lt;String&gt; initialRobots = new ArrayList&lt;String&gt;(Arrays.asList(args));</span>
<span class="nc" id="L164">        main.setDebugMode(initialRobots.remove(&quot;--debug&quot;));</span>
<span class="nc" id="L165">        main.setInitialRobots(initialRobots);</span>
<span class="nc" id="L166">        EventQueue.invokeLater(main);</span>
<span class="nc" id="L167">    }</span>

    private void setInitialRobots(java.util.List&lt;String&gt; initialRobots) {
<span class="nc" id="L170">        this.initialRobots = initialRobots;</span>
<span class="nc" id="L171">    }</span>

    public boolean isDebugMode() {
<span class="nc" id="L174">        return debugMode;</span>
    }

    public void setDebugMode(boolean debugMode) {
<span class="nc" id="L178">        this.debugMode = debugMode;</span>
<span class="nc" id="L179">    }</span>

    protected void registerCloseListener() {
<span class="nc" id="L182">        mainFrame.addWindowListener(new WindowAdapter() {</span>
            public void windowClosed(WindowEvent e) {
<span class="nc" id="L184">                synchronized (gameLock) {</span>
<span class="nc" id="L185">                    closed = true;</span>
<span class="nc" id="L186">                    paused = false;</span>
<span class="nc" id="L187">                    gameLock.notifyAll();</span>
<span class="nc" id="L188">                }</span>

<span class="nc" id="L190">            }</span>
        });
<span class="nc" id="L192">    }</span>

    private class EntrantLoader extends SwingWorker&lt;Errors, RobotFactory&gt; {
        private final RobotFileUtils.EntrantFile[] selectedFiles;

        public EntrantLoader(File[] selectedFiles) {
<span class="nc" id="L198">            this(RobotFileUtils.getEntrantFiles(selectedFiles));</span>
<span class="nc" id="L199">        }</span>

<span class="nc" id="L201">        public EntrantLoader(RobotFileUtils.EntrantFile[] selectedFiles) {</span>
<span class="nc" id="L202">            this.selectedFiles = selectedFiles;</span>
<span class="nc" id="L203">        }</span>

        public EntrantLoader(java.util.List&lt;String&gt; initialRobots) {
<span class="nc" id="L206">            this(RobotFileUtils.getFilesByName(initialRobots));</span>
<span class="nc" id="L207">        }</span>


        protected Errors doInBackground() throws Exception {
<span class="nc" id="L211">            Errors errors = new Errors();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            for (RobotFileUtils.EntrantFile entrantFile : selectedFiles) {</span>
<span class="nc" id="L213">                final File file = entrantFile.file;</span>
<span class="nc" id="L214">                AtRobotCompiler compiler = new AtRobotCompiler();</span>
                try {
<span class="nc" id="L216">                    System.out.println(&quot;Loading &quot; + file);</span>
<span class="nc" id="L217">                    final AtRobotCompilerOutput result = compiler.compile(file);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    if (result.hasErrors()) {</span>
<span class="nc" id="L219">                        errors.info(&quot;Errors in &quot; + file.getName());</span>
<span class="nc" id="L220">                        errors.addAll(result.getErrors());</span>
                    }
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (game != null) {</span>
<span class="nc" id="L223">                        game.addEntrant(result.createRobotFactory(file.getName()).setDebug(entrantFile.debug));</span>
                    }
<span class="nc" id="L225">                } catch (IOException e1) {</span>
<span class="nc" id="L226">                    errors.info(&quot;Errors in &quot; + file.getName());</span>
<span class="nc" id="L227">                    errors.info(e1.getMessage());</span>
<span class="nc" id="L228">                } catch (Throwable t) {</span>
<span class="nc" id="L229">                    errors.info(&quot;Compiler error in &quot; + file.getName());</span>
<span class="nc" id="L230">                    errors.info(t.getMessage());</span>
<span class="nc" id="L231">                    t.printStackTrace();</span>
<span class="nc" id="L232">                }</span>
            }
<span class="nc" id="L234">            return errors;</span>
        }

        protected void done() {
            try {
<span class="nc" id="L239">                get().showErrorDialog(&quot;Errors&quot;, mainFrame);</span>
<span class="nc" id="L240">                game.nextRound();</span>
<span class="nc" id="L241">            } catch (InterruptedException e1) {</span>
<span class="nc" id="L242">                e1.printStackTrace();</span>
<span class="nc" id="L243">            } catch (ExecutionException e1) {</span>
<span class="nc" id="L244">                e1.printStackTrace();</span>
<span class="nc" id="L245">            }</span>
<span class="nc" id="L246">        }</span>
    }


<span class="nc" id="L250">    private class GameThread extends Thread {</span>
        public void run() {
<span class="nc bnc" id="L252" title="All 2 branches missed.">            while (!closed) {</span>
                try {
<span class="nc" id="L254">                    synchronized (gameLock) {</span>
<span class="nc bnc" id="L255" title="All 4 branches missed.">                        while (paused &amp;&amp; !closed) {</span>
<span class="nc" id="L256">                            gameLock.wait();</span>
                        }
<span class="nc" id="L258">                    }</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                    if (useDelay) {</span>
<span class="nc" id="L260">                        Thread.sleep(frameDelay);</span>
                    } else {
<span class="nc" id="L262">                        Thread.yield();</span>
                    }
<span class="nc" id="L264">                    synchronized (gameLock) {</span>
<span class="nc bnc" id="L265" title="All 4 branches missed.">                        if (!closed &amp;&amp; game != null) {</span>
<span class="nc" id="L266">                            game.stepRound();</span>
                        }
<span class="nc" id="L268">                    }</span>
<span class="nc" id="L269">                } catch (Throwable e) {</span>
<span class="nc" id="L270">                    e.printStackTrace();</span>
<span class="nc" id="L271">                }</span>
            }
<span class="nc" id="L273">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>