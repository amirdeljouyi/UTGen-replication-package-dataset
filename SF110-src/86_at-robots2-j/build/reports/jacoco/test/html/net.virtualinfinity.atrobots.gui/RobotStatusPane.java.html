<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RobotStatusPane.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">86_at-robots2-j</a> &gt; <a href="index.source.html" class="el_package">net.virtualinfinity.atrobots.gui</a> &gt; <span class="el_source">RobotStatusPane.java</span></div><h1>RobotStatusPane.java</h1><pre class="source lang-java linenums">package net.virtualinfinity.atrobots.gui;

import net.virtualinfinity.atrobots.arena.SimulationFrame;
import net.virtualinfinity.atrobots.arena.SimulationFrameBuffer;
import net.virtualinfinity.atrobots.arena.SimulationObserver;
import net.virtualinfinity.atrobots.snapshots.RobotSnapshot;
import net.virtualinfinity.atrobots.snapshots.SnapshotAdaptor;

import javax.swing.*;
import javax.swing.border.EtchedBorder;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import java.awt.*;
import java.util.*;
import java.util.List;

/**
 * TODO: Describe this class.
 *
 * @author Daniel Pitts
 */
public class RobotStatusPane extends JList implements SimulationObserver {
    private final DefaultListModel robotList;
<span class="nc" id="L24">    private final List&lt;RobotItem&gt; reorderedList = new ArrayList&lt;RobotItem&gt;();</span>
<span class="nc" id="L25">    private final Map&lt;Integer, RobotItem&gt; items = new HashMap&lt;Integer, RobotItem&gt;();</span>

<span class="nc" id="L27">    private RobotStatusPane() {</span>
<span class="nc" id="L28">        robotList = new DefaultListModel();</span>
<span class="nc" id="L29">        setModel(robotList);</span>
<span class="nc" id="L30">        this.setCellRenderer(new RobotStatusRenderer());</span>
<span class="nc" id="L31">        final RobotSnapshot robotSnapshot = new RobotSnapshot();</span>
<span class="nc" id="L32">        robotSnapshot.setName(&quot;SUPER DUPER LONG NAME!&quot;);</span>
<span class="nc" id="L33">        robotSnapshot.setLastMessage(&quot;VERY LONG ERROR MESSAGE FOR THIS ROBOT&quot;);</span>
<span class="nc" id="L34">        robotSnapshot.setTotalKills(10000000);</span>
<span class="nc" id="L35">        this.setPrototypeCellValue(new RobotItem(robotSnapshot));</span>
<span class="nc" id="L36">    }</span>

    public void frameAvailable(final SimulationFrameBuffer frameBuffer) {
<span class="nc" id="L39">        EventQueue.invokeLater(new UpdateRobotList(frameBuffer));</span>
<span class="nc" id="L40">    }</span>

    private void updateRobotStatus(RobotSnapshot robotSnapshot) {
<span class="nc" id="L43">        final RobotItem robotItem = items.get(robotSnapshot.getId());</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (robotItem == null) {</span>
<span class="nc" id="L45">            addItem(new RobotItem(robotSnapshot));</span>
        } else {
<span class="nc" id="L47">            robotItem.setRobotSnapshot(robotSnapshot);</span>

        }
<span class="nc" id="L50">        revalidate();</span>
<span class="nc" id="L51">    }</span>

    private void addItem(RobotItem robotItem) {
<span class="nc" id="L54">        items.put(robotItem.getId(), robotItem);</span>
<span class="nc" id="L55">        robotList.addElement(robotItem);</span>
<span class="nc" id="L56">    }</span>

    public static RobotStatusPane createRobotStatusPane() {
<span class="nc" id="L59">        return new RobotStatusPane();</span>
    }

    public Set&lt;Integer&gt; getSelectedRobotIds() {
<span class="nc" id="L63">        final Object[] objects = this.getSelectedValues();</span>
<span class="nc" id="L64">        final Set&lt;Integer&gt; selectedIds = new HashSet&lt;Integer&gt;();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">        for (Object o : objects) {</span>
<span class="nc" id="L66">            selectedIds.add(((RobotItem) o).getId());</span>

        }
<span class="nc" id="L69">        return selectedIds;</span>
    }

    public void reset() {
<span class="nc" id="L73">        robotList.removeAllElements();</span>
<span class="nc" id="L74">    }</span>

    private static class Bar extends JComponent {
        private BoundedRangeModel model;
<span class="nc" id="L78">        private final ChangeListener changeListener = new ChangeListener() {</span>
            public void stateChanged(ChangeEvent e) {
<span class="nc" id="L80">                repaint();</span>
<span class="nc" id="L81">            }</span>
        };
        private float[] foregroundGradientFractions;
        private Color[] foregroundGradientColors;

        @Override
        protected void paintComponent(Graphics g) {
<span class="nc" id="L88">            final Graphics2D g2d = (Graphics2D) g;</span>
<span class="nc" id="L89">            final Insets insets = getInsets(null);</span>
<span class="nc" id="L90">            final int maxWidth = getWidth() - insets.left - insets.right;</span>
<span class="nc" id="L91">            final int maxHeight = getHeight() - insets.top - insets.bottom;</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (foregroundGradientFractions != null) {</span>
<span class="nc" id="L93">                g2d.setPaint(new LinearGradientPaint(insets.left, 0, getWidth() - insets.right, 0, foregroundGradientFractions, foregroundGradientColors));</span>
            } else {
<span class="nc" id="L95">                g2d.setPaint(getForeground());</span>
            }
<span class="nc" id="L97">            g2d.fillRect(insets.left, insets.top, maxWidth * model.getValue() / model.getMaximum(), maxHeight);</span>
<span class="nc" id="L98">            g2d.drawRect(insets.left, insets.top, maxWidth - 1, maxHeight - 1);</span>
<span class="nc" id="L99">        }</span>

        public float[] getForegroundGradientFractions() {
<span class="nc" id="L102">            return foregroundGradientFractions;</span>
        }

        public void setForegroundGradientFractions(float[] foregroundGradientFractions) {
<span class="nc" id="L106">            this.foregroundGradientFractions = foregroundGradientFractions;</span>
<span class="nc" id="L107">        }</span>

        public Color[] getForegroundGradientColors() {
<span class="nc" id="L110">            return foregroundGradientColors;</span>
        }

        public void setForegroundGradientColors(Color[] foregroundGradientColors) {
<span class="nc" id="L114">            this.foregroundGradientColors = foregroundGradientColors;</span>
<span class="nc" id="L115">        }</span>

<span class="nc" id="L117">        private Bar() {</span>
<span class="nc" id="L118">            setModel(new DefaultBoundedRangeModel());</span>
<span class="nc" id="L119">        }</span>

        public void setModel(BoundedRangeModel model) {
<span class="nc bnc" id="L122" title="All 2 branches missed.">            if (this.model != null) {</span>
<span class="nc" id="L123">                model.removeChangeListener(changeListener);</span>
            }
<span class="nc" id="L125">            model.addChangeListener(changeListener);</span>
<span class="nc" id="L126">            this.model = model;</span>
<span class="nc" id="L127">        }</span>

        public int getMinimum() {
<span class="nc" id="L130">            return getModel().getMinimum();</span>
        }

        public void setMinimum(int newMinimum) {
<span class="nc" id="L134">            getModel().setMinimum(newMinimum);</span>
<span class="nc" id="L135">        }</span>

        public int getMaximum() {
<span class="nc" id="L138">            return getModel().getMaximum();</span>
        }

        public void setMaximum(int newMaximum) {
<span class="nc" id="L142">            getModel().setMaximum(newMaximum);</span>
<span class="nc" id="L143">        }</span>

        public int getValue() {
<span class="nc" id="L146">            return getModel().getValue();</span>
        }

        public void setValue(int newValue) {
<span class="nc" id="L150">            getModel().setValue(newValue);</span>
<span class="nc" id="L151">        }</span>

        public void setValueIsAdjusting(boolean b) {
<span class="nc" id="L154">            getModel().setValueIsAdjusting(b);</span>
<span class="nc" id="L155">        }</span>

        public boolean getValueIsAdjusting() {
<span class="nc" id="L158">            return getModel().getValueIsAdjusting();</span>
        }

        public int getExtent() {
<span class="nc" id="L162">            return getModel().getExtent();</span>
        }

        public void setExtent(int newExtent) {
<span class="nc" id="L166">            getModel().setExtent(newExtent);</span>
<span class="nc" id="L167">        }</span>

        public BoundedRangeModel getModel() {
<span class="nc" id="L170">            return model;</span>
        }
    }

<span class="nc" id="L174">    private static class RobotStatusRenderer extends JPanel implements ListCellRenderer {</span>
<span class="nc" id="L175">        private final JLabel name = new JLabel();</span>
<span class="nc" id="L176">        private final JLabel roundKills = new JLabel();</span>
<span class="nc" id="L177">        private final JLabel gameStats = new JLabel();</span>
<span class="nc" id="L178">        private final Bar armor = new Bar();</span>
<span class="nc" id="L179">        private final Bar heat = new Bar();</span>
<span class="nc" id="L180">        private final JLabel lastMessage = new JLabel();</span>

        public Component getListCellRendererComponent(JList list, Object value, int index, boolean isSelected, boolean cellHasFocus) {
<span class="nc bnc" id="L183" title="All 2 branches missed.">            final Color background = isSelected ? Color.blue : Color.black;</span>
<span class="nc" id="L184">            setBackground(background);</span>
<span class="nc" id="L185">            setBorder(BorderFactory.createEtchedBorder(EtchedBorder.RAISED, Color.lightGray, Color.darkGray));</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            final Color foreground = isSelected ? Color.yellow : Color.gray;</span>
<span class="nc" id="L187">            armor.setForegroundGradientFractions(new float[]{0, .25f, 1});</span>
<span class="nc" id="L188">            armor.setForegroundGradientColors(new Color[]{new Color(0, 0, .25f), Color.blue, Color.green});</span>
<span class="nc" id="L189">            heat.setForegroundGradientFractions(new float[]{0, .25f, 1});</span>
<span class="nc" id="L190">            heat.setForegroundGradientColors(new Color[]{new Color(.2f, 0, 0), Color.red, Color.yellow});</span>
<span class="nc" id="L191">            name.setForeground(foreground);</span>
<span class="nc" id="L192">            roundKills.setForeground(foreground);</span>
<span class="nc" id="L193">            gameStats.setForeground(foreground);</span>
<span class="nc" id="L194">            lastMessage.setForeground(foreground);</span>
<span class="nc" id="L195">            removeAll();</span>
<span class="nc" id="L196">            setLayout(new GridLayout(6, 1, 0, 1));</span>
<span class="nc" id="L197">            add(name);</span>
<span class="nc" id="L198">            add(roundKills);</span>
<span class="nc" id="L199">            add(armor);</span>
<span class="nc" id="L200">            add(heat);</span>
<span class="nc" id="L201">            add(gameStats);</span>
<span class="nc" id="L202">            add(lastMessage);</span>
<span class="nc" id="L203">            final RobotItem item = (RobotItem) value;</span>
<span class="nc" id="L204">            final RobotSnapshot robotSnapshot = item.getRobotSnapshot();</span>
<span class="nc" id="L205">            roundKills.setText(&quot;Kills (round/total): &quot; + robotSnapshot.getRoundKills() + &quot;/&quot; + robotSnapshot.getTotalKills());</span>
<span class="nc" id="L206">            gameStats.setText(&quot;Wins/Ties/Deaths: &quot; + robotSnapshot.getTotalWins() + &quot;/&quot; + robotSnapshot.getTotalTies() + &quot;/&quot; + robotSnapshot.getTotalDeaths());</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (!item.isDead()) {</span>
<span class="nc" id="L208">                armor.setValue((int) Math.round(Math.min(100, robotSnapshot.getArmor())));</span>
<span class="nc" id="L209">                heat.setValue((int) Math.round(Math.min(100, robotSnapshot.getTemperature().getLogScale() * .2)));</span>
<span class="nc" id="L210">                name.setText(robotSnapshot.getName());</span>
            } else {
<span class="nc" id="L212">                armor.setValue(0);</span>
<span class="nc" id="L213">                heat.setValue(0);</span>
<span class="nc" id="L214">                name.setText(&quot;&lt;html&gt;&lt;strike&gt;&quot; + robotSnapshot.getName() + &quot;&lt;/html&gt;&lt;/strike&gt;&quot;);</span>
            }
<span class="nc bnc" id="L216" title="All 2 branches missed.">            lastMessage.setText(robotSnapshot.getLastMessage() == null ? &quot;&quot; : robotSnapshot.getLastMessage());</span>
<span class="nc" id="L217">            return this;</span>
        }
    }

    private class UpdateRobotList implements Runnable {
        private final SimulationFrameBuffer frameBuffer;

<span class="nc" id="L224">        public UpdateRobotList(SimulationFrameBuffer frameBuffer) {</span>
<span class="nc" id="L225">            this.frameBuffer = frameBuffer;</span>
<span class="nc" id="L226">        }</span>

        public void run() {
<span class="nc" id="L229">            final SimulationFrame currentFrame = frameBuffer.getCurrentFrame();</span>
<span class="nc" id="L230">            currentFrame.visitRobots(new SnapshotAdaptor() {</span>
                @Override
                public void acceptRobot(RobotSnapshot robotSnapshot) {
<span class="nc" id="L233">                    updateRobotStatus(robotSnapshot);</span>
<span class="nc" id="L234">                }</span>
            });

<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (currentFrame.isRoundOver()) {</span>
<span class="nc" id="L238">                reorderedList.clear();</span>
<span class="nc" id="L239">                reorderedList.addAll(items.values());</span>
<span class="nc" id="L240">                Collections.sort(reorderedList);</span>
<span class="nc" id="L241">                robotList.setSize(reorderedList.size());</span>
            }
<span class="nc bnc" id="L243" title="All 2 branches missed.">            for (int i = 0; i &lt; reorderedList.size(); ++i) {</span>
<span class="nc" id="L244">                final RobotItem existingItem = (RobotItem) robotList.get(i);</span>
<span class="nc" id="L245">                final RobotItem reorderedItem = reorderedList.get(i);</span>
<span class="nc bnc" id="L246" title="All 4 branches missed.">                if (reorderedItem.isChanged() || existingItem != reorderedItem) {</span>
<span class="nc" id="L247">                    robotList.set(i, reorderedItem);</span>
                }
            }
<span class="nc" id="L250">        }</span>
    }

    private static class RobotItem implements Comparable&lt;RobotItem&gt; {
        private RobotSnapshot robotSnapshot;
        private boolean dead;
        private boolean updated;
        private boolean changed;

        private RobotItem() {
        }

<span class="nc" id="L262">        public RobotItem(RobotSnapshot robotSnapshot) {</span>
<span class="nc" id="L263">            setRobotSnapshot(robotSnapshot);</span>
<span class="nc" id="L264">        }</span>

        public RobotSnapshot getRobotSnapshot() {
<span class="nc" id="L267">            return robotSnapshot;</span>
        }

        public boolean isUpdated() {
<span class="nc" id="L271">            return updated;</span>
        }

        public void clearUpdated() {
<span class="nc" id="L275">            updated = false;</span>
<span class="nc" id="L276">            changed = false;</span>
<span class="nc" id="L277">        }</span>

        public void setRobotSnapshot(RobotSnapshot robotSnapshot) {
<span class="nc bnc" id="L280" title="All 4 branches missed.">            changed = this.robotSnapshot == null || !this.robotSnapshot.equals(robotSnapshot);</span>
<span class="nc" id="L281">            this.updated = true;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">            this.dead = robotSnapshot.getArmor() &lt;= 0;</span>
<span class="nc" id="L283">            this.robotSnapshot = robotSnapshot;</span>
<span class="nc" id="L284">        }</span>

        public boolean isChanged() {
<span class="nc" id="L287">            return changed;</span>
        }

        public boolean isDead() {
<span class="nc" id="L291">            return dead;</span>
        }

        public int getId() {
<span class="nc" id="L295">            return getRobotSnapshot().getId();</span>
        }

        public int compareTo(RobotItem o) {
<span class="nc bnc" id="L299" title="All 4 branches missed.">            if (robotSnapshot == null &amp;&amp; o.robotSnapshot == null) {</span>
<span class="nc" id="L300">                return 0;</span>
            }
<span class="nc bnc" id="L302" title="All 2 branches missed.">            if (robotSnapshot == null) {</span>
<span class="nc" id="L303">                return -1;</span>
            }
<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (o.robotSnapshot == null) {</span>
<span class="nc" id="L306">                return 1;</span>
            }
<span class="nc" id="L308">            return -compare(robotSnapshot.getTotalWins(), o.robotSnapshot.getTotalWins(), 2) +</span>
<span class="nc" id="L309">                    -compare(robotSnapshot.getTotalTies(), o.robotSnapshot.getTotalTies(), 1);</span>
        }

        private int compare(int left, int right, int priority) {
<span class="nc bnc" id="L313" title="All 4 branches missed.">            return left == right ? 0 : left &lt; right ? -priority : priority;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>