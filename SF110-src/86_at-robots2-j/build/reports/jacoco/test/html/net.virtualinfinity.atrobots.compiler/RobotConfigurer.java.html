<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RobotConfigurer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">86_at-robots2-j</a> &gt; <a href="index.source.html" class="el_package">net.virtualinfinity.atrobots.compiler</a> &gt; <span class="el_source">RobotConfigurer.java</span></div><h1>RobotConfigurer.java</h1><pre class="source lang-java linenums">package net.virtualinfinity.atrobots.compiler;

import net.virtualinfinity.atrobots.arena.Arena;
import net.virtualinfinity.atrobots.arena.RoundState;
import net.virtualinfinity.atrobots.computer.*;
import net.virtualinfinity.atrobots.comqueue.CommunicationsQueue;
import net.virtualinfinity.atrobots.hardware.armor.Armor;
import net.virtualinfinity.atrobots.hardware.mines.MineLayer;
import net.virtualinfinity.atrobots.hardware.missiles.MissileLauncher;
import net.virtualinfinity.atrobots.hardware.radio.Transceiver;
import net.virtualinfinity.atrobots.hardware.scanning.radar.Radar;
import net.virtualinfinity.atrobots.hardware.scanning.scanner.Scanner;
import net.virtualinfinity.atrobots.hardware.scanning.sonar.Sonar;
import net.virtualinfinity.atrobots.hardware.shield.Shield;
import net.virtualinfinity.atrobots.hardware.throttle.Throttle;
import net.virtualinfinity.atrobots.hardware.transponder.Transponder;
import net.virtualinfinity.atrobots.hardware.turret.Turret;
import net.virtualinfinity.atrobots.ports.PortHandler;
import net.virtualinfinity.atrobots.robot.Robot;

import java.util.Map;

/**
 * @author Daniel Pitts
 */
<span class="nc" id="L26">public class RobotConfigurer {</span>
    private Throttle throttle;
    private double coolMultiplier;
    private Armor armor;
    private MineLayer mineLayer;
    private Radar radar;
    private Shield shield;
    private Sonar sonar;
    private Transceiver transceiver;
    private Transponder transponder;
    private Turret turret;
    private MissileLauncher missileLauncher;
    private double missileLauncherPower;
    private Scanner scanner;
    private Robot robot;
    private HardwareBus hardwareBus;
    private MemoryArray lowerMemoryArray;
<span class="nc" id="L43">    private final SpecialRegister desiredPowerRegister = new SpecialRegister() {</span>
        public short get() {
<span class="nc" id="L45">            return (short) robot.getThrottle().getDesiredPower();</span>
        }
    };
<span class="nc" id="L48">    private final SpecialRegister desiredHeadingRegister = new SpecialRegister() {</span>
        public short get() {
<span class="nc" id="L50">            return (short) (robot.getDesiredHeading().getAngle().getBygrees() &amp; 255);</span>
        }
    };
<span class="nc" id="L53">    private final SpecialRegister turretShiftRegister = new SpecialRegister() {</span>
        public short get() {
<span class="nc" id="L55">            return (short) robot.getTurretShift();</span>
        }
    };
<span class="nc" id="L58">    private final SpecialRegister scannerAccuracyRegister = new SpecialRegister() {</span>
        public short get() {
<span class="nc" id="L60">            return (short) robot.getTurret().getScanner().getAccuracy();</span>
        }
    };
<span class="nc" id="L63">    private final SpecialRegister odometerRegister = new SpecialRegister() {</span>
        public short get() {
<span class="nc" id="L65">            return (short) Math.round(robot.getOdometer().getDistance());</span>
        }
    };

    public void setThrottle(Throttle throttle) {
<span class="nc" id="L70">        this.throttle = throttle;</span>
<span class="nc" id="L71">    }</span>

    public void setCoolMultiplier(double coolMultiplier) {
<span class="nc" id="L74">        this.coolMultiplier = coolMultiplier;</span>
<span class="nc" id="L75">    }</span>

    public void setArmor(Armor armor) {
<span class="nc" id="L78">        this.armor = armor;</span>
<span class="nc" id="L79">    }</span>

    public void setMineLayer(MineLayer mineLayer) {
<span class="nc" id="L82">        this.mineLayer = mineLayer;</span>
<span class="nc" id="L83">    }</span>

    public void setRadar(Radar radar) {
<span class="nc" id="L86">        this.radar = radar;</span>
<span class="nc" id="L87">    }</span>

    public void setShield(Shield shield) {
<span class="nc" id="L90">        this.shield = shield;</span>
<span class="nc" id="L91">    }</span>

    public void setSonar(Sonar sonar) {
<span class="nc" id="L94">        this.sonar = sonar;</span>
<span class="nc" id="L95">    }</span>

    public void setTransceiver(Transceiver transceiver) {
<span class="nc" id="L98">        this.transceiver = transceiver;</span>
<span class="nc" id="L99">    }</span>

    public void setTransponder(Transponder transponder) {
<span class="nc" id="L102">        this.transponder = transponder;</span>
<span class="nc" id="L103">    }</span>

    public void setTurret(Turret turret) {
<span class="nc" id="L106">        this.turret = turret;</span>
<span class="nc" id="L107">    }</span>

    public void setMissileLauncher(MissileLauncher missileLauncher) {
<span class="nc" id="L110">        this.missileLauncher = missileLauncher;</span>
<span class="nc" id="L111">    }</span>

    public void setMissileLauncherPower(double missileLauncherPower) {
<span class="nc" id="L114">        this.missileLauncherPower = missileLauncherPower;</span>
<span class="nc" id="L115">    }</span>

    public void setScanner(Scanner scanner) {
<span class="nc" id="L118">        this.scanner = scanner;</span>
<span class="nc" id="L119">    }</span>

    public void wireRobotComponents(Arena arena, RoundState roundState) {
<span class="nc" id="L122">        robot.getHeatSinks().setCoolMultiplier(coolMultiplier);</span>
<span class="nc" id="L123">        wireThrottle();</span>
<span class="nc" id="L124">        wireArmor();</span>
<span class="nc" id="L125">        wireMineLayer(arena);</span>
<span class="nc" id="L126">        wireRadar();</span>
<span class="nc" id="L127">        wireShield();</span>
<span class="nc" id="L128">        wireSonar();</span>
<span class="nc" id="L129">        wireRadar();</span>
<span class="nc" id="L130">        final AtRobotsCommunicationsQueue commQueue = createCommQueue();</span>
<span class="nc" id="L131">        wireTranceiver(commQueue);</span>
<span class="nc" id="L132">        wireComputer(commQueue);</span>
<span class="nc" id="L133">        wireTransponder();</span>
<span class="nc" id="L134">        wireTurret();</span>
<span class="nc" id="L135">        wireMissileLauncher(arena);</span>
<span class="nc" id="L136">        wireScanner();</span>
<span class="nc" id="L137">        wireHardwareBus(arena, roundState);</span>
<span class="nc" id="L138">        connectSpecialRegisters();</span>
<span class="nc" id="L139">    }</span>

    private void connectSpecialRegisters() {
<span class="nc" id="L142">        lowerMemoryArray.addSpecialRegister(9, odometerRegister);</span>
<span class="nc" id="L143">        lowerMemoryArray.addSpecialRegister(0, desiredPowerRegister);</span>
<span class="nc" id="L144">        lowerMemoryArray.addSpecialRegister(1, desiredHeadingRegister);</span>
<span class="nc" id="L145">        lowerMemoryArray.addSpecialRegister(2, turretShiftRegister);</span>
<span class="nc" id="L146">        lowerMemoryArray.addSpecialRegister(3, scannerAccuracyRegister);</span>
<span class="nc" id="L147">    }</span>

    private void wireHardwareBus(Arena arena, RoundState roundState) {
<span class="nc" id="L150">        robot.setHardwareBus(hardwareBus);</span>
<span class="nc" id="L151">        hardwareBus.setHeat(robot.getHeatSinks());</span>
<span class="nc" id="L152">        hardwareBus.setPorts(createPortHandlers());</span>
<span class="nc" id="L153">        hardwareBus.setInterrupts(createInterruptHandlers(arena, roundState));</span>
<span class="nc" id="L154">        hardwareBus.addResetable(robot.getTurret().getScanner());</span>
<span class="nc" id="L155">        hardwareBus.addResetable(robot.getTurret());</span>
<span class="nc" id="L156">        hardwareBus.addResetable(robot.getOdometer());</span>
<span class="nc" id="L157">        hardwareBus.addResetable(robot);</span>
<span class="nc" id="L158">        hardwareBus.addResetable(robot.getShield());</span>
<span class="nc" id="L159">        hardwareBus.setAutoShutdownListener(robot.getComputer());</span>
<span class="nc" id="L160">        robot.getComputer().setHardwareBus(hardwareBus);</span>
<span class="nc" id="L161">        hardwareBus.addShutdownListener(robot.getComputer());</span>
<span class="nc" id="L162">        hardwareBus.addShutdownListener(robot.getShield());</span>
<span class="nc" id="L163">        hardwareBus.addShutdownListener(robot.getThrottle());</span>
<span class="nc" id="L164">    }</span>

    private Map&lt;Integer, PortHandler&gt; createPortHandlers() {
<span class="nc" id="L167">        return getPortFactory().createPortHandlers(robot);</span>
    }

    private AtRobotPortFactory getPortFactory() {
<span class="nc" id="L171">        return new AtRobotPortFactory();</span>
    }

    private Map&lt;Integer, InterruptHandler&gt; createInterruptHandlers(Arena arena, RoundState roundState) {
<span class="nc" id="L175">        return getInterruptFactory().createInterruptTable(robot, arena, roundState);</span>
    }

    private AtRobotInterruptFactory getInterruptFactory() {
<span class="nc" id="L179">        return new AtRobotInterruptFactory();</span>
    }

    private void wireMissileLauncher(Arena arena) {
<span class="nc" id="L183">        missileLauncher.setHeading(turret.getHeading());</span>
<span class="nc" id="L184">        missileLauncher.setPower(missileLauncherPower);</span>
<span class="nc" id="L185">        missileLauncher.setHeatSinks(robot.getHeatSinks());</span>
<span class="nc" id="L186">        missileLauncher.setDamageInflicter(robot);</span>
<span class="nc" id="L187">        missileLauncher.setOverburner(robot);</span>
<span class="nc" id="L188">        missileLauncher.setArena(arena);</span>
<span class="nc" id="L189">        missileLauncher.setPosition(robot.getPosition());</span>
<span class="nc" id="L190">    }</span>

    private void wireScanner() {
<span class="nc" id="L193">        turret.setScanner(scanner);</span>
<span class="nc" id="L194">        scanner.setScanSource(robot);</span>
<span class="nc" id="L195">        scanner.setHeading(robot.getTurret().getHeading());</span>
<span class="nc" id="L196">    }</span>

    private void wireComputer(AtRobotsCommunicationsQueue commQueue) {
<span class="nc" id="L199">        robot.getComputer().setCommQueue(commQueue);</span>
<span class="nc" id="L200">        robot.getComputer().getMemory().setErrorHandler(robot.getComputer().getErrorHandler());</span>
<span class="nc" id="L201">    }</span>

    private void wireTurret() {
<span class="nc" id="L204">        robot.setTurret(turret);</span>
<span class="nc" id="L205">        turret.getHeading().setRelation(robot.getHeading());</span>
<span class="nc" id="L206">        turret.setKeepshift(false);</span>
<span class="nc" id="L207">        turret.getHeading().setAngle(robot.getHeading().getAngle());</span>
<span class="nc" id="L208">        turret.setMissileLauncher(missileLauncher);</span>
<span class="nc" id="L209">    }</span>

    private void wireTransponder() {
<span class="nc" id="L212">        robot.setTransponder(transponder);</span>
<span class="nc" id="L213">    }</span>

    private void wireTranceiver(CommunicationsQueue commQueue) {
<span class="nc" id="L216">        robot.setTransceiver(transceiver);</span>
<span class="nc" id="L217">        transceiver.setCommQueue(commQueue);</span>
<span class="nc" id="L218">    }</span>

    private void wireSonar() {
<span class="nc" id="L221">        robot.setSonar(sonar);</span>
<span class="nc" id="L222">        sonar.setScanSource(robot);</span>
<span class="nc" id="L223">    }</span>

    private void wireShield() {
<span class="nc" id="L226">        robot.setShield(shield);</span>
<span class="nc" id="L227">        robot.getShield().setHeatSinks(robot.getHeatSinks());</span>
<span class="nc" id="L228">    }</span>

    private void wireRadar() {
<span class="nc" id="L231">        radar.setScanSource(robot);</span>
<span class="nc" id="L232">        robot.setRadar(radar);</span>
<span class="nc" id="L233">    }</span>

    private void wireMineLayer(Arena arena) {
<span class="nc" id="L236">        robot.setMineLayer(mineLayer);</span>
<span class="nc" id="L237">        mineLayer.setOwner(robot);</span>
<span class="nc" id="L238">        mineLayer.setArena(arena);</span>
<span class="nc" id="L239">        mineLayer.setPosition(robot.getPosition());</span>
<span class="nc" id="L240">    }</span>

    private void wireArmor() {
<span class="nc" id="L243">        robot.setArmor(armor);</span>
<span class="nc" id="L244">    }</span>

    private void wireThrottle() {
<span class="nc" id="L247">        robot.setThrottle(throttle);</span>
<span class="nc" id="L248">        throttle.setOverburner(robot);</span>
<span class="nc" id="L249">    }</span>

    private AtRobotsCommunicationsQueue createCommQueue() {
<span class="nc" id="L252">        final AtRobotsCommunicationsQueue queue = new AtRobotsCommunicationsQueue(robot.getComputer().getCommQueueMemoryRegion(),</span>
<span class="nc" id="L253">                robot.getComputer().getRegisters().getCommunicationQueueHead(),</span>
<span class="nc" id="L254">                robot.getComputer().getRegisters().getCommunicationQueueTail());</span>
<span class="nc" id="L255">        queue.setComputerErrorHandler(robot.getComputer().getErrorHandler());</span>
<span class="nc" id="L256">        return queue;</span>
    }

    public void setRobot(Robot robot) {
<span class="nc" id="L260">        this.robot = robot;</span>
<span class="nc" id="L261">    }</span>

    public void setHardwareBus(HardwareBus hardwareBus) {
<span class="nc" id="L264">        this.hardwareBus = hardwareBus;</span>
<span class="nc" id="L265">    }</span>

    public void setLowerMemoryArray(MemoryArray lowerMemoryArray) {
<span class="nc" id="L268">        this.lowerMemoryArray = lowerMemoryArray;</span>
<span class="nc" id="L269">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>