<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DebugConsole.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">86_at-robots2-j</a> &gt; <a href="index.source.html" class="el_package">net.virtualinfinity.atrobots.debugger</a> &gt; <span class="el_source">DebugConsole.java</span></div><h1>DebugConsole.java</h1><pre class="source lang-java linenums">package net.virtualinfinity.atrobots.debugger;

import net.virtualinfinity.atrobots.atsetup.AtRobotInstruction;
import net.virtualinfinity.atrobots.atsetup.AtRobotInterrupt;
import net.virtualinfinity.atrobots.atsetup.AtRobotPort;
import net.virtualinfinity.atrobots.computer.Computer;
import net.virtualinfinity.atrobots.computer.Microcode;

import java.io.IOException;

/**
 * TODO: Describe this class.
 *
 * @author Daniel Pitts
 */
public class DebugConsole {
    private final Debugger debugger;
    private final Console console;

<span class="nc" id="L20">    private DebugConsole(Debugger debugger, Console console) {</span>
<span class="nc" id="L21">        this.console = console;</span>
<span class="nc" id="L22">        this.debugger = debugger;</span>
<span class="nc" id="L23">    }</span>

    public static DebugConsole create(Console console) {
<span class="nc" id="L26">        return create(console, new Debugger());</span>
    }

    public static DebugConsole create(Console console, Debugger debugger) {
<span class="nc" id="L30">        return new DebugConsole(debugger, console).start();</span>
    }

    private void inputLoop() throws IOException {
<span class="nc bnc" id="L34" title="All 2 branches missed.">        for (String line = readline(); line != null; line = readline()) {</span>
<span class="nc" id="L35">            handleLine(line);</span>
        }
<span class="nc" id="L37">    }</span>

    private void handleLine(String line) {
        try {
<span class="nc" id="L41">            handleInput(line);</span>
<span class="nc" id="L42">        } catch (Exception e) {</span>
<span class="nc" id="L43">            console.handleException(e);</span>
<span class="nc" id="L44">            e.printStackTrace();</span>
<span class="nc" id="L45">        }</span>
<span class="nc" id="L46">    }</span>

    private void handleInput(String line) throws InterruptedException {
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if (line.trim().length() == 0) {</span>
<span class="nc" id="L50">            debugger.step();</span>
<span class="nc" id="L51">            return;</span>
        }
<span class="nc" id="L53">        final String[] tokens = line.split(&quot;\\s++&quot;);</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (tokens[0].equalsIgnoreCase(&quot;pause&quot;)) {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">            if (tokens.length &gt; 1) {</span>
<span class="nc" id="L56">                debugger.pause(Integer.parseInt(tokens[1]));</span>
            } else {
<span class="nc" id="L58">                debugger.pause();</span>
            }
<span class="nc bnc" id="L60" title="All 2 branches missed.">        } else if (tokens[0].equalsIgnoreCase(&quot;go&quot;)) {</span>
<span class="nc" id="L61">            debugger.go();</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">        } else if (tokens[0].equalsIgnoreCase(&quot;step&quot;)) {</span>
<span class="nc" id="L63">            debugger.step();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        } else if (tokens[0].equalsIgnoreCase(&quot;break&quot;)) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (tokens.length &gt; 1) {</span>
<span class="nc" id="L66">                debugger.setBreakpoint(Integer.parseInt(tokens[1]));</span>
            } else {
<span class="nc" id="L68">                debugger.setBreakpoint();</span>
            }
<span class="nc bnc" id="L70" title="All 2 branches missed.">        } else if (tokens[0].equalsIgnoreCase(&quot;unbreak&quot;)) {</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (tokens.length &gt; 1) {</span>
<span class="nc" id="L72">                debugger.clearBreakpoint(Integer.parseInt(tokens[1]));</span>
            } else {
<span class="nc" id="L74">                debugger.clearBreakpoint();</span>
            }
<span class="nc bnc" id="L76" title="All 2 branches missed.">        } else if (tokens[0].equalsIgnoreCase(&quot;entrant&quot;)) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (tokens.length &gt; 1) {</span>
<span class="nc" id="L78">                debugger.setDefaultEntrant(Integer.parseInt(tokens[1]));</span>
            } else {
<span class="nc" id="L80">                debugger.resetDefaultEntrant();</span>
            }
<span class="nc bnc" id="L82" title="All 2 branches missed.">        } else if (tokens[0].equalsIgnoreCase(&quot;unbreak&quot;)) {</span>
        } else {
<span class="nc" id="L84">            println(null, &quot;Unknown command.&quot;);</span>
        }
<span class="nc" id="L86">    }</span>

    private void printState(Computer computer) {
<span class="nc" id="L89">        println(computer, computer.getRegisters());</span>
<span class="nc" id="L90">        println(computer, computer.getInstructionPointer() + &quot;: &quot; + instructionString(computer));</span>
<span class="nc" id="L91">    }</span>

    private String instructionString(Computer computer) {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (isInterruptInstruction(computer.getOperandValue(0))) {</span>
<span class="nc" id="L95">            return operatorString(computer) + &quot; &quot; + interruptString(computer);</span>
        }
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (isPortInstruction(computer.getOperandValue(0))) {</span>
<span class="nc" id="L98">            return operatorString(computer) + &quot; &quot; + portString(computer) + &quot;, &quot; + operandString(computer, 2);</span>
        }
<span class="nc" id="L100">        return operatorString(computer) + &quot; &quot; + operandString(computer, 1) + &quot;, &quot; + operandString(computer, 2);</span>
    }

    private String portString(Computer computer) {
<span class="nc" id="L104">        return AtRobotPort.nameOf(computer.getOperandValue(1)) + &quot;(&quot; + operandString(computer, 1) + &quot;)&quot;;</span>
    }

    private String interruptString(Computer computer) {
<span class="nc" id="L108">        return AtRobotInterrupt.nameOf(computer.getOperandValue(1)) + &quot;(&quot; + operandString(computer, 1) + &quot;)&quot;;</span>
    }

    private boolean isInterruptInstruction(short operandValue) {
<span class="nc bnc" id="L112" title="All 2 branches missed.">        return AtRobotInstruction.INT.value == operandValue;</span>
    }

    private boolean isPortInstruction(short operandValue) {
<span class="nc bnc" id="L116" title="All 4 branches missed.">        return AtRobotInstruction.IPO.value == operandValue || AtRobotInstruction.OPO.value == operandValue;</span>
    }

    private static String operandString(Computer computer, int operand) {
<span class="nc" id="L120">        Microcode microcode = computer.getMicrocode(operand);</span>
<span class="nc bnc" id="L121" title="All 7 branches missed.">        switch (microcode) {</span>
            case DoubleDereference:
<span class="nc" id="L123">                return &quot;[&quot; + variableString(computer, operand) + &quot;]=[&quot; + computer.getDeferencedValue(operand) + &quot;]=&quot; +</span>
<span class="nc" id="L124">                        computer.getDoubleDereferencedValue(operand);</span>
            case Dereference:
<span class="nc" id="L126">                return variableString(computer, operand) + &quot;=&quot; + computer.getDeferencedValue(operand);</span>
            case NumberedLabel:
<span class="nc" id="L128">                return &quot;:&quot; + computer.getConstant(operand);</span>
            case ResolvedLabel:
<span class="nc" id="L130">                return labelString(computer, operand);</span>
            case UnresolvedLabel:
<span class="nc" id="L132">                return &quot;!&lt;unknown&gt;&quot;;</span>
            case Constant:
<span class="nc" id="L134">                return String.valueOf(computer.getConstant(operand));</span>
            default:
            case Invalid:
<span class="nc" id="L137">                return &quot;&lt;invalid&gt;&quot;;</span>
        }
    }

    private static String labelString(Computer computer, int operand) {
<span class="nc" id="L142">        return &quot;!&quot; + computer.getConstant(operand);</span>
    }

    private static String variableString(Computer computer, int operand) {
<span class="nc" id="L146">        return computer.getDebugInfo().getVariableName(computer.getConstant(operand));</span>
    }

    private static String operatorString(Computer computer) {
<span class="nc" id="L150">        Microcode microcode = computer.getMicrocode(0);</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (!microcode.isValid()) {</span>
<span class="nc" id="L152">            return &quot;&lt;invalid&gt;&quot;;</span>
        }
<span class="nc" id="L154">        final short value = microcode.getValue(computer, 0);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (microcode == Microcode.NumberedLabel) {</span>
<span class="nc" id="L156">            return &quot;:&quot; + value;</span>
        }
<span class="nc" id="L158">        return AtRobotInstruction.nameOf(value);</span>
    }


    private DebugConsole start() {
<span class="nc" id="L163">        debugger.setBreakpointHandler(new MyBreakpointHandler());</span>
<span class="nc" id="L164">        final Thread thread = new Thread(&quot;Debugger&quot;) {</span>
            public void run() {
                try {
<span class="nc" id="L167">                    inputLoop();</span>
<span class="nc" id="L168">                } catch (IOException e) {</span>
<span class="nc" id="L169">                    e.printStackTrace();</span>
<span class="nc" id="L170">                }</span>
<span class="nc" id="L171">            }</span>
        };
<span class="nc" id="L173">        thread.setDaemon(true);</span>
<span class="nc" id="L174">        thread.start();</span>
<span class="nc" id="L175">        return this;</span>
    }

    public Debugger getDebugger() {
<span class="nc" id="L179">        return debugger;</span>
    }

<span class="nc" id="L182">    private class MyBreakpointHandler implements BreakpointHandler {</span>
        public void handleBreakpoint(Computer computer) {
<span class="nc" id="L184">            printState(computer);</span>
<span class="nc" id="L185">        }</span>
    }

    public void println(Computer computer, Object o) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (computer != null) {</span>
<span class="nc" id="L190">            console.println(&quot;#&quot; + computer.getId() + &quot;: &quot; + computer.getName() + &quot;} &quot; + o);</span>
        } else {
<span class="nc" id="L192">            console.println(&quot; } &quot; + o);</span>
        }
<span class="nc" id="L194">    }</span>

    public String readline() throws IOException {
<span class="nc" id="L197">        return console.readline();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>