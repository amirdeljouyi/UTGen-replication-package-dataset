<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Debugger.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">86_at-robots2-j</a> &gt; <a href="index.source.html" class="el_package">net.virtualinfinity.atrobots.debugger</a> &gt; <span class="el_source">Debugger.java</span></div><h1>Debugger.java</h1><pre class="source lang-java linenums">package net.virtualinfinity.atrobots.debugger;

import net.virtualinfinity.atrobots.computer.Computer;
import net.virtualinfinity.atrobots.computer.DebugListener;

import java.util.*;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.LinkedBlockingDeque;

/**
 * TODO: Describe this class.
 *
 * @author Daniel Pitts
 */
<span class="nc" id="L15">public class Debugger implements DebugListener {</span>
<span class="nc" id="L16">    private final BlockingQueue&lt;Command&gt; afterBreakpointCommandQueue = new LinkedBlockingDeque&lt;Command&gt;();</span>
<span class="nc" id="L17">    private final BlockingQueue&lt;Command&gt; commandQueue = new LinkedBlockingDeque&lt;Command&gt;();</span>
    private BreakpointHandler breakpointHandler;

    private volatile boolean allPaused;
    private boolean wasAllPaused;
    private volatile Integer defaultEntrant;
    private boolean inBreakpoint;

    protected void doPauseAll() {
<span class="nc" id="L26">        allPaused = true;</span>
<span class="nc" id="L27">    }</span>

<span class="nc" id="L29">    private final Map&lt;Integer, EntrantState&gt; entrantStates = new HashMap&lt;Integer, EntrantState&gt;();</span>

    protected EntrantState getEntrantState(Computer computer) {
<span class="nc" id="L32">        return getEntrantState(computer.getId());</span>
    }

    private EntrantState getEntrantState(int entrantId) {
<span class="nc" id="L36">        EntrantState state = entrantStates.get(entrantId);</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">        if (state == null) {</span>
<span class="nc" id="L38">            state = createEntrantState();</span>
<span class="nc" id="L39">            entrantStates.put(entrantId, state);</span>
        }
<span class="nc" id="L41">        return state;</span>
    }

    protected EntrantState createEntrantState() {
<span class="nc" id="L45">        return new EntrantState();</span>
    }


    protected boolean isPaused(Computer computer) {
<span class="nc bnc" id="L50" title="All 4 branches missed.">        return allPaused || getEntrantState(computer).isPaused();</span>
    }

    protected void doPause(Computer computer) {
<span class="nc" id="L54">        getEntrantState(computer).pause();</span>
<span class="nc" id="L55">    }</span>

    protected boolean doPause(Integer entrantId) {
<span class="nc" id="L58">        return getEntrantState(entrantId).isPaused();</span>
    }


    protected void clearPaused(Computer computer) {
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (getEntrantState(computer).isPaused()) {</span>
<span class="nc" id="L64">            getEntrantState(computer).clearPaused();</span>
        } else {
<span class="nc" id="L66">            allPaused = false;</span>
        }
<span class="nc" id="L68">    }</span>

    private boolean isBreakpoint(Computer computer) {
<span class="nc" id="L71">        return getEntrantState(computer).isBreakpoint(computer);</span>
    }

    public void afterInstruction(Computer computer) {
<span class="nc" id="L75">    }</span>

    public boolean isAllPaused() {
<span class="nc" id="L78">        return allPaused;</span>
    }

    public int getDefaultEntrant() {
<span class="nc" id="L82">        return defaultEntrant;</span>
    }

    public void setDefaultEntrant(int defaultEntrant) {
<span class="nc" id="L86">        this.defaultEntrant = defaultEntrant;</span>
<span class="nc" id="L87">    }</span>

    public void clearDefaultEntrant() {
<span class="nc" id="L90">        this.defaultEntrant = null;</span>
<span class="nc" id="L91">    }</span>

    public boolean hasDefaultEntrant() {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        return defaultEntrant != null;</span>
    }

    protected void invokeOnBreakpoint(Command command) throws InterruptedException {
<span class="nc" id="L98">        afterBreakpointCommandQueue.put(command);</span>
<span class="nc" id="L99">    }</span>

    protected void invokeLater(Command command) throws InterruptedException {
<span class="nc" id="L102">        commandQueue.put(command);</span>
<span class="nc" id="L103">    }</span>

    public void beforeInstruction(Computer computer) {
        try {
<span class="nc" id="L107">            final Collection&lt;Command&gt; commands = new ArrayList&lt;Command&gt;();</span>
<span class="nc" id="L108">            commandQueue.drainTo(commands);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            for (Command command : commands) {</span>
<span class="nc" id="L110">                command.execute(computer);</span>
<span class="nc" id="L111">            }</span>
<span class="nc" id="L112">            wasAllPaused = isAllPaused();</span>
<span class="nc bnc" id="L113" title="All 4 branches missed.">            if (isBreakpoint(computer) || isPaused(computer)) {</span>
<span class="nc" id="L114">                clearPaused(computer);</span>
<span class="nc" id="L115">                getBreakpointHandler().handleBreakpoint(computer);</span>
<span class="nc" id="L116">                waitForCommandAfterBreakpoint(computer);</span>
            }
<span class="nc" id="L118">        } catch (InterruptedException e) {</span>
<span class="nc" id="L119">            Thread.interrupted();</span>
<span class="nc" id="L120">            e.printStackTrace();</span>
<span class="nc" id="L121">        }</span>
<span class="nc" id="L122">    }</span>

    private void waitForCommandAfterBreakpoint(Computer computer) throws InterruptedException {
<span class="nc" id="L125">        inBreakpoint = true;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        while (inBreakpoint) {</span>
<span class="nc" id="L127">            afterBreakpointCommandQueue.take().execute(computer);</span>
        }
<span class="nc" id="L129">    }</span>

    public void pause(final int enrantId) throws InterruptedException {
<span class="nc" id="L132">        invokeLater(new Command() {</span>
            public void execute(Computer computer) {
<span class="nc" id="L134">                doPause(enrantId);</span>
<span class="nc" id="L135">            }</span>
        });
<span class="nc" id="L137">    }</span>

    public void pauseAll() throws InterruptedException {
<span class="nc" id="L140">        invokeLater(new Command() {</span>
            public void execute(Computer computer) {
<span class="nc" id="L142">                doPauseAll();</span>
<span class="nc" id="L143">            }</span>
        });
<span class="nc" id="L145">    }</span>

    public void go() throws InterruptedException {
<span class="nc" id="L148">        invokeOnBreakpoint(new Command() {</span>
            public void execute(Computer computer) {
<span class="nc" id="L150">                inBreakpoint = false;</span>
<span class="nc" id="L151">                clearPaused(computer);</span>
<span class="nc" id="L152">            }</span>
        });
<span class="nc" id="L154">    }</span>

    public void step() throws InterruptedException {
<span class="nc" id="L157">        invokeOnBreakpoint(new Command() {</span>
            public void execute(Computer computer) throws InterruptedException {
<span class="nc" id="L159">                inBreakpoint = false;</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">                if (wasAllPaused) {</span>
<span class="nc" id="L161">                    doPauseAll();</span>
                } else {
<span class="nc" id="L163">                    doPause(computer);</span>
                }
<span class="nc" id="L165">            }</span>
        });
<span class="nc" id="L167">    }</span>

    public void pause() throws InterruptedException {
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (hasDefaultEntrant()) {</span>
<span class="nc" id="L171">            pause(getDefaultEntrant());</span>
        }
<span class="nc" id="L173">        pauseAll();</span>
<span class="nc" id="L174">    }</span>

    public BreakpointHandler getBreakpointHandler() {
<span class="nc" id="L177">        return breakpointHandler;</span>
    }

    public void setBreakpointHandler(BreakpointHandler breakpointHandler) {
<span class="nc" id="L181">        this.breakpointHandler = breakpointHandler;</span>
<span class="nc" id="L182">    }</span>

    public void clearBreakpoint() throws InterruptedException {
<span class="nc" id="L185">        invokeOnBreakpoint(new Command() {</span>
            public void execute(Computer computer) {
<span class="nc" id="L187">                getEntrantState(computer).removeBreakpoint(computer.getInstructionPointer());</span>
<span class="nc" id="L188">            }</span>
        });

<span class="nc" id="L191">    }</span>

    public void clearBreakpoint(final int instructionPointer) throws InterruptedException {
<span class="nc" id="L194">        invokeLater(new Command() {</span>
            public void execute(Computer computer) {
<span class="nc" id="L196">                getDefaultEntrantState(computer).removeBreakpoint(instructionPointer);</span>
<span class="nc" id="L197">            }</span>
        });
<span class="nc" id="L199">    }</span>

    public void setBreakpoint() throws InterruptedException {
<span class="nc" id="L202">        invokeOnBreakpoint(new Command() {</span>
            public void execute(Computer computer) {
<span class="nc" id="L204">                getEntrantState(computer).setBreakpoint(computer.getInstructionPointer());</span>
<span class="nc" id="L205">            }</span>
        });
<span class="nc" id="L207">    }</span>

    public void setBreakpoint(final int instructionPointer) throws InterruptedException {
<span class="nc" id="L210">        invokeLater(new Command() {</span>
            public void execute(Computer computer) {
<span class="nc" id="L212">                getDefaultEntrantState(computer).setBreakpoint(instructionPointer);</span>
<span class="nc" id="L213">            }</span>
        });
<span class="nc" id="L215">    }</span>

    private EntrantState getDefaultEntrantState(Computer computer) {
<span class="nc bnc" id="L218" title="All 2 branches missed.">        return hasDefaultEntrant() ? getEntrantState(getDefaultEntrant()) : getEntrantState(computer);</span>
    }

    public void resetDefaultEntrant() throws InterruptedException {
<span class="nc" id="L222">        invokeLater(new Command() {</span>
            public void execute(Computer computer) throws InterruptedException {
<span class="nc" id="L224">                setDefaultEntrant(computer.getId());</span>
<span class="nc" id="L225">            }</span>
        });
<span class="nc" id="L227">    }</span>

<span class="nc" id="L229">    protected static class EntrantState {</span>
<span class="nc" id="L230">        private Set&lt;Integer&gt; breakpoints = new HashSet&lt;Integer&gt;();</span>
        private boolean paused;

        public boolean isBreakpoint(Computer computer) {
<span class="nc" id="L234">            return breakpoints.contains(computer.getInstructionPointer());</span>
        }

        public void setBreakpoint(int breakpoint) {
<span class="nc" id="L238">            breakpoints.add(breakpoint);</span>
<span class="nc" id="L239">        }</span>

        public void removeBreakpoint(int breakpoint) {
<span class="nc" id="L242">            breakpoints.remove(breakpoint);</span>
<span class="nc" id="L243">        }</span>

        public boolean isPaused() {
<span class="nc" id="L246">            return paused;</span>
        }

        public void clearPaused() {
<span class="nc" id="L250">            paused = false;</span>
<span class="nc" id="L251">        }</span>

        public void pause() {
<span class="nc" id="L254">            paused = true;</span>
<span class="nc" id="L255">        }</span>
    }

    protected static interface Command {
        void execute(Computer computer) throws InterruptedException;
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>