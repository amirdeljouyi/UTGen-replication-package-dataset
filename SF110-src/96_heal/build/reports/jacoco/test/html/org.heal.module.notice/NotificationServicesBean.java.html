<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationServicesBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.module.notice</a> &gt; <span class="el_source">NotificationServicesBean.java</span></div><h1>NotificationServicesBean.java</h1><pre class="source lang-java linenums">package org.heal.module.notice;

import org.heal.module.user.UserBean;
import org.heal.module.user.UserRegistryBean;

import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.AddressException;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.Properties;
import java.util.Vector;

/**
 * 
 *
 * @author Seth Wright
 * @version 0.1
 * @modify Jason Varghese
 */

<span class="nc" id="L28">public class NotificationServicesBean implements Serializable {</span>
    //The subject header for all outgoing messages generated by the system
    private static final String MAILER = &quot;Health Education Assets Library Notification System&quot;;
    //the address to use when sending messages
<span class="nc" id="L32">    private InternetAddress healAddress = null;  </span>
    //array containing one element - the above healAddress;
<span class="nc" id="L34">    private InternetAddress[] healAddressArray = new InternetAddress[1];  </span>
    //the address of the smtp host, if null, localhost is used
<span class="nc" id="L36">    private String mailhost = null; </span>
    //the username to use when attempting to log into the smtp server to send
<span class="nc" id="L38">    private String mailuser = null;</span>
    //the password to use when attempting to log into the smtp server to send
<span class="nc" id="L40">    private String mailpassword = null;</span>
    //The session to use for generating all of our outgoing messages
<span class="nc" id="L42">    private Session session = null;</span>
    //The java bean/module used for getting the user information
<span class="nc" id="L44">    UserRegistryBean userRegistry = null;</span>


    /**
     * Sets the mailhost setting and also gets a new Session object.
     * The mailhost setting is used to determine what server to connect to
     * in order to send our mail.
     */
    public void setMailhost(String newMailhost) {
<span class="nc" id="L53">        mailhost = newMailhost;</span>
<span class="nc" id="L54">        Properties props = System.getProperties();</span>

        // XXX - could use Session.getTransport() and Transport.connect()
        // XXX - assume we're using SMTP
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (mailhost != null) {</span>
<span class="nc" id="L59">            props.put(&quot;mail.smtp.host&quot;, mailhost);</span>
        }
<span class="nc" id="L61">        session =  Session.getDefaultInstance(props, null);</span>
<span class="nc" id="L62">        session.setDebug(false);</span>
<span class="nc" id="L63">    }</span>

    /**
     * Sets the mail user name of the account used to send emails from the
     * heal notification system.
     */
    public void setMailUser(String newUserName) {
<span class="nc" id="L70">        mailuser = newUserName;</span>
<span class="nc" id="L71">    }</span>

    /**
     * Sets the mail password of the account used to send emails from the
     * heal notification system.
     */
    public void setMailPassword(String newMailPassword) {
<span class="nc" id="L78">        mailpassword = newMailPassword;</span>
<span class="nc" id="L79">    }</span>

    /**
     * Sets the module used by the notification services to get user
     * information such as the list of admin users and the list of 
     * subscribers for receiving HEAL notices.
     */
    public void setUserRegistry(UserRegistryBean newRegistry) {
<span class="nc" id="L87">        userRegistry = newRegistry;</span>
<span class="nc" id="L88">    }</span>

    /**
     * Returns the mailhost setting
     */
    public String getMailhost() {
<span class="nc" id="L94">        return mailhost;</span>
    }

    /**
     * Sets the address used as the &quot;From&quot; header for all outgoing messages.
     */
    public void setHealAddress(InternetAddress address) {
<span class="nc" id="L101">        healAddress = address;</span>
<span class="nc" id="L102">        healAddressArray[0] = healAddress;</span>
<span class="nc" id="L103">    }</span>
    
    /**
     * Returns the address used as the from header for outgoing messages.
     */
    public InternetAddress getHealAddress() {
<span class="nc" id="L109">        return healAddress;</span>
    }

    /**
     * Given an array of user &lt;B&gt;names&lt;/B&gt;, sends the given message text to
     * each user's email address if one is found in the user database.
     * Returns true if no errors occur (even if none of the users have email
     * addresses in the database).
     */
    public boolean sendEmailToUsers(String[] userNames, String messageBody) throws MessagingException {
<span class="nc" id="L119">        boolean result = false;</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">        if (userNames == null || messageBody == null) {</span>
<span class="nc" id="L121">            return false;</span>
        }
<span class="nc" id="L123">        StringBuffer addressBuffer = null;</span>
        String currAddress;
<span class="nc" id="L125">        ArrayList emailAddresses = userRegistry.getEmailAddresses(userNames);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (emailAddresses != null) {</span>
<span class="nc" id="L127">            Iterator emailIterator = emailAddresses.iterator();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            while (emailIterator.hasNext()) {</span>
<span class="nc" id="L129">                currAddress = (String)emailIterator.next();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                if (addressBuffer != null) {</span>
<span class="nc" id="L131">                    addressBuffer.append(&quot;,&quot;+currAddress);</span>
                } else {
<span class="nc" id="L133">                addressBuffer = new StringBuffer(currAddress);</span>
                }
            }
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (addressBuffer != null) {</span>
<span class="nc" id="L138">            result = sendUserNotice(addressBuffer.toString(),messageBody);</span>
        }
<span class="nc" id="L140">        return result;</span>
    }

    /**
     * Given a comma-delimited list of &lt;B&gt;addresses&lt;/B&gt; and a message body,
     * sends the given message to all users specified in the list.
     * If the message is successfully sent true is returned.  If an 
     * error occurs, false is returned.
     */
    public boolean sendUserNotice(String userAddresses, String messageBody) throws MessagingException {
<span class="nc" id="L150">        boolean result = false;</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">        if (userAddresses == null || messageBody == null) {</span>
<span class="nc" id="L152">            return false;</span>
        }
        try {
<span class="nc" id="L155">            InternetAddress[] addrs = InternetAddress.parse(userAddresses,false);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (addrs != null) {</span>
<span class="nc" id="L157">                result = sendEmail(addrs,messageBody, MAILER);</span>
            }
        } 
<span class="nc" id="L160">        catch (AddressException adex) {</span>
<span class="nc" id="L161">            adex.printStackTrace();</span>
<span class="nc" id="L162">            result = false;</span>
<span class="nc" id="L163">        } </span>
<span class="nc" id="L164">        return result;</span>
    }

    /**
     * Looks up the list of all admin users in the database (via the 
     * user registry bean) and then sends a message with the given
     * body to all of them.
     */
    public boolean sendAdminNotice(String messageBody) throws MessagingException {
<span class="nc bnc" id="L173" title="All 4 branches missed.">        if (messageBody == null || userRegistry == null) {</span>
<span class="nc" id="L174">            return false;</span>
        }
<span class="nc" id="L176">        ArrayList addressList = userRegistry.getAdminEmailAddresses();</span>
<span class="nc" id="L177">        return sendToList(addressList, messageBody);</span>
    }

    /**
     * Looks up the list of all subscribed users in the database (via the 
     * user registry bean) and then sends a message with the given
     * body to all of them.
     */
    public boolean sendToList(String messageBody) throws MessagingException {
<span class="nc bnc" id="L186" title="All 4 branches missed.">        if (messageBody == null || userRegistry == null) {</span>
<span class="nc" id="L187">            return false;</span>
        }
<span class="nc" id="L189">        ArrayList addressList = userRegistry.getSubscriberEmailAddresses();</span>
<span class="nc" id="L190">        return sendToList(addressList, messageBody);</span>
    }

    /**
     * Given an ArrayList of Strings containing email addresses, this
     * method sends an email with the given body to each address in 
     * the list.  If an error occurs, this returns false, otherwise
     * it returns true.
     */
    public boolean sendToList(ArrayList addressList, String messageBody) throws MessagingException{
<span class="nc" id="L200">        boolean result = false;</span>
        try {
<span class="nc bnc" id="L202" title="All 4 branches missed.">            if (addressList == null || addressList.size() == 0) {</span>
                /* Well, we didn't need to send it to anyone, 
                * so we succeeded - sort of.
                */
<span class="nc" id="L206">                result = true;</span>
            } else {
<span class="nc" id="L208">                Iterator addressIterator = addressList.iterator();</span>
<span class="nc" id="L209">                StringBuffer addressBuffer = new StringBuffer();</span>
<span class="nc" id="L210">                String addressString = (String)addressIterator.next();</span>
<span class="nc" id="L211">                addressBuffer.append(addressString);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                while (addressIterator.hasNext()) {</span>
<span class="nc" id="L213">                    addressString = (String) addressIterator.next();</span>
<span class="nc" id="L214">                    addressBuffer.append(&quot;,&quot;+addressString);</span>
                }
<span class="nc" id="L216">                addressString = addressBuffer.toString();</span>
<span class="nc" id="L217">                InternetAddress[] toAddrs=InternetAddress.parse(addressString,</span>
								false);
<span class="nc" id="L219">                result = sendEmail(toAddrs,messageBody, MAILER);</span>
            }
        } 
<span class="nc" id="L222">        catch (AddressException adex) {</span>
<span class="nc" id="L223">            adex.printStackTrace();</span>
<span class="nc" id="L224">        }</span>
<span class="nc" id="L225">        return result;</span>
    }
    
    public Vector sendPasswordReminder(UserBean user, String baseURL) throws MessagingException
    {
<span class="nc" id="L230">        String username=null;</span>
<span class="nc" id="L231">        String password=null;</span>
<span class="nc" id="L232">        String message = null;</span>
<span class="nc" id="L233">        Vector errorMessage = new Vector();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if(user.isLoginModified())</span>
<span class="nc" id="L235">            username = user.getEmail();</span>
		else
<span class="nc" id="L237">            username = user.getUserName();</span>
<span class="nc" id="L238">        password = user.getPassword();</span>
<span class="nc" id="L239">        message = &quot;The following is the registration information you requested.&quot; + &quot;\n&quot;;</span>
<span class="nc" id="L240">        message = message + &quot;username: &quot;+username+'\n'+&quot;password: &quot;+password+&quot;\n&quot;;</span>
<span class="nc" id="L241">        message = message + &quot;Logon at: &quot;+baseURL+&quot;/user/login.jsp&quot; +&quot;\n\n&quot;;</span>
<span class="nc" id="L242">        String emailValidationPath = &quot;&quot;;</span>
<span class="nc" id="L243">        emailValidationPath = baseURL+&quot;/healapp/emailValidation?emailId=&quot;+user.getUserId()+&quot;&amp;email=&quot;+user.getEmail();</span>
<span class="nc bnc" id="L244" title="All 4 branches missed.">        if(user.isLoginModified()&amp;&amp;!user.isEmailValidated())</span>
<span class="nc" id="L245">            message = message + &quot;Your registration has not been completed yet.  Please confirm your account by clicking on this link \n&quot;+emailValidationPath+&quot;\n&quot;;      </span>
            try{
<span class="nc" id="L247">                InternetAddress[] address = new InternetAddress[1];</span>
<span class="nc" id="L248">                address[0] = new InternetAddress(user.getEmail());</span>
<span class="nc" id="L249">                sendEmail(address,message,&quot;Password Reminder from www.healcentral.org&quot;);</span>
            }
<span class="nc" id="L251">            catch (AddressException adex)</span>
            {
<span class="nc" id="L253">                errorMessage.addElement(&quot;Invalid Email Address&quot;);</span>
<span class="nc" id="L254">            }</span>
      
<span class="nc" id="L256">        return errorMessage;</span>
      
    }
		
    public Vector sendUsernameValidationEmail(UserBean user,String URL) throws MessagingException
    {
<span class="nc" id="L262">        String username=null;</span>
<span class="nc" id="L263">        String password=null;</span>
<span class="nc" id="L264">        String message = null;</span>
<span class="nc" id="L265">        Vector errorMessage = new Vector();</span>
<span class="nc" id="L266">        username = user.getUserName();</span>
<span class="nc" id="L267">        password = user.getPassword();</span>
<span class="nc" id="L268">        message = &quot;We require one final step to confirm your registration with www.healcentral.org.&quot; + &quot;\n&quot;;</span>
<span class="nc" id="L269">        message = message + &quot;To activate your registration click the following link:\n&quot;+URL+&quot;\n\n\n&quot;;</span>
<span class="nc" id="L270">        message = message +&quot;Please note: It is important that you follow through with this final step of confirming your registration.  &quot;;</span>
<span class="nc" id="L271">        message = message +&quot;By not doing so, your status will remain pending and registration with healcentral.org will not be activated.  &quot;;</span>
<span class="nc" id="L272">        message = message +&quot;If you experience problems with the provided link, simply copy the listed link and paste it into the address field within your browser.  &quot;;</span>
<span class="nc" id="L273">        message = message +&quot;For all other questions or concerns please email: info@healcentral.org&quot;;</span>
        try{
<span class="nc" id="L275">            InternetAddress[] address = new InternetAddress[1];</span>
<span class="nc" id="L276">            address[0] = new InternetAddress(user.getEmail());</span>
<span class="nc" id="L277">            sendEmail(address,message,&quot;Confirm your account at www.healcentral.org&quot;);</span>
        }
<span class="nc" id="L279">        catch (AddressException adex)</span>
        {
<span class="nc" id="L281">            errorMessage.addElement(&quot;Invalid Email Address&quot;);</span>
<span class="nc" id="L282">        }</span>
<span class="nc" id="L283">        return errorMessage;</span>
      
    }		
		
    
    public Vector sendWelcomeMessage(String email, String URL) throws MessagingException
    {
<span class="nc" id="L290">        String message = null;</span>
<span class="nc" id="L291">        Vector errorMessage = new Vector();</span>
<span class="nc" id="L292">        message = &quot;Your registration is complete.  Welcome to the Health Education Assets Library.  &quot; + &quot;\n&quot;;</span>
<span class="nc" id="L293">        message = message + &quot;To join the HEAL mailing list, please access the following URL:\n&quot;+URL+&quot;\n\n&quot;;</span>
<span class="nc" id="L294">        message = message +&quot;If you have any questions or concerns please email: info@healcentral.org&quot;;</span>
        try{
<span class="nc" id="L296">            InternetAddress[] address = new InternetAddress[1];</span>
<span class="nc" id="L297">            address[0] = new InternetAddress(email);</span>
<span class="nc" id="L298">            sendEmail(address,message,&quot;Welcome to the Health Education Assets Library&quot;);</span>
        }
<span class="nc" id="L300">        catch (AddressException adex)</span>
        {
<span class="nc" id="L302">            errorMessage.addElement(&quot;Invalid Email Address&quot;);</span>
<span class="nc" id="L303">        }</span>
<span class="nc" id="L304">        return errorMessage;</span>
    }   

    /**
     * Given an array of  email addresses and the message
     * body, sends an email containing that body to the specified recipients.
     * The sender is assumed to be the HEAL account specified during
     * initialization (healAddress)
     * Note:
     * If he have no addresses, we generate an error and return false.  
     * If we only have one address, then we simply set that as the TO address.
     * If we have multiple addresses, then we want to hide the
     * addresses from everyone else.  The easiest way to do this
     * is to do a blind carbon copy.  In this case, though we need
     * an initial TO Address still, so we send a copy to ourselves.
     * If this behavior is not desireable, then simply call this 
     * method multiple times with only one address as the parameter.
     */
    public boolean sendEmail(InternetAddress[] toAddresses, String text, String subject) throws MessagingException{
        try {
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (session == null) {</span>
<span class="nc" id="L325">            throw new MessagingException(&quot;No session to use to send a &quot;+</span>
					     &quot;message (session was null)&quot;);
            }
<span class="nc" id="L328">            Message msg = new MimeMessage(session);</span>
            /* See method note above. */
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if (toAddresses != null) {</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">            if (toAddresses.length &gt; 1) {</span>
<span class="nc" id="L332">                msg.setRecipients(Message.RecipientType.TO, </span>
                        healAddressArray);
<span class="nc" id="L334">                msg.setRecipients(Message.RecipientType.BCC, toAddresses);</span>
            } else {
<span class="nc" id="L336">                msg.setRecipients(Message.RecipientType.TO, toAddresses);</span>
            }
            } else {
<span class="nc" id="L339">                throw new MessagingException(&quot;No \&quot;To\&quot; address specified&quot;);</span>
            }
	    
            //msg.setSubject(MAILSUBJECT);
<span class="nc" id="L343">            msg.setSubject(subject);      </span>
<span class="nc" id="L344">            msg.setFrom(healAddress);</span>
<span class="nc" id="L345">            msg.setSentDate(new Date());</span>
<span class="nc" id="L346">            msg.setHeader(&quot;X-Mailer&quot;, MAILER);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (text != null) {</span>
<span class="nc" id="L348">                msg.setText(text);</span>
            } else {
<span class="nc" id="L350">                throw new MessagingException(&quot;No message text specified&quot;);</span>
            }
<span class="nc" id="L352">            msg.saveChanges(); // implicit with send()</span>
<span class="nc" id="L353">            Transport transport = session.getTransport(&quot;smtp&quot;);</span>
<span class="nc" id="L354">            transport.connect(mailhost, mailuser, mailpassword);</span>
<span class="nc" id="L355">            transport.sendMessage(msg, msg.getAllRecipients());</span>
<span class="nc" id="L356">            transport.close();</span>
        }
<span class="nc" id="L358">        catch (MessagingException ex) {</span>
<span class="nc" id="L359">            ex.printStackTrace();</span>
<span class="nc" id="L360">            throw new MessagingException(ex.toString());</span>
            //return false;
<span class="nc" id="L362">        }</span>
<span class="nc" id="L363">        return true;</span>
    }

    /**
     * Adds the user to the HEAL mailing list.  If an error occurs, this method
     * returns false.  If the user was successfully added, true is returned.
     */
    public boolean addUserToList(String userName) {
<span class="nc bnc" id="L371" title="All 2 branches missed.">    	if (userRegistry == null) {</span>
<span class="nc" id="L372">            return false;</span>
        } else {
<span class="nc" id="L374">            return userRegistry.addUserToSubscribers(userName);</span>
        }
    }

    /**
     * Removes the user from the HEAL mailing list.  If an error occurs, 
     * this method returns false.  If the user was successfully removed, 
     * true is returned.
     */
    public boolean removeUserFromList(String userName) {
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (userRegistry == null) {</span>
<span class="nc" id="L385">            return false;</span>
        } else {
<span class="nc" id="L387">            return userRegistry.removeUserFromSubscribers(userName);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>