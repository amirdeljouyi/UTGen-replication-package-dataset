<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdministrationDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.module.admin</a> &gt; <span class="el_source">AdministrationDAO.java</span></div><h1>AdministrationDAO.java</h1><pre class="source lang-java linenums">package org.heal.module.admin;

import java.io.*;
import java.sql.SQLException;
import java.sql.*;
import javax.sql.DataSource;

import com.ora.jsp.sql.*;
import com.ora.jsp.sql.value.BooleanValue;
import org.heal.module.user.*;
import org.heal.util.*;
import org.heal.module.metadata.*;

/**
 * This DAO was created by Grace, its content came from original AdministrationServicesBean.java.
 * @author Seth Wright
 * @modify by Grace Yang
 * @version 0.1
 */

<span class="nc" id="L21">public class AdministrationDAO implements Serializable {</span>
    //The accessor for database information
    private DataSource dataSource;
<span class="nc" id="L24">    CommonDAO cd = new CommonDAO();</span>
    //The java bean/module used for getting the user information
<span class="nc" id="L26">    private UserRegistryBean userRegistry = null;</span>
    //The file locator used to locate content to be deleted.
<span class="nc" id="L28">    private FileLocator fileLocator = null;</span>

    /**
     * Sets the file locator to be used to translate metadata location
     * entries into file paths so that the deleteContent method can
     * actually delete the content.
     */
    public void setFileLocator(FileLocator newFileLocator) {
<span class="nc" id="L36">        fileLocator = newFileLocator;</span>
<span class="nc" id="L37">    }</span>

    /**
     * Returns the FileLocator being used by the Admin services.
     */
    public FileLocator getFileLocator() {
<span class="nc" id="L43">        return fileLocator;</span>
    }

    /**
     * Sets the module used by the administration services to get user
     * information such as the list of admin users and the list of
     * subscribers for receiving HEAL notices.
     */
    public void setUserRegistry(UserRegistryBean newRegistry) {
<span class="nc" id="L52">        userRegistry = newRegistry;</span>
<span class="nc" id="L53">    }</span>

    /**
     * Sets the dataSource property value.
     */
    public void setDataSource(DataSource dataSource) {
<span class="nc" id="L59">        this.dataSource = dataSource;</span>
<span class="nc" id="L60">    }</span>

    /**
     * Performs a possible long running overall consistency and integrity
     * check of the data in teh library.  Returns a IntegrityReportBean
     * that contains statistics on corrupt files, orphaned files, content
     * without metadata, missing files, and duplicate files.
     */
    public void checkSystemIntegrity() {
        //XXX not implemented
<span class="nc" id="L70">    }</span>

    /**
     * Marks a given metadata's entry as hidden, thus keeping it from showing
     * up in searches, etc.  Returns true if successful, false otherwise.
     */
    public boolean hideContent(String metadataId) {
<span class="nc" id="L77">        boolean success = false;</span>
        try {
<span class="nc" id="L79">            updateMetadataBooleanProperty(&quot;Private&quot;, true, metadataId);</span>
<span class="nc" id="L80">            success = true;</span>
<span class="nc" id="L81">        } catch(SQLException ex) {</span>
<span class="nc" id="L82">            ex.printStackTrace();</span>
<span class="nc" id="L83">        }</span>
<span class="nc" id="L84">        return success;</span>
    }

    /**
     * Marks a given metadata's entry as visible, thus allowing it to show
     * up in searches, etc.  Returns true if successful, false otherwise.
     */
    public boolean makeContentVisible(String metadataId) {
<span class="nc" id="L92">        boolean success = false;</span>
        try {
<span class="nc" id="L94">            updateMetadataBooleanProperty(&quot;Private&quot;, false, metadataId);</span>
<span class="nc" id="L95">            success = true;</span>
<span class="nc" id="L96">        } catch(SQLException ex) {</span>
<span class="nc" id="L97">            ex.printStackTrace();</span>
<span class="nc" id="L98">        }</span>
<span class="nc" id="L99">        return success;</span>
    }

    /**
     * Removes all references to the metadata from the metadata tables, then
     * makes a new entry in the DeletedItems table.  Finally, the content
     * file itself is deleted.
     * Note:  All entries in the database associated with the metadata
     * will be deleted, this includes taxons related to taxon paths associated
     * with the metadata Id.  Also, copyright texts that are only referenced
     * from copyright entries associated with this metadata Id will also
     * be deleted.
     */
    public boolean deleteContent(String metadataId) {
<span class="nc" id="L113">        boolean success = false;</span>
        MetadataBean metadata;
        ThumbnailBean thumbnail;
        String thumbnailLocation;
        File thumbnailFile;
        String contentLocation;
        File contentFile;
<span class="nc" id="L120">        Connection conn = null;</span>
        try {
<span class="nc" id="L122">            conn = dataSource.getConnection();</span>
<span class="nc" id="L123">            conn.setAutoCommit(false);</span>
<span class="nc" id="L124">            metadata = cd.getMetadata(metadataId, conn);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if(metadata != null) {</span>
<span class="nc" id="L126">                contentLocation = metadata.getLocation();</span>
<span class="nc" id="L127">                thumbnail = cd.getThumbnail(metadataId, conn);</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                if(thumbnail != null) {</span>
<span class="nc" id="L129">                    thumbnailLocation = thumbnail.getLocation();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                    if(thumbnailLocation != null) {</span>
<span class="nc" id="L131">                        thumbnailFile = new File(fileLocator.getThumbnailFilePath(thumbnailLocation));</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                        if(thumbnailFile != null) {</span>
<span class="nc" id="L133">                            thumbnailFile.delete();</span>
                        }
                    }
                }
<span class="nc" id="L137">                moveToDeletedItems(metadataId, &quot;Content deleted.&quot;, conn);</span>
<span class="nc" id="L138">                conn.commit();</span>
<span class="nc" id="L139">                contentFile = new File(fileLocator.getContentFilePath(contentLocation));</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                if(contentFile != null) {</span>
<span class="nc" id="L141">                    success = contentFile.delete();</span>
                } else {
<span class="nc" id="L143">                    success = true;</span>
                }
            } else {
<span class="nc" id="L146">                success = true;</span>
            }
<span class="nc" id="L148">        } catch(SQLException ex) {</span>
<span class="nc" id="L149">            ex.printStackTrace();</span>
        } finally {
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if(conn != null) {</span>
                try {
<span class="nc" id="L153">                    conn.setAutoCommit(true);</span>
<span class="nc" id="L154">                    conn.commit();</span>
<span class="nc" id="L155">                    conn.close();</span>
<span class="nc" id="L156">                } catch(Exception ex) {</span>
                    //ignore for now
<span class="nc" id="L158">                }</span>
            }
        }
<span class="nc" id="L161">        return success;</span>
    }

    /**
     * Sets the permissions of the user in the database.
     * Returns true if the permissions were successfully set, false if
     * an error occured.
     */
    public boolean setPermissions(String userId, UserPermissionsBean permissions) {
<span class="nc" id="L170">        return userRegistry.setPermissions(userId, permissions);</span>
    }

    /**
     * Given a property name and value and a metadata Id, updates
     * the metadata's table to reflect the given value.
     */
    public void updateMetadataBooleanProperty(String propertyName,
                                              boolean propertyValue,
                                              String metadataId)
            throws SQLException {
<span class="nc" id="L181">        updateMetadataValueProperty(propertyName, new BooleanValue(propertyValue), metadataId);</span>
<span class="nc" id="L182">    }</span>

    /**
     * Given a property name and value and a metadata Id, updates
     * the metadata's table to reflect the given value.
     */
    public void updateMetadataValueProperty(String propertyName, Value propertyValue, String metadataId)
            throws SQLException {
        // Save the metadata info from the database
<span class="nc" id="L191">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L192">        conn.setAutoCommit(false);</span>
        try {
<span class="nc" id="L194">            cd.updateMetadataValueProperty(propertyName, propertyValue, metadataId, conn);</span>
<span class="nc" id="L195">            conn.commit();</span>
        } finally {
            try {
<span class="nc" id="L198">                conn.setAutoCommit(true);</span>
<span class="nc" id="L199">                conn.close();</span>
<span class="nc" id="L200">            } catch(SQLException e) {</span>
<span class="nc" id="L201">            } // Ignore</span>
        }
<span class="nc" id="L203">    }</span>

    /**
     * Given a metadataId, creates an entry for that metadata in the
     * DeletedItems table with information from the current Metadata
     * table and the provided comment.  The DeleteDate will be set
     * as the current date.
     * Returns true if no problems occured, false otherwise.
     */
    public boolean moveToDeletedItems(String metadataId, String comment, Connection conn)
            throws SQLException {
<span class="nc" id="L214">        boolean success = false;</span>
<span class="nc" id="L215">        MetadataBean metadata = cd.getMetadata(metadataId, conn);</span>
<span class="nc" id="L216">        cd.addToDeletedItems(metadata, comment, conn);</span>
<span class="nc" id="L217">        success = cd.deleteMetadataReferences(metadataId, conn);</span>
<span class="nc" id="L218">        cd.removeMetadataFromTable(metadataId, &quot;Metadata&quot;, conn);</span>
<span class="nc" id="L219">        return success;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>