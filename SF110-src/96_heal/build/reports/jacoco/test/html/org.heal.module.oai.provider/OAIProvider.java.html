<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OAIProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.module.oai.provider</a> &gt; <span class="el_source">OAIProvider.java</span></div><h1>OAIProvider.java</h1><pre class="source lang-java linenums">/*
 * Created on Dec 1, 2004
 *
 */
package org.heal.module.oai.provider;

import java.io.IOException;
import java.io.PrintWriter;
import java.text.ParseException;
import java.util.Date;
import java.util.Iterator;
import java.util.Map;

import org.heal.module.oai.provider.verb.OAIVerb;

/**
 * @author Seth Wright
 *
 */
<span class="nc" id="L20">public class OAIProvider {</span>
	public static final boolean debug = false;
<span class="nc" id="L22">	private static OAIProviderConfig config = null;</span>
	public static void init(final OAIProviderConfig config) {
<span class="nc" id="L24">		OAIProvider.config = config;</span>
<span class="nc" id="L25">	}</span>
	
	//NOTE: the parameters Map contains String arrays (String[])
	//This is required because we have to detect duplicate parameters and
	//give a badArgument error
	public static void processRequest(final String requestURL,
									  final DataAccessor dataAccessor,
									  final Map parameters,
									  final PrintWriter out) 
	throws IOException
	{

<span class="nc" id="L37">		out.println(&quot;&lt;?xml version='1.0' encoding='UTF-8'?&gt;&quot;);</span>
<span class="nc" id="L38">		out.print(&quot;&lt;OAI-PMH xmlns=\&quot;http://www.openarchives.org/OAI/2.0/\&quot; xmlns:xsi=\&quot;http://www.w3.org/2001/XMLSchema-instance\&quot; &quot;);</span>
<span class="nc" id="L39">		out.println(&quot;xsi:schemaLocation=\&quot;http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd\&quot;&gt;&quot;);</span>
		//these should be ordered by which is most likely to occur
<span class="nc" id="L41">		ValidatedInput input = validateInput(dataAccessor,parameters,out);</span>
<span class="nc" id="L42">		writeOAIResponseHeader(input,</span>
								parameters,
								dataAccessor,
								requestURL,
								out);
<span class="nc bnc" id="L47" title="All 2 branches missed.">		if (input.errorList.size() == 0) {</span>
<span class="nc" id="L48">			input.verb.execute(input,config,dataAccessor,out);</span>
<span class="nc" id="L49">			dataAccessor.closeQuery();			</span>
		} else {
<span class="nc" id="L51">			Iterator iter = input.errorList.iterator();</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">			while(iter.hasNext()) {</span>
<span class="nc" id="L53">				out.println((String)iter.next());</span>
			}
		}
<span class="nc" id="L56">		out.println(&quot;&lt;/OAI-PMH&gt;&quot;);</span>
<span class="nc" id="L57">	}</span>
	
	private static void writeOAIResponseHeader(final ValidatedInput input,
												final Map parameters,
												final DataAccessor accessor, 
												final String requestURL, 
												final PrintWriter writer) {
		//get nowUTC from the database because that's the relevant time.
<span class="nc" id="L65">		Date responseDate = accessor.getNow();</span>
<span class="nc" id="L66">		String now = OAIGranularity.yearMonthDayHourMinuteSecond.format(responseDate);</span>
<span class="nc" id="L67">		writer.print(&quot;&lt;responseDate&gt;&quot;);</span>
<span class="nc" id="L68">		writer.print(now);</span>
<span class="nc" id="L69">		writer.println(&quot;&lt;/responseDate&gt;&quot;);</span>
<span class="nc" id="L70">		writer.print(&quot;&lt;request&quot;);</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (input.verb != null) {</span>
<span class="nc" id="L73">			writer.print(&quot; verb=\&quot;&quot;);				</span>
<span class="nc" id="L74">			writer.print(input.verb.getName());</span>
<span class="nc" id="L75">			writer.print(&quot;\&quot;&quot;);</span>
		}
<span class="nc bnc" id="L77" title="All 2 branches missed.">		if (input.identifier != null) {</span>
<span class="nc" id="L78">			writer.print(&quot; identifier=\&quot;&quot;);				</span>
<span class="nc" id="L79">			writer.print(input.identifier);</span>
<span class="nc" id="L80">			writer.print(&quot;\&quot;&quot;);</span>
		}
<span class="nc bnc" id="L82" title="All 2 branches missed.">		if (input.format != null) {</span>
<span class="nc" id="L83">			writer.print(&quot; metadataPrefix=\&quot;&quot;);				</span>
<span class="nc" id="L84">			writer.print(input.format.getPrefix());</span>
<span class="nc" id="L85">			writer.print(&quot;\&quot;&quot;);</span>
		}
<span class="nc bnc" id="L87" title="All 2 branches missed.">		if (input.from != null) {</span>
<span class="nc" id="L88">			writer.print(&quot; from=\&quot;&quot;);				</span>
<span class="nc" id="L89">			writer.print(((String[])parameters.get(&quot;from&quot;))[0]);</span>
<span class="nc" id="L90">			writer.print(&quot;\&quot;&quot;);</span>
		}
<span class="nc bnc" id="L92" title="All 2 branches missed.">		if (input.until != null) {</span>
<span class="nc" id="L93">			writer.print(&quot; until=\&quot;&quot;);				</span>
<span class="nc" id="L94">			writer.print(((String[])parameters.get(&quot;until&quot;))[0]);</span>
<span class="nc" id="L95">			writer.print(&quot;\&quot;&quot;);</span>
		}
<span class="nc bnc" id="L97" title="All 2 branches missed.">		if (input.resumptionToken != null) {</span>
<span class="nc" id="L98">			writer.print(&quot; resumptionToken=\&quot;&quot;);				</span>
<span class="nc" id="L99">			writer.print(((String[])parameters.get(&quot;resumptionToken&quot;))[0]);</span>
<span class="nc" id="L100">			writer.print(&quot;\&quot;&quot;);</span>
		}
<span class="nc bnc" id="L102" title="All 2 branches missed.">		if (input.set != null) {</span>
<span class="nc" id="L103">			writer.print(&quot; set=\&quot;&quot;);				</span>
<span class="nc" id="L104">			writer.print(((String[])parameters.get(&quot;set&quot;))[0]);</span>
<span class="nc" id="L105">			writer.print(&quot;\&quot;&quot;);</span>
		}
<span class="nc" id="L107">		writer.print(&quot;&gt;&quot;);</span>
<span class="nc" id="L108">		writer.print(requestURL);</span>
<span class="nc" id="L109">		writer.println(&quot;&lt;/request&gt;&quot;);		</span>
<span class="nc" id="L110">	}</span>

	public static void writeString(final String tagName,final String value,final PrintWriter writer) {
<span class="nc" id="L113">		writer.print(&quot;&lt;&quot;+tagName+&quot;&gt;&quot;);</span>
<span class="nc" id="L114">		writer.print(value);</span>
<span class="nc" id="L115">		writer.println(&quot;&lt;/&quot;+tagName+&quot;&gt;&quot;);		</span>
<span class="nc" id="L116">	}</span>

	public static void writeStrings(final String[] strings, 
									 final String tagName, 
									 final PrintWriter writer) 
	{
<span class="nc bnc" id="L122" title="All 2 branches missed.">		if (strings == null) return;</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">		for(int i=0;i&lt;strings.length;i++) {</span>
<span class="nc" id="L124">			writeString(tagName,strings[i],writer);</span>
		}
<span class="nc" id="L126">	}</span>

	public static String getErrorString(final OAIErrorCode code, final String description) {
<span class="nc" id="L129">		StringBuffer buf = new StringBuffer();</span>
<span class="nc" id="L130">		buf.append(&quot;&lt;error code=\&quot;&quot;);</span>
<span class="nc" id="L131">		buf.append(code.getName());</span>
<span class="nc" id="L132">		buf.append(&quot;\&quot;&gt;&quot;);</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">		if (description != null) {</span>
<span class="nc" id="L134">			buf.append(description);</span>
		}
<span class="nc" id="L136">		buf.append(&quot;&lt;/error&gt;&quot;);		</span>
<span class="nc" id="L137">		return buf.toString();</span>
	}
	
	public static void writeResumptionToken(final OAIResumptionToken token,final PrintWriter writer) 
	{
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (token == null) {</span>
<span class="nc" id="L143">			writer.println(&quot;&lt;resumptionToken&gt;&lt;/resumptionToken&gt;&quot;);</span>
<span class="nc" id="L144">			return;</span>
		}
<span class="nc" id="L146">		long size = token.getCompleteListSize();</span>
<span class="nc" id="L147">		long cursor = token.getCursor();</span>
<span class="nc" id="L148">		boolean queryCompleted = token.queryCompleted();</span>
<span class="nc" id="L149">		writer.print(&quot;&lt;resumptionToken&quot;);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">		if (!queryCompleted) {</span>
<span class="nc" id="L151">			Date expirationDate = token.getExpirationDate();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (expirationDate != null) {</span>
<span class="nc" id="L153">				writer.print(&quot; expirationDate=\&quot;&quot;+OAIGranularity.yearMonthDayHourMinuteSecond.format(expirationDate)+&quot;\&quot;&quot;);</span>
			}
		}
<span class="nc bnc" id="L156" title="All 2 branches missed.">		if (size &gt; 0) {</span>
<span class="nc" id="L157">			writer.print(&quot; completeListSize=\&quot;&quot;+size+&quot;\&quot;&quot;);</span>
		}
<span class="nc bnc" id="L159" title="All 2 branches missed.">		if (cursor &gt;= 0) {</span>
<span class="nc" id="L160">			writer.print(&quot; cursor=\&quot;&quot;+cursor+&quot;\&quot;&quot;);				</span>
		}
<span class="nc bnc" id="L162" title="All 2 branches missed.">		if (queryCompleted) {</span>
<span class="nc" id="L163">			writer.println(&quot;/&gt;&quot;);</span>
		} else {
<span class="nc" id="L165">			writer.print(&quot;&gt;&quot;);</span>
<span class="nc" id="L166">			writer.print(token.getContent());</span>
<span class="nc" id="L167">			writer.println(&quot;&lt;/resumptionToken&gt;&quot;);</span>
		}
<span class="nc" id="L169">	}</span>
			
	public static void writeRecord(final OAIRecord record, final OAIMetadataHandler handler, PrintWriter writer) throws IOException {
<span class="nc" id="L172">		writer.println(&quot;&lt;record&gt;&quot;);</span>
<span class="nc" id="L173">		writeRecordHeader(record,writer);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">		if (!record.isDeleted()) {</span>
<span class="nc" id="L175">			OAIRecordAdapter adapter = record.getRecordAdapter(handler.getFormat());</span>
			//if the record was deleted, only the header is returned because there is no record 
			//(if there was a record, it wouldn't have been deleted, would it?
<span class="nc" id="L178">			writer.print(&quot;&lt;metadata&gt;&quot;);</span>
<span class="nc" id="L179">			handler.writeMetadata(adapter,writer);		</span>
<span class="nc" id="L180">			writer.println(&quot;&lt;/metadata&gt;&quot;);</span>
<span class="nc bnc" id="L181" title="All 4 branches missed.">			if (adapter.hasOAIAbout() || adapter.hasCustomAbout()) {</span>
<span class="nc" id="L182">				writer.print(&quot;&lt;about&gt;&quot;);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">				if (adapter.hasOAIAbout()) {</span>
<span class="nc" id="L184">					handler.writeOAIAbout(adapter,writer);</span>
				}
<span class="nc bnc" id="L186" title="All 2 branches missed.">				if (adapter.hasCustomAbout()) {</span>
<span class="nc" id="L187">					handler.writeCustomAbout(adapter,writer);</span>
				}
<span class="nc" id="L189">				writer.println(&quot;&lt;/about&gt;&quot;);</span>
			}
		}
<span class="nc" id="L192">		writer.println(&quot;&lt;/record&gt;&quot;);</span>
<span class="nc" id="L193">	}</span>

	public static void writeRecordHeader(final OAIRecord record, final PrintWriter writer) {
<span class="nc bnc" id="L196" title="All 2 branches missed.">		if (record.isDeleted()) {</span>
<span class="nc" id="L197">			writer.println(&quot;&lt;header status=\&quot;deleted\&quot;&gt;&quot;);</span>
		} else {
<span class="nc" id="L199">			writer.println(&quot;&lt;header&gt;&quot;);</span>
		}
<span class="nc" id="L201">		writer.print(&quot;&lt;identifier&gt;&quot;);</span>
<span class="nc" id="L202">		writer.print(record.getOAIIdentifier());</span>
<span class="nc" id="L203">		writer.println(&quot;&lt;/identifier&gt;&quot;);</span>
<span class="nc" id="L204">		writer.print(&quot;&lt;datestamp&gt;&quot;);</span>
<span class="nc" id="L205">		writer.print(OAIGranularity.yearMonthDayHourMinuteSecond.format(record.getDateStamp()));</span>
<span class="nc" id="L206">		writer.println(&quot;&lt;/datestamp&gt;&quot;);</span>
<span class="nc" id="L207">		OAISet[] sets = record.getSets();</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">		if (sets != null &amp;&amp; sets.length &gt; 0) {</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">			for (int i=0;i&lt;sets.length;i++) {</span>
<span class="nc" id="L210">				writer.print(&quot;&lt;setSpec&gt;&quot;);</span>
<span class="nc" id="L211">				writer.print(sets[i].getSpec());</span>
<span class="nc" id="L212">				writer.println(&quot;&lt;/setSpec&gt;&quot;);</span>
			}
		}
<span class="nc" id="L215">		writer.println(&quot;&lt;/header&gt;&quot;);</span>
<span class="nc" id="L216">	}</span>

	private static String getParameterUnique(String paramName,Map parameters,ValidatedInput validated) {
<span class="nc" id="L219">		String retval = null;</span>
<span class="nc" id="L220">		String[] paramArr = (String[])parameters.get(paramName);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (paramArr != null) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">			if (paramArr.length &gt; 1) {</span>
<span class="nc" id="L223">				validated.errorList.add(getErrorString(OAIErrorCode.BAD_ARGUMENT,&quot;Unexpected duplicate paramater '&quot;+paramName+&quot;'.  Please resubmit the request with only one.&quot;));</span>
			}
			//we still only validate the first one.
<span class="nc" id="L226">			retval = paramArr[0];</span>
		}
<span class="nc" id="L228">		return retval;</span>
	}
	
	/* Return null if an error occurs, otherwise it returns a DateHolder
	 * with the from and until set to the Date versions of the input strings
	 * 
	 * If the input strings are null, the corresponding Date will also be
	 * set to null.
	 */
	private static ValidatedInput validateInput(final DataAccessor dataAccessor,
												final Map parameters,
												final PrintWriter writer) 
	{
<span class="nc" id="L241">		ValidatedInput retval = new ValidatedInput();</span>
		//verb,identifier,metadataPrefix,from,until,resumptionToken,set,
<span class="nc" id="L243">		String verbStr = getParameterUnique(&quot;verb&quot;,parameters,retval);</span>
<span class="nc" id="L244">		String resumptionToken = getParameterUnique(&quot;resumptionToken&quot;,parameters,retval);</span>
<span class="nc" id="L245">		String identifier = getParameterUnique(&quot;identifier&quot;,parameters,retval);</span>
<span class="nc" id="L246">		String metadataPrefix = getParameterUnique(&quot;metadataPrefix&quot;,parameters,retval);</span>
<span class="nc" id="L247">		String set = getParameterUnique(&quot;set&quot;,parameters,retval);</span>
<span class="nc" id="L248">		String from = getParameterUnique(&quot;from&quot;,parameters,retval);</span>
<span class="nc" id="L249">		String until = getParameterUnique(&quot;until&quot;,parameters,retval);</span>
<span class="nc" id="L250">		System.out.println(&quot;OAI request = [verb=&quot;+verbStr+&quot;, identifier=&quot;+identifier+&quot;, metadataPrefix=&quot;+metadataPrefix+&quot;, from=&quot;+from+&quot;, until=&quot;+until+&quot;, resumptionToken=&quot;+resumptionToken+&quot;, set=&quot;+set+&quot;]&quot;);</span>
<span class="nc" id="L251">		parameters.remove(&quot;verb&quot;);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">		retval.verb = (verbStr!=null)?OAIVerb.getVerb(verbStr):null;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (verbStr == null) {</span>
<span class="nc" id="L254">			retval.errorList.add(getErrorString(OAIErrorCode.BAD_VERB,&quot;The request was missing a verb.&quot;));</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">		} else if (retval.verb == null) {</span>
<span class="nc" id="L256">			retval.errorList.add(getErrorString(OAIErrorCode.BAD_VERB,&quot;Illegal OAI verb '&quot;+verbStr+&quot;'&quot;));</span>
		}

<span class="nc bnc" id="L259" title="All 2 branches missed.">		if (resumptionToken != null) {</span>
<span class="nc" id="L260">			retval.resumptionToken = dataAccessor.parseResumptionToken(resumptionToken);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">			if (retval.resumptionToken == null) {</span>
<span class="nc" id="L262">				retval.errorList.add(getErrorString(OAIErrorCode.BAD_RESUMPTION_TOKEN,resumptionToken+&quot; does not conform to the resumption token format of this provider.&quot;));</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">			} else if (dataAccessor.isExpired(retval.resumptionToken)) {</span>
<span class="nc" id="L264">				retval.errorList.add(getErrorString(OAIErrorCode.BAD_RESUMPTION_TOKEN,&quot;resumptionToken '&quot;+resumptionToken+&quot;' has expired.&quot;));</span>
			}
<span class="nc bnc" id="L266" title="All 10 branches missed.">			if (identifier != null || metadataPrefix != null || from != null || until != null || set != null) {</span>
<span class="nc" id="L267">				retval.errorList.add(getErrorString(OAIErrorCode.BAD_ARGUMENT,&quot;The resumptionToken argument is an exclusive argument but other parameters were included in this request.&quot;));</span>
			}
<span class="nc bnc" id="L269" title="All 2 branches missed.">			if (retval.resumptionToken != null) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">				if (retval.resumptionToken.getMetadataPrefix() != null) {</span>
<span class="nc" id="L271">					retval.format = config.getMetadataFormat(retval.resumptionToken.getMetadataPrefix());</span>
				} else {
<span class="nc" id="L273">					System.out.println(&quot;resumptiontoken prefix was null&quot;);</span>
				}
			}
		}
<span class="nc bnc" id="L277" title="All 2 branches missed.">		if (identifier != null) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (!dataAccessor.validateIdentifier(identifier)) {</span>
<span class="nc" id="L279">				retval.errorList.add(getErrorString(OAIErrorCode.BAD_ARGUMENT,identifier+&quot; does not conform to the identifier format of this provider.&quot;));</span>
<span class="nc" id="L280">				retval.identifier = null;</span>
			} else {
<span class="nc" id="L282">				retval.identifier = identifier;</span>
			}
		}
		//validate that the metadataPrefix is supported
<span class="nc bnc" id="L286" title="All 2 branches missed.">		if (metadataPrefix != null) {</span>
<span class="nc" id="L287">			OAIMetadataFormat format = config.getMetadataFormat(metadataPrefix);</span>
<span class="nc bnc" id="L288" title="All 4 branches missed.">			if (format == null || format.getHandler() == null) {</span>
<span class="nc" id="L289">				retval.errorList.add(getErrorString(OAIErrorCode.CANNOT_DISSEMINATE_FORMAT,&quot;The metadataPrefix '&quot;+metadataPrefix+&quot;' is not recognized by this provider.&quot;));</span>
<span class="nc" id="L290">				retval.format = null;</span>
			} else {
<span class="nc" id="L292">				retval.format = format;</span>
			}
		}
		//set validation
<span class="nc bnc" id="L296" title="All 2 branches missed.">		if (set != null) {</span>
			//we don't check for no set heirarchy here, that gets pushed to the later responses
<span class="nc bnc" id="L298" title="All 2 branches missed.">			if (!dataAccessor.validateSet(set)) {</span>
<span class="nc" id="L299">				retval.errorList.add(getErrorString(OAIErrorCode.BAD_ARGUMENT,set+&quot; does not conform to the set token format of this provider.&quot;));</span>
<span class="nc" id="L300">				retval.set = null;</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">			} else if (!dataAccessor.setExists(set)) {</span>
<span class="nc" id="L302">				retval.errorList.add(getErrorString(OAIErrorCode.BAD_ARGUMENT,set+&quot; is not a valid set for this repository.&quot;));</span>
<span class="nc" id="L303">				retval.set = null;</span>
			} else {
<span class="nc" id="L305">				retval.set = set;</span>
			}
		}
		//now we check the dates
<span class="nc bnc" id="L309" title="All 4 branches missed.">		if (until != null || from != null) {</span>
			//we only care about this if we have dates to parse...
			//the parsing should be based on the granularity we support
<span class="nc" id="L312">			OAIGranularity granularity = config.getGranularity();</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">			if (until != null) {</span>
				try {
<span class="nc" id="L315">					retval.until = granularity.parse(until);</span>
<span class="nc" id="L316">				} catch (ParseException ex) {</span>
<span class="nc" id="L317">					retval.errorList.add(getErrorString(OAIErrorCode.BAD_ARGUMENT,&quot;The until date '&quot;+until+&quot;' is not in the expected format of &quot;+granularity));</span>
<span class="nc" id="L318">					retval.until = null;</span>
<span class="nc" id="L319">				}</span>
			}
<span class="nc bnc" id="L321" title="All 2 branches missed.">			if (from != null) {</span>
				try {
<span class="nc" id="L323">					retval.from = granularity.parse(from);</span>
<span class="nc" id="L324">				} catch (ParseException ex) {</span>
<span class="nc" id="L325">					retval.errorList.add(getErrorString(OAIErrorCode.BAD_ARGUMENT,&quot;The from date '&quot;+from+&quot;' is not in the expected format of &quot;+granularity));</span>
<span class="nc" id="L326">					retval.from = null;</span>
<span class="nc" id="L327">				}</span>
			}
<span class="nc bnc" id="L329" title="All 4 branches missed.">			if (retval.from != null &amp;&amp; retval.until != null) {</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">				if (retval.from.getTime() &gt; retval.until.getTime()) {</span>
<span class="nc" id="L331">					retval.errorList.add(getErrorString(OAIErrorCode.BAD_ARGUMENT,&quot;The from date '&quot;+from+&quot;' cannot be later than the until date '&quot;+until+&quot;'&quot;));</span>
				}
			}
//			if (retval.until != null) {
//				Date earliestDate = config.getEarliestDatestamp();
//				if (retval.until.getTime() &lt; earliestDate.getTime()) {
//					String earliestAvailable = granularity.format(earliestDate);
//					writeError(OAIErrorCode.BAD_ARGUMENT,&quot;The until date '&quot;+until+&quot;' is earlier than this repository's earliest available date '&quot;+earliestAvailable+&quot;'&quot;,writer);					
//					errorOccurred = true;
//				}
//			}
		}
<span class="nc bnc" id="L343" title="All 2 branches missed.">		if (retval.verb != null) {</span>
<span class="nc" id="L344">			retval.verb.validateInput(retval,parameters);</span>
		}
<span class="nc" id="L346">		return retval;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>