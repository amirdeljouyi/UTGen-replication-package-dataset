<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleSearchDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.module.search</a> &gt; <span class="el_source">SimpleSearchDAO.java</span></div><h1>SimpleSearchDAO.java</h1><pre class="source lang-java linenums">package org.heal.module.search;

import java.io.*;
import java.sql.*;
import java.util.*;
import javax.sql.*;
import com.ora.jsp.sql.*;
import org.heal.module.metadata.*;

/**
 * @author Grace/Julie 
 * @version 0.1
 */
 
public class SimpleSearchDAO implements Serializable
{
  public SimpleSearchDAO()
<span class="nc" id="L18">  {</span>
<span class="nc" id="L19">  }</span>
  private DataSource dataSource;   
  /**
   * Sets the dataSource property value. 
   */
  public void setDataSource(DataSource dataSource) 
  {
<span class="nc" id="L26">    this.dataSource = dataSource;</span>
<span class="nc" id="L27">  }         </span>
  /**
   * Here is the process by which the simple search works.
   * First, traverses through the ParameterBean passed from 
   * the search action page, and builds a single sql query from the 
   * information in the Bean. Than we search the following table and fields.
   * Metadata Table: Title, Description, SourceCollection, and MetadataID
   * Keywords Table: Keyword
   * Formats Table: Format
   * Copyrights and CopyrightTexts Tables: CopyrightTextID and CopyrightText 
   * CopyrightHolders and Vcards Tables: VcardID and Vcard
   * Contributors and Vcards Tables: VcardID and Vcard
   * TaxonPaths and Taxons Tables: TaxonPathID and Entry
   * The results that are left are packaged into a SearchResultBean and returned.
   * If filterHidden is set to true, then the results will not contain
   * any metadata that is marked as hidden.
   * @param param
   * @return results 
   */
  public SearchResultBean simpleSearch(ParameterBean param, String consumer) throws SQLException 
  {           
<span class="nc" id="L48">    SearchResultBean results = new SearchResultBean();</span>
<span class="nc" id="L49">    results.setShortRecords(null);</span>
<span class="nc" id="L50">    List metaIDs = new ArrayList();</span>
<span class="nc" id="L51">    Vector rows=null;</span>
<span class="nc" id="L52">    Row row = null;</span>
<span class="nc" id="L53">    String metadataId=&quot;&quot;; </span>
<span class="nc" id="L54">    ShortMetadataResultBean[] metadata = null;            </span>
<span class="nc" id="L55">    Connection conn = dataSource.getConnection();                   </span>
    try 
    { 
<span class="nc" id="L58">      rows = getQueryMetaID(param,consumer,conn);  </span>
      // get the MetadataID and set it to the ShortMetadataBean and ShortMetadataResultBean
<span class="nc bnc" id="L60" title="All 4 branches missed.">      if (rows != null &amp;&amp; rows.size() &gt; 0) </span>
      {
       // found matches...
<span class="nc" id="L63">        Iterator rowIterator = rows.iterator();     </span>
<span class="nc" id="L64">        metadata = new ShortMetadataResultBean[rows.size()];</span>
<span class="nc" id="L65">        int i=0;                 </span>
<span class="nc bnc" id="L66" title="All 4 branches missed.">        while (rowIterator.hasNext()&amp;&amp; i &lt; metadata.length) </span>
        {
<span class="nc" id="L68">          row = (Row) rowIterator.next();</span>
          try 
          {
<span class="nc" id="L71">            metadataId = row.getString(&quot;MetadataID&quot;);</span>
<span class="nc" id="L72">            metaIDs.add(metadataId);</span>
<span class="nc" id="L73">            ShortMetadataBean shortMetadata=new ShortMetadataBean();</span>
<span class="nc" id="L74">            shortMetadata.setMetadataId(metadataId);</span>
<span class="nc" id="L75">            ShortMetadataResultBean smb = new ShortMetadataResultBean();</span>
<span class="nc" id="L76">            smb.setMetadataId(metadataId);                           </span>
<span class="nc" id="L77">            metadata[i]=smb;</span>
<span class="nc" id="L78">            i++;                   </span>
          }
<span class="nc" id="L80">          catch (NoSuchColumnException ex) </span>
          {
<span class="nc" id="L82">            throw new SQLException(ex.toString());</span>
<span class="nc" id="L83">          }</span>
        }
      }
<span class="nc" id="L86">      results.setShortRecords(metadata);</span>
<span class="nc" id="L87">      results.setMetaIDs(metaIDs);</span>
    }finally 
    {
      try 
      {
<span class="nc" id="L92">        conn.close();</span>
<span class="nc" id="L93">      } catch (SQLException ex) </span>
      {
      //ignore...
<span class="nc" id="L96">      }</span>
    }       
<span class="nc" id="L98">    return results;        </span>
  }
  /** Excute the SQL statement and return the set of rows  
    * @param param,conn
    * @return rows 
    */
  private Vector getQueryMetaID(ParameterBean param,String consumer,Connection conn)throws SQLException 
  {
<span class="nc" id="L106">    SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L107">    sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L108">    String sqls=makeSimpleQuery(param,consumer);</span>
<span class="nc" id="L109">    sqlCommandBean.setSqlValue(sqls);      </span>
<span class="nc" id="L110">    Vector rows = null;</span>
    try 
    {
<span class="nc" id="L113">      rows = sqlCommandBean.executeQuery();</span>
    }
<span class="nc" id="L115">    catch (UnsupportedTypeException e) </span>
    {
<span class="nc" id="L117">      throw new SQLException(e.toString());</span>
<span class="nc" id="L118">    } </span>
<span class="nc" id="L119">    return rows;</span>
  }      
  /**
   * This is the function that traverses through the ParameterBean passed from 
   * the search action page, and builds a single sql query from the 
   * information in the Bean. The query building process follows the following
   * steps: 1.Select MetadataID from each table
   *        2.UNION all the result
   *        3.If search more than one word, put the relation between each union.
   *          if relation is &quot;AND&quot;, put &quot;AND MetadataID IN&quot; between two words statement.
   *          if relation is &quot;OR&quot;, put &quot;AND MetadataID NOT IN&quot; between two statement.
   *          if relation is &quot;NOT&quot;, put &quot;UNION&quot; between two union statement.
   * @param param
   * @return String
   */
   /**
   * This method takes in a string and adds default connetives &quot;or&quot; into
   * necessary positions.
   */
  public String addDefaultConnectives(String query)
  {
<span class="nc" id="L140">    StringTokenizer tk=new StringTokenizer(query);</span>
<span class="nc" id="L141">    String previouskey=&quot;&quot;;</span>
    String key;
<span class="nc" id="L143">    StringBuffer buff=new StringBuffer();</span>
<span class="nc" id="L144">    boolean connect=false;    </span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">    while (tk.hasMoreTokens())</span>
    {
<span class="nc" id="L147">      key=tk.nextToken();</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">      if (key.compareTo(&quot;not&quot;)==0 || key.compareTo(&quot;or&quot;)==0 </span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">      || key.compareTo(&quot;and&quot;)==0)</span>
      {
<span class="nc" id="L151">        buff.append(key+&quot; &quot;);</span>
<span class="nc" id="L152">        previouskey=key;</span>
      }
<span class="nc bnc" id="L154" title="All 6 branches missed.">      else if (previouskey.compareTo(&quot;(&quot;)!=0 &amp;&amp; previouskey.compareTo(&quot;&quot;)!=0 &amp;&amp; key.compareTo(&quot;)&quot;)!=0</span>
<span class="nc bnc" id="L155" title="All 6 branches missed.">      &amp;&amp; previouskey.compareTo(&quot;not&quot;)!=0 &amp;&amp; previouskey.compareTo(&quot;and&quot;)!=0 &amp;&amp; previouskey.compareTo(&quot;or&quot;)!=0 )</span>
      {
<span class="nc" id="L157">        buff.append(&quot; and &quot;+key+&quot; &quot;);</span>
<span class="nc" id="L158">        previouskey=key;</span>
      }
      else
      {
<span class="nc" id="L162">        buff.append(key+&quot; &quot;);</span>
<span class="nc" id="L163">        previouskey=key;</span>
      }      
    }
<span class="nc" id="L166">    return buff.toString();</span>
  }
  /**
   * This method forms the query sentence for zero or one level of join. 
   * That is, for searches on metadata table and keyword tables. 
   * It assumes that query string is in the correct acceptance format:
   * keyword &quot; keyword AND keyword &quot; NOT ( keyword OR keyword )
   * The final sql statement should be in the following format:
   * SELECT metadataID FROM tablename WHERE column like '%keyword%' AND
   * metadatID IN (Select metadataID from tablename WHERE column like '%keyword%'
   * @param query
   * @param column
   * @param table
   * @return bf.toString()
   */
  public String buildCommonQuery(String query, String column, String table)
  {
<span class="nc" id="L183">    String origQuery=null;</span>
<span class="nc" id="L184">    origQuery=addDefaultConnectives(query);</span>
<span class="nc" id="L185">    StringTokenizer tk=new StringTokenizer(origQuery);</span>
<span class="nc" id="L186">    String searchKey=null;</span>
<span class="nc" id="L187">    StringBuffer bf=new StringBuffer();</span>
<span class="nc" id="L188">    boolean isNOT=false;</span>
<span class="nc" id="L189">    boolean isOR=false;</span>
<span class="nc" id="L190">    boolean isAND=false;</span>
<span class="nc" id="L191">    boolean isFirst=true;</span>
<span class="nc" id="L192">    boolean isExact=false;</span>
<span class="nc" id="L193">    bf.append(&quot;SELECT &quot;+table+&quot;.metadataID from &quot;+table+&quot; WHERE &quot;);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">    while (tk.hasMoreTokens())</span>
    {
<span class="nc" id="L196">      searchKey=tk.nextToken();</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">      if (searchKey.compareTo(&quot;\&quot;&quot;)==0)</span>
      {
<span class="nc" id="L199">        StringBuffer exact=new StringBuffer();</span>
<span class="nc" id="L200">        searchKey=tk.nextToken();</span>
<span class="nc bnc" id="L201" title="All 4 branches missed.">        while(tk.hasMoreTokens() &amp;&amp; searchKey.compareTo(&quot;\&quot;&quot;)!=0)</span>
        {
<span class="nc" id="L203">          exact.append(searchKey+&quot; &quot;);</span>
<span class="nc" id="L204">          searchKey=tk.nextToken();</span>
        }
<span class="nc" id="L206">        searchKey=exact.toString();</span>
<span class="nc" id="L207">        searchKey=searchKey.trim();</span>
<span class="nc" id="L208">        isExact=true;</span>
      }
<span class="nc bnc" id="L210" title="All 4 branches missed.">      if (searchKey.compareTo(&quot;(&quot;)==0 || searchKey.compareTo(&quot;)&quot;)==0)</span>
      {
<span class="nc" id="L212">           bf.append(searchKey+&quot; &quot;);  </span>
      }
<span class="nc bnc" id="L214" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;or&quot;)==0)</span>
      {
<span class="nc" id="L216">         bf.append(searchKey+&quot; &quot;);</span>
<span class="nc" id="L217">         isOR=true;</span>
      }
<span class="nc bnc" id="L219" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;not&quot;)==0)</span>
      {
<span class="nc" id="L221">        bf.append(&quot; AND Metadata.metadataID NOT IN (SELECT &quot;+table+&quot;.MetadataID from &quot;+table+&quot; where &quot;);</span>
<span class="nc" id="L222">        isNOT=true;</span>
      }
<span class="nc bnc" id="L224" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;and&quot;)==0)</span>
      {
<span class="nc" id="L226">        bf.append(&quot; AND Metadata.metadataID IN (SELECT &quot;+table+&quot;.MetadataID from &quot;+table+&quot; where &quot;);</span>
<span class="nc" id="L227">        isAND=true;</span>
      }
      else 
      {
<span class="nc bnc" id="L231" title="All 4 branches missed.">        if (isAND || isNOT)</span>
        {
<span class="nc bnc" id="L233" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L235">            bf.append(column+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +column+&quot; like '% &quot;+searchKey+&quot;%' )&quot;);</span>
          }
          else
          {
<span class="nc" id="L239">             bf.append(column+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+column+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+column+&quot; like '%&quot;+searchKey+&quot; %')&quot;); </span>
          }
<span class="nc" id="L241">          isAND=false; isNOT=false; isFirst=false; isExact=false;</span>
        }
<span class="nc bnc" id="L243" title="All 4 branches missed.">        else if (isOR || isFirst)</span>
        {
<span class="nc bnc" id="L245" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L247">            bf.append(column+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +column+&quot; like '% &quot;+searchKey+&quot;%' &quot;);</span>
          }
          else
          {
<span class="nc" id="L251">             bf.append(column+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+column+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+column+&quot; like '%&quot;+searchKey+&quot; %'&quot;); </span>
          }
<span class="nc" id="L253">          isFirst=false; isOR=false; isExact=false;</span>
        }
        else
        {
<span class="nc bnc" id="L257" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L259">              bf.append(&quot; AND Metadata.metadataID IN (SELECT Metadata.MetadataID from metadata where &quot;+column+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +column+&quot; like '% &quot;+searchKey+&quot;%' )&quot;);</span>
          }
          else
          {
<span class="nc" id="L263">            bf.append(&quot; AND Metadata.metadataID IN (SELECT Metadata.MetadataID from metadata where &quot;+column+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+column+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+column+&quot; like '%&quot;+searchKey+&quot; %')&quot;);</span>
          }
<span class="nc" id="L265">          isAND=false; isFirst=false; isExact=false;</span>
        }
      }
    }
<span class="nc" id="L269">    return bf.toString();</span>
  }
  public String buildMutiQuery(String query, String column, String table, String subTable, String subColumn)
  {
<span class="nc" id="L273">    String origQuery=null;</span>
<span class="nc" id="L274">    origQuery=addDefaultConnectives(query);</span>
<span class="nc" id="L275">    StringTokenizer tk=new StringTokenizer(origQuery);</span>
<span class="nc" id="L276">    String searchKey=null;</span>
<span class="nc" id="L277">    StringBuffer bf=new StringBuffer();</span>
<span class="nc" id="L278">    boolean isNOT=false;</span>
<span class="nc" id="L279">    boolean isOR=false;</span>
<span class="nc" id="L280">    boolean isAND=false;</span>
<span class="nc" id="L281">    boolean isFirst=true;</span>
<span class="nc" id="L282">    boolean isExact=false;</span>
<span class="nc" id="L283">    bf.append(&quot;SELECT &quot;+table+&quot;.metadataID from &quot;+table+&quot; WHERE &quot;+column+&quot; IN (Select &quot;+column+&quot; from &quot;+subTable+&quot; WHERE &quot;);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">    while (tk.hasMoreTokens())</span>
    {
<span class="nc" id="L286">      searchKey=tk.nextToken();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">      if (searchKey.compareTo(&quot;\&quot;&quot;)==0)</span>
      {
<span class="nc" id="L289">        StringBuffer exact=new StringBuffer();</span>
<span class="nc" id="L290">        searchKey=tk.nextToken();</span>
<span class="nc bnc" id="L291" title="All 4 branches missed.">        while(tk.hasMoreTokens() &amp;&amp; searchKey.compareTo(&quot;\&quot;&quot;)!=0)</span>
        {
<span class="nc" id="L293">          exact.append(searchKey+&quot; &quot;);</span>
<span class="nc" id="L294">          searchKey=tk.nextToken();</span>
        }
<span class="nc" id="L296">        searchKey=exact.toString();</span>
<span class="nc" id="L297">        searchKey=searchKey.trim();</span>
<span class="nc" id="L298">        isExact=true;</span>
      }
<span class="nc bnc" id="L300" title="All 4 branches missed.">      if (searchKey.compareTo(&quot;(&quot;)==0 || searchKey.compareTo(&quot;)&quot;)==0)</span>
      {
<span class="nc" id="L302">        bf.append(searchKey+&quot; &quot;);</span>
      }
<span class="nc bnc" id="L304" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;or&quot;)==0)</span>
      {
<span class="nc" id="L306">        bf.append(searchKey+&quot; &quot;);</span>
<span class="nc" id="L307">        isOR=true;</span>
      }
<span class="nc bnc" id="L309" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;not&quot;)==0)</span>
      {
<span class="nc" id="L311">        bf.append(&quot; AND &quot;+column+&quot; NOT IN (SELECT &quot;+column+&quot; FROM &quot;+subTable+&quot; WHERE &quot;);</span>
<span class="nc" id="L312">        isNOT=true;</span>
      }
<span class="nc bnc" id="L314" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;and&quot;)==0)</span>
      {
<span class="nc" id="L316">        bf.append(&quot; AND &quot;+column+&quot; IN (SELECT &quot;+column+&quot; FROM &quot;+subTable+&quot; WHERE &quot;);</span>
<span class="nc" id="L317">        isAND=true;</span>
      }
      else 
      {
<span class="nc bnc" id="L321" title="All 4 branches missed.">        if (isAND || isNOT)</span>
        {
<span class="nc bnc" id="L323" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L325">            bf.append(subColumn+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +subColumn+&quot; like '% &quot;+searchKey+&quot;%' )&quot;);</span>
          }
          else
          {
<span class="nc" id="L329">            bf.append(subColumn+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot; %')&quot;);</span>
          }
<span class="nc" id="L331">          isAND=false; isNOT=false; isExact=false;</span>
        }
<span class="nc bnc" id="L333" title="All 4 branches missed.">        else if (isOR || isFirst)</span>
        {
<span class="nc bnc" id="L335" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L337">            bf.append(subColumn+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +subColumn+&quot; like '% &quot;+searchKey+&quot;%' &quot;);</span>
          }
          else
          {
<span class="nc" id="L341">            bf.append(subColumn+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot; %' &quot;);</span>
          }
<span class="nc" id="L343">          isFirst=false; isOR=false; isExact=false;</span>
        }
        else
        {
<span class="nc bnc" id="L347" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L349">            bf.append(&quot; AND &quot;+column+&quot; IN (SELECT &quot;+column+&quot; FROM &quot;+subTable+&quot; WHERE &quot;+subColumn+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +subColumn+&quot; like '% &quot;+searchKey+&quot;%' )&quot;);</span>
          }
          else
          {
<span class="nc" id="L353">            bf.append(&quot; AND &quot;+column+&quot; IN (SELECT &quot;+column+&quot; FROM &quot;+subTable+&quot; WHERE &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot; %')&quot;);</span>
          }
        }
      }
    }
<span class="nc" id="L358">    bf.append(&quot;)&quot;);</span>
<span class="nc" id="L359">    return bf.toString();</span>
  }  
  public String makeSimpleQuery(ParameterBean param, String consumer)
  { 
<span class="nc" id="L363">    StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L364">    boolean exact=false;</span>
<span class="nc" id="L365">    String relat=null; //stores the AND, OR relation</span>
<span class="nc" id="L366">    int i=0; //counter</span>
  
<span class="nc" id="L368">    sql.append(&quot;select distinct(Metadata.metadataID), Title FROM Metadata WHERE &quot;);</span>
<span class="nc" id="L369">    sql.append (&quot;(Metadata.CatalogDate IS NOT NULL AND Metadata.ApproveDate IS NOT NULL AND &quot;);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">    if (param.getHidden()==false)</span>
    {
<span class="nc" id="L372">      sql.append(&quot; Metadata.Private='0'&quot;);</span>
    }
<span class="nc bnc" id="L374" title="All 2 branches missed.">    if (param.getUsageRight() == null) {</span>
<span class="nc" id="L375">      sql.append(&quot; AND Metadata.SourceCollection &lt;&gt; 'PEIR - University of Alabama at Birmingham Department of Radiology' AND Metadata.SourceCollection&lt;&gt; 'PEIR - University of Alabama at Birmingham Department of Pathology'&quot;);</span>
    }
<span class="nc bnc" id="L377" title="All 2 branches missed.">    if(consumer == null){</span>
<span class="nc" id="L378">      sql.append(&quot; AND Metadata.MetadataID NOT IN (select MetadataID from TargetUserGroups where (TargetUserGroup = 'Consumer Health/Patient Education' or TargetUserGroup = 'K-12'))&quot;); </span>
    }
    
<span class="nc" id="L381">    sql.append(&quot;) \n&quot;);</span>
<span class="nc" id="L382">    String start=sql.toString();</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">    for (i=0; i&lt;param.size(); i++)</span>
    {
<span class="nc" id="L385">      ParameterNode tempNode=param.getParameters(i);</span>
<span class="nc" id="L386">      String key=tempNode.getKeyWord();</span>
<span class="nc" id="L387">      relat=tempNode.getRelation();</span>
<span class="nc" id="L388">      exact=tempNode.getExact(); </span>
<span class="nc bnc" id="L389" title="All 4 branches missed.">      if (relat.compareTo(&quot;AND&quot;)==0 || relat.compareTo(&quot;&quot;)==0) //if AND or OR relation</span>
      {
<span class="nc" id="L391">        sql.append(&quot;AND Metadata.MetadataID IN \n&quot;);</span>
      }
<span class="nc bnc" id="L393" title="All 2 branches missed.">      else if (relat.compareTo(&quot;NOT&quot;)==0)</span>
      {
<span class="nc" id="L395">        sql.append(&quot;AND Metadata.MetadataID NOT IN \n&quot;);</span>
      }
<span class="nc bnc" id="L397" title="All 2 branches missed.">      else if (relat.compareTo(&quot;OR&quot;)==0)</span>
      {
<span class="nc" id="L399">        sql.append(&quot;UNION \n&quot;+start+&quot;AND Metadata.MetadataID IN \n &quot;);</span>
      }        
<span class="nc bnc" id="L401" title="All 2 branches missed.">      if (!exact)</span>
      {
<span class="nc" id="L403">        sql.append(&quot;(&quot;+buildCommonQuery(key, &quot;title&quot;, &quot;Metadata&quot;));</span>
<span class="nc" id="L404">          sql.append(&quot;\nUNION &quot;+buildCommonQuery(key, &quot;description&quot;, &quot;Metadata&quot;)); </span>
<span class="nc" id="L405">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;SourceCollection&quot;, &quot;Metadata&quot;));</span>
<span class="nc" id="L406">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;metadataID&quot;, &quot;Metadata&quot;));</span>
<span class="nc" id="L407">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;LearningResourceType&quot;, &quot;Metadata&quot;));</span>
<span class="nc" id="L408">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;keyword&quot;, &quot;Keywords&quot;));</span>
<span class="nc" id="L409">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;tag&quot;, &quot;Tags&quot;));          </span>
<span class="nc" id="L410">          sql.append(&quot; \nUNION &quot;+buildMutiQuery(key, &quot;CopyrightTextID&quot;, &quot;CopyRights&quot;, &quot;CopyrightTexts&quot;, &quot;CopyrightText&quot;));</span>
<span class="nc" id="L411">          sql.append(&quot; \nUNION &quot;+buildMutiQuery(key, &quot;TaxonPathID&quot;, &quot;TaxonPaths&quot;, &quot;Taxons&quot;, &quot;Entry&quot;));</span>
<span class="nc" id="L412">          sql.append(&quot; \nUNION &quot;+buildMutiQuery(key, &quot;vcardID&quot;, &quot;Contributors&quot;, &quot;Vcards&quot;, &quot;vcard&quot;));</span>
<span class="nc" id="L413">          sql.append(&quot; \nUNION &quot;+buildMutiQuery(key, &quot;vcardID&quot;, &quot;CopyrightHolders&quot;, &quot;Vcards&quot;, &quot;vcard&quot;));</span>
<span class="nc" id="L414">          sql.append(&quot;)\n&quot;);</span>
      }
      else //if it is exact search
      {
<span class="nc" id="L418">        sql.append(&quot; (Select Metadata.MetadataID from Metadata where&quot;); </span>
<span class="nc" id="L419">        sql.append(&quot; (title like '&quot;+key+&quot;' OR title like '% &quot;+key+&quot; %' OR title like '&quot;+key+&quot; %' OR title like '% &quot;+key+&quot;' OR title like '% &quot;+key+&quot;.%' OR title like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L420">        sql.append(&quot;OR description like '&quot;+key+&quot;' OR description like '% &quot;+key+&quot; %' OR description like '&quot;+key+&quot; %' OR description like '% &quot;+key+&quot;' OR description like '% &quot;+key+&quot;.%' OR description like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L421">        sql.append(&quot;OR SourceCollection like '&quot;+key+&quot;' OR SourceCollection like '% &quot;+key+&quot; %' OR SourceCollection like '% &quot;+key+&quot;' OR SourceCollection like '&quot;+key+&quot; %' OR SourceCollection like '% &quot;+key+&quot;.%' OR SourceCollection like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L422">        sql.append(&quot;OR LearningResourceType like '&quot;+key+&quot;' OR LearningResourceType like '% &quot;+key+&quot; %' OR LearningResourceType like '% &quot;+key+&quot;' OR LearningResourceType like '&quot;+key+&quot; %' OR LearningResourceType like '% &quot;+key+&quot;.%' OR LearningResourceType like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L423">        sql.append(&quot;OR metadataID like '&quot;+key+&quot;' )\n&quot;);</span>
<span class="nc" id="L424">        sql.append(&quot;UNION Select keywords.metadataID FROM keywords where keyword like '&quot;+key+&quot;' OR keyword LIKE '% &quot;+key+&quot; %' OR keyword like '&quot;+key+&quot; %' OR keyword like '% &quot;+key+&quot;' OR keyword like '% &quot;+key+&quot;.%' OR keyword like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L425">        sql.append(&quot;UNION Select Copyrights.metadataID from Copyrights WHERE copyrightTextID IN (Select copyrightTextID from CopyrightTexts WHERE &quot;);</span>
<span class="nc" id="L426">        sql.append(&quot;copyrightText like '&quot;+key+&quot;' OR copyrightText LIKE '% &quot;+key+&quot; %' OR copyrightText like '&quot;+key+&quot; %' OR copyrightText like '% &quot;+key+&quot;' OR copyrightText like '% &quot;+key+&quot;.%')\n&quot;);</span>
      //  sql.append(&quot;UNION Select TaxonPaths.metadataID from TaxonPaths where taxonpathid in (select taxonpathid from taxons where &quot;);
      //  sql.append(&quot;Entry like '&quot;+key+&quot;' OR Entry LIKE '% &quot;+key+&quot; %' OR Entry like '&quot;+key+&quot; %' OR Entry like '% &quot;+key+&quot;' OR Entry like '% &quot;+key+&quot;.%' OR Entry like '% &quot;+key+&quot;,%')\n&quot;);
<span class="nc" id="L429">        sql.append(&quot;UNION select copyrightHolders.metadataID from copyrightHolders where vcardID in (select vcardID from vcards where &quot;);</span>
<span class="nc" id="L430">        sql.append(&quot;vCard like '&quot;+key+&quot;' OR vCard LIKE '% &quot;+key+&quot; %' OR vCard like '&quot;+key+&quot; %' OR vCard like '% &quot;+key+&quot;' OR vCard like '% &quot;+key+&quot;.%' OR vCard like '% &quot;+key+&quot;,%')\n&quot;);</span>
<span class="nc" id="L431">        sql.append(&quot;UNION select Contributors.metadataID from Contributors where vcardID in (select vcardID from vcards where &quot;);</span>
<span class="nc" id="L432">        sql.append(&quot;vCard like '&quot;+key+&quot;' OR vCard LIKE '% &quot;+key+&quot; %' OR vCard like '&quot;+key+&quot; %' OR vCard like '% &quot;+key+&quot;' OR vCard like '% &quot;+key+&quot;.%' OR vCard like '% &quot;+key+&quot;,%') )\n&quot;);        </span>
      }
    }
<span class="nc" id="L435">    sql.append(&quot; order by Title&quot;);</span>
<span class="nc" id="L436">    String output=sql.toString();</span>
<span class="nc" id="L437">    System.out.println(output);</span>
<span class="nc" id="L438">    return output;    </span>
  }    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>