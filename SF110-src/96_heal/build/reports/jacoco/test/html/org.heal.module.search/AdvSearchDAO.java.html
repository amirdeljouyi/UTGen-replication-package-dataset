<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdvSearchDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.module.search</a> &gt; <span class="el_source">AdvSearchDAO.java</span></div><h1>AdvSearchDAO.java</h1><pre class="source lang-java linenums">package org.heal.module.search;

import com.ora.jsp.sql.NoSuchColumnException;
import com.ora.jsp.sql.Row;
import com.ora.jsp.sql.SQLCommandBean;
import com.ora.jsp.sql.UnsupportedTypeException;
import org.heal.module.metadata.ShortMetadataBean;
import javax.sql.DataSource;
import java.io.Serializable;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.*;

/**
 * @author Grace/Julie
 * @version 0.1
 */

public class AdvSearchDAO implements Serializable 
{
  public AdvSearchDAO() 
<span class="nc" id="L22">  {</span>
<span class="nc" id="L23">  }</span>
	private DataSource dataSource;
	/**
	 * Sets the dataSource property value.
	 */
	public void setDataSource(DataSource dataSource) 
  {
<span class="nc" id="L30">		this.dataSource = dataSource;</span>
<span class="nc" id="L31">	}</span>
	/**
	 * Given a set of parameters and a list of filters, performs a search
	 * for all metadata that match all of the criteria set out in the
	 * parameters and also have a format in the presented list.
	 * The results are returned in a SearchResultBean.
	 * It should be noted that unless a metadata matches _ALL_ of the
	 * parameters laid out in the search paremters, it will not be in the
	 * result set.
	 *
	 * @param param
	 *
	 * @return results
	 */
	public SearchResultBean AdvSearch(ParameterBean param) throws SQLException 
  {
<span class="nc" id="L47">		SearchResultBean results = new SearchResultBean();</span>
<span class="nc" id="L48">		Connection conn = dataSource.getConnection();</span>
		try {
<span class="nc" id="L50">			List metaIDs = new ArrayList();</span>
<span class="nc" id="L51">			Vector rows = getQueryMetaID(param, conn);</span>
<span class="nc" id="L52">			ShortMetadataResultBean[] metadata = null;</span>
			// get the MetadataID and set it to the ShortMetadataBean and ShortMetadataResultBean
<span class="nc bnc" id="L54" title="All 4 branches missed.">			if(rows != null &amp;&amp; rows.size() &gt; 0) {</span>
				// found matches...
<span class="nc" id="L56">				metadata = new ShortMetadataResultBean[rows.size()];</span>
<span class="nc" id="L57">				int currentRowIndex = 0;</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">				for(Iterator rowIterator = rows.iterator(); rowIterator.hasNext();) {</span>
<span class="nc" id="L59">					Row row = (Row)rowIterator.next();</span>
					try {
<span class="nc" id="L61">						String metadataId = row.getString(&quot;ID&quot;);</span>
<span class="nc" id="L62">						metaIDs.add(metadataId);</span>
<span class="nc" id="L63">						ShortMetadataBean shortMetadata = new ShortMetadataBean();</span>
<span class="nc" id="L64">						shortMetadata.setMetadataId(metadataId);</span>
<span class="nc" id="L65">						ShortMetadataResultBean smb = new ShortMetadataResultBean();</span>
<span class="nc" id="L66">						smb.setMetadataId(metadataId);</span>
<span class="nc" id="L67">						metadata[currentRowIndex] = smb;</span>
<span class="nc" id="L68">						currentRowIndex++;</span>
<span class="nc" id="L69">					} catch(NoSuchColumnException ex) {</span>
<span class="nc" id="L70">						throw new SQLException(ex.toString());</span>
<span class="nc" id="L71">					}</span>
<span class="nc" id="L72">				}</span>
			}
<span class="nc" id="L74">			results.setShortRecords(metadata);</span>
<span class="nc" id="L75">			results.setMetaIDs(metaIDs);</span>
		} finally {
			try {
<span class="nc" id="L78">				conn.close();</span>
<span class="nc" id="L79">			} catch(SQLException ex) {</span>
				//ignore...
<span class="nc" id="L81">			}</span>
		}
<span class="nc" id="L83">		return results;</span>
	}
	/**
	 * Excute the SQL statement and return the set of rows
	 *
	 * @param param
	 * @param conn
	 *
	 * @return rows
	 */
	private Vector getQueryMetaID(ParameterBean param, Connection conn) throws SQLException 
  {
<span class="nc" id="L95">		SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L96">		sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L97">		String sqls = makeQuery(param);</span>
<span class="nc" id="L98">		sqlCommandBean.setSqlValue(sqls);</span>
		Vector rows;
		try 
    {
<span class="nc" id="L102">			rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L103">		} catch(UnsupportedTypeException e) </span>
    {
<span class="nc" id="L105">			throw new SQLException(e.toString());</span>
<span class="nc" id="L106">		}</span>
<span class="nc" id="L107">		return rows;</span>
	}
  /**
   * This method takes in a string and adds default connetives &quot;or&quot; into
   * necessary positions.
   */
  public String addDefaultConnectives(String query)
  {
    //System.out.println(query);
<span class="nc" id="L116">    StringTokenizer tk=new StringTokenizer(query);</span>
<span class="nc" id="L117">    String previouskey=&quot;&quot;;</span>
    String key;
<span class="nc" id="L119">    StringBuffer buff=new StringBuffer();</span>
<span class="nc" id="L120">    boolean connect=false;    </span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">    while (tk.hasMoreTokens())</span>
    {
<span class="nc" id="L123">      key=tk.nextToken();</span>
<span class="nc bnc" id="L124" title="All 4 branches missed.">      if (key.compareTo(&quot;not&quot;)==0 || key.compareTo(&quot;or&quot;)==0 </span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">      || key.compareTo(&quot;and&quot;)==0)</span>
      {
<span class="nc" id="L127">        buff.append(key+&quot; &quot;);</span>
<span class="nc" id="L128">        previouskey=key;</span>
      }
<span class="nc bnc" id="L130" title="All 6 branches missed.">      else if (previouskey.compareTo(&quot;(&quot;)!=0 &amp;&amp; previouskey.compareTo(&quot;&quot;)!=0 &amp;&amp; key.compareTo(&quot;)&quot;)!=0</span>
<span class="nc bnc" id="L131" title="All 6 branches missed.">      &amp;&amp; previouskey.compareTo(&quot;not&quot;)!=0 &amp;&amp; previouskey.compareTo(&quot;and&quot;)!=0 &amp;&amp; previouskey.compareTo(&quot;or&quot;)!=0 )</span>
      {
<span class="nc" id="L133">        buff.append(&quot; and &quot;+key+&quot; &quot;);</span>
<span class="nc" id="L134">        previouskey=key;</span>
      }
      else
      {
<span class="nc" id="L138">        buff.append(key+&quot; &quot;);</span>
<span class="nc" id="L139">        previouskey=key;</span>
      }      
    }
<span class="nc" id="L142">    return buff.toString();</span>
  }
  /**
   * This method forms the query sentence for zero or one level of join. 
   * That is, for searches on metadata table and keyword tables. 
   * It assumes that query string is in the correct acceptance format:
   * keyword &quot; keyword AND keyword &quot; NOT ( keyword OR keyword )
   * The final sql statement should be in the following format:
   * SELECT metadataID FROM tablename WHERE column like '%keyword%' AND
   * metadatID IN (Select metadataID from tablename WHERE column like '%keyword%'
   * @param query
   * @param column
   * @param table
   * @return bf.toString()
   */
  public String buildCommonQuery(String query, String column, String table)
  {
<span class="nc" id="L159">    String origQuery=null;</span>
<span class="nc" id="L160">    origQuery=addDefaultConnectives(query);</span>
<span class="nc" id="L161">    StringTokenizer tk=new StringTokenizer(origQuery);</span>
<span class="nc" id="L162">    String searchKey=null;</span>
<span class="nc" id="L163">    StringBuffer bf=new StringBuffer();</span>
<span class="nc" id="L164">    boolean isNOT=false;</span>
<span class="nc" id="L165">    boolean isOR=false;</span>
<span class="nc" id="L166">    boolean isAND=false;</span>
<span class="nc" id="L167">    boolean isFirst=true;</span>
<span class="nc" id="L168">    boolean isExact=false;</span>
<span class="nc" id="L169">    bf.append(&quot;SELECT &quot;+table+&quot;.metadataID from &quot;+table+&quot; WHERE &quot;);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">    while (tk.hasMoreTokens())</span>
    {
<span class="nc" id="L172">      searchKey=tk.nextToken();</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">      if (searchKey.compareTo(&quot;\&quot;&quot;)==0)</span>
      {
<span class="nc" id="L175">        StringBuffer exact=new StringBuffer();</span>
<span class="nc" id="L176">        searchKey=tk.nextToken();</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">        while(tk.hasMoreTokens() &amp;&amp; searchKey.compareTo(&quot;\&quot;&quot;)!=0)</span>
        {
<span class="nc" id="L179">          exact.append(searchKey+&quot; &quot;);</span>
<span class="nc" id="L180">          searchKey=tk.nextToken();</span>
        }
<span class="nc" id="L182">        searchKey=exact.toString();</span>
<span class="nc" id="L183">        searchKey=searchKey.trim();        </span>
<span class="nc" id="L184">        isExact=true;</span>
      }
<span class="nc bnc" id="L186" title="All 4 branches missed.">      if (searchKey.compareTo(&quot;(&quot;)==0 || searchKey.compareTo(&quot;)&quot;)==0)</span>
      {
<span class="nc" id="L188">           bf.append(searchKey+&quot; &quot;);  </span>
      }
<span class="nc bnc" id="L190" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;or&quot;)==0)</span>
      {
<span class="nc" id="L192">         bf.append(searchKey+&quot; &quot;);</span>
<span class="nc" id="L193">         isOR=true;</span>
      }
<span class="nc bnc" id="L195" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;not&quot;)==0)</span>
      {
<span class="nc" id="L197">        bf.append(&quot; AND Metadata.metadataID NOT IN (SELECT &quot;+table+&quot;.MetadataID from &quot;+table+&quot; where &quot;);</span>
<span class="nc" id="L198">        isNOT=true;</span>
      }
<span class="nc bnc" id="L200" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;and&quot;)==0)</span>
      {
<span class="nc" id="L202">        bf.append(&quot; AND Metadata.metadataID IN (SELECT &quot;+table+&quot;.MetadataID from &quot;+table+&quot; where &quot;);</span>
<span class="nc" id="L203">        isAND=true;</span>
      }
      else 
      {
<span class="nc bnc" id="L207" title="All 4 branches missed.">        if (isAND || isNOT)</span>
        {
<span class="nc bnc" id="L209" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L211">            bf.append(column+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +column+&quot; like '% &quot;+searchKey+&quot;%' )&quot;);</span>
          }
          else
          {
<span class="nc" id="L215">             bf.append(column+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+column+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+column+&quot; like '%&quot;+searchKey+&quot; %')&quot;); </span>
          }
<span class="nc" id="L217">          isAND=false; isNOT=false; isFirst=false; isExact=false;</span>
        }
<span class="nc bnc" id="L219" title="All 4 branches missed.">        else if (isOR || isFirst)</span>
        {
<span class="nc bnc" id="L221" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L223">            bf.append(column+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +column+&quot; like '% &quot;+searchKey+&quot;%' &quot;);</span>
          }
          else
          {
<span class="nc" id="L227">             bf.append(column+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+column+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+column+&quot; like '%&quot;+searchKey+&quot; %'&quot;); </span>
          }
<span class="nc" id="L229">          isFirst=false; isOR=false; isExact=false;</span>
        }
        else
        {
<span class="nc bnc" id="L233" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L235">              bf.append(&quot; AND Metadata.metadataID IN (SELECT Metadata.MetadataID from metadata where &quot;+column+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +column+&quot; like '% &quot;+searchKey+&quot;%' )&quot;);</span>
          }
          else
          {
<span class="nc" id="L239">            bf.append(&quot; AND Metadata.metadataID IN (SELECT Metadata.MetadataID from metadata where &quot;+column+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+column+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+column+&quot; like '%&quot;+searchKey+&quot; %')&quot;);</span>
          }
<span class="nc" id="L241">          isAND=false; isFirst=false; isExact=false;</span>
        }
      }
    }
    //System.out.println(bf.toString());
<span class="nc" id="L246">    return bf.toString();</span>
  }
  public String buildMutiQuery(String query, String column, String table, String subTable, String subColumn)
  {
<span class="nc" id="L250">    String origQuery=null;</span>
<span class="nc" id="L251">    origQuery=addDefaultConnectives(query);</span>
<span class="nc" id="L252">    StringTokenizer tk=new StringTokenizer(origQuery);</span>
<span class="nc" id="L253">    String searchKey=null;</span>
<span class="nc" id="L254">    StringBuffer bf=new StringBuffer();</span>
<span class="nc" id="L255">    boolean isNOT=false;</span>
<span class="nc" id="L256">    boolean isOR=false;</span>
<span class="nc" id="L257">    boolean isAND=false;</span>
<span class="nc" id="L258">    boolean isFirst=true;</span>
<span class="nc" id="L259">    boolean isExact=false;</span>
<span class="nc" id="L260">    bf.append(&quot;SELECT &quot;+table+&quot;.metadataID from &quot;+table+&quot; WHERE &quot;+column+&quot; IN (Select &quot;+column+&quot; from &quot;+subTable+&quot; WHERE &quot;);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">    while (tk.hasMoreTokens())</span>
    {
<span class="nc" id="L263">      searchKey=tk.nextToken();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">      if (searchKey.compareTo(&quot;\&quot;&quot;)==0)</span>
      {
<span class="nc" id="L266">        StringBuffer exact=new StringBuffer();</span>
<span class="nc" id="L267">        searchKey=tk.nextToken();</span>
<span class="nc bnc" id="L268" title="All 4 branches missed.">        while(tk.hasMoreTokens() &amp;&amp; searchKey.compareTo(&quot;\&quot;&quot;)!=0)</span>
        {
<span class="nc" id="L270">          exact.append(searchKey+&quot; &quot;);</span>
<span class="nc" id="L271">          searchKey=tk.nextToken();</span>
        }
<span class="nc" id="L273">        searchKey=exact.toString();</span>
<span class="nc" id="L274">        searchKey=searchKey.trim();</span>
<span class="nc" id="L275">        isExact=true;</span>
      }
<span class="nc bnc" id="L277" title="All 4 branches missed.">      if (searchKey.compareTo(&quot;(&quot;)==0 || searchKey.compareTo(&quot;)&quot;)==0)</span>
      {
<span class="nc" id="L279">        bf.append(searchKey+&quot; &quot;);</span>
      }
<span class="nc bnc" id="L281" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;or&quot;)==0)</span>
      {
<span class="nc" id="L283">        bf.append(searchKey+&quot; &quot;);</span>
<span class="nc" id="L284">        isOR=true;</span>
      }
<span class="nc bnc" id="L286" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;not&quot;)==0)</span>
      {
<span class="nc" id="L288">        bf.append(&quot; AND &quot;+column+&quot; NOT IN (SELECT &quot;+column+&quot; FROM &quot;+subTable+&quot; WHERE &quot;);</span>
<span class="nc" id="L289">        isNOT=true;</span>
      }
<span class="nc bnc" id="L291" title="All 2 branches missed.">      else if (searchKey.compareTo(&quot;and&quot;)==0)</span>
      {
<span class="nc" id="L293">        bf.append(&quot; AND &quot;+column+&quot; IN (SELECT &quot;+column+&quot; FROM &quot;+subTable+&quot; WHERE &quot;);</span>
<span class="nc" id="L294">        isAND=true;</span>
      }
      else 
      {
<span class="nc bnc" id="L298" title="All 4 branches missed.">        if (isAND || isNOT)</span>
        {
<span class="nc bnc" id="L300" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L302">            bf.append(subColumn+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +subColumn+&quot; like '% &quot;+searchKey+&quot;%' )&quot;);</span>
          }
          else
          {
<span class="nc" id="L306">            bf.append(subColumn+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot; %')&quot;);</span>
          }
<span class="nc" id="L308">          isAND=false; isNOT=false; isExact=false;</span>
        }
<span class="nc bnc" id="L310" title="All 4 branches missed.">        else if (isOR || isFirst)</span>
        {
<span class="nc bnc" id="L312" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L314">            bf.append(subColumn+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +subColumn+&quot; like '% &quot;+searchKey+&quot;%' &quot;);</span>
          }
          else
          {
<span class="nc" id="L318">            bf.append(subColumn+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot; %' &quot;);</span>
          }
<span class="nc" id="L320">          isFirst=false; isOR=false; isExact=false;</span>
        }
        else
        {
<span class="nc bnc" id="L324" title="All 2 branches missed.">          if (!isExact)</span>
          {
<span class="nc" id="L326">            bf.append(&quot; AND &quot;+column+&quot; IN (SELECT &quot;+column+&quot; FROM &quot;+subTable+&quot; WHERE &quot;+subColumn+&quot; like '&quot;+searchKey+ &quot;%' OR &quot; +subColumn+&quot; like '% &quot;+searchKey+&quot;%' )&quot;);</span>
          }
          else
          {
<span class="nc" id="L330">            bf.append(&quot; AND &quot;+column+&quot; IN (SELECT &quot;+column+&quot; FROM &quot;+subTable+&quot; WHERE &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot; %' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot;%' OR &quot;+subColumn+&quot; like '% &quot;+searchKey+&quot; %')&quot;);</span>
          }
        }
      }
    }
<span class="nc" id="L335">    bf.append(&quot;)&quot;);</span>
    //System.out.println(bf.toString());
<span class="nc" id="L337">    return bf.toString();</span>
  }  
  public String getMultiSelection(String[] values, String column)
  {
<span class="nc" id="L341">    StringBuffer buffer=new StringBuffer();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">    for(int i=0; i&lt;values.length; i++)</span>
    {
<span class="nc bnc" id="L344" title="All 2 branches missed.">      if(i==0)</span>
      {
<span class="nc" id="L346">        buffer.append(column+&quot; like '%&quot;+values[i]+&quot;%' &quot;);</span>
      }
      else
      {
<span class="nc" id="L350">        buffer.append(&quot;OR &quot;+column+&quot; like '%&quot;+values[i]+&quot;%' &quot;);</span>
      }                 
    }
<span class="nc" id="L353">    return buffer.toString();</span>
  }
  /**
   * This is the function that traverses through the ParameterBean passed from 
   * the advanced search action page, and builds a single sql query from the 
   * information in the Bean. for OR relation, the function uses UNION to
   * combine the select statements, for AND relation, the funcion uses
   * &quot;and metadataid in&quot; statement. For the multi-selection and drop down windows
   * that has fixed AND relation, they are parsed before the boolean keyword
   * selections, and the results will be attached at the begining for every 
   * Union boolean relation.
   * @param param
   * @return String
   */
  public String makeQuery(ParameterBean param)
  { 
<span class="nc" id="L369">    String[] filter=param.getFilterArray();</span>
<span class="nc" id="L370">    String[] source=param.getSourceCollection();</span>
<span class="nc" id="L371">    String[] publicationNames = param.getPublicationNames();</span>
<span class="nc" id="L372">    String[] publicationIds = param.getPublicationIds();</span>
    //String[] rights=param.getRightsArray();
<span class="nc" id="L374">    String[] primary=param.getPrimaryArray();</span>
<span class="nc" id="L375">    String[] imaging = param.getImaging();</span>
<span class="nc" id="L376">    String[] diseasep = param.getDisease();     </span>
<span class="nc" id="L377">    String relat=null; //stores the AND, OR relation</span>
<span class="nc" id="L378">    String in_relat=null; //stores relation segments needed in the query</span>
    String start; //stores the begining select statements and multi-selection
                  //conditions needed at the begining of the query and
                  //at the begining of every Union selection
<span class="nc" id="L382">    int i=0; //counter</span>
<span class="nc" id="L383">    StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L384">    StringBuffer union=new StringBuffer();</span>
<span class="nc" id="L385">    sql.append(&quot;select distinct(Metadata.metadataID) AS ID, Title FROM Metadata WHERE &quot;);</span>
<span class="nc" id="L386">    sql.append (&quot;(Metadata.CatalogDate IS NOT NULL AND Metadata.ApproveDate IS NOT NULL AND &quot;);      </span>
<span class="nc bnc" id="L387" title="All 2 branches missed.">    if (param.getHidden()==false)</span>
    {
<span class="nc" id="L389">      sql.append(&quot; Metadata.Private='0'&quot;);</span>
    }
<span class="nc" id="L391">    sql.append(&quot;) \n&quot;); </span>
<span class="nc bnc" id="L392" title="All 4 branches missed.">    if (filter!=null &amp;&amp; (filter[0].compareTo(&quot;all&quot;)!=0))</span>
    {                 
<span class="nc" id="L394">      sql.append(&quot; AND (&quot;);</span>
<span class="nc" id="L395">			sql.append(&quot; &quot;+getMultiSelection(filter, &quot;LearningResourceType&quot;));</span>
<span class="nc" id="L396">			sql.append(&quot;)\n&quot;);                              </span>
    }
<span class="nc bnc" id="L398" title="All 4 branches missed.">    if(imaging != null &amp;&amp; imaging[0].compareTo(&quot;all&quot;)!=0) </span>
    {
<span class="nc" id="L400">      sql.append(&quot; AND (&quot;);</span>
<span class="nc" id="L401">			sql.append(&quot; &quot;+getMultiSelection(imaging, &quot;RadiographType&quot;));</span>
<span class="nc" id="L402">			sql.append(&quot;)\n&quot;);</span>
		}
<span class="nc bnc" id="L404" title="All 4 branches missed.">    if(diseasep != null &amp;&amp; diseasep[0].compareTo(&quot;all&quot;)!=0) </span>
    {
<span class="nc" id="L406">			sql.append(&quot; AND (&quot;);</span>
<span class="nc" id="L407">			sql.append(&quot; &quot;+getMultiSelection(diseasep, &quot;DiseaseProcess&quot;));</span>
<span class="nc" id="L408">			sql.append(&quot;)\n&quot;);</span>
		}
    //parse out the multi-selection arrays, and combine them into the query
<span class="nc bnc" id="L411" title="All 4 branches missed.">    if(source!=null &amp;&amp; source[0].compareTo(&quot;all&quot;)!=0)</span>
    {
<span class="nc" id="L413">      sql.append(&quot; AND (&quot;);</span>
<span class="nc" id="L414">      sql.append(&quot; &quot;+getMultiSelection(source, &quot;SourceCollection&quot;));</span>
<span class="nc" id="L415">      sql.append(&quot; )\n&quot;);</span>
    }
<span class="nc bnc" id="L417" title="All 4 branches missed.">    if(null != publicationNames &amp;&amp; !&quot;all&quot;.equals(publicationNames[0])) </span>
    {
<span class="nc" id="L419">      sql.append(&quot; AND (&quot;);</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">      for(int counter = 0; counter &lt; publicationNames.length; ++counter) {</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if(0 != counter) {</span>
<span class="nc" id="L422">          sql.append(&quot; OR &quot;);</span>
        }
<span class="nc" id="L424">        sql.append(&quot;Metadata.PublicationId IN (SELECT Publications.PublicationId FROM Publications WHERE PublicationName LIKE '&quot; + publicationNames[counter] + &quot;%')&quot;);</span>
      }
<span class="nc" id="L426">      sql.append(&quot;)\n&quot;);</span>
    }
<span class="nc bnc" id="L428" title="All 4 branches missed.">    if(null != publicationIds &amp;&amp; !&quot;all&quot;.equals(publicationIds[0])) </span>
    {
<span class="nc" id="L430">      sql.append(&quot; AND (&quot;);</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">      for(int counter = 0; counter &lt; publicationIds.length; ++counter) {</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if(0 != counter) {</span>
<span class="nc" id="L433">          sql.append(&quot; OR &quot;);</span>
        }
<span class="nc" id="L435">        sql.append(&quot;Metadata.PublicationId = '&quot; + publicationIds[counter] + &quot;'&quot;);</span>
      }
<span class="nc" id="L437">      sql.append(&quot;)\n&quot;);</span>
    }
    
<span class="nc bnc" id="L440" title="All 6 branches missed.">    if(primary!=null &amp;&amp; primary[0].compareTo(&quot;all&quot;)!=0 &amp;&amp; primary[0].compareTo(&quot;notall&quot;)!=0)</span>
    { 
<span class="nc" id="L442">        sql.append(&quot;AND Metadata.MetadataID IN (SELECT TargetUserGroups.MetadataID from TargetUserGroups WHERE&quot;);</span>
<span class="nc" id="L443">        sql.append(&quot; &quot;+getMultiSelection(primary, &quot;TargetUserGroup&quot;));</span>
<span class="nc" id="L444">        sql.append(&quot;) \n&quot;);   </span>
    } 
<span class="nc bnc" id="L446" title="All 2 branches missed.">    else if(primary[0].compareTo(&quot;notall&quot;)== 0){       </span>
<span class="nc" id="L447">        sql.append(&quot; AND Metadata.MetadataID NOT IN (select MetadataID from TargetUserGroups where (TargetUserGroup = 'Consumer Health/Patient Education' or TargetUserGroup = 'K-12') AND MetadataID NOT IN (select MetadataID from TargetUserGroups where TargetUserGroup = 'Higher Education' or TargetUserGroup ='Health Profession Education'))&quot;);</span>
    }
    else {}
<span class="nc" id="L450">    start=sql.toString(); //The statement parsed above are saved in the start parameter</span>
    //string and attached at the beginning of the Union statement
<span class="nc bnc" id="L452" title="All 2 branches missed.">    for (i=0; i&lt;param.size(); i++)</span>
    {
<span class="nc" id="L454">      ParameterNode tempNode=param.getParameters(i);</span>
<span class="nc" id="L455">      String key=tempNode.getKeyWord();</span>
<span class="nc" id="L456">      relat=tempNode.getRelation();</span>
<span class="nc" id="L457">      String column=tempNode.getColumnName();</span>
<span class="nc" id="L458">      String table=tempNode.getTableName(); </span>
<span class="nc" id="L459">      boolean exact=tempNode.getExact();</span>
      //skip nodes with the three column below, because they have been taken care of 
<span class="nc bnc" id="L461" title="All 6 branches missed.">      if (column.compareTo(&quot;SpecimenType&quot;)!=0 &amp;&amp; column.compareTo(&quot;RadiographType&quot;)!=0 &amp;&amp; column.compareTo(&quot;DiseaseProcess&quot;)!=0)</span>
      {   //attach segments correspondingly 
<span class="nc bnc" id="L463" title="All 4 branches missed.">        if (relat.compareTo(&quot;AND&quot;)==0 &amp;&amp; i!=0 ) //if AND relation</span>
        {
<span class="nc" id="L465">          sql.append(&quot;AND Metadata.MetadataID IN \n&quot;);</span>
        }
<span class="nc bnc" id="L467" title="All 4 branches missed.">        else if (relat.compareTo(&quot;NOT&quot;)==0 &amp;&amp; i!=0) //if not relation</span>
        {
<span class="nc" id="L469">          sql.append(&quot;AND Metadata.MetadataID NOT IN \n&quot;);</span>
        }
<span class="nc bnc" id="L471" title="All 4 branches missed.">        else if (relat.compareTo(&quot;OR&quot;)==0 &amp;&amp; i!=0) //if or relation</span>
        {
<span class="nc" id="L473">          sql.append(&quot;UNION \n&quot;+start+&quot;AND Metadata.MetadataID IN \n &quot;);</span>
        } 
<span class="nc bnc" id="L475" title="All 2 branches missed.">        else if (i==0) //if the first node, attach default segment</span>
        {
<span class="nc" id="L477">          sql.append(&quot;AND Metadata.MetadataID IN \n&quot;);</span>
<span class="nc" id="L478">          in_relat=&quot;&quot;;</span>
        }
        //attach segments according to different table name
<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (table.compareTo(&quot;Metadata&quot;)==0)</span>
        { 
<span class="nc" id="L483">          sql.append(&quot;(&quot;+buildCommonQuery(key, column, table)+&quot; )\n&quot;);</span>
        }
<span class="nc bnc" id="L485" title="All 2 branches missed.">        if (table.compareTo(&quot;Keywords&quot;)==0)</span>
        {
<span class="nc" id="L487">          sql.append(in_relat);</span>
<span class="nc" id="L488">          sql.append(&quot;(&quot;+buildCommonQuery(key, column, table)+&quot;)\n&quot;);</span>
        }
        // added by Zhen 6/12/08 for searching tags table.
<span class="nc bnc" id="L491" title="All 2 branches missed.">        if (table.compareTo(&quot;Tags&quot;)==0)</span>
        {
<span class="nc" id="L493">          sql.append(in_relat);</span>
<span class="nc" id="L494">          sql.append(&quot;(&quot;+buildCommonQuery(key, column, table)+&quot;)\n&quot;);</span>
        }
<span class="nc bnc" id="L496" title="All 2 branches missed.">        if (table.compareTo(&quot;CopyrightHolders&quot;)==0)</span>
        {
<span class="nc" id="L498">          sql.append(in_relat);</span>
<span class="nc" id="L499">          sql.append(&quot;( &quot;+buildMutiQuery(key, &quot;vcardID&quot;, table, &quot;vcards&quot;, column)+&quot; )\n&quot;);</span>
        }
<span class="nc bnc" id="L501" title="All 2 branches missed.">        if (table.compareTo(&quot;Contributors&quot;)==0)</span>
        {
<span class="nc" id="L503">          sql.append(in_relat);</span>
<span class="nc" id="L504">          sql.append(&quot;( &quot;+buildMutiQuery(key, &quot;vcardID&quot;, table, &quot;vcards&quot;, column)+&quot; )\n&quot;);</span>
        }
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (table.compareTo(&quot;TaxonPaths&quot;)==0)</span>
        {
<span class="nc" id="L508">          sql.append(in_relat);</span>
<span class="nc" id="L509">          sql.append(&quot;( &quot;+buildMutiQuery(key, &quot;taxonpathID&quot;, table, &quot;taxons&quot;, column)+&quot; )\n&quot;);</span>
        }         
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (table.compareTo(&quot;ALL&quot;)==0)</span>
        {
<span class="nc" id="L513">          sql.append(in_relat );</span>
<span class="nc" id="L514">          sql.append(&quot;(&quot;+buildCommonQuery(key, &quot;title&quot;, &quot;Metadata&quot;));</span>
<span class="nc" id="L515">          sql.append(&quot;\nUNION &quot;+buildCommonQuery(key, &quot;description&quot;, &quot;Metadata&quot;)); </span>
<span class="nc" id="L516">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;SourceCollection&quot;, &quot;Metadata&quot;));</span>
<span class="nc" id="L517">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;metadataID&quot;, &quot;Metadata&quot;));</span>
<span class="nc" id="L518">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;LearningResourceType&quot;, &quot;Metadata&quot;));</span>
<span class="nc" id="L519">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;keyword&quot;, &quot;Keywords&quot;));</span>
<span class="nc" id="L520">          sql.append(&quot; \nUNION &quot;+buildCommonQuery(key, &quot;tag&quot;, &quot;Tags&quot;));</span>
<span class="nc" id="L521">          sql.append(&quot; \nUNION &quot;+buildMutiQuery(key, &quot;CopyrightTextID&quot;, &quot;CopyRights&quot;, &quot;CopyrightTexts&quot;, &quot;CopyrightText&quot;));</span>
<span class="nc" id="L522">          sql.append(&quot; \nUNION &quot;+buildMutiQuery(key, &quot;TaxonPathID&quot;, &quot;TaxonPaths&quot;, &quot;Taxons&quot;, &quot;Entry&quot;));</span>
<span class="nc" id="L523">          sql.append(&quot; \nUNION &quot;+buildMutiQuery(key, &quot;vcardID&quot;, &quot;Contributors&quot;, &quot;Vcards&quot;, &quot;vcard&quot;));</span>
<span class="nc" id="L524">          sql.append(&quot; \nUNION &quot;+buildMutiQuery(key, &quot;vcardID&quot;, &quot;CopyrightHolders&quot;, &quot;Vcards&quot;, &quot;vcard&quot;));</span>
<span class="nc" id="L525">          sql.append(&quot;)\n&quot;);</span>
        }        
      }
    }
<span class="nc" id="L529">    sql.append(&quot; order by Title&quot;);</span>
<span class="nc" id="L530">    String output=sql.toString();</span>
<span class="nc" id="L531">    System.out.println(&quot;query: &quot; + output);</span>
<span class="nc" id="L532">    return output;    </span>
  }    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>