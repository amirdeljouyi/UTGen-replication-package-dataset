<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReSearchDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.module.search</a> &gt; <span class="el_source">ReSearchDAO.java</span></div><h1>ReSearchDAO.java</h1><pre class="source lang-java linenums">package org.heal.module.search;

import java.io.*;
import java.sql.*;
import java.util.*;
import javax.sql.*;
import com.ora.jsp.sql.*;
import org.heal.module.metadata.*;

/**
 * @author Grace
 * @version 0.1
 */
// This DAO is for users to edit their search results 
public class ReSearchDAO implements Serializable 
{   
  public ReSearchDAO()
<span class="nc" id="L18">  {</span>
<span class="nc" id="L19">  }  </span>
  private DataSource dataSource;   
  /**
    * Sets the dataSource property value. 
    */
  public void setDataSource(DataSource dataSource) 
  {
<span class="nc" id="L26">    this.dataSource = dataSource;</span>
<span class="nc" id="L27">  }         </span>
  /**
    * Here is the process by which the edit search works.
    * First, we get all of the metadata IDs from the Previous search.
    * If you select search within result, The new search scope will be in
    * the previous search. Otherwise this search like a new search.
    * Second we take keyword, media file type and search type  to search in database.
    * The results that are left are packaged into a SearchResultBean and returned.
    * If the search type is 1, it means search any keywords in the database.
    * the keywords list is split (using space as the delimiter) and each 
    * keyword is searched for independently.(like OR)
    * If the search type is 2, it means search all keywords in the database.
    * the keywords list is split (using space as the delimiter) and all the
    * keywords are searched in database.(like AND)
    * If the search type is 3, it means exact search.
    * @param metaids, keywordlist, filterArray, searchtype, filterHidden
    * @return results 
    */
  public SearchResultBean editSearch(String metaids,
                             String keywordList,
                             String[] filterArray,
                             String searchtype,
                             boolean filterHidden)
    throws SQLException 
  {           
<span class="nc" id="L52">    SearchResultBean results = new SearchResultBean();</span>
<span class="nc" id="L53">    results.setShortRecords(null);</span>
<span class="nc" id="L54">    results.setFilterList(filterArray);       </span>
<span class="nc" id="L55">    Vector rows=null;</span>
<span class="nc" id="L56">    Row row = null;</span>
<span class="nc" id="L57">    String metadataId=&quot;&quot;; </span>
<span class="nc" id="L58">    List metaIDs = new ArrayList();</span>
<span class="nc" id="L59">    ShortMetadataResultBean[] metadata = null;           </span>
<span class="nc" id="L60">    Connection conn = dataSource.getConnection();   </span>
    
    try 
    {           
<span class="nc bnc" id="L64" title="All 2 branches missed.">      if (searchtype.equals(&quot;Exact&quot;)) </span>
      {                    
<span class="nc" id="L66">        rows = getExactMatches(metaids,keywordList,filterArray,filterHidden,conn);                     </span>
      } 
      else 
      {                   
<span class="nc" id="L70">        rows = getTypeMatches(metaids,keywordList,filterArray,searchtype,filterHidden,conn); </span>
      }           
      // get the MetadataID and set it to the ShortMetadataBean and ShortMetadataResultBean
<span class="nc bnc" id="L73" title="All 4 branches missed.">      if (rows != null &amp;&amp; rows.size() &gt; 0) </span>
      {
        // found matches...
<span class="nc" id="L76">        Iterator rowIterator = rows.iterator();     </span>
<span class="nc" id="L77">        metadata = new ShortMetadataResultBean[rows.size()];</span>
<span class="nc" id="L78">        int i=0;                 </span>
<span class="nc bnc" id="L79" title="All 4 branches missed.">        while (rowIterator.hasNext()&amp;&amp; i &lt; metadata.length) </span>
        {
<span class="nc" id="L81">          row = (Row) rowIterator.next();</span>
          try 
          {
<span class="nc" id="L84">            metadataId = row.getString(&quot;MetadataID&quot;);</span>
<span class="nc" id="L85">            metaIDs.add(metadataId);</span>
<span class="nc" id="L86">            ShortMetadataBean shortMetadata=new ShortMetadataBean();</span>
<span class="nc" id="L87">            shortMetadata.setMetadataId(metadataId);</span>
<span class="nc" id="L88">            ShortMetadataResultBean smb = new ShortMetadataResultBean();</span>
<span class="nc" id="L89">            smb.setMetadataId(metadataId);                   </span>
<span class="nc" id="L90">            metadata[i]=smb;</span>
<span class="nc" id="L91">            i++;                   </span>
          } 
<span class="nc" id="L93">          catch (NoSuchColumnException ex) </span>
          {
<span class="nc" id="L95">             throw new SQLException(ex.toString());</span>
<span class="nc" id="L96">          }</span>
        }
      }
<span class="nc" id="L99">      results.setShortRecords(metadata);</span>
<span class="nc" id="L100">      results.setMetaIDs(metaIDs);</span>
    }
    finally 
    {
      try 
      {
<span class="nc" id="L106">        conn.close();</span>
      } 
<span class="nc" id="L108">      catch (SQLException ex) </span>
      {
                //ignore...
<span class="nc" id="L111">      }</span>
    }       
<span class="nc" id="L113">    return results;        </span>
  }

  /**
    * Get MetadataIDs that exact match the keyword and selected media types.
    * If prevoious metadata ids not equal &quot;no&quot;, 
    * all the new search will be in the previous search results. 
    * Else the search will be new.
    * If media type is not &quot;All&quot;, then call getFilterString(String[]) to get the media type. 
    * Checks for the given keyword and type in the given table and column name using
    * the provided database connection.  If the match is found, a vector of
    * com.ora.jsp.sql.Row is returned. Else return null. 
    * @param mids, keyword, filterArray, hidd, conn
    * @return rows 
   */ 
  private Vector getExactMatches(String mids,String key,String[] filterAry,boolean hidd,Connection conn) throws SQLException 
  {  
<span class="nc" id="L130">    SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L131">    sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L132">    StringBuffer sql = new StringBuffer();</span>
      
<span class="nc" id="L134">    sql.append(&quot;SELECT distinct(Metadata.metadataID),Metadata.Title FROM Metadata WHERE &quot;);</span>
<span class="nc" id="L135">    sql.append (&quot;(Metadata.CatalogDate IS NOT NULL AND Metadata.ApproveDate IS NOT NULL&quot;);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">    if (hidd==false) </span>
    {
<span class="nc" id="L138">      sql.append(&quot; AND Metadata.Private=0 &quot;);</span>
    }
<span class="nc" id="L140">    sql.append(&quot; AND Metadata.MetadataID NOT IN (select MetadataID from TargetUserGroups where TargetUserGroup LIKE 'consumer Health%' or TargetUserGroup LIKE 'K-12%')&quot;);</span>
<span class="nc" id="L141">    sql.append(&quot;) AND (Metadata.MetadataID IN (SELECT Metadata.MetadataID FROM Metadata WHERE&quot;);     </span>
<span class="nc" id="L142">    sql.append(&quot; (title like '&quot;+key+&quot;' OR title like '% &quot;+key+&quot; %' OR title like '&quot;+key+&quot; %' OR title like '% &quot;+key+&quot;' OR title like '% &quot;+key+&quot;.%' OR title like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L143">    sql.append(&quot;OR description like '&quot;+key+&quot;' OR description like '% &quot;+key+&quot; %' OR description like '&quot;+key+&quot; %' OR description like '% &quot;+key+&quot;' OR description like '% &quot;+key+&quot;.%' OR description like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L144">    sql.append(&quot;OR SourceCollection like '&quot;+key+&quot;' OR SourceCollection like '% &quot;+key+&quot; %' OR SourceCollection like '% &quot;+key+&quot;' OR SourceCollection like '&quot;+key+&quot; %' OR SourceCollection like '% &quot;+key+&quot;.%' OR SourceCollection like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L145">    sql.append(&quot;OR metadataID like '&quot;+key+&quot;' )\n&quot;);    </span>
<span class="nc" id="L146">    sql.append(&quot;UNION Select keywords.metadataID FROM keywords where keyword like '&quot;+key+&quot;' OR keyword LIKE '% &quot;+key+&quot; %' OR keyword like '&quot;+key+&quot; %' OR keyword like '% &quot;+key+&quot;' OR keyword like '% &quot;+key+&quot;.%' OR keyword like '% &quot;+key+&quot;,%'\n&quot;);</span>
<span class="nc" id="L147">    sql.append(&quot;UNION Select Copyrights.metadataID from Copyrights WHERE copyrightTextID IN (Select copyrightTextID from CopyrightTexts WHERE &quot;);</span>
<span class="nc" id="L148">    sql.append(&quot;copyrightText like '&quot;+key+&quot;' OR copyrightText LIKE '% &quot;+key+&quot; %' OR copyrightText like '&quot;+key+&quot; %' OR copyrightText like '% &quot;+key+&quot;' OR copyrightText like '% &quot;+key+&quot;.%')\n&quot;);</span>
<span class="nc" id="L149">    sql.append(&quot;UNION Select TaxonPaths.metadataID from TaxonPaths where taxonpathid in (select taxonpathid from taxons where &quot;);</span>
<span class="nc" id="L150">    sql.append(&quot;Entry like '&quot;+key+&quot;' OR Entry LIKE '% &quot;+key+&quot; %' OR Entry like '&quot;+key+&quot; %' OR Entry like '% &quot;+key+&quot;' OR Entry like '% &quot;+key+&quot;.%' OR Entry like '% &quot;+key+&quot;,%')\n&quot;);</span>
<span class="nc" id="L151">    sql.append(&quot;UNION select copyrightHolders.metadataID from copyrightHolders where vcardID in (select vcardID from vcards where &quot;);</span>
<span class="nc" id="L152">    sql.append(&quot;vCard like '&quot;+key+&quot;' OR vCard LIKE '% &quot;+key+&quot; %' OR vCard like '&quot;+key+&quot; %' OR vCard like '% &quot;+key+&quot;' OR vCard like '% &quot;+key+&quot;.%' OR vCard like '% &quot;+key+&quot;,%')\n&quot;);</span>
<span class="nc" id="L153">    sql.append(&quot;UNION select Contributors.metadataID from Contributors where vcardID in (select vcardID from vcards where &quot;);        </span>
<span class="nc" id="L154">    sql.append(&quot;vCard like '&quot;+key+&quot;' OR vCard LIKE '% &quot;+key+&quot; %' OR vCard like '&quot;+key+&quot; %' OR vCard like '% &quot;+key+&quot;' OR vCard like '% &quot;+key+&quot;.%' OR vCard like '% &quot;+key+&quot;,%')))\n&quot;);        </span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">    if (filterAry != null)  </span>
    {
<span class="nc" id="L157">      String format=getFilterString(filterAry);    </span>
<span class="nc" id="L158">      sql.append(&quot; AND (&quot;+format+&quot;)&quot;);</span>
    }
<span class="nc bnc" id="L160" title="All 2 branches missed.">    if(mids.equals(&quot;no&quot;)){}</span>
    else
    { 
<span class="nc" id="L163">      sql.append(&quot; AND Metadata.MetadataID IN (&quot;+mids+&quot;)&quot;);</span>
    }
<span class="nc" id="L165">    sql.append(&quot; order by Title&quot;);</span>
<span class="nc" id="L166">    sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L167">    Vector rows = null;</span>
    try 
    {
<span class="nc" id="L170">      rows = sqlCommandBean.executeQuery();</span>
    }
<span class="nc" id="L172">    catch (UnsupportedTypeException e) </span>
    {
<span class="nc" id="L174">	    throw new SQLException(e.toString());</span>
<span class="nc" id="L175">    } </span>
<span class="nc" id="L176">    return rows;</span>
  }    

  /**
    * Get MetadataIDs that match all or any words that user input and selected media types.
    * If prevoious metadata ids not equal &quot;no&quot;, all the new search will be in the previous search results.
    * Else the search will be new.
    * Tokenizer the keywords and get each of word.
    * If search type equal &quot;All&quot;, add &quot;AND&quot; relation between the word.
    * If search type equal &quot;Any&quot;, add &quot;UNION&quot; relation between the word. 
    * If media type is not &quot;All&quot;, call getFilterString(String[]) to get the media type. 
    * Checks each keyword of the list and type in the given table and column name using
    * the provided database connection.  If the match is found, a vector of
    * com.ora.jsp.sql.Row is returned. Else return null.
    * @param mids, keywords, filterAry, type, hidd, conn
    * @return rows 
    */      
  private Vector getTypeMatches(String mids, String keywords,String[] filterAry,String type,boolean hidd,Connection conn) throws SQLException 
  {          
<span class="nc" id="L195">    List keys = new ArrayList();</span>
<span class="nc" id="L196">    String key = null;</span>
<span class="nc" id="L197">    StringTokenizer tokenizer = new StringTokenizer(keywords,&quot; &quot;);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">    while (tokenizer.hasMoreTokens()) </span>
    {
<span class="nc" id="L200">      keys.add(tokenizer.nextToken());</span>
    } 
    
<span class="nc" id="L203">    SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L204">    sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L205">    StringBuffer sql = new StringBuffer();      </span>
<span class="nc" id="L206">    sql.append(&quot;select distinct(Metadata.metadataID),Metadata.Title FROM Metadata WHERE &quot;);</span>
<span class="nc" id="L207">    sql.append (&quot;(Metadata.CatalogDate IS NOT NULL AND Metadata.ApproveDate IS NOT NULL&quot;);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">    if (hidd==false) </span>
    {
<span class="nc" id="L210">      sql.append(&quot; AND Metadata.Private=0 &quot;);</span>
    } 
<span class="nc" id="L212">    sql.append(&quot; AND Metadata.MetadataID NOT IN (select MetadataID from TargetUserGroups where TargetUserGroup LIKE 'consumer Health%' or TargetUserGroup LIKE 'K-12%')&quot;);</span>
<span class="nc" id="L213">    sql.append(&quot;) \n&quot;);</span>
<span class="nc" id="L214">    String start=sql.toString();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">    for (int i=0; i&lt;keys.size(); i++)</span>
    {
<span class="nc" id="L217">      key = (String)keys.get(i);</span>
<span class="nc bnc" id="L218" title="All 4 branches missed.">      if(type.equals(&quot;All&quot;) || i == 0)  </span>
      {
<span class="nc" id="L220">        sql.append(&quot;AND (Metadata.MetadataID IN \n&quot;);</span>
      }
<span class="nc bnc" id="L222" title="All 4 branches missed.">      else if(type.equals(&quot;Any&quot;) &amp;&amp; i &gt;=1) </span>
      {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (filterAry != null) </span>
        {
<span class="nc" id="L226">          String format=getFilterString(filterAry);</span>
<span class="nc" id="L227">          sql.append(&quot; AND (&quot;+format+&quot;)&quot;);</span>
        }
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if(mids.equals(&quot;no&quot;)){}</span>
        else
        { 
<span class="nc" id="L232">          sql.append(&quot; AND Metadata.MetadataID IN (&quot;+mids+&quot;)&quot;);</span>
        }     
<span class="nc" id="L234">        sql.append(&quot; UNION \n&quot;+start+&quot;AND (Metadata.MetadataID IN \n &quot;);</span>
      } 
<span class="nc" id="L236">      sql.append(&quot; (Select Metadata.MetadataID from metadata where&quot;); </span>
<span class="nc" id="L237">      sql.append(&quot; (title like '%&quot;+key+&quot;%' \n&quot;);</span>
<span class="nc" id="L238">      sql.append(&quot;OR description like '%&quot;+key+&quot;%' \n&quot;);</span>
<span class="nc" id="L239">      sql.append(&quot;OR SourceCollection like '%&quot;+key+&quot;%' \n&quot;);</span>
<span class="nc" id="L240">      sql.append(&quot;OR metadataID like '&quot;+key+&quot;' )\n&quot;);</span>
<span class="nc" id="L241">      sql.append(&quot;UNION Select keywords.metadataID FROM keywords where keyword like '%&quot;+key+&quot;%'\n&quot;);</span>
<span class="nc" id="L242">      sql.append(&quot;UNION Select Copyrights.metadataID from Copyrights WHERE copyrightTextID IN (Select copyrightTextID from CopyrightTexts WHERE &quot;);</span>
<span class="nc" id="L243">      sql.append(&quot;copyrightText LIKE '%&quot;+key+&quot;%')\n&quot;);</span>
<span class="nc" id="L244">      sql.append(&quot;UNION Select TaxonPaths.metadataID from TaxonPaths where taxonpathid in (select taxonpathid from taxons where &quot;);</span>
<span class="nc" id="L245">      sql.append(&quot; Entry LIKE '%&quot;+key+&quot;%')\n&quot;);</span>
<span class="nc" id="L246">      sql.append(&quot;UNION select copyrightHolders.metadataID from copyrightHolders where vcardID in (select vcardID from vcards where &quot;);</span>
<span class="nc" id="L247">      sql.append(&quot; vCard LIKE '%&quot;+key+&quot;%')\n&quot;);</span>
<span class="nc" id="L248">      sql.append(&quot;UNION select Contributors.metadataID from Contributors where vcardID in (select vcardID from vcards where &quot;);</span>
<span class="nc" id="L249">      sql.append(&quot; vCard LIKE '%&quot;+key+&quot;%')))\n&quot;);</span>
    }
<span class="nc bnc" id="L251" title="All 2 branches missed.">    if (filterAry != null) </span>
    {
<span class="nc" id="L253">      String format=getFilterString(filterAry);</span>
<span class="nc" id="L254">      sql.append(&quot; AND (&quot;+format+&quot;)&quot;);</span>
    }
<span class="nc bnc" id="L256" title="All 2 branches missed.">    if(mids.equals(&quot;no&quot;)){}</span>
    else
    { 
<span class="nc" id="L259">      sql.append(&quot; AND Metadata.MetadataID IN (&quot;+mids+&quot;)&quot;);</span>
    }
<span class="nc" id="L261">    sql.append(&quot; order by Title&quot;);</span>
<span class="nc" id="L262">    sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L263">    Vector rows = null;</span>
    try 
    {
<span class="nc" id="L266">      rows = sqlCommandBean.executeQuery();</span>
    }
<span class="nc" id="L268">    catch (UnsupportedTypeException e) </span>
    {
<span class="nc" id="L270">	    throw new SQLException(e.toString());</span>
<span class="nc" id="L271">    } </span>
<span class="nc" id="L272">    return rows;   </span>
  }
  /**
    * Combine some string with each element of filterarray to make SQL statement.
    * @param mids, keywords, filterAry, type, hidd, conn
    * @return rows 
    */
  public String getFilterString(String[] filterAry) 
  {  
<span class="nc" id="L281">    String format=&quot;&quot;;	</span>
<span class="nc" id="L282">    String f=&quot; OR Metadata.LearningResourceType like '&quot;; </span>
<span class="nc" id="L283">    int t1=0;   	  </span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">    for( int i=0; i &lt; filterAry.length; i++) </span>
    {
<span class="nc bnc" id="L286" title="All 2 branches missed.">      if (filterAry.length ==1) </span>
      {
<span class="nc" id="L288">        format =&quot;Metadata.LearningResourceType like '&quot; + filterAry[0]+&quot;%'&quot;; </span>
<span class="nc" id="L289">        t1=format.length();</span>
      }
      else 
      {
<span class="nc" id="L293">        format=format+f+filterAry[i]+&quot;%'&quot;;            </span>
      }          
    }
<span class="nc bnc" id="L296" title="All 2 branches missed.">    if (t1==0)</span>
    {
<span class="nc" id="L298">      format=format.replaceFirst(&quot;OR&quot;,&quot;&quot;); </span>
    } 
<span class="nc" id="L300">    return format;</span>
  }

  /**
    * make a String to contain all the metadateIDs that found in search.
    * @param metaID
    * @return inStr 
   */
  public String makeInString(List metaID)
  {
<span class="nc" id="L310">    StringBuffer inStrs=new StringBuffer();</span>
<span class="nc" id="L311">    int msize=metaID.size();</span>
<span class="nc" id="L312">    int i=0;</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">    while (msize &gt; i)</span>
    {
<span class="nc" id="L315">      inStrs.append(metaID.get(i));</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">      if (i!=metaID.size()-1)</span>
      {
<span class="nc" id="L318">        inStrs.append(&quot;, &quot;);</span>
      }
<span class="nc" id="L320">      i++;</span>
    }    
<span class="nc" id="L322">    String inStr=inStrs.toString();</span>
<span class="nc" id="L323">    return inStr;</span>
  }
  /**
    * Sort the search results as required field.
    * @param filed, mids
    * @return results 
   */
  public SearchResultBean sortResult(String filed, String mids) throws SQLException 
  {  
<span class="nc" id="L332">    SearchResultBean results = new SearchResultBean();</span>
<span class="nc" id="L333">    results.setShortRecords(null);</span>
<span class="nc" id="L334">    Vector rows=null;</span>
<span class="nc" id="L335">    Row row = null;</span>
<span class="nc" id="L336">    String metadataId=&quot;&quot;; </span>
<span class="nc" id="L337">    List metaIDs = new ArrayList();</span>
<span class="nc" id="L338">    ShortMetadataResultBean[] metadata = null;            </span>
<span class="nc" id="L339">    Connection conn = dataSource.getConnection();                   </span>
    try 
    {      
<span class="nc" id="L342">      rows = getSortMetadataID(filed,mids,conn);     </span>
      // get the MetadataID and set it to the ShortMetadataBean and ShortMetadataResultBean
<span class="nc bnc" id="L344" title="All 4 branches missed.">      if (rows != null &amp;&amp; rows.size() &gt; 0) </span>
      {
       // found matches...
<span class="nc" id="L347">        Iterator rowIterator = rows.iterator();     </span>
<span class="nc" id="L348">        metadata = new ShortMetadataResultBean[rows.size()];</span>
<span class="nc" id="L349">        int i=0;                 </span>
<span class="nc bnc" id="L350" title="All 4 branches missed.">        while (rowIterator.hasNext()&amp;&amp; i &lt; metadata.length) </span>
        {
<span class="nc" id="L352">          row = (Row) rowIterator.next();</span>
          try 
          {
<span class="nc" id="L355">            metadataId = row.getString(&quot;MetadataID&quot;);</span>
<span class="nc" id="L356">            metaIDs.add(metadataId);</span>
<span class="nc" id="L357">            ShortMetadataBean shortMetadata=new ShortMetadataBean();</span>
<span class="nc" id="L358">            shortMetadata.setMetadataId(metadataId);</span>
<span class="nc" id="L359">            ShortMetadataResultBean smb = new ShortMetadataResultBean();</span>
<span class="nc" id="L360">            smb.setMetadataId(metadataId);                    </span>
<span class="nc" id="L361">            metadata[i]=smb;</span>
<span class="nc" id="L362">            i++;                   </span>
          } 
<span class="nc" id="L364">          catch (NoSuchColumnException ex) </span>
          {
<span class="nc" id="L366">            throw new SQLException(ex.toString());</span>
<span class="nc" id="L367">          }</span>
        }
      }
<span class="nc" id="L370">      results.setShortRecords(metadata);</span>
<span class="nc" id="L371">      results.setMetaIDs(metaIDs);</span>
    }finally 
    {
      try 
      {
<span class="nc" id="L376">        conn.close();</span>
<span class="nc" id="L377">      } catch (SQLException ex) </span>
      {
      //ignore...
<span class="nc" id="L380">      }</span>
    }       
<span class="nc" id="L382">    return results;        </span>
  }
  /**
    * Get a sort field and sort in database using order by.
    * Return the sorted rows.
    * @param fd, ids, conn
    * @return rows 
   */
  private Vector getSortMetadataID(String fd, String ids, Connection conn) throws SQLException 
  {           
<span class="nc" id="L392">    SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L393">    sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L394">    StringBuffer sql = new StringBuffer(); </span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">    if (fd.equals(&quot;Format&quot;)) </span>
    {
<span class="nc" id="L397">      sql.append(&quot;SELECT MetadataID, LearningResourceType FROM Metadata WHERE metadataID IN (&quot;+ids+&quot;) &quot;) </span>
<span class="nc" id="L398">       .append(&quot;ORDER BY LearningResourceType&quot;);</span>
    }
<span class="nc bnc" id="L400" title="All 2 branches missed.">    else if (fd.equals(&quot;FileSize&quot;))</span>
    {      
<span class="nc" id="L402">      sql.append(&quot;SELECT MetadataID,FileSize FROM Metadata WHERE metadataID IN (&quot;+ids+&quot;) &quot;)</span>
<span class="nc" id="L403">         .append(&quot;ORDER BY CASE when FileSize=0 then CONVERT(int, 99999999) ELSE fileSize END ASC&quot;);</span>
    }
<span class="nc bnc" id="L405" title="All 2 branches missed.">    else if (fd.equals(&quot;SourceCollection&quot;)) </span>
    {
<span class="nc" id="L407">      sql.append(&quot;SELECT MetadataID,SourceCollection FROM Metadata WHERE metadataID IN (&quot;+ids+&quot;) &quot;) </span>
<span class="nc" id="L408">       .append(&quot;ORDER BY SourceCollection&quot;);</span>
    }
    else 
    {
<span class="nc" id="L412">      sql.append(&quot;SELECT MetadataID, Title FROM Metadata WHERE metadataID IN (&quot;+ids+&quot;) &quot;) </span>
<span class="nc" id="L413">       .append(&quot;ORDER BY Title&quot;);</span>
    }        
<span class="nc" id="L415">    sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L416">    Vector rows = null;</span>
    try 
    {
<span class="nc" id="L419">      rows = sqlCommandBean.executeQuery();</span>
    }
<span class="nc" id="L421">    catch (UnsupportedTypeException e) </span>
    {
<span class="nc" id="L423">      throw new SQLException(e.toString());</span>
<span class="nc" id="L424">    } </span>
<span class="nc" id="L425">    return rows;</span>
  }  
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>