<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PreviewUploadAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet.upload</a> &gt; <span class="el_source">PreviewUploadAction.java</span></div><h1>PreviewUploadAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet.upload;

import com.oreilly.servlet.MultipartRequest;
import com.oreilly.servlet.multipart.FileRenamePolicy;

import org.heal.module.metadata.CompleteMetadataBean;
import org.heal.module.metadata.ContextURLBean;
import org.heal.module.metadata.ContributorBean;
import org.heal.module.metadata.CopyrightBean;
import org.heal.module.metadata.CopyrightHolderBean;
import org.heal.module.metadata.CopyrightTextBean;
import org.heal.module.metadata.FormatBean;
import org.heal.module.metadata.KeywordBean;
import org.heal.module.metadata.MetadataBean;
import org.heal.module.metadata.RelationBean;
import org.heal.module.metadata.RequirementBean;
import org.heal.module.metadata.TargetUserGroupBean;
import org.heal.module.metadata.MetametadataContributorBean;
import org.heal.module.upload.UploadServicesBean;
import org.heal.module.user.UserBean;
import org.heal.servlet.Action;
import org.heal.util.DateTools;
import org.heal.util.FileLocator;
import org.heal.util.VCardBean;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.Vector;
import org.heal.servlet.upload.AlphanumericFileRenamePolicy;

<span class="nc" id="L43">public class PreviewUploadAction implements Action {</span>
  
<span class="nc" id="L45">  private static final FileRenamePolicy fileRenamePolicy = new AlphanumericFileRenamePolicy();</span>
    private static final Map&lt;String, String&gt; mediaTypes;

    // Initializes the mediaTypes map
    static {
<span class="nc" id="L50">        Map&lt;String, String&gt; temp = new HashMap&lt;String, String&gt;();</span>

<span class="nc" id="L52">        temp.put(&quot;pdf&quot;, &quot;application/pdf&quot;);</span>
<span class="nc" id="L53">        temp.put(&quot;ppt&quot;, &quot;application/vnd.ms-powerpoint&quot;);</span>
<span class="nc" id="L54">        temp.put(&quot;pot&quot;, &quot;application/vnd.ms-powerpoint&quot;);</span>
<span class="nc" id="L55">        temp.put(&quot;swf&quot;, &quot;application/x-shockwave-flash&quot;);</span>
<span class="nc" id="L56">        temp.put(&quot;smil&quot;, &quot;application/smil&quot;);</span>
<span class="nc" id="L57">        temp.put(&quot;zip&quot;, &quot;application/zip&quot;);</span>
<span class="nc" id="L58">        temp.put(&quot;doc&quot;, &quot;application/msword&quot;);</span>
<span class="nc" id="L59">        temp.put(&quot;wpd&quot;, &quot;application/vnd.wordperfect&quot;);</span>
<span class="nc" id="L60">        temp.put(&quot;vsd&quot;, &quot;application/visio&quot;);</span>
<span class="nc" id="L61">        temp.put(&quot;xls&quot;, &quot;application/vnd.ms-excel&quot;);</span>
<span class="nc" id="L62">        temp.put(&quot;xlm&quot;, &quot;application/vnd.ms-excel&quot;);</span>
<span class="nc" id="L63">        temp.put(&quot;mpp&quot;, &quot;application/vnd.ms-project&quot;);</span>
<span class="nc" id="L64">        temp.put(&quot;xml&quot;, &quot;application/xml&quot;);</span>
<span class="nc" id="L65">        temp.put(&quot;exe&quot;, &quot;application/octet-stream&quot;);</span>
<span class="nc" id="L66">        temp.put(&quot;js&quot;, &quot;application/x-javascript&quot;);</span>
<span class="nc" id="L67">        temp.put(&quot;wav&quot;, &quot;audio/x-wav&quot;);</span>
<span class="nc" id="L68">        temp.put(&quot;mpg&quot;, &quot;audio/mpeg&quot;);</span>
<span class="nc" id="L69">        temp.put(&quot;rm&quot;, &quot;audio/x-pn-realaudio&quot;);</span>
<span class="nc" id="L70">        temp.put(&quot;ra&quot;, &quot;audio/x-pn-realaudio&quot;);</span>
<span class="nc" id="L71">        temp.put(&quot;ram&quot;, &quot;audio/x-pn-realaudio&quot;);</span>
<span class="nc" id="L72">        temp.put(&quot;rpm&quot;, &quot;audio/x-pn-realaudio-plugin&quot;);</span>
<span class="nc" id="L73">        temp.put(&quot;qt&quot;, &quot;audio/qt&quot;);</span>
<span class="nc" id="L74">        temp.put(&quot;au&quot;, &quot;audio/basic&quot;);</span>
<span class="nc" id="L75">        temp.put(&quot;aif&quot;, &quot;audio/x-aiff&quot;);</span>
<span class="nc" id="L76">        temp.put(&quot;jpg&quot;, &quot;Image/jpeg&quot;);</span>
<span class="nc" id="L77">        temp.put(&quot;gif&quot;, &quot;Image/gif&quot;);</span>
<span class="nc" id="L78">        temp.put(&quot;png&quot;, &quot;Image/png&quot;);</span>
<span class="nc" id="L79">        temp.put(&quot;igs&quot;, &quot;model/iges&quot;);</span>
<span class="nc" id="L80">        temp.put(&quot;iges&quot;, &quot;model/iges&quot;);</span>
<span class="nc" id="L81">        temp.put(&quot;vrml&quot;, &quot;model/vrml&quot;);</span>
<span class="nc" id="L82">        temp.put(&quot;htm&quot;, &quot;text/html&quot;);</span>
<span class="nc" id="L83">        temp.put(&quot;html&quot;, &quot;text/html&quot;);</span>
<span class="nc" id="L84">        temp.put(&quot;sgm&quot;, &quot;text/sgml&quot;);</span>
<span class="nc" id="L85">        temp.put(&quot;sgml&quot;, &quot;text/sgml&quot;);</span>
<span class="nc" id="L86">        temp.put(&quot;txt&quot;, &quot;text/plain&quot;);</span>
<span class="nc" id="L87">        temp.put(&quot;rtf&quot;, &quot;text/rtf&quot;);</span>
<span class="nc" id="L88">        temp.put(&quot;xml&quot;, &quot;text/xml&quot;);</span>
<span class="nc" id="L89">        temp.put(&quot;mpeg&quot;, &quot;video/mpeg&quot;);</span>
<span class="nc" id="L90">        temp.put(&quot;mpg&quot;, &quot;video/mpeg&quot;);</span>
<span class="nc" id="L91">        temp.put(&quot;qt&quot;, &quot;video/quicktime&quot;);</span>
<span class="nc" id="L92">        temp.put(&quot;mov&quot;, &quot;video/quicktime&quot;);</span>

<span class="nc" id="L94">        mediaTypes = Collections.unmodifiableMap(temp);</span>
<span class="nc" id="L95">    }</span>


  public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
            throws IOException, ServletException 
  {
    
    RequestDispatcher rd;
<span class="nc" id="L103">        CompleteMetadataBean completeMetadata = new CompleteMetadataBean();</span>
<span class="nc" id="L104">        Vector errorMessages = new Vector();</span>
<span class="nc" id="L105">        FileLocator healFileLocator = (FileLocator)servlet.getServletContext().getAttribute(&quot;healFileLocator&quot;);</span>
<span class="nc" id="L106">        UserBean validUser = (UserBean)request.getSession().getAttribute(&quot;validUser&quot;);</span>
<span class="nc" id="L107">        MultipartRequest multiPartReq = processUploadRequest(request, validUser, completeMetadata, healFileLocator, errorMessages);</span>

<span class="nc bnc" id="L109" title="All 2 branches missed.">        if(errorMessages.size() &gt; 0) {</span>
            //setup attributes
<span class="nc" id="L111">            setupAttributes(request, multiPartReq);</span>
<span class="nc" id="L112">            request.setAttribute(&quot;errorMessages&quot;, errorMessages);</span>
<span class="nc" id="L113">            String forwardURL = &quot;../upload2/uploadform.jsp&quot;;</span>
<span class="nc" id="L114">            rd = request.getRequestDispatcher(forwardURL);</span>
<span class="nc" id="L115">            rd.forward(request, response);</span>
<span class="nc" id="L116">            return;</span>
        } else {
<span class="nc" id="L118">            UploadServicesBean uploadServices = (UploadServicesBean)servlet.getServletContext().getAttribute(&quot;uploadServices&quot;);</span>
            //MetadataDAO metadataServices = (MetadataDAO)servlet.getServletContext().getAttribute(&quot;MetadataDAO&quot;);
            //final QueueDAO queueManager = (QueueDAO)servlet.getServletContext().getAttribute(&quot;QueueDAO&quot;);
           // final CommonDAO commonServices = (CommonDAO)servlet.getServletContext().getAttribute(&quot;CommonDAO&quot;);
<span class="nc" id="L122">            String format = completeMetadata.getFormat();</span>
<span class="nc" id="L123">            String location = completeMetadata.getLocation();</span>
<span class="nc" id="L124">            String converted = healFileLocator.convertLocationToFilePath(location);</span>
<span class="nc" id="L125">            String path = healFileLocator.getUploadFilePath() + File.separator + converted;</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">            if((format.toLowerCase()).startsWith(&quot;Image&quot;.toLowerCase())) {</span>
<span class="nc" id="L128">                uploadServices.processImage(completeMetadata, path);</span>
<span class="nc bnc" id="L129" title="All 4 branches missed.">            } else if(&quot;Video&quot;.equalsIgnoreCase(format) || &quot;Animation&quot;.equalsIgnoreCase(format)) {</span>
<span class="nc" id="L130">                uploadServices.processVideo(completeMetadata, path);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">            } else if(&quot;Audio&quot;.equalsIgnoreCase(format)) {</span>
<span class="nc" id="L132">                uploadServices.processAudio(completeMetadata, path);</span>
            }

<span class="nc" id="L135">            final String vCard = &quot;begin:vcard\n&quot; +</span>
                    &quot;n:Health Education Assets Library (HEAL)\n&quot; +
                    &quot;url:http://www.healcentral.org\n&quot; +
                    &quot;email;type=internet:info@healcentral.org \n&quot; +
                    &quot;fn:Health Education Assets Library (HEAL)\n&quot; +
                    &quot;end:vcard&quot;;
<span class="nc" id="L141">            MetametadataContributorBean mcb = new MetametadataContributorBean();</span>
<span class="nc" id="L142">            mcb.setDate(new Date());</span>
<span class="nc" id="L143">            mcb.setRole(&quot;Creator&quot;);</span>
<span class="nc" id="L144">            mcb.setvCard(vCard);</span>
<span class="nc" id="L145">            mcb.setDateDescription(&quot;Contributed to HEAL&quot;);</span>
<span class="nc" id="L146">            completeMetadata.getMetametadataContributors().add(mcb);</span>
<span class="nc" id="L147">            request.getSession().setAttribute(&quot;completeMetadata&quot;, completeMetadata);</span>
<span class="nc" id="L148">            request.getSession().setAttribute(&quot;requestParameters&quot;, multiPartReq);</span>
<span class="nc" id="L149">            response.sendRedirect(&quot;../upload2/preview.jsp&quot;);</span>

        }  

<span class="nc" id="L153">  }</span>
  public boolean actionRequiresLogin() {
<span class="nc" id="L155">        return true;</span>
    }
  /**
     * Handles all processing of an upload request.  Parses out the upload
     * parameters and file and stores the information in the provided
     * CompleteMetadataBean.  Any errors that occur will result in
     * messages being added to the errorMessages vector.
     * The validUser parameter is required in order to determine where to
     * place the uploaded file.  The healFileLocator parameter is also
     * required for this reason.
     * If the errorMessages vector is empty then the complete metadata
     * bean parameter will be fully filled out and ready for storage
     * in the database.  If an errorMessage does show up, then there
     * was an error in processing and the uploaded file will be deleted
     * before this method returns.  The CompleteMetadataBean will still
     * contain as many parameters as the method was able to process, thus
     * allowing the error form to retain those settings as a convenience
     * to the user.
     * This method returns a HashMap containing all of the parameters and
     * values read from the request.  See the readRequestParameters method
     * for a description of the format of this map.
     */
    public static MultipartRequest processUploadRequest(HttpServletRequest request,
                                                        UserBean validUser,
                                                        CompleteMetadataBean cmb,
                                                        FileLocator healFileLocator,
                                                        Vector errorMessages) {
        String location;
        try {
<span class="nc" id="L184">            String userUploadDir = healFileLocator.getUploadFilePath() + &quot;\\&quot; + validUser.getUserId();</span>

<span class="nc" id="L186">            File directory = new File(userUploadDir);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if(!directory.exists()) {</span>
<span class="nc" id="L188">                directory.mkdir();</span>
            }

<span class="nc" id="L191">            MultipartRequest multipartReq = new MultipartRequest(request, userUploadDir, (int)healFileLocator.getMaxUploadSize(), fileRenamePolicy);</span>
<span class="nc" id="L192">            String fn = multipartReq.getParameter(&quot;locationfile&quot;);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (fn.equals(&quot;File&quot;))</span>
            {
<span class="nc" id="L195">              location = multipartReq.getFilesystemName(&quot;fileName&quot;);           </span>
<span class="nc" id="L196">              System.err.println(&quot;Location = &quot; + location);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">              if(location == null) {</span>
<span class="nc" id="L198">                errorMessages.addElement(&quot;Unable to process uploaded file.&quot;);</span>
              } else {
<span class="nc" id="L200">                location = validUser.getUserId() + &quot;/&quot; + location;</span>
              }              
            }
            else
            {
<span class="nc" id="L205">              location = multipartReq.getParameter(&quot;fileName&quot;);</span>
            }
<span class="nc bnc" id="L207" title="All 4 branches missed.">            if(multipartReq.getParameter(&quot;contributorInfo&quot;) == null || multipartReq.getParameter(&quot;contributorInfo&quot;).length() == 0) {</span>
<span class="nc" id="L208">                errorMessages.addElement(&quot;Please include contributor information.&quot;);</span>
            }

<span class="nc bnc" id="L211" title="All 4 branches missed.">            if(multipartReq.getParameter(&quot;title&quot;) == null || multipartReq.getParameter(&quot;title&quot;).length() == 0) {</span>
<span class="nc" id="L212">                errorMessages.addElement(&quot;Please enter a title.&quot;);</span>
            }

<span class="nc bnc" id="L215" title="All 4 branches missed.">            if(multipartReq.getParameter(&quot;description&quot;) == null || multipartReq.getParameter(&quot;description&quot;).length() == 0) {</span>
<span class="nc" id="L216">                errorMessages.addElement(&quot;Please enter a general description.&quot;);</span>
            }

<span class="nc bnc" id="L219" title="All 4 branches missed.">            if(multipartReq.getParameter(&quot;license&quot;) == null || multipartReq.getParameter(&quot;license&quot;).length() == 0) {</span>
<span class="nc" id="L220">                errorMessages.addElement(&quot;Please select usage rights setting.&quot;);</span>
            }

<span class="nc bnc" id="L223" title="All 4 branches missed.">            if(multipartReq.getParameter(&quot;copyrightHolder&quot;) == null || multipartReq.getParameter(&quot;copyrightHolder&quot;).length() == 0) {</span>
<span class="nc" id="L224">                errorMessages.addElement(&quot;Please include copyright holder information.&quot;);</span>
            }

<span class="nc" id="L227">            Date testDate = DateTools.parse(multipartReq.getParameter(&quot;creationDate&quot;));</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            if(null == testDate) {</span>
<span class="nc" id="L229">                errorMessages.addElement(&quot;Please provide a date in the format YYYY-MM-DD.&quot;);</span>
            } else {
                // This is MS SQL Server-specific
<span class="nc" id="L232">                Calendar testCalendar = Calendar.getInstance();</span>
<span class="nc" id="L233">                testCalendar.setTime(testDate);</span>
<span class="nc" id="L234">                final int year = testCalendar.get(Calendar.YEAR);</span>
<span class="nc bnc" id="L235" title="All 4 branches missed.">                if(year &lt; 1753 || year &gt; 9999) {</span>
<span class="nc" id="L236">                    errorMessages.addElement(&quot;The year '&quot; +year+ &quot;' in '&quot; + multipartReq.getParameter(&quot;creationDate&quot;)+ &quot;' is invalid.  Please provide a year within the range 1753 - 9999.&quot;);</span>
                }
            }
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if(null == multipartReq.getParameter(&quot;revision&quot;)) {</span>
<span class="nc" id="L240">                errorMessages.addElement(&quot;Please select whether or not this is a revision&quot;);</span>
            }
            //add info to the complete metadata bean...
<span class="nc" id="L243">            storeParameters(multipartReq, validUser, location, healFileLocator, cmb);</span>
<span class="nc" id="L244">            return multipartReq;</span>
<span class="nc" id="L245">        } catch(IOException lEx) {</span>
<span class="nc" id="L246">            errorMessages.addElement(&quot;An error occured while reading the submitted file.&quot;);</span>
<span class="nc" id="L247">            lEx.printStackTrace();</span>
<span class="nc" id="L248">            return null;</span>
        }
    }

    /**
     * Handles all processing of an upload request.  Parses out the upload
     * parameters and file and stores the information in the provided
     * CompleteMetadataBean.  Any errors that occur will result in
     * messages being added to the errorMessages vector.
     * The validUser parameter is required in order to determine where to
     * place the uploaded file.  The healFileLocator parameter is also
     * required for this reason.
     * If the errorMessages vector is empty then the complete metadata
     * bean parameter will be fully filled out and ready for storage
     * in the database.  If an errorMessage does show up, then there
     * was an error in processing and the uploaded file will be deleted
     * before this method returns.  The CompleteMetadataBean will still
     * contain as many parameters as the method was able to process, thus
     * allowing the error form to retain those settings as a convenience
     * to the user.
     * This method returns a HashMap containing all of the parameters and
     * values read from the request.  See the readRequestParameters method
     * for a description of the format of this map.
     */
    /**
     * Reads the information contained within the parametersMap
     * and stores that information in the CompleteMetadataBean.
     * The values in the parametersMap are ArrayLists keyed off
     * of strings defined in the upload form.  These values,
     * along with the user, location, and file locator are
     * used to completely fill out the complete metadata so
     * that it is ready to be stored in the database.
     * Since this is a new upload, the cmb.metadata.hidden
     * value is set to true (we don't mark things as unhidden
     * until the item is cataloged).
     */
    private static void storeParameters(MultipartRequest multipartReq,
                                        UserBean validUser,
                                        String location,
                                        FileLocator fileLocator,
                                        CompleteMetadataBean cmb) {
<span class="nc" id="L289">        cmb.setLocation(location);</span>
<span class="nc" id="L290">        cmb.setTitle(multipartReq.getParameter(&quot;title&quot;));</span>
<span class="nc" id="L291">        cmb.setContributeUserId(validUser.getUserId());</span>
<span class="nc" id="L292">        cmb.setCreationDate(DateTools.parse(multipartReq.getParameter(&quot;creationDate&quot;)));</span>


<span class="nc" id="L295">        java.util.Date currentTime = new java.util.Date();</span>
<span class="nc" id="L296">        cmb.setContributeDate(currentTime);</span>
<span class="nc" id="L297">        cmb.setAnnotated(multipartReq.getParameter(&quot;annotated&quot;));</span>
<span class="nc" id="L298">        cmb.setInappropriate(multipartReq.getParameter(&quot;inappropriate&quot;));</span>
<span class="nc" id="L299">        cmb.setPublicationName(multipartReq.getParameter(&quot;publicationName&quot;));</span>
<span class="nc" id="L300">        cmb.setPublicationId(multipartReq.getParameter(&quot;publicationId&quot;));</span>
<span class="nc" id="L301">        cmb.setSourceCollection(&quot;Peer Review Pending&quot;);</span>
<span class="nc" id="L302">        cmb.setSubmissionAgreement(multipartReq.getParameter(&quot;submissionAgreement&quot;));</span>
<span class="nc" id="L303">        cmb.setDescription(multipartReq.getParameter(&quot;description&quot;));</span>
<span class="nc" id="L304">        cmb.setLearningResourceType(multipartReq.getParameter(&quot;learningResourceType&quot;));</span>
<span class="nc" id="L305">        cmb.setSpecimenType(multipartReq.getParameter(&quot;specimenType&quot;));</span>
<span class="nc" id="L306">        cmb.setRadiographType(multipartReq.getParameter(&quot;radiographType&quot;));</span>
<span class="nc" id="L307">        cmb.setOrientation(multipartReq.getParameter(&quot;orientation&quot;));</span>
<span class="nc" id="L308">        cmb.setMagnification(multipartReq.getParameter(&quot;magnification&quot;));</span>
<span class="nc" id="L309">        cmb.setClinicalHistory(multipartReq.getParameter(&quot;clinicalHistory&quot;));</span>
<span class="nc" id="L310">        cmb.setPrivate(true); //we start out hidden until cataloged</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if(location != null) {</span>
<span class="nc" id="L312">            storeFileInfo(location, fileLocator, cmb);</span>
        }
<span class="nc" id="L314">        String resource = multipartReq.getParameter(&quot;relatedItem&quot;);</span>
<span class="nc" id="L315">        String kind = multipartReq.getParameter(&quot;relationType&quot;);</span>
<span class="nc" id="L316">        String description = multipartReq.getParameter(&quot;relationDescription&quot;);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">        if(resource != null) {</span>
<span class="nc" id="L318">            RelationBean relation = new RelationBean();</span>
<span class="nc" id="L319">            relation.setResource(resource);</span>
<span class="nc" id="L320">            relation.setKind(kind);</span>
<span class="nc" id="L321">            relation.setDescription(description);</span>
<span class="nc" id="L322">            cmb.addRelation(relation);</span>
        }
        
        String list[];
        String value;

<span class="nc" id="L328">        list = multipartReq.getParameterValues(&quot;copyrightHolder&quot;);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if(list != null) {</span>
<span class="nc" id="L330">            int a = list.length;</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">            for(int iter = 0; iter &lt; a; iter++) {</span>
<span class="nc" id="L332">                value = list[iter];</span>
<span class="nc" id="L333">                CopyrightHolderBean ddb = new CopyrightHolderBean();</span>
<span class="nc" id="L334">                ddb.setVCard(value); //XXX we aren't really storing a VCARD here</span>
<span class="nc" id="L335">                cmb.addCopyrightHolder(ddb);</span>
            }
        }
<span class="nc" id="L338">        list = multipartReq.getParameterValues(&quot;contributorInfo&quot;);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if(list != null) {</span>
<span class="nc" id="L340">            int a = list.length;</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">            for(int iter = 0; iter &lt; a; iter++) {</span>
<span class="nc" id="L342">                VCardBean vCard = new VCardBean();</span>
<span class="nc" id="L343">                value = list[iter];</span>
<span class="nc" id="L344">                ContributorBean cb = new ContributorBean();</span>
<span class="nc" id="L345">                String[] nestedValues = value.split(&quot;\\|&quot;);</span>
          
<span class="nc bnc" id="L347" title="All 2 branches missed.">                if(nestedValues.length == 7)</span>
                {
<span class="nc" id="L349">                  cb.setRole(trimString(nestedValues[0]));</span>
<span class="nc" id="L350">                  final String lastName = trimString(nestedValues[1]);</span>
<span class="nc" id="L351">                  cb.setLastName(lastName);</span>
<span class="nc" id="L352">                  vCard.setLastName(lastName);</span>
<span class="nc" id="L353">                  final String firstName = trimString(nestedValues[2]);</span>
<span class="nc" id="L354">                  cb.setFirstName(firstName);</span>
<span class="nc" id="L355">                  vCard.setFirstName(firstName);</span>
<span class="nc" id="L356">                  vCard.setMiddleName(trimString(nestedValues[3]));</span>
<span class="nc" id="L357">                  vCard.setTitle(trimString(nestedValues[4]));</span>
<span class="nc" id="L358">                  final String org = trimString(nestedValues[5]);</span>
<span class="nc" id="L359">                  cb.setOrganization(org);</span>
<span class="nc" id="L360">                  vCard.setOrganization(org);</span>
<span class="nc" id="L361">                  final String email = trimString(nestedValues[6]);</span>
<span class="nc" id="L362">                  cb.setEmail(email);</span>
<span class="nc" id="L363">                  vCard.setEmail(email);</span>
<span class="nc" id="L364">                }</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                else if(nestedValues.length == 8)</span>
                {
<span class="nc" id="L367">                  cb.setRole(trimString(nestedValues[0]));</span>
<span class="nc" id="L368">                  final String lastName = trimString(nestedValues[1]);</span>
<span class="nc" id="L369">                  cb.setLastName(lastName);</span>
<span class="nc" id="L370">                  vCard.setLastName(lastName);</span>
<span class="nc" id="L371">                  final String firstName = trimString(nestedValues[2]);</span>
<span class="nc" id="L372">                  cb.setFirstName(firstName);</span>
<span class="nc" id="L373">                  vCard.setFirstName(firstName);</span>
<span class="nc" id="L374">                  vCard.setMiddleName(trimString(nestedValues[3]));</span>
<span class="nc" id="L375">                  vCard.setTitle(trimString(nestedValues[4]));</span>
<span class="nc" id="L376">                  final String org = trimString(nestedValues[5]);</span>
<span class="nc" id="L377">                  cb.setOrganization(org);</span>
<span class="nc" id="L378">                  vCard.setOrganization(org);</span>
<span class="nc" id="L379">                  final String email = trimString(nestedValues[6]);</span>
<span class="nc" id="L380">                  cb.setEmail(email);</span>
<span class="nc" id="L381">                  vCard.setEmail(email);</span>
<span class="nc" id="L382">                  vCard.setPhone(trimString(nestedValues[7]));</span>
                
<span class="nc" id="L384">                }</span>
                else {
<span class="nc" id="L386">                    System.err.println(&quot;SimpleUploadAction: cannot parse contributor \&quot;&quot; +value+ &quot;\&quot;&quot;);</span>
<span class="nc" id="L387">                    continue;</span>
                }               
<span class="nc" id="L389">                String vCardString = vCard.getVCard();</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">                if(null != vCardString) {</span>
<span class="nc" id="L391">                    cb.setVCard(vCardString);</span>
                } else {
<span class="nc" id="L393">                    cb.setVCard(value); //XXX we aren't really storing a VCARD here</span>
                }
<span class="nc" id="L395">                cmb.addContributor(cb);</span>
            }
        }

<span class="nc" id="L399">        list = multipartReq.getParameterValues(&quot;license&quot;);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">        if(list != null) {</span>
<span class="nc" id="L401">            int a = list.length;</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">            for(int iter = 0; iter &lt; a; iter++) {</span>
<span class="nc" id="L403">                value = list[iter];</span>
<span class="nc" id="L404">                CopyrightTextBean ddb = new CopyrightTextBean();</span>
<span class="nc" id="L405">                ddb.setCopyrightText(value);</span>
<span class="nc" id="L406">                CopyrightBean cb = new CopyrightBean();</span>
<span class="nc" id="L407">                cb.setCopyrightText(ddb);</span>
<span class="nc" id="L408">                cmb.addCopyright(cb);</span>
            }
        }

<span class="nc" id="L412">        list = multipartReq.getParameterValues(&quot;context&quot;);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if(list != null) {</span>
<span class="nc" id="L414">            int a = list.length;</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">            for(int iter = 0; iter &lt; a; iter++) {</span>
<span class="nc" id="L416">                value = list[iter];</span>
<span class="nc" id="L417">                ContextURLBean ddb = new ContextURLBean();</span>
<span class="nc" id="L418">                ddb.setContextURL(value);</span>
<span class="nc" id="L419">                cmb.addContextURL(ddb);</span>
            }
        }

<span class="nc" id="L423">        list = multipartReq.getParameterValues(&quot;targetUserGroup&quot;);</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">        if(list != null) {</span>
<span class="nc" id="L425">            int a = list.length;</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">            for(int iter = 0; iter &lt; a; iter++) {</span>
<span class="nc" id="L427">                value = list[iter];</span>
<span class="nc" id="L428">                TargetUserGroupBean tugb = new TargetUserGroupBean();</span>
<span class="nc" id="L429">                tugb.setTargetUserGroup(value);</span>
<span class="nc" id="L430">                cmb.addTargetUserGroup(tugb);</span>
            }
        }

<span class="nc" id="L434">        list = multipartReq.getParameterValues(&quot;browserReq&quot;);</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">        if(list != null) {</span>
<span class="nc" id="L436">            int a = list.length;</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">            for(int iter = 0; iter &lt; a; iter++) {</span>
<span class="nc" id="L438">                value = list[iter];</span>
<span class="nc" id="L439">                RequirementBean ddb = new RequirementBean();</span>
<span class="nc" id="L440">                ddb.setRequirementType(RequirementBean.BROWSER);</span>
<span class="nc" id="L441">                ddb.setRequirementName(value);</span>
<span class="nc" id="L442">                cmb.addRequirement(ddb);</span>
            }
        }

<span class="nc" id="L446">        list = multipartReq.getParameterValues(&quot;operatingReq&quot;);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if(list != null) {</span>
<span class="nc" id="L448">            int a = list.length;</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">            for(int iter = 0; iter &lt; a; iter++) {</span>
<span class="nc" id="L450">                value = list[iter];</span>
<span class="nc" id="L451">                RequirementBean ddb = new RequirementBean();</span>
<span class="nc" id="L452">                ddb.setRequirementType(RequirementBean.OS);</span>
<span class="nc" id="L453">                ddb.setRequirementName(value);</span>
<span class="nc" id="L454">                cmb.addRequirement(ddb);</span>
            }
        }

<span class="nc" id="L458">        list = multipartReq.getParameterValues(&quot;keywords&quot;);</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if(list != null) {</span>
<span class="nc" id="L460">            int a = list.length;</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">            for(int iter = 0; iter &lt; a; iter++) {</span>
<span class="nc" id="L462">                value = list[iter];</span>
<span class="nc" id="L463">                KeywordBean ddb = new KeywordBean();</span>
<span class="nc" id="L464">                ddb.setKeyword(value);</span>
<span class="nc" id="L465">                cmb.addKeyword(ddb);</span>
            }
        }

<span class="nc" id="L469">        value = location;</span>
<span class="nc" id="L470">        value = getMediaType(value);</span>
<span class="nc" id="L471">        FormatBean ddb = new FormatBean();</span>
<span class="nc" id="L472">        ddb.setFormat(value);</span>
<span class="nc" id="L473">        cmb.addFormat(ddb);</span>
<span class="nc" id="L474">    }</span>

    /**
     * A helper method used to store all the file information
     * in the provided metadata.  The location and fileLocator
     * are used to gain a handle on the File, at which point the
     * size, name, extension, and location are set in the
     * metadata bean.
     */
    private static void storeFileInfo(String location, FileLocator fileLocator, MetadataBean metadata) {
<span class="nc bnc" id="L484" title="All 2 branches missed.">        if(location.startsWith(&quot;http&quot;)) {</span>
<span class="nc" id="L485">            metadata.setFileName(location);</span>
        } else {

<span class="nc" id="L488">            File content = new File(fileLocator.getUploadFilePath(), location);</span>
<span class="nc" id="L489">            System.err.println(fileLocator.getUploadFilePath());</span>
<span class="nc" id="L490">            System.err.println(location);</span>
<span class="nc bnc" id="L491" title="All 4 branches missed.">            if(content.exists() &amp;&amp; content.isFile()) {</span>
<span class="nc" id="L492">                metadata.setLocation(location);</span>
<span class="nc" id="L493">                String name = content.getName();</span>
<span class="nc" id="L494">                metadata.setFileName(name);</span>
<span class="nc" id="L495">                metadata.setFileSize(String.valueOf(content.length()));</span>
            }
        }
<span class="nc" id="L498">    }</span>

  /**
     * Takes information from the parametersMap and, using
     * the request.setAttribute method, places it in the request
     * such that the upload form can easily look it up and display
     * it to the user.  This method is meant to be used in the case
     * that an error occured during the upload processing (such
     * as a missing parameter) and we need the user to resubmit
     * their request.  This method sets the attributes so that
     * the previously set fields in the form can be filled in
     * and the user doesn't have to completely refill the form.
     * Because we are using an encoding type of multipart/form-data
     * to upload the form and file, the request's parameters are
     * not set (we have to read these manually), then we need to
     * set them before we forward the request to another page
     * that wants to use them.
     * If an attribute is not supposed to have multiple settings
     * such as the title or description, the attribute that is
     * set is a String, if the attribute does have multiple
     * settings, such as keywords or organ, then the attribute
     * that is set is a String array (String[]).
     * The parameters that are set are: (* denotes multiple)
     * mediaType
     * browserReq*
     * operatingReq*
     * title
     * description
     * annotated
     * context*
     * specimenType
     * radiographType
     * mriType
     * orientation
     * magnification
     * diseaseProcess
     * diseaseDiagnosis
     * clinicalHistory
     * learnContext
     * inappropriate
     * keywords*
     * organ*
     * copyrightHolder
     * copyrightMessage
     * relatedItem
     * relationType
     * relationDescription
     */
  
     public static void setupAttributes(HttpServletRequest request, MultipartRequest multiPartReq) {
<span class="nc" id="L548">        setStringAttribute(request, &quot;mediaType&quot;, multiPartReq);</span>
<span class="nc" id="L549">        setArrayAttribute(request, &quot;browserReq&quot;, multiPartReq);</span>
<span class="nc" id="L550">        setArrayAttribute(request, &quot;operatingReq&quot;, multiPartReq);</span>
<span class="nc" id="L551">        setStringAttribute(request, &quot;title&quot;, multiPartReq);</span>
<span class="nc" id="L552">        setStringAttribute(request, &quot;description&quot;, multiPartReq);</span>
<span class="nc" id="L553">        setStringAttribute(request, &quot;annotated&quot;, multiPartReq);</span>
<span class="nc" id="L554">        setArrayAttribute(request, &quot;context&quot;, multiPartReq);</span>
<span class="nc" id="L555">        setStringAttribute(request, &quot;specimenType&quot;, multiPartReq);</span>
<span class="nc" id="L556">        setStringAttribute(request, &quot;radiographType&quot;, multiPartReq);</span>
<span class="nc" id="L557">        setStringAttribute(request, &quot;mriType&quot;, multiPartReq);</span>
<span class="nc" id="L558">        setStringAttribute(request, &quot;orientation&quot;, multiPartReq);</span>
<span class="nc" id="L559">        setStringAttribute(request, &quot;magnification&quot;, multiPartReq);</span>
<span class="nc" id="L560">        setStringAttribute(request, &quot;diseaseProcess&quot;, multiPartReq);</span>
<span class="nc" id="L561">        setStringAttribute(request, &quot;diseaseDiagnosis&quot;, multiPartReq);</span>
<span class="nc" id="L562">        setStringAttribute(request, &quot;clinicalHistory&quot;, multiPartReq);</span>
<span class="nc" id="L563">        setStringAttribute(request, &quot;learnContext&quot;, multiPartReq);</span>
<span class="nc" id="L564">        setStringAttribute(request, &quot;inappropriate&quot;, multiPartReq);</span>
<span class="nc" id="L565">        setArrayAttribute(request, &quot;keywords&quot;, multiPartReq);</span>
<span class="nc" id="L566">        setStringAttribute(request, &quot;copyrightHolder&quot;, multiPartReq);</span>
<span class="nc" id="L567">        setArrayAttribute(request, &quot;contributorInfo&quot;, multiPartReq);</span>
<span class="nc" id="L568">        setStringAttribute(request, &quot;copyrightMessage&quot;, multiPartReq);</span>
<span class="nc" id="L569">        setStringAttribute(request, &quot;relatedItem&quot;, multiPartReq);</span>
<span class="nc" id="L570">        setStringAttribute(request, &quot;relationType&quot;, multiPartReq);</span>
<span class="nc" id="L571">        setStringAttribute(request, &quot;relationDescription&quot;, multiPartReq);</span>
<span class="nc" id="L572">        setStringAttribute(request, &quot;q_1&quot;, multiPartReq);</span>
<span class="nc" id="L573">        setStringAttribute(request, &quot;q_2&quot;, multiPartReq);</span>
<span class="nc" id="L574">        setStringAttribute(request, &quot;q_3&quot;, multiPartReq);</span>
<span class="nc" id="L575">        setStringAttribute(request, &quot;targetUserGroup&quot;, multiPartReq);</span>
<span class="nc" id="L576">        setStringAttribute(request, &quot;publicationName&quot;, multiPartReq);</span>
<span class="nc" id="L577">        setStringAttribute(request, &quot;creationDate&quot;, multiPartReq);</span>
<span class="nc" id="L578">        setStringAttribute(request, &quot;learningResourceType&quot;, multiPartReq);</span>
<span class="nc" id="L579">        setStringAttribute(request, &quot;locationfile&quot;, multiPartReq);</span>
<span class="nc" id="L580">        setStringAttribute(request, &quot;fileName&quot;, multiPartReq);</span>
<span class="nc" id="L581">    }</span>
     /**
     * Looks up the attribute in the parametersMap, takes that setting
     * (if it isn't null) and sets an attribute in the request
     * with the given name and the discovered values.  The value
     * of the attribute is a String[] of all of the values found
     * in the parametersMap that correspond to the given attributeName
     */
    private static void setArrayAttribute(HttpServletRequest request, String attributeName, MultipartRequest multiPartReq) {
<span class="nc" id="L590">        String[] stringArray = multiPartReq.getParameterValues(attributeName);</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">        if(stringArray != null) {</span>
<span class="nc" id="L592">            request.setAttribute(attributeName, stringArray);</span>
        }
<span class="nc" id="L594">    }</span>
    /**
     * Looks up the attribute in the parametersMap, takes that setting
     * (if it isn't null) and sets an attribute in the request
     * with the given name and the discovered value.
     */
    private static void setStringAttribute(HttpServletRequest request, String attributeName, MultipartRequest multipartReq) {
<span class="nc" id="L601">        String aString = multipartReq.getParameter(attributeName);</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if(aString != null) {</span>
<span class="nc" id="L603">            request.setAttribute(attributeName, aString);</span>
        }
<span class="nc" id="L605">    }</span>
    
  /**
     * Given a complete metadata beans and two hashmaps, looks up the
     * requirements associated with the metadata and separates the
     * requirements into those related to the user's web browser and
     * those related to the user's operating system.  Each entry is
     * added to the hash map as the key, with SELECTED as the value.
     * This is intended for use in jsp pages where a select input is
     * being generated.
     */
     public static void separateRequirements(CompleteMetadataBean cmb, HashMap browserMap, HashMap operatingMap) {
<span class="nc" id="L617">        ArrayList requirements = cmb.getRequirements();</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if(requirements != null) {</span>
<span class="nc" id="L619">            Iterator iter = requirements.iterator();</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">            while(iter.hasNext()) {</span>
<span class="nc" id="L621">                RequirementBean requirement = (RequirementBean)iter.next();</span>
<span class="nc" id="L622">                String type = requirement.getRequirementType();</span>
<span class="nc" id="L623">                String name = requirement.getRequirementName();</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                if(name != null) {</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                    if(RequirementBean.BROWSER.equalsIgnoreCase(type)) {</span>
<span class="nc" id="L626">                        browserMap.put(name, &quot;SELECTED&quot;);</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                    } else if(RequirementBean.OS.equalsIgnoreCase(type)) {</span>
<span class="nc" id="L628">                        operatingMap.put(name, &quot;SELECTED&quot;);</span>
                    }
                }
<span class="nc" id="L631">            }</span>
        }
<span class="nc" id="L633">    }</span>

    
    

    /**
     * Determines the media file type based on the file extension (from filename)
     * If filename startsWith &quot;http://&quot; media file Type is web page
     */
    private static String getMediaType(String fileName) {
        int index;
<span class="nc" id="L644">        String fileExtension = null;</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">        if((index = fileName.lastIndexOf(&quot;.&quot;)) != -1) {</span>
<span class="nc" id="L646">            fileExtension = fileName.substring(index + 1);</span>
        }
<span class="nc" id="L648">        String mediaType = mediaTypes.get(fileExtension);</span>
<span class="nc bnc" id="L649" title="All 2 branches missed.">        if(mediaType == null) {</span>
<span class="nc" id="L650">            mediaType = &quot;unknown&quot;;</span>
        }
<span class="nc bnc" id="L652" title="All 4 branches missed.">        if((&quot;unknown&quot;.equals(mediaTypes)) &amp;&amp; (fileName.startsWith(&quot;http&quot;))) {</span>
<span class="nc" id="L653">            mediaType = &quot;text/htm&quot;;</span>
        }
<span class="nc" id="L655">        return mediaType;</span>
    }

    /**
     * Trims any extra whitespace from the beginning and end of a value -- if
     * that results in an empty string, this method returns &lt;code&gt;null&lt;/code&gt;.
     *
     * @param value A non-null String.
     * @return A trimmed String or null if the string is empty.
     */
    private final static String trimString(String value) {
<span class="nc" id="L666">        String ret = value.trim();</span>
<span class="nc bnc" id="L667" title="All 2 branches missed.">        return (ret.length() &gt; 0 ? ret : null);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>