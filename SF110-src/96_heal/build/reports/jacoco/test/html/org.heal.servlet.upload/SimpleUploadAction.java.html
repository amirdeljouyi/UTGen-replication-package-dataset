<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleUploadAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet.upload</a> &gt; <span class="el_source">SimpleUploadAction.java</span></div><h1>SimpleUploadAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet.upload;

import com.oreilly.servlet.MultipartRequest;
import org.heal.module.catalog.QueueDAO;
import org.heal.module.catalog.QueuedRecordBean;
import org.heal.module.metadata.CompleteMetadataBean;
import org.heal.module.metadata.MetadataDAO;
import org.heal.module.metadata.MetametadataIdentifierBean;
import org.heal.module.upload.UploadServicesBean;
import org.heal.servlet.Action;
import org.heal.util.FileLocator;
import org.heal.util.CommonDAO;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;



<span class="nc" id="L28">public class SimpleUploadAction implements Action {</span>
   
    public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
            throws IOException, ServletException {

        RequestDispatcher rd;     
<span class="nc" id="L34">        CompleteMetadataBean completeMetadata = (CompleteMetadataBean)request.getSession().getAttribute(&quot;completeMetadata&quot;);</span>
<span class="nc" id="L35">        MultipartRequest multiPartReq = (MultipartRequest)request.getSession().getAttribute(&quot;requestParameters&quot;);</span>
       
<span class="nc" id="L37">        Map parameters = new HashMap();</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">        for(Enumeration enumeration = multiPartReq.getParameterNames(); enumeration.hasMoreElements();) {</span>
<span class="nc" id="L39">            final String parameterName = (String)enumeration.nextElement();</span>
<span class="nc" id="L40">            final String[] parameterValues = multiPartReq.getParameterValues(parameterName);</span>
<span class="nc" id="L41">            parameters.put(parameterName, parameterValues);</span>
<span class="nc" id="L42">        }</span>
<span class="nc" id="L43">        FileLocator healFileLocator = (FileLocator)servlet.getServletContext().getAttribute(&quot;healFileLocator&quot;);</span>
<span class="nc" id="L44">        UploadServicesBean uploadServices = (UploadServicesBean)servlet.getServletContext().getAttribute(&quot;uploadServices&quot;);</span>
<span class="nc" id="L45">        MetadataDAO metadataServices = (MetadataDAO)servlet.getServletContext().getAttribute(&quot;MetadataDAO&quot;);</span>
<span class="nc" id="L46">        final QueueDAO queueManager = (QueueDAO)servlet.getServletContext().getAttribute(&quot;QueueDAO&quot;);</span>
<span class="nc" id="L47">        final CommonDAO commonServices = (CommonDAO)servlet.getServletContext().getAttribute(&quot;CommonDAO&quot;);</span>
<span class="nc" id="L48">        String format = completeMetadata.getFormat();</span>
<span class="nc" id="L49">        String location = completeMetadata.getLocation();</span>
<span class="nc" id="L50">        String converted = healFileLocator.convertLocationToFilePath(location);</span>
<span class="nc" id="L51">        String path = healFileLocator.getUploadFilePath() + File.separator + converted;</span>

<span class="nc bnc" id="L53" title="All 2 branches missed.">        if((format.toLowerCase()).startsWith(&quot;Image&quot;.toLowerCase())) {</span>
<span class="nc" id="L54">            uploadServices.processImage(completeMetadata, path);</span>
<span class="nc bnc" id="L55" title="All 4 branches missed.">        } else if(&quot;Video&quot;.equalsIgnoreCase(format) || &quot;Animation&quot;.equalsIgnoreCase(format)) {</span>
<span class="nc" id="L56">            uploadServices.processVideo(completeMetadata, path);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        } else if(&quot;Audio&quot;.equalsIgnoreCase(format)) {</span>
<span class="nc" id="L58">            uploadServices.processAudio(completeMetadata, path);</span>
        }
        try {
<span class="nc" id="L61">            metadataServices.saveCompleteMetadata(completeMetadata);</span>
            // since we need a metadata id for this part...
<span class="nc" id="L63">            MetametadataIdentifierBean mib = new MetametadataIdentifierBean();</span>
<span class="nc" id="L64">            mib.setCatalog(&quot;http://www.healcentral.org/&quot;);</span>
<span class="nc" id="L65">            mib.setEntry(completeMetadata.getMetadataId());</span>
<span class="nc" id="L66">            mib.setMetadataId(completeMetadata.getMetadataId());</span>
<span class="nc" id="L67">            completeMetadata.getMetametadataIdentifiers().add(mib);</span>
<span class="nc" id="L68">            metadataServices.saveMetametadataIdentifier(mib);</span>
<span class="nc" id="L69">        } catch(SQLException e) {</span>
<span class="nc" id="L70">                throw new ServletException(e);</span>
<span class="nc" id="L71">        }</span>
<span class="nc" id="L72">        QueuedRecordBean temp = new QueuedRecordBean();</span>
<span class="nc" id="L73">        temp.setType(QueueDAO.TYPE_APPROVAL);</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if(&quot;yes&quot;.equalsIgnoreCase(multiPartReq.getParameter(&quot;revision&quot;))) {</span>
<span class="nc" id="L75">            temp.setComments(&quot;submitted as a revision&quot;);</span>
        }
<span class="nc" id="L77">        temp.setShortMetadata(completeMetadata);</span>
<span class="nc" id="L78">        queueManager.saveQueuedRecord(temp);</span>
<span class="nc" id="L79">        parameters.put(&quot;publicationId&quot;, new String[]{completeMetadata.getPublicationId()});</span>
<span class="nc" id="L80">        request.getSession().setAttribute(&quot;requestParameters&quot;, parameters);</span>
<span class="nc" id="L81">        request.setAttribute(&quot;submissionId&quot;, completeMetadata.getPublicationId());</span>
<span class="nc" id="L82">        rd = request.getRequestDispatcher(&quot;../upload2/uploadformSuccess.jsp&quot;);</span>
<span class="nc" id="L83">        rd.forward(request, response);        </span>
<span class="nc" id="L84">    }</span>
    public boolean actionRequiresLogin() {
<span class="nc" id="L86">        return true;</span>
    }

    /**
     * Takes information from the parametersMap and, using
     * the request.setAttribute method, places it in the request
     * such that the upload form can easily look it up and display
     * it to the user.  This method is meant to be used in the case
     * that an error occured during the upload processing (such
     * as a missing parameter) and we need the user to resubmit
     * their request.  This method sets the attributes so that
     * the previously set fields in the form can be filled in
     * and the user doesn't have to completely refill the form.
     * Because we are using an encoding type of multipart/form-data
     * to upload the form and file, the request's parameters are
     * not set (we have to read these manually), then we need to
     * set them before we forward the request to another page
     * that wants to use them.
     * If an attribute is not supposed to have multiple settings
     * such as the title or description, the attribute that is
     * set is a String, if the attribute does have multiple
     * settings, such as keywords or organ, then the attribute
     * that is set is a String array (String[]).
     * The parameters that are set are: (* denotes multiple)
     * mediaType
     * browserReq*
     * operatingReq*
     * title
     * description
     * annotated
     * context*
     * specimenType
     * radiographType
     * mriType
     * orientation
     * magnification
     * diseaseProcess
     * diseaseDiagnosis
     * clinicalHistory
     * learnContext
     * inappropriate
     * keywords*
     * organ*
     * copyrightHolder
     * copyrightMessage
     * relatedItem
     * relationType
     * relationDescription
     */
    public static void setupAttributes(HttpServletRequest request, Map parameters) {
<span class="nc" id="L136">        setStringAttribute(request, &quot;title&quot;, parameters);</span>
<span class="nc" id="L137">        setStringAttribute(request, &quot;description&quot;, parameters);</span>
<span class="nc" id="L138">        setStringAttribute(request, &quot;annotated&quot;, parameters);</span>
<span class="nc" id="L139">        setArrayAttribute(request, &quot;context&quot;, parameters);</span>
<span class="nc" id="L140">        setStringAttribute(request, &quot;specimenType&quot;, parameters);</span>
<span class="nc" id="L141">        setStringAttribute(request, &quot;radiographType&quot;, parameters);</span>
<span class="nc" id="L142">        setStringAttribute(request, &quot;mriType&quot;, parameters);</span>
<span class="nc" id="L143">        setStringAttribute(request, &quot;orientation&quot;, parameters);</span>
<span class="nc" id="L144">        setStringAttribute(request, &quot;magnification&quot;, parameters);</span>
<span class="nc" id="L145">        setStringAttribute(request, &quot;diseaseProcess&quot;, parameters);</span>
<span class="nc" id="L146">        setStringAttribute(request, &quot;diseaseDiagnosis&quot;, parameters);</span>
<span class="nc" id="L147">        setStringAttribute(request, &quot;clinicalHistory&quot;, parameters);</span>
<span class="nc" id="L148">        setStringAttribute(request, &quot;learnContext&quot;, parameters);</span>
<span class="nc" id="L149">        setStringAttribute(request, &quot;inappropriate&quot;, parameters);</span>
<span class="nc" id="L150">        setArrayAttribute(request, &quot;keywords&quot;, parameters);</span>
<span class="nc" id="L151">        setStringAttribute(request, &quot;copyrightHolder&quot;, parameters);</span>
<span class="nc" id="L152">        setArrayAttribute(request, &quot;contributorInfo&quot;, parameters);</span>
<span class="nc" id="L153">        setStringAttribute(request, &quot;copyrightMessage&quot;, parameters);</span>
<span class="nc" id="L154">        setStringAttribute(request, &quot;relatedItem&quot;, parameters);</span>
<span class="nc" id="L155">        setStringAttribute(request, &quot;relationType&quot;, parameters);</span>
<span class="nc" id="L156">        setStringAttribute(request, &quot;relationDescription&quot;, parameters);</span>
<span class="nc" id="L157">        setStringAttribute(request, &quot;q_1&quot;, parameters);</span>
<span class="nc" id="L158">        setStringAttribute(request, &quot;q_2&quot;, parameters);</span>
<span class="nc" id="L159">        setStringAttribute(request, &quot;q_3&quot;, parameters);</span>
<span class="nc" id="L160">        setArrayListAttribute(request, &quot;targetUserGroup&quot;, parameters);</span>
<span class="nc" id="L161">        setStringAttribute(request, &quot;publicationName&quot;, parameters);</span>
<span class="nc" id="L162">        setStringAttribute(request, &quot;creationDate&quot;, parameters);</span>
<span class="nc" id="L163">        setStringAttribute(request, &quot;learningResourceType&quot;, parameters);</span>
<span class="nc" id="L164">        setStringAttribute(request, &quot;revision&quot;, parameters);</span>
<span class="nc" id="L165">        setStringAttribute(request, &quot;publicationId&quot;, parameters);</span>
<span class="nc" id="L166">        setStringAttribute(request, &quot;locationfile&quot;, parameters);</span>
<span class="nc" id="L167">        setStringAttribute(request, &quot;fileName&quot;, parameters);</span>
<span class="nc" id="L168">    }</span>
      /**
     * Looks up the attribute in the parametersMap, takes that setting
     * (if it isn't null) and sets an attribute in the request
     * with the given name and the discovered values.  The value
     * of the attribute is a String[] of all of the values found
     * in the parametersMap that correspond to the given attributeName
     */
      private static void setArrayListAttribute(HttpServletRequest request, String attributeName, Map parameters) {
<span class="nc" id="L177">        String[] stringArray = (String[])parameters.get(attributeName);</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if(stringArray == null) {</span>
<span class="nc" id="L179">            return;</span>
        }
<span class="nc" id="L181">        ArrayList aList = new ArrayList();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        for(int a = 0; a &lt; stringArray.length; a++) {</span>
<span class="nc" id="L183">            aList.add(stringArray[a]);</span>
        }
<span class="nc" id="L185">        request.setAttribute(attributeName, aList);</span>
<span class="nc" id="L186">    }</span>

   /**
     * Looks up the attribute in the parametersMap, takes that setting
     * (if it isn't null) and sets an attribute in the request
     * with the given name and the discovered value.
     */
     private static void setStringAttribute(HttpServletRequest request, String attributeName, Map parameters) {
<span class="nc" id="L194">        String[] temp = (String[])parameters.get(attributeName);</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">        if(null != temp &amp;&amp; temp.length &gt; 0) {</span>
<span class="nc" id="L196">            request.setAttribute(attributeName, temp[0]);</span>
        }
<span class="nc" id="L198">    }</span>

    /**
     * Looks up the attribute in the parametersMap, takes that setting
     * (if it isn't null) and sets an attribute in the request
     * with the given name and the discovered values.  The value
     * of the attribute is a String[] of all of the values found
     * in the parametersMap that correspond to the given attributeName
     */
    private static void setArrayAttribute(HttpServletRequest request, String attributeName, Map parameters) {
<span class="nc" id="L208">        String[] stringArray = (String[])parameters.get(attributeName);</span>
<span class="nc" id="L209">        request.setAttribute(attributeName, stringArray);</span>
<span class="nc" id="L210">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>