<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserReviewDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet.userreview</a> &gt; <span class="el_source">UserReviewDAO.java</span></div><h1>UserReviewDAO.java</h1><pre class="source lang-java linenums">package org.heal.servlet.userreview;

import java.sql.SQLException;

import javax.servlet.ServletException;
import javax.sql.DataSource;
import com.ora.jsp.sql.NoSuchColumnException;
import com.ora.jsp.sql.Row;
import com.ora.jsp.sql.UnsupportedConversionException;
import org.heal.servlet.*;
import org.heal.module.metadata.ShortMetadataBean;

import javax.sql.DataSource;
import java.io.Serializable;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import com.ora.jsp.sql.SQLCommandBean;
import com.ora.jsp.sql.UnsupportedTypeException;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.Iterator;
import java.util.Vector;
import javax.servlet.http.HttpServlet;
import org.heal.module.metadata.ThumbnailBean;
import org.heal.util.FileLocator;

// this is where all the database access work is done.
public class UserReviewDAO extends HttpServlet implements Serializable {
<span class="nc" id="L32">    public UserReviewDAO() {}</span>

    private DataSource dataSource;

    // insert new user review.
    private static final String USER_REVIEW_INSERT_SQL = &quot;INSERT INTO UserReviews (MetaDataID, UserID, UserRating, Comments, ReviewDate, Approved, Anonymous) VALUES(?, ?, ?, ?, ?, ?, ?)&quot;;
    // approves user reivew.
    private static final String USER_REVIEW_APPROVAL_SQL = &quot;UPDATE UserReviews SET ApprovalDate = ?, Approved = ? where ReviewID = ?&quot;;
    // get user review.
    private static final String USER_REVIEW_SELECT_SQL = &quot;SELECT ReviewID, MetaDataID, UserRating, Comments, ReviewDate, ApprovalDate, Approved, Anonymous, UserID FROM UserReviews WHERE MetaDataID = '&quot;;
    // calculates average star rating for a reviewed resource.
    private static final String USER_RATING_AVERAGE_SQL = &quot;SELECT AVG(UserRating) as userReviewAVG FROM UserReviews WHERE Approved=1 and MetaDataID = '&quot;;	
    // clears all approved tags.
    private static final String USER_CLEAR_APPROVAL_SQL = &quot;UPDATE UserReviews SET Approved = ? where MetaDataID = ?&quot;;
    // gets all the reviews pending approval.
    private static final String ALL_USER_REVIEW_SELECT_SQL = &quot;SELECT UserReviews.metadataid AS usermetadataid, UserReviews.approved, Metadata.MetadataID AS metametadataid, Metadata.LearningResourceType, Metadata.Title, Metadata.Location AS location, Thumbnails.MetadataID AS thumbmetadataid, Thumbnails.Location AS thumblocation FROM Metadata INNER JOIN (SELECT DISTINCT (metadataid), approved  FROM userreviews) UserReviews ON UserReviews.metadataid = Metadata.MetadataID LEFT OUTER JOIN Thumbnails ON Metadata.MetadataID = Thumbnails.MetadataID WHERE (UserReviews.approved = 0)&quot;;
    // gets the top 10 most highly rated resources.
    private static final String GET_TOP_10_POPULAR_SELECT_SQL = &quot;SELECT TOP 10 AVG(UserReviews.userrating) AS avgur, UserReviews.metadataid AS usermetadataid, Metadata.LearningResourceType, Metadata.Title, Metadata.Location AS location, Thumbnails.Location AS thumblocation FROM Metadata INNER JOIN (SELECT DISTINCT (metadataid), approved, userrating FROM userreviews) UserReviews ON UserReviews.metadataid = Metadata.MetadataID LEFT OUTER JOIN Thumbnails ON Metadata.MetadataID = Thumbnails.MetadataID WHERE     (UserReviews.approved = 1) GROUP BY UserReviews.metadataid, UserReviews.approved, UserReviews.metadataid, Metadata.LearningResourceType, Metadata.Title, Metadata.Location, Thumbnails.Location ORDER BY avgur DESC&quot;;
    // get HEAL user info given the user ID.
    private static final String GET_USER_SELECT_SQL = &quot;SELECT FirstName, LastName, Email FROM Users WHERE UserID = '&quot;;
    
    public void setDataSource(DataSource dataSource) {
<span class="nc" id="L54">        this.dataSource = dataSource;</span>
<span class="nc" id="L55">    }</span>

    // gets the average star rating of a resource. 
    public int getUserRatingAVG (String metadataId) throws SQLException {
<span class="nc" id="L59">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L60">            Vector rs = new Vector();</span>
<span class="nc" id="L61">            Row row = null;</span>
<span class="nc" id="L62">        String sql = USER_RATING_AVERAGE_SQL + metadataId + &quot;'&quot;;</span>
<span class="nc" id="L63">        int AVG=0;</span>

<span class="nc" id="L65">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L66">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L67">        sqlCommandBean.setSqlValue(sql);</span>
        
        try{
<span class="nc" id="L70">            rs = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L71">            Iterator rowIterator = rs.iterator();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            while (rowIterator.hasNext()){</span>
<span class="nc" id="L73">                row = (Row) rowIterator.next();</span>
<span class="nc" id="L74">                AVG = row.getInt(&quot;userReviewAVG&quot;);</span>
            }
        }
<span class="nc" id="L77">        catch (UnsupportedConversionException ex) {</span>
<span class="nc" id="L78">            ex.printStackTrace();</span>
        }                
<span class="nc" id="L80">        catch (NoSuchColumnException ex) {</span>
<span class="nc" id="L81">            ex.printStackTrace();</span>
        }        
<span class="nc" id="L83">        catch (UnsupportedTypeException ute){</span>
<span class="nc" id="L84">            System.err.println(&quot;UnsupportedTypeException: &quot; + ute.getMessage());</span>
        }
        finally {
            try {
<span class="nc" id="L88">                conn.close();</span>
<span class="nc" id="L89">            } catch(SQLException ex) {</span>
<span class="nc" id="L90">                ex.printStackTrace();</span>
<span class="nc" id="L91">            } </span>
        }

<span class="nc" id="L94">        return AVG;</span>
    }
    
    // get all the user review data for a particular resource.
    public ArrayList getUserReview (String metadataId, String status, String orderby) throws SQLException {
<span class="nc" id="L99">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L100">        String sql = null;</span>
<span class="nc" id="L101">        ResultSet rs = null;</span>
<span class="nc" id="L102">        ResultSet rs2 = null;</span>
<span class="nc" id="L103">        String getUsersql = null;</span>

        // this is for sorting the user reviews by different columns. not used.
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (status.equals(&quot;approved&quot;)){</span>
<span class="nc" id="L107">                sql = USER_REVIEW_SELECT_SQL + metadataId + &quot;' and Approved=1 order by &quot; + orderby;</span>
        }
<span class="nc bnc" id="L109" title="All 2 branches missed.">        else if (status.equals(&quot;pending&quot;)){</span>
<span class="nc" id="L110">                sql = USER_REVIEW_SELECT_SQL + metadataId + &quot;' and Approved=0 order by &quot; + orderby;</span>
        }
        else{
<span class="nc" id="L113">                sql = USER_REVIEW_SELECT_SQL + metadataId + &quot;' order by &quot; + orderby;</span>
        }	

        // array for holding user reivew beans.
<span class="nc" id="L117">        ArrayList userReviewArray = new ArrayList();                </span>
        
<span class="nc" id="L119">        Statement selectReview = conn.createStatement();</span>
<span class="nc" id="L120">        Statement selectUser = conn.createStatement();</span>
<span class="nc" id="L121">        rs = selectReview.executeQuery(sql);</span>
        
<span class="nc bnc" id="L123" title="All 2 branches missed.">        while (rs.next()){</span>
<span class="nc" id="L124">            UserReviewBean userReviewBean = new UserReviewBean();</span>

            // put review data retrieved from the database into the bean.
<span class="nc" id="L127">            userReviewBean.setReviewId(Integer.parseInt(rs.getString(&quot;reviewId&quot;)));</span>
<span class="nc" id="L128">            userReviewBean.setMetaDataId(metadataId);</span>
<span class="nc" id="L129">            userReviewBean.setUserRating(Integer.parseInt(rs.getString(&quot;userRating&quot;)));</span>
<span class="nc" id="L130">            userReviewBean.setComments(rs.getString(&quot;comments&quot;));</span>
<span class="nc" id="L131">            userReviewBean.setReviewDate((java.util.Date)rs.getDate(&quot;reviewDate&quot;));</span>
<span class="nc" id="L132">            userReviewBean.setApproved(rs.getBoolean(&quot;approved&quot;));</span>
            
            // get the user name and email if the review is not anonymous.            
<span class="nc bnc" id="L135" title="All 2 branches missed.">            if (!rs.getBoolean(&quot;anonymous&quot;)){</span>
<span class="nc" id="L136">                getUsersql = GET_USER_SELECT_SQL + rs.getString(&quot;UserID&quot;) + &quot;'&quot;;</span>
<span class="nc" id="L137">                rs2 = selectUser.executeQuery(getUsersql);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                while (rs2.next()){</span>
<span class="nc" id="L139">                    userReviewBean.setUser(rs2.getString(&quot;FirstName&quot;)+ &quot; &quot; + rs2.getString(&quot;LastName&quot;));</span>
<span class="nc" id="L140">                    userReviewBean.setEmail(rs2.getString(&quot;Email&quot;));</span>
                }
            }
            else{
<span class="nc" id="L144">                userReviewBean.setUser(&quot;Anonymous&quot;);</span>
            }
            
            // add the bean to the array.
<span class="nc" id="L148">            userReviewArray.add(userReviewBean);</span>
<span class="nc" id="L149">        }</span>
        try {
<span class="nc" id="L151">                conn.close();</span>
<span class="nc" id="L152">            } catch(SQLException ex) {</span>
<span class="nc" id="L153">                ex.printStackTrace();</span>
<span class="nc" id="L154">        } </span>

<span class="nc" id="L156">        return userReviewArray;</span>
    }

    // for user review manager.  lists all user reviews pending approval.
    public ArrayList getAllUserReview(FileLocator healFileLocator) throws ServletException, SQLException{
<span class="nc" id="L161">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L162">        Vector rs = new Vector();</span>
<span class="nc" id="L163">        Row row = null;</span>
<span class="nc" id="L164">	ArrayList userReviewArray = new ArrayList();                </span>
        
<span class="nc" id="L166">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L167">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L168">        sqlCommandBean.setSqlValue(ALL_USER_REVIEW_SELECT_SQL);</span>
             
        try{
<span class="nc" id="L171">            rs = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L172">            Iterator rowIterator = rs.iterator();</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            while (rowIterator.hasNext()){</span>
<span class="nc" id="L174">                ShortMetadataBean smBean = new ShortMetadataBean();</span>
<span class="nc" id="L175">                ThumbnailBean thBean = new ThumbnailBean();</span>
<span class="nc" id="L176">                row = (Row) rowIterator.next();</span>
                
<span class="nc" id="L178">                String restype = row.getString(&quot;learningResourceType&quot;);</span>
                
                // get the thumbnail location.
<span class="nc bnc" id="L181" title="All 2 branches missed.">                if (row.getString(&quot;thumblocation&quot;) != null){</span>
<span class="nc" id="L182">                    thBean.setLocation(healFileLocator.getThumbnailURL(row.getString(&quot;thumblocation&quot;)));</span>
                    
                }
                else{
                    // finding the correct thumbnail for the corresponding type of resource.
<span class="nc bnc" id="L187" title="All 2 branches missed.">                    if (restype.equals(&quot;Animation&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_animation.jpg&quot;));}</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                    else if (restype.equals(&quot;Audio&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_audio.jpg&quot;));}</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    else if (restype.equals(&quot;Case Study&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_caseStudy.jpg&quot;));}</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                    else if (restype.equals(&quot;Diagram&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_illustration.gif&quot;));}</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">                    else if (restype.equals(&quot;Exercise&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_exercise.jpg&quot;));}</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                    else if (restype.equals(&quot;Lecture&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_lecture.jpg&quot;));}</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                    else if (restype.equals(&quot;Other&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_other.jpg&quot;));}</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                    else if (restype.equals(&quot;Tutorial&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_tutorial.jpg&quot;));}</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                    else if (restype.equals(&quot;Video&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_video.jpg&quot;));}</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                    else if (restype.equals(&quot;Virtual Patient&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_virtualPatient.jpg&quot;));}</span>
                }
                
<span class="nc" id="L199">                smBean.setThumbnail(thBean);</span>
<span class="nc" id="L200">                smBean.setLearningResourceType(restype);</span>
<span class="nc" id="L201">                smBean.setLocation(healFileLocator.getContentURL(row.getString(&quot;location&quot;)));                </span>
<span class="nc" id="L202">                smBean.setTitle(row.getString(&quot;title&quot;));</span>
<span class="nc" id="L203">                smBean.setMetadataId(row.getString(&quot;usermetadataid&quot;));</span>
                
<span class="nc" id="L205">                userReviewArray.add(smBean);</span>
<span class="nc" id="L206">            }</span>
        }
<span class="nc" id="L208">        catch (NoSuchColumnException ex) {</span>
        }        
<span class="nc" id="L210">        catch (UnsupportedTypeException ute){</span>
<span class="nc" id="L211">            System.err.println(&quot;UnsupportedTypeException: &quot; + ute.getMessage());</span>
        }
        finally {
            try {
<span class="nc" id="L215">                conn.close();</span>
<span class="nc" id="L216">            } catch(SQLException ex) {</span>
<span class="nc" id="L217">                ex.printStackTrace();</span>
<span class="nc" id="L218">            } </span>
        }

<span class="nc" id="L221">        return userReviewArray;</span>
    }

    // get the top 10 most highly rated resources.
    public ArrayList getTop10(FileLocator healFileLocator) throws ServletException, SQLException{
<span class="nc" id="L226">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L227">        Vector rs = new Vector();</span>
<span class="nc" id="L228">        Row row = null;</span>

<span class="nc" id="L230">	ArrayList userReviewArray = new ArrayList();                </span>
        
<span class="nc" id="L232">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L233">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L234">        sqlCommandBean.setSqlValue(GET_TOP_10_POPULAR_SELECT_SQL);</span>
             
        try{
<span class="nc" id="L237">            rs = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L238">            Iterator rowIterator = rs.iterator();</span>

<span class="nc bnc" id="L240" title="All 2 branches missed.">            while (rowIterator.hasNext()){</span>
<span class="nc" id="L241">                ShortMetadataBean smBean = new ShortMetadataBean();</span>
<span class="nc" id="L242">                ThumbnailBean thBean = new ThumbnailBean();</span>
<span class="nc" id="L243">                row = (Row) rowIterator.next();</span>
                
<span class="nc" id="L245">                String restype = row.getString(&quot;learningResourceType&quot;);</span>
                
                // get the thumbnail location.
<span class="nc bnc" id="L248" title="All 2 branches missed.">                if (row.getString(&quot;thumblocation&quot;) != null){</span>
<span class="nc" id="L249">                    thBean.setLocation(healFileLocator.getThumbnailURL(row.getString(&quot;thumblocation&quot;)));</span>
                    
                }
                else{
                    // finding the correct thumbnail for the corresponding type of resource.
<span class="nc bnc" id="L254" title="All 2 branches missed.">                    if (restype.equals(&quot;Animation&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_animation.jpg&quot;));}</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                    else if (restype.equals(&quot;Audio&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_audio.jpg&quot;));}</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">                    else if (restype.equals(&quot;Case Study&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_caseStudy.jpg&quot;));}</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                    else if (restype.equals(&quot;Diagram&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_illustration.gif&quot;));}</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                    else if (restype.equals(&quot;Exercise&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_exercise.jpg&quot;));}</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                    else if (restype.equals(&quot;Lecture&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_lecture.jpg&quot;));}</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                    else if (restype.equals(&quot;Other&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_other.jpg&quot;));}</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">                    else if (restype.equals(&quot;Tutorial&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_tutorial.jpg&quot;));}</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">                    else if (restype.equals(&quot;Video&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_video.jpg&quot;));}</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">                    else if (restype.equals(&quot;Virtual Patient&quot;)) {thBean.setLocation(healFileLocator.getThumbnailURL(&quot;../images/thumbnails/thb_virtualPatient.jpg&quot;));}</span>
                }
                
                // put all info into the short metadata bean.
<span class="nc" id="L267">                smBean.setThumbnail(thBean);</span>
<span class="nc" id="L268">                smBean.setLearningResourceType(restype);</span>
<span class="nc" id="L269">                smBean.setLocation(healFileLocator.getContentURL(row.getString(&quot;location&quot;)));                </span>
<span class="nc" id="L270">                smBean.setTitle(row.getString(&quot;title&quot;));</span>
<span class="nc" id="L271">                smBean.setMetadataId(row.getString(&quot;usermetadataid&quot;));</span>
                
                // add the bean to the array list.
<span class="nc" id="L274">                userReviewArray.add(smBean);</span>
<span class="nc" id="L275">            }</span>
        }
<span class="nc" id="L277">        catch (NoSuchColumnException ex) {</span>
<span class="nc" id="L278">            ex.printStackTrace();</span>
        }        
<span class="nc" id="L280">        catch (UnsupportedTypeException ute){</span>
<span class="nc" id="L281">            System.err.println(&quot;UnsupportedTypeException: &quot; + ute.getMessage());</span>
        }
        finally {
            try {
<span class="nc" id="L285">                conn.close();</span>
<span class="nc" id="L286">            } catch(SQLException ex) {</span>
<span class="nc" id="L287">                ex.printStackTrace();</span>
<span class="nc" id="L288">            } </span>
        }

<span class="nc" id="L291">        return userReviewArray;</span>
    }

    // used to open a database connection and then calls the function below.
    public void saveUserReview(UserReviewBean userReviewBean) throws SQLException {
<span class="nc" id="L296">        Connection conn = dataSource.getConnection();</span>

        try {
<span class="nc" id="L299">            saveUserReview(userReviewBean, conn);</span>
        } finally {
            try {
<span class="nc" id="L302">                conn.close();</span>
<span class="nc" id="L303">            } catch(SQLException ex) {</span>
<span class="nc" id="L304">                ex.printStackTrace();</span>
<span class="nc" id="L305">            } </span>
        }
<span class="nc" id="L307">    }</span>

    // used to save user reviews into the database.
    public void saveUserReview(UserReviewBean userReviewBean, Connection conn) throws SQLException {
<span class="nc bnc" id="L311" title="All 2 branches missed.">        if(userReviewBean == null) {</span>
<span class="nc" id="L312">            return;</span>
        }

<span class="nc" id="L315">        java.util.Date utilDate = new Date();</span>
<span class="nc" id="L316">        java.sql.Date sqlDate = new java.sql.Date(utilDate.getTime());</span>

        try {
<span class="nc" id="L319">            PreparedStatement ps = conn.prepareStatement(USER_REVIEW_INSERT_SQL);</span>

            // set up all the data to be inputted.
<span class="nc" id="L322">            ps.setString(1, userReviewBean.getMetaDataId());</span>
<span class="nc" id="L323">            ps.setString(2, userReviewBean.getUserId());</span>
<span class="nc" id="L324">            ps.setInt(3, userReviewBean.getUserRating());</span>
<span class="nc" id="L325">            ps.setString(4, userReviewBean.getComments());</span>
<span class="nc" id="L326">            ps.setDate(5, sqlDate);</span>
<span class="nc" id="L327">            ps.setBoolean(6, false);           </span>
<span class="nc" id="L328">            ps.setBoolean(7, userReviewBean.getAnonymous());</span>

            // execute the database update.
<span class="nc" id="L331">            ps.executeUpdate();</span>
        }			
<span class="nc" id="L333">        catch(SQLException e) {</span>
<span class="nc" id="L334">            System.err.println(&quot;SQLException: &quot; + e.getMessage());</span>
<span class="nc" id="L335">        }</span>
<span class="nc" id="L336">    }</span>
    
    // used to open a database connection and then calls the function below.
    public void approveUserReview(UserReviewBean userReviewBean) throws SQLException {
<span class="nc" id="L340">        Connection conn = dataSource.getConnection();</span>
        try {
<span class="nc" id="L342">            approveUserReview(userReviewBean, conn);</span>
<span class="nc" id="L343">            conn.commit();</span>
        } finally {
            try {
<span class="nc" id="L346">                conn.close();</span>
<span class="nc" id="L347">            } catch(SQLException ex) {</span>
<span class="nc" id="L348">                ex.printStackTrace();</span>
<span class="nc" id="L349">            } </span>
        }
<span class="nc" id="L351">    }</span>

    // used to approve user reviews. used after the clearUserReviewApproval function below.
    public void approveUserReview(UserReviewBean userReviewBean, Connection conn) throws SQLException {
<span class="nc bnc" id="L355" title="All 2 branches missed.">        if(userReviewBean == null) {</span>
<span class="nc" id="L356">            System.err.println(&quot;userReviewBean is null&quot;);</span>
<span class="nc" id="L357">            return;</span>
        }

<span class="nc" id="L360">        java.util.Date utilDate = new Date();</span>
<span class="nc" id="L361">        java.sql.Date sqlDate = new java.sql.Date(utilDate.getTime());</span>

        try {
<span class="nc" id="L364">            PreparedStatement ps = conn.prepareStatement(USER_REVIEW_APPROVAL_SQL);</span>
<span class="nc" id="L365">            ps.setDate(1, sqlDate);</span>
<span class="nc" id="L366">            ps.setBoolean(2, userReviewBean.getApproved());                        </span>
<span class="nc" id="L367">            ps.setInt(3, userReviewBean.getReviewId());</span>
<span class="nc" id="L368">            ps.executeUpdate();</span>
        }			
<span class="nc" id="L370">        catch(SQLException ex) {</span>
<span class="nc" id="L371">            System.err.println(&quot;SQLException: &quot; + ex.getMessage());</span>
<span class="nc" id="L372">        }</span>
<span class="nc" id="L373">    }</span>
    
    // used to clear all the existing reviews approved flag.
    public void clearUserReviewApproval(String metadataId) throws SQLException {
<span class="nc" id="L377">        Connection conn = dataSource.getConnection();</span>
        try {
<span class="nc" id="L379">            PreparedStatement ps = conn.prepareStatement(USER_CLEAR_APPROVAL_SQL);</span>
<span class="nc" id="L380">            ps.setBoolean(1, false);                        </span>
<span class="nc" id="L381">            ps.setString(2, metadataId);</span>
<span class="nc" id="L382">            ps.executeUpdate();</span>
        }			
<span class="nc" id="L384">        catch(SQLException ex) {</span>
<span class="nc" id="L385">            System.err.println(&quot;SQLException: &quot; + ex.getMessage());</span>
        }
        finally {
            try {
<span class="nc" id="L389">                conn.close();</span>
<span class="nc" id="L390">            } catch(SQLException ex) {</span>
<span class="nc" id="L391">                ex.printStackTrace();</span>
<span class="nc" id="L392">            } </span>
        }
<span class="nc" id="L394">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>