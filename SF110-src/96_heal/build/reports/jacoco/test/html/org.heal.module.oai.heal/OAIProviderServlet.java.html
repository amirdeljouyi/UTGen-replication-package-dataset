<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OAIProviderServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.module.oai.heal</a> &gt; <span class="el_source">OAIProviderServlet.java</span></div><h1>OAIProviderServlet.java</h1><pre class="source lang-java linenums">/*
 * Created on Dec 16, 2004
 *
 */
package org.heal.module.oai.heal;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Map;
import java.util.StringTokenizer;

import javax.servlet.ServletConfig;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.sql.DataSource;

import org.heal.module.oai.provider.OAIMetadataFormat;
import org.heal.module.oai.provider.OAIProvider;
import org.heal.util.FileLocator;

import com.ora.jsp.sql.DataSourceWrapper;

/**
 * The front end for the HEAL implementation of the OAI provider
 * protocol.  The full configuration options for the OAI provider are
 * as follows:&lt;br&gt;
 * &lt;ul&gt;
 * &lt;li&gt;&lt;code&gt;idPrefix&lt;/code&gt; - the prefix for OAI identifiers generated by this
 * provider. The final identifier is generated as &lt;code&gt;idPrefix&lt;/code&gt;GlobalID.
 * e.g., metadata with the GlobalID &lt;code&gt;XXX-XXXX-XXXX&lt;/code&gt; 
 * an &lt;code&gt;idPrefix&lt;/code&gt; of &lt;code&gt;oai:org.heal:&lt;/code&gt;, would lead to an idetifer 
 * of &lt;code&gt;oai:org:heal:XXX-XXXX-XXXX&lt;/code&gt;.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;resumptionThreshold&lt;/code&gt; - This is the number of records that will 
 * be returned in any one request to ListSets or ListIdentifiers until a
 * resumptionToken is returned.  The default is 10.  A value of zero means no 
 * resumptionTokens will be generated.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;coverage&lt;/code&gt; - This is the value returned in the dublin core coverage 
 * element.  The default is &lt;code&gt;health-sciences&lt;/code&gt;.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;metametadataRole&lt;/code&gt; - The value defined in the metadata's about
 * clause in the response.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;granularity&lt;/code&gt; - The granularity, in Java parsing format 
 * (see SimpleDateFormat).  The default is &quot;yyyy-MM-dd'T'HH:mm:ss'Z'&quot;, and the 
 * minimum granularity supported by the OAI protocol specification is by the day 
 * (YYYY-MM-dd).&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;adminEmails&lt;/code&gt; - a comma separated list of email addresses that
 * are included in response to OAI 'Identify' requests.  The default is: 
 * info@healcentral.org&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;description&lt;/code&gt; - A description of the provider that is included
 * in responses to OAI 'Identify' requests.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;healVCard&lt;/code&gt; - The vCard used to describe HEAL.  This is included in
 * in the about clause of each metadata item in 'GetRecord' and 'ListRecords' requests.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;allowedCollections&lt;/code&gt; - A comma separated list of the allowable collections
 * (as found in the SourceCollection field of the Metadata table) that will be exposed 
 * via the provider.  A value of &lt;code&gt;all&lt;/code&gt; means just that, all collections will
 * be exposed.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;metadataFormats&lt;/code&gt; - A comma separated list of prefix/class combinations
 * defining the metadata formats and their java implementations.  The first portion of each
 * entry specifies the prefix that defines this format (e.g. &quot;oai_dc&quot;).  This is
 * used by OAI harvesters to select the format/namespace of the responses.  An example
 * parameter string is: &lt;code&gt;oai_dc/org.heal.module.oai.provider.oai_dc.OAI_DCMetadataFormat,nsdl_dc/org.heal.module.oai.provider.nsdl_dc.NSDL_DCMetadataFormat&lt;/code&gt;&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;repositoryName&lt;/code&gt; - The name of the repository associated with this OAI provider.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;baseURL&lt;/code&gt; - The URL associated with the oaiprovider servlet.  Defaults to &lt;code&gt;http://www.healcentral.org/heal/oaiprovider&lt;/code&gt;&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;jdbcDriverClassname&lt;/code&gt; - The class name of the jdbc driver to use in connecting to the database.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;jdbcURL&lt;/code&gt; - The URL of the heal database.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;jdbcUser&lt;/code&gt; - The username to use when connecting to the heal database.&lt;/li&gt;
 * &lt;li&gt;&lt;code&gt;jdbcPassword&lt;/code&gt; - The password associated with the username that is used to connect to the heal database.&lt;/li&gt;
 * &lt;/ul&gt;
 * @author Seth Wright
 *
 */
<span class="nc" id="L77">public class OAIProviderServlet extends HttpServlet {</span>
	private static final String defaultIdPrefix = &quot;oai:org.heal:&quot;;
	private static final int defaultResumptionThreshold = 10;
	private static final String defaultCoverage = &quot;health-sciences&quot;;
	private static final String defaultMetametadataRole = &quot;primary&quot;;
	private static final String defaultGranularity = &quot;yyyy-MM-dd'T'HH:mm:ss'Z'&quot;;
<span class="nc" id="L83">	private static final String[] defaultAdminEmails = {&quot;info@healcentral.org&quot;};</span>
<span class="nc" id="L84">	private static final String[] defaultDescriptions = {&quot;The Health Education Assets Library (HEAL) is a digital library of freely accessible, web-based multimedia teaching materials that meet the needs of today's health sciences educators and learners. The HEAL collection currently contains a number of collections of multimedia resources for health sciences undergraduate and professional education, as well as resources for patient and consumer health.&quot;};</span>
	private static final String defaultHealVCard = &quot;begin:vcard\nn:Health Education Assets Library (HEAL)\nurl:http://www.healcentral.org\nemail;type=internet:info@healcentral.org\nfn:Health Education Assets Library (HEAL)\nend:vcard&quot;;
<span class="nc" id="L86">	private static final String[] defaultAllowedCollections = {&quot;Peer Review Pending&quot;,&quot;HEAL Reviewed Collection&quot;};</span>
	private static final String defaultRepositoryName = &quot;Health Education Assets Library&quot;;
	private static final String defaultBaseURL = &quot;http://www.healcentral.org/heal/oaiprovider&quot;;	
<span class="nc" id="L89">	private HEALDataAccessor dataAccessor = null;</span>
	
	/**
	 * Creates the application scope objects used by
	 * JSP pages in this application.
	 */
	public void init() throws ServletException {
<span class="nc" id="L96">		HEALProviderConfig providerConfig = null;	</span>
<span class="nc" id="L97">		DataSource ds = null;</span>

<span class="nc" id="L99">		ServletConfig config = getServletConfig();</span>
<span class="nc" id="L100">		String jdbcDriverClassName = config.getInitParameter(&quot;jdbcDriverClassName&quot;);</span>
<span class="nc" id="L101">		String jdbcURL = config.getInitParameter(&quot;jdbcURL&quot;);</span>
<span class="nc" id="L102">		String jdbcUser = config.getInitParameter(&quot;jdbcUser&quot;);</span>
<span class="nc" id="L103">		String jdbcPassword = config.getInitParameter(&quot;jdbcPassword&quot;);</span>
<span class="nc" id="L104">        String contentPath = config.getInitParameter(&quot;healContentPath&quot;);</span>
<span class="nc" id="L105">        String healBaseURL = config.getInitParameter(&quot;healBaseURL&quot;);</span>
<span class="nc" id="L106">        System.out.println(&quot;content path: &quot;+contentPath);</span>
<span class="nc" id="L107">        System.out.println(&quot;healBaseURL: &quot;+healBaseURL);</span>
<span class="nc" id="L108">		ServletContext context = getServletContext();</span>
		try {
			// use the DataSourceWrapper from the O'Reilly JSP library
<span class="nc" id="L111">			ds = new DataSourceWrapper(jdbcDriverClassName, jdbcURL, jdbcUser, jdbcPassword);</span>
<span class="nc" id="L112">		} catch(Exception e) {</span>
<span class="nc" id="L113">			throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
					&quot; due to an inability to open a &quot; +
					&quot; connection to the database.  Reason:&quot; +
<span class="nc" id="L116">					e.toString());</span>
<span class="nc" id="L117">		}</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if(ds == null) {</span>
<span class="nc" id="L119">			throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
					&quot; due to an inability to open a &quot; +
					&quot; connection to the database.&quot;);
		}


<span class="nc" id="L125">		String idPrefix = config.getInitParameter(&quot;idPrefix&quot;);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">		if (idPrefix == null) {</span>
<span class="nc" id="L127">			idPrefix = OAIProviderServlet.defaultIdPrefix;</span>
		}
<span class="nc" id="L129">		String resumptionThresholdStr = config.getInitParameter(&quot;resumptionThreshold&quot;);</span>
<span class="nc" id="L130">		int resumptionThreshold = 0;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">		if (resumptionThresholdStr == null) {</span>
<span class="nc" id="L132">			resumptionThreshold = OAIProviderServlet.defaultResumptionThreshold;</span>
		} else {
			try {
<span class="nc" id="L135">				resumptionThreshold = Integer.parseInt(resumptionThresholdStr);</span>
<span class="nc" id="L136">			} catch (NumberFormatException ex) {</span>
<span class="nc" id="L137">				ex.printStackTrace();</span>
<span class="nc" id="L138">				throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
						&quot; due to an invalid resumptionThreshold config parameter.  The expected&quot; +
						&quot; format is an integer.  The provided parameter was:&quot;+resumptionThresholdStr);
<span class="nc" id="L141">			}</span>
		}
<span class="nc" id="L143">		String coverage = config.getInitParameter(&quot;coverage&quot;);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">		if (coverage == null) {</span>
<span class="nc" id="L145">			coverage = OAIProviderServlet.defaultCoverage;</span>
		}
<span class="nc" id="L147">		String metametadataRole = config.getInitParameter(&quot;metametadataRole&quot;);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">		if (metametadataRole == null) {</span>
<span class="nc" id="L149">			metametadataRole = OAIProviderServlet.defaultMetametadataRole;</span>
		}
<span class="nc" id="L151">		String granularity = config.getInitParameter(&quot;granularity&quot;);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">		if (granularity == null) {</span>
<span class="nc" id="L153">			granularity = OAIProviderServlet.defaultGranularity;</span>
		}
<span class="nc" id="L155">		String descriptionsStr = config.getInitParameter(&quot;description&quot;);</span>
<span class="nc" id="L156">		String[] descriptions = null;</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">		if (descriptionsStr == null) {</span>
<span class="nc" id="L158">			descriptions = OAIProviderServlet.defaultDescriptions;</span>
		} else {
<span class="nc" id="L160">			descriptions = new String[1];</span>
<span class="nc" id="L161">			descriptions[0] = descriptionsStr;</span>
		}
<span class="nc" id="L163">		String adminEmailsStr = config.getInitParameter(&quot;adminEmails&quot;);</span>
<span class="nc" id="L164">		String[] adminEmails = null;</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (adminEmailsStr == null) {</span>
<span class="nc" id="L166">			adminEmails = OAIProviderServlet.defaultAdminEmails;</span>
		} else {
<span class="nc" id="L168">			ArrayList list = new ArrayList();</span>
<span class="nc" id="L169">			StringTokenizer tokenizer = new StringTokenizer(adminEmailsStr,&quot;,&quot;);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">			while (tokenizer.hasMoreTokens()) {</span>
<span class="nc" id="L171">				list.add(tokenizer.nextToken());</span>
			}
<span class="nc bnc" id="L173" title="All 2 branches missed.">			if (list.size() &gt; 0) {</span>
<span class="nc" id="L174">				adminEmails = new String[list.size()];</span>
<span class="nc" id="L175">				Iterator iter = list.iterator();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">				for (int i=0;iter.hasNext();i++) {</span>
<span class="nc" id="L177">					adminEmails[i] = (String)iter.next();</span>
				}
			}
		}
<span class="nc" id="L181">		String healVCard = config.getInitParameter(&quot;healVCard&quot;);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">		if (healVCard == null) {</span>
<span class="nc" id="L183">			healVCard = OAIProviderServlet.defaultHealVCard;</span>
		}
<span class="nc" id="L185">		String allowedCollectionsStr = config.getInitParameter(&quot;allowedCollections&quot;);</span>
<span class="nc" id="L186">		String[] allowedCollections = null;</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">		if (allowedCollectionsStr == null) {</span>
<span class="nc" id="L188">			allowedCollections = OAIProviderServlet.defaultAllowedCollections;</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">		} else if (!&quot;all&quot;.equalsIgnoreCase(allowedCollectionsStr)) {</span>
			//if we have 'all' then we leave it as null because the 
			//HealDataAccessor interprets that as it should include all source collections
<span class="nc" id="L192">			ArrayList list = new ArrayList();</span>
<span class="nc" id="L193">			StringTokenizer tokenizer = new StringTokenizer(allowedCollectionsStr,&quot;,&quot;);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">			while (tokenizer.hasMoreTokens()) {</span>
<span class="nc" id="L195">				list.add(tokenizer.nextToken());</span>
			}
<span class="nc bnc" id="L197" title="All 2 branches missed.">			if (list.size() &gt; 0) {</span>
<span class="nc" id="L198">				allowedCollections = new String[list.size()];</span>
<span class="nc" id="L199">				Iterator iter = list.iterator();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">				for (int i=0;iter.hasNext();i++) {</span>
<span class="nc" id="L201">					allowedCollections[i] = (String)iter.next();</span>
				}
			}
		}
<span class="nc" id="L205">		String formatsString = config.getInitParameter(&quot;metadataFormats&quot;);</span>
<span class="nc" id="L206">		OAIMetadataFormat[] formats = getMetadataFormats(formatsString);</span>
<span class="nc" id="L207">		String repositoryName = config.getInitParameter(&quot;repositoryName&quot;);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">		if (repositoryName == null) {</span>
<span class="nc" id="L209">			repositoryName = defaultRepositoryName;</span>
		}
<span class="nc" id="L211">		String baseURL = config.getInitParameter(&quot;baseURL&quot;);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">		if (baseURL == null) {</span>
<span class="nc" id="L213">			baseURL = defaultBaseURL;</span>
		}
				
<span class="nc" id="L216">		providerConfig = new HEALProviderConfig(idPrefix,</span>
												resumptionThreshold,
												coverage,
												metametadataRole,
												granularity,
												descriptions,
												adminEmails,
												healVCard,
												allowedCollections,
												repositoryName,
												baseURL,
												formats,
												healBaseURL+'/'+contentPath);
<span class="nc" id="L229">		dataAccessor = new HEALDataAccessor(providerConfig,ds);</span>
		//initialize the provider wrapper
<span class="nc" id="L231">		OAIProvider.init(providerConfig);</span>
<span class="nc" id="L232">	}</span>

	private OAIMetadataFormat[] getMetadataFormats(String formatsString) throws ServletException {
<span class="nc bnc" id="L235" title="All 2 branches missed.">		if (formatsString == null) {</span>
<span class="nc" id="L236">			throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
					&quot; due to a configuration error.  No metadata formats are configured.&quot;);
		} 
<span class="nc" id="L239">		StringTokenizer tokenizer = new StringTokenizer(formatsString,&quot;,&quot;);</span>
<span class="nc" id="L240">		ArrayList formatList = new ArrayList();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">		while (tokenizer.hasMoreTokens()) {</span>
<span class="nc" id="L242">			String formatStr = tokenizer.nextToken();</span>
<span class="nc" id="L243">			int slashIndex = formatStr.indexOf('/');</span>
<span class="nc bnc" id="L244" title="All 4 branches missed.">			if (slashIndex &gt; 0 &amp;&amp; slashIndex &lt; formatStr.length()-1) {</span>
<span class="nc" id="L245">				String prefix = formatStr.substring(0,slashIndex);</span>
<span class="nc" id="L246">				String format = formatStr.substring(slashIndex+1);</span>
				try {
<span class="nc" id="L248">					Class classDefinition = Class.forName(format);</span>
<span class="nc" id="L249">					OAIMetadataFormat formatInstance = (OAIMetadataFormat) classDefinition.newInstance();</span>
<span class="nc" id="L250">					formatInstance.setPrefix(prefix);</span>
<span class="nc" id="L251">					formatList.add(formatInstance);</span>
<span class="nc" id="L252">				} catch (ClassNotFoundException ex) {</span>
<span class="nc" id="L253">					ex.printStackTrace();</span>
<span class="nc" id="L254">					throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
							&quot; due to a configuration error.  Cannot find the following format class in the classpath: &quot;+format);
<span class="nc" id="L256">				} catch (InstantiationException ex2) {</span>
<span class="nc" id="L257">					ex2.printStackTrace();</span>
<span class="nc" id="L258">					throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
							&quot; due to a configuration error.  Cannot instantiate the following format class: &quot;+format);
<span class="nc" id="L260">				} catch (IllegalAccessException e) {</span>
<span class="nc" id="L261">					e.printStackTrace();</span>
<span class="nc" id="L262">					throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
							&quot; due to a configuration error.  Cannot access the following format class: &quot;+format);
<span class="nc" id="L264">				}		 </span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">			} else if (slashIndex &gt;= formatStr.length()-1){</span>
<span class="nc" id="L266">				throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
						&quot; due to a configuration error.  A metadata format parameter is missing the format class: &quot;+formatStr);
			} else {
<span class="nc" id="L269">				throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
						&quot; due to a configuration error.  A metadata format parameter is missing the format prefix: &quot;+formatStr);
			}
<span class="nc" id="L272">		}</span>
<span class="nc" id="L273">		OAIMetadataFormat[] formats = null;</span>
<span class="nc" id="L274">		int listLen = formatList.size();</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">		if (listLen == 0) {</span>
<span class="nc" id="L276">			throw new ServletException(&quot;Unable to initialize HEAL OAI Provider application&quot; +</span>
					&quot; due to a configuration error.  No metadata formats are configured.&quot;);
		}
<span class="nc" id="L279">		formats = new OAIMetadataFormat[listLen];</span>
<span class="nc" id="L280">		Iterator iter = formatList.iterator();</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">		for (int i=0;iter.hasNext();i++) {</span>
<span class="nc" id="L282">			formats[i] = (OAIMetadataFormat) iter.next();</span>
		}
<span class="nc" id="L284">		return formats;</span>
	}


	/**
	 * Refer all get requests to the central processing doPost method.
	 */
	public void doGet(HttpServletRequest request, HttpServletResponse response)
			throws IOException, ServletException {
<span class="nc" id="L293">		doPost(request, response);</span>
<span class="nc" id="L294">	}</span>

	/**
	 */
	public void doPost(HttpServletRequest request, HttpServletResponse response)
			throws IOException, ServletException {
		
<span class="nc" id="L301">		Map parameters = request.getParameterMap();</span>
<span class="nc" id="L302">		Iterator iter = parameters.keySet().iterator();</span>
<span class="nc" id="L303">		HashMap realParameterMap = new HashMap();</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L305">			String param = (String)iter.next();</span>
<span class="nc" id="L306">			realParameterMap.put(param,request.getParameterValues(param));</span>
<span class="nc" id="L307">		}</span>
<span class="nc" id="L308">		String requestURL = request.getRequestURL().toString();</span>
<span class="nc" id="L309">		response.setContentType(&quot;text/xml&quot;);</span>
<span class="nc" id="L310">		response.setCharacterEncoding(&quot;UTF-8&quot;);</span>
<span class="nc" id="L311">		PrintWriter writer = response.getWriter();</span>
<span class="nc" id="L312">		OAIProvider.processRequest(requestURL,dataAccessor,realParameterMap,writer);</span>
<span class="nc" id="L313">		writer.flush();</span>
<span class="nc" id="L314">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>