<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdvSearchAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet.search</a> &gt; <span class="el_source">AdvSearchAction.java</span></div><h1>AdvSearchAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet.search;

import org.heal.module.search.AdvSearchDAO;
import org.heal.module.search.ParameterBean;
import org.heal.module.search.ParameterNode;
import org.heal.module.search.SearchResultBean;
import org.heal.servlet.Action;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;


/**
 * @author Grace/Julie
 * @version 0.1
 */

<span class="nc" id="L21">public class AdvSearchAction implements Action </span>
{
  public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException 
  {
<span class="nc" id="L25">    request.getSession().setAttribute(&quot;searchResults&quot;, null);</span>
<span class="nc" id="L26">    AdvSearchDAO sd = (AdvSearchDAO)servlet.getServletContext().getAttribute(&quot;AdvSearchDAO&quot;);</span>
<span class="nc" id="L27">    request.getSession().setAttribute(&quot;prekeywords&quot;, null);</span>
    SearchResultBean resultBean;
    // searchType is unused for now...
<span class="nc" id="L30">    String searchType = request.getParameter(&quot;searchtype&quot;);</span>
<span class="nc" id="L31">    ParameterBean param = new ParameterBean();</span>
    String columInfo;
<span class="nc" id="L33">    String keyWord=&quot;&quot;;</span>
    String relation;
    ParameterNode pam;
<span class="nc" id="L36">    param.setHidden(false);</span>
    String type;
    String input;
    String logic;
<span class="nc" id="L40">    boolean validate=true;</span>
<span class="nc" id="L41">    String keywords = &quot;&quot;;</span>
<span class="nc" id="L42">    String[] sourceArray =null;</span>
<span class="nc" id="L43">    String[] publicationNames = null;</span>
<span class="nc" id="L44">    String[] primall = {&quot;all&quot;};</span>
<span class="nc bnc" id="L45" title="All 2 branches missed.">    if(searchType == null)</span>
    {
<span class="nc" id="L47">      searchType =&quot;advanced&quot;;</span>
<span class="nc" id="L48">      publicationNames = request.getParameterValues(&quot;publicationName&quot;);</span>
<span class="nc bnc" id="L49" title="All 4 branches missed.">      if((null != publicationNames) &amp;&amp; (!&quot;all&quot;.equals(publicationNames[0]))) </span>
      {
<span class="nc" id="L51">        param.setPublicationNames(publicationNames);</span>
      }
      
<span class="nc" id="L54">      String[] publicationIds = request.getParameterValues(&quot;publicationId&quot;);</span>
<span class="nc bnc" id="L55" title="All 4 branches missed.">      if((null != publicationIds) &amp;&amp; (!&quot;all&quot;.equals(publicationIds[0]))) </span>
      {
<span class="nc" id="L57">        param.setPublicationIds(publicationIds);</span>
<span class="nc" id="L58">        param.setPrimaryArray(primall);</span>
      }
<span class="nc" id="L60">    }</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">    else if(searchType.equals(&quot;collection&quot;))</span>
    {
<span class="nc" id="L63">      sourceArray = request.getParameterValues(&quot;source&quot;);</span>
<span class="nc" id="L64">      param.setSourceCollection(sourceArray);</span>
<span class="nc" id="L65">      param.setPrimaryArray(primall);</span>
    }
    else
    {
<span class="nc bnc" id="L69" title="All 2 branches missed.">      for(int i = 0; i &lt; 4; i++) </span>
      {
<span class="nc" id="L71">        type = &quot;type&quot;;</span>
<span class="nc" id="L72">        input = &quot;input&quot;;</span>
<span class="nc" id="L73">        logic = &quot;logic&quot;;</span>
<span class="nc" id="L74">        columInfo = request.getParameter(type + i);</span>
<span class="nc" id="L75">        keyWord = request.getParameter(input + i);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if(i != 0) </span>
        {
<span class="nc" id="L78">          relation = request.getParameter(logic + i);</span>
        } 
        else 
        {
<span class="nc" id="L82">          relation = &quot;AND&quot;;</span>
        }
        //mapping the terms from the interface to the database tablename and columns
<span class="nc bnc" id="L85" title="All 2 branches missed.">        if(keyWord.length()&gt;1)</span>
        {
<span class="nc" id="L87">          keyWord = keyWord.trim();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">          if(columInfo.compareTo(&quot;ALL&quot;) == 0) </span>
          {
<span class="nc" id="L90">            columInfo = (&quot;ALL.ALL&quot;);</span>
          } 
<span class="nc bnc" id="L92" title="All 2 branches missed.">          else if(columInfo.compareTo(&quot;Keyword&quot;) == 0) </span>
          {
<span class="nc" id="L94">            columInfo = (&quot;Keywords.Keyword&quot;);</span>
          } 
<span class="nc bnc" id="L96" title="All 2 branches missed.">          else if(columInfo.compareTo(&quot;Title&quot;) == 0) </span>
          {
<span class="nc" id="L98">            columInfo = (&quot;Metadata.Title&quot;);</span>
          } 
<span class="nc bnc" id="L100" title="All 2 branches missed.">          else if(columInfo.compareTo(&quot;metaID&quot;) == 0) </span>
          {
<span class="nc" id="L102">            columInfo = (&quot;Metadata.MetadataID&quot;);</span>
          } 
<span class="nc bnc" id="L104" title="All 2 branches missed.">          else if(columInfo.compareTo(&quot;Description&quot;) == 0) </span>
          {
<span class="nc" id="L106">            columInfo = (&quot;Metadata.Description&quot;);</span>
          } 
<span class="nc bnc" id="L108" title="All 2 branches missed.">          else if(columInfo.compareTo(&quot;Contributor&quot;) == 0) </span>
          {
<span class="nc" id="L110">            columInfo = (&quot;Contributors.vCard&quot;);</span>
          } 
<span class="nc bnc" id="L112" title="All 2 branches missed.">          else if(columInfo.compareTo(&quot;CopyrightHolder&quot;) == 0) </span>
          {
<span class="nc" id="L114">            columInfo = (&quot;CopyrightHolders.vCard&quot;);</span>
          }
          
          //added by Zhen 6/12/08 for Tag cloud search.
<span class="nc bnc" id="L118" title="All 2 branches missed.">          else if(columInfo.compareTo(&quot;Tags&quot;) == 0) </span>
          {
<span class="nc" id="L120">            columInfo = (&quot;Tags.tag&quot;);</span>
          }        
<span class="nc" id="L122">          keyWord=keyWord.toLowerCase(); //switch to lower case</span>
<span class="nc" id="L123">          StringBuffer bf=new StringBuffer();</span>
<span class="nc" id="L124">          char[] origQuery=keyWord.toCharArray();</span>
<span class="nc" id="L125">          int paranthesisCount=0; int pos=0;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">          for (int t=0; t&lt;origQuery.length; t++)</span>
          {
<span class="nc bnc" id="L128" title="All 4 branches missed.">            if (origQuery[t]=='(' || origQuery[t]==')')</span>
            {       
<span class="nc bnc" id="L130" title="All 2 branches missed.">              if (origQuery[t]=='(') //if &quot;)(&quot; happens, change to &quot;) and (&quot;</span>
              {
<span class="nc bnc" id="L132" title="All 4 branches missed.">                if(bf.length()&gt;=2 &amp;&amp; bf.charAt(bf.length()-2)==')') </span>
                {
<span class="nc" id="L134">                  bf.append(&quot;and &quot;+origQuery[t]+&quot; &quot;);</span>
<span class="nc" id="L135">                  paranthesisCount++;</span>
                }
                else 
                {
<span class="nc" id="L139">                  bf.append(&quot; &quot;+origQuery[t]+&quot; &quot;);</span>
<span class="nc" id="L140">                  paranthesisCount++;</span>
                }
              }
<span class="nc bnc" id="L143" title="All 2 branches missed.">              else if (origQuery[t]==')') //if &quot;( )&quot; happens, remove the segment</span>
              {
<span class="nc" id="L145">                pos=bf.length()-1;</span>
<span class="nc bnc" id="L146" title="All 4 branches missed.">                while (bf.charAt(pos)==' ' &amp;&amp; pos&gt;0)//need to get to the last character</span>
                {
<span class="nc" id="L148">                  pos--;</span>
                }
<span class="nc bnc" id="L150" title="All 2 branches missed.">                if(bf.charAt(pos)=='(') </span>
                {
<span class="nc" id="L152">                  bf.delete(bf.length()-3, bf.length()-1);</span>
<span class="nc" id="L153">                  paranthesisCount--;</span>
                }
                else
                {
<span class="nc" id="L157">                  bf.append(&quot; &quot;+origQuery[t]+&quot; &quot;);</span>
<span class="nc" id="L158">                  paranthesisCount--;</span>
                }          
              }
<span class="nc" id="L161">              else bf.append(&quot; &quot;+origQuery[t]+&quot; &quot;);</span>
            }
<span class="nc bnc" id="L163" title="All 2 branches missed.">            else if (origQuery[t]=='&quot;') //if &quot;...&quot;, copy the whole string </span>
            {
<span class="nc" id="L165">              bf.append(&quot; \&quot; &quot;);</span>
<span class="nc" id="L166">              t++;</span>
<span class="nc bnc" id="L167" title="All 4 branches missed.">              while (i&lt;origQuery.length &amp;&amp; origQuery[t]!='&quot;')</span>
              {
<span class="nc" id="L169">                bf.append(origQuery[t]);</span>
<span class="nc" id="L170">                t++;</span>
              }
<span class="nc bnc" id="L172" title="All 2 branches missed.">              if (t==origQuery.length)</span>
              {
<span class="nc" id="L174">                validate=false;</span>
              }
<span class="nc" id="L176">              bf.append(&quot; \&quot; &quot;);</span>
            }
<span class="nc bnc" id="L178" title="All 2 branches missed.">            else if (origQuery[t]=='\'')</span>
            {
<span class="nc" id="L180">              bf.append(&quot;\'\'&quot;);</span>
            }
<span class="nc bnc" id="L182" title="All 4 branches missed.">            else if (origQuery[t]==' ' &amp;&amp; bf.charAt(bf.length()-1)==' ') </span>
            {        
            }
<span class="nc" id="L185">            else bf.append(origQuery[t]);</span>
          }
<span class="nc bnc" id="L187" title="All 2 branches missed.">          if (paranthesisCount!=0)</span>
          {
<span class="nc" id="L189">            validate=false;</span>
          }
<span class="nc bnc" id="L191" title="All 2 branches missed.">          if (validate)</span>
          {
<span class="nc" id="L193">            pam=new ParameterNode(columInfo, bf.toString(), relation);</span>
<span class="nc" id="L194">            param.addParameters(pam);         </span>
          }
          else
          {
<span class="nc" id="L198">            i=10;</span>
          }			
        }
        else
        {
          
          break;
        }
      }
<span class="nc" id="L207">      String[] imagingArray = request.getParameterValues(&quot;imaging&quot;);</span>
<span class="nc bnc" id="L208" title="All 4 branches missed.">      if((imagingArray != null) &amp;&amp; (imagingArray[0].compareTo(&quot;all&quot;)) != 0) </span>
      {
<span class="nc" id="L210">        param.setImaging(imagingArray);    </span>
      }     
<span class="nc" id="L212">      String[] diseaseprocessArray = request.getParameterValues(&quot;diseaseProcess&quot;);</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">      if(diseaseprocessArray != null) </span>
      {
<span class="nc bnc" id="L215" title="All 2 branches missed.">        if (diseaseprocessArray[0].compareTo(&quot;all&quot;) != 0) </span>
        {
<span class="nc" id="L217">            param.setDisease(diseaseprocessArray);</span>
        }  
      }
      
<span class="nc" id="L221">      String[] filterStringArray = request.getParameterValues(&quot;filters&quot;);</span>
<span class="nc bnc" id="L222" title="All 6 branches missed.">      if((filterStringArray != null) &amp;&amp; (filterStringArray[0].compareTo(&quot;all&quot;) != 0 &amp;&amp; filterStringArray.length &lt; 8)) </span>
      {
<span class="nc" id="L224">        param.setFilterArray(filterStringArray);</span>
      } 
<span class="nc" id="L226">      sourceArray = request.getParameterValues(&quot;source&quot;);</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">      if((sourceArray != null) &amp;&amp; (sourceArray[0].compareTo(&quot;all&quot;) != 0 )) </span>
        {
<span class="nc" id="L229">            param.setSourceCollection(sourceArray);</span>
        } 
<span class="nc" id="L231">      String[] primary = {&quot;Health Profession Education&quot;,&quot;Higher Education&quot;};</span>
<span class="nc" id="L232">      String[] primaryArray=request.getParameterValues(&quot;primary&quot;);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">      if((primaryArray != null))  </span>
      {
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (primaryArray[0].startsWith(&quot;Health&quot;)){</span>
<span class="nc" id="L236">            param.setPrimaryArray(primary);</span>
        }
        else
<span class="nc" id="L239">        param.setPrimaryArray(primaryArray);</span>
      }
      
    }
    try 
    {
<span class="nc" id="L245">        resultBean = sd.AdvSearch(param);</span>
        
<span class="nc bnc" id="L247" title="All 2 branches missed.">        for(int i = 0; i &lt; param.size(); i++) </span>
        {
<span class="nc" id="L249">            ParameterNode tempNode = param.getParameters(i);</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if(i == 0) </span>
            {
<span class="nc" id="L252">                keywords = tempNode.getKeyWord();</span>
            } 
            else 
            {
<span class="nc" id="L256">                keywords = keywords + &quot; &quot; + tempNode.getRelation() + &quot; &quot; + tempNode.getKeyWord();</span>
            }
        }
<span class="nc" id="L259">        resultBean.setKeywords(keywords);</span>
<span class="nc" id="L260">        request.getSession().setAttribute(&quot;searchResults&quot;, resultBean);</span>
        //NOTE: PAGE MUST BE THE LAST PARAMETER!
<span class="nc" id="L262">        String queryString = request.getQueryString();</span>
<span class="nc" id="L263">        request.getSession().setAttribute(&quot;pams&quot;, queryString);</span>
<span class="nc bnc" id="L264" title="All 4 branches missed.">        if(queryString == null || queryString.length() == 0) </span>
        {
<span class="nc" id="L266">            queryString = &quot;page=1&quot;;</span>
        } 
        else 
        {
<span class="nc" id="L270">            queryString = queryString + &quot;&amp;page=1&quot;;</span>
        }
<span class="nc" id="L272">        String redirectURL = &quot;searchResults?&quot; + queryString;</span>
<span class="nc" id="L273">        response.sendRedirect(redirectURL);</span>
    } 
<span class="nc" id="L275">    catch(SQLException ex) </span>
    {
        //throw new SQLException(ex.toString());
<span class="nc" id="L278">    }</span>
<span class="nc" id="L279">  }</span>
  public boolean actionRequiresLogin() 
  {
<span class="nc" id="L282">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>