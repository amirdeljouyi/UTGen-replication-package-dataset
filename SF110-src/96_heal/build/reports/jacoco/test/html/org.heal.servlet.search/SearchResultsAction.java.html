<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchResultsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet.search</a> &gt; <span class="el_source">SearchResultsAction.java</span></div><h1>SearchResultsAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet.search;

import org.heal.module.metadata.MetadataDAO;
import org.heal.module.metadata.ShortMetadataBean;
import org.heal.module.metadata.ThumbnailBean;
import org.heal.module.search.SearchResultBean;
import org.heal.module.search.ShortMetadataResultBean;
import org.heal.util.FileLocator;
import org.heal.util.InterfaceUtilitiesBean;
import org.heal.util.ParameterMap;
import org.heal.util.ResultsPager;
import org.heal.servlet.Action;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;
import java.text.NumberFormat;

<span class="nc" id="L22">public class SearchResultsAction implements Action </span>
{
  public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
    throws IOException, ServletException 
  {
    SearchResultBean searchResults;
<span class="nc" id="L28">    searchResults = (SearchResultBean) request.getSession().getAttribute(&quot;searchResults&quot;);</span>
<span class="nc" id="L29">    String searchType = request.getParameter(&quot;searchtype&quot;);      </span>
<span class="nc" id="L30">    String queryString = request.getQueryString();</span>
<span class="nc" id="L31">    String pagenb = request.getParameter(&quot;page&quot;);</span>
<span class="nc bnc" id="L32" title="All 2 branches missed.">    if (queryString == null) </span>
    {
<span class="nc" id="L34">      queryString = &quot;&quot;;</span>
    }
    // If there are no search results, redirect to the appropriate search action.
    // This is here so that, for example, if a user bookmarked a search results page
    // rather than arriving here through a search, the expected page would be generated
<span class="nc bnc" id="L39" title="All 2 branches missed.">    if (searchResults == null) </span>
    {
<span class="nc" id="L41">      String searchURL = null;           </span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">      if (&quot;simple&quot;.equalsIgnoreCase(searchType)) </span>
      {
<span class="nc" id="L44">        searchURL = &quot;search?&quot; + queryString;//substring(&quot;action=display&amp;showpage=Searchresults&amp;&quot;.length());;</span>
      }
      else
      {
<span class="nc" id="L48">        searchURL = &quot;advsearch?&quot; + queryString;</span>
      } 
      
<span class="nc" id="L51">      response.sendRedirect(searchURL);</span>
<span class="nc" id="L52">      return;</span>
    }
    // page specifies the page we are looking at, defaultly page 1
<span class="nc" id="L55">    int displayPage = getParameterAsInteger(request, &quot;page&quot;, 1);</span>
    // display specifies how many items are being displayed per page, defaultly 25
<span class="nc" id="L57">    int displayIncrement = getParameterAsInteger(request, &quot;display&quot;, 25);</span>
    //**** BEGIN code to calculate displayStart and displayStop
<span class="nc" id="L59">    int displayStart = (displayPage - 1) * displayIncrement;</span>
<span class="nc" id="L60">    int displayStop = 0;</span>
<span class="nc" id="L61">    ShortMetadataResultBean[] allMetadata = null;</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">    if (searchResults != null) </span>
    {
<span class="nc" id="L64">      allMetadata = searchResults.getShortRecords();</span>
    }
<span class="nc bnc" id="L66" title="All 2 branches missed.">    if (allMetadata != null) </span>
    {
<span class="nc" id="L68">      displayStop = displayStart + displayIncrement;</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">      if (displayStop &gt; allMetadata.length) </span>
      {
<span class="nc" id="L71">        displayStop = allMetadata.length;</span>
      }
    }
    //**** END code to calculate displayStart and displayStop
<span class="nc" id="L75">    request.setAttribute(&quot;displayStart&quot;, &quot;&quot; + displayStart);</span>
<span class="nc" id="L76">    request.setAttribute(&quot;displayStop&quot;, &quot;&quot; + displayStop);</span>
<span class="nc" id="L77">    ParameterMap parameters = new ParameterMap(request.getParameterMap());</span>
    // If they're changing the display size, we must reset the page
<span class="nc" id="L79">    parameters.remove(&quot;page&quot;);</span>
    // Disregarding what &quot;display&quot; value may be in the current parameters
    // map, we put in &quot;10&quot; and construct a new query string to represent
    // the original query string with a &quot;display&quot; of &quot;10&quot;
<span class="nc" id="L83">    parameters.put(&quot;display&quot;, &quot;10&quot;);</span>
<span class="nc" id="L84">    parameters.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L85">    request.setAttribute(&quot;displayString10&quot;, &quot;searchResults?&quot;+ parameters.toString());</span>
    // Disregarding what &quot;display&quot; value may be in the current parameters
    // map, we put in &quot;25&quot; and construct a new query string to represent
    // the original query string with a &quot;display&quot; of &quot;25&quot;
<span class="nc" id="L89">    parameters.put(&quot;display&quot;, &quot;25&quot;);</span>
<span class="nc" id="L90">    parameters.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L91">    request.setAttribute(&quot;displayString25&quot;, &quot;searchResults?&quot;+ parameters.toString());</span>
    // Disregarding what &quot;display&quot; value may be in the current parameters
    // map, we put in &quot;50&quot; and construct a new query string to represent
    // the original query string with a &quot;display&quot; of &quot;50&quot;
<span class="nc" id="L95">    parameters.put(&quot;display&quot;, &quot;50&quot;);</span>
<span class="nc" id="L96">    parameters.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L97">    request.setAttribute(&quot;displayString50&quot;, &quot;searchResults?&quot;+ parameters.toString());</span>
    // The &quot;searchURL&quot; is the original URL with only the search-specific
    // parameters in the query string with the addition of the &quot;display&quot; parameter.
    // This is used in creating the links to different pages of search results.
<span class="nc" id="L101">    parameters = new ParameterMap(request.getParameterMap());</span>
<span class="nc" id="L102">    parameters.remove(&quot;page&quot;);</span>
<span class="nc" id="L103">    request.setAttribute(&quot;searchURL&quot;, &quot;searchResults?&quot; +parameters.toString());</span>
<span class="nc" id="L104">    ParameterMap parameterv = new ParameterMap(request.getParameterMap());</span>
    // If they're changing the display format, we must reset the page
<span class="nc" id="L106">    parameterv.remove(&quot;page&quot;);</span>
    // Disregarding what &quot;display&quot; format may be in the current parameters
    // map, we put in &quot;1&quot; and construct a new query string to represent
    // the original query string with a &quot;viewtype&quot; of &quot;1&quot;
<span class="nc" id="L110">    parameterv.put(&quot;viewtype&quot;, &quot;1&quot;);</span>
<span class="nc" id="L111">    parameterv.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L112">    request.setAttribute(&quot;view1&quot;, &quot;searchResults?&quot;+ parameterv.toString());</span>
    // Disregarding what &quot;display&quot; format may be in the current parameters
    // map, we put in &quot;2&quot; and construct a new query string to represent
    // the original query string with a &quot;viewtype&quot; of &quot;2&quot;
<span class="nc" id="L116">    parameterv.put(&quot;viewtype&quot;, &quot;2&quot;);</span>
<span class="nc" id="L117">    parameterv.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L118">    request.setAttribute(&quot;view2&quot;, &quot;searchResults?&quot;+ parameterv.toString());</span>
    // Disregarding what &quot;display&quot; value may be in the current parameters
    // map, we put in &quot;3&quot; and construct a new query string to represent
    // the original query string with a &quot;viewtype&quot; of &quot;3&quot;
<span class="nc" id="L122">    parameterv.put(&quot;viewtype&quot;, &quot;3&quot;);</span>
<span class="nc" id="L123">    parameterv.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L124">    request.setAttribute(&quot;view3&quot;, &quot;searchResults?&quot;+ parameterv.toString());</span>
    // The &quot;searchURL&quot; is the original URL with only the search-specific
    // parameters in the query string with the addition of the &quot;display&quot; parameter.
    // This is used in creating the links to different pages of search results.
<span class="nc" id="L128">    parameterv = new ParameterMap(request.getParameterMap());</span>
<span class="nc" id="L129">    parameterv.remove(&quot;page&quot;);</span>
<span class="nc" id="L130">    request.setAttribute(&quot;searchURL&quot;, &quot;searchResults?&quot; +parameterv.toString());</span>
<span class="nc" id="L131">    ParameterMap parametert = new ParameterMap(request.getParameterMap());</span>
    // If they're sorting the display result, we must reset the page
<span class="nc" id="L133">    parametert.remove(&quot;page&quot;);</span>
    // Disregarding what &quot;sort&quot; value may be in the current parameters
    // map, we put in &quot;sortFormat&quot; and construct a new query string to represent
    // the original query string with a &quot;sort&quot; by &quot;Format&quot;
<span class="nc" id="L137">    parametert.put(&quot;sortby&quot;, &quot;Title&quot;);</span>
<span class="nc" id="L138">    parametert.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L139">    request.setAttribute(&quot;sortTitle&quot;, &quot;sortResults?&quot;+ parametert.toString());</span>
<span class="nc" id="L140">    parametert.put(&quot;sortby&quot;, &quot;Format&quot;);</span>
<span class="nc" id="L141">    parametert.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L142">    request.setAttribute(&quot;sortFormat&quot;, &quot;sortResults?&quot;+ parametert.toString());</span>
    // Disregarding what &quot;sort&quot; value may be in the current parameters
    // map, we put in &quot;sortScollect&quot; and construct a new query string to represent
    // the original query string with a &quot;sort&quot; by &quot;Source Collection&quot;
<span class="nc" id="L146">    parametert.put(&quot;sortby&quot;, &quot;SourceCollection&quot;);</span>
<span class="nc" id="L147">    parametert.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L148">    request.setAttribute(&quot;sortScollect&quot;, &quot;sortResults?&quot;+ parametert.toString());</span>
    // Disregarding what &quot;sort&quot; value may be in the current parameters
    // map, we put in &quot;sortSize&quot; and construct a new query string to represent
    // the original query string with a &quot;sort&quot; by &quot;File Size&quot;
<span class="nc" id="L152">    parametert.put(&quot;sortby&quot;, &quot;FileSize&quot;);</span>
<span class="nc" id="L153">    parametert.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L154">    request.setAttribute(&quot;sortSize&quot;, &quot;sortResults?&quot;+ parametert.toString());</span>
    // The &quot;searchURL&quot; is the original URL with only the search-specific
    // parameters in the query string with the addition of the &quot;display&quot; parameter.
    // This is used in creating the links to different pages of search results.
<span class="nc" id="L158">    parametert = new ParameterMap(request.getParameterMap());</span>
<span class="nc" id="L159">    parametert.remove(&quot;page&quot;);</span>
<span class="nc" id="L160">    request.setAttribute(&quot;searchURL&quot;, &quot;searchResults?&quot; +parametert.toString());</span>
<span class="nc" id="L161">    request.setAttribute(&quot;origURL&quot;, &quot;searchResults?&quot; + queryString);</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">    if (allMetadata != null) </span>
    {
<span class="nc" id="L164">      ResultsPager pager = new org.heal.util.ResultsPager(allMetadata.length, displayIncrement, displayPage);</span>
<span class="nc" id="L165">      request.setAttribute(&quot;pager&quot;, pager);</span>
    }
    String metadataId;
    ShortMetadataBean currentMeta;
<span class="nc" id="L169">    MetadataDAO metadataServices = (MetadataDAO) servlet.getServletContext().getAttribute(&quot;MetadataDAO&quot;);</span>
<span class="nc" id="L170">    InterfaceUtilitiesBean interfaceUtilities = (InterfaceUtilitiesBean) servlet.getServletContext().getAttribute(&quot;interfaceUtilities&quot;);</span>
<span class="nc" id="L171">    FileLocator healFileLocator = (FileLocator) servlet.getServletContext().getAttribute(&quot;healFileLocator&quot;);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">    for (int i = displayStart; i &lt; displayStop; i++) {</span>
<span class="nc" id="L173">      metadataId = allMetadata[i].getMetadataId();</span>
<span class="nc" id="L174">      currentMeta = allMetadata[i].getShortMetadata();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">      if (currentMeta == null) </span>
      {
        try 
        {
<span class="nc" id="L179">          currentMeta = metadataServices.getShortMetadata(metadataId);</span>
        } 
<span class="nc" id="L181">        catch (SQLException e) </span>
        {
<span class="nc" id="L183">          System.err.println(e);</span>
<span class="nc" id="L184">        }</span>
<span class="nc" id="L185">        String format = currentMeta.getFormat();</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">          if (format == null) </span>
        {
<span class="nc" id="L188">          format = &quot;unknown&quot;;</span>
        }
        
<span class="nc" id="L191">        ThumbnailBean thumbnail = interfaceUtilities.getThumbnail(currentMeta.getThumbnail(), format, &quot;../&quot;);</span>
<span class="nc" id="L192">        currentMeta.setThumbnail(thumbnail);//}</span>
<span class="nc" id="L193">        currentMeta.setLocation(healFileLocator.getContentURL(currentMeta.getLocation()));</span>
<span class="nc" id="L194">        currentMeta.setDescription(interfaceUtilities.getAbbreviatedString(currentMeta.getDescription(), 100));</span>
<span class="nc" id="L195">        currentMeta.setFileSize(NumberFormat.getInstance().format(Long.parseLong(currentMeta.getFileSize())));</span>
<span class="nc" id="L196">        allMetadata[i].setShortMetadata(currentMeta);</span>
      }
    }
    // If the original query string is missing a parameter we add
    // the parameter's default value before passing on the query
    String queryStringWithDefaults;
<span class="nc" id="L202">    ParameterMap parameter = new ParameterMap(request.getParameterMap());</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">    if(!parameter.containsKey(&quot;display&quot;)) </span>
    {
      // The default &quot;display&quot; is &quot;25&quot;
<span class="nc" id="L206">      parameter.put(&quot;display&quot;, &quot;25&quot;);</span>
    }
<span class="nc bnc" id="L208" title="All 2 branches missed.">    if(!parameter.containsKey(&quot;page&quot;)) </span>
    {
      // The default &quot;page&quot; is &quot;1&quot;
<span class="nc" id="L211">      parameter.put(&quot;page&quot;, &quot;1&quot;);</span>
    }
<span class="nc bnc" id="L213" title="All 2 branches missed.">    if(!parameter.containsKey(&quot;viewtype&quot;)) </span>
    {
      // The default &quot;view&quot; is &quot;1&quot;
<span class="nc" id="L216">      parameter.put(&quot;viewtype&quot;, &quot;1&quot;);</span>
    }
<span class="nc bnc" id="L218" title="All 2 branches missed.">    if(!parameter.containsKey(&quot;sortby&quot;)) </span>
    {
      // The default &quot;sort&quot; is &quot;Title&quot;
<span class="nc" id="L221">      parameter.put(&quot;sortby&quot;, &quot;Title&quot;);</span>
    }
<span class="nc" id="L223">    queryStringWithDefaults = parameter.toString();</span>
<span class="nc" id="L224">    String forwardURL = null;</span>
<span class="nc" id="L225">    forwardURL = &quot;/search/searchresults.jsp?&quot; + queryStringWithDefaults;</span>
    RequestDispatcher rd;
<span class="nc" id="L227">    rd = request.getRequestDispatcher(forwardURL);</span>
<span class="nc" id="L228">    rd.forward(request, response);</span>
<span class="nc" id="L229">    return;</span>
  }
  private int getParameterAsInteger(final HttpServletRequest request, final String paramName, final int defaultValue) 
  {
<span class="nc" id="L233">    int ret = defaultValue;</span>
<span class="nc" id="L234">    String parameter = request.getParameter(paramName);</span>
<span class="nc bnc" id="L235" title="All 4 branches missed.">    if (parameter != null &amp;&amp; parameter.length() != 0) </span>
    {
      try 
      {
<span class="nc" id="L239">        ret = Integer.parseInt(parameter);</span>
      } 
<span class="nc" id="L241">      catch(NumberFormatException e) { } // does nothing, so the defaultValue will be returned</span>
    }
<span class="nc" id="L243">    return ret;</span>
  }
  public boolean actionRequiresLogin() 
  {
<span class="nc" id="L247">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>