<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommonDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.util</a> &gt; <span class="el_source">CommonDAO.java</span></div><h1>CommonDAO.java</h1><pre class="source lang-java linenums">package org.heal.util;

import com.ora.jsp.sql.NoSuchColumnException;
import com.ora.jsp.sql.Row;
import com.ora.jsp.sql.SQLCommandBean;
import com.ora.jsp.sql.UnsupportedTypeException;
import com.ora.jsp.sql.Value;
import com.ora.jsp.sql.value.BooleanValue;
import com.ora.jsp.sql.value.IntValue;
import com.ora.jsp.sql.value.LongValue;
import com.ora.jsp.sql.value.StringValue;
import com.ora.jsp.sql.value.TimestampValue;
import com.ora.jsp.sql.value.DateValue;

import org.heal.module.metadata.ContextURLBean;
import org.heal.module.metadata.ContributorBean;
import org.heal.module.metadata.CopyrightBean;
import org.heal.module.metadata.CopyrightHolderBean;
import org.heal.module.metadata.CopyrightTextBean;
import org.heal.module.metadata.DiseaseDiagnosisBean;
import org.heal.module.metadata.FormatBean;
import org.heal.module.metadata.KeywordBean;
import org.heal.module.metadata.MetadataBean;
import org.heal.module.metadata.MetametadataContributorBean;
import org.heal.module.metadata.MetametadataIdentifierBean;
import org.heal.module.metadata.RelationBean;
import org.heal.module.metadata.RequirementBean;
import org.heal.module.metadata.SourceCollectionBean;
import org.heal.module.metadata.TargetUserGroupBean;
import org.heal.module.metadata.TaxonBean;
import org.heal.module.metadata.TaxonPathBean;
import org.heal.module.metadata.ThumbnailBean;

import javax.sql.DataSource;
import java.io.Serializable;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Vector;

/**
 * @author Grace
 * @version 0.1
 */

public class CommonDAO implements Serializable {
<span class="nc" id="L53">    public CommonDAO() {</span>
<span class="nc" id="L54">    }</span>

    private DataSource dataSource;

    private static final String THUMBNAILINSERTSQL = &quot;INSERT INTO Thumbnails (MetadataId, Location, FileWidth, FileHeight) VALUES(?, ?, ?, ?)&quot;;
    private static final String THUMBNAILUPDATESQL = &quot;UPDATE Thumbnails SET MetadataId = ?, Location= ?, FileWidth= ?, FileHeight = ? WHERE ThumbnailID = ?&quot;;
    private static final String COPYRIGHTINSERTSQL = &quot;INSERT INTO Copyrights (MetadataID, CopyrightTextID) VALUES(?, ?)&quot;;
    private static final String COPYRIGHTUPDATESQL = &quot;UPDATE Copyrights SET MetadataID = ?, CopyrightTextID = ? WHERE CopyrightID = ?&quot;;

    private static final String COPYRIGHTTEXTINSERTSQL = &quot;INSERT INTO CopyrightTexts (CopyrightText, Cost, CopyrightAndOtherRestriction) VALUES(?, ?, ?)&quot;;
    private static final String COPYRIGHTTEXTUPDATESQL = &quot;UPDATE CopyrightTexts SET CopyrightText = ?, Cost = ?, CopyrightAndOtherRestriction = ? WHERE CopyrightTextID = ?&quot;;
    private static final String COPYRIGHTTEXTLOOKUPIDSQL = &quot;SELECT CopyrightTextID FROM CopyrightTexts WHERE CopyrightText = ?&quot;;
    private static final String DISEASEDIAGNOSISINSERTSQL = &quot;INSERT INTO DiseaseDiagnoses (MetadataID, DiseaseDiagnosis) VALUES(?, ?)&quot;;
    private static final String DISEASEDIAGNOSISUPDATESQL = &quot;UPDATE DiseaseDiagnoses SET MetadataID = ?, DiseaseDiagnosis = ? WHERE DiseaseDiagnosisID = ?&quot;;
    private static final String COPYRIGHTHOLDERINSERTSQL = &quot;INSERT INTO CopyrightHolders (MetadataID, vCardID) VALUES(?, ?)&quot;;
    private static final String COPYRIGHTHOLDERUPDATESQL = &quot;UPDATE CopyrightHolders SET MetadataID = ?, vCardID = ? WHERE CopyrightHolderID = ?&quot;;
    private static final String KEYWORDINSERTSQL = &quot;INSERT INTO Keywords (MetadataID, Keyword) VALUES(?, ?)&quot;;
    private static final String KEYWORDUPDATESQL = &quot;UPDATE Keywords SET MetadataID = ?, Keyword = ? WHERE KeywordID = ?&quot;;

    private static final String FORMATINSERTSQL = &quot;INSERT INTO Formats (MetadataID, Format) VALUES(?, ?)&quot;;
    private static final String FORMATUPDATESQL = &quot;UPDATE Formats SET MetadataID = ?, Format = ? WHERE FormatID = ?&quot;;


    private static final String TAXONPATHINSERTSQL = &quot;INSERT INTO TaxonPaths (MetadataID, Source, Purpose, Description, Keyword) VALUES(?, ?, ?, ?, ?)&quot;;
  //  private static final String TAXONPATHINSERTSQL = &quot;INSERT INTO TaxonPaths (MetadataID, Source) VALUES(?, ?)&quot;;
    private static final String TAXONINSERTSQL = &quot;INSERT INTO Taxons (TaxonPathID, ID, Entry) VALUES(?, ?, ?)&quot;;
    private static final String TAXONUPDATESQL = &quot;UPDATE Taxons SET TaxonPathID = ?, ID = ?, Entry = ? WHERE TaxonID = ?&quot;;


    private static final String CONTEXTURLINSERTSQL = &quot;INSERT INTO ContextURLs (MetadataID, ContextURL, ContextURLDescription) VALUES(?, ?, ?)&quot;;
    private static final String CONTEXTURLUPDATESQL = &quot;UPDATE ContextURLs SET MetadataID = ?, ContextURL = ?, ContextURLDescription = ? WHERE ContextURLID = ?&quot;;

    private static final String REQUIREMENTINSERTSQL = &quot;INSERT INTO Requirements (MetadataID, RequirementType, RequirementName, OtherPlatformRequirements, Duration, Description) VALUES(?, ?, ?, ?, ?, ?)&quot;;
    private static final String REQUIREMENTUPDATESQL = &quot;UPDATE Requirements SET MetadataID = ?, RequirementType = ?, RequirementName = ?, OtherPlatformRequirements = ?, Duration = ?, Description = ? WHERE RequirementID = ?&quot;;

    private static final String CONTRIBUTORINSERTSQL = &quot;INSERT INTO Contributors (MetadataID, Role, vCardID, ContributeDate, ContributeDateDescription, Version, Status) VALUES(?, ?, ?, ?, ?, ?, ?)&quot;;
    private static final String CONTRIBUTORUPDATESQL = &quot;UPDATE Contributors SET MetadataID = ?, Role = ?, vCardID = ?, ContributeDate = ?, ContributeDateDescription = ?, Version = ?, Status = ? WHERE ContributorID = ?&quot;;

    private static final String RELATIONINSERTSQL = &quot;INSERT INTO Relations (MetadataID, Resource, Kind, Description, Catalogue, Entry) VALUES(?, ?, ?, ?, ?, ?)&quot;;  
    private static final String RELATIONUPDATESQL = &quot;UPDATE Relations SET MetadataID = ?, Resource = ?, Kind = ?, Description = ?, Catalogue = ?, Entry = ? WHERE RelationID = ?&quot;;

    private static final String TARGETUSERGROUPINSERTSQL = &quot;INSERT INTO TargetUserGroups (MetadataId, TargetUserGroup) VALUES (?, ?)&quot;;

    private static final String DELETEDITEMSINSERTSQL = &quot;INSERT INTO DeletedItems (GlobalID, FileName, Title, Location, ContributeUserID, ContributeDate, DeleteDate, Comments) VALUES(?, ?, ?, ?, ?, ?, ?, ?)&quot;;


    /**
     * Sets the dataSource property value.
     */
    public void setDataSource(DataSource dataSource) {
<span class="nc" id="L104">        this.dataSource = dataSource;</span>
<span class="nc" id="L105">    }</span>

    /**
     * Given a property name and value and a metadata Id, updates
     * the metadata's table to reflect the given value.
     */
    public void updateMetadataBooleanProperty(String propertyName, boolean propertyValue, String metadataId, Connection conn)
            throws SQLException {
<span class="nc" id="L113">        updateMetadataValueProperty(propertyName, new BooleanValue(propertyValue), metadataId, conn);</span>
<span class="nc" id="L114">    }</span>

    /**
     * Given a property name and value and a metadata Id, updates
     * the metadata's table to reflect the given value.
     */
    public void updateMetadataValueProperty(String propertyName, Value propertyValue, String metadataId, Connection conn)
            throws SQLException {
<span class="nc" id="L122">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L123">        sql.append(&quot;UPDATE Metadata SET &quot;).append(propertyName).append(&quot; = ? WHERE &quot;);</span>
<span class="nc" id="L124">        sql.append(&quot;MetadataID = ?&quot;);</span>
<span class="nc" id="L125">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L126">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L127">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L128">        Vector values = new Vector();</span>
<span class="nc" id="L129">        values.addElement(propertyValue);</span>
<span class="nc" id="L130">        values.addElement(new StringValue(metadataId));</span>
<span class="nc" id="L131">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L132">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L133">    }</span>

    /**
     * Given a property name and value and a metadata Id, updates
     * the metadata's table to reflect the given value.
     */
    public void updateMetadataStringProperty(String propertyName,
                                             String propertyValue,
                                             String metadataId,
                                             Connection conn)
            throws SQLException {
<span class="nc" id="L144">        updateMetadataValueProperty(propertyName,</span>
                new StringValue(propertyValue),
                metadataId,
                conn);
<span class="nc" id="L148">    }</span>

    /**
     * Given a property name and value and a metadata Id, updates
     * the metadata's table to reflect the given value.
     */
    public void updateMetadataTimestampProperty(String propertyName,
                                                Timestamp propertyValue,
                                                String metadataId,
                                                Connection conn)
            throws SQLException {
<span class="nc" id="L159">        updateMetadataValueProperty(propertyName,</span>
                new TimestampValue(propertyValue),
                metadataId,
                conn);
<span class="nc" id="L163">    }</span>

    /**
     * Returns a Vector of Rows with all of the requested columns from the
     * requested table that have the specified metadataId in their
     * MetadataID column, or null if no matches are found.
     */
    public Vector getMetadataProperties(String metadataId,
                                        String columnNames,
                                        String tableName,
                                        Connection conn)
            throws SQLException {

<span class="nc bnc" id="L176" title="All 2 branches missed.">        if(metadataId == null) {</span>
<span class="nc" id="L177">            return null;</span>
        }

<span class="nc" id="L180">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L181">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L182">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L183">        sql.append(&quot;SELECT &quot;).append(columnNames).append(&quot; FROM &quot;).append(tableName).append(&quot; &quot;)</span>
<span class="nc" id="L184">                .append(&quot;WHERE MetadataID = ?&quot;);</span>
<span class="nc" id="L185">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L186">        Vector values = new Vector();</span>
<span class="nc" id="L187">        values.addElement(new StringValue(metadataId));</span>
<span class="nc" id="L188">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L189">        Vector rows = null;</span>
        try {
<span class="nc" id="L191">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L192">        } catch(UnsupportedTypeException e) {</span>
<span class="nc" id="L193">            throw new SQLException(e.toString());</span>
<span class="nc" id="L194">        }</span>

<span class="nc bnc" id="L196" title="All 4 branches missed.">        if(rows == null || rows.size() == 0) {</span>
            // Metadata not found
<span class="nc" id="L198">            return null;</span>
        }
<span class="nc" id="L200">        return rows;</span>
    }

    public TimestampValue getTimestampValue(Date date) {
        TimestampValue ret;
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if(null != date) {</span>
<span class="nc" id="L206">            ret = new TimestampValue(new Timestamp(date.getTime()));</span>
        } else {
<span class="nc" id="L208">            ret = new TimestampValue(null);</span>
        }
<span class="nc" id="L210">        return ret;</span>
    }

    public IntValue getIntValue(String intString) {
<span class="nc" id="L214">        int parsedInt = 0;</span>
        try {
<span class="nc" id="L216">            parsedInt = Integer.parseInt(intString);</span>
<span class="nc" id="L217">        } catch(NumberFormatException ex) {</span>
            //XXX logging?
<span class="nc" id="L219">        }</span>
<span class="nc" id="L220">        return new IntValue(parsedInt);</span>
    }

    public LongValue getLongValue(String longString) {
<span class="nc" id="L224">        long parsedLong = 0;</span>
        try {
<span class="nc" id="L226">            parsedLong = Long.parseLong(longString);</span>
<span class="nc" id="L227">        } catch(NumberFormatException e) {</span>

<span class="nc" id="L229">        }</span>
<span class="nc" id="L230">        return new LongValue(parsedLong);</span>
    }


    /**
     * Gets all rows from a given table.  The return value is a Vector
     * of com.ora.jsp.sql.Row object or null if an error occurs.
     */
    public Vector getAllRows(String tableName) throws SQLException {
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if(tableName == null) {</span>
<span class="nc" id="L240">            return null;</span>
        }
<span class="nc" id="L242">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L243">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L244">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L245">        sqlCommandBean.setSqlValue(&quot;SELECT * FROM &quot; + tableName);</span>
<span class="nc" id="L246">        Vector rows = null;</span>
        try {
<span class="nc" id="L248">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L249">        } catch(UnsupportedTypeException e) {</span>
<span class="nc" id="L250">            throw new SQLException(e.toString());</span>
<span class="nc" id="L251">        }</span>
<span class="nc" id="L252">        return rows;</span>
    }

    /**
     * Returns a MetadataBean initialized with the information
     * found in the database specified by the given metadataId,
     * or null if the metadataId is not found in the database.
     */
    public MetadataBean getMetadata(String metadataId, Connection conn)
            throws SQLException {

        // Get the metadata info from the database
<span class="nc" id="L264">        Row metadataRow = getMetadataProperty(metadataId, &quot;Metadata.*, Publications.Name AS PubName, Publications.PublicationDate AS PubDate&quot;, &quot;Metadata LEFT OUTER JOIN Publications ON Metadata.PublicationId = Publications.PublicationId&quot;, conn);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if(metadataRow == null) {</span>
<span class="nc" id="L266">            return null;</span>
        }

<span class="nc" id="L269">        MetadataBean metadataInfo = new MetadataBean();</span>
        try {
<span class="nc" id="L271">            metadataInfo.setMetadataId(metadataRow.getString(&quot;MetadataID&quot;));</span>
<span class="nc" id="L272">            metadataInfo.setGlobalId(metadataRow.getString(&quot;GlobalID&quot;));</span>
<span class="nc" id="L273">            metadataInfo.setFileName(metadataRow.getString(&quot;FileName&quot;));</span>
<span class="nc" id="L274">            metadataInfo.setFileSize(metadataRow.getString(&quot;FileSize&quot;));</span>
<span class="nc" id="L275">            metadataInfo.setTitle(metadataRow.getString(&quot;Title&quot;));</span>
<span class="nc" id="L276">            metadataInfo.setLocation(metadataRow.getString(&quot;Location&quot;));</span>
<span class="nc" id="L277">            metadataInfo.setSourceCollection(metadataRow.getString(&quot;SourceCollection&quot;));</span>
<span class="nc" id="L278">            metadataInfo.setLearningResourceType(metadataRow.getString(&quot;LearningResourceType&quot;));</span>
<span class="nc" id="L279">            metadataInfo.setContributeUserId(metadataRow.getString(&quot;ContributeUserID&quot;));</span>
<span class="nc" id="L280">            metadataInfo.setContributeDate(DateTools.parse(metadataRow.getString(&quot;ContributeDate&quot;)));</span>
<span class="nc" id="L281">            metadataInfo.setAnnotated(metadataRow.getString(&quot;Annotated&quot;));</span>
<span class="nc" id="L282">            metadataInfo.setInappropriate(metadataRow.getString(&quot;Inappropriate&quot;));</span>
<span class="nc" id="L283">            metadataInfo.setArchived(metadataRow.getString(&quot;Archived&quot;));</span>
<span class="nc" id="L284">            metadataInfo.setPrivate(metadataRow.getString(&quot;Private&quot;));</span>
<span class="nc" id="L285">            metadataInfo.setDescription(metadataRow.getString(&quot;Description&quot;));</span>
<span class="nc" id="L286">            metadataInfo.setSpecimenType(metadataRow.getString(&quot;SpecimenType&quot;));</span>
<span class="nc" id="L287">            metadataInfo.setRadiographType(metadataRow.getString(&quot;RadiographType&quot;));</span>
<span class="nc" id="L288">            metadataInfo.setOrientation(metadataRow.getString(&quot;Orientation&quot;));</span>
<span class="nc" id="L289">            metadataInfo.setMagnification(metadataRow.getString(&quot;Magnification&quot;));</span>
<span class="nc" id="L290">            metadataInfo.setClinicalHistory(metadataRow.getString(&quot;ClinicalHistory&quot;));</span>
<span class="nc" id="L291">            metadataInfo.setFileWidth(metadataRow.getString(&quot;FileWidth&quot;));</span>
<span class="nc" id="L292">            metadataInfo.setFileHeight(metadataRow.getString(&quot;FileHeight&quot;));</span>
<span class="nc" id="L293">            metadataInfo.setDuration(metadataRow.getString(&quot;Duration&quot;));</span>
<span class="nc" id="L294">            metadataInfo.setApproveDate(DateTools.parse(metadataRow.getString(&quot;ApproveDate&quot;)));</span>
<span class="nc" id="L295">            metadataInfo.setCatalogDate(DateTools.parse(metadataRow.getString(&quot;CatalogDate&quot;)));</span>
<span class="nc" id="L296">            metadataInfo.setRejectDate(DateTools.parse(metadataRow.getString(&quot;RejectDate&quot;)));</span>
<span class="nc" id="L297">            metadataInfo.setCreationDate(DateTools.parse(metadataRow.getString(&quot;CreationDate&quot;)));</span>
<span class="nc" id="L298">            metadataInfo.setPublicationName(metadataRow.getString(&quot;PubName&quot;));</span>
<span class="nc" id="L299">            metadataInfo.setPublicationDate(DateTools.parse(metadataRow.getString(&quot;PubDate&quot;)));</span>

            // For some reason a null integer gets returned from getString as &quot;0&quot;
            // so this ensures the publicationId is populated as null correctly
<span class="nc" id="L303">            final String publicationId = metadataRow.getString(&quot;PublicationId&quot;);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            metadataInfo.setPublicationId(&quot;0&quot;.equals(publicationId) ? null : publicationId);</span>
<span class="nc" id="L305">            metadataInfo.setLanguageType(metadataRow.getString(&quot;LanguageType&quot;));</span>
<span class="nc" id="L306">        } catch(NoSuchColumnException nsce) {</span>
<span class="nc" id="L307">            throw new SQLException(nsce.toString());</span>
<span class="nc" id="L308">        }</span>
<span class="nc" id="L309">        return metadataInfo;</span>
    }

    /**
     * Returns a Row with all information about the specified
     * metadata or null if the metadata is not found.
     */
    public Row getMetadataProperty(String metadataId, String columnNames, String tableName, Connection conn)
            throws SQLException {
<span class="nc" id="L318">        Vector results = getMetadataProperties(metadataId, columnNames, tableName, conn);</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if(results != null) {</span>
<span class="nc" id="L320">            return (Row)results.firstElement();</span>
        } else {
<span class="nc" id="L322">            return null;</span>
        }
    }

    /**
     * Removes all taxons and taxon paths associated with the given metadataId.
     */
    public void removeTaxonPaths(String metadataId, Connection conn) throws SQLException {
<span class="nc bnc" id="L330" title="All 4 branches missed.">        if(metadataId == null || conn == null) {</span>
<span class="nc" id="L331">            return;</span>
        }
<span class="nc" id="L333">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L334">        sql.append(&quot;DELETE FROM Taxons WHERE TaxonPathID in (SELECT TaxonPathID FROM TaxonPaths WHERE MetadataID = ?)&quot;);</span>
<span class="nc" id="L335">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L336">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L337">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L338">        Vector values = new Vector();</span>
<span class="nc" id="L339">        values.addElement(new StringValue(metadataId));</span>
<span class="nc" id="L340">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L341">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L342">        sql.setLength(0);</span>
<span class="nc" id="L343">        sql.append(&quot;DELETE FROM TaxonPaths WHERE MetadataID = ?&quot;);</span>
<span class="nc" id="L344">        sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L345">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L346">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L347">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L348">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L349">    }</span>

    /**
     * Removes all copyright entries with the given metadataId
     * from the Copyrights table.
     */
    public void removeCopyrights(String metadataId, Connection conn) throws SQLException {
<span class="nc bnc" id="L356" title="All 4 branches missed.">        if(metadataId == null || conn == null) {</span>
<span class="nc" id="L357">            return;</span>
        }
<span class="nc" id="L359">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L360">        sql.append(&quot;DELETE FROM Copyrights WHERE MetadataID = ?&quot;);</span>

<span class="nc" id="L362">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L363">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L364">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L365">        Vector values = new Vector();</span>
<span class="nc" id="L366">        values.addElement(new StringValue(metadataId));</span>
<span class="nc" id="L367">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L368">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L369">        sql.setLength(0);</span>
        //clean up the copyright texts
<span class="nc" id="L371">        sql.append(&quot;DELETE FROM CopyrightTexts WHERE CopyrightTextID NOT IN (SELECT CopyrightTextID FROM Copyrights)&quot;);</span>
<span class="nc" id="L372">        sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L373">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L374">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L375">        values = new Vector();</span>
<span class="nc" id="L376">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L377">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L378">    }</span>

    /**
     * Removes all entries in a table that have a given metadataId.
     */
    public void removeMetadataFromTable(String metadataId, String tableName, Connection conn) throws SQLException {
<span class="nc" id="L384">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L385">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L386">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L387">        sql.append(&quot;DELETE FROM &quot;).append(tableName).append(&quot; &quot;)</span>
<span class="nc" id="L388">                .append(&quot;WHERE MetadataID = ?&quot;);</span>
<span class="nc" id="L389">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L390">        Vector values = new Vector();</span>
<span class="nc" id="L391">        values.addElement(new StringValue(metadataId));</span>
<span class="nc" id="L392">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L393">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L394">    }</span>

    /**
     * Deletes the metadata entry from the metadata table.
     * Returns true if no problems occured, false otherwise.
     */
    public boolean deleteMetadata(String metadataId) {
<span class="nc" id="L401">        boolean success = false;</span>
<span class="nc" id="L402">        Connection conn = null;</span>
        try {
<span class="nc" id="L404">            conn = dataSource.getConnection();</span>
<span class="nc" id="L405">            conn.setAutoCommit(false);</span>
<span class="nc" id="L406">            removeMetadataFromTable(metadataId, &quot;Metadata&quot;, conn);</span>
<span class="nc" id="L407">            success = true;</span>
<span class="nc" id="L408">        } catch(SQLException ex) {</span>
<span class="nc" id="L409">            ex.printStackTrace();</span>
        } finally {
            try {
<span class="nc bnc" id="L412" title="All 2 branches missed.">                if(conn != null) {</span>
<span class="nc" id="L413">                    conn.setAutoCommit(true);</span>
<span class="nc" id="L414">                    conn.commit();</span>
<span class="nc" id="L415">                    conn.close();</span>
                }
<span class="nc" id="L417">            } catch(SQLException ex2) {</span>
                //ignore
<span class="nc" id="L419">            }</span>
        }
<span class="nc" id="L421">        return success;</span>
    }

    public String getMetadataPropertyAsString(String metadataId, String columnName, String tableName, Connection conn)
            throws SQLException {
<span class="nc" id="L426">        Row row = getMetadataProperty(metadataId, columnName, tableName, conn);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if(row != null) {</span>
            try {
<span class="nc" id="L429">                return row.getString(columnName);</span>
<span class="nc" id="L430">            } catch(NoSuchColumnException ex) {</span>
<span class="nc" id="L431">                throw new SQLException(ex.toString());</span>
            }
        } else {
<span class="nc" id="L434">            return null;</span>
        }
    }

    /**
     * Given a metadataId, creates an entry for that metadata in the
     * DeletedItems table with information from the current Metadata
     * table and the provided comment.  The DeleteDate will be set
     * as the current date.
     * Returns true if no problems occured, false otherwise.
     */
    public boolean moveToDeletedItems(String metadataId, String comment, Connection conn)
            throws SQLException {
<span class="nc" id="L447">        boolean success = false;</span>
<span class="nc" id="L448">        MetadataBean metadata = getMetadata(metadataId, conn);</span>
<span class="nc" id="L449">        addToDeletedItems(metadata, comment, conn);</span>
<span class="nc" id="L450">        success = deleteMetadataReferences(metadataId, conn);</span>
<span class="nc" id="L451">        removeMetadataFromTable(metadataId, &quot;Metadata&quot;, conn);</span>
<span class="nc" id="L452">        return success;</span>
    }

    /**
     * Takes information from the metadata bean and stores it in the
     * deleted items table, with the addition of the provided comment.
     */
    public void addToDeletedItems(MetadataBean metadata, String comment, Connection conn)
            throws SQLException {
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if(metadata == null) {</span>
<span class="nc" id="L462">            throw new SQLException(&quot;Invalid metadata provided.&quot;);</span>
        }
<span class="nc" id="L464">        Timestamp deleteDate = new Timestamp(System.currentTimeMillis());</span>
<span class="nc" id="L465">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L466">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L467">        sqlCommandBean.setSqlValue(DELETEDITEMSINSERTSQL);</span>
<span class="nc" id="L468">        Vector values = new Vector();</span>
<span class="nc" id="L469">        values.addElement(new StringValue(metadata.getGlobalId()));</span>
<span class="nc" id="L470">        values.addElement(new StringValue(metadata.getFileName()));</span>
<span class="nc" id="L471">        values.addElement(new StringValue(metadata.getTitle()));</span>
<span class="nc" id="L472">        values.addElement(new StringValue(metadata.getLocation()));</span>
<span class="nc" id="L473">        values.addElement(getIntValue(metadata.getContributeUserId()));</span>
<span class="nc" id="L474">        values.addElement(getTimestampValue(metadata.getContributeDate()));</span>
<span class="nc" id="L475">        values.addElement(new TimestampValue(deleteDate));</span>
<span class="nc" id="L476">        values.addElement(new StringValue(comment));</span>
<span class="nc" id="L477">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L478">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L479">    }</span>

    /**
     * Removes all references to the given metadataId, EXCEPT for the main
     * entry in the Metadata table.  All other references are removed from
     * the other tables (Formats, Keywords, Requirements, etc).
     * Also deleted are all taxons associated with taxonpaths associated with
     * this metadata reference.  Also, all copyrights associated with the
     * metadata are deleted.  If the copyright to be deleted contains the only
     * reference to the associated copyright text, then the copyright text
     * is also deleted.
     * Returns true if no problems occured, false otherwise.
     */
    public boolean deleteMetadataReferences(String metadataId, Connection conn)
            throws SQLException {
        //first do the easy removals...
<span class="nc" id="L495">        removeMetadataFromTable(metadataId, &quot;DiseaseDiagnoses&quot;, conn);</span>
<span class="nc" id="L496">        removeMetadataFromTable(metadataId, &quot;Formats&quot;, conn);</span>
<span class="nc" id="L497">        removeMetadataFromTable(metadataId, &quot;Keywords&quot;, conn);</span>
<span class="nc" id="L498">        removeMetadataFromTable(metadataId, &quot;Relations&quot;, conn);</span>
<span class="nc" id="L499">        removeMetadataFromTable(metadataId, &quot;Contributors&quot;, conn);</span>
<span class="nc" id="L500">        removeMetadataFromTable(metadataId, &quot;Requirements&quot;, conn);</span>
<span class="nc" id="L501">        removeMetadataFromTable(metadataId, &quot;ContextURLs&quot;, conn);</span>
<span class="nc" id="L502">        removeMetadataFromTable(metadataId, &quot;CopyrightHolders&quot;, conn);</span>
<span class="nc" id="L503">        removeMetadataFromTable(metadataId, &quot;Thumbnails&quot;, conn);</span>
<span class="nc" id="L504">        removeTaxonPaths(metadataId, conn);</span>
<span class="nc" id="L505">        removeCopyrights(metadataId, conn);</span>
<span class="nc" id="L506">        return true;</span>
    }

    /**
     * Returns a ThumbnailBean associated with the
     * given metadataId.
     * If no keywords are found or an error occurs,
     * null is returned.
     */
    public ThumbnailBean getThumbnail(String metadataId, Connection conn)
            throws SQLException {
<span class="nc" id="L517">        ThumbnailBean result = null;</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if(metadataId != null) {</span>
<span class="nc" id="L519">            Vector rows = getMetadataProperties(metadataId,</span>
                    &quot;*&quot;,
                    &quot;Thumbnails&quot;,
                    conn);
<span class="nc bnc" id="L523" title="All 4 branches missed.">            if(rows != null &amp;&amp; rows.size() &gt; 0) {</span>
                try {
                    //just take the first row, there shouldn't be
                    //multiple matches...
<span class="nc" id="L527">                    Row row = (Row)rows.firstElement();</span>
<span class="nc" id="L528">                    result = new ThumbnailBean();</span>
<span class="nc" id="L529">                    result.setThumbnailId(row.getString(&quot;ThumbnailID&quot;));</span>
<span class="nc" id="L530">                    result.setMetadataId(metadataId);</span>
<span class="nc" id="L531">                    result.setLocation(row.getString(&quot;Location&quot;));</span>
<span class="nc" id="L532">                    result.setFileWidth(row.getString(&quot;FileWidth&quot;));</span>
<span class="nc" id="L533">                    result.setFileHeight(row.getString(&quot;FileHeight&quot;));</span>
<span class="nc" id="L534">                } catch(NoSuchColumnException ex) {</span>
<span class="nc" id="L535">                    throw new SQLException(ex.toString());</span>
<span class="nc" id="L536">                }</span>
            }
        }
<span class="nc" id="L539">        return result;</span>
    }
    /**
     * Returns a SourceCollection Bean associated with the
     * given source collection name.
     * If no keywords are found or an error occurs,
     * null is returned.
     */
    public SourceCollectionBean getSCollectionBean(String name, Connection conn)
            throws SQLException
    {
<span class="nc" id="L550">      SourceCollectionBean result = null;</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">      if(name != null)</span>
      {
<span class="nc" id="L553">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L554">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L555">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L556">        sql.append(&quot;SELECT * FROM SourceCollection WHERE name = ?&quot;);</span>
<span class="nc" id="L557">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L558">        Vector values = new Vector();</span>
<span class="nc" id="L559">        values.addElement(new StringValue(name));</span>
<span class="nc" id="L560">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L561">        Vector rows = null;</span>
        try {
<span class="nc" id="L563">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L564">        } catch(UnsupportedTypeException e) {</span>
<span class="nc" id="L565">            throw new SQLException(e.toString());</span>
<span class="nc" id="L566">        }</span>
<span class="nc bnc" id="L567" title="All 4 branches missed.">        if(rows != null &amp;&amp; rows.size() &gt; 0) {</span>
          try {
            //just take the first row, there shouldn't be
            //multiple matches...
<span class="nc" id="L571">            Row row = (Row)rows.firstElement();</span>
<span class="nc" id="L572">            result = new SourceCollectionBean();</span>
<span class="nc" id="L573">            result.setSourceId(row.getString(&quot;SourceCollectionID&quot;));</span>
<span class="nc" id="L574">            result.setSourceName(&quot;Name&quot;);</span>
<span class="nc" id="L575">            result.setLocation(row.getString(&quot;Location&quot;));</span>
<span class="nc" id="L576">            result.setFileWidth(row.getString(&quot;Width&quot;));</span>
<span class="nc" id="L577">            result.setFileHeight(row.getString(&quot;Height&quot;));</span>
<span class="nc" id="L578">            result.setLink(row.getString(&quot;Link&quot;));</span>
<span class="nc" id="L579">          } catch(NoSuchColumnException ex) {</span>
<span class="nc" id="L580">            throw new SQLException(ex.toString());</span>
<span class="nc" id="L581">          }</span>
        }
      }
<span class="nc" id="L584">      return result;</span>
    }
    /**
     * Inserts the information about the specified thumbnail,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveThumbnail(ThumbnailBean thumbnail, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L594" title="All 2 branches missed.">        if(thumbnail == null) {</span>
<span class="nc" id="L595">            return;</span>
        }

<span class="nc" id="L598">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L599">        String thumbnailId = thumbnail.getThumbnailId();</span>

<span class="nc" id="L601">        Vector values = new Vector();</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if(thumbnailId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L604">            sql.append(THUMBNAILINSERTSQL);</span>
        } else {
<span class="nc" id="L606">            sql.append(THUMBNAILUPDATESQL);</span>
        }
<span class="nc" id="L608">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L609">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L610">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L611">        values.addElement(new StringValue(thumbnail.getMetadataId()));</span>
<span class="nc" id="L612">        values.addElement(new StringValue(thumbnail.getLocation()));</span>
<span class="nc" id="L613">        values.addElement(new StringValue(thumbnail.getFileWidth()));</span>
<span class="nc" id="L614">        values.addElement(new StringValue(thumbnail.getFileHeight()));</span>

<span class="nc bnc" id="L616" title="All 2 branches missed.">        if(thumbnailId != null) {</span>
<span class="nc" id="L617">            values.addElement(new StringValue(thumbnailId));</span>
        }
<span class="nc" id="L619">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L620">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L621">    }</span>

    /**
     * Inserts the information about the specified diseaseDiagnosis,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveDiseaseDiagnosis(DiseaseDiagnosisBean diseaseDiagnosis, Connection conn) throws SQLException {
<span class="nc bnc" id="L629" title="All 2 branches missed.">        if(diseaseDiagnosis == null) {</span>
<span class="nc" id="L630">            return;</span>
        }
<span class="nc" id="L632">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L633">        String diseaseDiagnosisId = diseaseDiagnosis.getDiseaseDiagnosisId();</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">        if(diseaseDiagnosisId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L636">            sql.append(DISEASEDIAGNOSISINSERTSQL);</span>
        } else {
<span class="nc" id="L638">            sql.append(DISEASEDIAGNOSISUPDATESQL);</span>
        }
<span class="nc" id="L640">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L641">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L642">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L643">        Vector values = new Vector();</span>
<span class="nc" id="L644">        values.addElement(new StringValue(diseaseDiagnosis.getMetadataId()));</span>
<span class="nc" id="L645">        values.addElement(new StringValue(diseaseDiagnosis.getDiseaseDiagnosis()));</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">        if(diseaseDiagnosisId != null) {</span>
<span class="nc" id="L647">            values.addElement(new StringValue(diseaseDiagnosisId));</span>
        }
<span class="nc" id="L649">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L650">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L651">    }</span>

    /**
     * Inserts the information about the specified copyright,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveCopyright(CopyrightBean copyright, Connection conn) throws SQLException {
<span class="nc bnc" id="L659" title="All 2 branches missed.">        if(copyright == null) {</span>
<span class="nc" id="L660">            return;</span>
        }
<span class="nc" id="L662">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L663">        String copyrightId = copyright.getCopyrightId();</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">        if(copyrightId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L666">            sql.append(COPYRIGHTINSERTSQL);</span>
        } else {
<span class="nc" id="L668">            sql.append(COPYRIGHTUPDATESQL);</span>
        }
<span class="nc" id="L670">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L671">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L672">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L673">        Vector values = new Vector();</span>
<span class="nc" id="L674">        values.addElement(new StringValue(copyright.getMetadataId()));</span>
<span class="nc" id="L675">        String copyrightTextId = saveCopyrightText(copyright.getCopyrightText(), conn);</span>
<span class="nc" id="L676">        values.addElement(new StringValue(copyrightTextId));</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">        if(copyrightId != null) {</span>
<span class="nc" id="L678">            values.addElement(new StringValue(copyright.getCopyrightId()));</span>
        }
<span class="nc" id="L680">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L681">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L682">    }</span>

    /**
     * Stores a CopyrightTextBean in the database.  If the provided
     * CopyrightTextBean has a copyrightTextId that is non-null, an update
     * will be attempted.  Otherwise, an insert will be performed.
     * The copyrightTextId will be returned.  This will either be obtained
     * from the provided bean, or by doing another database lookup after
     * the insert (looking for a match on the copyrightText).
     */
    public String saveCopyrightText(CopyrightTextBean copyrightText, Connection conn) throws SQLException {
<span class="nc bnc" id="L693" title="All 2 branches missed.">        if(copyrightText == null) {</span>
<span class="nc" id="L694">            return null;</span>
        }
<span class="nc" id="L696">        String copyrightTextId = null;</span>
<span class="nc" id="L697">        copyrightTextId = copyrightText.getCopyrightTextId();</span>
<span class="nc" id="L698">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L699">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L700">        Vector values = new Vector();</span>
<span class="nc" id="L701">        StringValue textValue =</span>
<span class="nc" id="L702">                new StringValue(copyrightText.getCopyrightText());</span>
<span class="nc" id="L703">        values.addElement(textValue);</span>
<span class="nc" id="L704">        values.addElement(new StringValue(copyrightText.getCost()));</span>
<span class="nc" id="L705">        values.addElement(new StringValue(copyrightText.getCopyrightAndOtherRestriction()));</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">        if(copyrightTextId != null) {</span>
<span class="nc" id="L707">            sqlCommandBean.setSqlValue(COPYRIGHTTEXTUPDATESQL);</span>
<span class="nc" id="L708">            values.addElement(new StringValue(copyrightText.getCopyrightTextId()));</span>
        } else {
<span class="nc" id="L710">            sqlCommandBean.setSqlValue(COPYRIGHTTEXTINSERTSQL);</span>
        }
<span class="nc" id="L712">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L713">        sqlCommandBean.executeUpdate();</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">        if(copyrightTextId == null) {</span>
            try {
<span class="nc" id="L716">                sqlCommandBean.setSqlValue(COPYRIGHTTEXTLOOKUPIDSQL);</span>
<span class="nc" id="L717">                values.clear();</span>
<span class="nc" id="L718">                values.addElement(textValue);</span>
                Vector rows;
<span class="nc" id="L720">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L721">                Row aRow = (Row)rows.firstElement();</span>
<span class="nc" id="L722">                copyrightTextId = aRow.getString(&quot;CopyrightTextID&quot;);</span>
<span class="nc" id="L723">            } catch(UnsupportedTypeException e) {</span>
<span class="nc" id="L724">                throw new SQLException(e.toString());</span>
<span class="nc" id="L725">            } catch(NoSuchColumnException ex) {</span>
<span class="nc" id="L726">                throw new SQLException(ex.toString());</span>
<span class="nc" id="L727">            }</span>
        }
<span class="nc" id="L729">        return copyrightTextId;</span>
    }

    /**
     * Inserts the information about the specified copyrightHolder,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveCopyrightHolder(CopyrightHolderBean copyrightHolder,
                                    Connection conn)
            throws SQLException {

<span class="nc bnc" id="L741" title="All 2 branches missed.">        if(copyrightHolder == null) {</span>
<span class="nc" id="L742">            return;</span>
        }

<span class="nc" id="L745">        String vCardID = saveVCard(copyrightHolder.getVCard(), conn);</span>

<span class="nc" id="L747">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L748">        String copyrightHolderId = copyrightHolder.getCopyrightHolderId();</span>
<span class="nc bnc" id="L749" title="All 2 branches missed.">        if(copyrightHolderId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L751">            sql.append(COPYRIGHTHOLDERINSERTSQL);</span>
        } else {
<span class="nc" id="L753">            sql.append(COPYRIGHTHOLDERUPDATESQL);</span>
        }
<span class="nc" id="L755">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L756">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L757">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L758">        Vector values = new Vector();</span>
<span class="nc" id="L759">        values.addElement(new StringValue(copyrightHolder.getMetadataId()));</span>
<span class="nc" id="L760">        values.addElement(new StringValue(vCardID));</span>

<span class="nc bnc" id="L762" title="All 2 branches missed.">        if(copyrightHolderId != null) {</span>
<span class="nc" id="L763">            values.addElement(new StringValue(copyrightHolderId));</span>
        }
<span class="nc" id="L765">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L766">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L767">    }</span>

    /**
     * @param vCard non-null vcard String
     * @param conn
     *
     * @return
     *
     * @throws SQLException
     */
    public String saveVCard(String vCard, Connection conn)
            throws SQLException {
<span class="nc" id="L779">        vCard = vCard.trim();</span>
<span class="nc" id="L780">        String vCardID = getVCardIDByVCard(vCard, conn);</span>

<span class="nc bnc" id="L782" title="All 2 branches missed.">        if(vCardID == null) {</span>
            // No current vCard found, so we have to insert one
<span class="nc" id="L784">            SQLCommandBean sqlInsertCommand = new SQLCommandBean();</span>
<span class="nc" id="L785">            sqlInsertCommand.setConnection(conn);</span>
<span class="nc" id="L786">            sqlInsertCommand.setSqlValue(&quot;INSERT INTO vCards (vCard) VALUES (?)&quot;);</span>
<span class="nc" id="L787">            Vector insertValues = new Vector();</span>
<span class="nc" id="L788">            insertValues.add(new StringValue(vCard));</span>
<span class="nc" id="L789">            sqlInsertCommand.setValues(insertValues);</span>
<span class="nc" id="L790">            sqlInsertCommand.executeUpdate();</span>
<span class="nc" id="L791">            vCardID = getVCardIDByVCard(vCard, conn);</span>
        }
<span class="nc" id="L793">        return vCardID;</span>
    }

    /**
     * Returns a vCardID or null if no VCard matching the vCard parameter
     * is found.
     *
     * @param vCard The String of the vCard to be found
     * @param conn The connection to the database.
     *
     * @return &lt;code&gt;null&lt;/code&gt;If no vCard is found, otherwise returns a
     *         &lt;code&gt;String&lt;/code&gt; containing the vCardID
     */
    private String getVCardIDByVCard(String vCard, Connection conn) throws SQLException {
<span class="nc" id="L807">        SQLCommandBean sqlCommand = new SQLCommandBean();</span>
<span class="nc" id="L808">        sqlCommand.setConnection(conn);</span>
<span class="nc" id="L809">        sqlCommand.setSqlValue(&quot;SELECT vCardID FROM vCards WHERE vCard LIKE ?&quot;);</span>
<span class="nc" id="L810">        Vector values = new Vector();</span>
<span class="nc" id="L811">        values.add(new StringValue(vCard));</span>
<span class="nc" id="L812">        sqlCommand.setValues(values);</span>

        Vector results;
        try {
<span class="nc" id="L816">            results = sqlCommand.executeQuery();</span>
<span class="nc" id="L817">        } catch(UnsupportedTypeException e) {</span>
<span class="nc" id="L818">            throw new SQLException(e.getMessage());</span>
<span class="nc" id="L819">        }</span>
<span class="nc bnc" id="L820" title="All 4 branches missed.">        if(results != null &amp;&amp; results.size() &gt; 0) {</span>
<span class="nc" id="L821">            Row row = (Row)results.get(0);</span>
            try {
<span class="nc" id="L823">                return row.getString(&quot;vCardID&quot;);</span>
<span class="nc" id="L824">            } catch(NoSuchColumnException e) {</span>
<span class="nc" id="L825">                throw new SQLException(e.getMessage());</span>
            }
        }
        else
<span class="nc" id="L829">        return null;</span>
    }

    public void saveTaxonPath(TaxonPathBean taxonPath) throws SQLException {
<span class="nc bnc" id="L833" title="All 2 branches missed.">        if(null == taxonPath) {</span>
<span class="nc" id="L834">            return;</span>
        }
<span class="nc" id="L836">        Connection conn = dataSource.getConnection();</span>
        try {
<span class="nc" id="L838">            saveTaxonPath(taxonPath, conn);</span>
        } finally {
<span class="nc" id="L840">            conn.close();</span>
        }
<span class="nc" id="L842">    }</span>

    /**
     * Inserts the information about the specified taxon path,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveTaxonPath(TaxonPathBean taxonPath, Connection conn) throws SQLException {
<span class="nc bnc" id="L850" title="All 2 branches missed.">        if(taxonPath == null) {</span>
<span class="nc" id="L851">            return;</span>
        }
<span class="nc" id="L853">        String taxonPathId = taxonPath.getTaxonPathId();</span>
<span class="nc" id="L854">        final String source = taxonPath.getSource();</span>
<span class="nc" id="L855">        final String purpose = taxonPath.getPurpose();</span>
<span class="nc" id="L856">        final String description = taxonPath.getDescription();</span>
<span class="nc" id="L857">        final String keyword = taxonPath.getKeyword();</span>
<span class="nc" id="L858">        final String metadataId = taxonPath.getMetadataId();</span>

        // Checks if a taxon path like this already exists in the db
<span class="nc bnc" id="L861" title="All 2 branches missed.">        if(null == taxonPathId) {</span>
<span class="nc" id="L862">            taxonPathId = getTaxonPathId(metadataId, source, conn);</span>
        }

<span class="nc bnc" id="L865" title="All 2 branches missed.">        if(taxonPathId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L867">            final String sql = TAXONPATHINSERTSQL;</span>
<span class="nc" id="L868">            final SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>

<span class="nc" id="L870">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L871">            sqlCommandBean.setSqlValue(sql);</span>

            // Sets a temporary source so that we can grab the taxon path id with a unique value
<span class="nc" id="L874">            final String tempSource = metadataId + System.currentTimeMillis();</span>

<span class="nc" id="L876">            Vector values = new Vector();</span>
<span class="nc" id="L877">            values.addElement(new StringValue(metadataId));</span>
<span class="nc" id="L878">            values.addElement(new StringValue(tempSource));</span>
<span class="nc" id="L879">            values.addElement(new StringValue(purpose));</span>
<span class="nc" id="L880">            values.addElement(new StringValue(description));</span>
<span class="nc" id="L881">            values.addElement(new StringValue(keyword));</span>
<span class="nc" id="L882">            sqlCommandBean.setValues(values);</span>
<span class="nc" id="L883">            sqlCommandBean.executeUpdate();</span>

            // Gets the taxon path id using the unique temporary source value
<span class="nc" id="L886">            sqlCommandBean.setSqlValue(&quot;SELECT TaxonPathID FROM &quot; + &quot;TaxonPaths WHERE Source = ?&quot;);</span>
<span class="nc" id="L887">            values.clear();</span>
<span class="nc" id="L888">            values.addElement(new StringValue(tempSource));</span>
          //  values.addElement(new StringValue(purpose));
           // values.addElement(new StringValue(description));
          //  values.addElement(new StringValue(keyword));
<span class="nc" id="L892">            sqlCommandBean.setValues(values);</span>

            try {
<span class="nc" id="L895">                Vector rows = sqlCommandBean.executeQuery();</span>
<span class="nc bnc" id="L896" title="All 4 branches missed.">                if(rows != null &amp;&amp; rows.size() &gt; 0) {</span>
<span class="nc" id="L897">                    Row aRow = (Row)rows.firstElement();</span>

                    // taxonPathId is used below to set the taxon path bean's taxon path id
<span class="nc" id="L900">                    taxonPathId = aRow.getString(&quot;TaxonPathID&quot;);</span>

                    // fixes the temporary source
<span class="nc" id="L903">                    sqlCommandBean.setSqlValue(&quot;UPDATE TaxonPaths SET &quot; + &quot;Source = ?, Purpose = ?, Description = ?, Keyword = ? &quot; + &quot;WHERE TaxonPathID = ?&quot;);</span>
<span class="nc" id="L904">                    values.clear();</span>
<span class="nc" id="L905">                    values.addElement(new StringValue(source));</span>
<span class="nc" id="L906">                    values.addElement(new StringValue(purpose));</span>
<span class="nc" id="L907">                    values.addElement(new StringValue(description));</span>
<span class="nc" id="L908">                    values.addElement(new StringValue(keyword));</span>
<span class="nc" id="L909">                    values.addElement(new StringValue(taxonPathId));</span>
<span class="nc" id="L910">                    sqlCommandBean.setValues(values);</span>
<span class="nc" id="L911">                    sqlCommandBean.executeUpdate();</span>
                }
<span class="nc" id="L913">            } catch(NoSuchColumnException ex) {</span>
<span class="nc" id="L914">                throw new SQLException(ex.toString());</span>
<span class="nc" id="L915">            } catch(UnsupportedTypeException ex2) {</span>
<span class="nc" id="L916">                throw new SQLException(ex2.toString());</span>
<span class="nc" id="L917">            }</span>
        }
<span class="nc" id="L919">        taxonPath.setTaxonPathId(taxonPathId);</span>

        // There should be a taxon path id now
<span class="nc bnc" id="L922" title="All 4 branches missed.">        if(taxonPathId != null &amp;&amp; taxonPath.getTaxons() != null) {</span>
<span class="nc" id="L923">            Iterator taxonIterator = taxonPath.getTaxons().iterator();</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">            while(taxonIterator.hasNext()) {</span>
<span class="nc" id="L925">                TaxonBean taxon = (TaxonBean)taxonIterator.next();</span>
<span class="nc" id="L926">                taxon.setTaxonPathId(taxonPathId);</span>
<span class="nc" id="L927">                saveTaxon(taxon, conn);</span>
<span class="nc" id="L928">            }</span>
<span class="nc" id="L929">        } else {</span>
<span class="nc" id="L930">            throw new RuntimeException(&quot;Unable to save TaxonPath&quot;);</span>
        }
<span class="nc" id="L932">    }</span>

    private String getTaxonPathId(final String metadataId, final String source, final Connection conn) throws SQLException {
<span class="nc" id="L935">        final String sql = &quot;SELECT TaxonPathId FROM TaxonPaths WHERE MetadataID = ? AND Source = ?&quot;;</span>
<span class="nc" id="L936">        String ret = null;</span>

<span class="nc" id="L938">        PreparedStatement ps = null;</span>
<span class="nc" id="L939">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L941">            ps = conn.prepareStatement(sql);</span>
<span class="nc" id="L942">            ps.setString(1, metadataId);</span>
<span class="nc" id="L943">            ps.setString(2, source);</span>
<span class="nc" id="L944">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">            if(rs.next()) {</span>
<span class="nc" id="L946">                ret = rs.getString(1);</span>
            }
        } finally {
<span class="nc bnc" id="L949" title="All 2 branches missed.">            if(null != rs) {</span>
<span class="nc" id="L950">                rs.close();</span>
            }
<span class="nc bnc" id="L952" title="All 2 branches missed.">            if(null != ps) {</span>
<span class="nc" id="L953">                ps.close();</span>
            }
        }
<span class="nc" id="L956">        return ret;</span>
    }

    /**
     * Inserts the information about the specified taxon,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveTaxon(TaxonBean taxon, Connection conn) throws SQLException {
<span class="nc" id="L965">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L966">        String taxonId = taxon.getTaxonId();</span>
<span class="nc" id="L967">        String taxonPathId = taxon.getTaxonPathId();</span>
<span class="nc" id="L968">        String id = taxon.getId();</span>
<span class="nc" id="L969">        String entry = taxon.getEntry();</span>

        // Checks to see if a Taxon matching this  bean already exists
        // in the database
<span class="nc" id="L973">        String existingTaxon = getTaxonId(taxon, conn);</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">        if(null != existingTaxon) {</span>
<span class="nc" id="L975">            taxon.setTaxonId(existingTaxon);</span>
<span class="nc" id="L976">            return;</span>
        }

<span class="nc bnc" id="L979" title="All 2 branches missed.">        if(taxonId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L981">            sql.append(TAXONINSERTSQL);</span>
        } else {
<span class="nc" id="L983">            sql.append(TAXONUPDATESQL);</span>
        }
<span class="nc" id="L985">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L986">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L987">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L988">        Vector values = new Vector();</span>
<span class="nc" id="L989">        values.addElement(new StringValue(taxonPathId));</span>
<span class="nc" id="L990">        values.addElement(new StringValue(id));</span>
<span class="nc" id="L991">        values.addElement(new StringValue(entry));</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">        if(taxonId != null) {</span>
<span class="nc" id="L993">            values.addElement(new StringValue(taxonId));</span>
        }
<span class="nc" id="L995">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L996">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L997">    }</span>

    private String getTaxonId(TaxonBean taxon, Connection conn) throws SQLException {
<span class="nc" id="L1000">        String ret = null;</span>
<span class="nc" id="L1001">        PreparedStatement ps = null;</span>
<span class="nc" id="L1002">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L1004">            String sql = &quot;SELECT TaxonID FROM Taxons WHERE Id = ? AND Entry = ? AND TaxonPathID = ?&quot;;</span>
<span class="nc" id="L1005">            ps = conn.prepareStatement(sql);</span>
<span class="nc" id="L1006">            ps.setString(1, taxon.getId());</span>
<span class="nc" id="L1007">            ps.setString(2, taxon.getEntry());</span>
<span class="nc" id="L1008">            ps.setString(3, taxon.getTaxonPathId());</span>
<span class="nc" id="L1009">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">            if(rs.next()) {</span>
<span class="nc" id="L1011">                ret = rs.getString(1);</span>
            }
        } finally {
<span class="nc bnc" id="L1014" title="All 2 branches missed.">            if(null != rs) {</span>
<span class="nc" id="L1015">                rs.close();</span>
            }
<span class="nc bnc" id="L1017" title="All 2 branches missed.">            if(null != ps) {</span>
<span class="nc" id="L1018">                ps.close();</span>
            }
        }

<span class="nc" id="L1022">        return ret;</span>
    }

    /**
     * Inserts the information about the specified contextURL,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveContextURL(ContextURLBean contextURL, Connection conn) throws SQLException {
<span class="nc bnc" id="L1031" title="All 2 branches missed.">        if(contextURL == null) {</span>
<span class="nc" id="L1032">            return;</span>
        }
<span class="nc" id="L1034">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L1035">        String contextURLId = contextURL.getContextURLId();</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">        if(contextURLId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L1038">            sql.append(CONTEXTURLINSERTSQL);</span>
        } else {
<span class="nc" id="L1040">            sql.append(CONTEXTURLUPDATESQL);</span>
        }
<span class="nc" id="L1042">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1043">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1044">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L1045">        Vector values = new Vector();</span>
<span class="nc" id="L1046">        values.addElement(new StringValue(contextURL.getMetadataId()));</span>
<span class="nc" id="L1047">        values.addElement(new StringValue(contextURL.getContextURL()));</span>
<span class="nc" id="L1048">        values.addElement(new StringValue(contextURL.getContextURLDescription()));</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">        if(contextURLId != null) {</span>
<span class="nc" id="L1050">            values.addElement(new StringValue(contextURLId));</span>
        }
<span class="nc" id="L1052">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1053">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1054">    }</span>

    /**
     * Inserts the information about the specified contributor,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveContributor(ContributorBean contributor, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L1064" title="All 2 branches missed.">        if(contributor == null) {</span>
<span class="nc" id="L1065">            return;</span>
        }

<span class="nc" id="L1068">        String vCardID = saveVCard(contributor.getVCard(), conn);</span>

<span class="nc" id="L1070">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L1071">        String contributorId = contributor.getContributorId();</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">        if(contributorId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L1074">            sql.append(CONTRIBUTORINSERTSQL);</span>
        } else {
<span class="nc" id="L1076">            sql.append(CONTRIBUTORUPDATESQL);</span>
        }
<span class="nc" id="L1078">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1079">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1080">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L1081">        Vector values = new Vector();</span>
<span class="nc" id="L1082">        values.addElement(new StringValue(contributor.getMetadataId()));</span>
<span class="nc" id="L1083">        values.addElement(new StringValue(contributor.getRole()));</span>
<span class="nc" id="L1084">        values.addElement(new StringValue(vCardID));</span>

<span class="nc" id="L1086">        java.sql.Date contributeDate = null;</span>
<span class="nc bnc" id="L1087" title="All 2 branches missed.">        if(null != contributor.getDate()) {</span>
<span class="nc" id="L1088">            contributeDate = new java.sql.Date(contributor.getDate().getTime());</span>
        }
<span class="nc" id="L1090">        values.addElement(new DateValue(contributeDate));</span>
<span class="nc" id="L1091">        values.addElement(new StringValue(contributor.getDateDescription()));</span>
<span class="nc" id="L1092">        values.addElement(new StringValue(contributor.getVersion()));</span>
<span class="nc" id="L1093">        values.addElement(new StringValue(contributor.getStatus()));</span>
<span class="nc bnc" id="L1094" title="All 2 branches missed.">        if(contributorId != null) {</span>
<span class="nc" id="L1095">            values.addElement(new StringValue(contributor.getContributorId()));</span>
        }
<span class="nc" id="L1097">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1098">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1099">    }</span>


    /**
     * Inserts the information about the specified requirement,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveRequirement(RequirementBean requirement, Connection conn) throws SQLException {
<span class="nc bnc" id="L1108" title="All 2 branches missed.">        if(requirement == null) {</span>
<span class="nc" id="L1109">            return;</span>
        }
<span class="nc" id="L1111">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L1112">        String requirementId = requirement.getRequirementId();</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">        if(requirementId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L1115">            sql.append(REQUIREMENTINSERTSQL);</span>
        } else {
<span class="nc" id="L1117">            sql.append(REQUIREMENTUPDATESQL);</span>
        }
<span class="nc" id="L1119">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1120">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1121">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L1122">        Vector values = new Vector();</span>
<span class="nc" id="L1123">        values.addElement(new StringValue(requirement.getMetadataId()));</span>
<span class="nc" id="L1124">        values.addElement(new StringValue(requirement.getRequirementType()));</span>
<span class="nc" id="L1125">        values.addElement(new StringValue(requirement.getRequirementName()));</span>
<span class="nc" id="L1126">        values.addElement(new StringValue(requirement.getOtherPlatform()));</span>
<span class="nc" id="L1127">        values.addElement(new StringValue(requirement.getDuration()));</span>
<span class="nc" id="L1128">        values.addElement(new StringValue(requirement.getDescription()));</span>
<span class="nc bnc" id="L1129" title="All 2 branches missed.">        if(requirementId != null) {</span>
<span class="nc" id="L1130">            values.addElement(new StringValue(requirement.getRequirementId()));</span>
        }
<span class="nc" id="L1132">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1133">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1134">    }</span>

    /**
     * Inserts the information about the specified relation,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveRelation(RelationBean relation, Connection conn) throws SQLException {
<span class="nc bnc" id="L1142" title="All 2 branches missed.">        if(relation == null) {</span>
<span class="nc" id="L1143">            return;</span>
        }
<span class="nc" id="L1145">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L1146">        String relationId = relation.getRelationId();</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">        if(relationId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L1149">            sql.append(RELATIONINSERTSQL);</span>
        } else {
<span class="nc" id="L1151">            sql.append(RELATIONUPDATESQL);</span>
        }
<span class="nc" id="L1153">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1154">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1155">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L1156">        Vector values = new Vector();</span>
<span class="nc" id="L1157">        values.addElement(new StringValue(relation.getMetadataId()));</span>
<span class="nc" id="L1158">        values.addElement(new StringValue(relation.getResource()));</span>
<span class="nc" id="L1159">        values.addElement(new StringValue(relation.getKind()));</span>
<span class="nc" id="L1160">        values.addElement(new StringValue(relation.getDescription()));</span>
<span class="nc" id="L1161">        values.addElement(new StringValue(relation.getCatalogue()));</span>
<span class="nc" id="L1162">        values.addElement(new StringValue(relation.getEntry()));</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">        if(relationId != null) {</span>
<span class="nc" id="L1164">            values.addElement(new StringValue(relation.getRelationId()));</span>
        }
<span class="nc" id="L1166">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1167">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1168">    }</span>

    /**
     * Inserts the information about the specified keyword,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveKeyword(KeywordBean keyword, Connection conn) throws SQLException {
<span class="nc bnc" id="L1176" title="All 2 branches missed.">        if(keyword == null) {</span>
<span class="nc" id="L1177">            return;</span>
        }
<span class="nc" id="L1179">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L1180">        String keywordId = keyword.getKeywordId();</span>
<span class="nc bnc" id="L1181" title="All 2 branches missed.">        if(keywordId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L1183">            sql.append(KEYWORDINSERTSQL);</span>
        } else {
<span class="nc" id="L1185">            sql.append(KEYWORDUPDATESQL);</span>
        }
<span class="nc" id="L1187">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1188">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1189">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L1190">        Vector values = new Vector();</span>
<span class="nc" id="L1191">        values.addElement(new StringValue(keyword.getMetadataId()));</span>
<span class="nc" id="L1192">        values.addElement(new StringValue(keyword.getKeyword()));</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">        if(keywordId != null) {</span>
<span class="nc" id="L1194">            values.addElement(new StringValue(keywordId));</span>
        }
<span class="nc" id="L1196">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1197">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1198">    }</span>

    /**
     * Inserts the information about the specified keyword,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveTargetUserGroup(TargetUserGroupBean tug, Connection conn) throws SQLException {
<span class="nc bnc" id="L1206" title="All 2 branches missed.">        if(tug == null) {</span>
<span class="nc" id="L1207">            return;</span>
        }
<span class="nc" id="L1209">        List&lt;TargetUserGroupBean&gt; existingTugs = new ArrayList&lt;TargetUserGroupBean&gt;();</span>
<span class="nc" id="L1210">        Vector rows = null;</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">        if(null != tug.getMetadataId()) {</span>
<span class="nc" id="L1212">            rows = getMetadataProperties(tug.getMetadataId(), &quot;TargetUserGroup&quot;, &quot;TargetUserGroups&quot;, conn);</span>
        }
<span class="nc bnc" id="L1214" title="All 2 branches missed.">        if(null != rows) {</span>
            try {
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                for(Iterator iter = rows.iterator(); iter.hasNext(); ) {</span>
<span class="nc" id="L1217">                    Row row = (Row)iter.next();</span>
<span class="nc" id="L1218">                    String tugDescription = row.getString(&quot;TargetUserGroup&quot;);</span>
<span class="nc" id="L1219">                    TargetUserGroupBean temp = new TargetUserGroupBean();</span>
<span class="nc" id="L1220">                    temp.setMetadataId(tug.getMetadataId());</span>
<span class="nc" id="L1221">                    temp.setTargetUserGroup(tugDescription);</span>
<span class="nc" id="L1222">                    existingTugs.add(temp);</span>
<span class="nc" id="L1223">                }</span>
<span class="nc" id="L1224">            } catch(NoSuchColumnException e) {</span>
<span class="nc" id="L1225">                throw new RuntimeException(e);</span>
<span class="nc" id="L1226">            }</span>
        }
<span class="nc bnc" id="L1228" title="All 2 branches missed.">        if(null != tug.getTargetUserGroup()) {</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">            for(TargetUserGroupBean existingTug : existingTugs) {</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">                if(tug.getTargetUserGroup().equals(existingTug.getTargetUserGroup())) {</span>
                    // We don't need to save this TUG, because it already exists
<span class="nc" id="L1232">                    return;</span>
                }
<span class="nc" id="L1234">            }</span>
        }
<span class="nc" id="L1236">        String sql = TARGETUSERGROUPINSERTSQL;</span>
<span class="nc" id="L1237">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1238">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1239">        sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L1240">        Vector values = new Vector();</span>
<span class="nc" id="L1241">        values.addElement(new StringValue(tug.getMetadataId()));</span>
<span class="nc" id="L1242">        values.addElement(new StringValue(tug.getTargetUserGroup()));</span>
<span class="nc" id="L1243">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1244">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1245">    }</span>

    public void deleteTargetUserGroupsByMetadataId(final String metadataId, final Connection conn) throws SQLException {
<span class="nc bnc" id="L1248" title="All 2 branches missed.">        if(null == metadataId) return;</span>

<span class="nc" id="L1250">        final String sql = &quot;DELETE FROM TargetUserGroups WHERE MetadataId = ?&quot;;</span>
<span class="nc" id="L1251">        PreparedStatement ps = null;</span>
        try {
<span class="nc" id="L1253">            ps = conn.prepareStatement(sql);</span>
<span class="nc" id="L1254">            ps.setString(1, metadataId);</span>
<span class="nc" id="L1255">            ps.executeUpdate();</span>
        } finally {
<span class="nc bnc" id="L1257" title="All 2 branches missed.">            if(null != ps) {</span>
<span class="nc" id="L1258">                ps.close();</span>
            }
        }
<span class="nc" id="L1261">    }</span>

    /**
     * Inserts the information about the specified format,
     * or updates the information if it's already defined in the
     * database.
     */
    public void saveFormat(FormatBean format, Connection conn) throws SQLException {
<span class="nc bnc" id="L1269" title="All 2 branches missed.">        if(format == null) {</span>
<span class="nc" id="L1270">            return;</span>
        }
<span class="nc" id="L1272">        StringBuffer sql = new StringBuffer();</span>
<span class="nc" id="L1273">        String formatId = format.getFormatId();</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">        if(formatId == null) {</span>
            // Use INSERT statement
<span class="nc" id="L1276">            sql.append(FORMATINSERTSQL);</span>
        } else {
<span class="nc" id="L1278">            sql.append(FORMATUPDATESQL);</span>
        }
<span class="nc" id="L1280">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1281">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1282">        sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L1283">        Vector values = new Vector();</span>
<span class="nc" id="L1284">        values.addElement(new StringValue(format.getMetadataId()));</span>
<span class="nc" id="L1285">        values.addElement(new StringValue(format.getFormat()));</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">        if(formatId != null) {</span>
<span class="nc" id="L1287">            values.addElement(new StringValue(formatId));</span>
        }
<span class="nc" id="L1289">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1290">        sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1291">    }</span>

    public List getMetametadataIdentifiers(String metadataId, Connection conn) {
<span class="nc" id="L1294">        List&lt;MetametadataIdentifierBean&gt; ret = new ArrayList&lt;MetametadataIdentifierBean&gt;();</span>
<span class="nc" id="L1295">        PreparedStatement ps = null;</span>
<span class="nc" id="L1296">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L1298">            ps = conn.prepareStatement(&quot;SELECT MetametadataIdentifierID, Catalogue, Entry, MetadataSchema FROM MetametadataIdentifiers WHERE MetadataID = ?&quot;);</span>
<span class="nc" id="L1299">            ps.setString(1, metadataId);</span>
<span class="nc" id="L1300">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1301" title="All 2 branches missed.">            while(rs.next()) {</span>
<span class="nc" id="L1302">                MetametadataIdentifierBean mib = new MetametadataIdentifierBean();</span>
<span class="nc" id="L1303">                mib.setMetametadataIdentifierId(rs.getString(1));</span>
<span class="nc" id="L1304">                mib.setMetadataId(metadataId);</span>
<span class="nc" id="L1305">                mib.setCatalog(rs.getString(2));</span>
<span class="nc" id="L1306">                mib.setEntry(rs.getString(3));</span>
<span class="nc" id="L1307">                mib.setMetadataSchema(rs.getString(4));</span>
<span class="nc" id="L1308">                ret.add(mib);</span>
<span class="nc" id="L1309">            }</span>
<span class="nc" id="L1310">        } catch(SQLException e) {</span>
<span class="nc" id="L1311">            throw new RuntimeException(e);</span>
        } finally {
            try {
<span class="nc bnc" id="L1314" title="All 2 branches missed.">                if(null != rs) {</span>
<span class="nc" id="L1315">                    rs.close();</span>
                }
<span class="nc bnc" id="L1317" title="All 2 branches missed.">                if(null != ps) {</span>
<span class="nc" id="L1318">                    ps.close();</span>
                }
<span class="nc" id="L1320">            } catch(SQLException e) {</span>
<span class="nc" id="L1321">                throw new RuntimeException(e);</span>
<span class="nc" id="L1322">            }</span>
        }
<span class="nc" id="L1324">        return ret;</span>
    }

    public List getMetametadataContributors(String metadataId, Connection conn) throws SQLException {
<span class="nc" id="L1328">        List&lt;MetametadataContributorBean&gt; ret = new ArrayList&lt;MetametadataContributorBean&gt;();</span>

<span class="nc" id="L1330">        PreparedStatement ps = null;</span>
<span class="nc" id="L1331">        ResultSet rs = null;</span>
        try {
<span class="nc" id="L1333">            ps = conn.prepareStatement(&quot;SELECT A.MetametadataContributorID, A.Role, A.ContributeDate, A.ContributeDateDescription, B.vCard FROM MetametadataContributors A INNER JOIN vCards B ON A.vCardID = B.vCardID WHERE A.MetadataID = ?&quot;);</span>
<span class="nc" id="L1334">            ps.setString(1, metadataId);</span>
<span class="nc" id="L1335">            rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1336" title="All 2 branches missed.">            while(rs.next()) {</span>
<span class="nc" id="L1337">                MetametadataContributorBean mcb = new MetametadataContributorBean();</span>
<span class="nc" id="L1338">                mcb.setMetametadataContributorId(rs.getString(1));</span>
<span class="nc" id="L1339">                mcb.setRole(rs.getString(2));</span>
<span class="nc" id="L1340">                mcb.setDate(rs.getDate(3));</span>
<span class="nc" id="L1341">                mcb.setDateDescription(rs.getString(4));</span>
<span class="nc" id="L1342">                mcb.setvCard(rs.getString(5));</span>
<span class="nc" id="L1343">                mcb.setMetadataId(metadataId);</span>

<span class="nc" id="L1345">                ret.add(mcb);</span>
<span class="nc" id="L1346">            }</span>
        } finally {
<span class="nc bnc" id="L1348" title="All 2 branches missed.">            if(null != rs) {</span>
<span class="nc" id="L1349">                rs.close();</span>
            }
<span class="nc bnc" id="L1351" title="All 2 branches missed.">            if(null != ps) {</span>
<span class="nc" id="L1352">                ps.close();</span>
            }
        }

<span class="nc" id="L1356">        return ret;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>