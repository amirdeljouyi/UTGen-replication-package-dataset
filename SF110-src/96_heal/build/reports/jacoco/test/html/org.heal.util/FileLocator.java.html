<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileLocator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.util</a> &gt; <span class="el_source">FileLocator.java</span></div><h1>FileLocator.java</h1><pre class="source lang-java linenums">package org.heal.util;

import org.heal.module.user.UserBean;

import java.io.File;
import java.io.IOException;
import java.io.Serializable;

/**
 * This class translates URLs to file system paths and vice versa.
 *
 * @author Seth Wright
 * @version 0.1
 */
<span class="fc" id="L15">public class FileLocator implements Serializable {</span>

    public static final String DEFAULT_UPLOAD_DIRECTORY = &quot;upload&quot;;
    public static final String DEFAULT_THUMBNAIL_DIRECTORY = &quot;thumbnails&quot;;
    public static final String DEFAULT_CONTENT_DIRECTORY = &quot;content&quot;;
    public static final String DEFAULT_PACKAGE_DIRECTORY = &quot;package&quot;;

<span class="fc" id="L22">    private String uploadDirectory = DEFAULT_UPLOAD_DIRECTORY;</span>
<span class="fc" id="L23">    private File uploadDirectoryFile = null;</span>
<span class="fc" id="L24">    private String uploadFilePath = null;</span>
<span class="fc" id="L25">    private String uploadURL = null;</span>
<span class="fc" id="L26">    private String serverBaseURL = null;</span>
<span class="fc" id="L27">    private int serverBaseURLLength = -1;</span>
<span class="fc" id="L28">    private String contentDirectory = DEFAULT_CONTENT_DIRECTORY;</span>
<span class="fc" id="L29">    private File contentDirectoryFile = null;</span>
<span class="fc" id="L30">    private String contentFilePath = null;</span>
<span class="fc" id="L31">    private String contentURL = null;</span>
<span class="fc" id="L32">    private String baseFilePath = null;</span>
<span class="fc" id="L33">    private int baseFilePathLength = -1;</span>
<span class="fc" id="L34">    private String packageDirectory = DEFAULT_PACKAGE_DIRECTORY;</span>
<span class="fc" id="L35">    private File packageDirectoryFile = null;</span>
<span class="fc" id="L36">    private String packageFilePath = null;</span>
<span class="fc" id="L37">    private String packageURL = null;</span>
<span class="fc" id="L38">    private String thumbnailDirectory = DEFAULT_THUMBNAIL_DIRECTORY;</span>
<span class="fc" id="L39">    private File thumbnailDirectoryFile = null;</span>
<span class="fc" id="L40">    private String thumbnailFilePath = null;</span>
<span class="fc" id="L41">    private String thumbnailURL = null;</span>
<span class="fc" id="L42">    private long maxUploadSize = 512 * 1024 * 1024; //512 Megabytes</span>

    /**
     * Returns the maximum size allowed for uploaded files.
     * This value is in bytes.
     */
    public long getMaxUploadSize() {
<span class="nc" id="L49">        return maxUploadSize;</span>
    }

    /**
     * Sets the maximum size allowed for uploaded files.
     * This value is in bytes.
     */
    public void setMaxUploadSize(long newMaxUploadSize) {
<span class="nc" id="L57">        maxUploadSize = newMaxUploadSize;</span>
<span class="nc" id="L58">    }</span>

    /**
     * Returns the upload directory property setting.
     * This is the path that is tacked on after either the baseURL
     * or the baseFilePath to get the logical or translated locations
     * of the files in the upload directory.  The URL for the upload
     * directory will then be: http://&lt;baseURL&gt;/&lt;uploadDirectory&gt;/
     * and the path to the upload directory will reside at:
     * &lt;baseFilePath&gt;/&lt;uploadDirectory&gt;/
     */
    public String getUploadDirectory() {
<span class="nc" id="L70">        return uploadDirectory;</span>
    }

    /**
     * Determines the directory to store content below the base directory
     * used in the various sections of the application (i.e. content or upload)
     * This plus the filename should be used to create the location setting
     * in the Metadata table.
     * The directory is created by combining information from the given
     * user with the given format (i.e. illustration/photograph)
     * The returned directory is of the format:
     * &lt;user id&gt;/&lt;contentFormat&gt;
     * If user is null, or contentformat is null (or empty), returns null.
     */
    public String getLocationDirectory(UserBean user, String contentFormat) {
<span class="nc bnc" id="L85" title="All 6 branches missed.">        if(user == null || contentFormat == null || contentFormat.length() &lt; 1) {</span>
<span class="nc" id="L86">            return null;</span>
        }
<span class="nc" id="L88">        return user.getUserId() + File.separator + contentFormat;</span>
    }

    /**
     * Returns the thumbnail directory property setting.
     * This is the path that is tacked on after either the baseURL
     * or the baseFilePath to get the logical or translated locations
     * of the files in the thumbnail directory.  The URL for the thumbnail
     * directory will then be: http://&lt;baseURL&gt;/&lt;thumbnailDirectory&gt;/
     * and the path to the thumbnail directory will reside at:
     * &lt;baseFilePath&gt;/&lt;thumbnailDirectory&gt;/
     */
    public String getThumbnailDirectory() {
<span class="nc" id="L101">        return thumbnailDirectory;</span>
    }

    /**
     * Returns the server base URL property setting.
     * This is the base url on the server where all content
     * (uploaded, cataloged, approved - all content in the system).
     * This baseurl + the upload directory should point to the
     * upload directory in the webserver.
     */
    public String getServerBaseURL() {
<span class="nc" id="L112">        return serverBaseURL;</span>
    }

    /**
     * Returns the base file path property setting.
     * This is the base directory on the filesystem where all content
     * (uploaded, cataloged, approved - all content in the system).
     * This filepath + the upload directory should point to the
     * upload directory in the filesystem.
     */
    public String getBaseFilePath() {
<span class="nc" id="L123">        return baseFilePath;</span>
    }

    /**
     * Returns the content directory property setting.
     * This is the path that is tacked on after either the baseURL
     * or the baseFilePath to get the logical or translated locations
     * of the files in the content directory.  The URL for the content
     * directory will then be: http://&lt;baseURL&gt;/&lt;contentDirectory&gt;/
     * and the path to the content directory will reside at:
     * &lt;baseFilePath&gt;/&lt;contentDirectory&gt;/
     */
    public String getContentDirectory() {
<span class="nc" id="L136">        return contentDirectory;</span>
    }

    /**
     * Returns the package directory property setting.
     * This is the path that is tacked on after either the baseURL
     * or the baseFilePath to get the logical or translated locations
     * of the files in the package directory.  The URL for the package
     * directory will then be: http://&lt;baseURL&gt;/&lt;packageDirectory&gt;/
     * and the path to the package directory will reside at:
     * &lt;baseFilePath&gt;/&lt;packageDirectory&gt;/
     */
    public String getPackageDirectory() {
<span class="nc" id="L149">        return packageDirectory;</span>
    }

    /**
     * Sets the thumbnail directory property setting.
     * This is the path that is tacked on after either the baseURL
     * or the baseFilePath to get the logical or translated locations
     * of the files in the thumbnail directory.  The URL for the thumbnail
     * directory will then be: http://&lt;baseURL&gt;/&lt;thumbnailDirectory&gt;/
     * and the path to the thumbnail directory will reside at:
     * &lt;baseFilePath&gt;/&lt;thumbnailDirectory&gt;/
     * Be sure to call generateFullDirectories before using this class
     * after changing this setting.
     */
    public void setThumbnailDirectory(String newThumbnail) {
<span class="nc" id="L164">        thumbnailDirectory = newThumbnail;</span>
<span class="nc" id="L165">    }</span>

    /**
     * Sets the upload directory property setting.
     * This is the path that is tacked on after either the baseURL
     * or the baseFilePath to get the logical or translated locations
     * of the files in the upload directory.  The URL for the upload
     * directory will then be: http://&lt;baseURL&gt;/&lt;uploadDirectory&gt;/
     * and the path to the upload directory will reside at:
     * &lt;baseFilePath&gt;/&lt;uploadDirectory&gt;/
     * Be sure to call generateFullDirectories before using this class
     * after changing this setting.
     */
    public void setUploadDirectory(String newUpload) {
<span class="nc" id="L179">        uploadDirectory = newUpload;</span>
<span class="nc" id="L180">    }</span>

    /**
     * Sets the server base URL property setting.
     * This is the base url on the server where all content
     * (uploaded, cataloged, approved - all content in the system).
     * This baseurl + the upload directory should point to the
     * upload directory in the webserver.
     * Be sure to call generateFullDirectories before using this class
     * after changing this setting.
     */
    public void setServerBaseURL(String newBaseURL) {
<span class="fc" id="L192">        serverBaseURL = newBaseURL;</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        if(serverBaseURL != null) {</span>
<span class="fc" id="L194">            serverBaseURLLength = serverBaseURL.length();</span>
        } else {
<span class="nc" id="L196">            serverBaseURLLength = -1;</span>
        }
<span class="fc" id="L198">    }</span>

    /**
     * Sets the base file path property setting.
     * This is the base directory on the filesystem where all content
     * (uploaded, cataloged, approved - all content in the system).
     * This filepath + the upload directory should point to the
     * upload directory in the filesystem.
     * Be sure to call generateFullDirectories before using this class
     * after changing this setting.
     */
    public void setBaseFilePath(String newFilePath) {
<span class="nc" id="L210">        baseFilePath = newFilePath;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if(baseFilePath != null) {</span>
<span class="nc" id="L212">            baseFilePathLength = baseFilePath.length();</span>
        } else {
<span class="nc" id="L214">            baseFilePathLength = -1;</span>
        }
<span class="nc" id="L216">    }</span>

    /**
     * Sets the content directory property setting.
     * This is the path that is tacked on after either the baseURL
     * or the baseFilePath to get the logical or translated locations
     * of the files in the content directory.  The URL for the content
     * directory will then be: http://&lt;baseURL&gt;/&lt;contentDirectory&gt;/
     * and the path to the content directory will reside at:
     * &lt;baseFilePath&gt;/&lt;contentDirectory&gt;/
     * Be sure to call generateFullDirectories before using this class
     * after changing this setting.
     */
    public void setContentDirectory(String newContentDirectory) {
<span class="fc" id="L230">        contentDirectory = newContentDirectory;</span>
<span class="fc" id="L231">    }</span>

    /**
     * Sets the package directory property setting.
     * This is the path that is tacked on after either the baseURL
     * or the baseFilePath to get the logical or translated locations
     * of the files in the package directory.  The URL for the package
     * directory will then be: http://&lt;baseURL&gt;/&lt;packageDirectory&gt;/
     * and the path to the package directory will reside at:
     * &lt;baseFilePath&gt;/&lt;packageDirectory&gt;/
     * Be sure to call generateFullDirectories before using this class
     * after changing this setting.
     */
    public void setPackageDirectory(String newPackage) {
<span class="nc" id="L245">        packageDirectory = newPackage;</span>
<span class="nc" id="L246">    }</span>

    /**
     * Given a URL, calculates the file system path to use to access
     * the file.  The calculation is made using the base URL and
     * base file path properties.
     */
    public String getFilePathFromURL(String url) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if(url == null) {</span>
<span class="nc" id="L255">            return null;</span>
        }
        int index;
        String temp, postfix;
<span class="nc" id="L259">        String result = null;</span>
<span class="nc" id="L260">        index = url.indexOf(serverBaseURL);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if(index != -1) {</span>
<span class="nc" id="L262">            postfix = url.substring(index + serverBaseURLLength);</span>
<span class="nc" id="L263">            temp = baseFilePath + File.separator + postfix;</span>
<span class="nc" id="L264">            result = temp.replace('/', File.separatorChar);</span>
        }
<span class="nc" id="L266">        return result;</span>
    }

    /**
     * Given a file path, calculates the url to use to access
     * the file via the web server.  The calculation is made using the
     * base URL and base file path properties.
     */
    public String getURLFromFilePath(String path) {
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if(path == null) {</span>
<span class="nc" id="L276">            return null;</span>
        }
        int index;
        String temp, postfix;
<span class="nc" id="L280">        String result = null;</span>
<span class="nc" id="L281">        index = path.indexOf(baseFilePath);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if(index != -1) {</span>
<span class="nc" id="L283">            postfix = path.substring(index + baseFilePathLength);</span>
<span class="nc" id="L284">            temp = serverBaseURL + File.separator + postfix;</span>
<span class="nc" id="L285">            result = temp.replace(File.separatorChar, '/');</span>
        }
<span class="nc" id="L287">        return result;</span>
    }

    /**
     * Generates the content filepath and url and the upload filepath and url
     * properties.  This method is called whenever the contentDirectory
     * uploadDirectory, baseFilePath, or serverBaseURL properties are changed.
     * This method should be called once all of the settings have been made
     * and the FileLocator is ready for use.
     */
    public void generateFullDirectories() {
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if(baseFilePath != null) {</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            if(contentDirectory != null) {</span>
<span class="nc" id="L300">                contentFilePath = baseFilePath + File.separator + contentDirectory;</span>
<span class="nc" id="L301">                contentDirectoryFile = new File(contentFilePath);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                if(!contentDirectoryFile.exists()) {</span>
<span class="nc" id="L303">                    contentDirectoryFile.mkdirs();</span>
                }
            }
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if(uploadDirectory != null) {</span>
<span class="nc" id="L307">                uploadFilePath = baseFilePath + File.separator + uploadDirectory;</span>
<span class="nc" id="L308">                uploadDirectoryFile = new File(uploadFilePath);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                if(!uploadDirectoryFile.exists()) {</span>
<span class="nc" id="L310">                    uploadDirectoryFile.mkdirs();</span>
                }
            }
<span class="nc bnc" id="L313" title="All 2 branches missed.">            if(thumbnailDirectory != null) {</span>
<span class="nc" id="L314">                thumbnailFilePath = baseFilePath + File.separator</span>
                        + thumbnailDirectory;
<span class="nc" id="L316">                thumbnailDirectoryFile = new File(thumbnailFilePath);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                if(!thumbnailDirectoryFile.exists()) {</span>
<span class="nc" id="L318">                    thumbnailDirectoryFile.mkdirs();</span>
                }
            }
<span class="nc bnc" id="L321" title="All 2 branches missed.">            if(packageDirectory != null) {</span>
<span class="nc" id="L322">                packageFilePath = baseFilePath + File.separator + packageDirectory;</span>
<span class="nc" id="L323">                packageDirectoryFile = new File(packageFilePath);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                if(!packageDirectoryFile.exists()) {</span>
<span class="nc" id="L325">                    packageDirectoryFile.mkdirs();</span>
                }
            }
        }
<span class="nc bnc" id="L329" title="All 2 branches missed.">        if(serverBaseURL != null) {</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if(contentDirectory != null) {</span>
<span class="nc" id="L331">                contentURL = serverBaseURL + '/' + contentDirectory + '/';</span>
            }
<span class="nc bnc" id="L333" title="All 2 branches missed.">            if(uploadDirectory != null) {</span>
<span class="nc" id="L334">                uploadURL = serverBaseURL + '/' + uploadDirectory + '/';</span>
            }
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if(thumbnailDirectory != null) {</span>
<span class="nc" id="L337">                thumbnailURL = serverBaseURL + '/' + thumbnailDirectory + '/';</span>
            }
<span class="nc bnc" id="L339" title="All 2 branches missed.">            if(packageDirectory != null) {</span>
<span class="nc" id="L340">                packageURL = serverBaseURL + '/' + packageDirectory + '/';</span>
            }
        }
<span class="nc" id="L343">    }</span>

    /**
     * Returns the file path generated from the uploadDirectory and base
     * file path properties.
     */
    public String getUploadFilePath() {
<span class="nc" id="L350">        return uploadFilePath;</span>
    }

    /**
     * Returns the file path result of the package directory concatenated
     * with the provided source location.
     */
    public String getUploadFilePath(String sourceLocation) {
<span class="nc" id="L358">        String convertedSource = sourceLocation.replace('/', File.separatorChar);</span>
<span class="nc" id="L359">        File fullPath = new File(uploadFilePath, convertedSource);</span>
<span class="nc" id="L360">        String retval = null;</span>
        try {
<span class="nc" id="L362">            retval = fullPath.getCanonicalPath();</span>
<span class="nc" id="L363">        } catch(IOException ex) {</span>
<span class="nc" id="L364">            ex.printStackTrace();</span>
<span class="nc" id="L365">        }</span>
<span class="nc" id="L366">        return retval;</span>
    }

    /**
     * Returns the url result of the upload directory concatenated
     * with the provided source location.
     */
    public String getUploadURL(String sourceLocation) {
<span class="nc bnc" id="L374" title="All 2 branches missed.">        if(sourceLocation.startsWith(&quot;http://&quot;)) /*same mod as getContentURL*/ {</span>
<span class="nc" id="L375">            return sourceLocation;</span>
        } else {
<span class="nc" id="L377">            return uploadURL + sourceLocation.replaceAll(&quot;\\\\&quot;, &quot;/&quot;);</span>
        }
    }

    /**
     * Returns the url generated from the uploadDirectory and server base
     * url properties.
     */
    public String getUploadURL() {
<span class="nc" id="L386">        return uploadURL;</span>
    }

    /**
     * Returns the file path generated from the thumbnailDirectory and base
     * file path properties.
     */
    public String getThumbnailFilePath() {
<span class="nc" id="L394">        return thumbnailFilePath;</span>
    }

    /**
     * Returns the file path result of the thumbnail directory concatenated
     * with the provided source location.
     */
    public String getThumbnailFilePath(String sourceLocation) {
<span class="nc" id="L402">        String convertedSource = sourceLocation.replace('/', File.separatorChar);</span>
<span class="nc" id="L403">        File fullPath = new File(thumbnailFilePath, convertedSource);</span>
<span class="nc" id="L404">        String retval = null;</span>
        try {
<span class="nc" id="L406">            retval = fullPath.getCanonicalPath();</span>
<span class="nc" id="L407">        } catch(IOException ex) {</span>
<span class="nc" id="L408">            ex.printStackTrace();</span>
<span class="nc" id="L409">        }</span>
<span class="nc" id="L410">        return retval;</span>
    }

    /**
     * Returns the url result of the thumbnail directory concatenated
     * with the provided source location.
     */
    public String getThumbnailURL(String sourceLocation) {
<span class="nc bnc" id="L418" title="All 2 branches missed.">        if(sourceLocation.startsWith(&quot;http:&quot;)) {</span>
<span class="nc" id="L419">            return sourceLocation;</span>
        } else {
<span class="nc" id="L421">            return thumbnailURL + sourceLocation;</span>
        }
    }

    /**
     * Returns the url generated from the thumbnailDirectory and server base
     * url properties.
     */
    public String getThumbnailURL() {
<span class="nc" id="L430">        return thumbnailURL;</span>
    }

    /**
     * Returns the file path generated from the contentDirectory and base
     * file path properties.
     */
    public String getContentFilePath() {
<span class="nc" id="L438">        return contentFilePath;</span>
    }

    /**
     * Returns the file path result of the content directory concatenated
     * with the provided source location.
     */
    public String getContentFilePath(String sourceLocation) {
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if(sourceLocation.toLowerCase().startsWith(getContentURL().toLowerCase())) {</span>
<span class="nc" id="L447">            sourceLocation = sourceLocation.substring(getContentURL().length());</span>
        }
<span class="nc" id="L449">        String convertedSource = sourceLocation.replace('/', File.separatorChar);</span>
<span class="nc" id="L450">        File fullPath = new File(contentFilePath, convertedSource);</span>
<span class="nc" id="L451">        String retval = null;</span>
        try {
<span class="nc" id="L453">            retval = fullPath.getCanonicalPath();</span>
<span class="nc" id="L454">        } catch(IOException ex) {</span>
<span class="nc" id="L455">            ex.printStackTrace();</span>
<span class="nc" id="L456">        }</span>
<span class="nc" id="L457">        return retval;</span>
    }

    /**
     * Returns the url result of the content directory concatenated
     * with the provided source location.
     */
    /* mod by JV for http:// starting items */
    public String getContentURL(String sourceLocation) {
<span class="nc bnc" id="L466" title="All 2 branches missed.">        if(sourceLocation.startsWith(&quot;http://&quot;)) {</span>
<span class="nc" id="L467">            return sourceLocation;</span>
        } else {
<span class="nc" id="L469">            return contentURL + sourceLocation;</span>
        }
    }

    /**
     * Returns the url generated from the contentDirectory and server base
     * url properties.
     */
    public String getContentURL() {
<span class="nc" id="L478">        return contentURL;</span>
    }

    /**
     * Returns the file path generated from the packageDirectory and base
     * file path properties.
     */
    public String getPackageFilePath() {
<span class="nc" id="L486">        return packageFilePath;</span>
    }

    /**
     * Returns the directory storing packages.
     */
    public File getPackageDirectoryFile() {
<span class="nc" id="L493">        return packageDirectoryFile;</span>
    }

    /**
     * Returns the url generated from the packageDirectory and server base
     * url properties.
     */
    public String getPackageURL() {
<span class="nc" id="L501">        return packageURL;</span>
    }

    /**
     * Returns a string consisting of only the path of a given location that
     * falls below the preset content, package, and upload directories.  This
     * method works for both URLs and file paths.  This method relies upon
     * the base url, base file, content, package, and upload path settings.
     * Given a base url of 'http://www.healcentral.org/'
     * a file url of 'd:\apache\htdocs\'
     * a content path of 'content'
     * a package path of 'package'
     * and an upload path of 'upload'
     * The following results will be given:
     * getRelativePath(c:\apache\content\brain\picture.jpg) = brain\picture.jpg
     * getRelativePath(http://www.healcentral.org/content/brain/picture.jpg) =
     * brain/picture.jpg
     * &lt;p/&gt;
     * The approach to determining the relative path is to look for first the
     * content directory, then the upload directory, then the package
     * directory to see if any of them appear in the location string
     * (using the String.indexOf() method).
     * &lt;p/&gt;
     * If the parameter is null, or the content, upload, or package paths are
     * not foud, then null is returned.
     */
    public String getRelativePath(String location) {
<span class="nc" id="L528">        int index = -1;</span>
        char separator;
<span class="nc" id="L530">        String result = null;</span>
        int locationLen;
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if(location != null) {</span>
<span class="nc" id="L533">            locationLen = location.length();</span>
            //check each directory type
<span class="nc bnc" id="L535" title="All 2 branches missed.">            if((contentDirectory != null &amp;&amp;</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                    (index = location.indexOf(File.separator + contentDirectory + File.separator)) != -1)) {</span>
                //move the index to past the location of the directory
<span class="nc" id="L538">                index += contentDirectory.length();</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">            } else if((uploadDirectory != null &amp;&amp;</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">                    (index = location.indexOf(File.separator + uploadDirectory + File.separator)) != -1)) {</span>
<span class="nc" id="L541">                index += uploadDirectory.length();</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">            } else if((thumbnailDirectory != null &amp;&amp;</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">                    (index = location.indexOf(File.separator + thumbnailDirectory + File.separator)) != -1)) {</span>
<span class="nc" id="L544">                index += thumbnailDirectory.length();</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">            } else if((packageDirectory != null &amp;&amp;</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                    (index = location.indexOf(File.separator + packageDirectory + File.separator)) != -1)) {</span>
<span class="nc" id="L547">                index += packageDirectory.length();</span>
            }

            /* if we found the location, see if we need to skip a
             * file separator or URL separator
             */
<span class="nc bnc" id="L553" title="All 2 branches missed.">            if(index != -1) {</span>
<span class="nc" id="L554">                separator = location.charAt(index);</span>
<span class="nc bnc" id="L555" title="All 4 branches missed.">                if(separator == File.separatorChar ||</span>
                        separator == '/') {
                    //we found a separator, so skip over it
<span class="nc" id="L558">                    index++;</span>
                }
                //if the index isn't past the end, get the rest of the string
<span class="nc bnc" id="L561" title="All 2 branches missed.">                if(index &lt; locationLen) {</span>
<span class="nc" id="L562">                    result = location.substring(index);</span>
                }
            }
        }
<span class="nc" id="L566">        return result;</span>
    }

    /**
     * Moves the given file from the upload directory to the content
     * directory.  There is no error checking for conflicts.
     */
    public boolean moveFromUploadToContent(String location)
            throws IOException {
<span class="nc" id="L575">        boolean success = false;</span>
<span class="nc" id="L576">        String filepath = convertLocationToFilePath(location);</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">        if(filepath != null) {</span>
<span class="nc" id="L578">            File from = new File(uploadFilePath, filepath);</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">            if(from.exists()) {</span>
<span class="nc" id="L580">                File to = new File(contentFilePath, filepath);</span>
<span class="nc" id="L581">                success = from.renameTo(to);</span>
            }
        }
<span class="nc" id="L584">        return success;</span>
    }

    /**
     * Just like the getRelativePath method, but replaces any occurences of
     * '/' with File.separatorChar.
     */
    public String getRelativeFilePath(String location) {
<span class="nc" id="L592">        String retval = getRelativePath(location);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">        if(retval != null) {</span>
<span class="nc" id="L594">            retval.replace('/', File.separatorChar);</span>
        }
<span class="nc" id="L596">        return retval;</span>
    }

    /**
     * Just like the getRelativePath method, but replaces any occurences of
     * File.separatorChar with '/'.
     */
    public String getRelativeURLPath(String location) {
<span class="nc" id="L604">        String retval = getRelativePath(location);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if(retval != null) {</span>
<span class="nc" id="L606">            retval.replace(File.separatorChar, '/');</span>
        }
<span class="nc" id="L608">        return retval;</span>
    }

    /**
     * Given a &quot;location&quot; setting (see the Location field of the
     * Metadata table) it replaces all of the path separators to
     * be those of the local operating system, allowing the
     * application to get a path to the content file.
     * example: location = &quot;2/Photograph/brain.jpg&quot;, returns
     * &quot;2\Photograph\brain.jpg&quot; on Windows,
     * &quot;2/Photograph/brain.jpg&quot; on Solaris
     * Returns null if the location parameter is null.
     */
    public String convertLocationToFilePath(String location) {
<span class="nc bnc" id="L622" title="All 2 branches missed.">        if(location == null) {</span>
<span class="nc" id="L623">            return null;</span>
        }
<span class="nc" id="L625">        String retval = new String(location);</span>
<span class="nc" id="L626">        return retval.replace('/', File.separatorChar);</span>
    }

    /**
     * Given a file path setting it replaces all of the path
     * separators to be '/' as is standardized in the
     * Location field of the Metadata table in the database.
     * The path field should contain the local operating systems
     * File.separatorChar as the separator between directories.
     * This method should only be used for relative file paths
     * of the format below, and the path shouldn't contain
     * the upload, content, package, or thumbnail directories,
     * but rather the relative path below those.
     * &lt;p/&gt;
     * example: (Windows)path = &quot;2\Photograph\brain.jpg&quot;, or
     * &quot;2/Photograph/brain.jpg&quot; on Solaris
     * returns
     * &quot;2/Photograph/brain.jpg&quot;
     * Returns null if the filepath parameter is null.
     */
    public String convertFilePathToLocation(String location) {
<span class="nc bnc" id="L647" title="All 2 branches missed.">        if(location == null) {</span>
<span class="nc" id="L648">            return null;</span>
        }
<span class="nc" id="L650">        String retval = new String(location);</span>
<span class="nc" id="L651">        return retval.replace(File.separatorChar, '/');</span>
    }

    /**
     * Given a location directory (i.e. one generated via the
     * getLocationDirectory method), checks all possible places a file by
     * the name of locationdirectory/name could be.  If a redundancy is
     * detected, it will separate the filename and extension information
     * in name and begin adding numbers to the name until no redundancy is
     * found.  For example, if location directory is &quot;1/audio&quot; and the name
     * is &quot;sound.avi&quot; and the file &lt;uploaddir&gt;/1/audio/sound.avi is found or
     * the file &lt;contentdir&gt;/1/audio/sound.avi is found, then the method will
     * try against &lt;uploaddir&gt;/1/audio/sound1.avi and
     * &lt;contentdir&gt;/1/audio/sound1.avi, sound2.avi, sound3.avi, etc. until no
     * conflict is found.  When no conflict is found the returned String
     * will be of the form: 1/audio/sound4.avi
     * &lt;p/&gt;
     * Checks files in both the upload and content directories.
     * Also creates the parent directory of the file if it does not exist.
     */
    public String getUniqueFileLocation(String locationDirectory, String name) {
<span class="nc" id="L672">        String filePath = locationDirectory + File.separator + name;</span>
        //try quick and dirty first...
<span class="nc" id="L674">        File uploadFile = new File(uploadFilePath, filePath);</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if(!uploadFile.exists()) {</span>
<span class="nc" id="L676">            File contentFile = new File(contentFilePath, filePath);</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">            if(!contentFile.exists()) {</span>
<span class="nc" id="L678">                File uploadParent = uploadFile.getParentFile();</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">                if(!uploadParent.exists()) {</span>
<span class="nc" id="L680">                    uploadParent.mkdirs();</span>
                }
<span class="nc" id="L682">                File contentParent = contentFile.getParentFile();</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">                if(!contentParent.exists()) {</span>
<span class="nc" id="L684">                    contentParent.mkdirs();</span>
                }
<span class="nc" id="L686">                return filePath;</span>
            }
        }
        //if we get here, one of the files existed
<span class="nc" id="L690">        int counter = 2; //if we have a redundancy, start at 2(e.g. brain2.jpg)</span>
<span class="nc" id="L691">        int extensionIndex = name.lastIndexOf('.');</span>
        //extension will contain the period also: e.g. &quot;.jpg&quot;
<span class="nc" id="L693">        String extension = &quot;&quot;;</span>
<span class="nc" id="L694">        String fileName = name;</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">        if(extensionIndex &gt; 0) {</span>
<span class="nc" id="L696">            extension = name.substring(extensionIndex);</span>
<span class="nc" id="L697">            fileName = name.substring(0, extensionIndex);</span>
        }
        while(true) {
<span class="nc" id="L700">            filePath = locationDirectory +</span>
                    File.separator +
                    fileName +
                    counter +
                    extension;
<span class="nc" id="L705">            uploadFile = new File(uploadFilePath, filePath);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">            if(!uploadFile.exists()) {</span>
<span class="nc" id="L707">                File contentFile = new File(contentFilePath, filePath);</span>
<span class="nc bnc" id="L708" title="All 2 branches missed.">                if(!contentFile.exists()) {</span>
<span class="nc" id="L709">                    File uploadParent = uploadFile.getParentFile();</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                    if(!uploadParent.exists()) {</span>
<span class="nc" id="L711">                        uploadParent.mkdirs();</span>
                    }
<span class="nc" id="L713">                    File contentParent = contentFile.getParentFile();</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                    if(!contentParent.exists()) {</span>
<span class="nc" id="L715">                        contentParent.mkdirs();</span>
                    }
<span class="nc" id="L717">                    return filePath;</span>
                }
            }
            //if we get here we had a collision, so we increment the counter.
<span class="nc" id="L721">            counter++;</span>
        }
    }

    public void createParentDir(String filepath) {

<span class="nc" id="L727">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>