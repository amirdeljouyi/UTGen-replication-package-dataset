<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VCardBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.util</a> &gt; <span class="el_source">VCardBean.java</span></div><h1>VCardBean.java</h1><pre class="source lang-java linenums">package org.heal.util;

import java.io.Serializable;
import java.util.NoSuchElementException;
import java.util.StringTokenizer;

/**
 * Represents VCard data.  Very incomplete implementation, but this is all
 * that is needed at the moment.
 *
 * @author Brad Schaefer (&lt;A HREF=&quot;mailto:schaefer@libscan.med.utah.edu&quot;&gt;schaefer@libscan.med.utah.edu&lt;/A&gt;)
 * @version 1.0
 */
<span class="nc" id="L14">public class VCardBean implements Serializable {</span>
    private String vCard;

    // Name fields
    private String firstName;
    private String lastName;
    private String middleName;
    private String formattedName;

    private String title;
    private String organization;
    private String email;
    private String phone;
    private String fax;


    public void setVCard(String vCard) {
<span class="nc" id="L31">        this.vCard = vCard;</span>

<span class="nc" id="L33">        firstName = lastName = middleName = formattedName = null;</span>
<span class="nc" id="L34">        title = null;</span>
<span class="nc" id="L35">        organization = null;</span>
<span class="nc" id="L36">        email = null;</span>
<span class="nc" id="L37">        phone = fax = null;</span>

<span class="nc" id="L39">        parseVCard(this);</span>
<span class="nc" id="L40">    }</span>

    /**
     * @return A String representation of this vCard object.  If a
     *         vCard cannot be found or generated, this will return
     *         &lt;code&gt;null&lt;/code&gt;.
     */
    public String getVCard() {
        String ret;
<span class="nc bnc" id="L49" title="All 2 branches missed.">        if(null == vCard) {</span>
            // tries to generate a vcard for this object
            // (this may return null if a vcard cannot be generated)
<span class="nc" id="L52">            ret = generateVCard(this);</span>
        } else {
<span class="nc" id="L54">            ret = vCard;</span>
        }
<span class="nc" id="L56">        return ret;</span>
    }

    public String getFirstName() {
<span class="nc" id="L60">        return firstName;</span>
    }

    public void setFirstName(String firstName) {
<span class="nc" id="L64">        this.firstName = firstName;</span>
<span class="nc" id="L65">    }</span>

    public String getLastName() {
<span class="nc" id="L68">        return lastName;</span>
    }

    public void setLastName(String lastName) {
<span class="nc" id="L72">        this.lastName = lastName;</span>
<span class="nc" id="L73">    }</span>

    public String getMiddleName() {
<span class="nc" id="L76">        return middleName;</span>
    }

    public void setMiddleName(String middleName) {
<span class="nc" id="L80">        this.middleName = middleName;</span>
<span class="nc" id="L81">    }</span>

    public String getFormattedName() {
<span class="nc" id="L84">        return formattedName;</span>
    }

    public void setFormattedName(String formattedName) {
<span class="nc" id="L88">        this.formattedName = formattedName;</span>
<span class="nc" id="L89">    }</span>

    public String getTitle() {
<span class="nc" id="L92">        return title;</span>
    }

    public void setTitle(String title) {
<span class="nc" id="L96">        this.title = title;</span>
<span class="nc" id="L97">    }</span>

    public String getOrganization() {
<span class="nc" id="L100">        return organization;</span>
    }

    public void setOrganization(String organization) {
<span class="nc" id="L104">        this.organization = organization;</span>
<span class="nc" id="L105">    }</span>

    public String getEmail() {
<span class="nc" id="L108">        return email;</span>
    }

    public void setEmail(String email) {
<span class="nc" id="L112">        this.email = email;</span>
<span class="nc" id="L113">    }</span>

    public String getPhone() {
<span class="nc" id="L116">        return phone;</span>
    }

    public void setPhone(String phone) {
<span class="nc" id="L120">        this.phone = phone;</span>
<span class="nc" id="L121">    }</span>

    public String getFax() {
<span class="nc" id="L124">        return fax;</span>
    }

    public void setFax(String fax) {
<span class="nc" id="L128">        this.fax = fax;</span>
<span class="nc" id="L129">    }</span>

    public String toString() {
<span class="nc" id="L132">        return getVCard();</span>
    }

    /**
     * Generates a vCard String from the various member variables. If no
     * vCard can be generated, it returns &lt;code&gt;null&lt;/code&gt;.
     * &lt;p/&gt;
     * DESIGN DECISION: Since this is used primarily to generate vCards
     * inputted via contribute and/or imported records, there are extra
     * restrictions beyond the N and FN (name fields) requirements for
     * a vCard -- to generate a vcard we additionally require an EMAIL,
     * an ORG, and a TITLE.
     */
    private static String generateVCard(VCardBean vcb) {
        // Makes sure required fields are there
<span class="nc bnc" id="L147" title="All 6 branches missed.">        if(null == vcb.getFirstName() || null == vcb.getLastName() || null == vcb.getEmail()</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                || null == vcb.getOrganization()) {</span>
<span class="nc" id="L149">            return null;</span>
        }
<span class="nc" id="L151">        StringBuffer vCard = new StringBuffer(&quot;BEGIN:VCARD\n&quot;);</span>

        // FN field
        {
            StringBuffer name;
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if(vcb.getFormattedName() != null) {</span>
<span class="nc" id="L157">                name = new StringBuffer(vcb.getFormattedName());</span>
            } else {
<span class="nc" id="L159">                name = new StringBuffer(vcb.getFirstName()).append(&quot; &quot;);</span>
<span class="nc" id="L160">                String middleName = vcb.getMiddleName();</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">                if(middleName != null &amp;&amp; middleName.length() != 0) {</span>
<span class="nc" id="L162">                    name.append(middleName).append(&quot; &quot;);</span>
                }
<span class="nc" id="L164">                name.append(vcb.getLastName());</span>
            }
<span class="nc" id="L166">            vCard.append(&quot;FN:&quot;).append(name.toString()).append(&quot;\n&quot;);</span>
        }

        // N field
<span class="nc" id="L170">        vCard.append(&quot;N:&quot;).append(vcb.getLastName()).append(&quot;;&quot;);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if(vcb.getMiddleName() != null) {</span>
<span class="nc" id="L172">            vCard.append(vcb.getMiddleName());</span>
        }
<span class="nc" id="L174">        vCard.append(&quot;;&quot;).append(vcb.getFirstName()).append(&quot;;&quot;).append(&quot;\n&quot;);</span>

        // TITLE field
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if(null != vcb.getTitle()) {</span>
<span class="nc" id="L178">            vCard.append(&quot;TITLE:&quot;).append(addBackslashes(vcb.getTitle())).append(&quot;\n&quot;);</span>
        }

        // ORG field
<span class="nc" id="L182">        vCard.append(&quot;ORG:&quot;).append(addBackslashes(vcb.getOrganization())).append(&quot;\n&quot;);</span>

        // EMAIL field
<span class="nc" id="L185">        vCard.append(&quot;EMAIL;TYPE=INTERNET:&quot;).append(vcb.getEmail()).append(&quot;\n&quot;);</span>

        // TEL;TYPE=VOICE field
<span class="nc bnc" id="L188" title="All 4 branches missed.">        if(vcb.getPhone() != null &amp;&amp; vcb.getPhone().length() != 0) {</span>
<span class="nc" id="L189">            vCard.append(&quot;TEL;TYPE=VOICE:&quot;).append(vcb.getPhone()).append(&quot;\n&quot;);</span>
        }

        // TEL;TYPE=FAX field
<span class="nc bnc" id="L193" title="All 4 branches missed.">        if(vcb.getFax() != null &amp;&amp; vcb.getFax().length() != 0) {</span>
<span class="nc" id="L194">            vCard.append(&quot;TEL;TYPE=FAX:&quot;).append(vcb.getFax()).append(&quot;\n&quot;);</span>
        }

<span class="nc" id="L197">        vCard.append(&quot;END:VCARD&quot;);</span>
<span class="nc" id="L198">        return vCard.toString();</span>
//        this.vCard = vCard.toString();
    }

    /**
     * Folds lines which are more than 75 characters long into multiple lines
     * delimited by &lt;code&gt;&quot;\r\n\t&quot;&lt;/code&gt; (a CRLF + a whitespace character).
     *
     * @param str An unfolded String.
     *
     * @return A folded String.
     */
    private static String foldLines(String str) {
<span class="nc" id="L211">        StringBuffer ret = new StringBuffer();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        while(str.length() &gt; 75) {</span>
<span class="nc" id="L213">            ret.append(str.substring(0, 75) + &quot;\r\n\t&quot;);</span>
<span class="nc" id="L214">            str = str.substring(75, str.length());</span>
        }
<span class="nc" id="L216">        ret.append(str);</span>
<span class="nc" id="L217">        return ret.toString();</span>
    }

    /**
     * If lines are folded using a CRLF + a whitespace character, this unfolds
     * the line in the String.
     *
     * @param str A String with folded lines.
     *
     * @return A String without folded lines.
     */
    private static String unfoldLines(String str) {
<span class="nc" id="L229">        return str.replaceAll(&quot;\r\n\\s&quot;, &quot;&quot;);</span>
    }

    /**
     * Takes what's in the vCard field and seperates it out to the seperate
     * vCard variables.  If the vCard is valid for our purposes, we set the
     * VCardBean properties accordingly.
     */
    private static void parseVCard(VCardBean vcb) {
<span class="nc" id="L238">        String vCard = vcb.getVCard();</span>
<span class="nc bnc" id="L239" title="All 4 branches missed.">        if(null == vCard || !vCard.toUpperCase().startsWith(&quot;BEGIN:VCARD&quot;)) {</span>
<span class="nc" id="L240">            return;</span>
        }

<span class="nc" id="L243">        vCard = unfoldLines(vCard);</span>
<span class="nc" id="L244">        StringTokenizer tokenizer = new StringTokenizer(vCard, &quot;\n&quot;);</span>

        // Basic vCard types
<span class="nc" id="L247">        String FN = null;</span>
<span class="nc" id="L248">        String N = null;</span>
<span class="nc" id="L249">        String ORG = null;</span>
<span class="nc" id="L250">        String EMAIL = null;</span>
<span class="nc" id="L251">        String TEL = null;</span>
<span class="nc" id="L252">        String TITLE = null;</span>
<span class="nc" id="L253">        String TEL_FAX = null;</span>

<span class="nc" id="L255">        boolean beginFound = false;</span>
<span class="nc" id="L256">        boolean endFound = false;</span>
<span class="nc bnc" id="L257" title="All 4 branches missed.">        while(tokenizer.hasMoreElements() &amp;&amp; !endFound) {</span>
<span class="nc" id="L258">            String element = (String)tokenizer.nextElement();</span>

<span class="nc" id="L260">            int index = element.indexOf(&quot;:&quot;);</span>

            // Malformed vCard, so reset the field data and return without setting
            // the VCardBean properties
<span class="nc bnc" id="L264" title="All 2 branches missed.">            if(index == -1) {</span>
<span class="nc" id="L265">                return;</span>
            }

<span class="nc bnc" id="L268" title="All 2 branches missed.">            if(index == element.length() - 1) {</span>
<span class="nc" id="L269">                continue;</span>
            }

<span class="nc" id="L272">            String type = element.substring(0, index);</span>
<span class="nc" id="L273">            String data = element.substring(index + 1, element.length());</span>
<span class="nc" id="L274">            String subtype = &quot;&quot;;</span>

            // Checks for subtypes
<span class="nc bnc" id="L277" title="All 2 branches missed.">            if((index = type.indexOf(&quot;;&quot;)) != -1) {</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">                if(index + 1 != type.length()) {</span>
<span class="nc" id="L279">                    subtype = type.substring(index + 1, type.length());</span>
                }
<span class="nc" id="L281">                type = type.substring(0, index);</span>
            }

            // Cleans up the strings
<span class="nc" id="L285">            type = type.trim();</span>
<span class="nc" id="L286">            data = data.trim();</span>

            // Looks for the beginning of the vCard, which should be the first element
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if(!beginFound) {</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">                if(type.equalsIgnoreCase(&quot;begin&quot;) &amp;&amp; data.equalsIgnoreCase(&quot;vcard&quot;)) {</span>
<span class="nc" id="L291">                    beginFound = true;</span>
                }
                continue;
            }

            // Looks for the end element
<span class="nc bnc" id="L297" title="All 4 branches missed.">            if(type.equalsIgnoreCase(&quot;end&quot;) &amp;&amp; data.equalsIgnoreCase(&quot;vcard&quot;)) {</span>
<span class="nc" id="L298">                endFound = true;</span>
<span class="nc" id="L299">                continue;</span>
            }

            // FN type
<span class="nc bnc" id="L303" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;fn&quot;)) {</span>
<span class="nc" id="L304">                FN = data;</span>
<span class="nc" id="L305">                continue;</span>
            }

            // N type
<span class="nc bnc" id="L309" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;n&quot;)) {</span>
<span class="nc" id="L310">                N = data;</span>
<span class="nc" id="L311">                continue;</span>
                
            }

            // ORG type
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;org&quot;)) {</span>
<span class="nc" id="L317">                ORG = data;</span>
<span class="nc" id="L318">                continue;</span>
            }

            // EMAIL type
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;email&quot;)) {</span>
<span class="nc" id="L323">                EMAIL = data;</span>
<span class="nc" id="L324">                continue;</span>
            }

            // TEL type
<span class="nc bnc" id="L328" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;tel&quot;)) {</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                if(&quot;type=fax&quot;.equalsIgnoreCase(subtype)) {</span>
<span class="nc" id="L330">                    TEL_FAX = data;</span>
                } else {
<span class="nc" id="L332">                    TEL = data;</span>
                }
<span class="nc" id="L334">                continue;</span>
            }

            // TITLE type
<span class="nc bnc" id="L338" title="All 2 branches missed.">            if(type.equalsIgnoreCase(&quot;title&quot;)) {</span>
<span class="nc" id="L339">                TITLE = data;</span>
<span class="nc" id="L340">                continue;</span>
            }
<span class="nc" id="L342">        } // end loop</span>


        // Parses vCard into the seperate fields

        // this doesn't take into account \;'s which should be escaped, but
        // this is only a partial implementation of vcard so for now we don't worry about it 
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (N != null)</span>
        {
<span class="nc" id="L351">          String[] name = N.split(&quot;;&quot;);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">          if(name.length &gt;= 3) {</span>
<span class="nc" id="L353">            vcb.setFirstName(name[2].trim());</span>
<span class="nc" id="L354">            vcb.setMiddleName(name[1].trim());</span>
<span class="nc" id="L355">            vcb.setLastName(name[0].trim());</span>
          }
        }
        
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if(null != FN) {</span>
<span class="nc" id="L360">            vcb.setFormattedName(FN.trim());</span>
        }

<span class="nc bnc" id="L363" title="All 2 branches missed.">        if(null != ORG) {</span>
<span class="nc" id="L364">            vcb.setOrganization(removeBackslashes(ORG.trim()));</span>
        }
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if(null != EMAIL) {</span>
<span class="nc" id="L367">            vcb.setEmail(EMAIL.trim());</span>
        }
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if(null != TITLE) {</span>
<span class="nc" id="L370">            vcb.setTitle(removeBackslashes(TITLE.trim()));</span>
        }

<span class="nc bnc" id="L373" title="All 2 branches missed.">        if(TEL != null) {</span>
<span class="nc" id="L374">            vcb.setPhone(TEL.trim());</span>
        }

<span class="nc bnc" id="L377" title="All 2 branches missed.">        if(null != TEL_FAX) {</span>
<span class="nc" id="L378">            vcb.setFax(TEL_FAX.trim());</span>
        }
<span class="nc" id="L380">    }</span>

    /**
     * Adds escape characters (backslashes) to characters with special meaning in vCard attributres.
     *
     * @param str
     *
     * @return The string with backslashes added before commas and semicolons.
     */
    private static String addBackslashes(String str) {
<span class="nc" id="L390">        return str.replaceAll(&quot;,&quot;, &quot;\\,&quot;).replaceAll(&quot;;&quot;, &quot;\\;&quot;);</span>
    }

    /**
     * Removes escape characters (backslashes) from characters with special meaning in vCard attributes.
     * Used when translating a vCard String
     *
     * @param str
     *
     * @return The String with backslashes removed from before commas and semicolons.
     */
    private static String removeBackslashes(String str) {
<span class="nc" id="L402">        return str.replaceAll(&quot;\\,&quot;, &quot;,&quot;).replaceAll(&quot;\\;&quot;, &quot;;&quot;);</span>
    }

    public boolean isValidVCard() {
<span class="nc bnc" id="L406" title="All 2 branches missed.">        return (null == vCard ? false : vCard.toLowerCase().startsWith(&quot;begin:vcard&quot;));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>