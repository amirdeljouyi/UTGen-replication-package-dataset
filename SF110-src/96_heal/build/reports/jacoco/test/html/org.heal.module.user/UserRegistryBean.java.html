<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserRegistryBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.module.user</a> &gt; <span class="el_source">UserRegistryBean.java</span></div><h1>UserRegistryBean.java</h1><pre class="source lang-java linenums">package org.heal.module.user;

import com.ora.jsp.sql.*;
import com.ora.jsp.sql.value.BooleanValue;
import com.ora.jsp.sql.value.StringValue;

import java.util.Iterator;
import javax.sql.DataSource;
import java.io.Serializable;
import java.sql.Connection;
import java.sql.SQLException;
import java.sql.PreparedStatement;
import java.util.ArrayList;
import java.util.Vector;

/**
 * This contains methods for authenticating a user,
 * and retrieving and updating user information.
 *
 * @author Seth Wright
 * @modify Jason Varghese
 * @version 0.1
 */
<span class="nc" id="L24">public class UserRegistryBean implements Serializable {</span>
    private DataSource dataSource;

    /**
     * Sets the dataSource property value.
     */
    public void setDataSource(DataSource dataSource) {
<span class="nc" id="L31">        this.dataSource = dataSource;</span>
<span class="nc" id="L32">    }</span>

    /**
     * Returns true if the specified user name and password
     * match an employee in the database.     */
    public UserBean verifyLogin(String userName, String password, boolean emailIsUsername)
            throws SQLException {

<span class="nc" id="L40">        UserBean userInfo = getUser(userName, emailIsUsername);</span>
<span class="nc bnc" id="L41" title="All 4 branches missed.">        if (userInfo != null &amp;&amp; password.equals(userInfo.getPassword())) {</span>
<span class="nc" id="L42">            return userInfo;</span>
        }
<span class="nc" id="L44">        return null;</span>
    }

    /**
     * Returns true if the given user has the specified permissions.
     */
    public boolean checkPermissions(UserBean user, String accessLevel) {
        /* XXX not currently implemented */
<span class="nc" id="L52">        return false;</span>
    }

    /**
     * Returns true if the user was found in the database, false
     * otherwise.  Throws an SQLException in the event something goes
     * wrong.
     */
    public boolean userExists(String userName) throws SQLException {

        // Get the user info from the database
<span class="nc" id="L63">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L64">        Row userRow = null;</span>
        try {
<span class="nc" id="L66">            userRow = getUserPropertiesFromEmail(userName, conn);</span>
        } finally {
            try {
<span class="nc" id="L69">                conn.close();</span>
<span class="nc" id="L70">            } catch (SQLException e) {</span>
<span class="nc" id="L71">            } // Ignore</span>
        }

<span class="nc bnc" id="L74" title="All 2 branches missed.">        return (userRow != null);</span>
    }
    
    /**
     * Returns a Vector of Strings of all of the usernames in the
     * database.  Returns null on an error or if no entries exist in the
     * database.
     */
    public Vector getAllUserIds() throws SQLException {
        //Get the usernames from the database
<span class="nc" id="L84">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L85">        Vector names = null;</span>
        try {
<span class="nc" id="L87">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L88">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L89">            String sql = &quot;SELECT UserId FROM USERS&quot;;</span>
<span class="nc" id="L90">            sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L91">            Vector rows = null;</span>
            try {
<span class="nc" id="L93">								Row row = null;</span>
<span class="nc" id="L94">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">                if (rows != null &amp;&amp; rows.size() &gt; 0) {</span>
<span class="nc" id="L96">                    names = new Vector();</span>
<span class="nc" id="L97">                    Object[] rowArray = rows.toArray();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                    for (int rowIndex = 0; rowIndex &lt; rowArray.length; rowIndex++) {</span>
<span class="nc" id="L99">                        String name = ((Row) rowArray[rowIndex]).getString(&quot;UserId&quot;);</span>
<span class="nc" id="L100">                        names.add(name);</span>
                    }
                }
<span class="nc" id="L103">            } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L104">                throw new SQLException(e.toString());</span>
<span class="nc" id="L105">            } catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L106">                throw new SQLException(e2.toString());</span>
<span class="nc" id="L107">            }</span>
        } finally {
            try {
<span class="nc" id="L110">                conn.close();</span>
<span class="nc" id="L111">            } catch (SQLException e) {</span>
<span class="nc" id="L112">                e.printStackTrace();}</span>
        }
<span class="nc" id="L114">        return names;</span>
    }    

    /**
     * Returns a Vector of Strings of all of the usernames in the
     * database.  Returns null on an error or if no entries exist in the
     * database.
     */
    public Vector getAllUsernames() throws SQLException {
        //Get the usernames from the database
<span class="nc" id="L124">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L125">        Vector names = null;</span>
        try {
<span class="nc" id="L127">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L128">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L129">            String sql = &quot;SELECT UserName FROM USERS&quot;;</span>
<span class="nc" id="L130">            sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L131">            Vector rows = null;</span>
            try {
<span class="nc" id="L133">								Row row = null;</span>
<span class="nc" id="L134">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc bnc" id="L135" title="All 4 branches missed.">                if (rows != null &amp;&amp; rows.size() &gt; 0) {</span>
<span class="nc" id="L136">                    names = new Vector();</span>
<span class="nc" id="L137">                    Object[] rowArray = rows.toArray();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                    for (int rowIndex = 0; rowIndex &lt; rowArray.length; rowIndex++) {</span>
<span class="nc" id="L139">                        String name = ((Row) rowArray[rowIndex]).getString(&quot;UserName&quot;);</span>
<span class="nc" id="L140">                        names.add(name);</span>
                    }
                }
<span class="nc" id="L143">            } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L144">                throw new SQLException(e.toString());</span>
<span class="nc" id="L145">            } catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L146">                throw new SQLException(e2.toString());</span>
<span class="nc" id="L147">            }</span>
        } finally {
            try {
<span class="nc" id="L150">                conn.close();</span>
<span class="nc" id="L151">            } catch (SQLException e) {</span>
<span class="nc" id="L152">                e.printStackTrace();}</span>
        }
<span class="nc" id="L154">        return names;</span>
    }


    /**
     * Returns a Vector of Strings of all of the usernames in the
     * database.  Returns null on an error or if no entries exist in the
     * database.
     */
    public int getCountOfUsers() throws SQLException {
        //Get the usernames from the database
<span class="nc" id="L165">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L166">		int count = 0;</span>
        try {
<span class="nc" id="L168">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L169">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L170">            String sql = &quot;SELECT Count(distinct email) as Expr1 FROM USERS&quot;;</span>
<span class="nc" id="L171">            sqlCommandBean.setSqlValue(sql);</span>
            try {
<span class="nc" id="L173">                Vector rows = null;</span>
<span class="nc" id="L174">				Row row = null;</span>
<span class="nc" id="L175">				rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L176">				Iterator rowIterator = rows.iterator();</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">				while (rowIterator.hasNext()) {</span>
<span class="nc" id="L178">                    row = (Row) rowIterator.next();</span>
<span class="nc" id="L179">					count = row.getInt(&quot;Expr1&quot;);		</span>
                }
            } 
<span class="nc" id="L182">            catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L183">                throw new SQLException(e.toString());</span>
            } 
<span class="nc" id="L185">            catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L186">                throw new SQLException(e2.toString());</span>
            }
<span class="nc" id="L188">			catch (UnsupportedConversionException ex){</span>
<span class="nc" id="L189">                throw new SQLException(ex.toString());</span>
<span class="nc" id="L190">			}						</span>
        } 
        finally {
            try {
<span class="nc" id="L194">                conn.close();</span>
            } 
<span class="nc" id="L196">            catch (SQLException e) {</span>
<span class="nc" id="L197">            e.printStackTrace();}</span>
        }
<span class="nc" id="L199">        return count;</span>
    }

    /**
     * Returns a Vector of Strings of all of the usernames in the
     * database.  Returns null on an error or if no entries exist in the
     * database.
     */
    public int getAreaofExpertiseSummary(String value) throws SQLException {
        //Get the usernames from the database
<span class="nc" id="L209">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L210">		int count = 0;</span>
        try {
<span class="nc" id="L212">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L213">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L214">            String sql = &quot;SELECT Count(userid) as Expr1 FROM USERS where professionalSpecialty = ?&quot;;</span>
<span class="nc" id="L215">            sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L216">            Vector values = new Vector();</span>
<span class="nc" id="L217">            values.addElement(new StringValue(value));</span>
<span class="nc" id="L218">            sqlCommandBean.setValues(values);</span>
            try {
<span class="nc" id="L220">                Vector rows = null;</span>
<span class="nc" id="L221">                Row row = null;</span>
<span class="nc" id="L222">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L223">                Iterator rowIterator = rows.iterator();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                while (rowIterator.hasNext()){</span>
<span class="nc" id="L225">                    row = (Row) rowIterator.next();</span>
<span class="nc" id="L226">                    count = row.getInt(&quot;Expr1&quot;);</span>
				}
            } 
<span class="nc" id="L229">            catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L230">                throw new SQLException(e.toString());</span>
            } 
<span class="nc" id="L232">            catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L233">                throw new SQLException(e2.toString());</span>
            }
<span class="nc" id="L235">			catch (UnsupportedConversionException ex) {</span>
<span class="nc" id="L236">                throw new SQLException(ex.toString());</span>
<span class="nc" id="L237">			}						</span>
        } 
        finally {
            try {
<span class="nc" id="L241">                conn.close();</span>
            } 
<span class="nc" id="L243">            catch (SQLException e) {</span>
<span class="nc" id="L244">                e.printStackTrace();</span>
<span class="nc" id="L245">            }</span>
        }
<span class="nc" id="L247">        return count;</span>
    }

    /**
     * Returns an UserBean initialized with the information
     * found in the database for the specified employee, or null if
     * not found.
     */
    public UserBean getUser(String userName,boolean emailIsUsername) throws SQLException {

        // Get the user info from the database
<span class="nc" id="L258">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L259">        Row userRow = null;</span>
<span class="nc" id="L260">		Vector userProfessionalRoleRow = null;</span>
<span class="nc" id="L261">		Vector userInstructionalLevel = null;</span>
<span class="nc" id="L262">		UserBean userBean = new UserBean();</span>

        try {
<span class="nc" id="L265">            userRow = getUserProperties(userName, emailIsUsername, conn);</span>
<span class="nc" id="L266">			userBean=rowToBean(userRow);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">            if(userRow!=null){</span>
<span class="nc" id="L268">                userProfessionalRoleRow = getUserProfessionalRole(userBean.getUserId(), conn);</span>
<span class="nc" id="L269">                userInstructionalLevel = getUserInstructionalLevel(userBean.getUserId(), conn);</span>
			}
        } 
        finally {
            try {
<span class="nc" id="L274">                conn.close();</span>
            } 
<span class="nc" id="L276">            catch (SQLException e) {</span>
<span class="nc" id="L277">                e.printStackTrace();</span>
<span class="nc" id="L278">            }</span>
        }
		
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if(userProfessionalRoleRow!=null){	</span>
<span class="nc" id="L282">            Iterator it = userProfessionalRoleRow.iterator();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">			while (it.hasNext()){</span>
<span class="nc" id="L284">                userBean.addProfessionalRole(rowToProfessionalRole((Row)it.next()));</span>
			}
		}
				
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if(userInstructionalLevel!=null){</span>
<span class="nc" id="L289">            Iterator it2 = userInstructionalLevel.iterator();</span>
<span class="nc bnc" id="L290" title="All 2 branches missed.">			while (it2.hasNext()){</span>
<span class="nc" id="L291">                userBean.addInstructionalLevel(rowToInstructionalLevel((Row)it2.next()));	</span>
			}				
		}
<span class="nc" id="L294">        return userBean;</span>
    }

    /**
     * Returns an UserBean initialized with the information
     * found in the database for the specified email address, or null if
     * not found.
     */
    public UserBean getUserFromEmail(String email) throws SQLException {
        // Get the user info from the database
<span class="nc" id="L304">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L305">        Row userRow = null;</span>
        try {
<span class="nc" id="L307">            userRow = getUserPropertiesFromEmail(email, conn);</span>
        } finally {
            try {
<span class="nc" id="L310">                conn.close();</span>
<span class="nc" id="L311">            } catch (SQLException e) {</span>
<span class="nc" id="L312">                e.printStackTrace();}</span>
        }
<span class="nc" id="L314">        return rowToBean(userRow);</span>

    }    
    

    public UserBean getUserFromID(String userID) throws SQLException {
        // Get the user info from the database
<span class="nc" id="L321">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L322">        Row userRow = null;</span>
<span class="nc" id="L323">        Vector userProfessionalRoleRow = null;</span>
<span class="nc" id="L324">        Vector userInstructionalLevel = null;</span>
        
<span class="nc" id="L326">        UserBean userBean = new UserBean();</span>
        try {
<span class="nc" id="L328">            userRow = getUserPropertiesFromID(userID, conn);</span>
<span class="nc" id="L329">            userBean = rowToBean(userRow);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">            if(userRow!=null)	{</span>
<span class="nc" id="L331">              userProfessionalRoleRow = getUserProfessionalRole(userBean.getUserId(), conn);</span>
<span class="nc" id="L332">              userInstructionalLevel = getUserInstructionalLevel(userBean.getUserId(), conn);</span>
						}            
        } finally {
            try {
<span class="nc" id="L336">                conn.close();</span>
<span class="nc" id="L337">            } catch (SQLException e) {</span>
<span class="nc" id="L338">                e.printStackTrace();}</span>
        }
		
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if(userProfessionalRoleRow!=null){	</span>
<span class="nc" id="L342">            Iterator it = userProfessionalRoleRow.iterator();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            while (it.hasNext()){</span>
<span class="nc" id="L344">                userBean.addProfessionalRole(rowToProfessionalRole((Row)it.next()));</span>
            }
		}
        
<span class="nc bnc" id="L348" title="All 2 branches missed.">		if(userInstructionalLevel!=null){</span>
<span class="nc" id="L349">            Iterator it = userInstructionalLevel.iterator();</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            while (it.hasNext()){</span>
<span class="nc" id="L351">                userBean.addInstructionalLevel(rowToInstructionalLevel((Row)it.next()));	</span>
			}				
		}
        
<span class="nc" id="L355">        return userBean;</span>
    }
    
    /**
     * Returns a Vector of Strings of all of the usernames in the
     * database.  Returns null on an error or if no entries exist in the
     * database.
     */
    public Vector getAreaofExpertiseValues() throws SQLException {
        //Get the usernames from the database
<span class="nc" id="L365">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L366">        Vector names = null;</span>
        try {
<span class="nc" id="L368">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L369">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L370">            String sql = &quot;SELECT distinct ProfessionalSpecialty FROM USERS where modifiedLogin = '1'&quot;;</span>
<span class="nc" id="L371">            sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L372">            Vector rows = null;</span>
            try {
<span class="nc" id="L374">                Row row = null;</span>
<span class="nc" id="L375">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc bnc" id="L376" title="All 4 branches missed.">                if (rows != null &amp;&amp; rows.size() &gt; 0) {</span>
<span class="nc" id="L377">                    names = new Vector();</span>
<span class="nc" id="L378">                    Object[] rowArray = rows.toArray();</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                    for (int rowIndex = 0; rowIndex &lt; rowArray.length; rowIndex++) {</span>
<span class="nc" id="L380">                        String name = ((Row) rowArray[rowIndex]).getString(&quot;ProfessionalSpecialty&quot;);</span>
<span class="nc" id="L381">                        names.add(name);</span>
                    }
                }
            } 
<span class="nc" id="L385">            catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L386">                throw new SQLException(e.toString());</span>
            } 
<span class="nc" id="L388">            catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L389">                throw new SQLException(e2.toString());</span>
<span class="nc" id="L390">            }</span>
        } finally {
            try {
<span class="nc" id="L393">                conn.close();</span>
<span class="nc" id="L394">            } catch (SQLException e) {</span>
<span class="nc" id="L395">                e.printStackTrace();}</span>
        }
<span class="nc" id="L397">        return names;</span>
    }    
    

    /**
     * Takes a Row obtained from the database and translates that into
     * a UserBean.  Returns null if the userRow is null and throws
     * and SQLException if an error occurs.
     */
    private UserBean rowToBean(Row userRow)
            throws SQLException {
        // Create a UserBean if the user was found
<span class="nc bnc" id="L409" title="All 2 branches missed.">        if (userRow == null) {</span>
            // Not found
<span class="nc" id="L411">            return null;</span>
        }

<span class="nc" id="L414">        UserBean userInfo = new UserBean();</span>
        try {
<span class="nc" id="L416">            userInfo.setUserId(userRow.getString(&quot;UserID&quot;));</span>
<span class="nc" id="L417">            userInfo.setUserName(userRow.getString(&quot;UserName&quot;));</span>
<span class="nc" id="L418">            userInfo.setPassword(userRow.getString(&quot;Password&quot;));</span>
<span class="nc" id="L419">            userInfo.setMinor(userRow.getBoolean(&quot;Minor&quot;));</span>
<span class="nc" id="L420">            userInfo.setAdministrator(userRow.getBoolean(&quot;Administrator&quot;));</span>
<span class="nc" id="L421">            userInfo.setCataloger(userRow.getBoolean(&quot;Cataloger&quot;));</span>
<span class="nc" id="L422">            userInfo.setApprover(userRow.getBoolean(&quot;Approver&quot;));</span>
<span class="nc" id="L423">            userInfo.setFirstName(userRow.getString(&quot;FirstName&quot;));</span>
<span class="nc" id="L424">            userInfo.setLastName(userRow.getString(&quot;LastName&quot;));</span>
<span class="nc" id="L425">            userInfo.setMiddleInitial(userRow.getString(&quot;MI&quot;));</span>
<span class="nc" id="L426">            userInfo.setEmail(userRow.getString(&quot;Email&quot;));</span>
            //userInfo.setProfessionalTitle(userRow.getString(&quot;ProfessionalTitle&quot;));
<span class="nc" id="L428">            userInfo.setProfessionalSpecialty(userRow.getString(&quot;ProfessionalSpecialty&quot;));</span>
<span class="nc" id="L429">            userInfo.setPhoneNumber(userRow.getString(&quot;PhoneNumber&quot;));</span>
<span class="nc" id="L430">            userInfo.setInstitutionName(userRow.getString(&quot;InstitutionName&quot;));</span>
<span class="nc" id="L431">            userInfo.setAddress1(userRow.getString(&quot;Address1&quot;));</span>
<span class="nc" id="L432">            userInfo.setAddress2(userRow.getString(&quot;Address2&quot;));</span>
<span class="nc" id="L433">            userInfo.setCity(userRow.getString(&quot;City&quot;));</span>
<span class="nc" id="L434">            userInfo.setState(userRow.getString(&quot;State&quot;));</span>
<span class="nc" id="L435">            userInfo.setZipCode(userRow.getString(&quot;ZipCode&quot;));</span>
<span class="nc" id="L436">            userInfo.setCountry(userRow.getString(&quot;Country&quot;));</span>
<span class="nc" id="L437">            userInfo.setMailingList(userRow.getBoolean(&quot;mailingList&quot;));</span>
<span class="nc" id="L438">            userInfo.setLoginModified(userRow.getBoolean(&quot;modifiedLogin&quot;));</span>
<span class="nc" id="L439">            userInfo.setEmailValidated(userRow.getBoolean(&quot;emailValidated&quot;));</span>
<span class="nc" id="L440">            userInfo.setIAMSEMember(userRow.getBoolean(&quot;IAMSEMember&quot;));					</span>
            
<span class="nc" id="L442">        } catch (UnsupportedConversionException ex) {</span>
<span class="nc" id="L443">            throw new SQLException(ex.toString());</span>
<span class="nc" id="L444">        } catch (NoSuchColumnException nsce) {</span>
<span class="nc" id="L445">            throw new SQLException(nsce.toString());</span>
<span class="nc" id="L446">        }</span>

<span class="nc" id="L448">        return userInfo;</span>
    }

    /**
     * Takes a Row obtained from the database and translates that into
     * a UserBean.  Returns null if the userRow is null and throws
     * and SQLException if an error occurs.
     */
    private ProfessionalRoleBean rowToProfessionalRole(Row userRow)
            throws SQLException {
        // Create a UserBean if the user was found
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (userRow == null) {</span>
            // Not found
<span class="nc" id="L461">            return null;</span>
        }

<span class="nc" id="L464">        ProfessionalRoleBean professionalRole = new ProfessionalRoleBean();</span>
        try {
<span class="nc" id="L466">            professionalRole.setProfessionalRoleId(userRow.getString(&quot;ProfessionalRoleId&quot;));</span>
<span class="nc" id="L467">            professionalRole.setUserId(userRow.getString(&quot;UserId&quot;));</span>
<span class="nc" id="L468">            professionalRole.setProfessionalRole(userRow.getString(&quot;ProfessionalRole&quot;));</span>
<span class="nc" id="L469">        } catch (NoSuchColumnException nsce) {</span>
<span class="nc" id="L470">            throw new SQLException(nsce.toString());</span>
<span class="nc" id="L471">        }</span>
<span class="nc" id="L472">        return professionalRole;</span>
    }
		
    /**
     * Takes a Row obtained from the database and translates that into
     * a UserBean.  Returns null if the userRow is null and throws
     * and SQLException if an error occurs.
     */
    private InstructionalLevelBean rowToInstructionalLevel(Row userRow)
            throws SQLException {
        // Create a UserBean if the user was found
<span class="nc bnc" id="L483" title="All 2 branches missed.">        if (userRow == null) {</span>
            // Not found
<span class="nc" id="L485">            return null;</span>
        }

<span class="nc" id="L488">        InstructionalLevelBean instructionalLevel = new InstructionalLevelBean();</span>
        try {
<span class="nc" id="L490">            instructionalLevel.setInstructionalLevelId(userRow.getString(&quot;InstructionalLevelId&quot;));</span>
<span class="nc" id="L491">            instructionalLevel.setUserId(userRow.getString(&quot;UserId&quot;));</span>
<span class="nc" id="L492">            instructionalLevel.setInstructionalLevel(userRow.getString(&quot;InstructionalLevel&quot;));</span>
<span class="nc" id="L493">        } catch (NoSuchColumnException nsce) {</span>
<span class="nc" id="L494">            throw new SQLException(nsce.toString());</span>
<span class="nc" id="L495">        }</span>
<span class="nc" id="L496">        return instructionalLevel;</span>
    }	


    /**
     * Inserts the information about the specified user, or
     * updates the information if it's already defined.
     */
    public String saveRegistration(UserBean userInfo) throws SQLException {

        // Save the user info from the database
<span class="nc" id="L507">        Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L508">        Connection conn2 = dataSource.getConnection();</span>
<span class="nc" id="L509">		String userId=&quot;&quot;;</span>
<span class="nc" id="L510">        conn.setAutoCommit(false);</span>
<span class="nc" id="L511">        conn2.setAutoCommit(false);</span>
				
        try {
<span class="nc" id="L514">            saveCompleteUserProperties(userInfo, conn);</span>
<span class="nc" id="L515">            conn.commit();</span>
<span class="nc" id="L516">			userId = userInfo.getUserId();		</span>
<span class="nc bnc" id="L517" title="All 4 branches missed.">			if(userInfo.getUserId() == null || userInfo.getUserId().length()==0){</span>
<span class="nc" id="L518">                UserBean userInfo2=getUserFromEmail(userInfo.getEmail());</span>
<span class="nc" id="L519">				userInfo.setUserId(userInfo2.getUserId());</span>
<span class="nc" id="L520">				userId = userInfo2.getUserId();</span>
			}				
				
<span class="nc" id="L523">			saveUserProfessionalRole(userInfo, conn2);</span>
<span class="nc" id="L524">			saveUserInstructionalLevel(userInfo, conn2);	</span>
<span class="nc" id="L525">            conn2.commit();						</span>
        } finally {
            try {
<span class="nc" id="L528">                conn.setAutoCommit(true);</span>
<span class="nc" id="L529">                conn.close();</span>
<span class="nc" id="L530">                conn2.setAutoCommit(true);</span>
<span class="nc" id="L531">                conn2.close();								</span>
<span class="nc" id="L532">            } catch (SQLException e) {</span>
<span class="nc" id="L533">							e.printStackTrace();} </span>
        }
<span class="nc" id="L535">		return userId;</span>
    }

    /**
     * Inserts the XML encoded user registration information into the
     * database, or updates the information if it is already defined.
     */
    public void saveRegistration(String xmlRegistration) throws SQLException {
<span class="nc" id="L543">        UserBean userInfo = new UserBean();</span>
<span class="nc" id="L544">        userInfo.parseXML(xmlRegistration);</span>
<span class="nc" id="L545">        saveRegistration(userInfo);</span>
<span class="nc" id="L546">    }</span>

    /**
     * Looks up a user property in the Users table that matches the given
     * UserName.  The property should be a String value such that calling
     * Row.getString() doesn't cause any problems.
     */
    private String getUserStringProperty(String userName,
                                         String propertyName,
                                         Connection conn)
            throws SQLException {
<span class="nc bnc" id="L557" title="All 4 branches missed.">        if (userName == null || propertyName == null) {</span>
<span class="nc" id="L558">            return null;</span>
        }
<span class="nc" id="L560">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L561">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L562">        String sql = &quot;SELECT &quot; + propertyName + &quot; FROM USERS WHERE UserName = ?&quot;;</span>
<span class="nc" id="L563">        sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L564">        Vector values = new Vector();</span>
<span class="nc" id="L565">        values.addElement(new StringValue(userName));</span>
<span class="nc" id="L566">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L567">        Vector rows = null;</span>
        try {
<span class="nc" id="L569">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L570">        } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L571">            throw new SQLException(e.toString());</span>
<span class="nc" id="L572">        } // Can not happen here</span>

<span class="nc bnc" id="L574" title="All 4 branches missed.">        if (rows == null || rows.size() == 0) {</span>
            // User not found
<span class="nc" id="L576">            return null;</span>
        }
<span class="nc" id="L578">        Row aRow = (Row) rows.firstElement();</span>
<span class="nc" id="L579">        String result = null;</span>
        try {
<span class="nc" id="L581">            result = aRow.getString(propertyName);</span>
<span class="nc" id="L582">        } catch (NoSuchColumnException ex) {</span>
<span class="nc" id="L583">            ex.printStackTrace();</span>
<span class="nc" id="L584">        }</span>
<span class="nc" id="L585">        return result;</span>
    }

    /**
     * Returns a Row with all information about the specified
     * user or null if the user is not found.
     */
    private Row getUserProperties(String userName, boolean emailIsUsername, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L595" title="All 2 branches missed.">        if (userName == null) {</span>
<span class="nc" id="L596">            return null;</span>
        }

<span class="nc" id="L599">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L600">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L601">		String sql=&quot;&quot;;</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">		if (emailIsUsername){</span>
<span class="nc" id="L603">            sql = &quot;SELECT * FROM USERS WHERE Email = ? and modifiedLogin = 1&quot;;</span>
		}
		else{
<span class="nc" id="L606">            sql = &quot;SELECT * FROM USERS WHERE UserName = ?&quot;;</span>
		}
<span class="nc" id="L608">        sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L609">        Vector values = new Vector();</span>
<span class="nc" id="L610">        values.addElement(new StringValue(userName));</span>
<span class="nc" id="L611">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L612">        Vector rows = null;</span>
        try {
<span class="nc" id="L614">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L615">        } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L616">            throw new SQLException(e.toString());</span>
<span class="nc" id="L617">        } // Can not happen here</span>

<span class="nc bnc" id="L619" title="All 4 branches missed.">        if (rows == null || rows.size() == 0) {</span>
            // User not found
<span class="nc" id="L621">            return null;</span>
        }
<span class="nc" id="L623">        return (Row) rows.firstElement();</span>
    }

    /**
     * Returns a Row with all information about the specified
     * user or null if the user is not found.
     */
    private Vector getUserProfessionalRole(String userId, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L633" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L634">            return null;</span>
        }

<span class="nc" id="L637">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L638">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L639">        String sql = &quot;SELECT * FROM UsersProfessionalRole WHERE UserId = ?&quot;;</span>
<span class="nc" id="L640">        sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L641">        Vector values = new Vector();</span>
<span class="nc" id="L642">        values.addElement(new StringValue(userId));</span>
<span class="nc" id="L643">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L644">        Vector rows = null;</span>
        try {
<span class="nc" id="L646">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L647">        } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L648">            throw new SQLException(e.toString());</span>
<span class="nc" id="L649">        } // Can not happen here</span>

<span class="nc bnc" id="L651" title="All 4 branches missed.">        if (rows == null || rows.size() == 0) {</span>
            // User not found
<span class="nc" id="L653">            return null;</span>
        }
        //return (Row) rows.firstElement();
<span class="nc" id="L656">		return rows;</span>
    }
		
    /**
     * Returns a Row with all information about the specified
     * user or null if the user is not found.
     */
    private Vector getUserInstructionalLevel(String userId, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L667">            return null;</span>
        }

<span class="nc" id="L670">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L671">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L672">        String sql = &quot;SELECT * FROM UsersInstructionalLevel WHERE UserId = ?&quot;;</span>
<span class="nc" id="L673">        sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L674">        Vector values = new Vector();</span>
<span class="nc" id="L675">        values.addElement(new StringValue(userId));</span>
<span class="nc" id="L676">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L677">        Vector rows = null;</span>
        try {
<span class="nc" id="L679">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L680">        } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L681">            throw new SQLException(e.toString());</span>
<span class="nc" id="L682">        } // Can not happen here</span>

<span class="nc bnc" id="L684" title="All 4 branches missed.">        if (rows == null || rows.size() == 0) {</span>
            // User not found
<span class="nc" id="L686">            return null;</span>
        }
        //return (Row) rows.firstElement();
<span class="nc" id="L689">		return rows;</span>
    }		

    /**
     * Returns a Row with all information about the specified
     * user or null if the user is not found.
     */
    private Row getUserPropertiesFromID(String userID, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L699" title="All 2 branches missed.">        if (userID == null) {</span>
<span class="nc" id="L700">            return null;</span>
        }

<span class="nc" id="L703">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L704">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L705">        String sql = &quot;SELECT * FROM USERS WHERE UserID = ?&quot;;</span>
<span class="nc" id="L706">        sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L707">        Vector values = new Vector();</span>
<span class="nc" id="L708">        values.addElement(new StringValue(userID));</span>
<span class="nc" id="L709">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L710">        Vector rows = null;</span>
        try {
<span class="nc" id="L712">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L713">        } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L714">            throw new SQLException(e.toString());</span>
<span class="nc" id="L715">        } // Can not happen here</span>

<span class="nc bnc" id="L717" title="All 4 branches missed.">        if (rows == null || rows.size() == 0) {</span>
            // User not found
<span class="nc" id="L719">            return null;</span>
        }
<span class="nc" id="L721">        return (Row) rows.firstElement();</span>
    }
    
       /**
     * Returns a Row with all information about the specified
     * user or null if the user's email address is not found.
     */
    private Row getUserPropertiesFromEmail(String email, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L731" title="All 2 branches missed.">        if (email == null) {</span>
<span class="nc" id="L732">            return null;</span>
        }

<span class="nc" id="L735">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L736">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L737">        String sql = &quot;SELECT * FROM USERS WHERE email = ?&quot;;</span>
<span class="nc" id="L738">        sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L739">        Vector values = new Vector();</span>
<span class="nc" id="L740">        values.addElement(new StringValue(email));</span>
<span class="nc" id="L741">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L742">        Vector rows = null;</span>
        try {
<span class="nc" id="L744">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L745">        } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L746">            throw new SQLException(e.toString());</span>
<span class="nc" id="L747">        } // Can not happen here</span>

<span class="nc bnc" id="L749" title="All 4 branches missed.">        if (rows == null || rows.size() == 0) {</span>
            // User not found
<span class="nc" id="L751">            return null;</span>
        }
<span class="nc" id="L753">        return (Row) rows.firstElement();</span>
    } 

    /**
     * Given a user ID and a set of permissions, looks up the user in the
     * database and if the user is found, updates their permissions.  Returns
     * false if either parameter is null, the user was not found in the
     * database, or an error occured.  Otherwise the method returns true.
     */
    public boolean setPermissions(String userId,
                                  UserPermissionsBean permissions) {
<span class="nc bnc" id="L764" title="All 4 branches missed.">        if (userId == null || permissions == null) {</span>
<span class="nc" id="L765">            return false;</span>
        }
<span class="nc" id="L767">        boolean success = false;</span>
<span class="nc" id="L768">        Connection conn = null;</span>
        try {
<span class="nc" id="L770">            conn = dataSource.getConnection();</span>
<span class="nc" id="L771">            conn.setAutoCommit(false);</span>
<span class="nc" id="L772">            Row userRow = getUserProperties(userId, false, conn);</span>
<span class="nc" id="L773">            UserBean user = rowToBean(userRow);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">            if (user != null) {</span>
<span class="nc" id="L775">                user.setMinor(permissions.isMinor());</span>
<span class="nc" id="L776">                user.setAdministrator(permissions.isAdministrator());</span>
<span class="nc" id="L777">                user.setCataloger(permissions.isCataloger());</span>
<span class="nc" id="L778">                user.setApprover(permissions.isApprover());</span>
<span class="nc" id="L779">                saveUserProperties(user, conn);</span>
<span class="nc" id="L780">                success = true;</span>
            }
<span class="nc" id="L782">        } catch (SQLException ex) {</span>
<span class="nc" id="L783">            ex.printStackTrace();</span>
        } finally {
            try {
<span class="nc bnc" id="L786" title="All 2 branches missed.">                if (conn != null) {</span>
<span class="nc" id="L787">                    conn.setAutoCommit(true);</span>
<span class="nc" id="L788">                    conn.commit();</span>
<span class="nc" id="L789">                    conn.close();</span>
                }
<span class="nc" id="L791">            } catch (SQLException ex2) {</span>
<span class="nc" id="L792">                ex2.printStackTrace();</span>
<span class="nc" id="L793">            }</span>
        }
<span class="nc" id="L795">        return success;</span>
    }

    /**
     * Inserts the information about the specified user,
     * or updates the information if it's already defined.
     */
    private void saveCompleteUserProperties(UserBean userInfo, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L805" title="All 2 branches missed.">        if (userInfo == null) {</span>
<span class="nc" id="L806">            return;</span>
        }
<span class="nc" id="L808">		saveUserProperties(userInfo, conn);</span>
		//conn.commit();				
		//if(userInfo.getUserId() == null || userInfo.getUserId().length()==0)
        //{
            //userInfo=getUserFromEmail(userInfo.getEmail());
		//}				
				
		//saveUserProfessionalRole(userInfo, conn);
		//saveUserInstructionalLevel(userInfo, conn);
<span class="nc" id="L817">	}</span>

    /**
     * Inserts the information about the specified user,
     * or updates the information if it's already defined.
     */
    private void saveUserProperties(UserBean userInfo, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L826" title="All 2 branches missed.">        if (userInfo == null) {</span>
<span class="nc" id="L827">            return;</span>
        }

<span class="nc" id="L830">        UserBean dbInfo = getUser(userInfo.getUserName(),false);</span>
<span class="nc" id="L831">        StringBuffer sql = new StringBuffer();</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">        if (dbInfo == null) {</span>
            // Use INSERT statement
<span class="nc" id="L834">            sql.append(&quot;INSERT INTO Users &quot;).</span>
<span class="nc" id="L835">                    append(&quot;(Password, Minor, Administrator, &quot;).</span>
<span class="nc" id="L836">                    append(&quot;Cataloger, Approver, FirstName, LastName, MI, &quot;).</span>
                    //append(&quot;Email, ProfessionalTitle, ProfessionalSpecialty, &quot;).
<span class="nc" id="L838">                    append(&quot;Email, ProfessionalSpecialty, &quot;).		</span>
<span class="nc" id="L839">                    append(&quot;PhoneNumber, InstitutionName, Address1, Address2, &quot;).</span>
<span class="nc" id="L840">                    append(&quot;City, State, ZipCode, Country, mailingList, modifiedLogin, emailValidated, IAMSEMember, UserName) &quot;).</span>
<span class="nc" id="L841">                    append(&quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, &quot;).</span>
<span class="nc" id="L842">                    append(&quot;?, ?, ?, ?, ?, ?, ?, ?,?,?)&quot;);</span>
        } else {
            // Use UPDATE statement
<span class="nc" id="L845">            sql.append(&quot;UPDATE Users SET &quot;).</span>
<span class="nc" id="L846">                    append(&quot;Password = ?, Minor = ?, Administrator = ?, &quot;).</span>
<span class="nc" id="L847">                    append(&quot;Cataloger = ?, Approver = ?, FirstName = ?, &quot;).</span>
<span class="nc" id="L848">                    append(&quot;LastName = ?, MI = ?, Email = ?, &quot;).</span>
                    //append(&quot;ProfessionalTitle = ?, ProfessionalSpecialty = ?, &quot;).
<span class="nc" id="L850">                    append(&quot;ProfessionalSpecialty = ?, &quot;).</span>
<span class="nc" id="L851">                    append(&quot;PhoneNumber = ?, InstitutionName = ?, Address1 = ?, &quot;).</span>
<span class="nc" id="L852">                    append(&quot;Address2 = ?, City = ?, State = ?, ZipCode = ?, &quot;).</span>
<span class="nc" id="L853">                    append(&quot;Country = ?, mailingList = ?, modifiedLogin = ?, emailValidated = ?, IAMSEMember = ? WHERE UserName= ?&quot;);</span>
        }

<span class="nc" id="L856">        PreparedStatement ps = null;</span>
        try {
<span class="nc" id="L858">            ps = conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L859">            ps.setString(1, userInfo.getPassword());</span>
<span class="nc" id="L860">            ps.setBoolean(2, userInfo.isMinor());</span>
<span class="nc" id="L861">            ps.setBoolean(3, userInfo.isAdministrator());</span>
<span class="nc" id="L862">            ps.setBoolean(4, userInfo.isCataloger());</span>
<span class="nc" id="L863">            ps.setBoolean(5, userInfo.isApprover());</span>
<span class="nc" id="L864">            ps.setString(6, userInfo.getFirstName());</span>
<span class="nc" id="L865">            ps.setString(7, userInfo.getLastName());</span>
<span class="nc" id="L866">            ps.setString(8, userInfo.getMiddleInitial());</span>
<span class="nc" id="L867">            ps.setString(9, userInfo.getEmail());</span>
            //ps.setString(10, userInfo.getProfessionalTitle());
<span class="nc" id="L869">            ps.setString(10, userInfo.getProfessionalSpecialty());</span>
<span class="nc" id="L870">            ps.setString(11, userInfo.getPhoneNumber());</span>
<span class="nc" id="L871">            ps.setString(12, userInfo.getInstitutionName());</span>
<span class="nc" id="L872">            ps.setString(13, userInfo.getAddress1());</span>
<span class="nc" id="L873">            ps.setString(14, userInfo.getAddress2());</span>
<span class="nc" id="L874">            ps.setString(15, userInfo.getCity());</span>
<span class="nc" id="L875">            ps.setString(16, userInfo.getState());</span>
<span class="nc" id="L876">            ps.setString(17, userInfo.getZipCode());</span>
<span class="nc" id="L877">            ps.setString(18, userInfo.getCountry());</span>
<span class="nc" id="L878">            ps.setBoolean(19, userInfo.getMailingList());</span>
<span class="nc" id="L879">            ps.setBoolean(20, true);</span>
<span class="nc" id="L880">            ps.setBoolean(21, userInfo.isEmailValidated());</span>
<span class="nc" id="L881">            ps.setBoolean(22, userInfo.isIAMSEMember());</span>
<span class="nc" id="L882">            ps.setString(23, userInfo.getUserName());</span>
<span class="nc" id="L883">            ps.executeUpdate();</span>
        } finally {
<span class="nc bnc" id="L885" title="All 2 branches missed.">            if(null != ps) {</span>
                // If this isn't in a finally block, then an SQL Exception
                // will leave the prepared statement open when it's returned
                // to the connection pool, causing cloned connection transaction
                // exceptions
<span class="nc" id="L890">                ps.close();</span>
            }
        }
<span class="nc" id="L893">    }</span>
		
		
		public void reset(String username){	
<span class="nc" id="L897">            PreparedStatement ps = null;</span>
            try {
<span class="nc" id="L899">                Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L900">                ps = conn.prepareStatement(&quot;UPDATE Users SET modifiedLogin = 0 where username = ?&quot;);</span>
<span class="nc" id="L901">                ps.setString(1, username);</span>
<span class="nc" id="L902">                ps.executeUpdate();</span>
            }    
<span class="nc" id="L904">			catch(SQLException sqlEx){</span>
<span class="nc" id="L905">                sqlEx.printStackTrace();</span>
            }
			finally {
<span class="nc bnc" id="L908" title="All 2 branches missed.">                if(null != ps) {</span>
                // If this isn't in a finally block, then an SQL Exception
                // will leave the prepared statement open when it's returned
                // to the connection pool, causing cloned connection transaction
                // exceptions
                    try{
<span class="nc" id="L914">                        ps.close();</span>
					}
<span class="nc" id="L916">					catch(SQLException sqlEx){</span>
<span class="nc" id="L917">                        sqlEx.printStackTrace();</span>
<span class="nc" id="L918">                    }</span>
                }   
            }		
<span class="nc" id="L921">		}</span>

    public boolean validateEmail(String email, int userId){
<span class="nc" id="L924">        PreparedStatement ps = null;</span>
<span class="nc" id="L925">        int rowCount = 0;</span>
<span class="nc" id="L926">        boolean update = false;</span>
        try{
<span class="nc" id="L928">            Connection conn = dataSource.getConnection();</span>
<span class="nc" id="L929">            ps = conn.prepareStatement(&quot;UPDATE Users SET emailValidated = 1 where email = ? and userId = ?&quot;);</span>
<span class="nc" id="L930">            ps.setString(1, email);</span>
<span class="nc" id="L931">            ps.setInt(2, userId);</span>
<span class="nc" id="L932">            rowCount = ps.executeUpdate();</span>
        } 
<span class="nc" id="L934">        catch(SQLException sqlEx){</span>
<span class="nc" id="L935">            sqlEx.printStackTrace();</span>
        }
		finally {
<span class="nc bnc" id="L938" title="All 2 branches missed.">            if(null != ps){</span>
            // If this isn't in a finally block, then an SQL Exception
            // will leave the prepared statement open when it's returned
            // to the connection pool, causing cloned connection transaction
            // exceptions
                try{
<span class="nc" id="L944">                    ps.close();</span>
				}
<span class="nc" id="L946">				catch(SQLException sqlEx){</span>
<span class="nc" id="L947">                    sqlEx.printStackTrace();</span>
<span class="nc" id="L948">                }</span>
            }
        }
      
<span class="nc bnc" id="L952" title="All 2 branches missed.">        if (rowCount &gt; 0){</span>
<span class="nc" id="L953">            return true;</span>
        }  
        else{
<span class="nc" id="L956">            return false;</span>
        }  
    }
		public void updateEmail(String email, String newemail)
		{
			
<span class="nc" id="L962">							PreparedStatement ps = null;</span>
        try {
<span class="nc" id="L964">						Connection conn = dataSource.getConnection();</span>

<span class="nc" id="L966">            ps = conn.prepareStatement(&quot;UPDATE Users SET emailValidated = 0, UserName = ?, email= ? where email = ?&quot;);</span>
<span class="nc" id="L967">            ps.setString(1, newemail);</span>
<span class="nc" id="L968">            ps.setString(2, newemail);</span>
<span class="nc" id="L969">            ps.setString(3, email);</span>
<span class="nc" id="L970">            ps.executeUpdate();</span>
        } 
<span class="nc" id="L972">				catch(SQLException sqlEx){</span>
				}
				finally {
<span class="nc bnc" id="L975" title="All 2 branches missed.">            if(null != ps) {</span>
                
								try{
<span class="nc" id="L978">                ps.close();</span>
								}
<span class="nc" id="L980">								catch(SQLException sqlEx){</span>
<span class="nc" id="L981">				}</span>
            }
        }		

<span class="nc" id="L985">		}</span>
			
    /**
     * Inserts the information about the specified user,
     * or updates the information if it's already defined.
     */
    private void saveUserProfessionalRole(UserBean userInfo, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L994" title="All 2 branches missed.">        if (userInfo == null) {</span>
<span class="nc" id="L995">            return;</span>
        }
		
<span class="nc" id="L998">        PreparedStatement ps = null;</span>
        
        try {
<span class="nc" id="L1001">            ps = conn.prepareStatement(&quot;DELETE UsersProfessionalRole where UserId = ?&quot;);</span>
<span class="nc" id="L1002">            ps.setString(1, userInfo.getUserId());</span>
<span class="nc" id="L1003">            ps.executeUpdate();</span>
        } finally {
<span class="nc bnc" id="L1005" title="All 2 branches missed.">            if(null != ps) {</span>
                // If this isn't in a finally block, then an SQL Exception
                // will leave the prepared statement open when it's returned
                // to the connection pool, causing cloned connection transaction
                // exceptions
<span class="nc" id="L1010">                ps.close();</span>
            }
        }

<span class="nc" id="L1014">            String userId = userInfo.getUserId();				</span>
<span class="nc" id="L1015">			ProfessionalRoleBean prb = null;</span>
<span class="nc" id="L1016">			ArrayList prbs = userInfo.getProfessionalRole();</span>
<span class="nc" id="L1017">            Iterator it = prbs.iterator();</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">			while (it.hasNext()){</span>
<span class="nc" id="L1019">                prb=(ProfessionalRoleBean)it.next();</span>
<span class="nc" id="L1020">                StringBuffer sql = new StringBuffer();</span>
                // Use INSERT statement
<span class="nc" id="L1022">                sql.append(&quot;INSERT INTO UsersProfessionalRole &quot;).</span>
<span class="nc" id="L1023">                    append(&quot;(UserId, ProfessionalRole) &quot;).</span>
<span class="nc" id="L1024">                    append(&quot;VALUES (?,?)&quot;);</span>
                    
                try {
<span class="nc" id="L1027">                    ps = conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L1028">                    ps.setInt(1,Integer.parseInt(userId));</span>
<span class="nc" id="L1029">                    ps.setString(2, prb.getProfessionalRole());</span>
<span class="nc" id="L1030">                    ps.executeUpdate();//System.err.println(&quot;heree&quot;);</span>
                } 
                finally {
<span class="nc bnc" id="L1033" title="All 2 branches missed.">                    if(null != ps) {</span>
                    // If this isn't in a finally block, then an SQL Exception
                    // will leave the prepared statement open when it's returned
                    // to the connection pool, causing cloned connection transaction
                    // exceptions
<span class="nc" id="L1038">                        ps.close();</span>
                    }
                }
<span class="nc" id="L1041">            }</span>
<span class="nc" id="L1042">        }</span>


    /**
     * Inserts the information about the specified user,
     * or updates the information if it's already defined.
     */
    private void saveUserInstructionalLevel(UserBean userInfo, Connection conn)
            throws SQLException {

<span class="nc bnc" id="L1052" title="All 2 branches missed.">        if (userInfo == null) {</span>
<span class="nc" id="L1053">            return;</span>
        }

<span class="nc" id="L1056">		PreparedStatement ps = null;</span>
        try {
<span class="nc" id="L1058">            ps = conn.prepareStatement(&quot;DELETE UsersInstructionalLevel where UserId = ?&quot;);</span>
<span class="nc" id="L1059">            ps.setString(1, userInfo.getUserId());</span>
<span class="nc" id="L1060">            ps.executeUpdate();</span>
        } finally {
<span class="nc bnc" id="L1062" title="All 2 branches missed.">            if(null != ps) {</span>
                // If this isn't in a finally block, then an SQL Exception
                // will leave the prepared statement open when it's returned
                // to the connection pool, causing cloned connection transaction
                // exceptions
<span class="nc" id="L1067">                ps.close();</span>
            }
        }				
<span class="nc" id="L1070">		String userId = userInfo.getUserId();</span>
<span class="nc" id="L1071">		InstructionalLevelBean ilb = null;</span>
<span class="nc" id="L1072">		ArrayList ilbs = userInfo.getInstructionalLevel();</span>
<span class="nc" id="L1073">        Iterator it = ilbs.iterator();</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">		while (it.hasNext()){</span>
<span class="nc" id="L1075">            ilb=(InstructionalLevelBean)it.next();</span>
<span class="nc" id="L1076">			StringBuffer sql = new StringBuffer();</span>

            // Use INSERT statement
<span class="nc" id="L1079">            sql.append(&quot;INSERT INTO UsersInstructionalLevel &quot;).</span>
<span class="nc" id="L1080">                    append(&quot;(UserId, InstructionalLevel) &quot;).</span>
<span class="nc" id="L1081">                    append(&quot;VALUES (?,?)&quot;);</span>
										
            try {
<span class="nc" id="L1084">                ps = conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L1085">                ps.setInt(1,Integer.parseInt(userId));</span>
<span class="nc" id="L1086">                ps.setString(2, ilb.getInstructionalLevel());</span>
<span class="nc" id="L1087">                ps.executeUpdate();</span>
            } 
            finally {
<span class="nc bnc" id="L1090" title="All 2 branches missed.">                if(null != ps) {</span>
                // If this isn't in a finally block, then an SQL Exception
                // will leave the prepared statement open when it's returned
                // to the connection pool, causing cloned connection transaction
                // exceptions
<span class="nc" id="L1095">                    ps.close();</span>
                }
            }
<span class="nc" id="L1098">		}</span>
<span class="nc" id="L1099">    }		</span>

    /**
     * Looks up the user's ID in the Users table and adds an entry for it
     * in the Subscriber's table (if it doesn't already exist).
     * Returns true if successful (also if it already exists in the table)
     * and false if an error occurs.
     */
    public boolean addUserToSubscribers(String userName) {
<span class="nc" id="L1108">        boolean success = false;</span>
<span class="nc" id="L1109">        Connection conn = null;</span>
        try {
<span class="nc" id="L1111">            conn = dataSource.getConnection();</span>
<span class="nc" id="L1112">            String userId = getUserStringProperty(userName, &quot;UserID&quot;, conn);</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">            if (userId != null) {</span>
<span class="nc bnc" id="L1114" title="All 2 branches missed.">                if (getSubscriber(userId, conn) != null) {</span>
<span class="nc" id="L1115">                    success = true;</span>
                } else {
<span class="nc" id="L1117">                    success = addSubscriber(userId, conn);</span>
                }
            }
<span class="nc" id="L1120">        } catch (SQLException ex) {</span>
<span class="nc" id="L1121">            ex.printStackTrace();</span>
        } finally {
            try {
<span class="nc bnc" id="L1124" title="All 2 branches missed.">                if (conn != null) {</span>
<span class="nc" id="L1125">                    conn.close();</span>
                }
<span class="nc" id="L1127">            } catch (SQLException ex) {</span>
                //ignore, we just want the connection closed.
<span class="nc" id="L1129">            }</span>
        }
<span class="nc" id="L1131">        return success;</span>
    }

    /**
     * Looks up the user's ID in the Users table and removes any entries for it
     * in the Subscriber's table.  Returns true if on success and false if
     * an error occurs.
     */
    public boolean removeUserFromSubscribers(String userName) {
<span class="nc" id="L1140">        boolean success = false;</span>
<span class="nc" id="L1141">        Connection conn = null;</span>
        try {
<span class="nc" id="L1143">            conn = dataSource.getConnection();</span>
<span class="nc" id="L1144">            String userId = getUserStringProperty(userName, &quot;UserID&quot;, conn);</span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">            if (userId != null) {</span>
<span class="nc" id="L1146">                success = deleteSubscriber(userId, conn);</span>
            }
<span class="nc" id="L1148">        } catch (SQLException ex) {</span>
<span class="nc" id="L1149">            ex.printStackTrace();</span>
        } finally {
            try {
<span class="nc bnc" id="L1152" title="All 2 branches missed.">                if (conn != null) {</span>
<span class="nc" id="L1153">                    conn.close();</span>
                }
<span class="nc" id="L1155">            } catch (SQLException ex) {</span>
                //ignore, we just want the connection closed.
<span class="nc" id="L1157">            }</span>
        }
<span class="nc" id="L1159">        return success;</span>
    }

    /**
     * Attempts to delete a subscriber from the subscribers table.
     * This method will delete all subscribers found with the given
     * UserID (there should only be one, but just in case).
     */
    private boolean deleteSubscriber(String userId, Connection conn)
            throws SQLException {
<span class="nc" id="L1169">        boolean success = false;</span>
<span class="nc bnc" id="L1170" title="All 4 branches missed.">        if (userId == null || conn == null) {</span>
<span class="nc" id="L1171">            return false;</span>
        }
        try {
<span class="nc" id="L1174">            StringBuffer sql = new StringBuffer();</span>
            // Use DELETE statement
<span class="nc" id="L1176">            sql.append(&quot;DELETE FROM Subscribers WHERE UserID = ?&quot;);</span>
<span class="nc" id="L1177">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1178">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1179">            sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L1180">            Vector values = new Vector();</span>
<span class="nc" id="L1181">            values.addElement(new StringValue(userId));</span>

<span class="nc" id="L1183">            sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1184">            sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1185">            success = true;</span>
<span class="nc" id="L1186">        } catch (SQLException ex) {</span>
<span class="nc" id="L1187">            ex.printStackTrace();</span>
<span class="nc" id="L1188">        }</span>
<span class="nc" id="L1189">        return success;</span>
    }

    /**
     * Attempts to add a subscriber to the subscribers table.
     * This method will insert a subscriber regardless of whether or not
     * it already exists in the tabel.
     */
    private boolean addSubscriber(String userId, Connection conn) {
<span class="nc" id="L1198">        boolean success = false;</span>
<span class="nc bnc" id="L1199" title="All 4 branches missed.">        if (userId == null || conn == null) {</span>
<span class="nc" id="L1200">            return false;</span>
        }
        try {
<span class="nc" id="L1203">            StringBuffer sql = new StringBuffer();</span>
            // Use INSERT statement
<span class="nc" id="L1205">            sql.append(&quot;INSERT INTO Subscribers (UserID) VALUES(?)&quot;);</span>
<span class="nc" id="L1206">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1207">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1208">            sqlCommandBean.setSqlValue(sql.toString());</span>
<span class="nc" id="L1209">            Vector values = new Vector();</span>
<span class="nc" id="L1210">            values.addElement(new StringValue(userId));</span>

<span class="nc" id="L1212">            sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1213">            sqlCommandBean.executeUpdate();</span>
<span class="nc" id="L1214">            success = true;</span>
<span class="nc" id="L1215">        } catch (SQLException ex) {</span>
<span class="nc" id="L1216">            ex.printStackTrace();</span>
<span class="nc" id="L1217">        }</span>
<span class="nc" id="L1218">        return success;</span>
    }

    /**
     * If the given userId is found in the subscriber table, then
     * its corresponding Row is returned.  Otherwise, null is returned
     * if no subscriber is found.  In case of an error, an SQLException
     * is throw.
     */
    private Row getSubscriber(String userId, Connection conn)
            throws SQLException {
<span class="nc bnc" id="L1229" title="All 4 branches missed.">        if (userId == null || conn == null) {</span>
<span class="nc" id="L1230">            return null;</span>
        }

<span class="nc" id="L1233">        SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1234">        sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1235">        String sql = &quot;SELECT * FROM Subscribers WHERE UserID = ?&quot;;</span>
<span class="nc" id="L1236">        sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L1237">        Vector values = new Vector();</span>
<span class="nc" id="L1238">        values.addElement(new StringValue(userId));</span>
<span class="nc" id="L1239">        sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1240">        Vector rows = null;</span>
        try {
<span class="nc" id="L1242">            rows = sqlCommandBean.executeQuery();</span>
<span class="nc" id="L1243">        } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L1244">            throw new SQLException(e.toString());</span>
<span class="nc" id="L1245">        } // Can not happen here</span>

<span class="nc bnc" id="L1247" title="All 4 branches missed.">        if (rows == null || rows.size() == 0) {</span>
            // User not found
<span class="nc" id="L1249">            return null;</span>
        }
<span class="nc" id="L1251">        return (Row) rows.firstElement();</span>
    }

    /**
     * Looks up all entries in the Users table with a true value for the
     * administrator setting.  Returns an ArrayList of Strings containing
     * the email addresses of the found users.
     */
    public ArrayList getAdminEmailAddresses() {
        //Get the useraddresses from the database
<span class="nc" id="L1261">        Connection conn = null;</span>
<span class="nc" id="L1262">        ArrayList addresses = null;</span>
        try {
<span class="nc" id="L1264">            conn = dataSource.getConnection();</span>
<span class="nc" id="L1265">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1266">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1267">            String sql = &quot;SELECT Email FROM Users WHERE Administrator = ?&quot;;</span>
<span class="nc" id="L1268">            sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L1269">            Vector values = new Vector();</span>
<span class="nc" id="L1270">            values.addElement(new BooleanValue(true));</span>
<span class="nc" id="L1271">            sqlCommandBean.setValues(values);</span>
<span class="nc" id="L1272">            Vector rows = null;</span>
            String name;
            Object[] rowArray;
            try {
<span class="nc" id="L1276">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc bnc" id="L1277" title="All 4 branches missed.">                if (rows != null &amp;&amp; rows.size() &gt; 0) {</span>
<span class="nc" id="L1278">                    addresses = new ArrayList();</span>
<span class="nc" id="L1279">                    rowArray = rows.toArray();</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">                    for (int rowIndex = 0; rowIndex &lt; rowArray.length; rowIndex++) {</span>
<span class="nc" id="L1281">                        name = ((Row) rowArray[rowIndex]).getString(&quot;Email&quot;);</span>
<span class="nc" id="L1282">                        addresses.add(name);</span>
                    }
                }
<span class="nc" id="L1285">            } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L1286">                throw new SQLException(e.toString());</span>
<span class="nc" id="L1287">            } catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L1288">                throw new SQLException(e2.toString());</span>
<span class="nc" id="L1289">            }</span>
<span class="nc" id="L1290">        } catch (SQLException ex) {</span>
<span class="nc" id="L1291">            ex.printStackTrace();</span>
<span class="nc" id="L1292">            addresses = null;</span>
        } finally {
            try {
<span class="nc bnc" id="L1295" title="All 2 branches missed.">                if (conn != null) {</span>
<span class="nc" id="L1296">                    conn.close();</span>
                }
<span class="nc" id="L1298">            } catch (SQLException e) {</span>
<span class="nc" id="L1299">            } // Ignore</span>
        }
<span class="nc" id="L1301">        return addresses;</span>
    }

    /**
     * This method gets all of the usernames corresponding to user ids
     * found in the subscribers table.
     * Returns an ArrayList of strings.
     */
    public ArrayList getAllSubscribers() {
        //Get the useraddresses from the database
<span class="nc" id="L1311">        Connection conn = null;</span>
<span class="nc" id="L1312">        ArrayList users = null;</span>
        try {
<span class="nc" id="L1314">            conn = dataSource.getConnection();</span>
<span class="nc" id="L1315">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1316">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1317">            String sql = &quot;SELECT UserName FROM Users WHERE UserID =some (SELECT UserID FROM Subscribers)&quot;;</span>
<span class="nc" id="L1318">            sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L1319">            Vector rows = null;</span>
            String name;
            Object[] rowArray;
            try {
<span class="nc" id="L1323">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc bnc" id="L1324" title="All 4 branches missed.">                if (rows != null &amp;&amp; rows.size() &gt; 0) {</span>
<span class="nc" id="L1325">                    users = new ArrayList();</span>
<span class="nc" id="L1326">                    rowArray = rows.toArray();</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">                    for (int rowIndex = 0; rowIndex &lt; rowArray.length; rowIndex++) {</span>
<span class="nc" id="L1328">                        name = ((Row) rowArray[rowIndex]).getString(&quot;UserName&quot;);</span>
<span class="nc" id="L1329">                        users.add(name);</span>
                    }
                }
<span class="nc" id="L1332">            } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L1333">                throw new SQLException(e.toString());</span>
<span class="nc" id="L1334">            } catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L1335">                throw new SQLException(e2.toString());</span>
<span class="nc" id="L1336">            }</span>
<span class="nc" id="L1337">        } catch (SQLException ex) {</span>
<span class="nc" id="L1338">            ex.printStackTrace();</span>
<span class="nc" id="L1339">            users = null;</span>
        } finally {
            try {
<span class="nc bnc" id="L1342" title="All 2 branches missed.">                if (conn != null) {</span>
<span class="nc" id="L1343">                    conn.close();</span>
                }
<span class="nc" id="L1345">            } catch (SQLException e) {</span>
<span class="nc" id="L1346">            } // Ignore</span>
        }
<span class="nc" id="L1348">        return users;</span>
    }

    /**
     * This method gets all of the email addresses found in the users table
     * corresponding to the given usernames.  Only users with email addresses
     * in the table will have a value returned.  If an error occurs, null is
     * returned, other wise a possibly empty (if no user email addresses were
     * found) ArrayList is returned.
     */
    public ArrayList getEmailAddresses(String[] userNames) {
        //Get the useraddresses from the database
<span class="nc bnc" id="L1360" title="All 4 branches missed.">        if (userNames == null || userNames.length &lt;= 0) {</span>
<span class="nc" id="L1361">            return null;</span>
        }
<span class="nc" id="L1363">        Connection conn = null;</span>
<span class="nc" id="L1364">        ArrayList addresses = null;</span>
        try {
<span class="nc" id="L1366">            conn = dataSource.getConnection();</span>
<span class="nc" id="L1367">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1368">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1369">            StringBuffer sqlBuffer = new StringBuffer(&quot;SELECT Email FROM Users WHERE &quot;);</span>
<span class="nc" id="L1370">            sqlBuffer.append(&quot;UserName = '&quot; + userNames[0] + &quot;'&quot;);</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">            for (int i = 1; i &lt; userNames.length; i++) {</span>
<span class="nc" id="L1372">                sqlBuffer.append(&quot; or UserName = '&quot; + userNames[i] + &quot;'&quot;);</span>
            }
<span class="nc" id="L1374">            sqlCommandBean.setSqlValue(sqlBuffer.toString());</span>

<span class="nc" id="L1376">            Vector rows = null;</span>
            String name;
            Object[] rowArray;
            try {
<span class="nc" id="L1380">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc bnc" id="L1381" title="All 4 branches missed.">                if (rows != null &amp;&amp; rows.size() &gt; 0) {</span>
<span class="nc" id="L1382">                    addresses = new ArrayList();</span>
<span class="nc" id="L1383">                    rowArray = rows.toArray();</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">                    for (int rowIndex = 0; rowIndex &lt; rowArray.length; rowIndex++) {</span>
<span class="nc" id="L1385">                        name = ((Row) rowArray[rowIndex]).getString(&quot;Email&quot;);</span>
<span class="nc" id="L1386">                        addresses.add(name);</span>
                    }
                }
<span class="nc" id="L1389">            } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L1390">                throw new SQLException(e.toString());</span>
<span class="nc" id="L1391">            } catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L1392">                throw new SQLException(e2.toString());</span>
<span class="nc" id="L1393">            }</span>
<span class="nc" id="L1394">        } catch (SQLException ex) {</span>
<span class="nc" id="L1395">            ex.printStackTrace();</span>
<span class="nc" id="L1396">            addresses = null;</span>
        } finally {
            try {
<span class="nc bnc" id="L1399" title="All 2 branches missed.">                if (conn != null) {</span>
<span class="nc" id="L1400">                    conn.close();</span>
                }
<span class="nc" id="L1402">            } catch (SQLException e) {</span>
<span class="nc" id="L1403">            } // Ignore</span>
        }
<span class="nc" id="L1405">        return addresses;</span>
    }

    /**
     * This method gets all of the userIDs found in the subscribers table and
     * then looks up all the email addresses of those entries from the
     * Users table.
     */
    public ArrayList getSubscriberEmailAddresses() {
        //Get the useraddresses from the database
<span class="nc" id="L1415">        Connection conn = null;</span>
<span class="nc" id="L1416">        ArrayList addresses = null;</span>
        try {
<span class="nc" id="L1418">            conn = dataSource.getConnection();</span>
<span class="nc" id="L1419">            SQLCommandBean sqlCommandBean = new SQLCommandBean();</span>
<span class="nc" id="L1420">            sqlCommandBean.setConnection(conn);</span>
<span class="nc" id="L1421">            String sql = &quot;SELECT Email FROM Users WHERE UserID =some (SELECT UserID FROM Subscribers)&quot;;</span>
<span class="nc" id="L1422">            sqlCommandBean.setSqlValue(sql);</span>
<span class="nc" id="L1423">            Vector rows = null;</span>
            String name;
            Object[] rowArray;
            try {
<span class="nc" id="L1427">                rows = sqlCommandBean.executeQuery();</span>
<span class="nc bnc" id="L1428" title="All 4 branches missed.">                if (rows != null &amp;&amp; rows.size() &gt; 0) {</span>
<span class="nc" id="L1429">                    addresses = new ArrayList();</span>
<span class="nc" id="L1430">                    rowArray = rows.toArray();</span>
<span class="nc bnc" id="L1431" title="All 2 branches missed.">                    for (int rowIndex = 0; rowIndex &lt; rowArray.length; rowIndex++) {</span>
<span class="nc" id="L1432">                        name = ((Row) rowArray[rowIndex]).getString(&quot;Email&quot;);</span>
<span class="nc" id="L1433">                        addresses.add(name);</span>
                    }
                }
<span class="nc" id="L1436">            } catch (UnsupportedTypeException e) {</span>
<span class="nc" id="L1437">                throw new SQLException(e.toString());</span>
<span class="nc" id="L1438">            } catch (NoSuchColumnException e2) {</span>
<span class="nc" id="L1439">                throw new SQLException(e2.toString());</span>
<span class="nc" id="L1440">            }</span>
<span class="nc" id="L1441">        } catch (SQLException ex) {</span>
<span class="nc" id="L1442">            ex.printStackTrace();</span>
<span class="nc" id="L1443">            addresses = null;</span>
        } finally {
            try {
<span class="nc bnc" id="L1446" title="All 2 branches missed.">                if (conn != null) {</span>
<span class="nc" id="L1447">                    conn.close();</span>
                }
<span class="nc" id="L1449">            } catch (SQLException e) {</span>
<span class="nc" id="L1450">            } // Ignore</span>
        }
<span class="nc" id="L1452">        return addresses;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>