<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ModifyMetadataAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet.cataloger</a> &gt; <span class="el_source">ModifyMetadataAction.java</span></div><h1>ModifyMetadataAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet.cataloger;

import org.heal.module.metadata.CompleteMetadataBean;
import org.heal.servlet.Action;
import org.heal.util.AuthenticationTools;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;

/**
 * &lt;p&gt;An {@link Action} that saves the metadata from a form into
 * the session's {@link CompleteMetadataBean} by mapping {@link MetadataModifier}s
 * to forms.  The {@link MetadataModifier} which matches the form determines
 * the next {@link Action} to execute.&lt;/p&gt;
 *
 * &lt;p&gt;The mapping is currently defined as:&lt;/p&gt;
 *
 * &lt;ul&gt;&lt;li&gt;'metadata' : {@link MetadataRecordModifier}
 * &lt;li&gt;'contextURL' : {@link ContextURLRecordModifier}
 * &lt;li&gt;'contributor' : {@link ContributorRecordModifier}
 * &lt;li&gt;'copyrightHolder' : {@link CopyrightHolderRecordModifier}
 * &lt;li&gt;'controlledVocabulary' : {@link ControlledVocabularyRecordModifier}
 * &lt;li&gt;'requirement' : {@link RequirementRecordModifier}
 * &lt;/ul&gt;
 */
public class ModifyMetadataAction implements Action {
	private final Map modifierMap;

<span class="nc" id="L35">	public ModifyMetadataAction() {</span>
		// Initializes the action map
<span class="nc" id="L37">		Map modifierMap = new HashMap();</span>

<span class="nc" id="L39">		modifierMap.put(&quot;metadata&quot;, new MetadataRecordModifier());</span>
<span class="nc" id="L40">		modifierMap.put(&quot;contextURL&quot;, new ContextURLRecordModifier());</span>
<span class="nc" id="L41">		modifierMap.put(&quot;contributor&quot;, new ContributorRecordModifier());</span>
<span class="nc" id="L42">		modifierMap.put(&quot;copyrightHolder&quot;, new CopyrightHolderRecordModifier());</span>
<span class="nc" id="L43">		modifierMap.put(&quot;controlledVocabulary&quot;, new ControlledVocabularyRecordModifier());</span>
<span class="nc" id="L44">		modifierMap.put(&quot;requirement&quot;, new RequirementRecordModifier());</span>
<span class="nc" id="L45">		modifierMap.put(&quot;relation&quot;, new RelationRecordModifier());</span>
<span class="nc" id="L46">        modifierMap.put(&quot;metametadataIdentifier&quot;, new MetametadataIdentifierRecordModifier());</span>
<span class="nc" id="L47">        modifierMap.put(&quot;metametadataContributor&quot;, new MetametadataContributorRecordModifier());</span>

        // This guarantees that the action map will not be modified after initialization
<span class="nc" id="L50">		this.modifierMap = Collections.unmodifiableMap(modifierMap);</span>
<span class="nc" id="L51">	}</span>

	/**
	 * &lt;p&gt;This perform method uses the &lt;code&gt;&quot;type&quot;&lt;/code&gt; parameter to save the
	 * metadata modifications from the &lt;code&gt;request&lt;/code&gt; in the
	 * {@link CompleteMetadataBean} that is in the session.  If the type or
	 * &lt;code&gt;CompleteMetadataBean&lt;/code&gt; doesn't exist, the &lt;code&gt;response&lt;/code&gt; is
	 * redirected to an error page.&lt;/o&gt;
	 *
	 * &lt;p&gt;When a valid type and a &lt;code&gt;CompleteMetadataBean&lt;/code&gt; is available
	 * in the session, this method uses the appropriate {@link MetadataModifier}
	 * to save the motifications to the metadata and to perform the subsequent
	 * {@link Action}.&lt;/p&gt;
	 */
	public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
		  throws IOException, ServletException {
<span class="nc bnc" id="L67" title="All 2 branches missed.">		if(!AuthenticationTools.isCataloger(request)) {</span>
			// The user does not have the access to view this page
			// so we go no further, and redirect them to an access denied page
			// TODO instead of hardcoding page locations, this should be in config files somewhere
<span class="nc" id="L71">			response.sendRedirect(&quot;/error/accessDenied.jsp&quot;);</span>
<span class="nc" id="L72">			return;</span>
		}

<span class="nc" id="L75">		final String modifierKey = request.getParameter(&quot;type&quot;);</span>
<span class="nc" id="L76">		final CompleteMetadataBean cmb = (CompleteMetadataBean)request.getSession().getAttribute(&quot;metadata&quot;);</span>

<span class="nc bnc" id="L78" title="All 4 branches missed.">		if(null == cmb || !modifierMap.containsKey(modifierKey)) {</span>
			// Not enough information in the form and/or session to process this request
<span class="nc" id="L80">			response.sendRedirect(&quot;/error/accessDenied.jsp&quot;);</span>
<span class="nc" id="L81">			return;</span>
		}

<span class="nc" id="L84">		final MetadataModifier modifier = (MetadataModifier)modifierMap.get(modifierKey);</span>
<span class="nc" id="L85">		modifier.updateMetadata(cmb, request);</span>

<span class="nc" id="L87">		Action nextAction = modifier.getNextAction(request);</span>
<span class="nc" id="L88">		nextAction.perform(servlet, request, response);</span>
<span class="nc" id="L89">	}</span>

	/**
	 * @return &lt;code&gt;true&lt;/code&gt;
	 */
	public boolean actionRequiresLogin() {
<span class="nc" id="L95">		return true;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>