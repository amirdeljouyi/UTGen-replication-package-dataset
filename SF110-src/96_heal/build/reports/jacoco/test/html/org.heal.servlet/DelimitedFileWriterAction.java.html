<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DelimitedFileWriterAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet</a> &gt; <span class="el_source">DelimitedFileWriterAction.java</span></div><h1>DelimitedFileWriterAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * An {@link org.heal.servlet.Action} that writes data into a delimited
 * text file.  This is used for simple forms to drop form data into a file.
 * Any new lines in form data will be lost since excel was having trouble
 * handling them.
 *
 * @version 1.1
 * @author Brad Schaefer (&lt;A HREF=&quot;mailto:schaefer@lib.med.utah.edu&quot;&gt;schaefer@lib.med.utah.edu&lt;/A&gt;) 
 */
<span class="nc" id="L25">public abstract class DelimitedFileWriterAction implements Action {</span>
    private static final String DEFAULT_DELIMITER = &quot;|&quot;;

<span class="nc" id="L28">    private static Map locks = new HashMap();</span>

<span class="nc" id="L30">    private String delimiter = DEFAULT_DELIMITER;</span>

    public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
            throws IOException, ServletException {
<span class="nc" id="L34">        List data = getData(request);</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">        if(null != data) {</span>
<span class="nc" id="L36">            File out = new File(servlet.getServletContext().getRealPath(&quot;/&quot;) +&quot;../private/logs/&quot; +getLogFilename());</span>
<span class="nc" id="L37">            appendDataToFile(out, data);</span>
        }
<span class="nc bnc" id="L39" title="All 2 branches missed.">        if(getSuccessPage()!=null){</span>
<span class="nc" id="L40">        RequestDispatcher rd = request.getRequestDispatcher(getSuccessPage());</span>
<span class="nc" id="L41">        rd.forward(request, response);</span>
        }
<span class="nc" id="L43">    }</span>

    /**
     * Appends delimited data to a file.
     *
     * @param file The &lt;code&gt;File&lt;/code&gt; to write to.  The file is expected to
     *      be in the /docs/logs folder.
     * @param data A &lt;code&gt;List&lt;/code&gt; of Strings to delimit and write to the file.
     * @throws IOException Thrown if there are problems writing to the file.
     */
    private void appendDataToFile(File file, List data) throws IOException {
        // Constructs the delimited String to
<span class="nc" id="L55">        StringBuffer outputString = new StringBuffer();</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        for(Iterator iter = data.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L57">            String atom = (String)iter.next();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">            if(null != atom) {</span>
                // Removes newline characters because excel seems resistant
                // to importing delimited data containing them
<span class="nc" id="L61">                atom = atom.replace('\n', ' ').replace('\r', ' ');</span>
<span class="nc bnc" id="L62" title="All 4 branches missed.">				if(-1 != atom.indexOf(getDelimiter()) || -1 != atom.indexOf(&quot;\&quot;&quot;)) {</span>
<span class="nc" id="L63">					atom = &quot;\&quot;&quot; +atom.replaceAll(&quot;\&quot;&quot;, &quot;\&quot;\&quot;&quot;)+ &quot;\&quot;&quot;;</span>
				}
<span class="nc" id="L65">                outputString.append(atom);</span>
            }
<span class="nc bnc" id="L67" title="All 2 branches missed.">			if(iter.hasNext()) {</span>
<span class="nc" id="L68">            	outputString.append(getDelimiter());</span>
			}
<span class="nc" id="L70">        }</span>
        // Adds a line separator to denote a new record
<span class="nc" id="L72">        outputString.append(System.getProperty(&quot;line.separator&quot;));</span>

        Object lock;
<span class="nc" id="L75">        synchronized(locks) { // Obtains the lock object for a given File</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if(locks.containsKey(file)) {</span>
<span class="nc" id="L77">                lock = locks.get(file);</span>
            } else {
<span class="nc" id="L79">                lock = new Object();</span>
<span class="nc" id="L80">                locks.put(file, lock);</span>
            }
<span class="nc" id="L82">        }</span>
<span class="nc" id="L83">        synchronized(lock) {</span>
            // Prevents more than one thread to write to a File at a time
<span class="nc" id="L85">            FileWriter out = new FileWriter(file.getAbsolutePath(), true);</span>
<span class="nc" id="L86">            out.write(outputString.toString());</span>
<span class="nc" id="L87">            out.close();</span>
<span class="nc" id="L88">        }</span>
<span class="nc" id="L89">    }</span>

    /**
     * @return The delimiter used when writing to a log file. The default
     *      delimiter is &lt;code&gt;'|'&lt;/code&gt;.
     */
    public String getDelimiter() {
<span class="nc" id="L96">        return delimiter;</span>
    }

    /**
     * Sets what delimiter to use in the log file.  Typically this is
     * not called, or called only in an initialization block of a
     * subclass of this class.
     *
     * @param str
     */
    public void setDelimiter(String str) {
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if(null != str) {</span>
<span class="nc" id="L108">            delimiter = str;</span>
        } else {
<span class="nc" id="L110">            throw new IllegalArgumentException(&quot;Delimiter cannot be null&quot;);</span>
        }
<span class="nc" id="L112">    }</span>

    /**
     * Convenience method to get a form parameter from the &lt;code&gt;HttpServletRequest&lt;/code&gt;
     * object.  Right now all this does is convert nulls to empty strings.
     *
     * @param req
     * @param parameterName
     * @return
     */
    protected static String getFormParameter(HttpServletRequest req, String parameterName) {
<span class="nc" id="L123">        String ret = req.getParameter(parameterName);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        return (null != ret ? ret : &quot;&quot;);</span>
    }


    /**
     * @return The name of the file to write the delimited data to.  This file
     *      need not include path information -- it will show up in the /private/logs/
     *      folder.
     */
    public abstract String getLogFilename();

    /**
     * @return A &lt;code&gt;String&lt;/code&gt; representation of the page to forward
     *      to upon a successful form submission.
     */
    public abstract String getSuccessPage();

    /**
     * @param request The &lt;code&gt;HttpServletRequest&lt;/code&gt; to parse the data
     *      from.
     * @return A &lt;code&gt;List&lt;/code&gt; of String data that will be saved.
     */
    public abstract List getData(HttpServletRequest request);
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>