<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailFormServlet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet</a> &gt; <span class="el_source">EmailFormServlet.java</span></div><h1>EmailFormServlet.java</h1><pre class="source lang-java linenums">package org.heal.servlet;

import javax.mail.Message;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.*;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Properties;

/**
 * Servlet that emails form data that it recieves.
 */
<span class="nc" id="L22">public class EmailFormServlet extends HttpServlet</span>
{  
    private Hashtable configurations;
<span class="nc" id="L25">    private String separator = &quot;\n&quot;;</span>

    /**
     * Special key in the Hashtable used to determine whether or not to reload
     * the configuration file.
     */
    private static final String LAST_MODIFIED = &quot;lastModified&quot;;

    public void init(ServletConfig servletconfig) throws ServletException 
    {
<span class="nc" id="L35">        super.init(servletconfig);</span>
<span class="nc" id="L36">        configurations = new Hashtable();</span>
<span class="nc" id="L37">        separator = System.getProperty(&quot;line.separator&quot;);</span>
<span class="nc" id="L38">    }</span>

    /**
     * Gives a full HTML error page for when there's a configuration
     * problem that prevents this servlet from behaving as expected.
     *
     * @param errorMessage A message indicating the specific problem
     *      which caused this error.
     * @return A String containing HTML to display on an error page.
     */
  
    private String errorMessage(String errorMessage) 
    {
<span class="nc" id="L51">        StringBuffer ret = new StringBuffer();</span>
<span class="nc" id="L52">        ret.append(&quot;&lt;html&gt;&quot; + separator);</span>
<span class="nc" id="L53">        ret.append(&quot;  &lt;body&gt;&quot; + separator);</span>
<span class="nc" id="L54">        ret.append(&quot;    &lt;b&gt;Server configuration error&lt;/b&gt;: &lt;em&gt;&quot;);</span>
<span class="nc" id="L55">        ret.append(errorMessage);</span>
<span class="nc" id="L56">        ret.append(&quot;&lt;/em&gt;&quot; + separator);</span>
<span class="nc" id="L57">        ret.append(&quot;    &lt;hr&gt;&quot; + separator);</span>
<span class="nc" id="L58">        ret.append(&quot;Please contact &lt;a href=\&quot;mailto:info@healcentral.org\&quot;&gt;info@healcentral.org&lt;/a&gt; with this error.&quot;</span>
                +separator);
<span class="nc" id="L60">        ret.append(&quot;  &lt;/body&gt;&quot; + separator);</span>
<span class="nc" id="L61">        ret.append(&quot;&lt;/html&gt;&quot; + separator);</span>
<span class="nc" id="L62">        return ret.toString();</span>
    }

    /**
     * Reads a properties file specified by the filename and dumps the
     * keys/values into a &lt;code&gt;Hashtable&lt;/code&gt;.  If the file cannot be
     * found or read then a &lt;code&gt;Hashtable&lt;/code&gt; with only the key/value
     * of &lt;code&gt;{ &quot;lastModified&quot; : &quot;0&quot; }&lt;/code&gt; is returned.
     *
     * @param filename The file name/location of the properties file that
     *      specifies the configuration for this servlet.
     * @return A &lt;code&gt;Hashtable&lt;/code&gt; representing the configuration
     *      options specified in the properties file.
     */
    private Hashtable readConfiguration(String filename) 
    {        
<span class="nc" id="L78">        Hashtable ret = new Hashtable();</span>
<span class="nc" id="L79">        Properties props = new Properties();</span>
        try 
        {
<span class="nc" id="L82">            FileInputStream file = new FileInputStream(filename);</span>
<span class="nc" id="L83">            props.load(file);</span>
<span class="nc" id="L84">            file.close();</span>
<span class="nc" id="L85">        } catch(Exception e) { }</span>

<span class="nc" id="L87">        Enumeration enumeration = props.propertyNames();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        while(enumeration.hasMoreElements())</span>
        {
<span class="nc" id="L90">            String key = (String)enumeration.nextElement();</span>
<span class="nc" id="L91">            ret.put(key, props.getProperty(key));</span>
<span class="nc" id="L92">        }</span>

        try 
        {
<span class="nc" id="L96">            File configFile = new File(filename);</span>
<span class="nc" id="L97">            ret.put(LAST_MODIFIED, String.valueOf(configFile.lastModified()));</span>
        } 
<span class="nc" id="L99">        catch(Exception e) </span>
        {
<span class="nc" id="L101">            ret.put(LAST_MODIFIED, String.valueOf(0L));</span>
<span class="nc" id="L102">        }</span>

<span class="nc" id="L104">        return ret;</span>
    }

    private Hashtable getConfiguration(String filename) 
    {
<span class="nc" id="L109">        Hashtable ret = (Hashtable)configurations.get(filename);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if(null == ret) </span>
        {
<span class="nc" id="L112">            ret = readConfiguration(filename);</span>
<span class="nc" id="L113">            configurations.put(filename, ret);</span>
        } 
        else 
        {
<span class="nc" id="L117">            final String lastModified = (String)ret.get(LAST_MODIFIED);</span>
            File configFile;
            try 
            {
<span class="nc" id="L121">                configFile = new File(filename);</span>

                // If the configuration file exists, and has a different lastModified
                // stamp, then we reload the config file
<span class="nc bnc" id="L125" title="All 2 branches missed.">                if(!lastModified.equals(String.valueOf(configFile.lastModified()))) </span>
                {
<span class="nc" id="L127">                    configurations.remove(filename);</span>
<span class="nc" id="L128">                    ret = readConfiguration(filename);</span>
<span class="nc" id="L129">                    configurations.put(filename, ret);</span>
                }
            } 
<span class="nc" id="L132">            catch(Exception e) { }</span>
        }
<span class="nc" id="L134">        return ret;</span>
    }

    /**
     * Sends an email according to the parameters indicated
     *
     * @param serverConfig A &lt;code&gt;Hashtable&lt;/code&gt; representing the configuration
     *      options specified by the server.
     * @param formVariables A &lt;code&gt;Hashtable&lt;/code&gt; representing the variables
     *      submitted to the servlet.
     * @return &lt;code&gt;true&lt;/code&gt; if an email was sent, otherwise &lt;code&gt;false&lt;/code&gt;.
     */
    private boolean sendEmail(final Hashtable serverConfig, final Hashtable formVariables) 
    {
<span class="nc" id="L148">        String smtpServer = (String)serverConfig.get(&quot;smtpServer&quot;);</span>

<span class="nc" id="L150">        String to = (String)formVariables.get(&quot;to&quot;);</span>
<span class="nc" id="L151">        String from = (String)formVariables.get(&quot;from&quot;);</span>
<span class="nc" id="L152">        String subject = (String)formVariables.get(&quot;subject&quot;);</span>
<span class="nc" id="L153">        String body = (String)formVariables.get(&quot;body&quot;);</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        if(null == to) </span>
        {
<span class="nc" id="L157">            return false; // This field is required</span>
        }
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if(null == from) </span>
        {
<span class="nc" id="L161">            from = &quot;info@healcentral.org&quot;;</span>
        }
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if(null == subject) </span>
        {
<span class="nc" id="L165">            subject = &quot;HEALCENTRAL.ORG mailer&quot;;</span>
        }
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if(null == body) </span>
        {
<span class="nc" id="L169">            body = &quot;&quot;;</span>
        }

<span class="nc" id="L172">        StringBuffer extra = new StringBuffer();</span>
<span class="nc" id="L173">        Enumeration enumeration = formVariables.keys();</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">        while(enumeration.hasMoreElements())</span>
        {
<span class="nc" id="L176">            String formVariableName = (String)enumeration.nextElement();</span>
<span class="nc bnc" id="L177" title="All 4 branches missed.">            if(formVariableName.equals(&quot;to&quot;) || formVariableName.equals(&quot;from&quot;)</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">                || formVariableName.equals(&quot;subject&quot;) || formVariableName.equals(&quot;body&quot;)) </span>
            {
<span class="nc" id="L180">                continue;</span>
            }
<span class="nc" id="L182">            extra.append(formVariableName+ &quot; = &quot; +formVariables.get(formVariableName)+ &quot;\n&quot;);</span>
<span class="nc" id="L183">        }</span>
        try 
        {
<span class="nc" id="L186">            Properties props = System.getProperties();</span>
<span class="nc" id="L187">            props.put(&quot;mail.smtp.host&quot;, smtpServer);</span>

<span class="nc" id="L189">            Session session = Session.getDefaultInstance(props, null);</span>

            // Constructs the email from the form variables
<span class="nc" id="L192">            StringBuffer msg = new StringBuffer();</span>
<span class="nc" id="L193">            msg.append(body);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if(extra.length() &gt; 0) {</span>
<span class="nc" id="L195">                msg.append(&quot;\n&quot;);</span>
<span class="nc" id="L196">                msg.append(&quot;-------\n&quot;);</span>
<span class="nc" id="L197">                msg.append(extra.toString());</span>
            }
<span class="nc" id="L199">            MimeMessage message = new MimeMessage(session);</span>
<span class="nc" id="L200">            message.setFrom(new InternetAddress(from));</span>
<span class="nc" id="L201">            message.addRecipient(Message.RecipientType.TO, new InternetAddress(to));</span>
<span class="nc" id="L202">            message.setSubject(subject);</span>
<span class="nc" id="L203">            message.setText(msg.toString());</span>

<span class="nc" id="L205">            Transport.send(message);</span>
        } 
<span class="nc" id="L207">        catch(Exception e) </span>
        {
<span class="nc" id="L209">            e.printStackTrace();</span>
<span class="nc" id="L210">            return false;</span>
<span class="nc" id="L211">        }</span>
<span class="nc" id="L212">        return true;</span>
    }   

    /**
     * Parses the form veriables passed to this servlet into a
     * &lt;code&gt;Hashtable&lt;/code&gt;.
     *
     * @param req
     * @return A &lt;code&gt;Hashtable&lt;/code&gt; containing all the form variables
     *      passed to the servlet.
     */
    private Hashtable getFormVariables(HttpServletRequest req) 
    {
<span class="nc" id="L225">        Hashtable ret = new Hashtable();</span>

<span class="nc" id="L227">        Enumeration enumeration = req.getParameterNames();</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">        while(enumeration.hasMoreElements())</span>
        {
<span class="nc" id="L230">            String variableName = (String)enumeration.nextElement();</span>
<span class="nc" id="L231">            String variableValue = req.getParameterValues(variableName)[0];</span>
<span class="nc" id="L232">            ret.put(variableName, variableValue);</span>
<span class="nc" id="L233">        }</span>
<span class="nc" id="L234">        return ret;</span>
    }

    public void doGet(HttpServletRequest req, HttpServletResponse res)
        throws ServletException, IOException {
<span class="nc" id="L239">        doPost(req, res);</span>
<span class="nc" id="L240">    }</span>

    public void doPost(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException 
    {
      //  String s = req.getQueryString();
      // using Parameter instead of QueryString
<span class="nc" id="L246">        String s = req.getParameter(&quot;filename&quot;);   </span>
       
<span class="nc bnc" id="L248" title="All 4 branches missed.">        if (null == s || s.length() == 0) </span>
        {
<span class="nc" id="L250">            res.setContentType(&quot;text/html&quot;);</span>
<span class="nc" id="L251">            PrintWriter out = res.getWriter();</span>
<span class="nc" id="L252">            out.print(errorMessage(&quot;Configuration file not specified&quot;));</span>
<span class="nc" id="L253">            out.close();</span>
        }

<span class="nc" id="L256">        Hashtable serverConfig = getConfiguration(s);</span>
<span class="nc" id="L257">        Hashtable formVariables = getFormVariables(req);</span>
<span class="nc" id="L258">        boolean emailSent = sendEmail(serverConfig, formVariables);</span>
<span class="nc" id="L259">        saveXml(serverConfig, formVariables);</span>
        String forward;
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if(false == emailSent) </span>
        {
<span class="nc" id="L263">            forward = (String)serverConfig.get(&quot;forwardFailure&quot;);</span>
        } 
        else 
        {
<span class="nc" id="L267">            forward = (String)serverConfig.get(&quot;forwardSuccess&quot;);</span>
        }

<span class="nc" id="L270">        forward(forward, req, res);</span>
<span class="nc" id="L271">    }</span>

    /**
     * Saves the form data to an xml file specified by the server configuration.
     *
     * @param serverConfig
     * @param formVariables
     * @throws IOException
     */
    private synchronized void saveXml(Hashtable serverConfig, Hashtable formVariables) throws IOException 
    {
<span class="nc" id="L282">        String xmlFilename = (String) serverConfig.get(&quot;xml&quot;);</span>
<span class="nc" id="L283">        String dtd = (String) serverConfig.get(&quot;dtd&quot;);</span>
<span class="nc" id="L284">        boolean fileExists = false;</span>
<span class="nc" id="L285">        File file = new File(xmlFilename);</span>
<span class="nc" id="L286">        System.out.print(&quot;filename&quot;+file);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (file.exists()) </span>
        {
<span class="nc" id="L289">            fileExists = true;</span>
        }
<span class="nc" id="L291">        RandomAccessFile xmlFile = new RandomAccessFile(xmlFilename, &quot;rw&quot;);</span>
<span class="nc" id="L292">        xmlFile.seek(xmlFile.length());</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">        if(!fileExists) </span>
        {
<span class="nc" id="L295">            xmlFile.writeBytes(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot; + separator);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">            if (dtd == null) </span>
            {
<span class="nc" id="L298">                Enumeration enumeration = formVariables.keys();</span>
<span class="nc" id="L299">                xmlFile.writeBytes(&quot;&lt;!DOCTYPE records&quot; + separator);</span>
<span class="nc" id="L300">                xmlFile.writeBytes(&quot;[&quot; + separator);</span>
<span class="nc" id="L301">                xmlFile.writeBytes(&quot;&lt;!ELEMENT records (record)+&gt;&quot; + separator);</span>
<span class="nc" id="L302">                xmlFile.writeBytes(&quot;&lt;!ELEMENT record (&quot;);</span>
<span class="nc" id="L303">                StringBuffer fieldNameList = new StringBuffer();</span>
<span class="nc" id="L304">                StringBuffer elementList = new StringBuffer();</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">                while(enumeration.hasMoreElements())</span>
                {
<span class="nc" id="L307">                    String fieldName = (String)enumeration.nextElement();</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">                    if(fieldNameList.length() &gt; 0) </span>
                    {
<span class="nc" id="L311">                        fieldNameList.append(&quot;,&quot; + fieldName);</span>
                    } 
                    else 
                    {
<span class="nc" id="L315">                        fieldNameList.append(fieldName);</span>
                    }
<span class="nc" id="L317">                    elementList.append(&quot;&lt;!ELEMENT &quot; + fieldName + &quot; (#PCDATA)&gt;&quot; + separator);</span>
<span class="nc" id="L318">                }</span>

<span class="nc" id="L320">                xmlFile.writeBytes(fieldNameList.toString() + &quot;)&gt;&quot; + separator);</span>
<span class="nc" id="L321">                xmlFile.writeBytes(elementList.toString());</span>
<span class="nc" id="L322">                xmlFile.writeBytes(&quot;]&gt;&quot; + separator);</span>
<span class="nc" id="L323">            } </span>
            else 
            {
<span class="nc" id="L326">                xmlFile.writeBytes(&quot;&lt;!DOCTYPE records SYSTEM \&quot;&quot; + dtd + &quot;\&quot;&gt;&quot; + separator);</span>
            }
<span class="nc" id="L328">            xmlFile.writeBytes(&quot;&lt;records&gt;&quot; + separator);</span>
        } 
        else 
        {
<span class="nc" id="L332">            xmlFile.seek(xmlFile.length() - (long) &quot;records&quot;.length() - (long) separator.length() - 3L);</span>
        }
<span class="nc" id="L334">        xmlFile.writeBytes(&quot;&lt;record&gt;&quot; + separator);</span>
<span class="nc" id="L335">        Enumeration enumeration = formVariables.keys();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        while(enumeration.hasMoreElements())</span>
        {
<span class="nc" id="L338">            String fieldName = (String)enumeration.nextElement();</span>
<span class="nc" id="L339">            String fieldValue = (String)formVariables.get(fieldName);</span>
<span class="nc" id="L340">            xmlFile.writeBytes(&quot;&lt;&quot; +fieldName+ &quot;&gt;&quot; +fieldValue+ &quot;&lt;/&quot; +fieldName+ &quot;&gt;&quot; +separator);</span>
<span class="nc" id="L341">        }</span>
<span class="nc" id="L342">        xmlFile.writeBytes(&quot;&lt;/record&gt;&quot; + separator);</span>
<span class="nc" id="L343">        xmlFile.writeBytes(&quot;&lt;/records&gt;&quot; + separator);</span>
<span class="nc" id="L344">        xmlFile.close();</span>
<span class="nc" id="L345">    }</span>
    /**
     * forwards a request to the given relative url.
     */
    private void forward(String url,HttpServletRequest request,HttpServletResponse response)
            throws IOException, ServletException 
    {
<span class="nc" id="L352">        RequestDispatcher rd = request.getRequestDispatcher(url);</span>
<span class="nc" id="L353">        rd.forward(request, response);</span>
<span class="nc" id="L354">    }</span>
  
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>