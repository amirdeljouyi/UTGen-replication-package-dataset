<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WSSearchResultsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet</a> &gt; <span class="el_source">WSSearchResultsAction.java</span></div><h1>WSSearchResultsAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet;


import org.heal.module.search.SearchResultBean;
import org.heal.module.search.ShortMetadataResultBean;
import org.heal.util.ParameterMap;
import org.heal.util.ResultsPager;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;


/**
 * An {@link Action} that handles the results of MERLOT's SOAP based search services.
 */
 
<span class="nc" id="L20">public class WSSearchResultsAction implements Action {</span>
    
    /**
     *
     * @param servlet
     * @param request
     * @param response
     * @throws IOException
     * @throws ServletException
     */
    
    public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
        throws IOException, ServletException {
        
        SearchResultBean searchResults;
<span class="nc" id="L35">        searchResults = (SearchResultBean) request.getSession().getAttribute(&quot;searchResults&quot;); </span>
<span class="nc" id="L36">		String queryString = request.getQueryString();</span>
<span class="nc bnc" id="L37" title="All 2 branches missed.">        if (queryString == null) {</span>
<span class="nc" id="L38">            queryString = &quot;&quot;;</span>
        }

		// If there are no search results, redirect to the appropriate search action.
		// This is here so that, for example, if a user bookmarked a search results page
		// rather than arriving here through a search, the expected page would be generated
<span class="nc bnc" id="L44" title="All 2 branches missed.">		if (searchResults == null) {</span>
<span class="nc" id="L45">            String searchURL = &quot;../search/fedsearch.jsp&quot;;</span>
<span class="nc" id="L46">            response.sendRedirect(searchURL);</span>
<span class="nc" id="L47">            return;</span>
        }

		// page specifies the page we are looking at, defaultly page 1
<span class="nc" id="L51">        int displayPage = getParameterAsInteger(request, &quot;page&quot;, 1);</span>
		// display specifies how many items are being displayed per page, defaultly 10
<span class="nc" id="L53">        int displayIncrement = getParameterAsInteger(request, &quot;display&quot;, 10);</span>


		//**** BEGIN code to calculate displayStart and displayStop
<span class="nc" id="L57">        int displayStart = (displayPage - 1) * displayIncrement;</span>
<span class="nc" id="L58">        int displayStop = 0;</span>
<span class="nc" id="L59">        ShortMetadataResultBean[] allMetadata = null;</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (searchResults != null) {</span>
<span class="nc" id="L61">            allMetadata = searchResults.getShortRecords();</span>
        }
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (allMetadata != null) {</span>
<span class="nc" id="L64">            displayStop = displayStart + displayIncrement;</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (displayStop &gt; allMetadata.length) {</span>
<span class="nc" id="L66">                displayStop = allMetadata.length;</span>
            }
        }
        //**** END code to calculate displayStart and displayStop
<span class="nc" id="L70">        request.setAttribute(&quot;displayStart&quot;, &quot;&quot; + displayStart);</span>
<span class="nc" id="L71">        request.setAttribute(&quot;displayStop&quot;, &quot;&quot; + displayStop);</span>
		
        {
<span class="nc" id="L74">        ParameterMap parameters = new ParameterMap(request.getParameterMap());</span>
		// If they're changing the display size, we must reset the page
<span class="nc" id="L76">		parameters.remove(&quot;page&quot;);</span>

		// Disregarding what &quot;display&quot; value may be in the current parameters
		// map, we put in &quot;5&quot; and construct a new query string to represent
		// the original query string with a &quot;display&quot; of &quot;5&quot;
<span class="nc" id="L81">        parameters.put(&quot;display&quot;, &quot;5&quot;);</span>
<span class="nc" id="L82">        request.setAttribute(&quot;displayString5&quot;, &quot;wsSearchResults?&quot;+ parameters.toString());</span>

        // Disregarding what &quot;display&quot; value may be in the current parameters
		// map, we put in &quot;10&quot; and construct a new query string to represent
        // the original query string with a &quot;display&quot; of &quot;10&quot;
<span class="nc" id="L87">        parameters.put(&quot;display&quot;, &quot;10&quot;);</span>
<span class="nc" id="L88">        request.setAttribute(&quot;displayString10&quot;, &quot;wsSearchResults?&quot;+ parameters.toString());</span>

        // Disregarding what &quot;display&quot; value may be in the current parameters
        // map, we put in &quot;25&quot; and construct a new query string to represent
        // the original query string with a &quot;display&quot; of &quot;25&quot;
<span class="nc" id="L93">        parameters.put(&quot;display&quot;, &quot;25&quot;);</span>
<span class="nc" id="L94">        request.setAttribute(&quot;displayString25&quot;, &quot;wsSearchResults?&quot;+ parameters.toString());</span>

        // Disregarding what &quot;display&quot; value may be in the current parameters
        // map, we put in &quot;25&quot; and construct a new query string to represent
        // the original query string with a &quot;display&quot; of &quot;25&quot;
<span class="nc" id="L99">        parameters.put(&quot;display&quot;, &quot;50&quot;);</span>
<span class="nc" id="L100">        request.setAttribute(&quot;displayString50&quot;, &quot;wsSearchResults?&quot;+ parameters.toString());</span>

        // The &quot;searchURL&quot; is the original URL with only the search-specific
        // parameters in the query string with the addition of the &quot;display&quot; parameter.
        // This is used in creating the links to different pages of search results.
<span class="nc" id="L105">        parameters = new ParameterMap(request.getParameterMap());</span>
<span class="nc" id="L106">        parameters.remove(&quot;page&quot;);</span>
<span class="nc" id="L107">        request.setAttribute(&quot;searchURL&quot;, &quot;wsSearchResults?&quot; +parameters.toString());</span>
        }
				
<span class="nc" id="L110">        request.setAttribute(&quot;origURL&quot;, &quot;wsSearchResults?&quot; + queryString);</span>
<span class="nc" id="L111">        String pagenb = request.getParameter(&quot;page&quot;);</span>
        
<span class="nc" id="L113">        ParameterMap parameterv = new ParameterMap(request.getParameterMap());</span>
        // If they're changing the display format, we must reset the page
<span class="nc" id="L115">        parameterv.remove(&quot;page&quot;);</span>
        // Disregarding what &quot;display&quot; format may be in the current parameters
        // map, we put in &quot;1&quot; and construct a new query string to represent
        // the original query string with a &quot;viewtype&quot; of &quot;1&quot;
<span class="nc" id="L119">        parameterv.put(&quot;viewtype&quot;, &quot;1&quot;);</span>
<span class="nc" id="L120">        parameterv.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L121">        request.setAttribute(&quot;view1&quot;, &quot;wsSearchResults?&quot;+ parameterv.toString());</span>
        // Disregarding what &quot;display&quot; format may be in the current parameters
        // map, we put in &quot;2&quot; and construct a new query string to represent
        // the original query string with a &quot;viewtype&quot; of &quot;2&quot;
<span class="nc" id="L125">        parameterv.put(&quot;viewtype&quot;, &quot;2&quot;);</span>
<span class="nc" id="L126">        parameterv.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L127">        request.setAttribute(&quot;view2&quot;, &quot;wsSearchResults?&quot;+ parameterv.toString());</span>
        // Disregarding what &quot;display&quot; value may be in the current parameters
        // map, we put in &quot;3&quot; and construct a new query string to represent
        // the original query string with a &quot;viewtype&quot; of &quot;3&quot;
<span class="nc" id="L131">        parameterv.put(&quot;viewtype&quot;, &quot;3&quot;);</span>
<span class="nc" id="L132">        parameterv.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L133">        request.setAttribute(&quot;view3&quot;, &quot;wsSearchResults?&quot;+ parameterv.toString());</span>
        // The &quot;searchURL&quot; is the original URL with only the search-specific
        // parameters in the query string with the addition of the &quot;display&quot; parameter.
        // This is used in creating the links to different pages of search results.
<span class="nc" id="L137">        parameterv = new ParameterMap(request.getParameterMap());</span>
<span class="nc" id="L138">        parameterv.remove(&quot;page&quot;);</span>
<span class="nc" id="L139">        request.setAttribute(&quot;searchURL&quot;, &quot;wsSearchResults?&quot; +parameterv.toString());				</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (allMetadata != null) {</span>
<span class="nc" id="L141">            ResultsPager pager = new org.heal.util.ResultsPager(allMetadata.length, displayIncrement, displayPage);</span>
<span class="nc" id="L142">            request.setAttribute(&quot;pager&quot;, pager);</span>
        }
<span class="nc" id="L144">		String keywords = new String();</span>
<span class="nc" id="L145">		keywords = request.getParameter(&quot;keywords&quot;);</span>

        // If the original query string is missing a parameter we add
        // the parameter's default value before passing on the query
        String queryStringWithDefaults;
        {
<span class="nc" id="L151">        ParameterMap parameters = new ParameterMap(request.getParameterMap());</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if(!parameters.containsKey(&quot;display&quot;)) {</span>
            // The default &quot;display&quot; is &quot;10&quot;
<span class="nc" id="L154">            parameters.put(&quot;display&quot;, &quot;10&quot;);</span>
        }
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if(!parameters.containsKey(&quot;page&quot;)) {</span>
            // The default &quot;page&quot; is &quot;1&quot;
<span class="nc" id="L158">            parameters.put(&quot;page&quot;, &quot;1&quot;);</span>
        }
<span class="nc" id="L160">        queryStringWithDefaults = parameters.toString();</span>
        }
    
<span class="nc" id="L163">        String forwardURL = &quot;/search/WSsearchresults.jsp?&quot; + queryStringWithDefaults;</span>
        RequestDispatcher rd;
<span class="nc" id="L165">        rd = request.getRequestDispatcher(forwardURL);</span>
<span class="nc" id="L166">        rd.forward(request, response);</span>
<span class="nc" id="L167">        return;</span>
    }

    private int getParameterAsInteger(final HttpServletRequest request, final String paramName, final int defaultValue) {
<span class="nc" id="L171">        int ret = defaultValue;</span>
<span class="nc" id="L172">        String parameter = request.getParameter(paramName);</span>
<span class="nc bnc" id="L173" title="All 4 branches missed.">        if (parameter != null &amp;&amp; parameter.length() != 0) {</span>
            try {
<span class="nc" id="L175">                ret = Integer.parseInt(parameter);</span>
                } 
<span class="nc" id="L177">            catch(NumberFormatException e) { } // does nothing, so the defaultValue will be returned</span>
        }
<span class="nc" id="L179">        return ret; </span>
    }

    public boolean actionRequiresLogin() {
<span class="nc" id="L183">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>