<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthenticateAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet</a> &gt; <span class="el_source">AuthenticateAction.java</span></div><h1>AuthenticateAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet;

import java.util.ArrayList;
import java.util.Vector;
import org.heal.module.user.ProfessionalRoleBean;
import org.heal.module.user.UserBean;
import org.heal.module.user.UserRegistryBean;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;
import java.net.URLEncoder;

<span class="nc" id="L17">public class AuthenticateAction implements Action {</span>
	private final static String ENCODING = &quot;UTF-8&quot;;

	public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
        throws IOException, ServletException {
        
<span class="nc" id="L23">        request.getSession().removeAttribute(&quot;validUser&quot;);</span>
<span class="nc" id="L24">		String userName = request.getParameter(&quot;userName&quot;);</span>
<span class="nc" id="L25">		String password = request.getParameter(&quot;password&quot;);</span>
<span class="nc" id="L26">		String origURL = request.getParameter(&quot;origURL&quot;);</span>
<span class="nc" id="L27">		boolean usernameIsEmail = false;</span>
<span class="nc bnc" id="L28" title="All 4 branches missed.">		if (userName!=null &amp;&amp; userName.indexOf('@')&gt;0)</span>
<span class="nc" id="L29">			usernameIsEmail = true;</span>

<span class="nc bnc" id="L31" title="All 4 branches missed.">		if(userName.length() == 0 || password.length() == 0) {</span>
<span class="nc" id="L32">            String query = &quot;../user/login.jsp?errorMsg=&quot; </span>
<span class="nc" id="L33">                + URLEncoder.encode(&quot;You must enter a Username and Password.&quot;, ENCODING);</span>

<span class="nc bnc" id="L35" title="All 4 branches missed.">			if(origURL != null &amp;&amp; origURL.length() &gt; 0) {</span>
<span class="nc" id="L36">				query = query + &quot;&amp;origURL=&quot; + URLEncoder.encode(origURL, ENCODING);</span>
			}

<span class="nc" id="L39">			response.sendRedirect(query);</span>
<span class="nc" id="L40">			return;</span>
		}

<span class="nc" id="L43">		UserRegistryBean userRegistry = (UserRegistryBean)servlet.getServletContext().getAttribute(&quot;userRegistry&quot;);</span>
		UserBean user;
<span class="nc" id="L45">		String query=&quot;&quot;;</span>
		try {
<span class="nc bnc" id="L47" title="All 2 branches missed.">			if(null == (user = userRegistry.verifyLogin(userName, password, usernameIsEmail))) {</span>
<span class="nc" id="L48">				query = &quot;../user/login.jsp?errorMsg=&quot;</span>
<span class="nc" id="L49">					  + URLEncoder.encode(&quot;The Username and Password you entered is not valid.&quot;, ENCODING);</span>

<span class="nc bnc" id="L51" title="All 4 branches missed.">				if(origURL != null &amp;&amp; origURL.length() &gt; 0) {</span>
<span class="nc" id="L52">					query = query + &quot;&amp;origURL=&quot; + URLEncoder.encode(origURL, ENCODING);</span>
				}

<span class="nc" id="L55">				response.sendRedirect(query);</span>
<span class="nc" id="L56">				return;</span>
			} else {
<span class="nc" id="L58">				request.getSession().setAttribute(&quot;validUser&quot;, user);</span>
<span class="nc" id="L59">				boolean modifiedLogin = user.isLoginModified();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">				if (!modifiedLogin){</span>
<span class="nc" id="L61">					query = &quot;../healapp/showRegistrationInfo?type=modify&quot;;</span>
<span class="nc bnc" id="L62" title="All 4 branches missed.">					if (origURL !=null &amp;&amp; origURL.length()&gt;0)</span>
<span class="nc" id="L63">						query = query + &quot;&amp;origURL=&quot; + URLEncoder.encode(origURL, ENCODING);</span>
<span class="nc" id="L64">					response.sendRedirect(query);</span>
<span class="nc" id="L65">					return;					</span>
				}
<span class="nc bnc" id="L67" title="All 2 branches missed.">				if(!usernameIsEmail) {</span>
<span class="nc" id="L68">                    request.getSession().invalidate();</span>
<span class="nc" id="L69">					query = &quot;../user/login.jsp?errorMsg=&quot;</span>
<span class="nc" id="L70">					  + URLEncoder.encode(&quot;The username name you entered is invalid. &lt;br&gt; Your username is now your email address.&quot;)+ &quot;&amp;origURL=&quot; + URLEncoder.encode(origURL, ENCODING);</span>
<span class="nc" id="L71">                    response.sendRedirect(query);</span>
<span class="nc" id="L72">                    return;								</span>
				}

<span class="nc" id="L75">				boolean emailValidated = user.isEmailValidated();						</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">				if(!emailValidated) {</span>
<span class="nc" id="L77">                    request.getSession().invalidate();</span>
<span class="nc" id="L78">					query = &quot;../user/login.jsp?errorMsg=&quot;</span>
<span class="nc" id="L79">					  + URLEncoder.encode(&quot;The email address you entered has not been validated. &lt;br&gt; Please click on the link sent to your email inbox.&quot;)+ &quot;&amp;origURL=&quot; + URLEncoder.encode(origURL, ENCODING);</span>
<span class="nc" id="L80">                    response.sendRedirect(query);</span>
<span class="nc" id="L81">                    return;								</span>
				}						

				/*
				  Redirect to the main page or to the original URL, if
				  invoked as a result of a access attempt to a protected
				  page.
				*/
<span class="nc bnc" id="L89" title="All 4 branches missed.">				if(origURL != null &amp;&amp; origURL.length() &gt; 0) {</span>
<span class="nc" id="L90">					response.sendRedirect(origURL);</span>
				} else {
<span class="nc" id="L92">					response.sendRedirect(&quot;../index.jsp&quot;);</span>
				}
            }  
<span class="nc" id="L95">		} catch(SQLException ex) {</span>
<span class="nc" id="L96">			throw new ServletException(ex);</span>
<span class="nc" id="L97">		}</span>
<span class="nc" id="L98">	}</span>

	public boolean actionRequiresLogin() {
<span class="nc" id="L101">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>