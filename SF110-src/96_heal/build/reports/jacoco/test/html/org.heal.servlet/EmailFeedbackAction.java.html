<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailFeedbackAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet</a> &gt; <span class="el_source">EmailFeedbackAction.java</span></div><h1>EmailFeedbackAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet;

import javax.mail.Message;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeMessage;
import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.IOException;
import java.io.RandomAccessFile;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;

/**
 * An {@link Action} which emails form data
 */
public class EmailFeedbackAction implements Action {
<span class="nc" id="L24">	public static final String DEFAULT_FROM = new String(&quot;info@healcentral.org&quot;);</span>
<span class="nc" id="L25">	public static final String DEFAULT_SUBJECT = new String(&quot;HEALCENTRAL.ORG mailer&quot;);</span>
<span class="nc" id="L26">	public static final String DEFAULT_BODY = new String();</span>
<span class="nc" id="L27">	public static final String LINE_SEPARATOR = System.getProperty(&quot;line.separator&quot;);</span>

	private final String smtpServer;
	private final String xmlFilename;

<span class="nc" id="L32">	public EmailFeedbackAction(String smtpServer, String xmlFilename) {</span>
<span class="nc" id="L33">		this.smtpServer = smtpServer;</span>
<span class="nc" id="L34">		this.xmlFilename = xmlFilename;</span>
<span class="nc" id="L35">	}</span>

	public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
		  throws IOException, ServletException {
<span class="nc" id="L39">		saveXml(request.getParameterMap());</span>
<span class="nc" id="L40">        sendEmail(request.getParameterMap());</span>

<span class="nc" id="L42">		RequestDispatcher rd = request.getRequestDispatcher(&quot;/feedback/mail_logged_response.html&quot;);</span>
<span class="nc" id="L43">		rd.forward(request, response);</span>
<span class="nc" id="L44">	}</span>

	public boolean actionRequiresLogin() {
<span class="nc" id="L47">		return false;</span>
	}

	/**
	 * Sends an email according to the parameters indicated
	 *
	 * @param parameters A &lt;code&gt;Map&lt;/code&gt; representing the variables
	 * submitted to the servlet.
	 *
	 * @return &lt;code&gt;true&lt;/code&gt; if an email was sent, otherwise &lt;code&gt;false&lt;/code&gt;.
	 */
	private boolean sendEmail(final Map parameters) {
<span class="nc" id="L59">		Map formVariables = new HashMap(parameters);</span>
<span class="nc" id="L60">		String to = join((String[])formVariables.get(&quot;to&quot;), LINE_SEPARATOR);</span>
<span class="nc" id="L61">		String from = join((String[])formVariables.get(&quot;from&quot;), LINE_SEPARATOR);</span>
<span class="nc" id="L62">		String subject = join((String[])formVariables.get(&quot;subject&quot;), LINE_SEPARATOR);</span>
<span class="nc" id="L63">		String body = join((String[])formVariables.get(&quot;body&quot;), LINE_SEPARATOR);</span>
<span class="nc" id="L64">		formVariables.remove(&quot;to&quot;);</span>
<span class="nc" id="L65">		formVariables.remove(&quot;from&quot;);</span>
<span class="nc" id="L66">		formVariables.remove(&quot;subject&quot;);</span>
<span class="nc" id="L67">		formVariables.remove(&quot;body&quot;);</span>

<span class="nc bnc" id="L69" title="All 2 branches missed.">		if(null == to) {</span>
<span class="nc" id="L70">			return false; // This field is required</span>
		}
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if(null == from) {</span>
<span class="nc" id="L73">			from = DEFAULT_FROM;</span>
		}
<span class="nc bnc" id="L75" title="All 2 branches missed.">		if(null == subject) {</span>
<span class="nc" id="L76">			subject = DEFAULT_SUBJECT;</span>
		}
<span class="nc bnc" id="L78" title="All 2 branches missed.">		if(null == body) {</span>
<span class="nc" id="L79">			body = DEFAULT_BODY;</span>
		}

<span class="nc" id="L82">		StringBuffer extra = new StringBuffer();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">		for(Object temp : formVariables.entrySet()) {</span>
<span class="nc" id="L84">			Map.Entry entry = (Map.Entry)temp;</span>
<span class="nc" id="L85">			extra.append(entry.getKey()).append(&quot; = &quot;).append(join((String[])entry.getValue(), LINE_SEPARATOR)).append(LINE_SEPARATOR);</span>
<span class="nc" id="L86">		}</span>

		try {
<span class="nc" id="L89">			Properties props = System.getProperties();</span>
<span class="nc" id="L90">			props.put(&quot;mail.smtp.host&quot;, smtpServer);</span>

<span class="nc" id="L92">			Session session = Session.getDefaultInstance(props, null);</span>

			// Constructs the email from the form variables
<span class="nc" id="L95">			StringBuffer msg = new StringBuffer();</span>
<span class="nc" id="L96">			msg.append(body);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">			if(extra.length() &gt; 0) {</span>
<span class="nc" id="L98">				msg.append(&quot;\n&quot;);</span>
<span class="nc" id="L99">				msg.append(&quot;-------\n&quot;);</span>
<span class="nc" id="L100">				msg.append(extra.toString());</span>
			}
<span class="nc" id="L102">			MimeMessage message = new MimeMessage(session);</span>
<span class="nc" id="L103">			message.setFrom(new InternetAddress(from));</span>
<span class="nc" id="L104">			message.addRecipient(Message.RecipientType.TO, new InternetAddress(to));</span>
<span class="nc" id="L105">			message.setSubject(subject);</span>
<span class="nc" id="L106">			message.setText(msg.toString());</span>

<span class="nc" id="L108">			Transport.send(message);</span>
<span class="nc" id="L109">		} catch(Exception e) {</span>
<span class="nc" id="L110">			e.printStackTrace();</span>
<span class="nc" id="L111">			return false;</span>
<span class="nc" id="L112">		}</span>
<span class="nc" id="L113">		return true;</span>
	}

	/**
	 * Saves the form data to an xml file.
	 *
	 * @param formVariables
	 *
	 * @throws IOException
	 */
	private synchronized void saveXml(Map formVariables) throws IOException {
<span class="nc" id="L124">		boolean fileExists = false;</span>
<span class="nc" id="L125">		File file = new File(xmlFilename);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">		if(file.exists()) {</span>
<span class="nc" id="L127">			fileExists = true;</span>
		}
<span class="nc" id="L129">		RandomAccessFile xmlFile = new RandomAccessFile(xmlFilename, &quot;rw&quot;);</span>
<span class="nc" id="L130">		xmlFile.seek(xmlFile.length());</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">		if(!fileExists) {</span>
<span class="nc" id="L132">			xmlFile.writeBytes(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L133">			xmlFile.writeBytes(&quot;&lt;!DOCTYPE records&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L134">			xmlFile.writeBytes(&quot;[&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L135">			xmlFile.writeBytes(&quot;&lt;!ELEMENT records (record)+&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L136">			xmlFile.writeBytes(&quot;&lt;!ELEMENT record (&quot;);</span>
<span class="nc" id="L137">			StringBuffer fieldNameList = new StringBuffer();</span>
<span class="nc" id="L138">			StringBuffer elementList = new StringBuffer();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">			for(Object key : formVariables.keySet()) {</span>
<span class="nc" id="L140">				String fieldName = (String)key;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">				if(fieldNameList.length() &gt; 0) {</span>
<span class="nc" id="L142">					fieldNameList.append(&quot;,&quot; + fieldName);</span>
				} else {
<span class="nc" id="L144">					fieldNameList.append(fieldName);</span>
				}
<span class="nc" id="L146">				elementList.append(&quot;&lt;!ELEMENT &quot; + fieldName + &quot; (#PCDATA)&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L147">			}</span>

<span class="nc" id="L149">			xmlFile.writeBytes(fieldNameList.toString() + &quot;)&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L150">			xmlFile.writeBytes(elementList.toString());</span>
<span class="nc" id="L151">			xmlFile.writeBytes(&quot;]&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L152">			xmlFile.writeBytes(&quot;&lt;records&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L153">		} else {</span>
<span class="nc" id="L154">			xmlFile.seek(xmlFile.length() - (long)&quot;records&quot;.length() - (long)LINE_SEPARATOR.length() - 3L);</span>
		}
<span class="nc" id="L156">		xmlFile.writeBytes(&quot;&lt;record&gt;&quot; + LINE_SEPARATOR);</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">		for(Object entry : formVariables.entrySet()) {</span>
<span class="nc" id="L159">			final String fieldName = (String)((Map.Entry)entry).getKey();</span>
<span class="nc" id="L160">			final String fieldValue = join((String[])((Map.Entry)entry).getValue(), LINE_SEPARATOR);</span>
<span class="nc" id="L161">			xmlFile.writeBytes(&quot;&lt;&quot; + fieldName + &quot;&gt;&quot; + fieldValue + &quot;&lt;/&quot; + fieldName + &quot;&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L162">		}</span>
<span class="nc" id="L163">		xmlFile.writeBytes(&quot;&lt;/record&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L164">		xmlFile.writeBytes(&quot;&lt;/records&gt;&quot; + LINE_SEPARATOR);</span>
<span class="nc" id="L165">		xmlFile.close();</span>
<span class="nc" id="L166">	}</span>

	private static final String join(String[] arr, String delim) {
<span class="nc bnc" id="L169" title="All 2 branches missed.">		if(null == arr) { return null; }</span>
<span class="nc" id="L170">		StringBuffer buffer = new StringBuffer();</span>
<span class="nc" id="L171">		final int lastElement = arr.length-1;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">		for(int i = 0; i &lt; arr.length; ++i) {</span>
<span class="nc" id="L173">			buffer.append(arr[i]);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">			if(i &lt; lastElement) {</span>
<span class="nc" id="L175">				buffer.append(delim);</span>
			}
		}
<span class="nc" id="L178">		return buffer.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>