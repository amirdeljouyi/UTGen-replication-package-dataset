<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BrowseAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">96_heal</a> &gt; <a href="index.source.html" class="el_package">org.heal.servlet</a> &gt; <span class="el_source">BrowseAction.java</span></div><h1>BrowseAction.java</h1><pre class="source lang-java linenums">package org.heal.servlet;

import org.heal.module.browse.BrowseDAO;
import org.heal.module.browse.BrowseResultsBean;
import org.heal.module.metadata.MetadataDAO;
import org.heal.module.metadata.ShortMetadataBean;
import org.heal.module.metadata.ThumbnailBean;
import org.heal.util.FileLocator;
import org.heal.util.InterfaceUtilitiesBean;
import org.heal.util.ParameterMap;
import org.heal.util.ResultsPager;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;
import java.util.Vector;

/**
 * This {@link Action} handles the browse request
 *
 * @author Jason Varghese
 * @modify Brad Schaefer
 */

<span class="nc" id="L29">public class BrowseAction implements Action {</span>
    public void perform(HttpServlet servlet, HttpServletRequest request, HttpServletResponse response)
        throws IOException, ServletException {
        try {
<span class="nc" id="L33">            BrowseDAO browseServices = (BrowseDAO)servlet.getServletContext().getAttribute(&quot;browseDAO&quot;);</span>
<span class="nc" id="L34">            String pid = request.getParameter(&quot;pid&quot;);</span>
            Vector categories;
            Vector trail;
            Vector results;
            BrowseResultsBean browseResultsBean;
<span class="nc" id="L39">            browseResultsBean = (BrowseResultsBean)request.getSession().getAttribute(&quot;results&quot;);</span>
<span class="nc" id="L40">            MetadataDAO metadataServices = (MetadataDAO)servlet.getServletContext().getAttribute(&quot;MetadataDAO&quot;);</span>
<span class="nc bnc" id="L41" title="All 4 branches missed.">            if(pid == null || pid.length() &lt; 1) {</span>
<span class="nc" id="L42">                pid = &quot;0&quot;;</span>
            }
<span class="nc bnc" id="L44" title="All 4 branches missed.">            if((browseResultsBean != null) &amp;&amp; (browseResultsBean.getId().equals(pid))) {</span>
<span class="nc" id="L45">                trail = browseResultsBean.getTrail();</span>
<span class="nc" id="L46">                categories = browseResultsBean.getSubCategories();</span>
<span class="nc" id="L47">                results = browseResultsBean.getResultsId();</span>
            } else {
<span class="nc" id="L49">                trail = browseServices.getTrail(pid);</span>
<span class="nc" id="L50">                categories = browseServices.getChildrenCategories(pid);</span>
<span class="nc" id="L51">                results = browseServices.doBrowse(pid);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">                if(trail == null) {</span>
<span class="nc" id="L53">                    trail = new Vector();</span>
                }
<span class="nc" id="L55">                request.getSession().removeAttribute(&quot;results&quot;);</span>
<span class="nc" id="L56">                browseResultsBean = new BrowseResultsBean();</span>
<span class="nc" id="L57">                browseResultsBean.setTrail(trail);</span>
<span class="nc" id="L58">                browseResultsBean.setId(pid);</span>
<span class="nc" id="L59">                browseResultsBean.setSubCategories(categories);</span>
<span class="nc" id="L60">                browseResultsBean.setResultsId(results);</span>
<span class="nc" id="L61">                request.getSession().setAttribute(&quot;results&quot;, browseResultsBean);</span>
            }
            
<span class="nc" id="L64">            final int currentSection = getParameterAsInteger(request, &quot;currentSection&quot;, 0);</span>
            // display specifies how many items are being displayed per page, defaultly 25
<span class="nc" id="L66">            final int displayIncrement = getParameterAsInteger(request, &quot;display&quot;, 25);</span>
<span class="nc" id="L67">            final int previousSection = currentSection - 1;</span>
<span class="nc" id="L68">            int nextSection = currentSection + 1;</span>
<span class="nc" id="L69">            final int lowerbound = currentSection * displayIncrement;</span>
<span class="nc" id="L70">            int upperbound = nextSection * displayIncrement;</span>

<span class="nc bnc" id="L72" title="All 2 branches missed.">            if(upperbound &gt; results.size()) {</span>
<span class="nc" id="L73">                upperbound = results.size();</span>
<span class="nc" id="L74">                nextSection = -1;</span>
            }

<span class="nc" id="L77">            Vector smbs = null;</span>
<span class="nc bnc" id="L78" title="All 4 branches missed.">            if((results != null) &amp;&amp; (results.size() &gt; 0)) {</span>
<span class="nc" id="L79">                smbs = new Vector();</span>
<span class="nc" id="L80">                InterfaceUtilitiesBean interfaceUtilities = (InterfaceUtilitiesBean)servlet.getServletContext().getAttribute(&quot;interfaceUtilities&quot;);</span>
<span class="nc" id="L81">                FileLocator healFileLocator = (FileLocator)servlet.getServletContext().getAttribute(&quot;healFileLocator&quot;);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                for(int b = lowerbound; b &lt; upperbound; b++) {</span>
<span class="nc" id="L83">                    final String id = (String)results.get(b);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                    if(id != null) {</span>
<span class="nc" id="L85">                        final ShortMetadataBean smb = metadataServices.getShortMetadata(id);</span>
<span class="nc" id="L86">                        String temp = smb.getDescription();</span>
<span class="nc bnc" id="L87" title="All 4 branches missed.">                        if(temp != null &amp;&amp; temp.length() &gt; 0) {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">                            final int limit = (100 &gt; temp.length() ? temp.length() : 100);</span>
<span class="nc" id="L89">                            smb.setDescription(temp.substring(0, limit));</span>
                        }
<span class="nc" id="L91">                        ThumbnailBean tbean = interfaceUtilities.getThumbnail(smb.getThumbnail(), smb.getFormat(), &quot;../&quot;);</span>
<span class="nc" id="L92">                        smb.setThumbnail(tbean);</span>
<span class="nc" id="L93">                        smb.setLocation(healFileLocator.getContentURL(smb.getLocation()));</span>
<span class="nc" id="L94">                        smbs.add(smb);</span>
                    }
                }
            }
            // page specifies the page we are looking at, defaultly page 1
<span class="nc" id="L99">            final int displayPage = getParameterAsInteger(request, &quot;page&quot;, 1);</span>
<span class="nc" id="L100">            final String pagenb = String.valueOf(displayPage);</span>
<span class="nc" id="L101">            ResultsPager pager = new ResultsPager(results.size(), displayIncrement, displayPage);</span>
<span class="nc" id="L102">            request.setAttribute(&quot;pager&quot;, pager);</span>

            //**** BEGIN code to calculate displayStart and displayStop
<span class="nc" id="L105">            int displayStart = (displayPage - 1) * displayIncrement;</span>
<span class="nc" id="L106">            int displayStop = 0;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if(results != null) {</span>
<span class="nc" id="L108">                displayStop = displayStart + displayIncrement;</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                if(displayStop &gt; results.size()) {</span>
<span class="nc" id="L110">                    displayStop = results.size();</span>
                }
            }
            //**** END code to calculate displayStart and displayStop
<span class="nc" id="L114">            request.setAttribute(&quot;displayStart&quot;, String.valueOf(displayStart));</span>
<span class="nc" id="L115">            request.setAttribute(&quot;displayStop&quot;, String.valueOf(displayStop));</span>

            {
<span class="nc" id="L118">                ParameterMap parameters = new ParameterMap(request.getParameterMap());</span>
                // If they're changing the display size, we must reset the page
<span class="nc" id="L120">                parameters.remove(&quot;page&quot;);</span>

                // Disregarding what &quot;display&quot; value may be in the current parameters
                // map, we put in &quot;25&quot; and construct a new query string to represent
                // the original query string with a &quot;display&quot; of &quot;25&quot;
<span class="nc" id="L125">                parameters.put(&quot;display&quot;, &quot;10&quot;);</span>
<span class="nc" id="L126">                parameters.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L127">                request.setAttribute(&quot;displayString10&quot;, &quot;browse?&quot; + parameters.toString());</span>

                // Disregarding what &quot;display&quot; value may be in the current parameters
                // map, we put in &quot;25&quot; and construct a new query string to represent
                // the original query string with a &quot;display&quot; of &quot;25&quot;
<span class="nc" id="L132">                parameters.put(&quot;display&quot;, &quot;25&quot;);</span>
<span class="nc" id="L133">                parameters.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L134">                request.setAttribute(&quot;displayString25&quot;, &quot;browse?&quot; + parameters.toString());</span>

                // Disregarding what &quot;display&quot; value may be in the current parameters
                // map, we put in &quot;100&quot; and construct a new query string to represent
                // the original query string with a &quot;display&quot; of &quot;100&quot;
<span class="nc" id="L139">                parameters.put(&quot;display&quot;, &quot;50&quot;);</span>
<span class="nc" id="L140">                parameters.put(&quot;page&quot;, pagenb);</span>
<span class="nc" id="L141">                request.setAttribute(&quot;displayString50&quot;, &quot;browse?&quot; + parameters.toString());</span>
            }
<span class="nc" id="L143">            String origURL = &quot;../healapp/browse?&quot; + request.getQueryString();</span>
<span class="nc" id="L144">            request.setAttribute(&quot;origURL&quot;, origURL);</span>
<span class="nc" id="L145">            request.setAttribute(&quot;startNumber&quot;, String.valueOf(lowerbound + 1));</span>
<span class="nc" id="L146">            request.setAttribute(&quot;smbs&quot;, smbs);</span>
<span class="nc" id="L147">            request.setAttribute(&quot;trail&quot;, trail);</span>
<span class="nc" id="L148">            request.setAttribute(&quot;categories&quot;, categories);</span>
<span class="nc" id="L149">            request.setAttribute(&quot;pid&quot;, pid);</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">            if(previousSection &gt;= 0) {</span>
<span class="nc" id="L152">                request.setAttribute(&quot;previousSection&quot;, Integer.toString(previousSection));</span>
            }
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if(currentSection &gt;= 0) {</span>
<span class="nc" id="L155">                request.setAttribute(&quot;currentSection&quot;, Integer.toString(currentSection));</span>
            }
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if(nextSection &gt;= 0) {</span>
<span class="nc" id="L158">                request.setAttribute(&quot;nextSection&quot;, Integer.toString(nextSection));</span>
            }
            RequestDispatcher rd;
<span class="nc" id="L161">            rd = request.getRequestDispatcher(&quot;/browse/browse2.jsp&quot;);</span>
<span class="nc" id="L162">            rd.forward(request, response);</span>
<span class="nc" id="L163">        } catch(SQLException ex) {</span>
<span class="nc" id="L164">        }</span>
<span class="nc" id="L165">    }</span>

    private int getParameterAsInteger(final HttpServletRequest request, final String paramName, final int defaultValue) {
<span class="nc" id="L168">        int ret = defaultValue;</span>
<span class="nc" id="L169">        String parameter = request.getParameter(paramName);</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">        if(parameter != null &amp;&amp; parameter.length() != 0) {</span>
            try {
<span class="nc" id="L172">                ret = Integer.parseInt(parameter);</span>
<span class="nc" id="L173">            } catch(NumberFormatException e) {</span>
<span class="nc" id="L174">            } // does nothing, so the defaultValue will be returned</span>
        }
<span class="nc" id="L176">        return ret;</span>
    }

    public boolean actionRequiresLogin() {
<span class="nc" id="L180">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>