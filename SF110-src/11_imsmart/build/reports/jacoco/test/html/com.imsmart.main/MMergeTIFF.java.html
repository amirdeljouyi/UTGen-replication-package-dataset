<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MMergeTIFF.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">11_imsmart</a> &gt; <a href="index.source.html" class="el_package">com.imsmart.main</a> &gt; <span class="el_source">MMergeTIFF.java</span></div><h1>MMergeTIFF.java</h1><pre class="source lang-java linenums">package com.imsmart.main;

import com.imsmart.misc.MLog;
import com.imsmart.misc.MProperties;
import java.awt.image.RenderedImage;
import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Set;
import java.util.SortedSet;
import java.util.TreeSet;

import com.sun.media.jai.codec.FileSeekableStream;
import com.sun.media.jai.codec.ImageCodec;
import com.sun.media.jai.codec.ImageDecoder;
import com.sun.media.jai.codec.ImageEncoder;
import com.sun.media.jai.codec.TIFFEncodeParam;
import java.util.Date;

public class MMergeTIFF extends Thread {

    private static String TARGET_DIRECTORY;
    private static String TIFF_DIR;
    private static SortedSet filesToMergeSet;
    private static Iterator fileToMergeIterator;
    private static HashMap documentsMap;
<span class="nc" id="L31">    private static MProperties properties = MProperties.getInstance();</span>
<span class="nc" id="L32">    private static MLog logger = MLog.getInstance();</span>

    /**
     * @param args
     */
    public MMergeTIFF(String name) {
<span class="nc" id="L38">        super(name);</span>
<span class="nc" id="L39">        TIFF_DIR = properties.getPropertyValue(MProperties.IMAGE_DIR);</span>
<span class="nc" id="L40">        TARGET_DIRECTORY = properties.getPropertyValue(MProperties.MERGED_DIR);</span>

<span class="nc" id="L42">    }</span>

    public MMergeTIFF() {
<span class="nc" id="L45">        super();</span>
<span class="nc" id="L46">        TIFF_DIR = properties.getPropertyValue(MProperties.IMAGE_DIR);</span>
<span class="nc" id="L47">        TARGET_DIRECTORY = properties.getPropertyValue(MProperties.MERGED_DIR);</span>
<span class="nc" id="L48">    }</span>

    public static void startMerge() {
<span class="nc" id="L51">        MMergeTIFF test = new MMergeTIFF();</span>
<span class="nc" id="L52">        logger.info(&quot;Merging Started: &quot; + new Date());</span>
<span class="nc" id="L53">        File dir = new File(TIFF_DIR);</span>
<span class="nc" id="L54">        String fileNames[] = dir.list();</span>
<span class="nc" id="L55">        MMergeTIFF.setDocuments(fileNames);</span>
        
<span class="nc" id="L57">        Set keys = documentsMap.keySet();</span>

<span class="nc" id="L59">        SortedSet set = new TreeSet(keys);</span>
<span class="nc" id="L60">        MMergeTIFF.setFilesToMerge(set);</span>
<span class="nc" id="L61">        MMergeTIFF.fileToMergeIterator = set.iterator();</span>
<span class="nc" id="L62">        String strThreadCount = properties.getPropertyValue(MProperties.THREAD_COUNT);</span>
<span class="nc" id="L63">        int threadCount = Integer.parseInt(strThreadCount);</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        for (int i = 1; i &lt;= threadCount; i++) {</span>
<span class="nc" id="L65">            MMergeTIFF merge = new MMergeTIFF(&quot;Thread -&quot; + i);</span>
<span class="nc" id="L66">            merge.start();</span>
        }

<span class="nc" id="L69">    }</span>

    private synchronized String getNextFileToMerge() {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (fileToMergeIterator == null) {</span>
<span class="nc" id="L73">            fileToMergeIterator = filesToMergeSet.iterator();</span>
        }

<span class="nc" id="L76">        String fileName = (String) fileToMergeIterator.next();</span>
<span class="nc" id="L77">        return fileName;</span>

    }

    public void run() {
<span class="nc" id="L82">        logger.info(&quot;Starting new thread - &quot; + getName());</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        while (fileToMergeIterator.hasNext()) {</span>
<span class="nc" id="L84">            String fileName = getNextFileToMerge();</span>
<span class="nc" id="L85">            List pageList = (List) documentsMap.get(fileName);</span>

<span class="nc" id="L87">            merge(fileName, pageList);</span>
<span class="nc" id="L88">        }</span>
<span class="nc" id="L89">        logger.info(&quot;End of thread - &quot; + getName());</span>
<span class="nc" id="L90">    }</span>

    public static void setDocuments(String pages[]) {
<span class="nc" id="L93">        HashMap documentMap = new HashMap();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        for (int i = 0; i &lt; pages.length; i++) {</span>
<span class="nc" id="L95">            String pageName = pages[i];</span>
<span class="nc bnc" id="L96" title="All 4 branches missed.">            if (pageName.endsWith(&quot;tif&quot;) || pageName.endsWith(&quot;TIF&quot;)) {</span>
<span class="nc" id="L97">                int index = pageName.indexOf(&quot;.&quot;);</span>

<span class="nc" id="L99">                String multiPageFileName = pageName.substring(0, index);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (!documentMap.containsKey(multiPageFileName)) {</span>
<span class="nc" id="L101">                    List pageList = new ArrayList();</span>
<span class="nc" id="L102">                    pageList.add(pageName);</span>
<span class="nc" id="L103">                    documentMap.put(multiPageFileName, pageList);</span>
<span class="nc" id="L104">                } else {</span>
<span class="nc" id="L105">                    List pageList = (List) documentMap.get(multiPageFileName);</span>
<span class="nc" id="L106">                    pageList.add(pageName);</span>
<span class="nc" id="L107">                    documentMap.put(multiPageFileName, pageList);</span>
                }
            }
        }
        
<span class="nc" id="L112">        documentsMap = documentMap;</span>
        //return documentMap;
<span class="nc" id="L114">    }</span>

    private void merge(String fileName, List pageList) {
<span class="nc" id="L117">        SortedSet sortedList = new TreeSet(pageList);</span>
        try {
<span class="nc" id="L119">            List imageList = new ArrayList();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            for (Iterator iterator = sortedList.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L121">                String name = (String) iterator.next();</span>
                // String name = (String) pageList.get(i);
<span class="nc" id="L123">                File file = new File(TIFF_DIR + &quot;/&quot; + name);</span>

<span class="nc" id="L125">                FileSeekableStream ss = new FileSeekableStream(file);</span>
<span class="nc" id="L126">                ImageDecoder dec = ImageCodec.createImageDecoder(&quot;tiff&quot;, ss,</span>
                        null);
<span class="nc" id="L128">                TIFFEncodeParam param = new TIFFEncodeParam();</span>
<span class="nc" id="L129">                param.setCompression(TIFFEncodeParam.COMPRESSION_GROUP4);</span>
<span class="nc" id="L130">                param.setLittleEndian(false); // Intel</span>
<span class="nc" id="L131">                RenderedImage singlePageTif = dec.decodeAsRenderedImage(0);</span>
<span class="nc" id="L132">                imageList.add(singlePageTif);</span>

<span class="nc" id="L134">            }</span>

<span class="nc" id="L136">            RenderedImage rImage[] = new RenderedImage[imageList.size()];</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">            for (int j = 0; j &lt; imageList.size(); j++) {</span>
<span class="nc" id="L138">                rImage[j] = (RenderedImage) imageList.get(j);</span>
            }
<span class="nc" id="L140">            saveMultiPageTif(rImage, TARGET_DIRECTORY + fileName + &quot;.tif&quot;);</span>

        //logger.info(&quot;Merged &quot; + rImage.length + &quot; pages!!&quot;);
<span class="nc" id="L143">        } catch (Exception ex) {</span>
<span class="nc" id="L144">            ex.printStackTrace();</span>
<span class="nc" id="L145">        }</span>

<span class="nc" id="L147">    }</span>

    public void saveMultiPageTif(RenderedImage[] image, String file)
            throws java.io.IOException {
<span class="nc" id="L151">        String filename = file;</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (!filename.endsWith(&quot;.tif&quot;)) {</span>
<span class="nc" id="L153">            filename = new String(file + &quot;.tif&quot;);</span>
        }
<span class="nc" id="L155">        OutputStream out = new FileOutputStream(filename);</span>
<span class="nc" id="L156">        TIFFEncodeParam param = new TIFFEncodeParam();</span>
        // I tried different compression but on windows tif viewer I was not
        // able to see.
<span class="nc" id="L159">        param.setCompression(TIFFEncodeParam.COMPRESSION_GROUP4);</span>
<span class="nc" id="L160">        ImageEncoder encoder = ImageCodec.createImageEncoder(&quot;TIFF&quot;, out, param);</span>

<span class="nc" id="L162">        List list = new ArrayList();</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">        for (int i = 0; i &lt; image.length; i++) {</span>
<span class="nc" id="L165">            list.add(image[i]);</span>
        }
<span class="nc" id="L167">        RenderedImage firstPage = (RenderedImage) list.get(0);</span>
<span class="nc" id="L168">        list.remove(0);</span>
<span class="nc" id="L169">        param.setExtraImages(list.iterator());</span>
<span class="nc" id="L170">        encoder.encode(firstPage);</span>

<span class="nc" id="L172">        out.close();</span>
<span class="nc" id="L173">    }</span>

    public static void setDocumentsMap(HashMap documents) {
<span class="nc" id="L176">        documentsMap = documents;</span>
<span class="nc" id="L177">    }</span>

    public static void setFilesToMerge(SortedSet set) {
<span class="nc" id="L180">        filesToMergeSet = set;</span>
<span class="nc" id="L181">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>