<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IndexFileAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">64_jtailgui</a> &gt; <a href="index.source.html" class="el_package">fr.pingtimeout.jtail.gui.action</a> &gt; <span class="el_source">IndexFileAction.java</span></div><h1>IndexFileAction.java</h1><pre class="source lang-java linenums">package fr.pingtimeout.jtail.gui.action;

import fr.pingtimeout.jtail.gui.controller.FileIndexerWorker;
import fr.pingtimeout.jtail.gui.message.ExceptionHandler;
import fr.pingtimeout.jtail.gui.message.InformationHandler;
import fr.pingtimeout.jtail.gui.message.MessageHandler;
import fr.pingtimeout.jtail.gui.message.UIMessage;
import fr.pingtimeout.jtail.gui.model.JTailMainModel;
import fr.pingtimeout.jtail.gui.model.JTailModel;
import fr.pingtimeout.jtail.gui.model.OpenFileModel;
import fr.pingtimeout.jtail.gui.view.OpenFileDialog;
import fr.pingtimeout.jtail.io.FileIndexer;
import fr.pingtimeout.jtail.io.LineReader;
import fr.pingtimeout.jtail.io.index.FileIndex;
import fr.pingtimeout.jtail.io.index.RamFileIndex;
import fr.pingtimeout.jtail.io.index.RomFileIndex;
import fr.pingtimeout.jtail.util.JTailLogger;

import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.io.File;
import java.io.FileNotFoundException;
import java.util.Observable;
import java.util.Observer;
import java.util.ResourceBundle;

/**
 * Created by IntelliJ IDEA.
 * User: vadmin
 * Date: Sep 18, 2010
 * Time: 1:49:19 PM
 * To change this template use File | Settings | File Templates.
 */
public class IndexFileAction extends JTailAbstractAction implements Observer {
    /**
     * Buddle.
     */
    private static final ResourceBundle
<span class="nc" id="L40">            bundle = ResourceBundle.getBundle(&quot;fr.pingtimeout.jtail.gui.language&quot;); //NON-NLS</span>

    /**
     * Icône associée à l'action.
     */
<span class="nc" id="L45">    private static final ImageIcon OPEN_ICON = new ImageIcon(OpenFileAction.class.getResource(&quot;add16.png&quot;));</span>

    /**
     * Le modèle de l'application
     */
    private final JTailMainModel jTailMainModel;

    /**
     * Le modèle associé à l'ouverture de fichier.
     */
    private final OpenFileModel openFileModel;


    public IndexFileAction(JTailMainModel jTailMainModel, OpenFileModel openFileModel) {
<span class="nc" id="L59">        super(bundle.getString(&quot;action.open.label&quot;),</span>
<span class="nc" id="L60">                bundle.getString(&quot;action.open.tooltip&quot;),</span>
<span class="nc" id="L61">                bundle.getString(&quot;action.open.mnemonic&quot;),</span>
<span class="nc" id="L62">                bundle.getString(&quot;action.open.accelerator&quot;),</span>
                OPEN_ICON);
<span class="nc" id="L64">        this.jTailMainModel = jTailMainModel;</span>
<span class="nc" id="L65">        this.openFileModel = openFileModel;</span>
<span class="nc" id="L66">    }</span>

    public void actionPerformed(ActionEvent actionEvent) {
<span class="nc" id="L69">        JTailLogger.debug(&quot;File : {}&quot;, openFileModel.getFile()); //NON-NLS</span>
<span class="nc" id="L70">        JTailLogger.debug(&quot;Index type : {}&quot;, openFileModel.getIndexType()); //NON-NLS</span>

        // Hide the dialog
<span class="nc" id="L73">        Component dialog = (Component)actionEvent.getSource();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">        while(!(dialog instanceof JDialog)) {</span>
<span class="nc" id="L75">            dialog = dialog.getParent();</span>
        }
<span class="nc" id="L77">        dialog.setVisible(false);</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">        if(openFileModel.getFile() == null) {</span>
<span class="nc" id="L80">            InformationHandler.handle(true, UIMessage.INFO_NO_FILE_SELECTED);</span>
<span class="nc" id="L81">            return;</span>
        }

<span class="nc" id="L84">        Class&lt;? extends FileIndex&gt; indexerClass = null;</span>
<span class="nc bnc" id="L85" title="All 3 branches missed.">        switch (openFileModel.getIndexType()) {</span>
            case MEMORY_BASED:
<span class="nc" id="L87">                indexerClass = RamFileIndex.class;</span>
<span class="nc" id="L88">                break;</span>
            case FILE_BASED:
<span class="nc" id="L90">                indexerClass = RomFileIndex.class;</span>
                break;
        }

        // Préparer l'indexation du fichier
        final FileIndexer fileIndexer;
        final FileIndexerWorker fileIndexerWorker;

        try {
<span class="nc" id="L99">            fileIndexer = new FileIndexer(openFileModel.getFile(), indexerClass);</span>
<span class="nc" id="L100">            fileIndexer.addObserver(this);</span>
<span class="nc" id="L101">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L102">            ExceptionHandler.handle(e, UIMessage.ERROR_FILE_NOT_FOUND, openFileModel.getFile().getName());</span>
<span class="nc" id="L103">            return;</span>
<span class="nc" id="L104">        }</span>

<span class="nc" id="L106">        fileIndexerWorker = new FileIndexerWorker(fileIndexer);</span>

        // Démarrer l'indexation
<span class="nc" id="L109">        fileIndexerWorker.execute();</span>
<span class="nc" id="L110">    }</span>

    @Override
    public void update(Observable o, Object arg) {
<span class="nc" id="L114">        JTailLogger.debug(&quot;Notification received : {} emitted by {}&quot;, //NON-NLS</span>
                arg, o);

        // Lorsque l'indexation est terminée, créer le JTailModel et l'ajouter dans l'application
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if ((Integer) arg == 100) {</span>
<span class="nc" id="L119">            final FileIndexer fileIndexer = (FileIndexer) o;</span>
<span class="nc" id="L120">            final File file = fileIndexer.getFile();</span>
            try {
<span class="nc" id="L122">                final LineReader lineReader = new LineReader(file, fileIndexer.getIndex());</span>
<span class="nc" id="L123">                final JTailModel model = new JTailModel(file, lineReader);</span>
<span class="nc" id="L124">                this.jTailMainModel.add(model);</span>
<span class="nc" id="L125">            } catch (FileNotFoundException e) {</span>
<span class="nc" id="L126">                ExceptionHandler.handle(e, UIMessage.ERROR_FILE_NOT_FOUND, file.getName());</span>
<span class="nc" id="L127">            } catch (Exception e) {</span>
<span class="nc" id="L128">                ExceptionHandler.handle(e, UIMessage.ERROR_GENERIC_MESSAGE);</span>
<span class="nc" id="L129">            }</span>
        }
<span class="nc" id="L131">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>