<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Handler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">12_dsachat</a> &gt; <a href="index.source.html" class="el_package">dsachat.server</a> &gt; <span class="el_source">Handler.java</span></div><h1>Handler.java</h1><pre class="source lang-java linenums">package dsachat.server;

import java.io.IOException;
import java.util.Vector;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import dsachat.share.ChallReq;
import dsachat.share.Challenge;
import dsachat.share.ConnectionEndpoint;
import dsachat.share.InputEvent;
import dsachat.share.InputListener;
import dsachat.share.UserEvent;
import dsachat.share.hero.Hero;

/**
 * This class is a global listener for all connections.
 * It waits for input, procecces it and send the results to all
 * or one connected client
 * 
 * @author bernshausen
 *
 */
public class Handler implements InputListener{
	
<span class="fc" id="L26">	private Vector&lt;Entry&gt; clients = new Vector&lt;Entry&gt;();</span>
	
<span class="fc" id="L28">	public Handler(){}</span>
	
	/**
	 * add a new connection to a list
	 * Send all other users that this client has connected
	 * @param cl the connection endpoint which has connected
	 */
	public void addConnection(ConnectionEndpoint cl){
<span class="fc" id="L36">		Entry n = new Entry();</span>
<span class="fc" id="L37">		n.ce = cl;</span>
<span class="fc" id="L38">		n.name=&quot;&quot;;</span>
		try {
			//wait for end of key exchange
<span class="nc bnc" id="L41" title="All 2 branches missed.">			while(!cl.isConnected()){</span>
<span class="nc" id="L42">				continue;</span>
			}
<span class="nc bnc" id="L44" title="All 2 branches missed.">			for(int i=0; i&lt;clients.size();i++){</span>
<span class="nc" id="L45">				UserEvent ev= new UserEvent(false,clients.elementAt(i).name);</span>
<span class="nc" id="L46">				cl.send(ev);</span>
			}
<span class="fc" id="L48">		} catch (Exception e) {</span>
			// TODO Auto-generated catch block
<span class="fc" id="L50">			e.printStackTrace();</span>
<span class="nc" id="L51">		}</span>
<span class="fc" id="L52">		clients.addElement(n);</span>
		
<span class="fc" id="L54">	}</span>
	
	/**
	 * Remove a connection from the list after a client disconnects
	 * @param cl the connection which was closed
	 */
	public void removeConnection(ConnectionEndpoint cl){
<span class="fc" id="L61">		String name = null;</span>
<span class="pc bfc" id="L62" title="All 2 branches covered.">		for(int i=0; i&lt;clients.size(); i++){</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">			if(clients.elementAt(i).ce.getClientPort()==cl.getClientPort()){</span>
<span class="nc" id="L64">				name=clients.elementAt(i).name;</span>
<span class="nc" id="L65">				clients.removeElementAt(i);</span>
<span class="nc" id="L66">				break;</span>
			}
		}
		//signal other users that this one disconnects
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">		if(name != null){</span>
<span class="nc" id="L71">			UserEvent newCon = new UserEvent(true,name);</span>
<span class="nc" id="L72">			sendAllObj(newCon);</span>
		}
<span class="fc" id="L74">	}</span>
	

	/**
	 * handle the input from a connection
	 * The connection sends Objects, so the action differs for different
	 * Classes
	 */
	public void handleInput(InputEvent e) {
<span class="nc" id="L83">		Object o = e.getData();</span>
<span class="nc" id="L84">		ConnectionEndpoint con = e.getSource();</span>
		//String means chat or chat commands. also the gm can send a special command
<span class="nc bnc" id="L86" title="All 2 branches missed.">		if(o.getClass().equals(String.class)){</span>
<span class="nc" id="L87">			String msg = o.toString();</span>
			//check for commands
<span class="nc bnc" id="L89" title="All 2 branches missed.">			if(msg.startsWith(&quot;/&quot;)){</span>
<span class="nc" id="L90">				String[] cmd = msg.substring(1).split(&quot;\\s&quot;, 2); </span>
<span class="nc" id="L91">				msg = cmd[1];</span>
				//roll a dice
<span class="nc bnc" id="L93" title="All 2 branches missed.">				if(cmd[0].matches(&quot;(d(ice)?)|(wuurfel)&quot;)){</span>
<span class="nc" id="L94">					rollDice(con, msg.trim());</span>
<span class="nc" id="L95">					return;</span>
				}
				//whisper to another user
<span class="nc bnc" id="L98" title="All 2 branches missed.">				if(cmd[0].matches(&quot;(w(hisper)?)|(f(luuster)?)&quot;)){</span>
<span class="nc" id="L99">					whisper(con, msg.trim());</span>
<span class="nc" id="L100">					return;</span>
				}
				//display different
<span class="nc bnc" id="L103" title="All 2 branches missed.">				if(cmd[0].matches(&quot;me&quot;)){</span>
<span class="nc" id="L104">					sendAllObj(new String(&quot;*&quot;+getName(con)+&quot;: &quot;+msg));</span>
<span class="nc" id="L105">					return;</span>
				}
				//special command for gm to get all connected heros
<span class="nc bnc" id="L108" title="All 2 branches missed.">				if(cmd[0].equals(&quot;/getheros&quot;)){</span>
<span class="nc" id="L109">					sendHeros(con);</span>
<span class="nc" id="L110">					return;</span>
				}
<span class="nc" id="L112">				sendOneSystemMsg(con,&quot;command /&quot;+cmd[0]+&quot; not found&quot;);</span>
<span class="nc" id="L113">				return;</span>
			}
			//if its not a command send broadcast
<span class="nc" id="L116">			sendAllStr(con,o.toString());</span>
		}
		//execute a challenge
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if(o.getClass().equals(Challenge.class)){</span>
<span class="nc" id="L120">			Challenge c = (Challenge)o;</span>
			//the challenge itself produces the output
<span class="nc" id="L122">			String send = c.roll();</span>
			//where to send the data
<span class="nc" id="L124">			String to = c.getTo();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">			if(to == null){</span>
<span class="nc" id="L126">				sendAllStr(con,send);</span>
			}else{
				//silent means the sender doesn't get the response back
<span class="nc bnc" id="L129" title="All 2 branches missed.">				if(!c.isSilent()){</span>
					try {
<span class="nc" id="L131">						con.send(send);</span>
<span class="nc" id="L132">					} catch (IOException e1) {</span>
						// TODO Auto-generated catch block
<span class="nc" id="L134">						e1.printStackTrace();</span>
<span class="nc" id="L135">					}</span>
				}
				//send to receiver
<span class="nc" id="L138">				sendToOneStr(con,to,send);</span>
			}
		}
		//send a challenge request to the requested client
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if(o.getClass().equals(ChallReq.class)){</span>
<span class="nc" id="L143">			ChallReq cr = (ChallReq)o;</span>
			//send challenge to TO
<span class="nc bnc" id="L145" title="All 2 branches missed.">			for(Entry i : clients){</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">				if(i.name.equals(cr.getTo())){</span>
					try {
<span class="nc" id="L148">						i.ce.send(cr);</span>
<span class="nc" id="L149">					} catch (IOException e1) {</span>
						// TODO Auto-generated catch block
<span class="nc" id="L151">						e1.printStackTrace();</span>
<span class="nc" id="L152">					}</span>
<span class="nc" id="L153">					return;</span>
				}
<span class="nc" id="L155">			}</span>
			
		}
		/*
		 * A new connection opened. the hero was sent
		 * Other meaning: the hero was updated
		 */
<span class="nc bnc" id="L162" title="All 2 branches missed.">		if(o.getClass().equals(Hero.class)){</span>
<span class="nc" id="L163">			Hero h = (Hero)o;</span>
<span class="nc" id="L164">			String name = updateHero(con,h);</span>
			//if this user existed already
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if(name == null){</span>
<span class="nc" id="L167">				System.out.println(getName(con)+&quot; updated his hero&quot;);</span>
<span class="nc" id="L168">				return;//exit</span>
			}
			//else tell other clients that new user has arrived
<span class="nc" id="L171">			UserEvent newCon = new UserEvent(false,name);</span>
<span class="nc" id="L172">			System.out.println(getName(con)+&quot; connected&quot;);</span>
<span class="nc" id="L173">			sendAllObj(newCon);</span>
			try {
				//sent welcome message
<span class="nc" id="L176">				con.send(&quot;Welcome &quot; +h.getName());</span>
<span class="nc" id="L177">			} catch (IOException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L179">				e1.printStackTrace();</span>
<span class="nc" id="L180">			}</span>
		}
		//GM connects with an userEvent
<span class="nc bnc" id="L183" title="All 2 branches missed.">		if(o.getClass().equals(UserEvent.class)){</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">			if(!isGmConnected()){</span>
<span class="nc" id="L185">				UserEvent newCon = (UserEvent)o;</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">				for(int i=0; i&lt;clients.size(); i++){</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">					if(clients.elementAt(i).ce.getClientPort() == con.getClientPort()){</span>
<span class="nc" id="L188">						clients.elementAt(i).name=&quot;Gamemaster&quot;;</span>
					}
				}
<span class="nc" id="L191">				System.out.println(&quot;Gamemaster connected&quot;);</span>
<span class="nc" id="L192">				sendAllObj(newCon);</span>
				try {
					//sent welcome message
<span class="nc" id="L195">					con.send(&quot;Welcome &quot; +newCon.getName());</span>
<span class="nc" id="L196">				} catch (IOException e1) {</span>
					// TODO Auto-generated catch block
<span class="nc" id="L198">					e1.printStackTrace();</span>
<span class="nc" id="L199">				}</span>
			}else{
				//TODO gm already connected. kill socket
			}
		}
<span class="nc" id="L204">	}</span>

	/**
	 * send connected heros to gm
	 * @param con
	 */
	private void sendHeros(ConnectionEndpoint con) {
<span class="nc" id="L211">		Vector&lt;Hero&gt; vh = new Vector&lt;Hero&gt;();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">		for(Entry e : clients){</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">			if(e.hero!=null){</span>
<span class="nc" id="L214">				vh.addElement(e.hero);</span>
			}
<span class="nc" id="L216">		}</span>
		try {
<span class="nc" id="L218">			con.send(vh);</span>
<span class="nc" id="L219">		} catch (IOException e1) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L221">			e1.printStackTrace();</span>
<span class="nc" id="L222">		}</span>
<span class="nc" id="L223">	}</span>

	/**
	 * test if a gm is already connected
	 * @return
	 */
	private boolean isGmConnected() {
<span class="nc bnc" id="L230" title="All 2 branches missed.">		for(int i=0; i&lt;clients.size(); i++){</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">			if(clients.elementAt(i).name.equals(&quot;Gamemaster&quot;)){</span>
<span class="nc" id="L232">				return true;</span>
			}
		}
<span class="nc" id="L235">		return false;</span>
	}

	/**
	 * send a System message to one client
	 * @param con the connection to send to
	 * @param string the mesasge to send
	 */
	private void sendOneSystemMsg(ConnectionEndpoint con, String string) {
		try {
<span class="nc" id="L245">			con.send(string);</span>
<span class="nc" id="L246">		} catch (IOException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L248">			e.printStackTrace();</span>
<span class="nc" id="L249">		}</span>
<span class="nc" id="L250">	}</span>
	
	/**
	 * send a System message to all clients 
	 * @param string the message
	 */
	private void sendAllSystemMsg(String string) {
<span class="nc bnc" id="L257" title="All 2 branches missed.">		for(int i=0; i&lt;clients.size(); i++){</span>
			try {
<span class="nc" id="L259">				clients.elementAt(i).ce.send(string);</span>
<span class="nc" id="L260">			} catch (IOException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L262">				e.printStackTrace();</span>
<span class="nc" id="L263">			}</span>
		}
<span class="nc" id="L265">	}</span>

	/**
	 * whisper a message to one client, send also a message to sender
	 * @param con the connection this message came from
	 * @param cmd the tail of the sent message (without leading &quot;/w &quot;)
	 */
	private void whisper(ConnectionEndpoint con, String cmd) {
<span class="nc" id="L273">		String[] split = cmd.split(&quot;\\s&quot;,2);//split to max. 2 parts</span>
<span class="nc" id="L274">		String to = split[0];</span>
<span class="nc" id="L275">		String tail = split[1];</span>
<span class="nc" id="L276">		String send = getName(con)+&quot; whispers: &quot;+tail;</span>
		//send to receiver
<span class="nc bnc" id="L278" title="All 2 branches missed.">		for(int i=0; i&lt;clients.size();i++){</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">			if(clients.elementAt(i).name.equals(to)){</span>
<span class="nc" id="L280">				sendOneSystemMsg(clients.elementAt(i).ce,send);</span>
			}
		}
		//duplicated message for sender
<span class="nc" id="L284">		send = &quot;You whisper to &quot;+to+&quot;: &quot;+tail;</span>
<span class="nc" id="L285">		sendOneSystemMsg(con,send);</span>
<span class="nc" id="L286">	}</span>

	/**
	 * roll some dices
	 * @param con the connection which sent the command
	 * @param cmd the tailing command (without leading &quot;/d &quot;)
	 */
	private void rollDice(ConnectionEndpoint con, String cmd) {
<span class="nc bnc" id="L294" title="All 2 branches missed.">		if(cmd.matches(&quot;.*\\+.*&quot;)){</span>
<span class="nc" id="L295">			Matcher m = Pattern.compile(&quot;(\\d*)[wd](\\d+)\\+(\\d+).*&quot;).matcher(cmd);</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">			if (m.matches()){</span>
<span class="nc bnc" id="L297" title="All 4 branches missed.">				int count = (m.group(1)==null||m.group(1).equals(&quot;&quot;))?</span>
<span class="nc" id="L298">						1 : Integer.parseInt(m.group(1));</span>
<span class="nc" id="L299">				int sides = Integer.parseInt(m.group(2));</span>
<span class="nc" id="L300">				int mod = Integer.parseInt(m.group(3));</span>
<span class="nc" id="L301">				String ret = getName(con)+&quot; rolled &quot;+cmd+&quot; --&gt; &quot;;</span>
<span class="nc" id="L302">				int sum=0;</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">				for(int i=0; i&lt;count; i++){</span>
<span class="nc" id="L304">					sum += Challenge.dice(sides);</span>
				}
<span class="nc" id="L306">				sum += mod;</span>
<span class="nc" id="L307">				ret += sum;</span>
				//just send to all
<span class="nc" id="L309">				sendAllSystemMsg(ret);</span>
			}
<span class="nc" id="L311">		}else{</span>
<span class="nc" id="L312">			Matcher m = Pattern.compile(&quot;(\\d*)[wd](\\d+).*&quot;).matcher(cmd);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">			if (m.matches()){</span>
<span class="nc bnc" id="L314" title="All 4 branches missed.">				int count = (m.group(1)==null||m.group(1).equals(&quot;&quot;))?</span>
<span class="nc" id="L315">						1 : Integer.parseInt(m.group(1));</span>
<span class="nc" id="L316">				int sides = Integer.parseInt(m.group(2));</span>
				
<span class="nc" id="L318">				String ret = getName(con)+&quot; rolls &quot;+cmd+&quot; --&gt; &quot;;</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">				for(int i=0; i&lt;count; i++){</span>
<span class="nc" id="L320">					ret += Challenge.dice(sides)+ &quot;  &quot;;</span>
				}
				//just send to all
<span class="nc" id="L323">				sendAllSystemMsg(ret);</span>
			}
		}
<span class="nc" id="L326">	}</span>

	/**
	 * Send a String message to a single client
	 * @param con the connection the message came from
	 * @param to name of the receiver
	 * @param send the String to send
	 */
	private void sendToOneStr(ConnectionEndpoint con, String to, String send) {
<span class="nc" id="L335">		String sender = getName(con);</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">		for(int i=0; i&lt;clients.size(); i++){</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">			if(clients.elementAt(i).name.equals(to)){</span>
				try {
<span class="nc" id="L339">					String msg = sender +&quot;: &quot;+send;</span>
<span class="nc" id="L340">					clients.elementAt(i).ce.send(msg);</span>
<span class="nc" id="L341">				} catch (IOException e) {</span>
					// TODO Auto-generated catch block
<span class="nc" id="L343">					e.printStackTrace();</span>
<span class="nc" id="L344">				}</span>
			}
		}
<span class="nc" id="L347">	}</span>

	/**
	 * Update a formerly connected hero
	 * @param con the connection the update came from
	 * @param h the new hero
	 * @return null if the hero existed before,
	 *  the name of the connection if the hero was not sent before 
	 */
	private String updateHero(ConnectionEndpoint con, Hero h) {
<span class="nc bnc" id="L357" title="All 2 branches missed.">		for(int i=0; i&lt;clients.size(); i++){</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">			if(clients.elementAt(i).ce.getClientPort() == con.getClientPort()){</span>
<span class="nc" id="L359">				clients.elementAt(i).hero=h;</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">				if(clients.elementAt(i).name.equals(&quot;&quot;)){</span>
<span class="nc" id="L361">					clients.elementAt(i).name=h.getName();</span>
<span class="nc" id="L362">					return h.getName();</span>
				}else{
<span class="nc" id="L364">					return null;</span>
				}
			}
		}
<span class="nc" id="L368">		return null;</span>
	}

	/**
	 * send a broadcast string message
	 * @param con the connection the message came from
	 * @param string the message
	 */
	private void sendAllStr(ConnectionEndpoint con, String string) {
<span class="nc" id="L377">		String sender = getName(con);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">		for(int i=0; i&lt;clients.size(); i++){</span>
			try {
<span class="nc" id="L380">				String msg = sender +&quot;: &quot;+string;</span>
<span class="nc" id="L381">				clients.elementAt(i).ce.send(msg);</span>
<span class="nc" id="L382">			} catch (IOException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L384">				e.printStackTrace();</span>
<span class="nc" id="L385">			}</span>
		}
<span class="nc" id="L387">	}</span>
	
	/**
	 * send an object to all clients
	 * @param o the object to send
	 */
	private void sendAllObj(Object o) {
<span class="nc bnc" id="L394" title="All 2 branches missed.">		for(int i=0; i&lt;clients.size(); i++){</span>
			try {
<span class="nc" id="L396">				clients.elementAt(i).ce.send(o);</span>
<span class="nc" id="L397">			} catch (IOException e) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L399">				e.printStackTrace();</span>
<span class="nc" id="L400">			}</span>
		}
<span class="nc" id="L402">	}</span>

	/**
	 * return the name of a connection stored in the list
	 * @param con the connection
	 * @return the name
	 */
	private String getName(ConnectionEndpoint con) {
<span class="nc bnc" id="L410" title="All 2 branches missed.">		for(int i=0; i&lt;clients.size(); i++){</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">			if(clients.elementAt(i).ce.getClientPort() == con.getClientPort()){</span>
<span class="nc" id="L412">				return clients.elementAt(i).name;</span>
			}
		}
<span class="nc" id="L415">		return null;</span>
	}
	
}

/**
 * private class for this listener to hold the connections in a list
 * @author bernshausen
 *
 */
<span class="fc" id="L425">class Entry{</span>
	public String name;
	public ConnectionEndpoint ce;
	public Hero hero;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>