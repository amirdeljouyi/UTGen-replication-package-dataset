<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GmFrame.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">12_dsachat</a> &gt; <a href="index.source.html" class="el_package">dsachat.gm.gui</a> &gt; <span class="el_source">GmFrame.java</span></div><h1>GmFrame.java</h1><pre class="source lang-java linenums">package dsachat.gm.gui;

import java.awt.Dimension;
import java.awt.Toolkit;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintStream;
import java.net.UnknownHostException;
import java.net.MalformedURLException;
import java.security.GeneralSecurityException;
import java.util.Vector;

import javax.swing.JButton;
import javax.swing.JDesktopPane;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JInternalFrame;
import javax.swing.JLayeredPane;
import javax.swing.JMenu;
import javax.swing.JMenuBar;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JRootPane;
import javax.swing.JTextField;
import javax.swing.KeyStroke;
import javax.swing.filechooser.FileFilter;
import javax.swing.tree.TreePath;

import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.dom4j.io.SAXReader;

import dsachat.Main;
import dsachat.client.net.SecClient;
import dsachat.share.ChallReq;
import dsachat.share.Challenge;
import dsachat.share.ConnectionEndpoint;
import dsachat.share.InputEvent;
import dsachat.share.InputListener;
import dsachat.share.UserEvent;
import dsachat.share.hero.Attribute;
import dsachat.share.hero.Hero;
import dsachat.share.hero.Spell;
import dsachat.share.hero.Talent;
import dsachat.share.hero.Weapon;

/**
 * Display the Main Window for Game Master
 * There will be a chat frame and additional Frames for Heros and Enemies
 * The GM can load all online Heros. He also can load generated enemies.
 * 
 * @author bernshausen
 *
 */
public class GmFrame extends JFrame implements ActionListener, InputListener{

	
	private static final long serialVersionUID = 5032616017013540649L;
	JDesktopPane desktop;
	SecClient cl;
	private InternalGmChatFrame igcf;
	
	/**
	 * Set up the Frame.
	 * Set the size and load the internal components
	 */
	public GmFrame(){
<span class="nc" id="L74">		super(&quot;DSA Chat GameMaster&quot;);</span>

        //Make the big window be indented 50 pixels from each edge
        //of the screen.
<span class="nc" id="L78">        int inset = 50;</span>
<span class="nc" id="L79">        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();</span>
<span class="nc" id="L80">        setBounds(inset, inset,</span>
                  screenSize.width -inset*2,
                  screenSize.height - inset*2);

        //Set up the GUI.
<span class="nc" id="L85">        desktop = new JDesktopPane(); //a specialized layered pane</span>
<span class="nc" id="L86">        setContentPane(desktop);</span>
<span class="nc" id="L87">        setJMenuBar(createMenuBar());</span>
<span class="nc" id="L88">        setDefaultLookAndFeelDecorated(true);</span>
        //Make dragging a little faster but perhaps uglier.
//        desktop.setDragMode(JDesktopPane.OUTLINE_DRAG_MODE);
<span class="nc" id="L91">        this.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span>
<span class="nc" id="L92">        createInternalFrames();</span>
<span class="nc" id="L93">	}</span>
	
	/**
	 * Create the Chat view
	 */
	private void createInternalFrames() {
<span class="nc" id="L99">		igcf = new InternalGmChatFrame(this);</span>
<span class="nc" id="L100">		igcf.setVisible(true);</span>
<span class="nc" id="L101">		desktop.add(igcf);</span>
		try {
<span class="nc" id="L103">            igcf.setSelected(true);</span>
<span class="nc" id="L104">        } catch (java.beans.PropertyVetoException e) {}</span>
<span class="nc" id="L105">	}</span>

	/**
	 * Create the MenuBar for this Window
	 * @return the MenuBar
	 */
	protected JMenuBar createMenuBar() {
<span class="nc" id="L112">        JMenuBar menuBar = new JMenuBar();</span>

        //Set up the file menu.
<span class="nc" id="L115">        JMenu menu = new JMenu(&quot;File&quot;);</span>
<span class="nc" id="L116">        menu.setMnemonic(KeyEvent.VK_F);</span>
<span class="nc" id="L117">        menuBar.add(menu);</span>
        
        //load hero item
<span class="nc" id="L120">        JMenuItem menuItem = new JMenuItem(&quot;Load enemies&quot;);</span>
<span class="nc" id="L121">        menuItem.setMnemonic(KeyEvent.VK_L);</span>
<span class="nc" id="L122">        menuItem.setAccelerator(KeyStroke.getKeyStroke(</span>
        		KeyEvent.VK_L, ActionEvent.ALT_MASK));
<span class="nc" id="L124">        menuItem.setActionCommand(&quot;load&quot;);</span>
<span class="nc" id="L125">        menuItem.addActionListener(this);</span>
<span class="nc" id="L126">        menuItem.setToolTipText(&quot;Multiple selections allowed&quot;);</span>
<span class="nc" id="L127">        menu.add(menuItem);</span>
        
        //save chat log
<span class="nc" id="L130">        menuItem = new JMenuItem(&quot;Save Chat Log&quot;);</span>
<span class="nc" id="L131">        menuItem.setMnemonic(KeyEvent.VK_S);</span>
<span class="nc" id="L132">        menuItem.setAccelerator(KeyStroke.getKeyStroke(</span>
                KeyEvent.VK_S, ActionEvent.ALT_MASK));
<span class="nc" id="L134">        menuItem.setActionCommand(&quot;save&quot;);</span>
<span class="nc" id="L135">        menuItem.addActionListener(this);</span>
<span class="nc" id="L136">        menu.add(menuItem);</span>

        //Set up the quit menu item.
<span class="nc" id="L139">        menuItem = new JMenuItem(&quot;Quit&quot;);</span>
<span class="nc" id="L140">        menuItem.setMnemonic(KeyEvent.VK_Q);</span>
<span class="nc" id="L141">        menuItem.setAccelerator(KeyStroke.getKeyStroke(</span>
                KeyEvent.VK_Q, ActionEvent.ALT_MASK));
<span class="nc" id="L143">        menuItem.setActionCommand(&quot;quit&quot;);</span>
<span class="nc" id="L144">        menuItem.addActionListener(this);</span>
<span class="nc" id="L145">        menu.add(menuItem);</span>
        
        
<span class="nc" id="L148">        JMenu connectMenu = new JMenu(&quot;Connection&quot;);</span>
<span class="nc" id="L149">        connectMenu.setMnemonic(KeyEvent.VK_O);</span>
<span class="nc" id="L150">        menuBar.add(connectMenu);</span>
        
        //Set up the connect menu item.
<span class="nc" id="L153">        menuItem = new JMenuItem(&quot;Connect&quot;);</span>
<span class="nc" id="L154">        menuItem.setMnemonic(KeyEvent.VK_C);</span>
<span class="nc" id="L155">        menuItem.setAccelerator(KeyStroke.getKeyStroke(</span>
        		KeyEvent.VK_C, ActionEvent.ALT_MASK));
<span class="nc" id="L157">        menuItem.setActionCommand(&quot;connect&quot;);</span>
<span class="nc" id="L158">        menuItem.addActionListener(this);</span>
<span class="nc" id="L159">        connectMenu.add(menuItem);</span>
        
        //load hero item
<span class="nc" id="L162">        menuItem = new JMenuItem(&quot;Load online heros&quot;);</span>
<span class="nc" id="L163">        menuItem.setMnemonic(KeyEvent.VK_O);</span>
<span class="nc" id="L164">        menuItem.setAccelerator(KeyStroke.getKeyStroke(</span>
        		KeyEvent.VK_O, ActionEvent.CTRL_MASK));
<span class="nc" id="L166">        menuItem.setActionCommand(&quot;downloadHeros&quot;);</span>
<span class="nc" id="L167">        menuItem.addActionListener(this);</span>
<span class="nc" id="L168">        connectMenu.add(menuItem);</span>
        
        //menuItem for disconnecting
<span class="nc" id="L171">        menuItem = new JMenuItem(&quot;Disconnect&quot;);</span>
<span class="nc" id="L172">        menuItem.setMnemonic(KeyEvent.VK_D);</span>
<span class="nc" id="L173">        menuItem.setAccelerator(KeyStroke.getKeyStroke(</span>
        		KeyEvent.VK_D, ActionEvent.ALT_MASK));
<span class="nc" id="L175">        menuItem.setActionCommand(&quot;disconnect&quot;);</span>
<span class="nc" id="L176">        menuItem.addActionListener(this);</span>
<span class="nc" id="L177">        connectMenu.add(menuItem);</span>
        //help section
<span class="nc" id="L179">        menu = new JMenu(&quot;Help&quot;);</span>
<span class="nc" id="L180">        menu.setMnemonic(KeyEvent.VK_H);</span>
<span class="nc" id="L181">        menuBar.add(menu);</span>
        
<span class="nc" id="L183">        menuItem = new JMenuItem(&quot;Help&quot;);</span>
<span class="nc" id="L184">        menuItem.setMnemonic(KeyEvent.VK_H);</span>
<span class="nc" id="L185">        menuItem.setAccelerator(KeyStroke.getKeyStroke(</span>
        		KeyEvent.VK_H, ActionEvent.ALT_MASK));
<span class="nc" id="L187">        menuItem.setActionCommand(&quot;help&quot;);</span>
<span class="nc" id="L188">        menuItem.addActionListener(this);</span>
<span class="nc" id="L189">        menu.add(menuItem);</span>
        
<span class="nc" id="L191">        menuItem = new JMenuItem(&quot;About&quot;);</span>
<span class="nc" id="L192">        menuItem.setMnemonic(KeyEvent.VK_A);</span>
<span class="nc" id="L193">        menuItem.setAccelerator(KeyStroke.getKeyStroke(</span>
        		KeyEvent.VK_A, ActionEvent.ALT_MASK));
<span class="nc" id="L195">        menuItem.setActionCommand(&quot;about&quot;);</span>
<span class="nc" id="L196">        menuItem.addActionListener(this);</span>
<span class="nc" id="L197">        menu.add(menuItem);</span>
        

<span class="nc" id="L200">        return menuBar;</span>
    }

	
	public void actionPerformed(ActionEvent e) {
		/*
		 * switch action types
		 * most actions will send something to server
		 */
		//connect client to server
<span class="nc bnc" id="L210" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;connect&quot;)){</span>
<span class="nc" id="L211">    		cl = new SecClient();</span>
    		try {
    			//ask user to calculate parameters
<span class="nc" id="L214">    			String[] options = {&quot;Yes&quot;,&quot;No&quot;};</span>
<span class="nc" id="L215">    			int res = JOptionPane.showOptionDialog(this,</span>
    					&quot;Calculate new DH Parameters?\n&quot; +
    					&quot;This can take VERY long&quot;, &quot;new parameters&quot;,
    					JOptionPane.YES_NO_OPTION,
    					JOptionPane.QUESTION_MESSAGE,
    					null, options , options[1]);
<span class="nc bnc" id="L221" title="All 2 branches missed.">    			boolean calcparam = (res==JOptionPane.YES_OPTION)?true:false;</span>
<span class="nc" id="L222">				cl.initialize(calcparam);</span>
				//connect. when we can't connect ask user again
<span class="nc bnc" id="L224" title="All 2 branches missed.">				if(!connect(null))</span>
<span class="nc" id="L225">					return;</span>
<span class="nc" id="L226">				cl.addInputListener(this);</span>
<span class="nc" id="L227">				cl.start();</span>
				//exchange DH public keys
<span class="nc" id="L229">				cl.exchange();</span>
				//wait for connection
<span class="nc bnc" id="L231" title="All 2 branches missed.">				while(!cl.isConnected()){</span>
<span class="nc" id="L232">					continue;</span>
				}
				//send that GM has connected
<span class="nc" id="L235">				send(new UserEvent(false, &quot;Gamemaster&quot;));</span>
				//TODO activate load heros
<span class="nc" id="L237">			} catch (GeneralSecurityException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L239">				e1.printStackTrace();</span>
<span class="nc" id="L240">			} catch (UnknownHostException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L242">				e1.printStackTrace();</span>
<span class="nc" id="L243">			} catch (IOException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L245">				e1.printStackTrace();</span>
<span class="nc" id="L246">			} </span>
		}
		//disconnect and quit
<span class="nc bnc" id="L249" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;quit&quot;)){</span>
			try {
<span class="nc" id="L251">				cl.disconnect();</span>
<span class="nc" id="L252">			} catch (IOException e1) {</span>
				// exit anyway
<span class="nc" id="L254">			}</span>
<span class="nc" id="L255">			System.exit(0);</span>
		}
<span class="nc bnc" id="L257" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;disconnect&quot;)){</span>
			try {
<span class="nc" id="L259">				cl.disconnect();</span>
<span class="nc" id="L260">			} catch (IOException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L262">				e1.printStackTrace();</span>
<span class="nc" id="L263">			}</span>
		}
		//load heros from server
<span class="nc bnc" id="L266" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;downloadHeros&quot;)){</span>
<span class="nc" id="L267">			send(&quot;//getheros now&quot;);</span>
		}
		//send chat message to server
<span class="nc bnc" id="L270" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;sendInput&quot;)){</span>
			try {
<span class="nc" id="L272">				JTextField source = (JTextField)e.getSource();</span>
<span class="nc" id="L273">				source.select(0, source.getText().length());</span>
<span class="nc" id="L274">				cl.send(source.getText());</span>
<span class="nc" id="L275">			} catch (IOException e1) {</span>
<span class="nc" id="L276">				igcf.addText(&quot;*You are disconnected! Your message could not be sent&quot;);</span>
				// TODO Auto-generated catch block
<span class="nc" id="L278">				e1.printStackTrace();</span>
<span class="nc" id="L279">			}</span>
		}
		//send a challenge and let the server execute it
<span class="nc bnc" id="L282" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;challenge&quot;)){</span>
			//get the frame where the data can be found through component tree
<span class="nc" id="L284">			InternalGmHeroFrame fr = (InternalGmHeroFrame)((JRootPane)((JLayeredPane)((JPanel)</span>
<span class="nc" id="L285">					((JPanel)((JButton)e.getSource()).getParent()).getParent())</span>
<span class="nc" id="L286">					.getParent()).getParent()).getParent();</span>
			//get selected item of that frame
<span class="nc" id="L288">			TreePath tp = fr.getSelectedPath();</span>
<span class="nc" id="L289">			Hero h = (Hero)tp.getPathComponent(1);</span>
<span class="nc" id="L290">			Object o = tp.getLastPathComponent();</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">			if(o == null){</span>
				//signal user that he has to select an item
<span class="nc" id="L293">				JOptionPane.showInternalMessageDialog(fr,</span>
						&quot;No Item selected, nothing sent&quot;, &quot;Warning&quot;,
						JOptionPane.INFORMATION_MESSAGE);
				//do not send a challenge
<span class="nc" id="L297">				return;</span>
			}
<span class="nc" id="L299">			int mod = fr.getMod();</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">			if(fr.getFrameName().equals(&quot;Heros&quot;)){</span>
<span class="nc" id="L301">				ChallReq cr =new ChallReq(o,mod,h.getName(),&quot;Gamemaster&quot;);</span>
<span class="nc" id="L302">				send(cr);</span>
<span class="nc" id="L303">			}</span>
			else{
<span class="nc" id="L305">				String to = fr.getReceiver();</span>
<span class="nc" id="L306">				boolean silent = fr.silent();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">				if(to.equals(h.getName())) silent=true;</span>
				Challenge c;
				//Talent and Spell are quite the same
<span class="nc bnc" id="L310" title="All 4 branches missed.">				if (o.getClass().equals(Talent.class)||o.getClass().equals(Spell.class)){</span>
<span class="nc" id="L311">					Talent t = (Talent)o;</span>
<span class="nc" id="L312">					String talName = t.getName();</span>
<span class="nc" id="L313">					c = new Challenge(talName,mod,h,silent,</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">							(to.equals(&quot;All&quot;)?null:to));</span>
				//an attribute is handled different
<span class="nc bnc" id="L316" title="All 2 branches missed.">				}else if(o.getClass().equals(Attribute.class)){</span>
<span class="nc" id="L317">					Attribute a = (Attribute)o;</span>
<span class="nc" id="L318">					String shortc = a.getShortcut();</span>
					//Note that the order is lightly changed
<span class="nc" id="L320">					c = new Challenge(shortc,h,mod,silent,</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">							(to.equals(&quot;All&quot;)?null:to));</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">				}else if(o.getClass().equals(Weapon.class)){</span>
<span class="nc" id="L323">					Weapon w = (Weapon)o;</span>
<span class="nc" id="L324">					c=new Challenge(w,fr.isAttack(),h,mod,silent,</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">							(to.equals(&quot;All&quot;)?null:to));</span>
<span class="nc" id="L326">				}else{</span>
					//Add new extensions here
<span class="nc" id="L328">					System.out.println(o.getClass());</span>
<span class="nc" id="L329">					return;</span>
				}
<span class="nc" id="L331">				send(c);</span>
			}
		}
		//save Chat Log
<span class="nc bnc" id="L335" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;save&quot;)){</span>
			File outFile; 
<span class="nc" id="L337">			JFileChooser chooser = new JFileChooser(</span>
<span class="nc" id="L338">					new File(System.getProperty(&quot;user.home&quot;, &quot;.&quot;)));</span>
<span class="nc" id="L339">		    int returnVal = chooser.showSaveDialog(this);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">		    if(returnVal == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L341">		    	outFile = chooser.getSelectedFile();</span>
		    }else{
<span class="nc" id="L343">		    	return; //do nothing when user doesn't want to</span>
		    }
		    try {
<span class="nc" id="L346">		    	outFile.createNewFile();</span>
<span class="nc" id="L347">				PrintStream out = new PrintStream(new FileOutputStream(outFile));</span>
<span class="nc" id="L348">				out.println(igcf.getChatlog());</span>
<span class="nc" id="L349">			} catch (FileNotFoundException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L351">				e1.printStackTrace();</span>
<span class="nc" id="L352">			} catch (IOException e1) {</span>
				// TODO Auto-generated catch block
<span class="nc" id="L354">				e1.printStackTrace();</span>
<span class="nc" id="L355">			}</span>
		}
		//show a version 
<span class="nc bnc" id="L358" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;about&quot;)){</span>
<span class="nc" id="L359">			String about = &quot;Version: &quot;+Main.version;</span>
<span class="nc" id="L360">			JOptionPane.showMessageDialog(this, about, &quot;About&quot;,</span>
					JOptionPane.INFORMATION_MESSAGE);
		}
		//show a short help section
<span class="nc bnc" id="L364" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;help&quot;)){</span>
<span class="nc" id="L365">			String help =</span>
				&quot;Chat:\n&quot; +
				&quot;\&quot;/w &lt;user&gt; &lt;text&gt;\&quot;\t whisper to another user\n&quot; +
				&quot;\&quot;/d &lt;num&gt;w&lt;sides&gt;\&quot;\t roll dices\n&quot; +
				&quot;\n&quot; +
				&quot;You can also change the color of the users in your text-view\n&quot; +
				&quot;and the background color of the text view. (by right click)\n&quot;;
<span class="nc" id="L372">			JOptionPane.showMessageDialog(this, help, &quot;Help&quot;,</span>
					JOptionPane.INFORMATION_MESSAGE);
		}
<span class="nc bnc" id="L375" title="All 2 branches missed.">		if(e.getActionCommand().equals(&quot;load&quot;)){</span>
<span class="nc" id="L376">			loadEnemies();</span>
		}
<span class="nc" id="L378">	}</span>
	
	/**
	 * Load enemies from Selected Files
	 */
	private void loadEnemies(){
		//get files from user
		File[] input; 
<span class="nc" id="L386">		JFileChooser chooser = new JFileChooser(</span>
<span class="nc" id="L387">				new File(System.getProperty(&quot;user.home&quot;, &quot;.&quot;)));</span>
<span class="nc" id="L388">	    FileFilter ff = new FileFilter(){</span>

			@Override
			public boolean accept(File arg0) {
<span class="nc bnc" id="L392" title="All 2 branches missed.">				if(arg0.getAbsolutePath().endsWith(&quot;.xml&quot;));</span>
<span class="nc" id="L393">				return false;</span>
			}
			
			public String getDescription(){
<span class="nc" id="L397">				return &quot;XML Files&quot;;</span>
			}
	    	
	    };

<span class="nc" id="L402">	    chooser.setFileFilter(ff);</span>
<span class="nc" id="L403">	    chooser.setMultiSelectionEnabled(true);</span>
<span class="nc" id="L404">	    int returnVal = chooser.showOpenDialog(this);</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">	    if(returnVal == JFileChooser.APPROVE_OPTION) {</span>
<span class="nc" id="L406">	       input = chooser.getSelectedFiles();</span>
	    }else{
<span class="nc" id="L408">	    	return; //do nothing when user doesn't want to</span>
	    }
	    //parse documents
<span class="nc" id="L411">	    Vector&lt;Hero&gt; heros = new Vector&lt;Hero&gt;();</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">	    for(File f : input){</span>
<span class="nc" id="L413">	    	Hero hero = null;</span>
<span class="nc" id="L414">    		SAXReader reader = new SAXReader();</span>
    	    Document doc;
			try {
<span class="nc" id="L417">				doc = reader.read(f);</span>
<span class="nc" id="L418">				hero = new Hero(doc);</span>
<span class="nc" id="L419">				heros.addElement(hero);</span>
<span class="nc" id="L420">			} catch (MalformedURLException e1) {//Hero could not be parsed</span>
				// TODO Auto-generated catch block
<span class="nc" id="L422">				e1.printStackTrace();</span>
<span class="nc" id="L423">			} catch (DocumentException e1) {//Hero could not be parsed</span>
				// TODO Auto-generated catch block
<span class="nc" id="L425">				e1.printStackTrace();</span>
<span class="nc" id="L426">			}</span>
	    }
	    //just update the enemies if there's already a Frame for enemies
<span class="nc" id="L429">	    Vector&lt;Hero&gt; oldEnemies = null;</span>
<span class="nc" id="L430">	    InternalGmHeroFrame ighf = null;</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">	    for(JInternalFrame jif :desktop.getAllFrames()){</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">			if(jif.getClass().equals(InternalGmHeroFrame.class)){</span>
<span class="nc" id="L433">				ighf = (InternalGmHeroFrame) jif;</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">				if(ighf.getFrameName().equals(&quot;Enemies&quot;)){</span>
<span class="nc" id="L435">					oldEnemies = ighf.getData();</span>
<span class="nc" id="L436">					break;</span>
				}
			}
		}
<span class="nc bnc" id="L440" title="All 2 branches missed.">	    if(oldEnemies == null){//no enemies loaded before</span>
<span class="nc" id="L441">	    	desktop.add(new InternalGmHeroFrame(this,heros,&quot;Enemies&quot;));	    	</span>
	    } else {
<span class="nc bnc" id="L443" title="All 2 branches missed.">	    	for(Hero h1 : heros){</span>
<span class="nc" id="L444">	    		boolean exists = false;</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">	    		for(Hero h2 : oldEnemies){</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">	    			if(h1.getName().equals(h2.getName())){</span>
<span class="nc" id="L447">	    				exists = true;</span>
<span class="nc" id="L448">	    				break;</span>
	    			}
<span class="nc" id="L450">	    		}</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">	    		if(!exists){</span>
<span class="nc" id="L452">	    			heros.addElement(h1);</span>
	    		}
<span class="nc" id="L454">	    	}</span>
<span class="nc" id="L455">	    	ighf.updateHero(heros);</span>
	    }
<span class="nc" id="L457">	}</span>

	/**
	 * Connect to the server.
	 * Get host and port from user. If there's an error redo.
	 * 
	 * @param msg an error message to show user whats gone wrong
	 * @return true if connection was succesful, false if user cancelled
	 */
	private boolean connect(String msg) {
<span class="nc bnc" id="L467" title="All 2 branches missed.">		String message = (msg==null)?</span>
				&quot;Specify the location of the chat server\n&quot;+
                &quot;This must be in form of host:port\n&quot; +
                &quot;where host is either a name or an IPv4-Address.&quot;:
                &quot;Something went wrong:\n&quot; +
                msg+&quot;\n&quot;+
                &quot;Please specify Server in form of\n&quot; +
                &quot;\&quot;host:port\&quot; where host is a name or an IPv4-address\n&quot; +
                &quot;and port is a number between 1 and 65535&quot;;
<span class="nc" id="L476">		String title = &quot;Server address&quot;;</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">		int type = (msg==null)?JOptionPane.PLAIN_MESSAGE:JOptionPane.ERROR_MESSAGE;</span>
<span class="nc" id="L478">		String s = (String)JOptionPane.showInputDialog(</span>
                this,
                message,
                title,
                type,
                null,
                null,
                &quot;localhost:20001&quot;);
<span class="nc bnc" id="L486" title="All 2 branches missed.">		if(s==null){</span>
<span class="nc" id="L487">			return false; //user canceled</span>
		}
		try {
<span class="nc" id="L490">			String[] addr = s.split(&quot;:&quot;);</span>
			//check IP not possible because it could be a hostname
<span class="nc" id="L492">			String ip = addr[0];</span>
<span class="nc" id="L493">			int port = Integer.parseInt(addr[1]);</span>
<span class="nc bnc" id="L494" title="All 4 branches missed.">			if(port &lt; 1 || port &gt; 65535)</span>
<span class="nc" id="L495">				throw new Exception(&quot;Port not in range 1 to 65535&quot;);</span>
<span class="nc" id="L496">			cl.connect(ip, port);</span>
<span class="nc" id="L497">		} catch (Exception e) {</span>
			//do connect again until connection succeeded or user cancels
<span class="nc" id="L499">			return connect(e.getMessage());</span>
<span class="nc" id="L500">		}</span>
<span class="nc" id="L501">		return true;</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public void handleInput(InputEvent e) {
		// TODO Auto-generated method stub
<span class="nc" id="L507">		Object o = e.getData();</span>
<span class="nc" id="L508">		ConnectionEndpoint ce = e.getSource();</span>
<span class="nc" id="L509">		ce.toString();//TODO just for warning. please delete</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">		if(o.getClass().equals(String.class)){</span>
<span class="nc" id="L511">			String s = (String)o;</span>
<span class="nc" id="L512">			igcf.addText(s);</span>
		}
<span class="nc bnc" id="L514" title="All 2 branches missed.">		if(o.getClass().equals(UserEvent.class)){</span>
<span class="nc" id="L515">			UserEvent ev = (UserEvent)o;</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">			if(ev.isDisconnect()){</span>
<span class="nc" id="L517">				igcf.deleteUser(ev.getName());</span>
			}else{
<span class="nc" id="L519">				igcf.addUser(ev.getName());</span>
			}
		}
<span class="nc bnc" id="L522" title="All 2 branches missed.">		if(o.getClass().equals(Vector.class)){</span>
<span class="nc" id="L523">			Vector&lt;Hero&gt; vh = (Vector&lt;Hero&gt;)o;</span>
			//see if we already have a &quot;Heros&quot; frame
<span class="nc bnc" id="L525" title="All 2 branches missed.">			for(JInternalFrame jif :desktop.getAllFrames()){</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">				if(jif.getClass().equals(InternalGmHeroFrame.class)){</span>
<span class="nc" id="L527">					InternalGmHeroFrame ighf = (InternalGmHeroFrame) jif;</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">					if(ighf.getFrameName().equals(&quot;Heros&quot;)){</span>
<span class="nc" id="L529">						ighf.updateHero(vh);</span>
<span class="nc" id="L530">						return;</span>
					}
				}
			}
<span class="nc" id="L534">			desktop.add(new InternalGmHeroFrame(this,vh,&quot;Heros&quot;));</span>
		}
<span class="nc" id="L536">	}</span>
	
	/**
	 * Send the object to server
	 * @param o the object to send
	 */
	private void send(Object o){
		try {
<span class="nc" id="L544">			cl.send(o);</span>
<span class="nc" id="L545">		} catch (IOException e) {</span>
			// TODO Auto-generated catch block
<span class="nc" id="L547">			e.printStackTrace();</span>
<span class="nc" id="L548">		}</span>
<span class="nc" id="L549">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>